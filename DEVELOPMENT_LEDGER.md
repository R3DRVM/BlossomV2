# Bloom Execution Ledger - Development Guide

**Status**: INTERNAL DEV-ONLY
**Branch**: `mvp`
**Last Updated**: 2026-01-24

---

## Checkpoints

| Checkpoint | Status | Notes |
|------------|--------|-------|
| Backend gating (DEV_LEDGER_SECRET required) | PASS | Returns 403 if not configured |
| Header-only auth (no query param) | PASS | Query param logged as deprecated |
| Frontend blocks if env not set | PASS | Shows "Ledger Not Configured" |
| Schema has kind/venue/usd_estimate columns | PASS | All columns present |
| API returns meta.totalInDb | PASS | All list endpoints |
| Solana devnet wallet funded | PASS | 5 SOL airdropped |
| Solana devnet real transaction | PASS | See proof below |
| Ethereum Sepolia real transaction | PASS | See proof below |
| Dashboard shows both chains | PASS | /dev/ledger and /dev/stats |
| Stats dashboard with aggregates | PASS | /dev/stats with summary cards |
| Execution steps endpoint | PASS | GET /api/ledger/executions/:id/steps |

---

## Proof Transactions

### Solana Devnet

| Field | Value |
|-------|-------|
| **TX Signature** | `312NfZQPqbwGCf5emrrGPA1XkPzHmBUAzoJxGaiqxE5jSfcG6LrUWzjtSQr2RCTwxEX22jsbLS729yVqsDc6sBon` |
| **Explorer** | https://explorer.solana.com/tx/312NfZQPqbwGCf5emrrGPA1XkPzHmBUAzoJxGaiqxE5jSfcG6LrUWzjtSQr2RCTwxEX22jsbLS729yVqsDc6sBon?cluster=devnet |
| **Action** | SOL transfer (0.001 SOL) |
| **Kind/Venue** | proof / native |
| **From** | REDACTED |
| **Slot** | 437273331 |
| **Latency** | 2474ms |
| **Execution ID** | ce82ef64-e817-4eca-98b6-59b19e823db5 |

### Ethereum Sepolia

| Field | Value |
|-------|-------|
| **TX Hash** | `0x53375416932f7c9c47dec48da6f12f9a21688fe2ff0bd64ff4717e9e12016b28` |
| **Explorer** | https://sepolia.etherscan.io/tx/0x53375416932f7c9c47dec48da6f12f9a21688fe2ff0bd64ff4717e9e12016b28 |
| **Action** | ETH transfer (0.000001 ETH) |
| **Kind/Venue** | proof / native |
| **From** | 0x75B0406fFBcFCA51f8606FbbA340FB52A402f3e0 |
| **Block** | 10111277 |
| **Gas Used** | 30432 |
| **Latency** | 6924ms |
| **Execution ID** | 3577acc7-4e84-48ce-b06b-f5fd0374732c |

---

## Commands Used to Generate Proofs

### Solana Devnet Proof

```bash
# Generate wallet (done previously)
npx tsx agent/scripts/solana-generate-dev-wallet.ts --register --primary --label "mvp-dev-wallet"

# Fund wallet (manual step via faucet)
# https://faucet.solana.com/?address=REDACTED

# Execute smoke test
cd agent && npx tsx scripts/solana-ledger-smoke.ts
```

### Ethereum Sepolia Proof

```bash
# Execute smoke test
cd agent && npx tsx scripts/eth-ledger-smoke.ts
```

---

## What Changed (this session)

### New Files Created

| File | Purpose |
|------|---------|
| `agent/scripts/solana-ledger-smoke.ts` | Solana devnet transaction + ledger recording |
| `agent/scripts/eth-ledger-smoke.ts` | Sepolia transaction + ledger recording |
| `src/pages/DevStatsPage.tsx` | Execution statistics dashboard at /dev/stats |

### Files Modified

| File | Change |
|------|--------|
| `agent/.env.local` | Added DEV_LEDGER_SECRET, Solana private key |
| `.env.local` | Added VITE_DEV_LEDGER_SECRET |
| `agent/execution-ledger/db.ts` | Added getSummaryStats(), getExecutionSteps(), createExecutionStep() |
| `agent/src/server/http.ts` | Added stats endpoints: /api/ledger/stats/summary, /api/ledger/stats/recent, /api/ledger/executions/:id/steps |
| `src/routes/AppRouter.tsx` | Added /dev/stats route |

---

## How to Run Locally

### 1. Environment Variables

**Agent (`agent/.env.local`):**
```bash
# REQUIRED for ledger API access
DEV_LEDGER_SECRET=<auto-generated>

# Solana devnet
SOLANA_RPC_URL=https://api.devnet.solana.com
SOLANA_DEVNET_PUBKEY=REDACTED
SOLANA_PRIVATE_KEY=<stored-locally>

# Ethereum Sepolia
ETH_TESTNET_RPC_URL=<your-alchemy-url>
RELAYER_PRIVATE_KEY=<your-relayer-key>
```

**Frontend (`.env.local`):**
```bash
VITE_DEV_LEDGER_SECRET=<must-match-agent-secret>
VITE_AGENT_API_BASE_URL=http://localhost:3001
```

### 2. Start Services

```bash
# Terminal 1: Restart agent (to load new secrets)
cd agent && npm run dev

# Terminal 2: Start frontend
npm run dev
```

### 3. Access Dashboards

| Dashboard | URL | Purpose |
|-----------|-----|---------|
| Execution Ledger | `http://localhost:5173/dev/ledger` | Raw executions, sessions, assets, proof bundle |
| Execution Stats | `http://localhost:5173/dev/stats` | Summary cards, aggregates, recent activity |

---

## API Endpoints

All endpoints require `X-Ledger-Secret` header.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/ledger/summary` | GET | Basic ledger summary (executions, sessions, assets) |
| `/api/ledger/executions` | GET | List executions with pagination |
| `/api/ledger/executions/:id` | GET | Get single execution by ID |
| `/api/ledger/executions/:id/steps` | GET | Get execution steps for a specific execution |
| `/api/ledger/sessions` | GET | List sessions |
| `/api/ledger/assets` | GET | List tracked assets |
| `/api/ledger/wallets` | GET | List registered wallets |
| `/api/ledger/proofs` | GET | Get proof bundle (confirmed TXs by chain) |
| `/api/ledger/stats/summary` | GET | Comprehensive stats (totals, USD routed, by kind/venue/chain) |
| `/api/ledger/stats/recent` | GET | Recent executions for activity feed |

---

## API Gating Verification

### Test: No secret = 403

```bash
curl -s http://localhost:3001/api/ledger/summary | jq '.error'
```

### Test: Correct header = 200

```bash
SECRET=$(grep "DEV_LEDGER_SECRET=" agent/.env.local | tail -1 | cut -d'=' -f2)
curl -s -H "X-Ledger-Secret: $SECRET" http://localhost:3001/api/ledger/executions | jq '.data | length'
# Expected: 2
```

### Test: Stats summary endpoint

```bash
SECRET=$(grep "DEV_LEDGER_SECRET=" agent/.env.local | tail -1 | cut -d'=' -f2)
curl -s -H "X-Ledger-Secret: $SECRET" http://localhost:3001/api/ledger/stats/summary | jq '.data'
```

---

## Current Capability

### What is Now Real

| Capability | Status | Proof |
|------------|--------|-------|
| Solana devnet transactions | WORKING | TX signature on Solana Explorer |
| Ethereum Sepolia transactions | WORKING | TX hash on Etherscan |
| Execution ledger recording | WORKING | Both chains logged to SQLite |
| Gated ledger dashboard | WORKING | Secret-protected /dev/ledger |
| Gated stats dashboard | WORKING | Secret-protected /dev/stats |
| Explorer links | WORKING | Direct links to block explorers |
| Summary stats aggregation | WORKING | Total executions, USD routed, success rate |
| Breakdown by kind/venue/chain | WORKING | Displayed in stats dashboard |
| Execution steps tracking | WORKING | Expandable row in stats table |
| Intent tracking system | WORKING | Parse → Route → Execute lifecycle |
| proof_only with real TX | WORKING | Every proof produces on-chain TX |
| Dual-chain bridge proofs | WORKING | ETH→SOL produces proofs on both |
| Product thesis intents | WORKING | perp, prediction, vault, hedge |

### What is Next

| Feature | Priority | Notes |
|---------|----------|-------|
| Aave supply (Sepolia) | HIGH | Requires fixing ProofAdapter or using WRAP+SUPPLY flow |
| Perp venue (Drift/HL) | MEDIUM | Need venue adapters - currently proof_only |
| Bridge execution (LiFi) | MEDIUM | Quote working, execution not wired |
| Real swap via Uniswap V3 | MEDIUM | Swap adapter on Sepolia |
| Kamino vault (Solana) | MEDIUM | Currently proof_only |
| USD estimates from oracles | LOW | Currently hardcoded estimates |
| Polymarket integration | LOW | Prediction market data source |
| DefiLlama yield ranking | LOW | Vault discovery data source |
| Portfolio state ingestion | LOW | Required for hedge intents |

---

## Database Schema

### executions table

```sql
id TEXT PRIMARY KEY
chain TEXT NOT NULL              -- 'ethereum' | 'solana'
network TEXT NOT NULL            -- 'sepolia' | 'devnet'
kind TEXT                        -- 'perp' | 'deposit' | 'bridge' | 'swap' | 'proof' | 'relay' | 'transfer'
venue TEXT                       -- 'drift' | 'aave' | 'uniswap' | 'jupiter' | 'native' | etc.
intent TEXT NOT NULL             -- Natural language intent
action TEXT NOT NULL             -- Parsed action
from_address TEXT NOT NULL
to_address TEXT
token TEXT
amount_units TEXT
amount_display TEXT
usd_estimate REAL
usd_estimate_is_estimate INTEGER -- 1 = estimate, 0 = oracle
tx_hash TEXT
status TEXT NOT NULL             -- 'pending' | 'submitted' | 'confirmed' | 'finalized' | 'failed'
error_code TEXT
error_message TEXT
explorer_url TEXT
gas_used TEXT
block_number INTEGER
latency_ms INTEGER
relayer_address TEXT
session_id TEXT
created_at INTEGER NOT NULL
updated_at INTEGER NOT NULL
```

### execution_steps table

```sql
id TEXT PRIMARY KEY
execution_id TEXT NOT NULL       -- FK to executions.id
step_index INTEGER NOT NULL      -- 0-indexed step number
action TEXT NOT NULL             -- Step action (e.g., 'wrap', 'approve', 'supply')
tx_hash TEXT
explorer_url TEXT
status TEXT NOT NULL DEFAULT 'pending'  -- 'pending' | 'confirmed' | 'failed'
error_message TEXT
created_at INTEGER NOT NULL
```

---

## Troubleshooting

### "Ledger not configured" on API

The agent needs to be restarted after adding `DEV_LEDGER_SECRET` to `agent/.env.local`.

```bash
# Kill existing agent and restart
pkill -f "node.*agent" && cd agent && npm run dev
```

### Solana transaction fails

Check wallet has sufficient SOL:
```bash
curl -s https://api.devnet.solana.com -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1,"method":"getBalance","params":["REDACTED"]}' | jq '.result.value / 1e9'
```

### Ethereum transaction fails

Check relayer has sufficient ETH:
```bash
cast balance 0x75B0406fFBcFCA51f8606FbbA340FB52A402f3e0 --rpc-url $ETH_TESTNET_RPC_URL
```

---

## Security Notes

- **DO NOT** commit secrets to git
- **DO NOT** print private keys in logs or output
- Private keys stored in `.env.local` are excluded by `.gitignore`
- The ledger DB (`ledger.db`) is excluded by `.gitignore`

---

## Local Development Quick Start

### Start All Services

```bash
# From repo root - starts both frontend (5173) and agent (3001)
npm run dev:all
```

**URLs to open:**
- Frontend: http://localhost:5173
- Dev Stats Dashboard: http://localhost:5173/dev/stats
- Dev Ledger: http://localhost:5173/dev/ledger
- Agent API: http://localhost:3001/api/health

### Viewing Explorer Links

1. Open http://localhost:5173/dev/stats
2. Scroll to "Recent Executions" table
3. Click any row to expand it
4. The "Steps" section shows each transaction with clickable explorer links
   - Sepolia transactions link to https://sepolia.etherscan.io/tx/...
   - Solana devnet transactions link to https://explorer.solana.com/tx/...?cluster=devnet

---

## Troubleshooting

### Port 5173 Connection Refused

**Symptoms:** `ERR_CONNECTION_REFUSED` when opening http://localhost:5173

**Fixes:**
1. **Frontend not running:** Run `npm run dev:all` from repo root
2. **Port in use:** Kill existing process: `lsof -i :5173 | awk 'NR>1 {print $2}' | xargs kill -9`
3. **Check if running on different port:** The terminal output shows the actual URL (e.g., `http://localhost:5174/`)

### Agent API Returns 401/403

**Symptoms:** Stats page shows "API Error" or no data

**Fixes:**
1. **Missing secret header:** Ensure `VITE_DEV_LEDGER_SECRET` in `.env.local` matches `DEV_LEDGER_SECRET` in `agent/.env.local`
2. **Agent not running:** Check `curl http://localhost:3001/api/health` returns `{"ok":true,...}`
3. **Restart agent:** Kill and restart with `pkill -f "tsx watch" && cd agent && npm run dev`

### Dashboard Shows "Not Configured"

**Symptoms:** /dev/stats shows "Dashboard Not Configured" message

**Fix:** Add to `.env.local` in repo root:
```bash
VITE_DEV_LEDGER_SECRET=<same-value-as-agent-secret>
VITE_AGENT_API_BASE_URL=http://localhost:3001
```

### No Executions Shown

**Symptoms:** Dashboard loads but shows "No executions recorded"

**Fix:** Run the thesis checkpoints to generate real transactions:
```bash
cd agent && npx tsx scripts/run-thesis-checkpoints.ts --small
```

### CORS Errors in Browser Console

**Symptoms:** Network requests fail with CORS errors

**Fix:** Ensure agent is running (it includes CORS middleware). If using a different port, update `VITE_AGENT_API_BASE_URL`.

---

## Ledger Database Location

The execution ledger is stored in a local SQLite database:

```
agent/execution-ledger/ledger.db
```

**Important:**
- This file persists across restarts
- It is excluded from git via `.gitignore`
- To backup: `cp agent/execution-ledger/ledger.db ledger-backup-$(date +%Y%m%d).db`
- To reset: `rm agent/execution-ledger/ledger.db` (next run creates fresh DB)

---

## Ongoing Execution Test Runner

A safe, repeatable script for generating real testnet executions indefinitely.

### Usage

```bash
# From agent directory
cd agent

# Small test run (minimal amounts: 0.001 SOL, 1 REDACTED)
npx tsx scripts/run-execution-tests.ts --mode small --chains both --count 1

# Standard test run (normal amounts: 0.005 SOL, 5 REDACTED)
npx tsx scripts/run-execution-tests.ts --mode standard --chains ethereum --count 3

# Stress test (higher amounts: 0.01 SOL, 10 REDACTED)
npx tsx scripts/run-execution-tests.ts --mode stress --chains solana --count 10

# Dry run (no transactions sent)
npx tsx scripts/run-execution-tests.ts --mode small --chains both --count 5 --dry-run
```

### Modes

| Mode | SOL Amount | REDACTED Amount | Use Case |
|------|------------|-------------|----------|
| `small` | 0.001 | 1 | Quick tests, low cost |
| `standard` | 0.005 | 5 | Normal development |
| `stress` | 0.01 | 10 | Load testing |

### Chains

| Value | Description |
|-------|-------------|
| `ethereum` | Sepolia testnet only (deposit + swap) |
| `solana` | Devnet only (transfer + memo swap proof) |
| `both` | All chains (4 executions per count) |

### What Each Run Records

For each execution:
- `execution.kind`: deposit, swap, perp_intent, bridge_intent, proof
- `execution.venue`: demo_vault, demo_dex, solana_vault, etc.
- `execution.chain`: ethereum or solana
- `execution.usd_estimate`: labeled as estimate
- `execution.relayer_address`: when applicable
- `execution.tx_hash` and `execution.explorer_url`

For each step:
- `step.action`: approve, deposit, swap, transfer, etc.
- `step.tx_hash` and `step.explorer_url`
- `step.status`: confirmed or failed

### Verifying in Dashboard

After running tests:
1. Open http://localhost:5173/dev/stats
2. Check "Summary" cards for updated totals
3. Scroll to "Recent Executions" table
4. Click any row to expand and see steps with explorer links

### Safety Features

- **Never prints secrets or private keys**
- Errors stored in DB, not spammed to console
- If env var missing, prints "Missing env var: X" (not the value)
- Dry-run mode available for testing without transactions

---

## Local Dashboard Proof (2026-01-24)

### Validation Commands

```bash
# 1. Start services
npm run dev:all

# 2. Check frontend
curl -I http://localhost:5173/dev/stats  # Should return HTTP 200

# 3. Check agent health
curl -s http://localhost:3001/api/health
# Returns: {"ok":true,"ts":...,"service":"blossom-agent",...}

# 4. Check ledger API (secret redacted)
curl -s -H "X-Ledger-Secret: (redacted)" http://localhost:3001/api/ledger/stats/summary
# Returns: {"ok":true,"data":{"totalExecutions":18,"chainsActive":["ethereum","solana"],...}}

# 5. Run test executions
cd agent && npx tsx scripts/run-execution-tests.ts --mode small --chains both --count 1

# 6. Verify dashboard updated
# Open http://localhost:5173/dev/stats and check totalExecutions increased
```

### Proof Results

| Check | Status | Result |
|-------|--------|--------|
| Frontend at :5173 | ✅ PASS | HTTP 200 |
| /dev/stats route | ✅ PASS | HTTP 200 |
| /dev/ledger route | ✅ PASS | HTTP 200 |
| Agent health | ✅ PASS | {"ok":true} |
| Ledger API gated | ✅ PASS | Requires X-Ledger-Secret |
| Total executions | ✅ PASS | 18 recorded |
| Chains active | ✅ PASS | ethereum, solana |
| Explorer links | ✅ PASS | Sepolia + Solana devnet |

### Latest Test Run Results

| Execution ID | Chain | Kind | Venue | Explorer |
|--------------|-------|------|-------|----------|
| 1677f47d | ethereum | deposit | demo_vault | [Etherscan](https://sepolia.etherscan.io/tx/0xcc537902d52c6d1d374050ff572c64599644ffff34be006d8c0f0c41bf99f19c) |
| 669010d1 | ethereum | swap | demo_dex | [Etherscan](https://sepolia.etherscan.io/tx/0xccb771041d4ebb5812eaba68eb9bb4666001a06b98a5ec9bcf7069d5c1beec1d) |
| f9d8b740 | solana | deposit | solana_vault | [Solana](https://explorer.solana.com/tx/2cwasCnfFa9ixGhzZdG2v1fhAhBamExzrtnhcXY3AvZDELPGeAjCrwr9NDduz9Vgr5yCSkE8ytoxmUZC67m8Rer6?cluster=devnet) |
| 8e9e68ad | solana | swap | demo_dex | [Solana](https://explorer.solana.com/tx/33VyQV5ZJEbyjL4CJYF7rMVr1ysjMHBmSyECD7RJAjsNmHZMr9fEsa1SPqpWTCSjM19btbtRDBE8DWRRpDPLe5Kq?cluster=devnet) |

---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Ledger + API Health | PASS | f5e69a4f | - |
| 1: Checkpoint 1 | SKIP | - | - |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: Checkpoint 3 | SKIP | - | - |
| 4: Checkpoint 4 | SKIP | - | - |
| 5: Checkpoint 5 | SKIP | - | - |
| 6: Checkpoint 6 | SKIP | - | - |

**Generated**: 2026-01-24T06:56:18.337Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Checkpoint 0 | SKIP | - | - |
| 1: DemoREDACTED Vault Deposit | PASS | 1b38c9d6 | [ethereum](https://sepolia.etherscan.io/tx/0xf7c9960c34ff97b4a64b807ed6cd1fa8e18aabce7fc0ce9ee174ffd2ea3d0d60), [ethereum](https://sepolia.etherscan.io/tx/0xbb74a53c0ec7df846b10c61984904f2f494529685f5bd440402582bca1bebf10) |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: Checkpoint 3 | SKIP | - | - |
| 4: Checkpoint 4 | SKIP | - | - |
| 5: Checkpoint 5 | SKIP | - | - |
| 6: Checkpoint 6 | SKIP | - | - |

**Generated**: 2026-01-24T06:57:37.494Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Checkpoint 0 | SKIP | - | - |
| 1: Checkpoint 1 | SKIP | - | - |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: DemoSwap | PASS | f5f43630 | [ethereum](https://sepolia.etherscan.io/tx/0xa6216509608e71574760da83530c2cc26fe64e33c8407830319a47b4bbcbeaf8), [ethereum](https://sepolia.etherscan.io/tx/0x558361be1f15158978ec276519ddcb4713af942589a679cac3190d36911fccbd) |
| 4: Checkpoint 4 | SKIP | - | - |
| 5: Checkpoint 5 | SKIP | - | - |
| 6: Checkpoint 6 | SKIP | - | - |

**Generated**: 2026-01-24T06:58:50.973Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Checkpoint 0 | SKIP | - | - |
| 1: Checkpoint 1 | SKIP | - | - |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: Checkpoint 3 | SKIP | - | - |
| 4: Solana SPL Vault Deposit | PASS | d0c82c0d | [solana](https://explorer.solana.com/tx/23wPDvbC5iMYrEwMBDzUcN9rU3v3iLCU3yqnxBTg4LKKqBX2f7pwbzgKHxaHz1FwcET6w9nLXnLPgNSPU54EMDPK?cluster=devnet) |
| 5: Checkpoint 5 | SKIP | - | - |
| 6: Checkpoint 6 | SKIP | - | - |

**Generated**: 2026-01-24T07:03:14.976Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Checkpoint 0 | SKIP | - | - |
| 1: Checkpoint 1 | SKIP | - | - |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: Checkpoint 3 | SKIP | - | - |
| 4: Checkpoint 4 | SKIP | - | - |
| 5: Solana Swap Proof | PASS | ca97fe24 | [solana](https://explorer.solana.com/tx/2iD3Qtqnu6ZX1i6m1ATgCsCtDn9wrp7eSh8ZSWkeqN2G2VHDziMyVMRZm4RmXdC1ZKnigT6T1ak3EN4AfDkYV14b?cluster=devnet) |
| 6: Bridge Intent Proof | FAIL | - | - |

**Generated**: 2026-01-24T07:03:24.597Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Checkpoint 0 | SKIP | - | - |
| 1: Checkpoint 1 | SKIP | - | - |
| 2: Checkpoint 2 | SKIP | - | - |
| 3: Checkpoint 3 | SKIP | - | - |
| 4: Checkpoint 4 | SKIP | - | - |
| 5: Checkpoint 5 | SKIP | - | - |
| 6: Bridge Intent Proof | PASS | 2137331f | [ethereum](https://sepolia.etherscan.io/tx/0x9c7374c154cfd64213049c7a49f87fb7bab4d9bfb9323e031e163b528265decd), [solana](https://explorer.solana.com/tx/2kbTQjv8BeWw4uoHWMhVRpyUpxCQzrRWsReCi58ypTv7TVo6fqWVa3FRHmvTPid4FEm6kyqKaw9BSK3pWX6UrfQ6?cluster=devnet) |

**Generated**: 2026-01-24T07:04:03.817Z


---

## Thesis Checkpoint Results (2026-01-24)

| Checkpoint | Status | Execution ID | Explorer Links |
|------------|--------|--------------|----------------|
| 0: Ledger + API Health | PASS | 868c7d22 | - |
| 1: DemoREDACTED Vault Deposit | PASS | 5e2a71f0 | [ethereum](https://sepolia.etherscan.io/tx/0x5acc696b853bde2ba3d8dff4b176785bfcc0448cca638d6fc79eef285269746e), [ethereum](https://sepolia.etherscan.io/tx/0xbba3bb790d11e347a4f97e51dae0e84072bf9cf9231e108a64316c30e9ec385d) |
| 2: Aave Deposit | SKIP | - | - |
| 3: DemoSwap | PASS | 8e7b31bb | [ethereum](https://sepolia.etherscan.io/tx/0xc8e9137b94e946613e9c553395274f1e80365ad74668237c85affab8569d503c), [ethereum](https://sepolia.etherscan.io/tx/0x6860f627fee36e6468e6bc8299613a9b02e726f4088e4c74792b850b7ab935ba) |
| 4: Solana SPL Vault Deposit | PASS | 76eae4e4 | [solana](https://explorer.solana.com/tx/3WQptCdBSkZdhCwub8wrdQZiat8w6e3s9PiBYqBA2S5N3Ry4XgYVQVjAGfNhSWeCA9GM4rsogpUbAmd1wroBi71Z?cluster=devnet) |
| 5: Solana Swap Proof | PASS | 7e34e668 | [solana](https://explorer.solana.com/tx/2KU5zPi3uHLx1hQuG6cxsCqwLTxLoVQ8TbCVNFaQ6qCmMPeDWgX8Ft5yFRsvvWhQRiLZJ9ebjnDEqGg2iCUU3tHZ?cluster=devnet) |
| 6: Bridge Intent Proof | PASS | f16dd11e | [ethereum](https://sepolia.etherscan.io/tx/0x8356dd1a046066efa92a2c2771198a886f74c82b514fc97d5d0159dde46c1687), [solana](https://explorer.solana.com/tx/GwpBSx2k6q1tm5iKr354W2UJP667HQuNA8cX7uLbnyjkcsjqPjtkS5rjHqx5JeaeowrENmJnWQc1aaPNpodG7W6?cluster=devnet) |

**Generated**: 2026-01-24T07:05:27.450Z


---

## Real Thesis Suite Results (2026-01-24)

**100% SUCCESS RATE** - All 7 checkpoints passed with **10 real on-chain transactions**.

### Run Command

```bash
npx tsx agent/scripts/run-real-thesis-suite.ts
```

### Checkpoint Results

| Checkpoint | Status | Duration | On-Chain Proofs |
|------------|--------|----------|-----------------|
| 1: Wallet/Session Infrastructure | ✅ PASS | 0.5s | (config check) |
| 2: REAL Ethereum Sepolia Deposit | ✅ PASS | 13.4s | [Etherscan](https://sepolia.etherscan.io/tx/0x48a1a19e7026cb4b841b0c8ee3e561fc1f83301a6780b1aec9e0a219adff636e) |
| 3: REAL Ethereum Sepolia Swap | ✅ PASS | 9.1s | [Etherscan](https://sepolia.etherscan.io/tx/0x16e8530e40ad73973ebf6f69d9877c3a1152c5922ad27c99bfbe5527ca5925fb) |
| 4: REAL Solana Devnet Vault Deposit | ✅ PASS | 1.8s | [Solana](https://explorer.solana.com/tx/3meoNNMStDYiDPUf1KKRpwf2ZZjuiGSaDKqwB7Dxx7z8hiEcN7ZU6Z9Uxg9toANN1JHyd3cqtoAgoao3sB2r3LkR?cluster=devnet) |
| 5: REAL Solana Devnet Swap Proof | ✅ PASS | 1.6s | [Solana](https://explorer.solana.com/tx/49rChAKwJgFM476LEWZJs2XX3KewJdhLW7GKgkgQg5KpCXQD1isdzqxLkUM3GDysqDhTS4GVHZ7KpPUX8LBYaPs4?cluster=devnet) |
| 6: Bridge Intent Dual-Chain Proofs | ✅ PASS | 15.6s | [Sepolia](https://sepolia.etherscan.io/tx/0x45c8257ea32d0b4ceb27ad20e23efd52f667b5590367573b06d32ec8c4c98bb3), [Solana](https://explorer.solana.com/tx/3qMGirymQnbX7V6PwjDViPC3sDMFRYgPSrh8qxUoUAehU1yDftwRQGCeiYgEVZtZkVJQMuKGdnyuzqpheHnqVKoM?cluster=devnet) |
| 7: Product Thesis (4 intents) | ✅ PASS | 57.4s | See below |

### Checkpoint 7: Product Thesis Intents (All 4 Produced Real TX)

| Intent | Status | Explorer |
|--------|--------|----------|
| "long btc with 500 and 10x leverage" | ✅ proof_only | [Etherscan](https://sepolia.etherscan.io/tx/0x60eb69740609f7e237c9b50c92a26733e26667120dfa6a3e2b614cea551d0835) |
| "bet on highest volume prediction market" | ✅ proof_only | [Etherscan](https://sepolia.etherscan.io/tx/0x55b0aecd0be997f6730c3720322164f0d1dbb8b21dd1c834a51e16550ae05a49) |
| "get me the top defi vault with 15% yield" | ✅ proof_only | [Etherscan](https://sepolia.etherscan.io/tx/0x0e63ae8f84bdaaa11b5ccee24e9b161d72a174b81fa012ea70d5059a38ce0951) |
| "hedge my positions" | ✅ proof_only | [Etherscan](https://sepolia.etherscan.io/tx/0xdb3f388bd5b3d1fd38a06f658c7a5b84e82885ec74c76512bfc776694df8242b) |

### All On-Chain Proofs Summary

**Ethereum Sepolia (7 transactions):**
- https://sepolia.etherscan.io/tx/0x48a1a19e7026cb4b841b0c8ee3e561fc1f83301a6780b1aec9e0a219adff636e
- https://sepolia.etherscan.io/tx/0x16e8530e40ad73973ebf6f69d9877c3a1152c5922ad27c99bfbe5527ca5925fb
- https://sepolia.etherscan.io/tx/0x45c8257ea32d0b4ceb27ad20e23efd52f667b5590367573b06d32ec8c4c98bb3
- https://sepolia.etherscan.io/tx/0x60eb69740609f7e237c9b50c92a26733e26667120dfa6a3e2b614cea551d0835
- https://sepolia.etherscan.io/tx/0x55b0aecd0be997f6730c3720322164f0d1dbb8b21dd1c834a51e16550ae05a49
- https://sepolia.etherscan.io/tx/0x0e63ae8f84bdaaa11b5ccee24e9b161d72a174b81fa012ea70d5059a38ce0951
- https://sepolia.etherscan.io/tx/0xdb3f388bd5b3d1fd38a06f658c7a5b84e82885ec74c76512bfc776694df8242b

**Solana Devnet (3 transactions):**
- https://explorer.solana.com/tx/3meoNNMStDYiDPUf1KKRpwf2ZZjuiGSaDKqwB7Dxx7z8hiEcN7ZU6Z9Uxg9toANN1JHyd3cqtoAgoao3sB2r3LkR?cluster=devnet
- https://explorer.solana.com/tx/49rChAKwJgFM476LEWZJs2XX3KewJdhLW7GKgkgQg5KpCXQD1isdzqxLkUM3GDysqDhTS4GVHZ7KpPUX8LBYaPs4?cluster=devnet
- https://explorer.solana.com/tx/3qMGirymQnbX7V6PwjDViPC3sDMFRYgPSrh8qxUoUAehU1yDftwRQGCeiYgEVZtZkVJQMuKGdnyuzqpheHnqVKoM?cluster=devnet

### Key Implementation Details

**proof_only Transactions:**
- Every `proof_only` intent now produces a REAL on-chain transaction
- Ethereum: Self-transfer of 1 wei with intent metadata in calldata
- Solana: Self-transfer of 1000 lamports (0.000001 SOL)
- All transactions are verifiable on block explorers

**Bridge Intents:**
- Bridge from ETH→SOL produces proofs on BOTH chains
- Source chain proof recorded on Sepolia
- Destination chain proof recorded on Solana devnet

---

## Intent Tracking System

### Overview

The Intent Tracking System transforms natural language user prompts into tracked, executable intents. It provides honest failure reporting when features are not yet implemented, making it easy to debug routing and integration issues.

### Intent Lifecycle

```
queued → planned → routed → executing → confirmed
                                     ↘ failed
```

### Intent Kinds

| Kind | Example Prompts | Implementation Status |
|------|----------------|----------------------|
| `perp` | "long btc 20x", "short eth 5x" | proof_only (real venues not integrated) |
| `swap` | "swap 5000 usdc to weth" | REAL (demo_dex on Sepolia) |
| `deposit` | "deposit 20000 usdc to vault" | REAL (demo_vault, aave) |
| `bridge` | "bridge 10000 usdc from eth to sol" | quote_only (LiFi quote, no execution) |
| `unknown` | unrecognized intents | proof_only |

### proof_only Policy

For features not yet implemented (perp trading, real bridging), the system:

1. Records the intent honestly with `executedKind: "proof_only"` in metadata
2. May create a chain proof (transfer/memo) to demonstrate capability
3. Marks as "confirmed" but with clear metadata indicating no real execution occurred
4. Does NOT pretend to have executed a perp fill or bridge

This ensures we can track intent volume and patterns while being truthful about capabilities.

### Database Schema: intents table

```sql
id TEXT PRIMARY KEY
created_at INTEGER NOT NULL
intent_text TEXT NOT NULL         -- Original user prompt
intent_kind TEXT                  -- perp | deposit | swap | bridge | unknown
requested_chain TEXT              -- ethereum | solana | both | null
requested_venue TEXT              -- aave | kamino | hl | drift | lifi | wormhole | demo_* | null
usd_estimate REAL
status TEXT NOT NULL              -- queued | planned | routed | executing | confirmed | failed
planned_at INTEGER
executed_at INTEGER
confirmed_at INTEGER
failure_stage TEXT                -- plan | route | execute | confirm | quote
error_code TEXT                   -- VENUE_NOT_IMPLEMENTED, LIFI_NO_ROUTE, CONFIG_MISSING, etc.
error_message TEXT
metadata_json TEXT                -- JSON: parsed intent, route decision, quote data
```

### Error Codes

| Code | Stage | Meaning |
|------|-------|---------|
| `VENUE_NOT_IMPLEMENTED` | route | Requested venue (drift/hl/kamino) not integrated |
| `BRIDGE_EXECUTION_NOT_IMPLEMENTED` | execute | LiFi quote succeeded but bridging not wired |
| `LIFI_QUOTE_FAILED` | quote | LiFi API returned error |
| `LIFI_NO_ROUTE` | quote | No route found for bridge request |
| `LIFI_UNREACHABLE` | quote | LiFi API timeout or network error |
| `CONFIG_MISSING` | execute | Required env vars not set |
| `EXECUTION_ERROR` | execute | On-chain execution failed |
| `TX_REVERTED` | confirm | Transaction reverted on-chain |

### API Endpoints

All endpoints require `X-Ledger-Secret` header.

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/ledger/intents/recent` | GET | List recent intents (limit param) |
| `/api/ledger/intents/:id` | GET | Get intent details + linked executions |
| `/api/ledger/intents/:id/executions` | GET | Get executions for intent |
| `/api/ledger/stats/intents` | GET | Intent statistics (counts, success rate, failures) |

### Running Intent Tests

```bash
# Navigate to agent directory
cd agent

# Standard test (5 diverse intents)
npx tsx scripts/run-intent-tests.ts --mode standard --chains ethereum

# Small smoke test (3 quick intents)
npx tsx scripts/run-intent-tests.ts --mode small --chains both --count 3

# Specific intents
npx tsx scripts/run-intent-tests.ts -i "long btc 20x" -i "swap 1000 usdc to weth"

# Stress test (20 intents, all types)
npx tsx scripts/run-intent-tests.ts --mode stress --chains both

# Dry run (parse and route only, no execution)
npx tsx scripts/run-intent-tests.ts --mode standard --dryRun

# From JSON file
npx tsx scripts/run-intent-tests.ts --file custom-intents.json
```

### Test Modes

| Mode | Count | Intent Types |
|------|-------|--------------|
| `small` | 3 | deposit, swap, perp |
| `standard` | 5 | deposit, swap, perp, bridge, short |
| `large` | 10 | All types with variations |
| `stress` | 20 | Comprehensive coverage |

### Viewing Intent Results

1. Open http://localhost:5173/dev/stats
2. Check "Intent Tracking" section for summary cards:
   - Total Intents
   - Intent Success Rate
   - Failed Intents
   - Failures by Stage
3. Scroll to "Recent Intents" table
4. Click any row to expand and see:
   - Full intent text
   - Parsed metadata
   - Linked executions (if any)
   - Error details (if failed)

### Example Output

```
[1/5] ✅ Intent: a1b2c3d4...
   Status: confirmed
   TX Hash: 0x123...
   Explorer: https://sepolia.etherscan.io/tx/0x123...

[2/5] ❌ Intent: e5f6g7h8...
   Status: failed
   Stage: route
   Error: VENUE_NOT_IMPLEMENTED
   Message: Perp venue "drift" is not yet integrated

[3/5] ✅ Intent: i9j0k1l2...
   Status: confirmed
   Note: proof_only (no real execution)
```

### Files Created/Modified

| File | Purpose |
|------|---------|
| `agent/execution-ledger/schema.sql` | Added intents table |
| `agent/execution-ledger/db.ts` | Added intent CRUD functions |
| `agent/src/intent/intentRunner.ts` | Intent orchestrator with REAL proof transactions |
| `agent/src/bridge/lifi.ts` | LiFi quote integration |
| `agent/src/server/http.ts` | Added intent API endpoints |
| `agent/scripts/run-intent-tests.ts` | Intent test runner script |
| `agent/scripts/run-real-thesis-suite.ts` | **NEW**: Comprehensive thesis suite with 7 checkpoints |
| `src/pages/DevStatsPage.tsx` | Added intent tracking UI with copy buttons |

### Key Changes in This Session

1. **proof_only now produces REAL transactions**
   - Ethereum: Self-transfer with intent metadata in calldata
   - Solana: Self-transfer via System Program

2. **Bridge intents produce dual-chain proofs**
   - Source chain proof on Sepolia
   - Destination chain proof on Solana devnet

3. **Explorer links enhanced**
   - Proper anchor tags with target="_blank"
   - Copy-to-clipboard button
   - URL validation before rendering

4. **New test suite: `run-real-thesis-suite.ts`**
   - 7 comprehensive checkpoints
   - Produces real on-chain transactions for every test
   - Supports `--checkpoint N` for individual runs
   - Supports `--skip-solana` flag

---

## UI Proof Suite

### Overview

The UI Proof Suite enables intent execution directly from the main Blossom chat interface. Users can type natural language intents in the chat, and the system will parse, route, and execute them on-chain.

### How It Works

1. **Intent Detection**: When a user types a message in the chat, the system checks if it matches known ledger intent patterns (swap, deposit, bridge, perp, etc.)
2. **Backend Routing**: Matching intents are sent to the backend `/api/ledger/intents/execute` endpoint
3. **Execution Pipeline**: The backend runs the full intent lifecycle: parse → route → execute → confirm
4. **Result Display**: Results are shown in the chat via `IntentExecutionCard`, including explorer links

### Supported Intent Patterns

| Pattern | Example |
|---------|---------|
| Swap | "swap 0.001 ETH to REDACTED" |
| Deposit | "deposit 100 REDACTED to vault" |
| Bridge | "bridge 50 REDACTED from eth to sol" |
| Perp | "long BTC with 10x leverage" |
| Bet | "bet on highest volume market" |
| Hedge | "hedge my positions" |
| Vault | "find top defi vault" |

### Files Modified

| File | Change |
|------|--------|
| `src/components/Chat.tsx` | Added ledger intent detection and `executeIntent` call |
| `src/components/MessageBubble.tsx` | Renders `IntentExecutionCard` for intent results |
| `src/components/IntentExecutionCard.tsx` | **NEW**: Displays execution status, explorer links, details |
| `src/lib/apiClient.ts` | Added `executeIntent()`, `getIntent()`, `getRecentIntents()` functions |
| `src/context/BlossomContext.tsx` | Extended `ChatMessage` interface with `intentExecution` field |
| `agent/src/server/http.ts` | Added POST `/api/ledger/intents/execute` endpoint |
| `src/pages/DevStatsPage.tsx` | Added Internal Verification panel for testing |

### Requirements

- `VITE_DEV_LEDGER_SECRET` must be set in `.env.local`
- Agent backend must be running with matching `DEV_LEDGER_SECRET`
- Wallet funds required for on-chain transactions (even proof_only)

### Internal Verification Panel

The `/dev/stats` page includes an "Internal Verification" panel for testing intents directly:

1. Open http://localhost:5173/dev/stats
2. Scroll to "Internal Verification" section
3. Enter an intent (e.g., "swap 0.001 ETH to REDACTED")
4. Select chain (Ethereum Sepolia or Solana Devnet)
5. Click "Execute Intent"
6. View result with explorer links

### UI Acceptance Tests

Run these intents from the main chat (http://localhost:5173) to verify UI integration:

| # | Intent | Expected |
|---|--------|----------|
| 1 | "swap 0.001 ETH to REDACTED" | Routed to demo_dex, TX on Sepolia |
| 2 | "deposit 1 REDACTED to vault" | Routed to demo_vault, TX on Sepolia |
| 3 | "long BTC with 10x" | proof_only TX on Sepolia |
| 4 | "bridge 0.001 ETH to solana" | Dual-chain proofs (Sepolia + Devnet) |

Each test should:
- ✅ Show "Executing Intent" loading state in chat
- ✅ Display `IntentExecutionCard` with status badge
- ✅ Include clickable explorer link for TX hash
- ✅ Show expandable details with intent ID and metadata
- ✅ Record execution in ledger (visible in /dev/stats)

### IntentExecutionCard Features

- **Status Badge**: Shows current status (confirmed, failed, executing)
- **Chain Badge**: Shows chain/network (ethereum/sepolia, solana/devnet)
- **Explorer Link**: Clickable link to view TX on block explorer
- **Copy Button**: Copy TX hash to clipboard
- **Expandable Details**: Intent ID, execution ID, parsed metadata
- **Error Display**: Shows error stage, code, and message for failures
- **Retry Button**: Available on failed executions

---

## Wallet UX

### Overview

Universal wallet connection supporting both EVM (Ethereum/Sepolia) and Solana (Devnet) via industry-standard adapters:

- **EVM**: RainbowKit + wagmi for MetaMask, WalletConnect, and other major wallets
- **Solana**: Solana Wallet Adapter for Phantom, Solflare, and other wallets

### Supported Wallets

| Chain | Wallets |
|-------|---------|
| Ethereum (Sepolia) | MetaMask, WalletConnect, Coinbase Wallet, Rainbow, etc. |
| Solana (Devnet) | Phantom, Solflare |

### Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `VITE_WALLETCONNECT_PROJECT_ID` | Optional | WalletConnect Cloud project ID. Get free at https://cloud.walletconnect.com. If not set, WalletConnect is disabled but injected wallets (MetaMask) still work. |
| `VITE_SOLANA_RPC_URL` | Optional | Solana RPC endpoint. Defaults to `https://api.devnet.solana.com` |

### Usage

1. Click "Connect wallet" button in the sidebar
2. Select chain: Ethereum (Sepolia) or Solana (Devnet)
3. Choose wallet from the provider modal
4. Approve connection in your wallet

### Files Added/Modified

| File | Purpose |
|------|---------|
| `src/components/wallet/WalletProviders.tsx` | Unified wallet providers (RainbowKit + Solana Adapter) with light theme |
| `src/components/wallet/ConnectWalletButton.tsx` | Universal connect button with chain modal and balance display |
| `src/components/wallet/WalletStateBridge.tsx` | **NEW**: Syncs wagmi/Solana state into BlossomContext |
| `src/main.tsx` | Added WalletProviders and WalletStateBridge wrappers |
| `src/components/RightPanel.tsx` | Integrated new wallet button, shows both EVM + Solana |
| `src/components/Chat.tsx` | Check wallet connection before intent execution |
| `src/lib/walletAdapter.ts` | Updated to check localStorage bridge state |
| `src/lib/consoleNoiseFilter.ts` | Added WalletConnect 400/403 noise suppression |
| `src/index.css` | Added Solana wallet adapter light theme overrides |

### Light Theme

The wallet UI matches Blossom's light theme:
- RainbowKit uses `lightTheme()` with pink accent
- Solana Wallet Adapter modal styled via CSS overrides
- All wallet cards use light backgrounds (slate-50, white)

### Wallet Connection Checks

Intent execution now validates wallet connection:

| Intent Type | Required Wallet |
|-------------|-----------------|
| Ethereum intents (swap, deposit) | EVM wallet on Sepolia |
| Solana intents | Solana wallet on Devnet |
| Bridge intents | Both wallets (or proof_only) |

If required wallet is not connected, user sees a friendly error card:
- "Connect an Ethereum wallet to execute this request."
- "Connect a Solana wallet to execute this request."
- "Switch your Ethereum wallet to Sepolia testnet."

### Troubleshooting

#### "Wrong Network" Error

**Symptom**: Connected but shows "Wrong Network"

**Fix**: Click "Switch to Sepolia" button, or manually switch in wallet to Sepolia (chain ID: 11155111)

#### Wallet Not Detected

**Symptom**: No wallet options appear

**Fix**:
1. Ensure wallet extension is installed (MetaMask, Phantom)
2. Refresh the page
3. Check browser extensions are enabled

#### WalletConnect Not Working

**Symptom**: Only MetaMask appears, WalletConnect missing

**Fix**: Set `VITE_WALLETCONNECT_PROJECT_ID` in `.env.local`:
```bash
VITE_WALLETCONNECT_PROJECT_ID=your_project_id_here
```

Get a free project ID at https://cloud.walletconnect.com

#### Solana Wallet Not Connecting

**Symptom**: Phantom doesn't connect

**Fix**:
1. Ensure Phantom is on Devnet (Settings → Developer Settings → Change Network)
2. Refresh the page
3. Try Solflare as alternative

---

## MVP WOW Suite - Investor Demo Verification

### Quick Verification

Run the automated verification suite:

```bash
cd agent && npx tsx scripts/run-mvp-wow-suite.ts
```

### Acceptance Criteria

| Criteria | Status | Verification |
|----------|--------|--------------|
| Perp execution produces real TX | ✅ | `long btc 10x with $500` → Sepolia TX hash |
| Position tracked in ledger | ✅ | `/api/ledger/positions?status=open` shows position |
| Execution steps recorded | ✅ | `/api/ledger/executions/:id/steps` shows route+execute |
| Bridge produces TWO txs | ✅ | Source (Sepolia) + Dest (Solana devnet) proofs |
| Explorer links work | ✅ | Click links in UI → view on block explorer |
| executedKind is truthful | ✅ | `real` for real txs, `proof_only` for proofs |
| /dev/stats shows all data | ✅ | Intents, executions, positions, steps visible |

### Manual Verification Steps

1. **Perp Position Flow**:
   ```bash
   # Execute via API
   curl -X POST http://localhost:3001/api/ledger/intents/execute \
     -H "Content-Type: application/json" \
     -H "X-Ledger-Secret: $LEDGER_SECRET" \
     -d '{"intentText": "long btc 10x with $100", "chain": "ethereum"}'

   # Check response has txHash and explorerUrl
   # Check positions
   curl http://localhost:3001/api/ledger/positions?status=open \
     -H "X-Ledger-Secret: $LEDGER_SECRET"
   ```

2. **Bridge Flow**:
   ```bash
   curl -X POST http://localhost:3001/api/ledger/intents/execute \
     -H "Content-Type: application/json" \
     -H "X-Ledger-Secret: $LEDGER_SECRET" \
     -d '{"intentText": "bridge 100 REDACTED from ethereum to solana", "chain": "both"}'

   # Response should have:
   # - txHash + explorerUrl (Sepolia)
   # - metadata.destChainProof.txHash + explorerUrl (Solana)
   ```

3. **UI Verification**:
   - Open http://localhost:5173
   - Type "long btc 10x with $500" in chat
   - Click Execute
   - Verify IntentExecutionCard shows Sepolia explorer link
   - Check RightPanel shows the open position
   - Navigate to /dev/stats
   - Verify execution steps are visible in expanded row

### Demo vs Real - Truthfulness Paragraph

> The MVP demonstrates real on-chain execution capability. When you execute an intent:
>
> - **Perp positions**: Execute on deployed DemoPerpEngine contract on Sepolia testnet.
>   The transaction is real, recorded on-chain, and verifiable on Etherscan.
>   `executedKind: "real"` indicates genuine contract interaction.
>
> - **Bridge proofs**: Execute proof transactions on BOTH chains (Sepolia + Solana devnet).
>   These are "proof_only" transactions that demonstrate dual-chain capability
>   without moving actual assets. `executedKind: "proof_only"` is truthfully reported.
>
> All transactions produce clickable explorer links. The ledger database records
> every execution with full metadata for audit trail. This is NOT simulation -
> these are real blockchain transactions on test networks.

---

## Confirm Mode Flow (Sprint 4 - Fix 1)

The confirm mode flow provides a two-step execution pattern: plan → confirm → execute.

### Flow Overview

1. User sends perp intent (e.g., "long ETH 2x with 100 REDACTED")
2. Backend returns `status: 'planned'` with parsed intent + route
3. UI shows plan card with "Confirm & Execute" button
4. User clicks confirm → Backend executes the planned intent
5. UI updates with execution result + explorer link

### Verification Commands

```bash
# 1. Start services
cd agent && npm run dev
# In another terminal:
npm run dev

# 2. Set execution mode to "confirm" in frontend
# (In browser console or .env.local)
# VITE_EXECUTION_MODE=confirm

# 3. Send a perp intent via chat
# Example: "long ETH 2x with 100 REDACTED"

# 4. Expected: Plan card appears with:
#    - Parsed intent details (action, amount, leverage)
#    - Status: "Planned"
#    - "Confirm & Execute" button

# 5. Click "Confirm & Execute"
# Expected: Button shows loading state
# Expected: After execution, card updates with:
#    - Status: "Confirmed" or "Failed"
#    - TX hash + explorer link (if successful)
#    - Position appears in RightPanel
```

### API Verification

```bash
# Test planOnly mode
SECRET=$(grep "DEV_LEDGER_SECRET=" agent/.env.local | tail -1 | cut -d'=' -f2)

# Create a planned intent (planOnly=true)
curl -X POST http://localhost:3001/api/ledger/intents/execute \
  -H "Content-Type: application/json" \
  -H "X-Ledger-Secret: $SECRET" \
  -d '{"intentText": "long ETH 2x with 100 REDACTED", "planOnly": true}' | jq '.'

# Expected: { ok: true, status: "planned", intentId: "<uuid>", metadata: {...} }

# Execute the planned intent (confirm step)
INTENT_ID=<intent-id-from-above>
curl -X POST http://localhost:3001/api/ledger/intents/execute \
  -H "Content-Type: application/json" \
  -H "X-Ledger-Secret: $SECRET" \
  -d "{\"intentId\": \"$INTENT_ID\"}" | jq '.'

# Expected: { ok: true, status: "confirmed", txHash: "0x...", explorerUrl: "..." }
```

---

## RPC Failover with Circuit Breaker (Sprint 4 - Fix 2)

The RPC provider implements automatic failover with circuit breaker pattern. When HTTP 429 (rate limit) errors occur, the system automatically switches to the next available endpoint.

### How It Works

1. **Custom Transport**: All viem RPC calls go through a custom transport that handles failover
2. **Rate Limit Detection**: Detects 429/rate-limit errors and immediately switches endpoints
3. **Circuit Breaker**: Opens circuit for 60s on rate limit, 30s on other failures
4. **Exponential Backoff**: Retries with backoff (500ms base, max 5s) before failover
5. **Auto-Recovery**: Circuit resets after timeout, allowing endpoint reuse

### Configuration

**agent/.env.local:**
```bash
# PRIMARY RPC (Alchemy recommended for better rate limits)
ETH_TESTNET_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY

# OPTIONAL: Individual provider URLs (auto-collected as fallbacks)
ALCHEMY_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY
INFURA_RPC_URL=https://sepolia.infura.io/v3/YOUR_KEY

# OPTIONAL: Explicit comma-separated fallback list
# ETH_RPC_FALLBACK_URLS=https://url1,https://url2

# NOTE: Public RPCs are automatically added as last resort:
# - https://ethereum-sepolia-rpc.publicnode.com
# - https://1rpc.io/sepolia
# - https://rpc.sepolia.org
```

### Circuit Breaker Behavior

| Setting | Value | Description |
|---------|-------|-------------|
| Failure threshold | 2 | Circuit opens after 2 consecutive failures |
| Reset timeout | 30s | Circuit resets to half-open after 30 seconds |
| Rate limit backoff | 60s | Longer backoff specifically for 429 errors |
| Request timeout | 15s | Individual request timeout |
| Retry count | 1 | Single retry per endpoint before failover |
| Backoff base | 500ms | Exponential backoff with 30% jitter |

### Verification

```bash
# Check provider health status
curl -s http://localhost:3001/api/rpc/health | jq '.'

# Expected output:
# {
#   "ok": true,
#   "active": "https://ethereum-sepolia-rpc.publicnode.com/",  # Currently active endpoint
#   "primary": { "url": "...", "healthy": true, "circuitOpen": false, "rateLimitedUntil": 0 },
#   "fallbacks": [...]
# }

# Reset all circuit breakers (manual recovery)
curl -s -X POST http://localhost:3001/api/rpc/reset | jq '.'

# Run failover test script
cd agent && npx tsx scripts/test-rpc-failover.ts
```

### Verified Failover Log

```
[rpc-provider] Rate limited! Circuit OPEN for https://sepolia.infura.io/v3/... for 60s
[rpc-provider] Rate limited on https://sepolia.infura.io/v3/..., switching to next endpoint...
[rpc-provider] Success on attempt 3 via https://ethereum-sepolia-rpc.publicnode.com/
```

---

## Error UI Aesthetics (Sprint 4 - Fix 3)

Execution errors are displayed compactly with collapsible details.

### Expected Behavior

- Error shows as a single row with icon + error code
- "Show details" button reveals full error message
- No large red background blocks
- Matches existing card styling

### Verification

1. Trigger an execution error (e.g., insufficient funds)
2. Verify error displays as compact row
3. Click "Show details" → Full message appears
4. Click "Hide details" → Collapses back

---

## Positions After Execution (Sprint 4 - Fix 4)

After successful perp execution, positions automatically appear in RightPanel.

### Verification Steps

1. Execute a perp intent (confirm mode or auto mode)
2. Wait for confirmation (status changes to "confirmed")
3. Check RightPanel → Positions tab
4. Verify position shows with:
   - Asset (e.g., ETH)
   - Direction (long/short)
   - Size
   - Entry price
   - PnL (may be $0 initially)

### API Verification

```bash
# List positions after execution
curl -s -H "X-Ledger-Secret: $SECRET" \
  http://localhost:3001/api/ledger/positions | jq '.data'
```

---
