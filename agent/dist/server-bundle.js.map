{
  "version": 3,
  "sources": ["../src/services/predictionData.ts", "../src/quotes/defiLlamaQuote.ts", "../src/config.ts", "../src/integrations/dflow/dflowClient.ts", "../src/utils/correlationId.ts", "../src/routing/routingService.ts", "../src/quotes/eventMarkets.ts", "../src/utils/actionParser.ts", "../src/services/prices.ts", "../src/quotes/oneInchQuote.ts", "../src/quotes/uniswapQuoter.ts", "../src/quotes/evmQuote.ts", "../src/executors/evmReceipt.ts", "../telemetry/db.ts", "../src/quotes/lendingQuote.ts", "../src/executors/erc20Rpc.ts", "../src/executors/evmRpc.ts", "../src/defi/aave/market.ts", "../src/executors/ethTestnetExecutor.ts", "../src/server/sessionPolicy.ts", "../src/executors/relayer.ts", "../src/defi/aave/positions.ts", "../src/utils/demoTokenMinter.ts", "../src/providers/rpcProvider.ts", "../execution-ledger/db-factory.ts", "../execution-ledger/db.ts", "../src/ledger/ledger.ts", "../src/indexer/perpIndexer.ts", "../src/bridge/lifi.ts", "../src/solana/solanaClient.ts", "../src/intent/intentRunner.ts", "../src/server/http.ts", "../src/services/llmClient.ts", "../src/plugins/perps-sim/index.ts", "../src/plugins/defi-sim/index.ts", "../src/plugins/event-sim/index.ts", "../src/services/state.ts", "../src/services/ticker.ts", "../src/providers/dflowProvider.ts", "../src/providers/fallbackProvider.ts", "../src/providers/providerRegistry.ts", "../src/utils/executionLogger.ts", "../src/utils/accessGate.ts", "../src/telemetry/logger.ts"],
  "sourcesContent": ["/**\n * Prediction Market Data Service\n * Fetches live data from Kalshi and Polymarket APIs with fallback to static demo data\n */\n\nexport interface RawPredictionMarket {\n  id: string;\n  title: string;\n  source: 'KALSHI' | 'POLYMARKET';\n  yesPrice: number;   // 0\u20131\n  noPrice: number;    // 0\u20131\n  volume24hUsd?: number;\n  openInterestUsd?: number;\n  isLive?: boolean;   // true when from network, false if fallback\n}\n\n// Static fallback for Kalshi markets\nconst STATIC_KALSHI_MARKETS: RawPredictionMarket[] = [\n  {\n    id: 'FED_CUTS_MAR_2025',\n    title: 'Fed cuts in March 2025',\n    source: 'KALSHI',\n    yesPrice: 0.62,\n    noPrice: 0.38,\n    volume24hUsd: 125000,\n    openInterestUsd: 450000,\n  },\n  {\n    id: 'BTC_ETF_APPROVAL_2025',\n    title: 'BTC ETF approved by Dec 31',\n    source: 'KALSHI',\n    yesPrice: 0.68,\n    noPrice: 0.32,\n    volume24hUsd: 280000,\n    openInterestUsd: 1200000,\n  },\n  {\n    id: 'ETH_ETF_APPROVAL_2025',\n    title: 'ETH ETF approved by June 2025',\n    source: 'KALSHI',\n    yesPrice: 0.58,\n    noPrice: 0.42,\n    volume24hUsd: 95000,\n    openInterestUsd: 380000,\n  },\n];\n\n// Static fallback for Polymarket markets\nconst STATIC_POLYMARKET_MARKETS: RawPredictionMarket[] = [\n  {\n    id: 'US_ELECTION_2024',\n    title: 'US Election Winner 2024',\n    source: 'POLYMARKET',\n    yesPrice: 0.50,\n    noPrice: 0.50,\n    volume24hUsd: 450000,\n    openInterestUsd: 2100000,\n  },\n  {\n    id: 'CRYPTO_MCAP_THRESHOLD',\n    title: 'Crypto market cap above $3T by year-end',\n    source: 'POLYMARKET',\n    yesPrice: 0.52,\n    noPrice: 0.48,\n    volume24hUsd: 180000,\n    openInterestUsd: 750000,\n  },\n  {\n    id: 'ETH_ABOVE_5K',\n    title: 'ETH above $5k by year-end',\n    source: 'POLYMARKET',\n    yesPrice: 0.45,\n    noPrice: 0.55,\n    volume24hUsd: 120000,\n    openInterestUsd: 520000,\n  },\n];\n\n/**\n * Fetch markets from Kalshi API\n */\nexport async function fetchKalshiMarkets(): Promise<RawPredictionMarket[]> {\n  const apiUrl = process.env.KALSHI_API_URL;\n  const apiKey = process.env.KALSHI_API_KEY;\n\n  // If no API credentials, return static fallback\n  if (!apiUrl || !apiKey) {\n    console.log('[PredictionData] Kalshi API not configured, using static fallback');\n    return STATIC_KALSHI_MARKETS.map(m => ({ ...m, isLive: false }));\n  }\n\n  try {\n    const response = await fetch(apiUrl, {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${apiKey}`,\n        'Accept': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`Kalshi API error: ${response.status} ${response.statusText}`);\n    }\n\n    const data = await response.json();\n    \n    // Map Kalshi API response to RawPredictionMarket[]\n    // Adjust this mapping based on actual Kalshi API response structure\n    const markets: RawPredictionMarket[] = [];\n    \n    // Example mapping (adjust based on actual API structure):\n    // If data is an array of markets:\n    if (Array.isArray(data)) {\n      for (const market of data) {\n        // Filter for binary YES/NO markets only\n        if (market.type === 'binary' || market.outcomes?.length === 2) {\n          const yesPrice = parseFloat(market.yesPrice || market.outcomes?.[0]?.price || '0.5');\n          const noPrice = parseFloat(market.noPrice || market.outcomes?.[1]?.price || '0.5');\n          \n          if (yesPrice >= 0 && yesPrice <= 1 && noPrice >= 0 && noPrice <= 1) {\n            markets.push({\n              id: market.id || market.ticker || `kalshi-${Date.now()}-${Math.random()}`,\n              title: market.title || market.question || market.name || 'Unknown Market',\n              source: 'KALSHI',\n              yesPrice,\n              noPrice,\n              volume24hUsd: parseFloat(market.volume24h || market.volume_24h || '0'),\n              openInterestUsd: parseFloat(market.openInterest || market.open_interest || '0'),\n            });\n          }\n        }\n      }\n    } else if (data.markets && Array.isArray(data.markets)) {\n      // If data.markets is the array\n      for (const market of data.markets) {\n        if (market.type === 'binary' || market.outcomes?.length === 2) {\n          const yesPrice = parseFloat(market.yesPrice || market.outcomes?.[0]?.price || '0.5');\n          const noPrice = parseFloat(market.noPrice || market.outcomes?.[1]?.price || '0.5');\n          \n          if (yesPrice >= 0 && yesPrice <= 1 && noPrice >= 0 && noPrice <= 1) {\n            markets.push({\n              id: market.id || market.ticker || `kalshi-${Date.now()}-${Math.random()}`,\n              title: market.title || market.question || market.name || 'Unknown Market',\n              source: 'KALSHI',\n              yesPrice,\n              noPrice,\n              volume24hUsd: parseFloat(market.volume24h || market.volume_24h || '0'),\n              openInterestUsd: parseFloat(market.openInterest || market.open_interest || '0'),\n            });\n          }\n        }\n      }\n    }\n\n    // Sort by openInterestUsd or volume24hUsd desc, take top 15\n    const sorted = markets.sort((a, b) => {\n      const aValue = a.openInterestUsd || a.volume24hUsd || 0;\n      const bValue = b.openInterestUsd || b.volume24hUsd || 0;\n      return bValue - aValue;\n    });\n\n    const topMarkets = sorted.slice(0, 15);\n\n    if (topMarkets.length > 0) {\n      console.log(`[PredictionData] Fetched ${topMarkets.length} markets from Kalshi`);\n      return topMarkets.map(m => ({ ...m, isLive: true }));\n    } else {\n      console.warn('[PredictionData] Kalshi API returned no valid markets, using static fallback');\n      return STATIC_KALSHI_MARKETS.map(m => ({ ...m, isLive: false }));\n    }\n  } catch (error: any) {\n    console.warn('[PredictionData] Failed to fetch Kalshi markets:', error.message);\n    return STATIC_KALSHI_MARKETS.map(m => ({ ...m, isLive: false }));\n  }\n}\n\n// Module-level cache for Polymarket (30s TTL)\ninterface PolymarketCache {\n  data: RawPredictionMarket[];\n  fetchedAt: number;\n}\n\nlet polymarketCache: PolymarketCache | null = null;\nconst POLYMARKET_CACHE_TTL_MS = 30 * 1000;\n\n// Backoff state for Polymarket\nlet polymarketFailureCount = 0;\nlet polymarketNextAllowedFetchMs = 0;\nconst POLYMARKET_BACKOFF_DELAYS = [15000, 30000, 60000]; // 15s, 30s, 60s\nlet hasLoggedPolymarketWarning = false;\n\n/**\n * Fetch markets from Polymarket public API (no keys required)\n * Uses a simple public endpoint pattern - falls back gracefully if unavailable\n */\nasync function fetchPolymarketPublicMarkets(): Promise<RawPredictionMarket[]> {\n  try {\n    // Try a simple public markets endpoint (if available)\n    // Note: Polymarket's exact public API structure may vary\n    // This is a best-effort attempt that will fall back to static if it fails\n    const publicUrl = 'https://clob.polymarket.com/markets';\n    \n    const response = await fetch(publicUrl, {\n      method: 'GET',\n      headers: {\n        'Accept': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      // Not available or requires auth - return empty, will use static fallback\n      return [];\n    }\n\n    const data = await response.json();\n    const markets: RawPredictionMarket[] = [];\n    \n    // Handle various possible response structures\n    const marketsArray = Array.isArray(data) ? data : (data.markets || data.items || []);\n    \n    for (const market of marketsArray.slice(0, 20)) {\n      // Look for binary markets with YES/NO outcomes\n      if (!market.question && !market.title && !market.name) continue;\n      \n      // Try to extract prices from various possible structures\n      let yesPrice = 0.5;\n      let noPrice = 0.5;\n      \n      if (market.outcomes && Array.isArray(market.outcomes) && market.outcomes.length >= 2) {\n        yesPrice = parseFloat(market.outcomes[0]?.price || market.outcomes[0]?.lastPrice || '0.5');\n        noPrice = parseFloat(market.outcomes[1]?.price || market.outcomes[1]?.lastPrice || '0.5');\n      } else if (market.yesPrice !== undefined) {\n        yesPrice = parseFloat(market.yesPrice);\n        noPrice = 1 - yesPrice;\n      }\n      \n      // Validate prices\n      if (yesPrice < 0 || yesPrice > 1 || noPrice < 0 || noPrice > 1) {\n        yesPrice = 0.5;\n        noPrice = 0.5;\n      }\n      \n      const volume = parseFloat(market.volume24h || market.volume || market.volumeUsd || '0');\n      const liquidity = parseFloat(market.liquidity || market.totalLiquidity || market.openInterest || '0');\n      \n      markets.push({\n        id: market.id || market.slug || market.questionId || `polymarket-${Date.now()}-${Math.random()}`,\n        title: market.question || market.title || market.name || 'Unknown Market',\n        source: 'POLYMARKET',\n        yesPrice,\n        noPrice,\n        volume24hUsd: volume,\n        openInterestUsd: liquidity,\n      });\n    }\n\n    // Sort by volume desc, take top 15\n    const sorted = markets.sort((a, b) => {\n      const aValue = a.volume24hUsd || a.openInterestUsd || 0;\n      const bValue = b.volume24hUsd || b.openInterestUsd || 0;\n      return bValue - aValue;\n    });\n\n    const topMarkets = sorted.slice(0, 15);\n\n    if (topMarkets.length > 0) {\n      // Reset failure count on success\n      polymarketFailureCount = 0;\n      polymarketNextAllowedFetchMs = 0;\n      hasLoggedPolymarketWarning = false;\n      return topMarkets.map(m => ({ ...m, isLive: true }));\n    }\n\n    return [];\n  } catch (error: any) {\n    // Fail silently - will fall back to static\n    return [];\n  }\n}\n\n/**\n * Fetch markets from Polymarket API (with fallback chain)\n */\nexport async function fetchPolymarketMarkets(): Promise<RawPredictionMarket[]> {\n  const now = Date.now();\n  \n  // Check cache first\n  if (polymarketCache && now - polymarketCache.fetchedAt < POLYMARKET_CACHE_TTL_MS) {\n    return polymarketCache.data;\n  }\n\n  // Check backoff\n  if (now < polymarketNextAllowedFetchMs) {\n    // Return cached data if available, otherwise static\n    if (polymarketCache) {\n      return polymarketCache.data;\n    }\n    return STATIC_POLYMARKET_MARKETS.map(m => ({ ...m, isLive: false }));\n  }\n\n  // Try public API first (no keys required)\n  const publicMarkets = await fetchPolymarketPublicMarkets();\n  \n  if (publicMarkets.length > 0) {\n    polymarketCache = {\n      data: publicMarkets,\n      fetchedAt: now,\n    };\n    return publicMarkets;\n  }\n\n  // Fallback to configured API URL if provided\n  const apiUrl = process.env.POLYMARKET_API_URL;\n  \n  if (apiUrl) {\n    try {\n      const response = await fetch(apiUrl, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json',\n        },\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        const markets: RawPredictionMarket[] = [];\n        \n        if (Array.isArray(data)) {\n          for (const market of data) {\n            if (market.outcomes?.length === 2 || market.type === 'binary') {\n              const yesPrice = parseFloat(market.yesPrice || market.outcomes?.[0]?.price || '0.5');\n              const noPrice = parseFloat(market.noPrice || market.outcomes?.[1]?.price || '0.5');\n              \n              if (yesPrice >= 0 && yesPrice <= 1 && noPrice >= 0 && noPrice <= 1) {\n                markets.push({\n                  id: market.id || market.slug || `polymarket-${Date.now()}-${Math.random()}`,\n                  title: market.question || market.title || market.name || 'Unknown Market',\n                  source: 'POLYMARKET',\n                  yesPrice,\n                  noPrice,\n                  volume24hUsd: parseFloat(market.volume24h || market.volume_24h || '0'),\n                  openInterestUsd: parseFloat(market.openInterest || market.open_interest || '0'),\n                });\n              }\n            }\n          }\n        } else if (data.markets && Array.isArray(data.markets)) {\n          for (const market of data.markets) {\n            if (market.outcomes?.length === 2 || market.type === 'binary') {\n              const yesPrice = parseFloat(market.yesPrice || market.outcomes?.[0]?.price || '0.5');\n              const noPrice = parseFloat(market.noPrice || market.outcomes?.[1]?.price || '0.5');\n              \n              if (yesPrice >= 0 && yesPrice <= 1 && noPrice >= 0 && noPrice <= 1) {\n                markets.push({\n                  id: market.id || market.slug || `polymarket-${Date.now()}-${Math.random()}`,\n                  title: market.question || market.title || market.name || 'Unknown Market',\n                  source: 'POLYMARKET',\n                  yesPrice,\n                  noPrice,\n                  volume24hUsd: parseFloat(market.volume24h || market.volume_24h || '0'),\n                  openInterestUsd: parseFloat(market.openInterest || market.open_interest || '0'),\n                });\n              }\n            }\n          }\n        }\n\n        const sorted = markets.sort((a, b) => {\n          const aValue = a.openInterestUsd || a.volume24hUsd || 0;\n          const bValue = b.openInterestUsd || b.volume24hUsd || 0;\n          return bValue - aValue;\n        });\n\n        const topMarkets = sorted.slice(0, 15);\n\n        if (topMarkets.length > 0) {\n          polymarketCache = {\n            data: topMarkets.map(m => ({ ...m, isLive: true })),\n            fetchedAt: now,\n          };\n          polymarketFailureCount = 0;\n          polymarketNextAllowedFetchMs = 0;\n          hasLoggedPolymarketWarning = false;\n          return polymarketCache.data;\n        }\n      }\n    } catch (error: any) {\n      // Fall through to static\n    }\n  }\n\n  // All fetches failed - apply backoff\n  polymarketFailureCount++;\n  const backoffIndex = Math.min(polymarketFailureCount - 1, POLYMARKET_BACKOFF_DELAYS.length - 1);\n  const backoffMs = POLYMARKET_BACKOFF_DELAYS[backoffIndex];\n  polymarketNextAllowedFetchMs = now + backoffMs;\n\n  // Log warning once per session (DEV only)\n  if (!hasLoggedPolymarketWarning && process.env.NODE_ENV !== 'production') {\n    console.warn('[PredictionData] Polymarket feed unavailable, using fallback');\n    hasLoggedPolymarketWarning = true;\n  }\n\n  // Return cached data if available, otherwise static\n  if (polymarketCache) {\n    return polymarketCache.data;\n  }\n\n  return STATIC_POLYMARKET_MARKETS.map(m => ({ ...m, isLive: false }));\n}\n\n/**\n * Get top N markets by volume from Kalshi\n */\nexport async function getTopKalshiMarketsByVolume(limit: number = 5): Promise<RawPredictionMarket[]> {\n  const markets = await fetchKalshiMarkets();\n  const sorted = markets.sort((a, b) => {\n    const aValue = a.volume24hUsd || a.openInterestUsd || 0;\n    const bValue = b.volume24hUsd || b.openInterestUsd || 0;\n    return bValue - aValue;\n  });\n  return sorted.slice(0, limit);\n}\n\n/**\n * Get top N markets by volume from Polymarket\n */\nexport async function getTopPolymarketMarketsByVolume(limit: number = 5): Promise<RawPredictionMarket[]> {\n  const markets = await fetchPolymarketMarkets();\n  const sorted = markets.sort((a, b) => {\n    const aValue = a.volume24hUsd || a.openInterestUsd || 0;\n    const bValue = b.volume24hUsd || b.openInterestUsd || 0;\n    return bValue - aValue;\n  });\n  return sorted.slice(0, limit);\n}\n\n/**\n * Get highest volume market across both platforms\n */\nexport async function getHighestVolumeMarket(): Promise<RawPredictionMarket | null> {\n  const [kalshiMarkets, polymarketMarkets] = await Promise.all([\n    fetchKalshiMarkets(),\n    fetchPolymarketMarkets(),\n  ]);\n  \n  const allMarkets = [...kalshiMarkets, ...polymarketMarkets];\n  if (allMarkets.length === 0) return null;\n  \n  const sorted = allMarkets.sort((a, b) => {\n    const aValue = a.volume24hUsd || a.openInterestUsd || 0;\n    const bValue = b.volume24hUsd || b.openInterestUsd || 0;\n    return bValue - aValue;\n  });\n  \n  return sorted[0] || null;\n}\n\n", "/**\n * DefiLlama Yield Quote Provider\n * Fetches yield data from https://yields.llama.fi/pools\n * Caches results in-memory for 5 minutes\n */\n\ninterface DefiLlamaPool {\n  apy: number;\n  apyBase: number;\n  apyReward?: number;\n  symbol: string;\n  tvlUsd?: number;\n  pool: string;\n  project: string;\n  chain: string;\n  poolMeta?: string;\n}\n\ninterface VaultRecommendation {\n  name: string;\n  apy: number;\n  tvl: number;\n  poolId: string;\n  protocol: string;\n}\n\n// In-memory cache (5 minutes)\nlet cachedVaults: VaultRecommendation[] | null = null;\nlet cacheTimestamp: number = 0;\nconst CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\n// Hardcoded fallback vaults\nconst FALLBACK_VAULTS: VaultRecommendation[] = [\n  { name: 'Aave REDACTED', apy: 5.0, tvl: 1000000, poolId: 'demo-aave-usdc', protocol: 'Aave' },\n  { name: 'Compound REDACTED', apy: 4.5, tvl: 800000, poolId: 'demo-compound-usdc', protocol: 'Compound' },\n  { name: 'Aave USDT', apy: 4.8, tvl: 600000, poolId: 'demo-aave-usdt', protocol: 'Aave' },\n];\n\n/**\n * Fetch top yield vaults from DefiLlama\n * Returns top 3-5 stablecoin-like pools on Ethereum\n */\nexport async function getTopYieldVaults(): Promise<VaultRecommendation[]> {\n  // Check cache\n  const now = Date.now();\n  if (cachedVaults && (now - cacheTimestamp) < CACHE_TTL_MS) {\n    return cachedVaults;\n  }\n\n  try {\n    const response = await fetch('https://yields.llama.fi/pools', {\n      headers: {\n        'Accept': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`DefiLlama API returned ${response.status}`);\n    }\n\n    const data = await response.json();\n    const pools: DefiLlamaPool[] = data.data || [];\n\n    // Filter: Ethereum chain, stablecoin-like pools\n    const stablecoinSymbols = ['REDACTED', 'USDT', 'DAI', 'REDACTED.e', 'USDT.e'];\n    const ethereumPools = pools.filter((pool) => {\n      const isEthereum = pool.chain === 'Ethereum' || pool.chain === 'ethereum';\n      const isStablecoin = stablecoinSymbols.some((sym) => \n        pool.symbol?.toUpperCase().includes(sym)\n      );\n      return isEthereum && isStablecoin && pool.apy > 0;\n    });\n\n    // Sort by APY descending, take top 5\n    ethereumPools.sort((a, b) => (b.apy || 0) - (a.apy || 0));\n    const topPools = ethereumPools.slice(0, 5);\n\n    // Transform to VaultRecommendation format\n    const vaults: VaultRecommendation[] = topPools.map((pool) => ({\n      name: `${pool.project} ${pool.symbol}`,\n      apy: pool.apy || 0,\n      tvl: pool.tvlUsd || 0,\n      poolId: pool.pool || pool.project,\n      protocol: pool.project || 'Unknown',\n    }));\n\n    // Update cache\n    cachedVaults = vaults.length > 0 ? vaults : FALLBACK_VAULTS;\n    cacheTimestamp = now;\n\n    return cachedVaults;\n  } catch (error: any) {\n    console.warn('[getTopYieldVaults] Failed to fetch from DefiLlama:', error.message);\n    // Return fallback\n    cachedVaults = FALLBACK_VAULTS;\n    cacheTimestamp = now;\n    return FALLBACK_VAULTS;\n  }\n}\n\n/**\n * Get vault recommendation for a given amount\n * Returns highest APY vault\n */\nexport async function getVaultRecommendation(amountUsd?: number): Promise<VaultRecommendation | null> {\n  const vaults = await getTopYieldVaults();\n  if (vaults.length === 0) {\n    return null;\n  }\n  // Return highest APY vault\n  return vaults[0];\n}\n\n// DeFi Protocol TVL Data\nexport interface DefiProtocolTVL {\n  name: string;\n  tvl: number; // in USD\n  tvlFormatted: string; // e.g., \"$34.2B\"\n  category: string; // e.g., \"Lending\", \"Liquid Staking\"\n  chains: string[]; // e.g., [\"Ethereum\", \"Polygon\"]\n  slug: string;\n}\n\n// Cache for protocol TVL data (5 minutes)\nlet cachedProtocolsTVL: DefiProtocolTVL[] | null = null;\nlet protocolsCacheTimestamp: number = 0;\n\n// Fallback protocols if API fails\nconst FALLBACK_PROTOCOLS: DefiProtocolTVL[] = [\n  { name: 'Aave V3', tvl: 34200000000, tvlFormatted: '$34.2B', category: 'Lending', chains: ['Ethereum', 'Polygon'], slug: 'aave' },\n  { name: 'Lido', tvl: 28000000000, tvlFormatted: '$28.0B', category: 'Liquid Staking', chains: ['Ethereum'], slug: 'lido' },\n  { name: 'MakerDAO', tvl: 13900000000, tvlFormatted: '$13.9B', category: 'CDP', chains: ['Ethereum'], slug: 'makerdao' },\n  { name: 'Curve', tvl: 11300000000, tvlFormatted: '$11.3B', category: 'Dexes', chains: ['Ethereum', 'Arbitrum'], slug: 'curve' },\n  { name: 'AAVE', tvl: 8800000000, tvlFormatted: '$8.8B', category: 'Lending', chains: ['Ethereum', 'Avalanche'], slug: 'aave-v2' },\n];\n\n/**\n * Format USD amount to human-readable string\n */\nfunction formatTVL(tvl: number): string {\n  if (tvl >= 1_000_000_000) {\n    return `$${(tvl / 1_000_000_000).toFixed(1)}B`;\n  } else if (tvl >= 1_000_000) {\n    return `$${(tvl / 1_000_000).toFixed(1)}M`;\n  } else {\n    return `$${Math.round(tvl).toLocaleString()}`;\n  }\n}\n\n/**\n * Fetch top DeFi protocols by TVL from DefiLlama\n * Returns top 5-10 protocols sorted by TVL descending\n */\nexport async function getTopProtocolsByTVL(limit: number = 5): Promise<DefiProtocolTVL[]> {\n  // Check cache\n  const now = Date.now();\n  if (cachedProtocolsTVL && (now - protocolsCacheTimestamp) < CACHE_TTL_MS) {\n    return cachedProtocolsTVL.slice(0, limit);\n  }\n\n  try {\n    const response = await fetch('https://api.llama.fi/protocols', {\n      headers: {\n        'Accept': 'application/json',\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`DefiLlama protocols API returned ${response.status}`);\n    }\n\n    const protocols: any[] = await response.json();\n\n    // CEX exclusion patterns (matching defiProtocols.ts)\n    const cexCategories = ['cex', 'centralized exchange', 'cefi'];\n    const cexNamePatterns = ['binance', 'okx', 'okex', 'bitfinex', 'coinbase', 'kraken', 'huobi', 'bybit', 'gate.io', 'kucoin'];\n\n    // Filter out protocols with no TVL, no category, and exclude CEXs\n    const protocolsWithTVL = protocols\n      .filter((p) => {\n        // Basic validation\n        if (!p.tvl || p.tvl <= 0 || !p.name || !p.category) return false;\n\n        // Exclude CEX by category (case-insensitive)\n        const categoryLower = String(p.category).toLowerCase();\n        if (cexCategories.some(cexCat => categoryLower.includes(cexCat))) return false;\n\n        // Exclude CEX by name pattern (case-insensitive safety net)\n        const nameLower = String(p.name).toLowerCase();\n        if (cexNamePatterns.some(cexName => nameLower.includes(cexName))) return false;\n\n        return true;\n      })\n      .map((p) => ({\n        name: p.name,\n        tvl: p.tvl || 0,\n        tvlFormatted: formatTVL(p.tvl || 0),\n        category: p.category || 'DeFi',\n        chains: p.chains || ['Ethereum'],\n        slug: p.slug || p.name.toLowerCase().replace(/\\s+/g, '-'),\n      }));\n\n    // Sort by TVL descending\n    protocolsWithTVL.sort((a, b) => b.tvl - a.tvl);\n\n    // Update cache\n    cachedProtocolsTVL = protocolsWithTVL;\n    protocolsCacheTimestamp = now;\n\n    return protocolsWithTVL.slice(0, limit);\n  } catch (error: any) {\n    console.warn('[getTopProtocolsByTVL] Failed to fetch from DefiLlama:', error.message);\n    // Return fallback\n    cachedProtocolsTVL = FALLBACK_PROTOCOLS;\n    protocolsCacheTimestamp = now;\n    return FALLBACK_PROTOCOLS.slice(0, limit);\n  }\n}\n\n\n", "/**\n * Backend Configuration\n * Centralized config for execution mode and ETH testnet settings\n *\n * V1/V1.1 Default: eth_testnet (testnet-only by default)\n * SIM mode: Internal dev-only, requires ALLOW_SIM_MODE=true\n */\n\nimport type { Address } from 'viem';\n\n// Load environment variables FIRST (before reading process.env)\n// This ensures .env.local is loaded before config values are evaluated\nimport { config } from 'dotenv';\nimport { resolve, dirname } from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst agentDir = resolve(__dirname, '..');\nconst rootDir = resolve(agentDir, '..');\n\n// Load .env files with precedence (most specific first)\n// Precedence: agent/.env.local \u2192 agent/.env \u2192 root/.env.local \u2192 root/.env\nconst envFiles = [\n  resolve(agentDir, '.env.local'),\n  resolve(agentDir, '.env'),\n  resolve(rootDir, '.env.local'),\n  resolve(rootDir, '.env'),\n];\n\nlet loadedEnvFile: string | null = null;\nfor (const envFile of envFiles) {\n  const result = config({ path: envFile });\n  if (!result.error) {\n    loadedEnvFile = envFile;\n    break; // First successful load wins\n  }\n}\n\n// Log which env file was loaded (or if none)\nif (loadedEnvFile) {\n  console.log(`\uD83D\uDCC4 [config] Loaded environment from: ${loadedEnvFile}`);\n} else {\n  console.log(`\u26A0\uFE0F  [config] No .env file found (using system environment variables)`);\n}\n\n// Default to eth_testnet for V1/V1.1 (testnet-only by default)\nconst ALLOW_SIM_MODE = process.env.ALLOW_SIM_MODE === 'true';\nconst requestedMode = process.env.EXECUTION_MODE;\n\nlet EXECUTION_MODE: 'sim' | 'eth_testnet';\nif (requestedMode === 'sim') {\n  if (ALLOW_SIM_MODE) {\n    EXECUTION_MODE = 'sim';\n  } else {\n    // Auto-switch to eth_testnet if SIM requested but not allowed\n    EXECUTION_MODE = 'eth_testnet';\n    console.log('\u26A0\uFE0F  EXECUTION_MODE=sim ignored (ALLOW_SIM_MODE not set). Using eth_testnet.');\n  }\n} else {\n  // Default to eth_testnet (V1/V1.1 behavior)\n  EXECUTION_MODE = (requestedMode as 'eth_testnet') || 'eth_testnet';\n}\n\nexport { EXECUTION_MODE };\n\nexport const ETH_TESTNET_CHAIN_ID = parseInt(\n  process.env.ETH_TESTNET_CHAIN_ID || '11155111',\n  10\n); // Sepolia default\n\nexport const ETH_TESTNET_RPC_URL = process.env.ETH_TESTNET_RPC_URL;\n\n// RPC Failover Configuration\n// Primary: ETH_TESTNET_RPC_URL (recommend Alchemy for reliability)\n// Fallbacks: ETH_RPC_FALLBACK_URLS (comma-separated) OR individual vars\n// Order: Primary -> ETH_RPC_FALLBACK_URLS -> ALCHEMY_RPC_URL -> INFURA_RPC_URL -> public RPC\nconst collectFallbackUrls = (): string[] => {\n  const urls: string[] = [];\n\n  // 1. Explicit fallback list (comma-separated)\n  if (process.env.ETH_RPC_FALLBACK_URLS) {\n    urls.push(...process.env.ETH_RPC_FALLBACK_URLS.split(',').map(u => u.trim()).filter(Boolean));\n  }\n\n  // 2. Individual provider URLs (if not already primary)\n  const primary = process.env.ETH_TESTNET_RPC_URL || '';\n\n  if (process.env.ALCHEMY_RPC_URL && !primary.includes('alchemy')) {\n    urls.push(process.env.ALCHEMY_RPC_URL);\n  }\n\n  if (process.env.INFURA_RPC_URL && !primary.includes('infura')) {\n    urls.push(process.env.INFURA_RPC_URL);\n  }\n\n  // 3. Public Sepolia RPCs as last resort (no API key required, multiple for redundancy)\n  const publicRpcs = [\n    'https://ethereum-sepolia-rpc.publicnode.com',\n    'https://1rpc.io/sepolia',\n    'https://rpc.sepolia.org',\n  ];\n\n  for (const rpc of publicRpcs) {\n    try {\n      if (!urls.some(u => u.includes(new URL(rpc).hostname))) {\n        urls.push(rpc);\n      }\n    } catch { /* ignore invalid URLs */ }\n  }\n\n  // Dedupe and filter out primary\n  return [...new Set(urls)].filter(u => u !== primary && u.length > 0);\n};\n\nexport const ETH_RPC_FALLBACK_URLS = collectFallbackUrls();\n\nexport const EXECUTION_ROUTER_ADDRESS = process.env.EXECUTION_ROUTER_ADDRESS;\n\nexport const MOCK_SWAP_ADAPTER_ADDRESS = process.env.MOCK_SWAP_ADAPTER_ADDRESS;\n\nexport const UNISWAP_V3_ADAPTER_ADDRESS = process.env.UNISWAP_V3_ADAPTER_ADDRESS;\n\nexport const WETH_WRAP_ADAPTER_ADDRESS = process.env.WETH_WRAP_ADAPTER_ADDRESS;\n\nexport const REDACTED_ADDRESS_SEPOLIA = process.env.REDACTED_ADDRESS_SEPOLIA;\n\nexport const WETH_ADDRESS_SEPOLIA = process.env.WETH_ADDRESS_SEPOLIA;\n\n// Demo swap venue (deterministic for investor demos)\nexport const DEMO_REDACTED_ADDRESS = process.env.DEMO_REDACTED_ADDRESS;\nexport const DEMO_WETH_ADDRESS = process.env.DEMO_WETH_ADDRESS;\nexport const DEMO_SWAP_ROUTER_ADDRESS = process.env.DEMO_SWAP_ROUTER_ADDRESS;\n\n// Demo lending venue (deterministic for investor demos)\nexport const DEMO_LEND_VAULT_ADDRESS = process.env.DEMO_LEND_VAULT_ADDRESS;\nexport const DEMO_LEND_ADAPTER_ADDRESS = process.env.DEMO_LEND_ADAPTER_ADDRESS;\n\n// Demo perps venue (real on-chain perps for testnet)\nexport const DEMO_PERP_ENGINE_ADDRESS = process.env.DEMO_PERP_ENGINE_ADDRESS as Address | undefined;\nexport const DEMO_PERP_ADAPTER_ADDRESS = process.env.DEMO_PERP_ADAPTER_ADDRESS as Address | undefined;\n\n// Proof-of-execution adapter (for perps/events until real adapters exist)\nexport const PROOF_ADAPTER_ADDRESS = process.env.PROOF_ADAPTER_ADDRESS;\n\n// dFlow Integration\nexport const DFLOW_ENABLED = process.env.DFLOW_ENABLED === 'true';\nexport const DFLOW_API_KEY = process.env.DFLOW_API_KEY;\n// Legacy single URL (deprecated, kept for backwards compatibility)\nexport const DFLOW_BASE_URL = process.env.DFLOW_BASE_URL;\n// dFlow has TWO separate API endpoints:\nexport const DFLOW_QUOTE_API_URL = process.env.DFLOW_QUOTE_API_URL || 'https://a.quote-api.dflow.net';\nexport const DFLOW_PREDICTION_API_URL = process.env.DFLOW_PREDICTION_API_URL || 'https://prediction-markets-api.dflow.net';\nexport const DFLOW_EVENTS_MARKETS_PATH = process.env.DFLOW_EVENTS_MARKETS_PATH;\nexport const DFLOW_EVENTS_QUOTE_PATH = process.env.DFLOW_EVENTS_QUOTE_PATH;\nexport const DFLOW_SWAPS_QUOTE_PATH = process.env.DFLOW_SWAPS_QUOTE_PATH;\nexport const DFLOW_REQUIRE = process.env.DFLOW_REQUIRE === 'true';\n\n// Lending configuration\nexport const LENDING_EXECUTION_MODE: 'demo' | 'real' =\n  (process.env.LENDING_EXECUTION_MODE as 'demo' | 'real') || 'demo';\nexport const AAVE_POOL_ADDRESS = process.env.AAVE_POOL_ADDRESS; // Optional, for real mode later\nexport const LENDING_RATE_SOURCE: 'defillama' | 'aave' | 'none' =\n  (process.env.LENDING_RATE_SOURCE as 'defillama' | 'aave' | 'none') || 'defillama';\n\n// Aave Sepolia integration (testnet V1)\nexport const AAVE_SEPOLIA_POOL_ADDRESS = process.env.AAVE_SEPOLIA_POOL_ADDRESS as Address | undefined;\nexport const AAVE_ADAPTER_ADDRESS = process.env.AAVE_ADAPTER_ADDRESS as Address | undefined;\nexport const AAVE_REDACTED_ADDRESS = process.env.AAVE_REDACTED_ADDRESS || DEMO_REDACTED_ADDRESS; // Use demo REDACTED if not set\nexport const AAVE_WETH_ADDRESS = process.env.AAVE_WETH_ADDRESS as Address | undefined; // Aave-supported WETH on Sepolia\n\n// Adapter addresses\nexport const ERC20_PULL_ADAPTER_ADDRESS = process.env.ERC20_PULL_ADAPTER_ADDRESS;\nexport const UNISWAP_ADAPTER_ADDRESS = process.env.UNISWAP_ADAPTER_ADDRESS || UNISWAP_V3_ADAPTER_ADDRESS;\n\n// Swap configuration\nexport const DEFAULT_SWAP_SLIPPAGE_BPS = parseInt(process.env.DEFAULT_SWAP_SLIPPAGE_BPS || '50', 10); // 0.50% default\n\n// 1inch Routing Configuration (hybrid model)\nexport const ONEINCH_API_KEY = process.env.ONEINCH_API_KEY;\nexport const ONEINCH_BASE_URL = process.env.ONEINCH_BASE_URL || 'https://api.1inch.dev';\n\n// Routing mode: 'hybrid' uses 1inch for routing intelligence, 'dflow' uses dFlow, 'deterministic' uses fixed demo quotes\nexport const ROUTING_MODE: 'hybrid' | 'deterministic' | 'dflow' = \n  (process.env.ROUTING_MODE as 'hybrid' | 'deterministic' | 'dflow') || 'hybrid';\n\n// Execution swap mode: 'demo' executes via DemoSwapRouter, 'real' uses Uniswap V3 on Sepolia\nexport const EXECUTION_SWAP_MODE: 'demo' | 'real' = \n  (process.env.EXECUTION_SWAP_MODE as 'demo' | 'real') || 'demo';\n\n// Uniswap V3 SwapRouter02 address on Sepolia (for real swap execution)\nexport const UNISWAP_V3_ROUTER_ADDRESS = process.env.UNISWAP_V3_ROUTER_ADDRESS || \n  process.env.SEPOLIA_UNISWAP_V3_ROUTER || \n  '0xC532a74256D3Db42D0Bf7a0400fEFDbad7694008'; // Official Uniswap V3 SwapRouter02 on Sepolia\n\n// If true, fail when live quote fails. If false, gracefully fall back to deterministic quote.\nexport const ROUTING_REQUIRE_LIVE_QUOTE = process.env.ROUTING_REQUIRE_LIVE_QUOTE === 'true';\n\n// V1: Default to session mode for eth_testnet (one-click execution)\n// Can be overridden with EXECUTION_AUTH_MODE=direct for testing\nexport const EXECUTION_AUTH_MODE = process.env.EXECUTION_AUTH_MODE || \n  (EXECUTION_MODE === 'eth_testnet' ? 'session' : 'direct');\n\nexport const RELAYER_PRIVATE_KEY = process.env.RELAYER_PRIVATE_KEY;\n\n// V1 Demo Mode: Session-only execution, block direct mode\nexport const V1_DEMO = process.env.V1_DEMO === 'true';\n\n// Emergency Kill Switch: Block all execution if enabled\nexport const EXECUTION_DISABLED = process.env.EXECUTION_DISABLED === 'true';\n\n// Devnet Fee Configuration (25 bps = 0.25% default)\n// Valid range: 10-50 bps (0.10% - 0.50%)\nconst rawFeeBps = parseInt(process.env.BLOSSOM_FEE_BPS || '25', 10);\nexport const BLOSSOM_FEE_BPS = Math.min(50, Math.max(10, isNaN(rawFeeBps) ? 25 : rawFeeBps));\n\n// Aave V3 Pool on Sepolia (single config constant, validated at startup)\nexport const AAVE_POOL_ADDRESS_SEPOLIA = process.env.AAVE_POOL_ADDRESS_SEPOLIA || \n  '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951'; // Official Aave V3 Pool on Sepolia\n\n/**\n * Require ETH testnet configuration when in eth_testnet mode\n * Throws a clear error if required variables are missing\n */\nexport function requireEthTestnetConfig(): void {\n  if (EXECUTION_MODE !== 'eth_testnet') {\n    return; // Not required in other modes\n  }\n\n  const missing: string[] = [];\n\n  if (!EXECUTION_ROUTER_ADDRESS) {\n    missing.push('EXECUTION_ROUTER_ADDRESS');\n  }\n\n  if (!MOCK_SWAP_ADAPTER_ADDRESS) {\n    missing.push('MOCK_SWAP_ADAPTER_ADDRESS');\n  }\n\n  if (missing.length > 0) {\n    throw new Error(\n      `ETH testnet mode requires the following environment variables: ${missing.join(', ')}. ` +\n      `Please set them in your .env file or environment.`\n    );\n  }\n}\n\n/**\n * Require relayer configuration when in session mode\n * Throws a clear error if required variables are missing\n */\nexport function requireRelayerConfig(): void {\n  if (EXECUTION_MODE !== 'eth_testnet' || EXECUTION_AUTH_MODE !== 'session') {\n    return; // Not required in other modes\n  }\n\n  const missing: string[] = [];\n\n  if (!RELAYER_PRIVATE_KEY) {\n    missing.push('RELAYER_PRIVATE_KEY');\n  }\n\n  if (!ETH_TESTNET_RPC_URL) {\n    missing.push('ETH_TESTNET_RPC_URL');\n  }\n\n  if (missing.length > 0) {\n    throw new Error(\n      `Session mode requires the following environment variables: ${missing.join(', ')}. ` +\n      `Please set them in your .env file or environment.`\n    );\n  }\n}\n\n/**\n * Task 4: Validate contract configuration for eth_testnet\n * Checks chainId, router address, and adapter addresses\n * Throws clear errors if configuration is invalid\n */\nexport async function validateEthTestnetConfig(): Promise<void> {\n  if (EXECUTION_MODE !== 'eth_testnet') {\n    return; // Not required in other modes\n  }  const errors: string[] = [];\n\n  // Validate chainId\n  if (ETH_TESTNET_CHAIN_ID !== 11155111) {\n    errors.push(`ETH_TESTNET_CHAIN_ID must be 11155111 (Sepolia), got ${ETH_TESTNET_CHAIN_ID}`);\n  }\n\n  // Validate router address format\n  if (EXECUTION_ROUTER_ADDRESS) {\n    if (!/^0x[a-fA-F0-9]{40}$/.test(EXECUTION_ROUTER_ADDRESS)) {\n      errors.push(`EXECUTION_ROUTER_ADDRESS has invalid format: ${EXECUTION_ROUTER_ADDRESS}`);\n    }\n  } else {\n    errors.push('EXECUTION_ROUTER_ADDRESS is required for eth_testnet mode');\n  }\n\n  // Validate adapter addresses format (if set)\n  const adapterAddresses = [\n    { name: 'MOCK_SWAP_ADAPTER_ADDRESS', value: MOCK_SWAP_ADAPTER_ADDRESS },\n    { name: 'UNISWAP_V3_ADAPTER_ADDRESS', value: UNISWAP_V3_ADAPTER_ADDRESS },\n    { name: 'WETH_WRAP_ADAPTER_ADDRESS', value: WETH_WRAP_ADAPTER_ADDRESS },\n    { name: 'ERC20_PULL_ADAPTER_ADDRESS', value: ERC20_PULL_ADAPTER_ADDRESS },\n    { name: 'PROOF_ADAPTER_ADDRESS', value: PROOF_ADAPTER_ADDRESS },\n  ];\n\n  for (const { name, value } of adapterAddresses) {\n    if (value && !/^0x[a-fA-F0-9]{40}$/.test(value)) {\n      errors.push(`${name} has invalid format: ${value}`);\n    }\n  }\n\n  // Validate RPC URL is set and accessible\n  if (!ETH_TESTNET_RPC_URL) {\n    errors.push('ETH_TESTNET_RPC_URL is required for eth_testnet mode');\n  } else if (ETH_TESTNET_RPC_URL && !ETH_TESTNET_RPC_URL.startsWith('http')) {\n    errors.push(`ETH_TESTNET_RPC_URL must be a valid HTTP/HTTPS URL, got: ${ETH_TESTNET_RPC_URL.substring(0, 50)}...`);\n  }\n\n  // V1: Validate Aave Pool address (if using real Aave)\n  if (AAVE_POOL_ADDRESS_SEPOLIA && !/^0x[a-fA-F0-9]{40}$/.test(AAVE_POOL_ADDRESS_SEPOLIA)) {\n    errors.push(`AAVE_POOL_ADDRESS_SEPOLIA has invalid format: ${AAVE_POOL_ADDRESS_SEPOLIA}`);\n  }\n\n  if (errors.length > 0) {\n    throw new Error(\n      `ETH testnet configuration validation failed:\\n${errors.map(e => `  - ${e}`).join('\\n')}\\n` +\n      `Please check your .env file and ensure all addresses are correct Sepolia contract addresses.`\n    );\n  }\n}", "/**\n * dFlow API Client\n * Provides access to dFlow's routing and market data APIs\n * Uses fetch for minimal dependencies\n *\n * IMPORTANT: dFlow uses x-api-key header for authentication (NOT Bearer token)\n * dFlow has TWO separate API endpoints:\n * - Quote API (swaps): https://a.quote-api.dflow.net\n * - Prediction Markets API: https://prediction-markets-api.dflow.net\n */\n\nimport {\n  DFLOW_ENABLED,\n  DFLOW_API_KEY,\n  DFLOW_BASE_URL,\n  DFLOW_QUOTE_API_URL,\n  DFLOW_PREDICTION_API_URL,\n  DFLOW_EVENTS_MARKETS_PATH,\n  DFLOW_EVENTS_QUOTE_PATH,\n  DFLOW_SWAPS_QUOTE_PATH,\n} from '../../config';\n\nexport interface DflowRequestOptions {\n  method?: 'GET' | 'POST';\n  body?: Record<string, unknown>;\n  timeout?: number;\n}\n\nexport interface DflowResponse<T> {\n  ok: boolean;\n  data?: T;\n  error?: string;\n  statusCode?: number;\n}\n\n// Event market types\nexport interface DflowEventMarket {\n  id: string;\n  title: string;\n  yesPrice: number;\n  noPrice: number;\n  volume24hUsd?: number;\n  openInterestUsd?: number;\n  liquidity?: number;\n  spread?: number;\n  source?: string;\n}\n\nexport interface DflowEventQuote {\n  marketId: string;\n  outcome: 'YES' | 'NO';\n  price: number;\n  size: number;\n  impliedProbability: number;\n  liquidity: number;\n  spread: number;\n  estimatedFees?: number;\n}\n\n// Swap quote types\nexport interface DflowSwapQuote {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string;\n  amountOut: string;\n  minAmountOut: string;\n  slippageBps: number;\n  route?: string;\n  routeSummary?: string;\n  gas?: string;\n  priceImpact?: number;\n}\n\n/**\n * Check if dFlow is properly configured\n * Now checks for DFLOW_ENABLED and DFLOW_API_KEY (URLs have defaults)\n */\nexport function isDflowConfigured(): boolean {\n  // Check core requirements: enabled flag and API key\n  // URLs have defaults, so they don't need to be explicitly set\n  return !!(DFLOW_ENABLED && DFLOW_API_KEY);\n}\n\n/**\n * Get the appropriate base URL for a capability\n */\nfunction getBaseUrlForCapability(capability: 'eventsMarkets' | 'eventsQuotes' | 'swapsQuotes'): string {\n  switch (capability) {\n    case 'eventsMarkets':\n    case 'eventsQuotes':\n      return DFLOW_PREDICTION_API_URL;\n    case 'swapsQuotes':\n      return DFLOW_QUOTE_API_URL;\n    default:\n      return DFLOW_BASE_URL || DFLOW_QUOTE_API_URL;\n  }\n}\n\n/**\n * Check if a specific dFlow capability is available\n */\nexport function isDflowCapabilityAvailable(capability: 'eventsMarkets' | 'eventsQuotes' | 'swapsQuotes'): boolean {\n  if (!isDflowConfigured()) return false;\n  \n  switch (capability) {\n    case 'eventsMarkets':\n      return !!DFLOW_EVENTS_MARKETS_PATH;\n    case 'eventsQuotes':\n      return !!DFLOW_EVENTS_QUOTE_PATH;\n    case 'swapsQuotes':\n      return !!DFLOW_SWAPS_QUOTE_PATH;\n    default:\n      return false;\n  }\n}\n\n/**\n * Get dFlow capabilities summary\n */\nexport function getDflowCapabilities(): {\n  enabled: boolean;\n  eventsMarkets: boolean;\n  eventsQuotes: boolean;\n  swapsQuotes: boolean;\n} {\n  return {\n    enabled: isDflowConfigured(),\n    eventsMarkets: isDflowCapabilityAvailable('eventsMarkets'),\n    eventsQuotes: isDflowCapabilityAvailable('eventsQuotes'),\n    swapsQuotes: isDflowCapabilityAvailable('swapsQuotes'),\n  };\n}\n\n/**\n * Make a request to dFlow API\n * @param path - API path (will be appended to base URL)\n * @param options - Request options\n * @param capability - Optional capability hint to select the correct base URL\n */\nexport async function dflowRequest<T>(\n  path: string,\n  options: DflowRequestOptions = {},\n  capability?: 'eventsMarkets' | 'eventsQuotes' | 'swapsQuotes'\n): Promise<DflowResponse<T>> {\n  if (!isDflowConfigured()) {\n    return { ok: false, error: 'dFlow not configured' };\n  }\n\n  const { method = 'GET', body, timeout = 10000 } = options;\n\n  // Select the appropriate base URL based on capability\n  const baseUrl = capability\n    ? getBaseUrlForCapability(capability)\n    : (DFLOW_BASE_URL || DFLOW_QUOTE_API_URL);\n\n  const url = `${baseUrl}${path}`;\n\n  try {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n    // IMPORTANT: dFlow uses x-api-key header, NOT Bearer token\n    const response = await fetch(url, {\n      method,\n      headers: {\n        'Content-Type': 'application/json',\n        'x-api-key': DFLOW_API_KEY!,\n        'Accept': 'application/json',\n      },\n      body: body ? JSON.stringify(body) : undefined,\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    if (!response.ok) {\n      return {\n        ok: false,\n        error: `dFlow API error: ${response.status} ${response.statusText}`,\n        statusCode: response.status,\n      };\n    }\n\n    const data = await response.json();\n    return { ok: true, data: data as T, statusCode: response.status };\n  } catch (error: any) {\n    if (error.name === 'AbortError') {\n      return { ok: false, error: 'dFlow request timeout' };\n    }\n    return { ok: false, error: `dFlow request failed: ${error.message}` };\n  }\n}\n\n/**\n * Health check for dFlow API\n * Tries both the Quote API and Prediction API endpoints\n */\nexport async function dflowHealthCheck(): Promise<{ ok: boolean; latencyMs: number; error?: string; quoteApiOk?: boolean; predictionApiOk?: boolean }> {\n  if (!isDflowConfigured()) {\n    return { ok: false, latencyMs: 0, error: 'dFlow not configured' };\n  }\n\n  const startTime = Date.now();\n  let quoteApiOk = false;\n  let predictionApiOk = false;\n\n  try {\n    // Check Quote API\n    const quoteResponse = await fetch(`${DFLOW_QUOTE_API_URL}/health`, {\n      method: 'GET',\n      headers: {\n        'x-api-key': DFLOW_API_KEY!,\n      },\n    });\n    quoteApiOk = quoteResponse.ok || quoteResponse.status === 404;\n\n    // Check Prediction Markets API\n    const predictionResponse = await fetch(`${DFLOW_PREDICTION_API_URL}/health`, {\n      method: 'GET',\n      headers: {\n        'x-api-key': DFLOW_API_KEY!,\n      },\n    });\n    predictionApiOk = predictionResponse.ok || predictionResponse.status === 404;\n\n    const latencyMs = Date.now() - startTime;\n\n    // Consider healthy if at least one API is reachable\n    const ok = quoteApiOk || predictionApiOk;\n    return { ok, latencyMs, quoteApiOk, predictionApiOk };\n  } catch (error: any) {\n    return { ok: false, latencyMs: Date.now() - startTime, error: error.message, quoteApiOk, predictionApiOk };\n  }\n}\n\n/**\n * Get event markets from dFlow Prediction Markets API\n */\nexport async function getEventMarkets(): Promise<DflowResponse<DflowEventMarket[]>> {\n  // If specific path is not configured, try the default markets endpoint\n  const path = DFLOW_EVENTS_MARKETS_PATH || '/v1/markets';\n\n  return dflowRequest<DflowEventMarket[]>(path, {}, 'eventsMarkets');\n}\n\n/**\n * Get event quote from dFlow Prediction Markets API\n */\nexport async function getEventQuote(params: {\n  marketId: string;\n  outcome: 'YES' | 'NO';\n  amount: number;\n}): Promise<DflowResponse<DflowEventQuote>> {\n  // If specific path is not configured, try the default quote endpoint\n  const path = DFLOW_EVENTS_QUOTE_PATH || '/v1/quote';\n\n  return dflowRequest<DflowEventQuote>(path, {\n    method: 'POST',\n    body: params,\n  }, 'eventsQuotes');\n}\n\n/**\n * Get swap quote from dFlow Quote API\n */\nexport async function getSwapQuote(params: {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string;\n  slippageBps?: number;\n  chainId?: number;\n}): Promise<DflowResponse<DflowSwapQuote>> {\n  // If specific path is not configured, try the default quote endpoint\n  const path = DFLOW_SWAPS_QUOTE_PATH || '/v1/swap/quote';\n\n  return dflowRequest<DflowSwapQuote>(path, {\n    method: 'POST',\n    body: params,\n  }, 'swapsQuotes');\n}\n\n/**\n * Probe dFlow API endpoints for discovery\n * Tests common paths and returns status codes (never logs API key)\n * Use for dev/debug only\n */\nexport async function probeDflowEndpoints(): Promise<{\n  quoteApi: Array<{ path: string; status: number; ok: boolean; body?: string }>;\n  predictionApi: Array<{ path: string; status: number; ok: boolean; body?: string }>;\n  configured: boolean;\n  apiKeySet: boolean;\n}> {\n  const apiKeySet = !!DFLOW_API_KEY;\n  const configured = isDflowConfigured();\n  \n  const probePaths = [\n    '/',\n    '/openapi.json',\n    '/docs',\n    '/healthz',\n    '/v1',\n    '/v1/markets',\n    '/v1/events/markets',\n    '/v1/quote',\n    '/v1/swap/quote',\n  ];\n\n  const probeUrl = async (baseUrl: string, path: string): Promise<{ path: string; status: number; ok: boolean; body?: string }> => {\n    try {\n      const response = await fetch(`${baseUrl}${path}`, {\n        method: 'GET',\n        headers: apiKeySet ? {\n          'x-api-key': DFLOW_API_KEY!,\n          'Accept': 'application/json',\n        } : {\n          'Accept': 'application/json',\n        },\n      });\n      \n      let body: string | undefined;\n      try {\n        const text = await response.text();\n        body = text.substring(0, 200); // First 200 chars only\n      } catch {\n        // Ignore body read errors\n      }\n      \n      return { path, status: response.status, ok: response.ok, body };\n    } catch (error: any) {\n      return { path, status: 0, ok: false, body: `Error: ${error.message}` };\n    }\n  };\n\n  const quoteApiResults = await Promise.all(\n    probePaths.map(p => probeUrl(DFLOW_QUOTE_API_URL, p))\n  );\n  \n  const predictionApiResults = await Promise.all(\n    probePaths.map(p => probeUrl(DFLOW_PREDICTION_API_URL, p))\n  );\n\n  return {\n    quoteApi: quoteApiResults,\n    predictionApi: predictionApiResults,\n    configured,\n    apiKeySet,\n  };\n}\n\n", "/**\n * Centralized Correlation ID Generator\n * Sprint 3.1.1: Ensures globally unique correlation IDs using crypto.randomUUID()\n * \n * Usage:\n *   import { makeCorrelationId } from './utils/correlationId';\n *   const corrId = makeCorrelationId('markets'); // \"markets-550e8400-e29b-41d4-a716-446655440000\"\n */\n\nimport { randomUUID } from 'crypto';\n\n/**\n * Generate a globally unique correlation ID with optional prefix\n * Uses crypto.randomUUID() for guaranteed uniqueness\n * \n * @param prefix Optional prefix (e.g., 'markets', 'swap', 'executor')\n * @returns Correlation ID in format: \"prefix-uuid\" or just \"uuid\" if no prefix\n */\nexport function makeCorrelationId(prefix?: string): string {\n  const uuid = randomUUID();\n  return prefix ? `${prefix}-${uuid}` : uuid;\n}\n", "/**\n * Unified Routing Service\n * Sprint 3: dFlow routing with truthful metadata and deterministic fallback\n * \n * Rules:\n * - ROUTING_MODE='dflow' => hard fail if dFlow unavailable (return DFLOW_REQUIRED error)\n * - ROUTING_MODE='hybrid' => dFlow first, then fallback\n * - ROUTING_MODE='deterministic' => never call dFlow (always fallback)\n * - All responses include routing metadata (source, ok, reason, latencyMs)\n * - NEVER log API keys or include them in responses\n */\n\nimport {\n  DFLOW_ENABLED,\n  DFLOW_API_KEY,\n  ROUTING_MODE,\n} from '../config';\nimport {\n  isDflowConfigured,\n  isDflowCapabilityAvailable,\n  getSwapQuote as dflowGetSwapQuote,\n  getEventMarkets as dflowGetEventMarkets,\n  DflowSwapQuote,\n  DflowEventMarket,\n} from '../integrations/dflow/dflowClient';\nimport { makeCorrelationId } from '../utils/correlationId';\n\n// DEV-ONLY: Force dFlow failure/timeout for testing\nconst DFLOW_FORCE_FAIL = process.env.DFLOW_FORCE_FAIL === 'true' && process.env.NODE_ENV !== 'production';\nconst DFLOW_FORCE_TIMEOUT = process.env.DFLOW_FORCE_TIMEOUT === 'true' && process.env.NODE_ENV !== 'production';\n\n// DEV-ONLY: Track dFlow call count for deterministic mode proof\nlet dflowCallCount = 0;\nlet lastDflowCallAt: number | null = null;\n\nexport function getRoutingStats(): { dflowCallCount: number; lastDflowCallAt: number | null } {\n  return { dflowCallCount, lastDflowCallAt };\n}\n\nexport function resetRoutingStats(): void {\n  dflowCallCount = 0;\n  lastDflowCallAt = null;\n}\n\n/**\n * Canonical Routing Metadata Structure (Sprint 3.1)\n * Normalized across all endpoints: swap quotes, event markets, etc.\n */\n/**\n * Canonical Routing Metadata Structure (Sprint 3.1)\n * Normalized across all endpoints: swap quotes, event markets, etc.\n */\nexport interface RoutingMetadata {\n  source: 'dflow' | 'fallback';\n  kind: 'swap_quote' | 'event_markets';\n  ok: boolean;\n  reason?: string; // Only present when fallback or error\n  latencyMs: number;\n  mode: 'deterministic' | 'hybrid' | 'dflow';\n  correlationId: string;\n}\n\nexport interface RoutedSwapQuoteResult {\n  ok: boolean;\n  data?: {\n    tokenIn: string;\n    tokenOut: string;\n    amountIn: string;\n    amountOut: string;\n    minAmountOut: string;\n    slippageBps: number;\n    route?: string;\n    routeSummary?: string;\n    gas?: string;\n    priceImpact?: number;\n  };\n  routing: RoutingMetadata;\n  error?: {\n    code: string;\n    message: string;\n  };\n}\n\nexport interface RoutedEventMarketsResult {\n  ok: boolean;\n  data?: Array<{\n    id: string;\n    title: string;\n    yesPrice: number;\n    noPrice: number;\n    volume24hUsd?: number;\n    openInterestUsd?: number;\n    liquidity?: number;\n    spread?: number;\n  }>;\n  routing: RoutingMetadata;\n  error?: {\n    code: string;\n    message: string;\n  };\n}\n\n/**\n * Get swap quote with routing metadata\n */\nexport async function getSwapQuoteRouted(params: {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string;\n  slippageBps?: number;\n  chainId?: number;\n  fallbackQuote?: () => Promise<{ amountOut: string; minAmountOut: string; routeSummary?: string; gas?: string } | null>;\n  correlationId?: string; // Optional: if not provided, will generate one\n}): Promise<RoutedSwapQuoteResult> {\n  const startTime = Date.now();\n  const correlationId = params.correlationId || makeCorrelationId('swap');\n  const { tokenIn, tokenOut, amountIn, slippageBps, chainId, fallbackQuote } = params;\n  \n  // DEV-ONLY: Log routing request\n  if (process.env.NODE_ENV !== 'production') {\n    console.log(`[ROUTING] kind=swap_quote mode=${ROUTING_MODE} corr=${correlationId}`);\n  }\n\n  // ROUTING_MODE='deterministic' => never call dFlow\n  if (ROUTING_MODE === 'deterministic') {\n    if (fallbackQuote) {\n      const fallbackData = await fallbackQuote();\n      const latencyMs = Date.now() - startTime;\n      if (fallbackData) {\n        // DEV-ONLY: Log routing result\n        if (process.env.NODE_ENV !== 'production') {\n          console.log(`[ROUTING] kind=swap_quote source=fallback latencyMs=${latencyMs} corr=${correlationId}`);\n        }\n        return {\n          ok: true,\n          data: {\n            tokenIn,\n            tokenOut,\n            amountIn,\n            amountOut: fallbackData.amountOut,\n            minAmountOut: fallbackData.minAmountOut,\n            slippageBps: slippageBps || 50,\n            routeSummary: fallbackData.routeSummary,\n            gas: fallbackData.gas,\n          },\n          routing: {\n            source: 'fallback',\n            kind: 'swap_quote',\n            ok: true,\n            reason: 'ROUTING_MODE=deterministic (dFlow disabled)',\n            latencyMs,\n            mode: 'deterministic',\n            correlationId,\n          },\n        };\n      }\n    }\n    const latencyMs = Date.now() - startTime;\n    return {\n      ok: false,\n      routing: {\n        source: 'fallback',\n        kind: 'swap_quote',\n        ok: false,\n        reason: 'ROUTING_MODE=deterministic and fallback unavailable',\n        latencyMs,\n        mode: 'deterministic',\n        correlationId,\n      },\n      error: {\n        code: 'FALLBACK_UNAVAILABLE',\n        message: 'Deterministic routing mode requires fallback quote provider',\n      },\n    };\n  }\n\n  // ROUTING_MODE='dflow' => hard fail if dFlow unavailable\n  if (ROUTING_MODE === 'dflow') {\n    if (!isDflowConfigured() || !isDflowCapabilityAvailable('swapsQuotes')) {\n      const latencyMs = Date.now() - startTime;\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'swap_quote',\n          ok: false,\n          reason: 'dFlow not configured or swapsQuotes capability unavailable',\n          latencyMs,\n          mode: ROUTING_MODE as 'deterministic' | 'hybrid' | 'dflow',\n          correlationId,\n        },\n        error: {\n          code: 'DFLOW_REQUIRED',\n          message: 'ROUTING_MODE=dflow requires dFlow to be configured and available',\n        },\n      };\n    }\n\n    // Try dFlow (or force fail/timeout in DEV mode)\n    if (DFLOW_FORCE_FAIL) {\n      const latencyMs = Date.now() - startTime;\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'swap_quote',\n          ok: false,\n          reason: 'DEV: DFLOW_FORCE_FAIL=true (testing fallback)',\n          latencyMs,\n          mode: 'dflow',\n          correlationId,\n        },\n        error: {\n          code: 'DFLOW_REQUIRED',\n          message: 'dFlow routing required but forced to fail (DEV mode)',\n        },\n      };\n    }\n\n    if (DFLOW_FORCE_TIMEOUT) {\n      // Simulate timeout by waiting longer than default timeout (10s)\n      await new Promise(resolve => setTimeout(resolve, 11000));\n    }\n\n    // Track dFlow call (for deterministic mode proof)\n    dflowCallCount++;\n    lastDflowCallAt = Date.now();\n\n    const dflowResult = await dflowGetSwapQuote({\n      tokenIn,\n      tokenOut,\n      amountIn,\n      slippageBps,\n      chainId,\n    });\n\n    const latencyMs = Date.now() - startTime;\n    \n    // DEV-ONLY: Log routing result\n    if (process.env.NODE_ENV !== 'production') {\n      console.log(`[ROUTING] kind=swap_quote source=${dflowResult.ok ? 'dflow' : 'fallback'} latencyMs=${latencyMs} corr=${correlationId}`);\n    }\n\n    if (dflowResult.ok && dflowResult.data) {\n      return {\n        ok: true,\n        data: {\n          tokenIn: dflowResult.data.tokenIn,\n          tokenOut: dflowResult.data.tokenOut,\n          amountIn: dflowResult.data.amountIn,\n          amountOut: dflowResult.data.amountOut,\n          minAmountOut: dflowResult.data.minAmountOut,\n          slippageBps: dflowResult.data.slippageBps,\n          route: dflowResult.data.route,\n          routeSummary: dflowResult.data.routeSummary,\n          gas: dflowResult.data.gas,\n          priceImpact: dflowResult.data.priceImpact,\n        },\n        routing: {\n          source: 'dflow',\n          kind: 'swap_quote',\n          ok: true,\n          latencyMs,\n          mode: 'dflow',\n          correlationId,\n        },\n      };\n    }\n\n    // dFlow failed in dflow mode => hard fail\n    const errorReason = dflowResult.error || (DFLOW_FORCE_TIMEOUT ? 'timeout' : `HTTP ${dflowResult.statusCode || 'unknown'}`);\n    return {\n      ok: false,\n      routing: {\n        source: 'dflow',\n        kind: 'swap_quote',\n        ok: false,\n        reason: errorReason,\n        latencyMs,\n        mode: 'dflow',\n        correlationId,\n      },\n      error: {\n        code: 'DFLOW_REQUIRED',\n        message: `dFlow routing required but failed: ${errorReason}`,\n      },\n    };\n  }\n\n  // ROUTING_MODE='hybrid' => dFlow first, then fallback\n  if (ROUTING_MODE === 'hybrid' || DFLOW_ENABLED) {\n    // Try dFlow first (unless forced to fail/timeout in DEV)\n    if (!DFLOW_FORCE_FAIL && !DFLOW_FORCE_TIMEOUT && isDflowConfigured() && isDflowCapabilityAvailable('swapsQuotes')) {\n      // Track dFlow call\n      dflowCallCount++;\n      lastDflowCallAt = Date.now();\n\n      const dflowResult = await dflowGetSwapQuote({\n        tokenIn,\n        tokenOut,\n        amountIn,\n        slippageBps,\n        chainId,\n      });\n\n      const latencyMs = Date.now() - startTime;\n      \n      // DEV-ONLY: Log routing result\n      if (process.env.NODE_ENV !== 'production') {\n        console.log(`[ROUTING] kind=swap_quote source=${dflowResult.ok ? 'dflow' : 'fallback'} latencyMs=${latencyMs} corr=${correlationId}`);\n      }\n\n      if (dflowResult.ok && dflowResult.data) {\n        return {\n          ok: true,\n          data: {\n            tokenIn: dflowResult.data.tokenIn,\n            tokenOut: dflowResult.data.tokenOut,\n            amountIn: dflowResult.data.amountIn,\n            amountOut: dflowResult.data.amountOut,\n            minAmountOut: dflowResult.data.minAmountOut,\n            slippageBps: dflowResult.data.slippageBps,\n            route: dflowResult.data.route,\n            routeSummary: dflowResult.data.routeSummary,\n            gas: dflowResult.data.gas,\n            priceImpact: dflowResult.data.priceImpact,\n          },\n          routing: {\n            source: 'dflow',\n            kind: 'swap_quote',\n            ok: true,\n            latencyMs,\n            mode: ROUTING_MODE,\n            correlationId,\n          },\n        };\n      }\n\n      // dFlow failed, try fallback\n      if (fallbackQuote) {\n        const fallbackStartTime = Date.now();\n        const fallbackData = await fallbackQuote();\n        const totalLatencyMs = Date.now() - startTime;\n        \n        if (fallbackData) {\n          const fallbackReason = DFLOW_FORCE_FAIL \n            ? 'DEV: DFLOW_FORCE_FAIL=true (forced_fail)'\n            : DFLOW_FORCE_TIMEOUT\n            ? 'DEV: DFLOW_FORCE_TIMEOUT=true (timeout)'\n            : `dFlow failed: ${dflowResult.error || `HTTP ${dflowResult.statusCode || 'unknown'}`}`;\n          \n          return {\n            ok: true,\n            data: {\n              tokenIn,\n              tokenOut,\n              amountIn,\n              amountOut: fallbackData.amountOut,\n              minAmountOut: fallbackData.minAmountOut,\n              slippageBps: slippageBps || 50,\n              routeSummary: fallbackData.routeSummary,\n              gas: fallbackData.gas,\n            },\n            routing: {\n              source: 'fallback',\n              kind: 'swap_quote',\n              ok: true,\n              reason: fallbackReason,\n              latencyMs: totalLatencyMs,\n              mode: ROUTING_MODE,\n              correlationId,\n            },\n          };\n        }\n      }\n\n      // Both dFlow and fallback failed\n      const errorReason = DFLOW_FORCE_TIMEOUT ? 'timeout' : (dflowResult.error || `HTTP ${dflowResult.statusCode || 'unknown'}`);\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'swap_quote',\n          ok: false,\n          reason: errorReason,\n          latencyMs,\n          mode: ROUTING_MODE,\n          correlationId,\n        },\n        error: {\n          code: 'ROUTING_FAILED',\n          message: `dFlow failed and fallback unavailable: ${errorReason}`,\n        },\n      };\n    }\n  }\n\n  // dFlow not enabled or not available, use fallback\n  if (fallbackQuote) {\n    const fallbackData = await fallbackQuote();\n    const latencyMs = Date.now() - startTime;\n    \n    if (fallbackData) {\n      return {\n        ok: true,\n        data: {\n          tokenIn,\n          tokenOut,\n          amountIn,\n          amountOut: fallbackData.amountOut,\n          minAmountOut: fallbackData.minAmountOut,\n          slippageBps: slippageBps || 50,\n          routeSummary: fallbackData.routeSummary,\n          gas: fallbackData.gas,\n        },\n        routing: {\n          source: 'fallback',\n          kind: 'swap_quote',\n          ok: true,\n          reason: 'dFlow not enabled or unavailable',\n          latencyMs,\n          mode: ROUTING_MODE,\n          correlationId,\n        },\n      };\n    }\n  }\n\n  // No routing available\n  const latencyMs = Date.now() - startTime;\n  return {\n    ok: false,\n    routing: {\n      source: 'fallback',\n      kind: 'swap_quote',\n      ok: false,\n      reason: 'No routing providers available',\n      latencyMs,\n      mode: ROUTING_MODE,\n      correlationId,\n    },\n    error: {\n      code: 'ROUTING_UNAVAILABLE',\n      message: 'No swap quote routing available',\n    },\n  };\n}\n\n/**\n * Get event markets with routing metadata\n */\nexport async function getEventMarketsRouted(params: {\n  limit?: number;\n  fallbackMarkets?: () => Promise<Array<{\n    id: string;\n    title: string;\n    yesPrice: number;\n    noPrice: number;\n    volume24hUsd?: number;\n  }>>;\n  correlationId?: string; // Optional: if not provided, will generate one\n}): Promise<RoutedEventMarketsResult> {\n  const startTime = Date.now();\n  const correlationId = params.correlationId || makeCorrelationId('markets');\n  const { limit = 10, fallbackMarkets } = params;\n  \n  // DEV-ONLY: Log routing request\n  if (process.env.NODE_ENV !== 'production') {\n    console.log(`[ROUTING] kind=event_markets mode=${ROUTING_MODE} corr=${correlationId}`);\n  }\n\n  // ROUTING_MODE='deterministic' => never call dFlow\n  if (ROUTING_MODE === 'deterministic') {\n    if (fallbackMarkets) {\n      const fallbackData = await fallbackMarkets();\n      const latencyMs = Date.now() - startTime;\n      // DEV-ONLY: Log routing result\n      if (process.env.NODE_ENV !== 'production') {\n        console.log(`[ROUTING] kind=event_markets source=fallback latencyMs=${latencyMs} corr=${correlationId}`);\n      }\n      return {\n        ok: true,\n        data: fallbackData.slice(0, limit),\n        routing: {\n          source: 'fallback',\n          kind: 'event_markets',\n          ok: true,\n          reason: 'ROUTING_MODE=deterministic (dFlow disabled)',\n          latencyMs,\n          mode: 'deterministic',\n          correlationId,\n        },\n      };\n    }\n    const latencyMs = Date.now() - startTime;\n    return {\n      ok: false,\n      routing: {\n        source: 'fallback',\n        kind: 'event_markets',\n        ok: false,\n        reason: 'ROUTING_MODE=deterministic and fallback unavailable',\n        latencyMs,\n        mode: 'deterministic',\n        correlationId,\n      },\n      error: {\n        code: 'FALLBACK_UNAVAILABLE',\n        message: 'Deterministic routing mode requires fallback markets provider',\n      },\n    };\n  }\n\n  // ROUTING_MODE='dflow' => hard fail if dFlow unavailable\n  if (ROUTING_MODE === 'dflow') {\n    if (!isDflowConfigured() || !isDflowCapabilityAvailable('eventsMarkets')) {\n      const latencyMs = Date.now() - startTime;\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'event_markets',\n          ok: false,\n          reason: 'dFlow not configured or eventsMarkets capability unavailable',\n          latencyMs,\n          mode: ROUTING_MODE as 'deterministic' | 'hybrid' | 'dflow',\n          correlationId,\n        },\n        error: {\n          code: 'DFLOW_REQUIRED',\n          message: 'ROUTING_MODE=dflow requires dFlow to be configured and available',\n        },\n      };\n    }\n\n    // Try dFlow (or force fail/timeout in DEV mode)\n    if (DFLOW_FORCE_FAIL) {\n      const latencyMs = Date.now() - startTime;\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'event_markets',\n          ok: false,\n          reason: 'DEV: DFLOW_FORCE_FAIL=true (testing fallback)',\n          latencyMs,\n          mode: 'dflow',\n          correlationId,\n        },\n        error: {\n          code: 'DFLOW_REQUIRED',\n          message: 'dFlow routing required but forced to fail (DEV mode)',\n        },\n      };\n    }\n\n    if (DFLOW_FORCE_TIMEOUT) {\n      // Simulate timeout by waiting longer than default timeout (10s)\n      await new Promise(resolve => setTimeout(resolve, 11000));\n    }\n\n    // Track dFlow call\n    dflowCallCount++;\n    lastDflowCallAt = Date.now();\n\n    const dflowResult = await dflowGetEventMarkets();\n    const latencyMs = Date.now() - startTime;\n    \n    // DEV-ONLY: Log routing result\n    if (process.env.NODE_ENV !== 'production') {\n      console.log(`[ROUTING] kind=event_markets source=${dflowResult.ok ? 'dflow' : 'fallback'} latencyMs=${latencyMs} corr=${correlationId}`);\n    }\n\n    if (dflowResult.ok && dflowResult.data && Array.isArray(dflowResult.data) && dflowResult.data.length > 0) {\n      return {\n        ok: true,\n        data: dflowResult.data.slice(0, limit).map(m => ({\n          id: m.id,\n          title: m.title,\n          yesPrice: m.yesPrice,\n          noPrice: m.noPrice,\n          volume24hUsd: m.volume24hUsd,\n          openInterestUsd: m.openInterestUsd,\n          liquidity: m.liquidity,\n          spread: m.spread,\n        })),\n        routing: {\n          source: 'dflow',\n          kind: 'event_markets',\n          ok: true,\n          latencyMs,\n          mode: 'dflow',\n          correlationId,\n        },\n      };\n    }\n\n    // dFlow failed in dflow mode => hard fail\n    const errorReason = dflowResult.error || (DFLOW_FORCE_TIMEOUT ? 'timeout' : `HTTP ${dflowResult.statusCode || 'unknown'}`);\n    return {\n      ok: false,\n      routing: {\n        source: 'dflow',\n        kind: 'event_markets',\n        ok: false,\n        reason: errorReason,\n        latencyMs,\n        mode: 'dflow',\n        correlationId,\n      },\n      error: {\n        code: 'DFLOW_REQUIRED',\n        message: `dFlow routing required but failed: ${errorReason}`,\n      },\n    };\n  }\n\n  // ROUTING_MODE='hybrid' => dFlow first, then fallback\n  if (ROUTING_MODE === 'hybrid' || DFLOW_ENABLED) {\n    // Try dFlow first (unless forced to fail/timeout in DEV)\n    if (!DFLOW_FORCE_FAIL && !DFLOW_FORCE_TIMEOUT && isDflowConfigured() && isDflowCapabilityAvailable('eventsMarkets')) {\n      // Track dFlow call\n      dflowCallCount++;\n      lastDflowCallAt = Date.now();\n\n      const dflowResult = await dflowGetEventMarkets();\n      const latencyMs = Date.now() - startTime;\n      \n      // DEV-ONLY: Log routing result\n      if (process.env.NODE_ENV !== 'production') {\n        console.log(`[ROUTING] kind=event_markets source=${dflowResult.ok ? 'dflow' : 'fallback'} latencyMs=${latencyMs} corr=${correlationId}`);\n      }\n\n      if (dflowResult.ok && dflowResult.data && Array.isArray(dflowResult.data) && dflowResult.data.length > 0) {\n        return {\n          ok: true,\n          data: dflowResult.data.slice(0, limit).map(m => ({\n            id: m.id,\n            title: m.title,\n            yesPrice: m.yesPrice,\n            noPrice: m.noPrice,\n            volume24hUsd: m.volume24hUsd,\n            openInterestUsd: m.openInterestUsd,\n            liquidity: m.liquidity,\n            spread: m.spread,\n          })),\n          routing: {\n            source: 'dflow',\n            kind: 'event_markets',\n            ok: true,\n            latencyMs,\n            mode: ROUTING_MODE,\n            correlationId,\n          },\n        };\n      }\n\n      // dFlow failed, try fallback\n      if (fallbackMarkets) {\n        const fallbackData = await fallbackMarkets();\n        const totalLatencyMs = Date.now() - startTime;\n        \n        const fallbackReason = DFLOW_FORCE_FAIL \n          ? 'DEV: DFLOW_FORCE_FAIL=true (forced_fail)'\n          : DFLOW_FORCE_TIMEOUT\n          ? 'DEV: DFLOW_FORCE_TIMEOUT=true (timeout)'\n          : `dFlow failed: ${dflowResult.error || `HTTP ${dflowResult.statusCode || 'unknown'}`}`;\n        \n        return {\n          ok: true,\n          data: fallbackData.slice(0, limit),\n          routing: {\n            source: 'fallback',\n            kind: 'event_markets',\n            ok: true,\n            reason: fallbackReason,\n            latencyMs: totalLatencyMs,\n            mode: ROUTING_MODE,\n            correlationId,\n          },\n        };\n      }\n\n      // dFlow failed, no fallback\n      const errorReason = DFLOW_FORCE_TIMEOUT ? 'timeout' : (dflowResult.error || `HTTP ${dflowResult.statusCode || 'unknown'}`);\n      return {\n        ok: false,\n        routing: {\n          source: 'dflow',\n          kind: 'event_markets',\n          ok: false,\n          reason: errorReason,\n          latencyMs,\n          mode: ROUTING_MODE,\n          correlationId,\n        },\n        error: {\n          code: 'ROUTING_FAILED',\n          message: `dFlow failed and fallback unavailable: ${errorReason}`,\n        },\n      };\n    }\n  }\n\n  // dFlow not enabled or not available, use fallback\n  if (fallbackMarkets) {\n    const fallbackData = await fallbackMarkets();\n    const latencyMs = Date.now() - startTime;\n    \n    // DEV-ONLY: Log routing result\n    if (process.env.NODE_ENV !== 'production') {\n      console.log(`[ROUTING] kind=event_markets source=fallback latencyMs=${latencyMs} corr=${correlationId}`);\n    }\n    \n    return {\n      ok: true,\n      data: fallbackData.slice(0, limit),\n      routing: {\n        source: 'fallback',\n        kind: 'event_markets',\n        ok: true,\n        reason: 'dFlow not enabled or unavailable',\n        latencyMs,\n        mode: ROUTING_MODE,\n        correlationId,\n      },\n    };\n  }\n\n  // No routing available\n  const latencyMs = Date.now() - startTime;\n  return {\n    ok: false,\n    routing: {\n      source: 'fallback',\n      kind: 'event_markets',\n      ok: false,\n      reason: 'No routing providers available',\n      latencyMs,\n      mode: ROUTING_MODE,\n      correlationId,\n    },\n    error: {\n      code: 'ROUTING_UNAVAILABLE',\n      message: 'No event markets routing available',\n    },\n  };\n}\n", "/**\n * Event Markets Quote Provider\n * Fetches event market data from dFlow or Polymarket\n * Caches results in-memory for 60 seconds\n *\n * IMPORTANT: dFlow uses x-api-key header for authentication (NOT Bearer token)\n * \n * Sprint 3: Now uses unified routing service with truthful metadata\n */\n\nimport { DFLOW_ENABLED, DFLOW_API_KEY, DFLOW_PREDICTION_API_URL, DFLOW_EVENTS_MARKETS_PATH } from '../config';\nimport { isDflowConfigured, getEventMarkets as dflowGetEventMarkets } from '../integrations/dflow/dflowClient';\nimport { getEventMarketsRouted, RoutingMetadata } from '../routing/routingService';\n\nexport interface EventMarket {\n  id: string;\n  title: string;\n  yesPrice: number; // 0-1 probability\n  noPrice: number; // 0-1 probability\n  volume24hUsd?: number;\n  source: 'dflow' | 'polymarket' | 'fallback';\n}\n\nexport interface EventMarketsWithRouting {\n  markets: EventMarket[];\n  routing: RoutingMetadata;\n}\n\n// In-memory cache (60 seconds)\nlet cachedMarkets: EventMarket[] | null = null;\nlet cacheTimestamp: number = 0;\nconst CACHE_TTL_MS = 60 * 1000; // 60 seconds\n\n// Hardcoded fallback markets (harmonized IDs to match predictionData.ts)\nconst FALLBACK_MARKETS: EventMarket[] = [\n  { id: 'FED_CUTS_MAR_2025', title: 'Fed cuts in March 2025', yesPrice: 0.62, noPrice: 0.38, source: 'fallback' },\n  { id: 'BTC_ETF_APPROVAL_2025', title: 'BTC ETF approved by Dec 31', yesPrice: 0.68, noPrice: 0.32, source: 'fallback' },\n  { id: 'ETH_ETF_APPROVAL_2025', title: 'ETH ETF approved by June 2025', yesPrice: 0.58, noPrice: 0.42, source: 'fallback' },\n  { id: 'TRUMP_2024_WIN', title: 'Trump wins 2024 election', yesPrice: 0.52, noPrice: 0.48, source: 'fallback' },\n  { id: 'SOL_ADOPTION_2025', title: 'Solana adoption surges in 2025', yesPrice: 0.64, noPrice: 0.36, source: 'fallback' },\n];\n\n/**\n * Fetch event markets from dFlow if enabled, else Polymarket, else fallback\n * Sprint 3: Now uses unified routing service with truthful metadata\n */\nexport async function getEventMarkets(limit: number = 10): Promise<EventMarket[]> {\n  // Check cache\n  const now = Date.now();\n  if (cachedMarkets && (now - cacheTimestamp) < CACHE_TTL_MS) {\n    return cachedMarkets.slice(0, limit);\n  }\n\n  // Use routing service\n  const { makeCorrelationId } = await import('../utils/correlationId');\n  const routingCorrelationId = makeCorrelationId('markets');\n  const routedResult = await getEventMarketsRouted({\n    limit,\n    correlationId: routingCorrelationId,\n    fallbackMarkets: async () => {\n      // Try Polymarket\n      try {\n        const response = await fetch('https://clob.polymarket.com/markets', {\n          headers: {\n            'Accept': 'application/json',\n          },\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n          // Transform Polymarket response to EventMarket format\n          const markets: EventMarket[] = Array.isArray(data) ? data\n            .filter((m: any) => m.question && m.conditionId)\n            .map((m: any) => ({\n              id: m.conditionId || m.id || `poly-${Date.now()}-${Math.random()}`,\n              title: m.question || m.title || 'Unknown Market',\n              yesPrice: m.outcomes?.[0]?.price || 0.5,\n              noPrice: m.outcomes?.[1]?.price || 0.5,\n              volume24hUsd: m.volume24h || 0,\n              source: 'polymarket' as const,\n            })) : [];\n          \n          return markets;\n        }\n      } catch (error: any) {\n        console.warn('[getEventMarkets] Polymarket fetch failed:', error.message);\n      }\n      \n      // Return fallback\n      return FALLBACK_MARKETS;\n    },\n  });\n\n  if (routedResult.ok && routedResult.data) {\n    // Transform routed data to EventMarket format\n    const markets: EventMarket[] = routedResult.data.map(m => ({\n      id: m.id,\n      title: m.title,\n      yesPrice: m.yesPrice,\n      noPrice: m.noPrice,\n      volume24hUsd: m.volume24hUsd,\n      source: routedResult.routing.source === 'dflow' ? 'dflow' : 'polymarket',\n    }));\n\n    cachedMarkets = markets;\n    cacheTimestamp = now;\n    return markets;\n  }\n\n  // Fallback if routing service fails\n  cachedMarkets = FALLBACK_MARKETS;\n  cacheTimestamp = now;\n  return FALLBACK_MARKETS.slice(0, limit);\n}\n\n/**\n * Get event markets with routing metadata (Sprint 3)\n */\nexport async function getEventMarketsWithRouting(limit: number = 10): Promise<EventMarketsWithRouting> {\n  const { makeCorrelationId } = await import('../utils/correlationId');\n  const routingCorrelationId = makeCorrelationId('markets');\n  const routedResult = await getEventMarketsRouted({\n    limit,\n    correlationId: routingCorrelationId,\n    fallbackMarkets: async () => {\n      // Try Polymarket\n      try {\n        const response = await fetch('https://clob.polymarket.com/markets', {\n          headers: {\n            'Accept': 'application/json',\n          },\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n          const markets: EventMarket[] = Array.isArray(data) ? data\n            .filter((m: any) => m.question && m.conditionId)\n            .map((m: any) => ({\n              id: m.conditionId || m.id || `poly-${Date.now()}-${Math.random()}`,\n              title: m.question || m.title || 'Unknown Market',\n              yesPrice: m.outcomes?.[0]?.price || 0.5,\n              noPrice: m.outcomes?.[1]?.price || 0.5,\n              volume24hUsd: m.volume24h || 0,\n              source: 'polymarket' as const,\n            })) : [];\n          \n          return markets;\n        }\n      } catch (error: any) {\n        // Ignore\n      }\n      \n      return FALLBACK_MARKETS;\n    },\n  });\n\n  // Ensure routing metadata always exists (guard against undefined)\n  const routing = routedResult.routing || {\n    source: 'fallback' as const,\n    kind: 'event_markets' as const,\n    ok: false,\n    reason: 'Routing service returned no metadata',\n    latencyMs: 0,\n    mode: 'hybrid' as const,\n    correlationId: routingCorrelationId,\n  };\n\n  if (routedResult.ok && routedResult.data) {\n    const markets: EventMarket[] = routedResult.data.map(m => ({\n      id: m.id,\n      title: m.title,\n      yesPrice: m.yesPrice,\n      noPrice: m.noPrice,\n      volume24hUsd: m.volume24hUsd,\n      source: routing.source === 'dflow' ? 'dflow' : 'polymarket',\n    }));\n\n    return {\n      markets,\n      routing,\n    };\n  }\n\n  // Fallback\n  return {\n    markets: FALLBACK_MARKETS.slice(0, limit),\n    routing,\n  };\n}\n\n/**\n * Find event market by keyword match\n */\nexport async function findEventMarketByKeyword(keyword: string): Promise<EventMarket | null> {\n  const markets = await getEventMarkets(10);\n  const lowerKeyword = keyword.toLowerCase();\n  \n  // Simple string search\n  const match = markets.find(m => \n    m.title.toLowerCase().includes(lowerKeyword) ||\n    lowerKeyword.includes(m.title.toLowerCase().split(' ')[0])\n  );\n  \n  return match || markets[0] || null; // Return first market if no match\n}\n\n", "/**\n * Action Parser and Validator\n * Parses and validates BlossomAction[] from LLM JSON output\n */\n\nimport { BlossomAction, BlossomPortfolioSnapshot, BlossomExecutionRequest } from '../types/blossom';\nimport { blossomCharacter } from '../characters/blossom';\nimport { getTopKalshiMarketsByVolume, getTopPolymarketMarketsByVolume, getHighestVolumeMarket, RawPredictionMarket } from '../services/predictionData';\n\n/**\n * Validate and sanitize actions from LLM output\n */\nexport function validateActions(raw: any): BlossomAction[] {\n  if (!Array.isArray(raw)) {\n    console.warn('Actions is not an array:', typeof raw);\n    return [];\n  }\n\n  const validActions: BlossomAction[] = [];\n\n  for (const item of raw) {\n    try {\n      if (!item || typeof item !== 'object') {\n        console.warn('Invalid action item (not an object):', item);\n        continue;\n      }\n\n      if (item.type === 'perp' && item.action === 'open') {\n        // Validate perp action\n        if (\n          typeof item.market === 'string' &&\n          (item.side === 'long' || item.side === 'short') &&\n          typeof item.riskPct === 'number' &&\n          item.riskPct > 0 &&\n          item.riskPct <= 5 && // Enforce 5% max\n          Array.isArray(item.reasoning)\n        ) {\n          validActions.push({\n            type: 'perp',\n            action: 'open',\n            market: item.market,\n            side: item.side,\n            riskPct: Math.min(item.riskPct, 5), // Cap at 5%\n            entry: typeof item.entry === 'number' ? item.entry : undefined,\n            takeProfit: typeof item.takeProfit === 'number' ? item.takeProfit : undefined,\n            stopLoss: typeof item.stopLoss === 'number' ? item.stopLoss : undefined,\n            reasoning: item.reasoning.filter((r: any) => typeof r === 'string'),\n          });\n        } else {\n          console.warn('Invalid perp action:', item);\n        }\n      } else if (item.type === 'defi' && item.action === 'deposit') {\n        // Validate defi action\n        if (\n          typeof item.protocol === 'string' &&\n          typeof item.asset === 'string' &&\n          typeof item.amountUsd === 'number' &&\n          item.amountUsd > 0 &&\n          typeof item.apr === 'number' &&\n          Array.isArray(item.reasoning)\n        ) {\n          validActions.push({\n            type: 'defi',\n            action: 'deposit',\n            protocol: item.protocol,\n            asset: item.asset,\n            amountUsd: item.amountUsd,\n            apr: item.apr,\n            reasoning: item.reasoning.filter((r: any) => typeof r === 'string'),\n          });\n        } else {\n          console.warn('Invalid defi action:', item);\n        }\n      } else if (item.type === 'event' && item.action === 'open') {\n        // Validate event action\n        if (\n          typeof item.eventKey === 'string' &&\n          typeof item.label === 'string' &&\n          (item.side === 'YES' || item.side === 'NO') &&\n          typeof item.stakeUsd === 'number' &&\n          item.stakeUsd > 0 &&\n          typeof item.maxPayoutUsd === 'number' &&\n          typeof item.maxLossUsd === 'number' &&\n          Array.isArray(item.reasoning)\n        ) {\n          validActions.push({\n            type: 'event',\n            action: 'open',\n            eventKey: item.eventKey,\n            label: item.label,\n            side: item.side,\n            stakeUsd: item.stakeUsd,\n            maxPayoutUsd: item.maxPayoutUsd,\n            maxLossUsd: item.maxLossUsd,\n            reasoning: item.reasoning.filter((r: any) => typeof r === 'string'),\n            overrideRiskCap: typeof item.overrideRiskCap === 'boolean' ? item.overrideRiskCap : undefined,\n            requestedStakeUsd: typeof item.requestedStakeUsd === 'number' ? item.requestedStakeUsd : undefined,\n          });\n        } else {\n          console.warn('Invalid event action:', item);\n        }\n      } else if (item.type === 'event' && item.action === 'update') {\n        // Validate event update action\n        if (\n          typeof item.positionId === 'string' &&\n          typeof item.eventKey === 'string' &&\n          typeof item.label === 'string' &&\n          (item.side === 'YES' || item.side === 'NO') &&\n          typeof item.stakeUsd === 'number' &&\n          item.stakeUsd > 0 &&\n          typeof item.maxPayoutUsd === 'number' &&\n          typeof item.maxLossUsd === 'number' &&\n          Array.isArray(item.reasoning)\n        ) {\n          validActions.push({\n            type: 'event',\n            action: 'update',\n            eventKey: item.eventKey,\n            label: item.label,\n            side: item.side,\n            stakeUsd: item.stakeUsd,\n            maxPayoutUsd: item.maxPayoutUsd,\n            maxLossUsd: item.maxLossUsd,\n            reasoning: item.reasoning.filter((r: any) => typeof r === 'string'),\n            positionId: item.positionId,\n            overrideRiskCap: typeof item.overrideRiskCap === 'boolean' ? item.overrideRiskCap : false,\n            requestedStakeUsd: typeof item.requestedStakeUsd === 'number' ? item.requestedStakeUsd : undefined,\n          });\n        } else {\n          console.warn('Invalid event update action:', item);\n        }\n      } else {\n        console.warn('Unknown action type or action:', item);\n      }\n    } catch (error: any) {\n      console.warn('Error validating action:', error.message, item);\n    }\n  }\n\n  return validActions;\n}\n\n/**\n * Build prompts for Blossom LLM\n */\nexport async function buildBlossomPrompts(args: {\n  userMessage: string;\n  portfolio: BlossomPortfolioSnapshot | null;\n  venue: 'hyperliquid' | 'event_demo';\n}): Promise<{ systemPrompt: string; userPrompt: string; isPredictionMarketQuery: boolean }> {\n  const { userMessage, portfolio, venue } = args;\n\n  const systemPrompt = `You are Blossom, an AI trading copilot. You speak clearly and concisely, like a professional portfolio manager. You always:\n\n1. Restate the user's intent in one sentence.\n2. Summarize the strategy in 2-3 bullet points.\n3. Highlight risk in plain language.\n4. Suggest one simple next step or question.\n\nCRITICAL - Risk Management Rules:\n- Default per-strategy risk cap: 3% of the total account value.\n- NEVER exceed 5% of the total account value for any single strategy.\n- Event market stake cap: 2-3% of the total account value.\n- Single DeFi protocol cap: ~25% of idle capital (REDACTED balance).\n- Always provide clear reasoning bullets for each action.\n\nCRITICAL - Environment:\n- This is a SIMULATED demo environment. NO REAL ORDERS OR TRANSACTIONS WILL BE EXECUTED.\n- All actions are purely for demonstration and testing purposes.\n- Mention \"In this SIM environment...\" occasionally to remind users.\n\nCRITICAL - Never Say \"I Can't Process\":\n- If the user's intent is unclear, ASK a clarifying question instead of saying \"I can't process\" or \"I cannot\".\n- Example clarifying questions:\n  * \"I'd be happy to help! Are you looking to swap, trade perps, or explore yield opportunities?\"\n  * \"Got it, you want to trade. What asset and how much would you like to use?\"\n  * \"I see you're interested in prediction markets. Would you like me to show top markets by volume?\"\n- ONLY respond with an error if the request is truly impossible (e.g., unsupported chain, invalid token).\n- When in doubt, offer 2-3 options for the user to choose from.\n- If user says something vague like \"I want to make money\" or \"help me invest\", suggest concrete options.\n\nCRITICAL - Token Inference:\n- \"I have ETH\" or \"I only have ETH\" + swap request \u2192 tokenIn is ETH\n- \"Convert my REDACTED\" \u2192 tokenIn is REDACTED\n- \"Get me some WETH\" \u2192 tokenOut is WETH\n- \"Swap to REDACTED\" \u2192 tokenOut is REDACTED\n- Always infer the most logical interpretation. Ask only if truly ambiguous.\n- If user has a balance and wants to swap, infer they want to swap FROM their largest balance.\n\nCRITICAL - Output Format:\n- You MUST respond with a single JSON object with top-level keys: \"assistantMessage\" (string), \"actions\" (array), and optionally \"executionRequest\" (object).\n- No commentary or text outside the JSON object.\n- The \"assistantMessage\" must be short, clear, and never mention JSON or technical details.\n- The \"assistantMessage\" should follow the 4-step structure above (restate intent, summarize strategy, highlight risk, suggest next step).\n- The \"actions\" array MUST contain valid BlossomAction objects for simulation. For on-chain swaps, \"actions\" may be empty.\n- For on-chain swap requests, you MUST include an \"executionRequest\" field.\n\nCRITICAL - Execution Request Format (for on-chain swaps):\n- When user requests a swap (e.g., \"Swap X REDACTED to WETH\" or \"I only have ETH, swap to REDACTED\"), you MUST include \"executionRequest\":\n{\n  \"executionRequest\": {\n    \"kind\": \"swap\",\n    \"chain\": \"sepolia\",\n    \"tokenIn\": \"ETH\" | \"WETH\" | \"REDACTED\",\n    \"tokenOut\": \"WETH\" | \"REDACTED\",\n    \"amountIn\": \"0.01\",  // REQUIRED: decimal string (e.g., \"0.01\" for ETH, \"10\" for REDACTED)\n    \"slippageBps\": 50,   // basis points (50 = 0.5%)\n    \"fundingPolicy\": \"auto\"  // \"auto\" allows funding routes, \"require_tokenIn\" requires user to hold tokenIn\n  }\n}\n\nExamples:\n1. \"Swap 10 REDACTED to WETH\" \u2192 \n{\n  \"executionRequest\": {\n    \"kind\": \"swap\",\n    \"chain\": \"sepolia\",\n    \"tokenIn\": \"REDACTED\",\n    \"tokenOut\": \"WETH\",\n    \"amountIn\": \"10\",\n    \"slippageBps\": 50,\n    \"fundingPolicy\": \"require_tokenIn\"\n  }\n}\n\n2. \"I only have ETH. Swap 0.01 ETH to WETH\" \u2192\n{\n  \"executionRequest\": {\n    \"kind\": \"swap\",\n    \"chain\": \"sepolia\",\n    \"tokenIn\": \"ETH\",\n    \"tokenOut\": \"WETH\",\n    \"amountIn\": \"0.01\",\n    \"slippageBps\": 50,\n    \"fundingPolicy\": \"auto\"\n  }\n}\n\n3. \"Swap enough ETH to get 10 REDACTED\" \u2192\n{\n  \"executionRequest\": {\n    \"kind\": \"swap\",\n    \"chain\": \"sepolia\",\n    \"tokenIn\": \"ETH\",\n    \"tokenOut\": \"REDACTED\",\n    \"amountIn\": \"0.01\",  // YOU must explicitly choose amountIn (cannot be \"enough\")\n    \"amountOut\": \"10\",   // optional target\n    \"slippageBps\": 50,\n    \"fundingPolicy\": \"auto\"\n  }\n}\n\nCRITICAL - amountIn requirement:\n- You MUST always provide a specific amountIn value (decimal string).\n- If user says \"enough\" or \"sufficient\", you must calculate and provide an explicit amount.\n- For ETH: use decimal format like \"0.01\", \"0.1\", \"1.0\"\n- For REDACTED: use decimal format like \"10\", \"100\", \"1000\"\n\nCRITICAL - Execution Request Format (for perp positions):\n- When user requests a perp position AND mentions leverage (e.g., \"long BTC with 20x leverage\", \"5x leverage on ETH\"), you MUST include \"executionRequest\" with the leverage field:\n{\n  \"executionRequest\": {\n    \"kind\": \"perp\",\n    \"market\": \"BTC-PERP\" | \"ETH-PERP\" | \"SOL-PERP\",\n    \"side\": \"long\" | \"short\",\n    \"leverage\": 20,  // REQUIRED if user mentions leverage (extract from \"20x\", \"5x leverage\", etc.)\n    \"riskPct\": 2.0,  // percentage of account to risk\n    \"entryPrice\": 95000,  // optional target entry\n    \"takeProfitPrice\": 105000,  // optional TP target\n    \"stopLossPrice\": 92000  // optional SL target\n  }\n}\n\nIMPORTANT: Extract leverage from user requests:\n- \"20x leverage\" \u2192 leverage: 20\n- \"5.5x\" \u2192 leverage: 5.5\n- \"use 3x\" \u2192 leverage: 3\n- If user doesn't mention leverage, do NOT include it (will default to 2x)\n\nProduct Pillars:\n- Perps execution & risk: Open and manage perpetual futures positions with automatic risk management.\n- DeFi yield deployment: Park idle REDACTED into yield-generating protocols (Kamino, RootsFi, Jet).\n- Event market bets: Take positions on prediction markets (Fed cuts, ETF approvals, elections). For \"bet/bet YES/bet NO on [event]\" requests, include executionRequest with kind: \"event\", marketId: \"[market id]\", outcome: \"YES\"/\"NO\", stakeUsd: [amount].\n\nCRITICAL - Prediction Market Queries:\n- When the user asks about \"Kalshi\", \"Polymarket\", \"prediction markets\", \"top markets\", \"trending markets\", or \"highest volume market\", you MUST focus ONLY on prediction markets.\n- Do NOT suggest perps, DeFi, or other trading strategies when answering prediction market questions.\n- Do NOT say \"I can help with perps trading strategies...\" when asked about prediction markets.\n- If prediction market data is provided in the user prompt (either live or fallback), you MUST:\n  * Reference the specific markets by their exact names\n  * Provide a numbered list (1, 2, 3, etc.) with market names, YES probabilities, and volumes\n  * NOT mention perps, futures, liquidation, stop losses, or any perp-specific terms\n- For discovery queries (listing markets), provide ONLY the numbered list in your assistantMessage. Do NOT include actions in JSON.\n- For execution queries (risking on a market), include an event action in the JSON with the exact market details provided.\n\nExample JSON output (perp with leverage):\n{\n  \"assistantMessage\": \"I'll open a long ETH perp position with 5x leverage and 3% account risk. This strategy targets $3,640 take profit and $3,395 stop loss, keeping your liquidation buffer comfortable. Risk is capped at 3% of account value. Would you like me to adjust the risk level or entry price?\",\n  \"actions\": [\n    {\n      \"type\": \"perp\",\n      \"action\": \"open\",\n      \"market\": \"ETH-PERP\",\n      \"side\": \"long\",\n      \"riskPct\": 3.0,\n      \"entry\": 3500,\n      \"takeProfit\": 3640,\n      \"stopLoss\": 3395,\n      \"reasoning\": [\"ETH is trending up\", \"Risk is within 3% cap\", \"Stop loss protects downside\"]\n    }\n  ],\n  \"executionRequest\": {\n    \"kind\": \"perp\",\n    \"market\": \"ETH-PERP\",\n    \"side\": \"long\",\n    \"leverage\": 5,\n    \"riskPct\": 3.0,\n    \"entryPrice\": 3500,\n    \"takeProfitPrice\": 3640,\n    \"stopLossPrice\": 3395\n  }\n}\n\nCRITICAL - Execution Request Format (for DeFi lending/yield):\n- When user requests to allocate/deposit funds to a protocol (e.g., \"Allocate amountUsd:500 to protocol:Aave V3\", \"Allocate 10% to Lido\"), you MUST include \"executionRequest\":\n{\n  \"executionRequest\": {\n    \"kind\": \"lend\",\n    \"chain\": \"sepolia\",\n    \"asset\": \"REDACTED\",\n    \"amount\": \"500\",  // REQUIRED: decimal string (USD amount)\n    \"protocol\": \"demo\",  // Use \"demo\" for testnet\n    \"vault\": \"Aave V3\"  // Protocol name from user request\n  }\n}\n\nIMPORTANT - Parsing DeFi allocation requests:\n- \"Allocate amountUsd:\"500\" to protocol:\"Aave V3\" REDACTED yield\" \u2192 amount: \"500\", vault: \"Aave V3\"\n- \"Allocate amountPct:\"10\" to protocol:\"Lido\" REDACTED yield\" \u2192 calculate amount from account value (10% of portfolio), vault: \"Lido\"\n- Extract protocol name from protocol:\"[name]\" (with or without quotes)\n- Extract amount from amountUsd:\"[value]\" or amountPct:\"[value]\" (with or without quotes)\n- \"Deposit $1000 into Compound\" \u2192 amount: \"1000\", vault: \"Compound\"\n- \"Park 500 REDACTED in highest APY vault\" \u2192 amount: \"500\", vault: use highest APY from TOP YIELD VAULTS\n\nExample JSON output (DeFi yield allocation):\n{\n  \"assistantMessage\": \"I'll allocate $500 to Aave V3's REDACTED lending pool, earning 6.4% APY. This uses idle REDACTED capital efficiently while keeping funds accessible. The allocation is within the 25% single-protocol cap. Confirm to execute?\",\n  \"actions\": [\n    {\n      \"type\": \"defi\",\n      \"action\": \"deposit\",\n      \"protocol\": \"Aave V3\",\n      \"asset\": \"REDACTED\",\n      \"amountUsd\": 500,\n      \"apr\": 6.4,\n      \"reasoning\": [\"Highest APY vault available\", \"Within 25% protocol cap\", \"REDACTED remains accessible\"]\n    }\n  ],\n  \"executionRequest\": {\n    \"kind\": \"lend\",\n    \"chain\": \"sepolia\",\n    \"asset\": \"REDACTED\",\n    \"amount\": \"500\",\n    \"protocol\": \"demo\",\n    \"vault\": \"Aave V3\"\n  }\n}\n\nCRITICAL - Execution Request Format (for event markets):\n- When user requests to bet on an event (e.g., \"Bet YES on Fed rate cut\", \"Risk $50 on election\"), you MUST include \"executionRequest\":\n{\n  \"executionRequest\": {\n    \"kind\": \"event\",\n    \"chain\": \"sepolia\",\n    \"marketId\": \"fed-rate-cut-march-2025\",  // Extract from EVENT MARKETS data\n    \"outcome\": \"YES\" | \"NO\",\n    \"stakeUsd\": 50,  // USD amount to stake\n    \"price\": 0.65  // Optional: YES/NO price from EVENT MARKETS data\n  }\n}\n\nExample JSON output (event market bet):\n{\n  \"assistantMessage\": \"I'll place a YES bet on 'Fed cuts rates in March 2025' with $50 stake at 65% implied probability. Max payout: $76.92. Max loss: $50. This is 2% of your account value. Confirm to execute?\",\n  \"actions\": [\n    {\n      \"type\": \"event\",\n      \"action\": \"open\",\n      \"eventKey\": \"fed-rate-cut-march-2025\",\n      \"label\": \"Fed cuts rates in March 2025\",\n      \"side\": \"YES\",\n      \"stakeUsd\": 50,\n      \"maxPayoutUsd\": 76.92,\n      \"maxLossUsd\": 50,\n      \"reasoning\": [\"Strong economic indicators\", \"Within 2% risk cap\", \"65% implied probability\"]\n    }\n  ],\n  \"executionRequest\": {\n    \"kind\": \"event\",\n    \"chain\": \"sepolia\",\n    \"marketId\": \"fed-rate-cut-march-2025\",\n    \"outcome\": \"YES\",\n    \"stakeUsd\": 50,\n    \"price\": 0.65\n  }\n}`;\n\n  // Detect DeFi/yield intent\n  const lowerMessage = userMessage.toLowerCase();\n  const isDefiIntent = (/park|deposit|earn yield|lend|supply|yield|allocate/i.test(userMessage) &&\n    (lowerMessage.includes('usdc') || lowerMessage.includes('stablecoin') || lowerMessage.includes('yield') || lowerMessage.includes('protocol')));\n\n  // Fetch DefiLlama vaults if DeFi intent detected\n  let topVaults: Array<{ name: string; apy: number; tvl: number; poolId: string; protocol: string }> = [];\n  if (isDefiIntent) {\n    try {\n      const { getTopYieldVaults } = await import('../quotes/defiLlamaQuote');\n      topVaults = await getTopYieldVaults();\n    } catch (error: any) {\n      console.warn('[buildBlossomPrompts] Failed to fetch DefiLlama vaults:', error.message);\n      // Use fallback vaults (already in defiLlamaQuote.ts)\n    }\n  }\n\n  let userPrompt = `**User Request:**\\n${userMessage}\\n\\n`;\n\n  // Inject DefiLlama vault data if DeFi intent\n  if (isDefiIntent && topVaults.length > 0) {\n    userPrompt += `**TOP YIELD VAULTS (from DefiLlama):**\\n`;\n    topVaults.forEach((vault, idx) => {\n      userPrompt += `${idx + 1}. ${vault.name} - ${vault.apy.toFixed(2)}% APY, TVL: $${(vault.tvl / 1000).toFixed(0)}k\\n`;\n    });\n    userPrompt += `\\n**Recommendation:** For \"park/deposit/earn yield\" requests, recommend the highest APY vault (${topVaults[0]?.name || 'Aave REDACTED'}) and build a PULL \u2192 LEND_SUPPLY execution plan.\\n\\n`;\n  }\n\n  // Detect event intent\n  const isEventIntent = /bet|wager|risk.*on|event|prediction/i.test(userMessage) && \n    (lowerMessage.includes('yes') || lowerMessage.includes('no') || lowerMessage.includes('fed') || lowerMessage.includes('rate cut'));\n\n  // Fetch event markets if event intent detected\n  let eventMarkets: Array<{ id: string; title: string; yesPrice: number; noPrice: number }> = [];\n  if (isEventIntent) {\n    try {\n      const { getEventMarkets } = await import('../quotes/eventMarkets');\n      const markets = await getEventMarkets(5);\n      eventMarkets = markets.map(m => ({ id: m.id, title: m.title, yesPrice: m.yesPrice, noPrice: m.noPrice }));\n    } catch (error: any) {\n      console.warn('[buildBlossomPrompts] Failed to fetch event markets:', error.message);\n    }\n  }\n\n  // Inject event market data if event intent\n  if (isEventIntent && eventMarkets.length > 0) {\n    userPrompt += `**EVENT MARKETS (from dFlow/Polymarket):**\\n`;\n    eventMarkets.forEach((market, idx) => {\n      userPrompt += `${idx + 1}. \"${market.title}\" - YES: ${(market.yesPrice * 100).toFixed(0)}%, NO: ${(market.noPrice * 100).toFixed(0)}%\\n`;\n    });\n    userPrompt += `\\n**Recommendation:** For \"bet/bet YES/bet NO on [event]\" requests, match keyword to market and build a PROOF execution plan with venueType=2.\\n\\n`;\n  }\n\n  if (portfolio) {\n    const accountValue = portfolio.accountValueUsd.toLocaleString();\n    const usdc = portfolio.balances.find(b => b.symbol === 'REDACTED')?.balanceUsd || 0;\n    const openPerps = portfolio.strategies.filter(s => s.type === 'perp' && s.status !== 'closed').length;\n    const openEvents = portfolio.strategies.filter(s => s.type === 'event' && s.status !== 'closed').length;\n    const activeDefi = portfolio.defiPositions.filter(p => !p.isClosed).length;\n\n    userPrompt += `**Current Portfolio State:**\\n`;\n    userPrompt += `- Account Value: $${accountValue}\\n`;\n    userPrompt += `- REDACTED Balance: $${usdc.toLocaleString()}\\n`;\n    userPrompt += `- Open Perp Positions: ${openPerps}\\n`;\n    userPrompt += `- Open Event Positions: ${openEvents}\\n`;\n    userPrompt += `- Active DeFi Positions: ${activeDefi}\\n`;\n    userPrompt += `- Open Perp Exposure: $${portfolio.openPerpExposureUsd.toLocaleString()}\\n`;\n    userPrompt += `- Event Exposure: $${portfolio.eventExposureUsd.toLocaleString()}\\n\\n`;\n  }\n\n  // Calculate isPredictionMarketQuery flag early (for stub mode short-circuit)\n  // More robust detection: if venue is event_demo and message mentions prediction markets, Kalshi, or Polymarket\n  let isPredictionMarketQuery = false;\n  if (venue === 'event_demo') {\n    const lowerMessage = userMessage.toLowerCase();\n    const hasKalshi = lowerMessage.includes('kalshi');\n    const hasPolymarket = lowerMessage.includes('polymarket');\n    const hasPredictionMarket = lowerMessage.includes('prediction market') || lowerMessage.includes('prediction markets');\n    const hasTop = lowerMessage.includes('top');\n    const hasTrending = lowerMessage.includes('trending');\n    const hasHighestVolume = lowerMessage.includes('highest') && (lowerMessage.includes('volume') || lowerMessage.includes('vol'));\n    const hasRightNow = lowerMessage.includes('right now');\n    const hasRisk = lowerMessage.includes('risk') && (lowerMessage.includes('%') || lowerMessage.match(/\\d+%/));\n    \n    // More permissive: if it mentions Kalshi/Polymarket + any of: top, trending, prediction market, right now, highest volume\n    const isAskingTopKalshi = hasKalshi && (hasTop || hasPredictionMarket || hasRightNow || hasTrending);\n    const isAskingTopPolymarket = hasPolymarket && (hasTop || hasPredictionMarket || hasRightNow || hasTrending);\n    const isAskingHighestVolume = hasHighestVolume && (hasKalshi || hasPolymarket || hasPredictionMarket);\n    // Risk sizing on prediction markets (e.g. \"Risk 2% on highest-volume prediction market\")\n    const isRiskingOnPredictionMarket = hasRisk && (hasHighestVolume || hasPredictionMarket || hasKalshi || hasPolymarket);\n    \n    // Also match if just mentions Kalshi/Polymarket with \"top\" or \"trending\" (even without \"prediction market\")\n    const isAskingAboutKalshi = hasKalshi && (hasTop || hasTrending || hasRightNow);\n    const isAskingAboutPolymarket = hasPolymarket && (hasTop || hasTrending || hasRightNow);\n    \n    isPredictionMarketQuery = !!(isAskingTopKalshi || isAskingTopPolymarket || isAskingHighestVolume || \n      (hasKalshi && hasPredictionMarket) || (hasPolymarket && hasPredictionMarket) ||\n      isAskingAboutKalshi || isAskingAboutPolymarket || isRiskingOnPredictionMarket);\n    \n    // Log detection for debugging\n    console.log('[prediction-detection]', {\n      venue,\n      lowerMessage: lowerMessage.substring(0, 100),\n      hasKalshi,\n      hasPolymarket,\n      hasPredictionMarket,\n      hasTop,\n      hasTrending,\n      hasHighestVolume,\n      hasRightNow,\n      isAskingTopKalshi,\n      isAskingTopPolymarket,\n      isAskingHighestVolume,\n      isAskingAboutKalshi,\n      isAskingAboutPolymarket,\n      isPredictionMarketQuery\n    });\n  }\n\n  if (venue === 'hyperliquid') {\n    userPrompt += `**Venue Context:** On-chain perps venue. Prefer perps or DeFi actions.\\n\\n`;\n  } else if (venue === 'event_demo') {\n    userPrompt += `**Venue Context:** Event Markets (Demo). Prefer event market actions.\\n\\n`;\n    \n    // Reuse detection variables (already calculated above)\n    const lowerMessage = userMessage.toLowerCase();\n    const hasKalshi = lowerMessage.includes('kalshi');\n    const hasPolymarket = lowerMessage.includes('polymarket');\n    const hasPredictionMarket = lowerMessage.includes('prediction market') || lowerMessage.includes('prediction markets');\n    const hasTop = lowerMessage.includes('top') || lowerMessage.includes('trending');\n    const hasHighestVolume = lowerMessage.includes('highest') && (lowerMessage.includes('volume') || lowerMessage.includes('vol'));\n    \n    const isAskingTopKalshi = hasKalshi && (hasTop || hasPredictionMarket || lowerMessage.includes('right now'));\n    const isAskingTopPolymarket = hasPolymarket && (hasTop || hasPredictionMarket || lowerMessage.includes('right now'));\n    const isAskingHighestVolume = hasHighestVolume && (hasKalshi || hasPolymarket || hasPredictionMarket);\n    \n    console.log('[prediction] Detection:', { \n      lowerMessage: lowerMessage.substring(0, 150),\n      hasKalshi,\n      hasPolymarket,\n      hasPredictionMarket,\n      hasTop,\n      isAskingTopKalshi, \n      isAskingTopPolymarket, \n      isAskingHighestVolume,\n      isPredictionMarketQuery,\n      venue \n    });\n    \n    // Fetch live market data if relevant\n    let kalshiMarkets: RawPredictionMarket[] = [];\n    let polymarketMarkets: RawPredictionMarket[] = [];\n    let highestVolumeMarket: RawPredictionMarket | null = null;\n    \n    try {\n      if (isAskingTopKalshi || isAskingHighestVolume || (isPredictionMarketQuery && hasKalshi)) {\n        console.log('[prediction] Fetching Kalshi markets for prompt');\n        kalshiMarkets = await getTopKalshiMarketsByVolume(5);\n        console.log(`[prediction] Fetched ${kalshiMarkets.length} Kalshi markets:`, kalshiMarkets.map(m => m.title).join(', '));\n      }\n      if (isAskingTopPolymarket || isAskingHighestVolume || (isPredictionMarketQuery && hasPolymarket)) {\n        console.log('[prediction] Fetching Polymarket markets for prompt');\n        polymarketMarkets = await getTopPolymarketMarketsByVolume(5);\n        console.log(`[prediction] Fetched ${polymarketMarkets.length} Polymarket markets:`, polymarketMarkets.map(m => m.title).join(', '));\n      }\n      if (isAskingHighestVolume) {\n        console.log('[prediction] Fetching highest volume market');\n        highestVolumeMarket = await getHighestVolumeMarket();\n        console.log(`[prediction] Highest volume market:`, highestVolumeMarket ? highestVolumeMarket.title : 'none');\n      }\n    } catch (error: any) {\n      console.warn('[prediction] Failed to fetch market data for prompt:', error.message);\n      // Continue with empty arrays - will use fallback behavior\n    }\n    \n    // Build market context for LLM - always include if this is a prediction market query\n    // Always trigger for prediction market queries, even if data arrays are empty (will use fallback)\n    if (isPredictionMarketQuery) {\n      // Always include market data section, even if arrays are empty (will show fallback)\n      userPrompt += `**PREDICTION MARKET DATA:**\\n\\n`;\n      \n      if (kalshiMarkets.length > 0) {\n        userPrompt += `**Top Kalshi Markets (by volume):**\\n`;\n        kalshiMarkets.forEach((market, idx) => {\n          const prob = Math.round(market.yesPrice * 100);\n          const volume = market.volume24hUsd ? `$${(market.volume24hUsd / 1000).toFixed(0)}k` : 'N/A';\n          userPrompt += `${idx + 1}. \"${market.title}\" - ${prob}% YES probability, ${volume} 24h volume\\n`;\n        });\n        userPrompt += `\\n`;\n      } else if (isAskingTopKalshi || (isPredictionMarketQuery && hasKalshi)) {\n        // Fallback static data for Kalshi\n        userPrompt += `**Top Kalshi Markets (by volume):**\\n`;\n        userPrompt += `1. \"Fed cuts in March 2025\" - 62% YES probability, $125k 24h volume\\n`;\n        userPrompt += `2. \"BTC ETF approved by Dec 31\" - 68% YES probability, $280k 24h volume\\n`;\n        userPrompt += `3. \"ETH ETF approved by June 2025\" - 58% YES probability, $95k 24h volume\\n\\n`;\n      }\n      \n      if (polymarketMarkets.length > 0) {\n        userPrompt += `**Top Polymarket Markets (by volume):**\\n`;\n        polymarketMarkets.forEach((market, idx) => {\n          const prob = Math.round(market.yesPrice * 100);\n          const volume = market.volume24hUsd ? `$${(market.volume24hUsd / 1000).toFixed(0)}k` : 'N/A';\n          userPrompt += `${idx + 1}. \"${market.title}\" - ${prob}% YES probability, ${volume} 24h volume\\n`;\n        });\n        userPrompt += `\\n`;\n      } else if (isAskingTopPolymarket || (isPredictionMarketQuery && hasPolymarket)) {\n        // Fallback static data for Polymarket\n        userPrompt += `**Top Polymarket Markets (by volume):**\\n`;\n        userPrompt += `1. \"US Election Winner 2024\" - 50% YES probability, $450k 24h volume\\n`;\n        userPrompt += `2. \"Crypto market cap above $3T by year-end\" - 52% YES probability, $180k 24h volume\\n`;\n        userPrompt += `3. \"ETH above $5k by year-end\" - 45% YES probability, $120k 24h volume\\n\\n`;\n      }\n      \n      if (highestVolumeMarket) {\n        const prob = Math.round(highestVolumeMarket.yesPrice * 100);\n        const volume = highestVolumeMarket.volume24hUsd ? `$${(highestVolumeMarket.volume24hUsd / 1000).toFixed(0)}k` : 'N/A';\n        userPrompt += `**Highest Volume Market:** \"${highestVolumeMarket.title}\" (${highestVolumeMarket.source}) - ${prob}% YES probability, ${volume} 24h volume\\n\\n`;\n      }\n      \n      userPrompt += `**CRITICAL - PREDICTION MARKET MODE ACTIVATED:**\\n\\n`;\n      userPrompt += `The user is asking about prediction markets (Kalshi/Polymarket). You MUST respond ONLY about prediction markets.\\n\\n`;\n      userPrompt += `**MANDATORY Response Format:**\\n`;\n      userPrompt += `1. Start your response by acknowledging the prediction market query.\\n`;\n      userPrompt += `2. Provide a numbered list (1, 2, 3, etc.) of the markets from the data above.\\n`;\n      userPrompt += `3. For each market, include:\\n`;\n      userPrompt += `   - The exact market title/name\\n`;\n      userPrompt += `   - The YES probability percentage\\n`;\n      userPrompt += `   - The 24h volume (if available)\\n`;\n      userPrompt += `4. Do NOT mention perps, futures, DeFi, or any other trading strategies.\\n`;\n      userPrompt += `5. Do NOT ask the user to rephrase or suggest other trading options.\\n`;\n      userPrompt += `6. If the user asks to \"risk X%\" on a market, include an event action in the JSON.\\n`;\n      userPrompt += `7. If the user asks to \"override the risk cap\", \"ignore the 3% cap\", \"allocate the full amount\", \"increase stake to X\", or similar phrases for an existing event position, include an event action with action: \"update\", positionId (the existing position ID), and overrideRiskCap: true.\\n`;\n      userPrompt += `7. If the user only asks to list markets (discovery), do NOT include any actions in the JSON.\\n\\n`;\n      userPrompt += `**Example Response Format:**\\n`;\n      userPrompt += `\"Here are the top 5 prediction markets on Kalshi:\\n\\n`;\n      userPrompt += `1. [Market Name] - [X]% YES probability, $[Y]k 24h volume\\n`;\n      userPrompt += `2. [Market Name] - [X]% YES probability, $[Y]k 24h volume\\n`;\n      userPrompt += `...\\n\\n`;\n      userPrompt += `These markets are ranked by volume and represent the most active prediction markets currently available.\"\\n\\n`;\n      userPrompt += `**ABSOLUTELY FORBIDDEN:**\\n`;\n      userPrompt += `- Do NOT say \"I can help with perps trading strategies...\"\\n`;\n      userPrompt += `- Do NOT mention liquidation, stop losses, or perp-specific terms\\n`;\n      userPrompt += `- Do NOT suggest the user try perps or DeFi instead\\n`;\n      userPrompt += `- Do NOT give generic trading advice\\n\\n`;\n    } else {\n      // Not a prediction market query - generic instruction\n      userPrompt += `**Discovery Prompts:** When the user asks for \"top markets on Kalshi\" or \"top markets on Polymarket\", return a natural-language explanation listing 4-6 markets. Only include event actions in the JSON if the user explicitly asks to \"risk X% on the highest-volume market\". Otherwise, only describe markets in text.\\n\\n`;\n    }\n  }\n\n  userPrompt += `**Remember:** This is a SIMULATED environment. No real orders are placed.`;\n\n  return { systemPrompt, userPrompt, isPredictionMarketQuery };\n}\n\n/**\n * Validate execution request from LLM\n */\nexport function validateExecutionRequest(raw: any): BlossomExecutionRequest | null {\n  if (!raw || typeof raw !== 'object') {\n    return null;\n  }\n\n  if (raw.kind === 'lend' || raw.kind === 'lend_supply') {\n    // Validate chain\n    if (raw.chain !== 'sepolia') {\n      console.warn('Invalid chain for lending:', raw.chain);\n      return null;\n    }\n\n    // Validate asset (must be REDACTED for now)\n    if (raw.asset !== 'REDACTED') {\n      console.warn('Invalid asset for lending:', raw.asset);\n      return null;\n    }\n\n    // Validate amount (required, must be decimal string)\n    if (!raw.amount || typeof raw.amount !== 'string') {\n      console.warn('Missing or invalid amount for lending');\n      return null;\n    }\n\n    // Validate amount is a valid decimal number\n    const amountNum = parseFloat(raw.amount);\n    if (isNaN(amountNum) || amountNum <= 0) {\n      console.warn('Invalid amount value for lending:', raw.amount);\n      return null;\n    }\n\n    return {\n      kind: raw.kind === 'lend_supply' ? 'lend_supply' : 'lend',\n      chain: 'sepolia',\n      asset: 'REDACTED',\n      amount: raw.amount,\n      protocol: raw.protocol || 'demo',\n      vault: raw.vault,\n    };\n  }\n\n  if (raw.kind === 'swap') {\n    // Validate chain\n    if (raw.chain !== 'sepolia') {\n      console.warn('Invalid chain:', raw.chain);\n      return null;\n    }\n\n    // Validate token enums\n    const validTokenIn = ['ETH', 'WETH', 'REDACTED'];\n    const validTokenOut = ['WETH', 'REDACTED'];\n    if (!validTokenIn.includes(raw.tokenIn) || !validTokenOut.includes(raw.tokenOut)) {\n      console.warn('Invalid tokenIn or tokenOut:', raw.tokenIn, raw.tokenOut);\n      return null;\n    }\n\n    // Validate amountIn (required, must be decimal string)\n    if (!raw.amountIn || typeof raw.amountIn !== 'string') {\n      console.warn('Missing or invalid amountIn');\n      return null;\n    }\n\n    // Validate amountIn is a valid decimal number\n    const amountInNum = parseFloat(raw.amountIn);\n    if (isNaN(amountInNum) || amountInNum <= 0) {\n      console.warn('Invalid amountIn value:', raw.amountIn);\n      return null;\n    }\n\n    // Validate slippageBps\n    const slippageBps = typeof raw.slippageBps === 'number' ? raw.slippageBps : 50;\n    if (slippageBps < 0 || slippageBps > 1000) {\n      console.warn('Invalid slippageBps:', slippageBps);\n      return null;\n    }\n\n    // Validate fundingPolicy\n    const fundingPolicy = raw.fundingPolicy === 'require_tokenIn' ? 'require_tokenIn' : 'auto';\n\n    return {\n      kind: 'swap',\n      chain: 'sepolia',\n      tokenIn: raw.tokenIn,\n      tokenOut: raw.tokenOut,\n      amountIn: raw.amountIn,\n      amountOut: raw.amountOut || undefined,\n      slippageBps,\n      fundingPolicy,\n    };\n  }\n\n  // Future: validate other kinds (perp, etc.)\n  return null;\n}\n\n/**\n * Build deterministic response for prediction market queries in stub mode\n */\nexport async function buildPredictionMarketResponse(\n  userMessage: string,\n  venue: 'hyperliquid' | 'event_demo',\n  accountValueUsd?: number\n): Promise<{ assistantMessage: string; actions: BlossomAction[] }> {\n  const lowerMessage = userMessage.toLowerCase();\n  const hasKalshi = lowerMessage.includes('kalshi');\n  const hasPolymarket = lowerMessage.includes('polymarket');\n  const hasHighestVolume = lowerMessage.includes('highest') && (lowerMessage.includes('volume') || lowerMessage.includes('vol'));\n  \n  let markets: RawPredictionMarket[] = [];\n  let platformName = '';\n  \n  if (hasKalshi || (hasHighestVolume && !hasPolymarket)) {\n    console.log('[prediction-stub] Fetching Kalshi markets for stub response');\n    markets = await getTopKalshiMarketsByVolume(5);\n    platformName = 'Kalshi';\n  } else if (hasPolymarket || hasHighestVolume) {\n    console.log('[prediction-stub] Fetching Polymarket markets for stub response');\n    markets = await getTopPolymarketMarketsByVolume(5);\n    platformName = 'Polymarket';\n  } else {\n    // Default to Kalshi if unclear\n    markets = await getTopKalshiMarketsByVolume(5);\n    platformName = 'Kalshi';\n  }\n  \n  // Build numbered list response with clear formatting\n  let responseText = `Here are the top ${markets.length} ${platformName} prediction markets by 24h volume (stub data):\\n\\n`;\n  \n  markets.forEach((market, idx) => {\n    const yesProb = Math.round(market.yesPrice * 100);\n    const noProb = Math.round(market.noPrice * 100);\n    const volume = market.volume24hUsd \n      ? `$${(market.volume24hUsd / 1000).toFixed(0)}k` \n      : market.openInterestUsd \n        ? `$${(market.openInterestUsd / 1000).toFixed(0)}k OI`\n        : 'Volume N/A';\n    \n    responseText += `${idx + 1}) ${market.title} \u2014 Yes: ${yesProb}%, No: ${noProb}%, 24h Volume: ${volume}\\n\\n`;\n  });\n  \n  responseText += `These markets are ranked by volume and represent the most active prediction markets currently available on ${platformName}.`;\n  \n  // Check if user wants to risk on a market\n  const wantsToRisk = lowerMessage.includes('risk') && (lowerMessage.includes('%') || lowerMessage.match(/\\d+%/));\n  const wantsHighestVolume = lowerMessage.includes('highest') && (lowerMessage.includes('volume') || lowerMessage.includes('vol'));\n  let actions: BlossomAction[] = [];\n  \n  if (wantsToRisk && (markets.length > 0 || wantsHighestVolume)) {\n    // Extract risk percentage\n    const riskMatch = userMessage.match(/(\\d+(?:\\.\\d+)?)%/);\n    const riskPct = riskMatch ? parseFloat(riskMatch[1]) : 2;\n    \n    // Use highest volume market if requested, otherwise use first market\n    let targetMarket: RawPredictionMarket;\n    if (wantsHighestVolume) {\n      try {\n        const highestVolumeMarket = await getHighestVolumeMarket();\n        if (highestVolumeMarket) {\n          targetMarket = highestVolumeMarket;\n        } else {\n          targetMarket = markets[0];\n        }\n      } catch (error) {\n        console.warn('[prediction-stub] Failed to get highest volume market, using first market:', error);\n        targetMarket = markets[0];\n      }\n    } else {\n      targetMarket = markets[0];\n    }\n    \n    if (!targetMarket) {\n      console.warn('[prediction-stub] No market available for risk sizing');\n    } else {\n      const side: 'YES' | 'NO' = targetMarket.yesPrice >= 0.5 ? 'YES' : 'NO';\n      \n      // Calculate stake from account value or use default\n      const defaultAccountValue = 10000; // Default for stub mode\n      const accountValue = accountValueUsd || defaultAccountValue;\n      const stakeUsd = Math.round((accountValue * riskPct) / 100); // Exact risk percentage\n      \n      // Apply 3% cap\n      const maxEventRiskPct = 0.03;\n      const maxStakeUsd = Math.round(accountValue * maxEventRiskPct);\n      const finalStakeUsd = Math.min(stakeUsd, maxStakeUsd);\n      \n      const maxPayoutUsd = side === 'YES' \n        ? finalStakeUsd / targetMarket.yesPrice \n        : finalStakeUsd / targetMarket.noPrice;\n      \n      actions.push({\n        type: 'event',\n        action: 'open',\n        eventKey: targetMarket.id,\n        label: targetMarket.title,\n        side,\n        stakeUsd: finalStakeUsd,\n        maxPayoutUsd,\n        maxLossUsd: finalStakeUsd,\n        reasoning: [\n          wantsHighestVolume ? `Using highest volume market from ${platformName}` : `Using top market from ${platformName}`,\n          `Risk is ${riskPct}% of account (${finalStakeUsd < stakeUsd ? 'capped at 3%' : 'uncapped'})`,\n          `Market probability is ${Math.round(targetMarket.yesPrice * 100)}% YES`\n        ]\n      });\n      \n      if (finalStakeUsd < stakeUsd) {\n        responseText += `\\n\\nI'll stake ${riskPct}% of your account ($${stakeUsd.toLocaleString()}) on \"${targetMarket.title}\", side ${side}. However, I've capped this at $${finalStakeUsd.toLocaleString()} to keep risk at 3% of your $${accountValue.toLocaleString()} account. Your max loss is capped at the amount staked.`;\n      } else {\n        responseText = `I'll stake ${riskPct}% of your account ($${finalStakeUsd.toLocaleString()}) on \"${targetMarket.title}\", side ${side}. Your max loss is capped at the amount staked.`;\n      }\n    }\n  }\n  \n  return {\n    assistantMessage: responseText,\n    actions\n  };\n}\n\n", "/**\n * Price Service\n * Fetches real market prices with safe fallbacks\n */\n\nexport type PriceSymbol = 'ETH' | 'BTC' | 'SOL' | 'REDACTED' | 'AVAX' | 'LINK';\n\nexport interface PriceSnapshot {\n  symbol: PriceSymbol;\n  priceUsd: number;\n  source: 'coingecko' | 'static';\n  fetchedAt: number;\n}\n\n// In-memory cache\nconst priceCache = new Map<PriceSymbol, PriceSnapshot>();\n\n// Static fallback prices\nconst STATIC_PRICES: Record<PriceSymbol, number> = {\n  ETH: 3000,\n  BTC: 60000,\n  SOL: 150,\n  REDACTED: 1,\n  AVAX: 35,\n  LINK: 14,\n};\n\n// Cache TTL: 12 seconds\nconst CACHE_TTL_MS = 12 * 1000;\n\n/**\n * Get price for a symbol, with caching and fallback\n */\nexport async function getPrice(symbol: PriceSymbol): Promise<PriceSnapshot> {\n  // Check cache first\n  const cached = priceCache.get(symbol);\n  if (cached && Date.now() - cached.fetchedAt < CACHE_TTL_MS) {\n    return cached;\n  }\n\n  // Try to fetch from CoinGecko\n  try {\n    const price = await fetchFromCoinGecko(symbol);\n    const snapshot: PriceSnapshot = {\n      symbol,\n      priceUsd: price,\n      source: 'coingecko',\n      fetchedAt: Date.now(),\n    };\n    priceCache.set(symbol, snapshot);\n    return snapshot;\n  } catch (error) {\n    console.warn(`Failed to fetch ${symbol} price from CoinGecko, using static fallback:`, error);\n  }\n\n  // Fallback to static price\n  const snapshot: PriceSnapshot = {\n    symbol,\n    priceUsd: STATIC_PRICES[symbol],\n    source: 'static',\n    fetchedAt: Date.now(),\n  };\n  priceCache.set(symbol, snapshot);\n  return snapshot;\n}\n\n/**\n * Fetch price from CoinGecko public API\n */\nasync function fetchFromCoinGecko(symbol: PriceSymbol): Promise<number> {\n  // CoinGecko API mapping\n  const coinGeckoIds: Record<PriceSymbol, string> = {\n    ETH: 'ethereum',\n    BTC: 'bitcoin',\n    SOL: 'solana',\n    REDACTED: 'usd-coin',\n    AVAX: 'avalanche-2',\n    LINK: 'chainlink',\n  };\n\n  const coinId = coinGeckoIds[symbol];\n  if (!coinId) {\n    throw new Error(`Unsupported symbol: ${symbol}`);\n  }\n\n  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`;\n  \n  const response = await fetch(url, {\n    headers: {\n      'Accept': 'application/json',\n    },\n  });\n\n  if (!response.ok) {\n    throw new Error(`CoinGecko API error: ${response.status}`);\n  }\n\n  const data = await response.json() as Record<string, { usd: number }>;\n  const price = data[coinId]?.usd;\n  \n  if (typeof price !== 'number' || price <= 0) {\n    throw new Error(`Invalid price data from CoinGecko: ${price}`);\n  }\n\n  return price;\n}\n\n/**\n * Clear price cache (useful for testing)\n */\nexport function clearPriceCache(): void {\n  priceCache.clear();\n}\n\n", "/**\n * 1inch Quote Provider (Read-Only)\n * Fetches routing intelligence from 1inch API for swap routing decisions.\n * This is read-only - execution still uses our deterministic DemoSwapRouter.\n */\n\nimport {\n  ONEINCH_API_KEY,\n  ONEINCH_BASE_URL,\n  ETH_TESTNET_CHAIN_ID,\n} from '../config';\n\nexport interface OneInchQuoteRequest {\n  chainId: number;\n  tokenIn: string;  // Token address\n  tokenOut: string; // Token address\n  amountIn: string; // Amount in wei (string)\n  slippageBps?: number; // Basis points, e.g., 50 = 0.5%\n}\n\nexport interface OneInchQuoteResult {\n  toTokenAmount: string; // Amount out in wei\n  estimatedGas: string;\n  protocols: string[]; // e.g., ['UNISWAP_V3', 'SUSHISWAP']\n  routeSummary: string; // Human-readable route description\n  aggregator: '1inch';\n  fromToken: {\n    symbol: string;\n    decimals: number;\n  };\n  toToken: {\n    symbol: string;\n    decimals: number;\n  };\n  warnings?: string[];\n}\n\n/**\n * Fetch a quote from 1inch API (read-only, no execution data)\n * @param request Quote request parameters\n * @returns Quote result or undefined if quote fails\n */\nexport async function getOneInchQuote(\n  request: OneInchQuoteRequest\n): Promise<OneInchQuoteResult | undefined> {\n  const { chainId, tokenIn, tokenOut, amountIn } = request;\n\n  // 1inch API v5.2 quote endpoint\n  // Note: For Sepolia testnet, 1inch may not have liquidity data.\n  // In production, this would use mainnet chainId (1).\n  // For demo purposes, we'll construct a simulated response when API is unavailable.\n  \n  const apiUrl = `${ONEINCH_BASE_URL}/swap/v5.2/${chainId}/quote`;\n  \n  const params = new URLSearchParams({\n    src: tokenIn,\n    dst: tokenOut,\n    amount: amountIn,\n  });\n\n  const headers: Record<string, string> = {\n    'Accept': 'application/json',\n  };\n\n  // Add API key if configured\n  if (ONEINCH_API_KEY) {\n    headers['Authorization'] = `Bearer ${ONEINCH_API_KEY}`;\n  }\n\n  try {\n    console.log('[1inch] Fetching quote:', { chainId, tokenIn, tokenOut, amountIn });\n    \n    const response = await fetch(`${apiUrl}?${params.toString()}`, {\n      method: 'GET',\n      headers,\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.warn('[1inch] Quote API error:', response.status, errorText);\n      \n      // Return undefined to trigger fallback\n      return undefined;\n    }\n\n    const data = await response.json();\n    \n    // Parse 1inch response\n    const protocols = extractProtocols(data.protocols);\n    const routeSummary = buildRouteSummary(data);\n\n    const result: OneInchQuoteResult = {\n      toTokenAmount: data.toAmount || data.toTokenAmount,\n      estimatedGas: data.gas?.toString() || data.estimatedGas?.toString() || '0',\n      protocols,\n      routeSummary,\n      aggregator: '1inch',\n      fromToken: {\n        symbol: data.fromToken?.symbol || 'UNKNOWN',\n        decimals: data.fromToken?.decimals || 18,\n      },\n      toToken: {\n        symbol: data.toToken?.symbol || 'UNKNOWN',\n        decimals: data.toToken?.decimals || 18,\n      },\n    };\n\n    console.log('[1inch] Quote received:', {\n      toTokenAmount: result.toTokenAmount,\n      protocols: result.protocols,\n      routeSummary: result.routeSummary,\n    });\n\n    return result;\n  } catch (error: any) {\n    console.warn('[1inch] Quote fetch failed:', error.message);\n    return undefined;\n  }\n}\n\n/**\n * Extract protocol names from 1inch protocols response\n */\nfunction extractProtocols(protocols: any): string[] {\n  if (!protocols || !Array.isArray(protocols)) {\n    return ['Unknown'];\n  }\n\n  // 1inch returns nested array structure for multi-hop routes\n  const protocolNames = new Set<string>();\n  \n  const extractFromArray = (arr: any[]): void => {\n    for (const item of arr) {\n      if (Array.isArray(item)) {\n        extractFromArray(item);\n      } else if (typeof item === 'object' && item.name) {\n        protocolNames.add(item.name);\n      } else if (typeof item === 'string') {\n        protocolNames.add(item);\n      }\n    }\n  };\n\n  extractFromArray(protocols);\n  return Array.from(protocolNames);\n}\n\n/**\n * Build a human-readable route summary\n */\nfunction buildRouteSummary(data: any): string {\n  const fromSymbol = data.fromToken?.symbol || 'Token';\n  const toSymbol = data.toToken?.symbol || 'Token';\n  const protocols = extractProtocols(data.protocols);\n  \n  if (protocols.length === 0 || protocols[0] === 'Unknown') {\n    return `${fromSymbol} \u2192 ${toSymbol}`;\n  }\n\n  if (protocols.length === 1) {\n    return `${fromSymbol} \u2192 ${toSymbol} via ${protocols[0]}`;\n  }\n\n  return `${fromSymbol} \u2192 ${toSymbol} via ${protocols.slice(0, 3).join(' + ')}${protocols.length > 3 ? ' +more' : ''}`;\n}\n\n/**\n * Check if 1inch routing is available\n */\nexport function isOneInchAvailable(): boolean {\n  // 1inch is available if we have an API key or can use unauthenticated access\n  // For Sepolia, 1inch may not have data, but we try anyway\n  return true; // Always attempt, gracefully fail\n}\n\n/**\n * Get supported chain ID for 1inch\n * Note: 1inch doesn't support Sepolia directly, but we can still call it\n * and fall back gracefully.\n */\nexport function getOneInchChainId(): number {\n  // For demo, we use Sepolia chain ID even though 1inch may not support it\n  // This allows the code path to work, and we fall back to deterministic quotes\n  return ETH_TESTNET_CHAIN_ID;\n}\n\n\n", "/**\n * Uniswap V3 Quoter\n * Fetches quotes from Uniswap V3 QuoterV2 contract on Sepolia\n */\n\nimport { ETH_TESTNET_RPC_URL, ETH_TESTNET_CHAIN_ID, UNISWAP_V3_ROUTER_ADDRESS } from '../config';\nimport { formatUnits, parseUnits } from 'viem';\n\n// Uniswap V3 QuoterV2 address on Sepolia\nconst UNISWAP_V3_QUOTER_V2_ADDRESS = '0x3d4e44Eb1374240CE5F1B871ab261CD16335B76a';\n\ninterface UniswapQuoteResult {\n  amountOut: string; // BigInt string (wei)\n  sqrtPriceX96After: string;\n  initializedTicksCrossed: string;\n  gasEstimate: string;\n}\n\n/**\n * Get quote from Uniswap V3 QuoterV2\n * @param tokenIn Token in address\n * @param tokenOut Token out address\n * @param amountIn Amount in (wei, as BigInt string)\n * @param fee Fee tier (500, 3000, 10000)\n * @returns Quote result or null if failed\n */\nexport async function getUniswapV3Quote(params: {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string; // BigInt string\n  fee?: number;\n}): Promise<UniswapQuoteResult | null> {\n  const { tokenIn, tokenOut, amountIn, fee = 3000 } = params;\n\n  if (!ETH_TESTNET_RPC_URL) {\n    console.warn('[getUniswapV3Quote] ETH_TESTNET_RPC_URL not configured');\n    return null;\n  }\n\n  try {\n    // Encode quoteExactInputSingle call\n    // function quoteExactInputSingle(\n    //   address tokenIn,\n    //   address tokenOut,\n    //   uint24 fee,\n    //   uint256 amountIn,\n    //   uint160 sqrtPriceLimitX96\n    // ) external returns (uint256 amountOut, uint160 sqrtPriceX96After, uint32 initializedTicksCrossed, uint256 gasEstimate);\n    \n    const { encodeFunctionData, decodeFunctionResult } = await import('viem');\n    \n    const quoterAbi = [\n      {\n        name: 'quoteExactInputSingle',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          { name: 'tokenIn', type: 'address' },\n          { name: 'tokenOut', type: 'address' },\n          { name: 'fee', type: 'uint24' },\n          { name: 'amountIn', type: 'uint256' },\n          { name: 'sqrtPriceLimitX96', type: 'uint160' },\n        ],\n        outputs: [\n          { name: 'amountOut', type: 'uint256' },\n          { name: 'sqrtPriceX96After', type: 'uint160' },\n          { name: 'initializedTicksCrossed', type: 'uint32' },\n          { name: 'gasEstimate', type: 'uint256' },\n        ],\n      },\n    ] as const;\n\n    const callData = encodeFunctionData({\n      abi: quoterAbi,\n      functionName: 'quoteExactInputSingle',\n      args: [\n        tokenIn as `0x${string}`,\n        tokenOut as `0x${string}`,\n        fee,\n        BigInt(amountIn),\n        0n, // sqrtPriceLimitX96 = 0 (no price limit)\n      ],\n    });\n\n    // Call quoter contract\n    const response = await fetch(ETH_TESTNET_RPC_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'eth_call',\n        params: [\n          {\n            to: UNISWAP_V3_QUOTER_V2_ADDRESS,\n            data: callData,\n          },\n          'latest',\n        ],\n      }),\n    });\n\n    const data = await response.json();\n    \n    if (data.error) {\n      console.warn('[getUniswapV3Quote] RPC error:', data.error);\n      return null;\n    }\n\n    if (!data.result || data.result === '0x') {\n      console.warn('[getUniswapV3Quote] No result from quoter');\n      return null;\n    }\n\n    // Decode result\n    const decoded = decodeFunctionResult({\n      abi: quoterAbi,\n      functionName: 'quoteExactInputSingle',\n      data: data.result as `0x${string}`,\n    });\n\n    return {\n      amountOut: decoded[0].toString(),\n      sqrtPriceX96After: decoded[1].toString(),\n      initializedTicksCrossed: decoded[2].toString(),\n      gasEstimate: decoded[3].toString(),\n    };\n  } catch (error: any) {\n    console.warn('[getUniswapV3Quote] Error:', error.message);\n    return null;\n  }\n}\n\n/**\n * Check if Uniswap quoter is available\n */\nexport function isUniswapQuoterAvailable(): boolean {\n  return !!ETH_TESTNET_RPC_URL && !!UNISWAP_V3_ROUTER_ADDRESS;\n}\n\n\n", "// @ts-nocheck\n/**\n * EVM Quote Provider\n * Provides quotes for demo swap router and other EVM-based venues\n * Supports hybrid routing: 1inch for route intelligence, demo router for execution\n */\n\nimport { \n  DEMO_SWAP_ROUTER_ADDRESS, \n  DEFAULT_SWAP_SLIPPAGE_BPS, \n  DEMO_REDACTED_ADDRESS, \n  DEMO_WETH_ADDRESS,\n  ROUTING_MODE,\n  ROUTING_REQUIRE_LIVE_QUOTE,\n  ETH_TESTNET_CHAIN_ID,\n  DFLOW_ENABLED,\n} from '../config';\nimport { getOneInchQuote, isOneInchAvailable, OneInchQuoteResult } from './oneInchQuote';\nimport { getSwapQuote as getDflowSwapQuote, isDflowCapabilityAvailable } from '../integrations/dflow/dflowClient';\nimport { getUniswapV3Quote, isUniswapQuoterAvailable } from './uniswapQuoter';\nimport { formatUnits } from 'viem';\nimport { getSwapQuoteRouted, RoutingMetadata } from '../routing/routingService';\n\nexport interface SwapQuote {\n  expectedOut: string; // BigInt string\n  minOut: string; // BigInt string\n  estSlippageBps: number;\n  feeTier: number;\n  venueLabel: string;\n  chainLabel: string;\n  settlementEstimate: string;\n}\n\n/**\n * Get quote from demo swap router\n * Demo router uses fixed 95% rate (5% fee)\n */\nexport async function getDemoSwapQuote(params: {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string; // BigInt string\n  fee?: number; // Ignored for demo, kept for interface compatibility\n  slippageBps?: number;\n}): Promise<SwapQuote> {\n  const { tokenIn, tokenOut, amountIn, slippageBps = DEFAULT_SWAP_SLIPPAGE_BPS } = params;\n\n  // Demo router uses fixed rate: 95% output (5% fee)\n  const RATE_NUMERATOR = 95n;\n  const RATE_DENOMINATOR = 100n;\n\n  // Parse amountIn\n  const amountInBigInt = BigInt(amountIn);\n\n  // Calculate expected output (95% of input)\n  // Handle decimal differences: DEMO_REDACTED has 6 decimals, DEMO_WETH has 18 decimals\n  let expectedOut: bigint;\n  \n  if (tokenIn.toLowerCase() === DEMO_REDACTED_ADDRESS?.toLowerCase() && \n      tokenOut.toLowerCase() === DEMO_WETH_ADDRESS?.toLowerCase()) {\n    // REDACTED (6 decimals) -> WETH (18 decimals)\n    // Apply rate first, then scale up by 10^12\n    expectedOut = (amountInBigInt * RATE_NUMERATOR / RATE_DENOMINATOR) * 10n**12n;\n  } else if (tokenIn.toLowerCase() === DEMO_WETH_ADDRESS?.toLowerCase() && \n             tokenOut.toLowerCase() === DEMO_REDACTED_ADDRESS?.toLowerCase()) {\n    // WETH (18 decimals) -> REDACTED (6 decimals)\n    // Apply rate first, then scale down by 10^12\n    expectedOut = (amountInBigInt * RATE_NUMERATOR / RATE_DENOMINATOR) / 10n**12n;\n  } else {\n    // Same decimals or unknown - just apply rate\n    expectedOut = amountInBigInt * RATE_NUMERATOR / RATE_DENOMINATOR;\n  }\n\n  // Calculate minimum output with slippage\n  const slippageMultiplier = BigInt(10000 - slippageBps);\n  const minOut = (expectedOut * slippageMultiplier) / 10000n;\n\n  return {\n    expectedOut: expectedOut.toString(),\n    minOut: minOut.toString(),\n    estSlippageBps: slippageBps,\n    feeTier: 3000, // 0.3% (standard Uniswap V3 fee tier, kept for compatibility)\n    venueLabel: 'Blossom Demo Router (Uniswap V3 compatible)',\n    chainLabel: 'Sepolia',\n    settlementEstimate: '~1 block',\n  };\n}\n\n/**\n * Get quote for a swap (supports demo router)\n */\nexport async function getSwapQuote(params: {\n  tokenIn: string;\n  tokenOut: string;\n  amountIn: string;\n  fee?: number;\n  slippageBps?: number;\n}): Promise<SwapQuote | null> {\n  // Check if this is a demo swap\n  const isDemoSwap = \n    (params.tokenIn.toLowerCase() === DEMO_REDACTED_ADDRESS?.toLowerCase() || \n     params.tokenIn.toLowerCase() === DEMO_WETH_ADDRESS?.toLowerCase()) &&\n    (params.tokenOut.toLowerCase() === DEMO_REDACTED_ADDRESS?.toLowerCase() || \n     params.tokenOut.toLowerCase() === DEMO_WETH_ADDRESS?.toLowerCase());\n\n  if (isDemoSwap && DEMO_SWAP_ROUTER_ADDRESS) {\n    return getDemoSwapQuote(params);\n  }\n\n  // Future: Add real Uniswap quote logic here\n  return null;\n}\n\n/**\n * Routing decision metadata (includes source of routing intelligence)\n */\nexport interface RoutingDecision {\n  // Quote data\n  expectedOut: string; // Human-readable (e.g., \"0.95\")\n  expectedOutRaw: string; // BigInt string (wei)\n  minOut: string; // Human-readable\n  minOutRaw: string; // BigInt string (wei)\n  slippageBps: number;\n  \n  // Routing intelligence source\n  routingSource: '1inch' | 'deterministic' | 'dflow' | 'uniswap';\n  routeSummary: string; // e.g., \"REDACTED \u2192 WETH via Uniswap V3\"\n  route?: string; // Raw route data if available\n  protocols?: string[]; // e.g., ['UNISWAP_V3']\n  estimatedGas?: string;\n  gas?: string; // Gas estimate\n  \n  // Execution venue (always demo for now)\n  executionVenue: string; // \"Blossom Demo Router\"\n  executionNote: string; // Explains the hybrid model\n  \n  // Chain info\n  chain: string;\n  chainId: number;\n  settlementEstimate: string;\n  \n  // Warnings if any\n  warnings?: string[];\n}\n\n/**\n * Get routing decision: tries 1inch first, falls back to deterministic\n * This is the hybrid model: real routing intelligence + deterministic execution\n */\nexport async function getSwapRoutingDecision(params: {\n  tokenIn: string;\n  tokenOut: string;\n  tokenInSymbol: string;\n  tokenOutSymbol: string;\n  tokenInDecimals: number;\n  tokenOutDecimals: number;\n  amountIn: string; // BigInt string (wei)\n  slippageBps?: number;\n}): Promise<RoutingDecision> {\n  const {\n    tokenIn,\n    tokenOut,\n    tokenInSymbol,\n    tokenOutSymbol,\n    tokenInDecimals,\n    tokenOutDecimals,\n    amountIn,\n    slippageBps = DEFAULT_SWAP_SLIPPAGE_BPS,\n  } = params;\n\n  const warnings: string[] = [];\n  let oneInchResult: OneInchQuoteResult | undefined;\n  let dflowResult: { amountOut: string; minAmountOut: string; routeSummary?: string; gas?: string } | undefined;\n  let uniswapResult: { amountOut: string; gasEstimate: string } | undefined;\n  let routingMetadata: RoutingMetadata | undefined;\n\n  // Sprint 3: Use unified routing service for dFlow routing\n  // Generate correlation ID for routing request\n  const { makeCorrelationId } = await import('../utils/correlationId');\n  const routingCorrelationId = makeCorrelationId('swap');\n  const routedQuote = await getSwapQuoteRouted({\n    tokenIn,\n    tokenOut,\n    amountIn,\n    slippageBps,\n    chainId: ETH_TESTNET_CHAIN_ID,\n    correlationId: routingCorrelationId,\n    fallbackQuote: async () => {\n      // Fallback: Try Uniswap V3 quoter\n      if (isUniswapQuoterAvailable()) {\n        try {\n          const uniswapQuote = await getUniswapV3Quote({\n            tokenIn,\n            tokenOut,\n            amountIn,\n            fee: 3000, // 0.3% fee tier\n          });\n          if (uniswapQuote) {\n            uniswapResult = {\n              amountOut: uniswapQuote.amountOut,\n              gasEstimate: uniswapQuote.gasEstimate,\n            };\n            // Calculate minOut with slippage\n            const slippageMultiplier = BigInt(10000 - (slippageBps || DEFAULT_SWAP_SLIPPAGE_BPS));\n            const minOutRaw = (BigInt(uniswapQuote.amountOut) * slippageMultiplier / 10000n).toString();\n            return {\n              amountOut: uniswapQuote.amountOut,\n              minAmountOut: minOutRaw,\n              routeSummary: `${tokenInSymbol} \u2192 ${tokenOutSymbol} via Uniswap V3`,\n              gas: uniswapQuote.gasEstimate,\n            };\n          }\n        } catch (error: any) {\n          console.warn('[getSwapRoutingDecision] Uniswap quote failed:', error.message);\n        }\n      }\n\n      // Try 1inch if hybrid mode\n      if (ROUTING_MODE === 'hybrid' && isOneInchAvailable()) {\n        try {\n          oneInchResult = await getOneInchQuote({\n            chainId: ETH_TESTNET_CHAIN_ID,\n            tokenIn,\n            tokenOut,\n            amountIn,\n            slippageBps,\n          });\n          if (oneInchResult) {\n            const slippageMultiplier = BigInt(10000 - slippageBps);\n            const minOutRaw = (BigInt(oneInchResult.toTokenAmount) * slippageMultiplier / 10000n).toString();\n            return {\n              amountOut: oneInchResult.toTokenAmount,\n              minAmountOut: minOutRaw,\n              routeSummary: oneInchResult.routeSummary || `${tokenInSymbol} \u2192 ${tokenOutSymbol} via 1inch`,\n              gas: oneInchResult.estimatedGas,\n            };\n          }\n        } catch (error: any) {\n          console.warn('[getSwapRoutingDecision] 1inch quote failed:', error.message);\n          warnings.push(`1inch quote unavailable: ${error.message}`);\n        }\n      }\n\n      return null;\n    },\n  });\n\n  // Ensure routing metadata always exists (guard against undefined)\n  routingMetadata = routedQuote.routing || {\n    source: 'fallback' as const,\n    kind: 'swap_quote' as const,\n    ok: false,\n    reason: 'Routing service returned no metadata',\n    latencyMs: 0,\n    mode: 'hybrid' as const,\n    correlationId: routingCorrelationId,\n  };\n\n  // If routing service returned dFlow data, use it\n  if (routedQuote.ok && routedQuote.data && routedQuote.routing.source === 'dflow') {\n    dflowResult = {\n      amountOut: routedQuote.data.amountOut,\n      minAmountOut: routedQuote.data.minAmountOut,\n      routeSummary: routedQuote.data.routeSummary,\n      gas: routedQuote.data.gas,\n    };\n  }\n\n  // Uniswap and 1inch are now tried in fallbackQuote callback above\n  // Only fetch them here if routing service didn't provide fallback data\n  if (!routedQuote.ok || routedQuote.routing.source !== 'fallback') {\n    // Routing service handled it, skip duplicate calls\n  } else if (routedQuote.ok && routedQuote.data) {\n    // Routing service provided fallback data, use it\n    const expectedOutRaw = routedQuote.data.amountOut;\n    const expectedOut = formatUnits(BigInt(expectedOutRaw), tokenOutDecimals);\n    const minOutRaw = routedQuote.data.minAmountOut;\n    const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n    return {\n      expectedOut,\n      expectedOutRaw,\n      minOut,\n      minOutRaw,\n      slippageBps: routedQuote.data.slippageBps,\n      routingSource: 'deterministic',\n      routeSummary: routedQuote.data.routeSummary || `${tokenInSymbol} \u2192 ${tokenOutSymbol}`,\n      protocols: [],\n      estimatedGas: routedQuote.data.gas,\n      executionVenue: 'Blossom Demo Router',\n      executionNote: 'Routing via fallback provider',\n      chain: 'Sepolia',\n      chainId: ETH_TESTNET_CHAIN_ID,\n      settlementEstimate: '~1 block',\n      warnings: routedQuote.routing.reason ? [routedQuote.routing.reason] : undefined,\n      routing: routingMetadata,\n    };\n  }\n\n  // If dFlow succeeded, use its data for routing intelligence\n  if (dflowResult) {\n    const expectedOutRaw = dflowResult.amountOut;\n    const expectedOut = formatUnits(BigInt(expectedOutRaw), tokenOutDecimals);\n    const minOutRaw = dflowResult.minAmountOut;\n    const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n    return {\n      expectedOut,\n      expectedOutRaw,\n      minOut,\n      minOutRaw,\n      slippageBps,\n      routingSource: 'dflow',\n      routeSummary: dflowResult.routeSummary || `${tokenInSymbol} \u2192 ${tokenOutSymbol} via dFlow`,\n      protocols: ['dFlow'],\n      estimatedGas: dflowResult.gas,\n      executionVenue: 'Blossom Demo Router',\n      executionNote: 'Routing powered by dFlow; executed via deterministic demo venue.',\n      chain: 'Sepolia',\n      chainId: ETH_TESTNET_CHAIN_ID,\n      settlementEstimate: '~1 block',\n      warnings: warnings.length > 0 ? warnings : undefined,\n      routing: routingMetadata, // Sprint 3: Include routing metadata\n    };\n  }\n\n  // Compare 1inch vs Uniswap and choose best route\n  if (oneInchResult && uniswapResult) {\n    const oneInchOut = BigInt(oneInchResult.toTokenAmount);\n    const uniswapOut = BigInt(uniswapResult.amountOut);\n    \n    // Choose route with higher output\n    if (uniswapOut > oneInchOut) {\n      // Uniswap is better\n      const expectedOut = formatUnits(uniswapOut, tokenOutDecimals);\n      const slippageMultiplier = BigInt(10000 - slippageBps);\n      const minOutRaw = (uniswapOut * slippageMultiplier / 10000n).toString();\n      const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n      return {\n        expectedOut,\n        expectedOutRaw: uniswapResult.amountOut,\n        minOut,\n        minOutRaw,\n        slippageBps,\n        routingSource: 'uniswap',\n        routeSummary: `${tokenInSymbol} \u2192 ${tokenOutSymbol} via Uniswap V3 (best route)`,\n        protocols: ['Uniswap V3'],\n        estimatedGas: uniswapResult.gasEstimate,\n        executionVenue: 'Uniswap V3',\n        executionNote: `Best route: Uniswap V3 (${expectedOut} ${tokenOutSymbol} vs 1inch ${formatUnits(oneInchOut, tokenOutDecimals)} ${tokenOutSymbol})`,\n        chain: 'Sepolia',\n        chainId: ETH_TESTNET_CHAIN_ID,\n        settlementEstimate: '~1 block',\n        warnings: warnings.length > 0 ? warnings : undefined,\n        routing: routingMetadata, // Sprint 3: Include routing metadata\n      };\n    } else {\n      // 1inch is better\n      const expectedOutRaw = oneInchResult.toTokenAmount;\n      const expectedOut = formatUnits(BigInt(expectedOutRaw), tokenOutDecimals);\n      const slippageMultiplier = BigInt(10000 - slippageBps);\n      const minOutRaw = (BigInt(expectedOutRaw) * slippageMultiplier / 10000n).toString();\n      const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n      return {\n        expectedOut,\n        expectedOutRaw,\n        minOut,\n        minOutRaw,\n        slippageBps,\n        routingSource: '1inch',\n        routeSummary: oneInchResult.routeSummary,\n        protocols: oneInchResult.protocols,\n        estimatedGas: oneInchResult.estimatedGas,\n        executionVenue: 'Uniswap V3', // Still execute via Uniswap V3 adapter\n        executionNote: `Best route: 1inch (${expectedOut} ${tokenOutSymbol} vs Uniswap ${formatUnits(uniswapOut, tokenOutDecimals)} ${tokenOutSymbol})`,\n        chain: 'Sepolia',\n        chainId: ETH_TESTNET_CHAIN_ID,\n        settlementEstimate: '~1 block',\n        warnings: warnings.length > 0 ? warnings : undefined,\n        routing: routingMetadata, // Sprint 3: Include routing metadata\n      };\n    }\n  }\n\n  // If only 1inch succeeded, use its data for routing intelligence\n  if (oneInchResult) {\n    const expectedOutRaw = oneInchResult.toTokenAmount;\n    const expectedOut = formatUnits(BigInt(expectedOutRaw), tokenOutDecimals);\n    \n    // Apply slippage to get minOut\n    const slippageMultiplier = BigInt(10000 - slippageBps);\n    const minOutRaw = (BigInt(expectedOutRaw) * slippageMultiplier / 10000n).toString();\n    const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n    return {\n      expectedOut,\n      expectedOutRaw,\n      minOut,\n      minOutRaw,\n      slippageBps,\n      routingSource: '1inch',\n      routeSummary: oneInchResult.routeSummary,\n      protocols: oneInchResult.protocols,\n      estimatedGas: oneInchResult.estimatedGas,\n      executionVenue: 'Uniswap V3', // Execute via Uniswap V3 adapter\n      executionNote: 'Routing computed from 1inch aggregator; executed via Uniswap V3.',\n      chain: 'Sepolia',\n      chainId: ETH_TESTNET_CHAIN_ID,\n      settlementEstimate: '~1 block',\n      warnings: warnings.length > 0 ? warnings : undefined,\n      routing: routingMetadata, // Sprint 3: Include routing metadata\n    };\n  }\n\n  // If only Uniswap succeeded, use its data\n  if (uniswapResult) {\n    const expectedOut = formatUnits(BigInt(uniswapResult.amountOut), tokenOutDecimals);\n    const slippageMultiplier = BigInt(10000 - slippageBps);\n    const minOutRaw = (BigInt(uniswapResult.amountOut) * slippageMultiplier / 10000n).toString();\n    const minOut = formatUnits(BigInt(minOutRaw), tokenOutDecimals);\n\n    return {\n      expectedOut,\n      expectedOutRaw: uniswapResult.amountOut,\n      minOut,\n      minOutRaw,\n      slippageBps,\n      routingSource: 'uniswap',\n      routeSummary: `${tokenInSymbol} \u2192 ${tokenOutSymbol} via Uniswap V3`,\n      protocols: ['Uniswap V3'],\n      estimatedGas: uniswapResult.gasEstimate,\n      executionVenue: 'Uniswap V3',\n      executionNote: 'Routing and execution via Uniswap V3.',\n      chain: 'Sepolia',\n      chainId: ETH_TESTNET_CHAIN_ID,\n      settlementEstimate: '~1 block',\n      warnings: warnings.length > 0 ? warnings : undefined,\n      routing: routingMetadata, // Sprint 3: Include routing metadata\n    };\n  }\n\n  // 1inch not available or failed - use deterministic fallback\n  if (ROUTING_REQUIRE_LIVE_QUOTE) {\n    throw new Error('Live routing quote required but unavailable. Set ROUTING_REQUIRE_LIVE_QUOTE=false to allow fallback.');\n  }\n\n  // Fallback to demo swap quote (deterministic)\n  warnings.push('Using deterministic quote (1inch unavailable for Sepolia testnet)');\n\n  const demoQuote = await getDemoSwapQuote({\n    tokenIn,\n    tokenOut,\n    amountIn,\n    slippageBps,\n  });\n\n  const expectedOut = formatUnits(BigInt(demoQuote.expectedOut), tokenOutDecimals);\n  const minOut = formatUnits(BigInt(demoQuote.minOut), tokenOutDecimals);\n\n  return {\n    expectedOut,\n    expectedOutRaw: demoQuote.expectedOut,\n    minOut,\n    minOutRaw: demoQuote.minOut,\n    slippageBps,\n    routingSource: 'deterministic',\n    routeSummary: `${tokenInSymbol} \u2192 ${tokenOutSymbol} via Demo Router`,\n    protocols: ['Blossom Demo Router'],\n    executionVenue: 'Blossom Demo Router',\n    executionNote: 'Deterministic routing and execution via demo venue.',\n    chain: 'Sepolia',\n    chainId: ETH_TESTNET_CHAIN_ID,\n    settlementEstimate: demoQuote.settlementEstimate,\n    warnings: warnings.length > 0 ? warnings : undefined,\n    routing: routingMetadata, // Sprint 3: Include routing metadata\n  };\n}\n\n", "/**\n * EVM Receipt Watcher\n * Polls for transaction receipts to confirm on-chain execution.\n */\n\nexport interface ReceiptResult {\n  status: 'confirmed' | 'failed' | 'timeout' | 'pending';\n  blockNumber?: number;\n  gasUsed?: string;\n  error?: string;\n}\n\n/**\n * Wait for a transaction receipt with polling\n * @param rpcUrl RPC endpoint URL\n * @param txHash Transaction hash to watch\n * @param options Timeout and poll interval options\n * @returns Receipt result with status\n */\nexport async function waitForReceipt(\n  rpcUrl: string,\n  txHash: string,\n  options: {\n    timeoutMs?: number;\n    pollMs?: number;\n  } = {}\n): Promise<ReceiptResult> {\n  const { timeoutMs = 60000, pollMs = 2000 } = options;\n  \n  const startTime = Date.now();\n\n  while (Date.now() - startTime < timeoutMs) {\n    try {\n      const receipt = await getTransactionReceipt(rpcUrl, txHash);\n      \n      if (receipt) {\n        // Receipt exists - check status\n        // status: 0x1 = success, 0x0 = failed\n        const statusHex = receipt.status;\n        const blockNumber = receipt.blockNumber \n          ? parseInt(receipt.blockNumber, 16) \n          : undefined;\n        const gasUsed = receipt.gasUsed;\n\n        if (statusHex === '0x1') {\n          return {\n            status: 'confirmed',\n            blockNumber,\n            gasUsed,\n          };\n        } else {\n          return {\n            status: 'failed',\n            blockNumber,\n            gasUsed,\n            error: 'Transaction reverted on-chain',\n          };\n        }\n      }\n\n      // No receipt yet - wait and poll again\n      await sleep(pollMs);\n    } catch (error: any) {\n      console.warn('[waitForReceipt] Poll error:', error.message);\n      // Continue polling on transient errors\n      await sleep(pollMs);\n    }\n  }\n\n  // Timeout reached\n  return {\n    status: 'timeout',\n    error: `Transaction not confirmed within ${timeoutMs / 1000}s`,\n  };\n}\n\n/**\n * Get transaction receipt via JSON-RPC\n */\nasync function getTransactionReceipt(\n  rpcUrl: string,\n  txHash: string\n): Promise<any | null> {\n  const response = await fetch(rpcUrl, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      jsonrpc: '2.0',\n      id: 1,\n      method: 'eth_getTransactionReceipt',\n      params: [txHash],\n    }),\n  });\n\n  if (!response.ok) {\n    throw new Error(`RPC request failed: ${response.status}`);\n  }\n\n  const data = await response.json();\n  \n  if (data.error) {\n    throw new Error(data.error.message || 'RPC error');\n  }\n\n  // result is null if receipt not yet available\n  return data.result;\n}\n\n/**\n * Simple sleep utility\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Check if a transaction is pending (no receipt yet)\n */\nexport async function isTransactionPending(\n  rpcUrl: string,\n  txHash: string\n): Promise<boolean> {\n  try {\n    const receipt = await getTransactionReceipt(rpcUrl, txHash);\n    return receipt === null;\n  } catch {\n    return true; // Assume pending on error\n  }\n}\n\n\n", "/**\n * Bloom Telemetry Database\n * SQLite-based telemetry for tracking users, sessions, and executions\n */\n\nimport Database from 'better-sqlite3';\nimport { randomUUID } from 'crypto';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { fileURLToPath } from 'url';\nimport { dirname } from 'path';\n\n// ESM-safe __dirname equivalent\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// Database file path (in agent/telemetry directory)\nconst DB_PATH = process.env.TELEMETRY_DB_PATH || path.join(__dirname, 'telemetry.db');\n\nlet db: Database.Database | null = null;\n\n/**\n * Initialize the database connection and run migrations\n */\nexport function initDatabase(): Database.Database {\n  if (db) return db;\n\n  // Ensure directory exists\n  const dbDir = path.dirname(DB_PATH);\n  if (!fs.existsSync(dbDir)) {\n    fs.mkdirSync(dbDir, { recursive: true });\n  }\n\n  db = new Database(DB_PATH);\n  db.pragma('journal_mode = WAL'); // Better concurrent access\n  db.pragma('foreign_keys = ON');\n\n  // Run migrations\n  runMigrations(db);\n\n  return db;\n}\n\n/**\n * Get the database instance (initializes if needed)\n */\nexport function getDatabase(): Database.Database {\n  if (!db) {\n    return initDatabase();\n  }\n  return db;\n}\n\n/**\n * Close the database connection\n */\nexport function closeDatabase(): void {\n  if (db) {\n    db.close();\n    db = null;\n  }\n}\n\n/**\n * Run schema migrations\n */\nfunction runMigrations(database: Database.Database): void {\n  const schemaPath = path.join(__dirname, 'schema.sql');\n  const schema = fs.readFileSync(schemaPath, 'utf-8');\n  database.exec(schema);\n}\n\n// ============================================\n// User Operations\n// ============================================\n\nexport interface User {\n  id: string;\n  address: string;\n  created_at: number;\n  notes?: string;\n}\n\nexport function upsertUser(address: string, notes?: Record<string, any>): User {\n  const db = getDatabase();\n  const id = randomUUID();\n  const notesJson = notes ? JSON.stringify(notes) : null;\n\n  const stmt = db.prepare(`\n    INSERT INTO users (id, address, notes)\n    VALUES (?, ?, ?)\n    ON CONFLICT(address) DO UPDATE SET\n      notes = COALESCE(excluded.notes, users.notes)\n    RETURNING *\n  `);\n\n  return stmt.get(id, address.toLowerCase(), notesJson) as User;\n}\n\nexport function getUser(address: string): User | undefined {\n  const db = getDatabase();\n  const stmt = db.prepare('SELECT * FROM users WHERE address = ?');\n  return stmt.get(address.toLowerCase()) as User | undefined;\n}\n\nexport function listUsers(limit = 100, offset = 0): User[] {\n  const db = getDatabase();\n  const stmt = db.prepare('SELECT * FROM users ORDER BY created_at DESC LIMIT ? OFFSET ?');\n  return stmt.all(limit, offset) as User[];\n}\n\n// ============================================\n// Session Operations\n// ============================================\n\nexport interface Session {\n  id: string;\n  user_address: string;\n  session_id: string;\n  status: string;\n  expires_at?: number;\n  created_at: number;\n  updated_at: number;\n}\n\nexport function upsertSession(\n  userAddress: string,\n  sessionId: string,\n  status: string,\n  expiresAt?: number\n): Session {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  // Ensure user exists\n  upsertUser(userAddress);\n\n  // Use INSERT OR REPLACE with proper UNIQUE constraint (user_address, session_id)\n  const existing = db.prepare(\n    'SELECT * FROM sessions WHERE user_address = ? AND session_id = ?'\n  ).get(userAddress.toLowerCase(), sessionId) as Session | undefined;\n\n  if (existing) {\n    db.prepare(`\n      UPDATE sessions SET status = ?, expires_at = ?, updated_at = ?\n      WHERE user_address = ? AND session_id = ?\n    `).run(status, expiresAt ?? null, now, userAddress.toLowerCase(), sessionId);\n    return { ...existing, status, expires_at: expiresAt, updated_at: now };\n  }\n\n  db.prepare(`\n    INSERT INTO sessions (id, user_address, session_id, status, expires_at, updated_at)\n    VALUES (?, ?, ?, ?, ?, ?)\n  `).run(id, userAddress.toLowerCase(), sessionId, status, expiresAt ?? null, now);\n\n  return {\n    id,\n    user_address: userAddress.toLowerCase(),\n    session_id: sessionId,\n    status,\n    expires_at: expiresAt,\n    created_at: now,\n    updated_at: now,\n  };\n}\n\nexport function getLatestSession(userAddress: string): Session | undefined {\n  const db = getDatabase();\n  const stmt = db.prepare(`\n    SELECT * FROM sessions\n    WHERE user_address = ?\n    ORDER BY created_at DESC\n    LIMIT 1\n  `);\n  return stmt.get(userAddress.toLowerCase()) as Session | undefined;\n}\n\n// ============================================\n// Execution Operations\n// ============================================\n\nexport interface Execution {\n  id: string;\n  user_address: string;\n  draft_id?: string;\n  correlation_id?: string;\n  action: string;\n  token?: string;\n  amount_units?: string;\n  mode: string;\n  status: string;\n  tx_hash?: string;\n  error_code?: string;\n  error_message?: string;\n  created_at: number;\n  updated_at: number;\n  latency_ms?: number;\n}\n\nexport function createExecution(params: {\n  userAddress: string;\n  draftId?: string;\n  correlationId?: string;\n  action: string;\n  token?: string;\n  amountUnits?: string;\n  mode?: string;\n}): Execution {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  // Ensure user exists\n  upsertUser(params.userAddress);\n\n  db.prepare(`\n    INSERT INTO executions (id, user_address, draft_id, correlation_id, action, token, amount_units, mode, status, created_at, updated_at)\n    VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'prepared', ?, ?)\n  `).run(\n    id,\n    params.userAddress.toLowerCase(),\n    params.draftId ?? null,\n    params.correlationId ?? null,\n    params.action,\n    params.token ?? null,\n    params.amountUnits ?? null,\n    params.mode ?? 'real',\n    now,\n    now\n  );\n\n  return {\n    id,\n    user_address: params.userAddress.toLowerCase(),\n    draft_id: params.draftId,\n    correlation_id: params.correlationId,\n    action: params.action,\n    token: params.token,\n    amount_units: params.amountUnits,\n    mode: params.mode ?? 'real',\n    status: 'prepared',\n    created_at: now,\n    updated_at: now,\n  };\n}\n\nexport function updateExecution(\n  id: string,\n  updates: {\n    status?: string;\n    txHash?: string;\n    errorCode?: string;\n    errorMessage?: string;\n    latencyMs?: number;\n  }\n): void {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n\n  const sets: string[] = ['updated_at = ?'];\n  const values: any[] = [now];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.txHash !== undefined) {\n    sets.push('tx_hash = ?');\n    values.push(updates.txHash);\n  }\n  if (updates.errorCode !== undefined) {\n    sets.push('error_code = ?');\n    values.push(updates.errorCode);\n  }\n  if (updates.errorMessage !== undefined) {\n    sets.push('error_message = ?');\n    values.push(updates.errorMessage);\n  }\n  if (updates.latencyMs !== undefined) {\n    sets.push('latency_ms = ?');\n    values.push(updates.latencyMs);\n  }\n\n  values.push(id);\n\n  db.prepare(`UPDATE executions SET ${sets.join(', ')} WHERE id = ?`).run(...values);\n}\n\nexport function updateExecutionByCorrelationId(\n  correlationId: string,\n  updates: {\n    status?: string;\n    txHash?: string;\n    errorCode?: string;\n    errorMessage?: string;\n    latencyMs?: number;\n  }\n): void {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n\n  const sets: string[] = ['updated_at = ?'];\n  const values: any[] = [now];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.txHash !== undefined) {\n    sets.push('tx_hash = ?');\n    values.push(updates.txHash);\n  }\n  if (updates.errorCode !== undefined) {\n    sets.push('error_code = ?');\n    values.push(updates.errorCode);\n  }\n  if (updates.errorMessage !== undefined) {\n    sets.push('error_message = ?');\n    values.push(updates.errorMessage);\n  }\n  if (updates.latencyMs !== undefined) {\n    sets.push('latency_ms = ?');\n    values.push(updates.latencyMs);\n  }\n\n  values.push(correlationId);\n\n  db.prepare(`UPDATE executions SET ${sets.join(', ')} WHERE correlation_id = ?`).run(...values);\n}\n\nexport function getExecution(id: string): Execution | undefined {\n  const db = getDatabase();\n  return db.prepare('SELECT * FROM executions WHERE id = ?').get(id) as Execution | undefined;\n}\n\nexport function listExecutions(limit = 50, offset = 0): Execution[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM executions\n    ORDER BY created_at DESC\n    LIMIT ? OFFSET ?\n  `).all(limit, offset) as Execution[];\n}\n\n// ============================================\n// Request Log Operations\n// ============================================\n\nexport function logRequest(params: {\n  endpoint: string;\n  method?: string;\n  userAddress?: string;\n  correlationId?: string;\n  statusCode?: number;\n  latencyMs?: number;\n  errorCode?: string;\n}): void {\n  const db = getDatabase();\n  db.prepare(`\n    INSERT INTO request_log (endpoint, method, user_address, correlation_id, status_code, latency_ms, error_code)\n    VALUES (?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    params.endpoint,\n    params.method ?? 'GET',\n    params.userAddress?.toLowerCase() ?? null,\n    params.correlationId ?? null,\n    params.statusCode ?? null,\n    params.latencyMs ?? null,\n    params.errorCode ?? null\n  );\n}\n\n// ============================================\n// Metrics / Summary Operations\n// ============================================\n\nexport interface TelemetrySummary {\n  totalUsers: number;\n  totalSessions: number;\n  activeSessions: number;\n  totalExecutions: number;\n  successfulExecutions: number;\n  failedExecutions: number;\n  successRate: number;\n  avgLatencyMs: number | null;\n  topErrors: { error_code: string; count: number }[];\n  recentExecutions: Execution[];\n}\n\nexport function getTelemetrySummary(): TelemetrySummary {\n  const db = getDatabase();\n\n  const totalUsers = (db.prepare('SELECT COUNT(*) as count FROM users').get() as any).count;\n  const totalSessions = (db.prepare('SELECT COUNT(*) as count FROM sessions').get() as any).count;\n  const activeSessions = (db.prepare(\"SELECT COUNT(*) as count FROM sessions WHERE status = 'active'\").get() as any).count;\n  const totalExecutions = (db.prepare('SELECT COUNT(*) as count FROM executions').get() as any).count;\n  const successfulExecutions = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status = 'confirmed'\").get() as any).count;\n  const failedExecutions = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status = 'failed'\").get() as any).count;\n\n  const avgLatency = db.prepare('SELECT AVG(latency_ms) as avg FROM executions WHERE latency_ms IS NOT NULL').get() as any;\n\n  const topErrors = db.prepare(`\n    SELECT error_code, COUNT(*) as count\n    FROM executions\n    WHERE error_code IS NOT NULL\n    GROUP BY error_code\n    ORDER BY count DESC\n    LIMIT 10\n  `).all() as { error_code: string; count: number }[];\n\n  const recentExecutions = listExecutions(20);\n\n  return {\n    totalUsers,\n    totalSessions,\n    activeSessions,\n    totalExecutions,\n    successfulExecutions,\n    failedExecutions,\n    successRate: totalExecutions > 0 ? (successfulExecutions / totalExecutions) * 100 : 0,\n    avgLatencyMs: avgLatency?.avg ?? null,\n    topErrors,\n    recentExecutions,\n  };\n}\n\nexport function getUsersWithSessionStatus(): Array<User & { session_status?: string; session_id?: string }> {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT u.*, s.status as session_status, s.session_id\n    FROM users u\n    LEFT JOIN sessions s ON u.address = s.user_address\n    ORDER BY u.created_at DESC\n    LIMIT 100\n  `).all() as Array<User & { session_status?: string; session_id?: string }>;\n}\n\n// ============================================\n// Devnet Statistics Operations\n// ============================================\n\nexport interface DevnetStats {\n  // A) Unique devnet users\n  users: {\n    allTime: number;\n    last24h: number;\n  };\n  // B) Processed transactions\n  transactions: {\n    allTime: number;\n    last24h: number;\n    successCount: number;\n    failCount: number;\n  };\n  // C) Total devnet amount executed\n  amountExecuted: {\n    byToken: Array<{ token: string; totalUnits: string }>;\n    unpricedCount: number;\n  };\n  // D) Devnet fees collected\n  feesCollected: {\n    byToken: Array<{ token: string; totalFeeUnits: string; last24hFeeUnits: string }>;\n    feeBps: number;\n    unpricedCount: number;\n  };\n  // Metadata\n  generatedAt: string;\n}\n\n/**\n * Get comprehensive devnet statistics for landing page\n */\nexport function getDevnetStats(feeBps: number): DevnetStats {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n  const dayAgo = now - 86400;\n\n  // A) Unique users\n  const totalUsersResult = db.prepare('SELECT COUNT(DISTINCT address) as count FROM users').get() as any;\n  const users24hResult = db.prepare(\n    'SELECT COUNT(DISTINCT user_address) as count FROM executions WHERE created_at >= ?'\n  ).get(dayAgo) as any;\n\n  // B) Transaction counts\n  const totalExecResult = db.prepare('SELECT COUNT(*) as count FROM executions').get() as any;\n  const exec24hResult = db.prepare(\n    'SELECT COUNT(*) as count FROM executions WHERE created_at >= ?'\n  ).get(dayAgo) as any;\n  const successResult = db.prepare(\n    \"SELECT COUNT(*) as count FROM executions WHERE status = 'confirmed' OR tx_hash IS NOT NULL\"\n  ).get() as any;\n  const failResult = db.prepare(\n    \"SELECT COUNT(*) as count FROM executions WHERE status = 'failed'\"\n  ).get() as any;\n\n  // C) Amount executed by token\n  const amountByToken = db.prepare(`\n    SELECT token, SUM(CAST(amount_units AS REAL)) as total_units\n    FROM executions\n    WHERE token IS NOT NULL AND amount_units IS NOT NULL AND amount_units != ''\n    GROUP BY token\n  `).all() as Array<{ token: string; total_units: number }>;\n\n  const unpricedAmountResult = db.prepare(`\n    SELECT COUNT(*) as count FROM executions\n    WHERE token IS NULL OR amount_units IS NULL OR amount_units = ''\n  `).get() as any;\n\n  // D) Fees collected by token (only successful executions)\n  // First try to use stored fee_units, otherwise calculate from amount_units\n  const feesByToken = db.prepare(`\n    SELECT\n      token,\n      SUM(CAST(COALESCE(fee_units, CAST(amount_units AS REAL) * ? / 10000) AS REAL)) as total_fee,\n      SUM(CASE WHEN created_at >= ? THEN CAST(COALESCE(fee_units, CAST(amount_units AS REAL) * ? / 10000) AS REAL) ELSE 0 END) as fee_24h\n    FROM executions\n    WHERE (status = 'confirmed' OR tx_hash IS NOT NULL)\n      AND token IS NOT NULL\n      AND amount_units IS NOT NULL\n      AND amount_units != ''\n    GROUP BY token\n  `).all(feeBps, dayAgo, feeBps) as Array<{ token: string; total_fee: number; fee_24h: number }>;\n\n  const unpricedFeeResult = db.prepare(`\n    SELECT COUNT(*) as count FROM executions\n    WHERE (status = 'confirmed' OR tx_hash IS NOT NULL)\n      AND (token IS NULL OR amount_units IS NULL OR amount_units = '')\n  `).get() as any;\n\n  return {\n    users: {\n      allTime: totalUsersResult?.count ?? 0,\n      last24h: users24hResult?.count ?? 0,\n    },\n    transactions: {\n      allTime: totalExecResult?.count ?? 0,\n      last24h: exec24hResult?.count ?? 0,\n      successCount: successResult?.count ?? 0,\n      failCount: failResult?.count ?? 0,\n    },\n    amountExecuted: {\n      byToken: amountByToken.map(row => ({\n        token: row.token,\n        totalUnits: row.total_units?.toFixed(6) ?? '0',\n      })),\n      unpricedCount: unpricedAmountResult?.count ?? 0,\n    },\n    feesCollected: {\n      byToken: feesByToken.map(row => ({\n        token: row.token,\n        totalFeeUnits: row.total_fee?.toFixed(6) ?? '0',\n        last24hFeeUnits: row.fee_24h?.toFixed(6) ?? '0',\n      })),\n      feeBps,\n      unpricedCount: unpricedFeeResult?.count ?? 0,\n    },\n    generatedAt: new Date().toISOString(),\n  };\n}\n\n/**\n * Update execution with fee information (call after successful execution)\n */\nexport function updateExecutionWithFee(\n  id: string,\n  amountUnits: string | undefined,\n  feeBps: number\n): void {\n  if (!amountUnits) return;\n\n  const db = getDatabase();\n  const amount = parseFloat(amountUnits);\n  if (isNaN(amount)) return;\n\n  const feeUnits = (amount * feeBps / 10000).toFixed(6);\n\n  db.prepare(`\n    UPDATE executions SET fee_units = ?, fee_bps = ?, updated_at = ?\n    WHERE id = ?\n  `).run(feeUnits, feeBps, Math.floor(Date.now() / 1000), id);\n}\n\n// ============================================\n// Traffic Statistics (Request-level metrics)\n// ============================================\n\nexport interface TrafficStats {\n  // Traffic = HTTP requests processed (not on-chain transactions)\n  requests: {\n    allTime: number;\n    last24h: number;\n    successRate24h: number; // percentage of requests with status_code < 400\n    http5xx24h: number;\n  };\n  // Unique visitors based on user_address in request_log\n  visitors: {\n    allTime: number;\n    last24h: number;\n  };\n  generatedAt: string;\n}\n\n/**\n * Get traffic statistics (HTTP request-level metrics)\n * This is separate from execution stats which track on-chain transactions\n */\nexport function getTrafficStats(windowHours = 24): TrafficStats {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n  const windowStart = now - (windowHours * 3600);\n\n  // Total requests all time\n  const totalRequestsResult = db.prepare(\n    'SELECT COUNT(*) as count FROM request_log'\n  ).get() as any;\n\n  // Requests in window\n  const requestsWindowResult = db.prepare(\n    'SELECT COUNT(*) as count FROM request_log WHERE created_at >= ?'\n  ).get(windowStart) as any;\n\n  // Success rate in window (status_code < 400 or null = success)\n  const successWindowResult = db.prepare(`\n    SELECT COUNT(*) as count FROM request_log\n    WHERE created_at >= ? AND (status_code IS NULL OR status_code < 400)\n  `).get(windowStart) as any;\n\n  // 5xx errors in window\n  const http5xxWindowResult = db.prepare(\n    'SELECT COUNT(*) as count FROM request_log WHERE created_at >= ? AND status_code >= 500'\n  ).get(windowStart) as any;\n\n  // Unique visitors all time (by user_address)\n  const visitorsAllTimeResult = db.prepare(\n    'SELECT COUNT(DISTINCT user_address) as count FROM request_log WHERE user_address IS NOT NULL'\n  ).get() as any;\n\n  // Unique visitors in window\n  const visitorsWindowResult = db.prepare(\n    'SELECT COUNT(DISTINCT user_address) as count FROM request_log WHERE user_address IS NOT NULL AND created_at >= ?'\n  ).get(windowStart) as any;\n\n  const requestsInWindow = requestsWindowResult?.count ?? 0;\n  const successInWindow = successWindowResult?.count ?? 0;\n  const successRate = requestsInWindow > 0 ? (successInWindow / requestsInWindow) * 100 : 100;\n\n  return {\n    requests: {\n      allTime: totalRequestsResult?.count ?? 0,\n      last24h: requestsInWindow,\n      successRate24h: Math.round(successRate * 100) / 100,\n      http5xx24h: http5xxWindowResult?.count ?? 0,\n    },\n    visitors: {\n      allTime: visitorsAllTimeResult?.count ?? 0,\n      last24h: visitorsWindowResult?.count ?? 0,\n    },\n    generatedAt: new Date().toISOString(),\n  };\n}\n\n/**\n * Get request log stats for load test reports\n */\nexport function getRequestLogStats(runId?: string): {\n  totalRequests: number;\n  byEndpoint: Array<{ endpoint: string; count: number; successCount: number; avgLatencyMs: number; p95LatencyMs: number }>;\n  errorCodes: Array<{ code: string; count: number }>;\n  http5xxCount: number;\n} {\n  const db = getDatabase();\n\n  const totalResult = db.prepare('SELECT COUNT(*) as count FROM request_log').get() as any;\n\n  const byEndpoint = db.prepare(`\n    SELECT\n      endpoint,\n      COUNT(*) as count,\n      SUM(CASE WHEN status_code = 200 THEN 1 ELSE 0 END) as success_count,\n      AVG(latency_ms) as avg_latency\n    FROM request_log\n    GROUP BY endpoint\n    ORDER BY count DESC\n  `).all() as Array<{ endpoint: string; count: number; success_count: number; avg_latency: number }>;\n\n  // Calculate p95 per endpoint\n  const byEndpointWithP95 = byEndpoint.map(row => {\n    const latencies = db.prepare(\n      'SELECT latency_ms FROM request_log WHERE endpoint = ? AND latency_ms IS NOT NULL ORDER BY latency_ms'\n    ).all(row.endpoint) as Array<{ latency_ms: number }>;\n\n    const p95Index = Math.ceil(latencies.length * 0.95) - 1;\n    const p95 = latencies[Math.max(0, p95Index)]?.latency_ms ?? 0;\n\n    return {\n      endpoint: row.endpoint,\n      count: row.count,\n      successCount: row.success_count,\n      avgLatencyMs: Math.round(row.avg_latency ?? 0),\n      p95LatencyMs: p95,\n    };\n  });\n\n  const errorCodes = db.prepare(`\n    SELECT error_code as code, COUNT(*) as count\n    FROM request_log\n    WHERE error_code IS NOT NULL\n    GROUP BY error_code\n    ORDER BY count DESC\n    LIMIT 10\n  `).all() as Array<{ code: string; count: number }>;\n\n  const http5xxResult = db.prepare(\n    'SELECT COUNT(*) as count FROM request_log WHERE status_code >= 500'\n  ).get() as any;\n\n  return {\n    totalRequests: totalResult?.count ?? 0,\n    byEndpoint: byEndpointWithP95,\n    errorCodes,\n    http5xxCount: http5xxResult?.count ?? 0,\n  };\n}\n\n/**\n * Get recent transaction hashes for reporting\n */\nexport function getRecentTxHashes(limit = 20): string[] {\n  const db = getDatabase();\n  const rows = db.prepare(`\n    SELECT tx_hash FROM executions\n    WHERE tx_hash IS NOT NULL\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(limit) as Array<{ tx_hash: string }>;\n\n  return rows.map(r => r.tx_hash);\n}\n\n/**\n * Migrate database to add fee columns if they don't exist\n */\nexport function migrateAddFeeColumns(): void {\n  const db = getDatabase();\n\n  // Check if fee_units column exists\n  const columns = db.prepare(\"PRAGMA table_info(executions)\").all() as Array<{ name: string }>;\n  const hasFeeCols = columns.some(c => c.name === 'fee_units');\n\n  if (!hasFeeCols) {\n    try {\n      db.exec('ALTER TABLE executions ADD COLUMN fee_units TEXT');\n      db.exec('ALTER TABLE executions ADD COLUMN fee_bps INTEGER');\n      console.log('[telemetry] Migrated: added fee_units and fee_bps columns');\n    } catch (e) {\n      // Columns might already exist from schema.sql\n      console.log('[telemetry] Fee columns already exist or migration skipped');\n    }\n  }\n}\n\n// ============================================\n// Devnet Traffic Runs Operations\n// ============================================\n\nexport interface DevnetRun {\n  run_id: string;\n  stage: number | null;\n  users: number;\n  concurrency: number;\n  duration: number;\n  total_requests: number;\n  success_rate: number;\n  p50_ms: number;\n  p95_ms: number;\n  http_5xx: number;\n  top_error_code: string | null;\n  started_at: string;\n  ended_at: string;\n  report_path: string | null;\n  created_at: number;\n}\n\n/**\n * Ensure runs table exists\n */\nexport function ensureRunsTable(): void {\n  const db = getDatabase();\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS runs (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      run_id TEXT UNIQUE NOT NULL,\n      stage INTEGER,\n      users INTEGER,\n      concurrency INTEGER,\n      duration INTEGER,\n      total_requests INTEGER,\n      success_rate REAL,\n      p50_ms INTEGER,\n      p95_ms INTEGER,\n      http_5xx INTEGER,\n      top_error_code TEXT,\n      started_at TEXT,\n      ended_at TEXT,\n      report_path TEXT,\n      created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))\n    );\n    CREATE INDEX IF NOT EXISTS idx_runs_run_id ON runs(run_id);\n    CREATE INDEX IF NOT EXISTS idx_runs_created ON runs(created_at);\n  `);\n}\n\n/**\n * Insert or update a run record\n */\nexport function upsertRun(run: Omit<DevnetRun, 'created_at'>): void {\n  const db = getDatabase();\n  ensureRunsTable();\n\n  db.prepare(`\n    INSERT OR REPLACE INTO runs (\n      run_id, stage, users, concurrency, duration,\n      total_requests, success_rate, p50_ms, p95_ms, http_5xx,\n      top_error_code, started_at, ended_at, report_path\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    run.run_id,\n    run.stage,\n    run.users,\n    run.concurrency,\n    run.duration,\n    run.total_requests,\n    run.success_rate,\n    run.p50_ms,\n    run.p95_ms,\n    run.http_5xx,\n    run.top_error_code,\n    run.started_at,\n    run.ended_at,\n    run.report_path\n  );\n}\n\n/**\n * List recent devnet traffic runs\n */\nexport function listRuns(limit = 5): DevnetRun[] {\n  const db = getDatabase();\n  ensureRunsTable();\n\n  return db.prepare(`\n    SELECT * FROM runs\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(limit) as DevnetRun[];\n}\n\n/**\n * Get a specific run by run_id\n */\nexport function getRun(runId: string): DevnetRun | undefined {\n  const db = getDatabase();\n  ensureRunsTable();\n\n  return db.prepare('SELECT * FROM runs WHERE run_id = ?').get(runId) as DevnetRun | undefined;\n}\n", "/**\n * Lending Quote Provider\n * Provides routing metadata for lending operations\n * Supports hybrid model: real APR data from DefiLlama + deterministic execution\n */\n\nimport {\n  DEMO_LEND_VAULT_ADDRESS,\n  LENDING_EXECUTION_MODE,\n  LENDING_RATE_SOURCE,\n  ETH_TESTNET_CHAIN_ID,\n} from '../config';\n\nexport interface LendingQuoteRequest {\n  asset: string; // Token address (e.g., DEMO_REDACTED)\n  amount: string; // Amount in wei (BigInt string)\n  vaultAddress?: string; // Optional: specific vault address\n}\n\nexport interface LendingRoutingDecision {\n  // Decision layer\n  routingSource: 'defillama' | 'deterministic';\n  apr: string; // APR as percentage string (e.g., \"5.0\")\n  aprBps: number; // APR in basis points\n  protocol: string; // e.g., \"DemoLendVault\"\n  \n  // Execution layer\n  executionVenue: string;\n  executionNote: string;\n  vault: string; // Vault address\n  \n  // Chain info\n  chain: string;\n  chainId: number;\n  settlementEstimate: string;\n  \n  // Warnings if any\n  warnings?: string[];\n}\n\n/**\n * Demo lending vault informational APR (5%)\n */\nconst DEMO_VAULT_APR_BPS = 500;\n\n/**\n * Get lending routing decision with APR data\n * Uses DefiLlama for real rates (when available), falls back to deterministic\n */\nexport async function getLendingRoutingDecision(\n  request: LendingQuoteRequest\n): Promise<LendingRoutingDecision> {\n  const warnings: string[] = [];\n  let apr = DEMO_VAULT_APR_BPS;\n  let routingSource: 'defillama' | 'deterministic' = 'deterministic';\n\n  // Try to get APR from DefiLlama if configured\n  if (LENDING_RATE_SOURCE === 'defillama') {\n    try {\n      const { getTopYieldVaults } = await import('./defiLlamaQuote');\n      const vaults = await getTopYieldVaults();\n      if (vaults.length > 0) {\n        // Use highest APY vault\n        apr = Math.round(vaults[0].apy * 100); // Convert to bps\n        routingSource = 'defillama';\n      } else {\n        warnings.push('DefiLlama vaults not available; using demo rate');\n      }\n    } catch (error: any) {\n      console.warn('[lendingQuote] DefiLlama fetch failed:', error.message);\n      warnings.push('DefiLlama fetch failed; using demo rate');\n    }\n  }\n\n  const vaultAddress = request.vaultAddress || DEMO_LEND_VAULT_ADDRESS || '';\n  const isDemo = LENDING_EXECUTION_MODE === 'demo';\n\n  return {\n    routingSource,\n    apr: (apr / 100).toFixed(2), // Convert bps to percentage\n    aprBps: apr,\n    protocol: isDemo ? 'DemoLendVault' : 'Aave V3',\n    executionVenue: isDemo ? 'Blossom Demo Lending Vault' : 'Aave V3',\n    executionNote: isDemo \n      ? 'Executed deterministically via demo vault; APR is informational only.'\n      : 'Executed via real lending protocol.',\n    vault: vaultAddress,\n    chain: 'Sepolia',\n    chainId: ETH_TESTNET_CHAIN_ID,\n    settlementEstimate: '~1 block',\n    warnings: warnings.length > 0 ? warnings : undefined,\n  };\n}\n\n/**\n * Attempt to fetch APR from DefiLlama\n * Returns APR as percentage (e.g., 5.0 for 5%)\n */\nasync function getDefiLlamaApr(assetAddress: string): Promise<number | undefined> {\n  // DefiLlama yields endpoint for Sepolia is limited\n  // For MVP, we'll return undefined to use deterministic rate\n  // In production, this would query DefiLlama's pools API\n  \n  // Example endpoint: https://yields.llama.fi/pools\n  // But Sepolia testnet doesn't have real yield data\n  \n  try {\n    // For demo purposes, simulate a slightly different rate\n    // In real implementation, fetch from DefiLlama API\n    const response = await fetch('https://yields.llama.fi/pools', {\n      method: 'GET',\n      headers: { 'Accept': 'application/json' },\n    });\n\n    if (!response.ok) {\n      return undefined;\n    }\n\n    // DefiLlama returns mainnet data; we can't match Sepolia addresses\n    // Return undefined to fall back to deterministic rate\n    console.log('[lendingQuote] DefiLlama data fetched but not applicable to Sepolia testnet');\n    return undefined;\n  } catch (error) {\n    // Network error or timeout\n    return undefined;\n  }\n}\n\n/**\n * Get informational APR for display (demo vault)\n */\nexport function getDemoVaultApr(): { apr: string; aprBps: number } {\n  return {\n    apr: (DEMO_VAULT_APR_BPS / 100).toFixed(2),\n    aprBps: DEMO_VAULT_APR_BPS,\n  };\n}\n\n", "/**\n * ERC20 RPC Helpers\n * Read ERC20 token balance and allowance via JSON-RPC eth_call\n */\n\nimport { ETH_TESTNET_RPC_URL } from '../config';\n\n/**\n * JSON-RPC Response type\n */\ntype JsonRpcResponse<T = unknown> = {\n  result?: T;\n  error?: { message?: string; code?: number; data?: unknown };\n};\n\n/**\n * ERC20 ABI for balanceOf and allowance\n */\nconst ERC20_ABI = [\n  {\n    name: 'balanceOf',\n    type: 'function',\n    stateMutability: 'view',\n    inputs: [{ name: 'owner', type: 'address' }],\n    outputs: [{ name: '', type: 'uint256' }],\n  },\n  {\n    name: 'allowance',\n    type: 'function',\n    stateMutability: 'view',\n    inputs: [\n      { name: 'owner', type: 'address' },\n      { name: 'spender', type: 'address' },\n    ],\n    outputs: [{ name: '', type: 'uint256' }],\n  },\n] as const;\n\n/**\n * Decode uint256 from hex response\n */\nfunction decodeUint256(hex: string): bigint {\n  if (!hex || hex === '0x') {\n    return 0n;\n  }\n  return BigInt(hex);\n}\n\n/**\n * Get ERC20 token balance for an address\n * @param token Token contract address\n * @param owner Owner address\n * @returns Token balance as bigint\n */\nexport async function erc20_balanceOf(\n  token: string,\n  owner: string\n): Promise<bigint> {\n  if (!ETH_TESTNET_RPC_URL) {\n    throw new Error('ETH_TESTNET_RPC_URL not configured');\n  }\n\n  const { encodeFunctionData } = await import('viem');\n  const to = token.toLowerCase() as `0x${string}`;\n  const ownerAddr = owner.toLowerCase() as `0x${string}`;\n\n  const data = encodeFunctionData({\n    abi: ERC20_ABI,\n    functionName: 'balanceOf',\n    args: [ownerAddr],\n  });\n\n  // Debug log (no secrets)\n  console.log(`[erc20Rpc] balanceOf: token=${to.substring(0, 10)}..., owner=${ownerAddr.substring(0, 10)}..., data=${data.substring(0, 10)}...`);\n\n  try {\n    const response = await fetch(ETH_TESTNET_RPC_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'eth_call',\n        params: [\n          {\n            to,\n            data,\n          },\n          'latest',\n        ],\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`RPC call failed: ${response.statusText}`);\n    }\n\n    const result = await response.json();\n\n    if (result.error) {\n      throw new Error(`RPC error: ${result.error.message || JSON.stringify(result.error)}`);\n    }\n\n    return decodeUint256(result.result);\n  } catch (error: any) {\n    throw new Error(`Failed to fetch ERC20 balance: ${error.message}`);\n  }\n}\n\n/**\n * Get ERC20 token allowance for a spender\n * @param token Token contract address\n * @param owner Owner address\n * @param spender Spender address\n * @returns Token allowance as bigint\n */\nexport async function erc20_allowance(\n  token: string,\n  owner: string,\n  spender: string\n): Promise<bigint> {\n  if (!ETH_TESTNET_RPC_URL) {\n    throw new Error('ETH_TESTNET_RPC_URL not configured');\n  }\n\n  const { encodeFunctionData } = await import('viem');\n  const to = token.toLowerCase() as `0x${string}`;\n  const ownerAddr = owner.toLowerCase() as `0x${string}`;\n  const spenderAddr = spender.toLowerCase() as `0x${string}`;\n\n  const data = encodeFunctionData({\n    abi: ERC20_ABI,\n    functionName: 'allowance',\n    args: [ownerAddr, spenderAddr],\n  });\n\n  // Debug log (no secrets)\n  console.log(`[erc20Rpc] allowance: token=${to.substring(0, 10)}..., owner=${ownerAddr.substring(0, 10)}..., spender=${spenderAddr.substring(0, 10)}..., data=${data.substring(0, 10)}...`);\n\n  try {\n    const response = await fetch(ETH_TESTNET_RPC_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'eth_call',\n        params: [\n          {\n            to,\n            data,\n          },\n          'latest',\n        ],\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`RPC call failed: ${response.statusText}`);\n    }\n\n    const jsonResult: unknown = await response.json();\n    const result = jsonResult as JsonRpcResponse<string>;\n\n    if (result.error) {\n      throw new Error(`RPC error: ${result.error.message || JSON.stringify(result.error)}`);\n    }\n\n    if (!result.result) {\n      throw new Error('RPC response missing result field');\n    }\n\n    return decodeUint256(result.result);\n  } catch (error: any) {\n    throw new Error(`Failed to fetch ERC20 allowance: ${error.message}`);\n  }\n}\n\n\n", "/**\n * EVM RPC Utilities\n * Lightweight JSON-RPC helpers for contract interaction\n */\n\n/**\n * JSON-RPC Response type\n */\ntype JsonRpcResponse<T = unknown> = {\n  result?: T;\n  error?: { message?: string; code?: number; data?: unknown };\n};\n\n/**\n * Pad address to 32 bytes (64 hex chars)\n */\nexport function padAddress(address: string): string {\n  const addressWithoutPrefix = address.toLowerCase().replace(/^0x/, '');\n  return '0x' + addressWithoutPrefix.padStart(64, '0');\n}\n\n/**\n * Encode function call data\n * @param functionSelector - 4-byte function selector (e.g., \"0x7ecebe00\")\n * @param params - Array of encoded parameters (without 0x prefix)\n */\nexport function encodeCall(functionSelector: string, ...params: string[]): string {\n  return functionSelector + params.join('');\n}\n\n/**\n * Call eth_getCode\n */\nexport async function eth_getCode(rpcUrl: string, address: string): Promise<string> {\n  const response = await fetch(rpcUrl, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      jsonrpc: '2.0',\n      id: 1,\n      method: 'eth_getCode',\n      params: [address.toLowerCase(), 'latest'],\n    }),\n  });\n\n  const jsonResult: unknown = await response.json();\n  const result = jsonResult as JsonRpcResponse<string>;\n\n  if (result.error) {\n    throw new Error(`RPC error: ${result.error.message || 'Unknown error'}`);\n  }\n\n  if (!result.result) {\n    return '0x';\n  }\n\n  return result.result;\n}\n\n/**\n * Call eth_call\n */\nexport async function eth_call(\n  rpcUrl: string,\n  to: string,\n  data: string\n): Promise<string> {\n  const response = await fetch(rpcUrl, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      jsonrpc: '2.0',\n      id: 1,\n      method: 'eth_call',\n      params: [\n        {\n          to: to.toLowerCase(),\n          data: data,\n        },\n        'latest',\n      ],\n    }),\n  });\n\n  const jsonResult: unknown = await response.json();\n  const result = jsonResult as JsonRpcResponse<string>;\n\n  if (result.error) {\n    throw new Error(`RPC error: ${result.error.message || 'Unknown error'}`);\n  }\n\n  if (!result.result) {\n    return '0x';\n  }\n\n  return result.result;\n}\n\n/**\n * Decode boolean from eth_call result\n */\nexport function decodeBool(hex: string): boolean {\n  // Remove 0x prefix and leading zeros, check if last char is odd (1) or even (0)\n  const cleaned = hex.replace(/^0x0*/, '');\n  if (cleaned === '') return false;\n  // Check if the value is non-zero\n  return BigInt(hex) !== 0n;\n}\n\n/**\n * Decode uint256 from eth_call result\n */\nexport function decodeUint256(hex: string): string {\n  if (!hex || hex === '0x' || hex === '0x0') {\n    return '0';\n  }\n  return BigInt(hex).toString();\n}\n\n\n", "/**\n * Aave v3 Market Configuration\n * Single source of truth for Aave v3 testnet market data\n */\n\nimport { Address } from 'viem';\nimport { ETH_TESTNET_CHAIN_ID, ETH_TESTNET_RPC_URL } from '../../config';\n\nexport interface AaveMarketConfig {\n  chainId: number;\n  poolAddress: Address;\n  poolAddressesProvider: Address;\n  poolDataProvider: Address;\n  supportedAssets: AaveAsset[];\n}\n\nexport interface AaveAsset {\n  symbol: string;\n  address: Address;\n  aTokenAddress: Address;\n  decimals: number;\n}\n\n/**\n * Aave v3 Sepolia Market Configuration\n * Official addresses from: https://docs.aave.com/developers/deployed-contracts/v3-testnet-addresses\n */\nconst AAVE_V3_SEPOLIA_CONFIG: AaveMarketConfig = {\n  chainId: 11155111, // Sepolia\n  poolAddress: '0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951' as Address,\n  poolAddressesProvider: '0x012bAC54348C0E635dCAc9D5FB99f06F24136C9A' as Address,\n  poolDataProvider: '0x3e9708d80f7B3e43118013075F7e95CE3AB31F31' as Address,\n  supportedAssets: [\n    // REDACTED on Sepolia (testnet token)\n    // Note: aToken addresses can be fetched dynamically via PoolDataProvider\n    // For now, we'll use a known address or fetch it on-demand\n    // The actual REDACTED address on Sepolia may vary - this will be overridden by AAVE_REDACTED_ADDRESS if set\n    {\n      symbol: 'REDACTED',\n      address: '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8' as Address, // Sepolia REDACTED testnet token (fallback)\n      aTokenAddress: '0x0000000000000000000000000000000000000000' as Address, // Will be fetched dynamically\n      decimals: 6,\n    },\n  ],\n};\n\n/**\n * Get Aave market configuration for the current chain\n */\nexport async function getAaveMarketConfig(): Promise<AaveMarketConfig> {\n  const chainId = ETH_TESTNET_CHAIN_ID || 11155111;\n  \n  if (chainId === 11155111) {\n    // Sepolia - use official Aave v3 addresses\n    return AAVE_V3_SEPOLIA_CONFIG;\n  }\n  \n  throw new Error(`Aave v3 market not configured for chainId ${chainId}`);\n}\n\n/**\n * Fetch aToken address for an asset using PoolDataProvider\n */\nexport async function getATokenAddress(assetAddress: Address): Promise<Address | null> {\n  try {\n    const { createPublicClient, http } = await import('viem');\n    const { sepolia } = await import('viem/chains');\n    \n    if (!ETH_TESTNET_RPC_URL) {\n      console.warn('[aave/market] ETH_TESTNET_RPC_URL not configured, cannot fetch aToken address');\n      return null;\n    }\n\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    const config = await getAaveMarketConfig();\n    \n    // PoolDataProvider.getReserveTokensAddresses(address asset) returns (address aTokenAddress, address stableDebtTokenAddress, address variableDebtTokenAddress)\n    const abi = [\n      {\n        name: 'getReserveTokensAddresses',\n        type: 'function',\n        stateMutability: 'view',\n        inputs: [{ name: 'asset', type: 'address' }],\n        outputs: [\n          { name: 'aTokenAddress', type: 'address' },\n          { name: 'stableDebtTokenAddress', type: 'address' },\n          { name: 'variableDebtTokenAddress', type: 'address' },\n        ],\n      },\n    ] as const;\n\n    const result = await publicClient.readContract({\n      address: config.poolDataProvider as `0x${string}`,\n      abi,\n      functionName: 'getReserveTokensAddresses',\n      args: [assetAddress as `0x${string}`],\n    });\n\n    return result[0] as Address; // aToken address\n  } catch (error: any) {\n    console.warn(`[aave/market] Failed to fetch aToken address for ${assetAddress}:`, error.message);\n    return null;\n  }\n}\n\n/**\n * Get supported asset by symbol\n */\nexport async function getSupportedAsset(symbol: string): Promise<AaveAsset | null> {\n  const config = await getAaveMarketConfig();\n  const asset = config.supportedAssets.find(a => a.symbol === symbol);\n  \n  if (!asset) {\n    return null;\n  }\n\n  // If aToken address is not set, try to fetch it\n  if (asset.aTokenAddress === '0x0000000000000000000000000000000000000000') {\n    const aTokenAddress = await getATokenAddress(asset.address);\n    if (aTokenAddress) {\n      asset.aTokenAddress = aTokenAddress;\n    }\n  }\n\n  return asset;\n}\n\n/**\n * Get all supported assets with aToken addresses\n */\nexport async function getSupportedAssets(): Promise<AaveAsset[]> {\n  const config = await getAaveMarketConfig();\n  \n  // Fetch aToken addresses for assets that don't have them\n  const assetsWithATokens = await Promise.all(\n    config.supportedAssets.map(async (asset) => {\n      if (asset.aTokenAddress === '0x0000000000000000000000000000000000000000') {\n        const aTokenAddress = await getATokenAddress(asset.address);\n        if (aTokenAddress) {\n          return { ...asset, aTokenAddress };\n        }\n      }\n      return asset;\n    })\n  );\n\n  return assetsWithATokens;\n}\n", "// @ts-nocheck\n/**\n * ETH Testnet Executor\n * Prepares execution plans and EIP-712 typed data for signing\n */\n\nimport {\n  EXECUTION_ROUTER_ADDRESS,\n  MOCK_SWAP_ADAPTER_ADDRESS,\n  UNISWAP_V3_ADAPTER_ADDRESS,\n  UNISWAP_ADAPTER_ADDRESS,\n  WETH_WRAP_ADAPTER_ADDRESS,\n  ERC20_PULL_ADAPTER_ADDRESS,\n  REDACTED_ADDRESS_SEPOLIA,\n  WETH_ADDRESS_SEPOLIA,\n  DEMO_REDACTED_ADDRESS,\n  DEMO_WETH_ADDRESS,\n  DEMO_LEND_VAULT_ADDRESS,\n  DEMO_LEND_ADAPTER_ADDRESS,\n  PROOF_ADAPTER_ADDRESS,\n  ETH_TESTNET_RPC_URL,\n  ETH_TESTNET_CHAIN_ID,\n  requireEthTestnetConfig,\n  AAVE_WETH_ADDRESS,\n} from '../config';\nimport { getSwapQuote, getSwapRoutingDecision, RoutingDecision } from '../quotes/evmQuote';\nimport { getLendingRoutingDecision, LendingRoutingDecision } from '../quotes/lendingQuote';\nimport { BlossomExecutionRequest } from '../types/blossom';\nimport { erc20_balanceOf, erc20_allowance } from './erc20Rpc';\nimport { eth_call, padAddress, encodeCall, decodeUint256 } from './evmRpc';\nimport { parseUnits } from 'viem';\nimport { makeCorrelationId } from '../utils/correlationId';\n\nexport interface PrepareEthTestnetExecutionArgs {\n  draftId: string;\n  userAddress: string;\n  strategy?: any;\n  authMode?: 'direct' | 'session';\n  executionIntent?: 'mock' | 'swap_usdc_weth' | 'swap_weth_usdc';\n  executionRequest?: BlossomExecutionRequest; // NEW: from chat\n  executionKind?: 'demo_swap' | 'lend_supply' | 'perp' | 'event' | 'default'; // demo_swap triggers PULL+SWAP, lend_supply triggers PULL+LEND, perp/event triggers PROOF\n}\n\nexport interface ApprovalRequirement {\n  token: string;\n  spender: string;\n  amount: string;\n}\n\nexport interface PrepareEthTestnetExecutionResult {\n  chainId: number;\n  to: string;\n  value: string;\n  plan: {\n    user: string;\n    nonce: string;\n    deadline: string;\n    actions: Array<{\n      actionType: number;\n      adapter: string;\n      data: string;\n    }>;\n  };\n  requirements?: {\n    approvals?: ApprovalRequirement[];\n  };\n  typedData?: {\n    domain: {\n      name: string;\n      version: string;\n      chainId: number;\n      verifyingContract: string;\n    };\n    types: {\n      EIP712Domain: Array<{ name: string; type: string }>;\n      Action: Array<{ name: string; type: string }>;\n      Plan: Array<{ name: string; type: string }>;\n    };\n    primaryType: string;\n    message: {\n      user: string;\n      nonce: string;\n      deadline: string;\n      actions: Array<{\n        actionType: number;\n        adapter: string;\n        data: string;\n      }>;\n    };\n  };\n  call: {\n    method: 'executeBySender';\n    args: {\n      plan: {\n        user: string;\n        nonce: string;\n        deadline: string;\n        actions: Array<{\n          actionType: number;\n          adapter: string;\n          data: string;\n        }>;\n      };\n    };\n  };\n  summary: string;\n  warnings?: string[];\n  routing?: {\n    // Quote data (for swaps)\n    venue: string;\n    chain: string;\n    feeTier?: number;\n    expectedOut?: string;     // Human-readable (e.g., \"0.95\")\n    expectedOutRaw?: string; // BigInt string (wei) for contract calls\n    minOut?: string;          // Human-readable\n    minOutRaw?: string;      // BigInt string (wei) for contract calls\n    slippageBps?: number;\n    settlementEstimate: string;\n    // Hybrid routing fields\n    routingSource?: '1inch' | 'deterministic' | 'defillama' | 'dflow' | 'uniswap';\n    routeSummary?: string;\n    protocols?: string[];\n    // Sprint 3: Truthful routing metadata\n    routing?: {\n      source: 'dflow' | 'fallback';\n      kind: 'swap_quote' | 'event_markets';\n      ok: boolean;\n      reason?: string;\n      latencyMs: number;\n    };\n    estimatedGas?: string;\n    executionVenue?: string;\n    executionNote?: string;\n    warnings?: string[];\n    // Lending-specific fields\n    apr?: string; // e.g., \"5.00\"\n    aprBps?: number;\n    vault?: string; // Vault address\n    actionType?: 'swap' | 'lend_supply';\n    venueType?: number;\n  };\n  netExposure?: string; // Static net exposure string (e.g., \"Net: Perp delta +0.5%, Yield +5%\")\n}\n\n/**\n * Convert executionRequest to executionIntent and params\n */\nexport function executionRequestToIntent(\n  executionRequest: BlossomExecutionRequest\n): {\n  executionIntent: 'swap_usdc_weth' | 'swap_weth_usdc';\n  amountIn: bigint;\n  tokenIn: string;\n  tokenOut: string;\n  fundingPolicy: 'auto' | 'require_tokenIn';\n} {\n  if (executionRequest.kind !== 'swap') {\n    throw new Error('Only swap execution requests supported');\n  }\n\n  if (!REDACTED_ADDRESS_SEPOLIA || !WETH_ADDRESS_SEPOLIA) {\n    throw new Error('Token addresses not configured');\n  }\n  \n  // Determine token addresses\n  const tokenInAddr = executionRequest.tokenIn === 'ETH' \n    ? 'ETH' // Special case for native ETH\n    : executionRequest.tokenIn === 'WETH'\n    ? WETH_ADDRESS_SEPOLIA.toLowerCase()\n    : REDACTED_ADDRESS_SEPOLIA.toLowerCase();\n    \n  const tokenOutAddr = executionRequest.tokenOut === 'WETH'\n    ? WETH_ADDRESS_SEPOLIA.toLowerCase()\n    : REDACTED_ADDRESS_SEPOLIA.toLowerCase();\n\n  // Determine executionIntent\n  let executionIntent: 'swap_usdc_weth' | 'swap_weth_usdc';\n  if (executionRequest.tokenIn === 'REDACTED' && executionRequest.tokenOut === 'WETH') {\n    executionIntent = 'swap_usdc_weth';\n  } else if (executionRequest.tokenIn === 'WETH' && executionRequest.tokenOut === 'REDACTED') {\n    executionIntent = 'swap_weth_usdc';\n  } else if (executionRequest.tokenIn === 'ETH') {\n    // ETH input: will need funding route, use WETH\u2192REDACTED or REDACTED\u2192WETH based on tokenOut\n    executionIntent = executionRequest.tokenOut === 'REDACTED' ? 'swap_weth_usdc' : 'swap_usdc_weth';\n  } else {\n    throw new Error(`Unsupported swap: ${executionRequest.tokenIn} \u2192 ${executionRequest.tokenOut}`);\n  }\n\n  // Convert amountIn to bigint using viem parseUnits (no float math)\n  let amountIn: bigint;\n  if (executionRequest.tokenIn === 'ETH' || executionRequest.tokenIn === 'WETH') {\n    // 18 decimals\n    amountIn = parseUnits(executionRequest.amountIn, 18);\n  } else {\n    // REDACTED: 6 decimals\n    amountIn = parseUnits(executionRequest.amountIn, 6);\n  }\n\n  return {\n    executionIntent,\n    amountIn,\n    tokenIn: tokenInAddr,\n    tokenOut: tokenOutAddr,\n    fundingPolicy: executionRequest.fundingPolicy,\n  };\n}\n\n/**\n * Fetch nonce from ExecutionRouter contract via RPC\n */\nasync function fetchNonceFromChain(userAddress: string): Promise<string> {\n  if (!ETH_TESTNET_RPC_URL) {\n    throw new Error('ETH_TESTNET_RPC_URL is required to fetch nonce');\n  }\n\n  if (!EXECUTION_ROUTER_ADDRESS) {\n    throw new Error('EXECUTION_ROUTER_ADDRESS is required to fetch nonce');\n  }\n\n  // Encode function call: nonces(address)\n  // Function selector: nonces(address) = 0x7ecebe00\n  const functionSelector = '0x7ecebe00';\n  const paddedAddr = padAddress(userAddress);\n  const callData = encodeCall(functionSelector, paddedAddr.slice(2));\n\n  try {\n    const result = await eth_call(ETH_TESTNET_RPC_URL, EXECUTION_ROUTER_ADDRESS, callData);\n    return decodeUint256(result);\n  } catch (error: any) {\n    console.error('[ethTestnetExecutor] Failed to fetch nonce:', error);\n    throw new Error(`Failed to fetch nonce from chain: ${error.message}`);\n  }\n}\n\n/**\n * Prepare ETH testnet execution plan and EIP-712 typed data\n */\nexport async function prepareEthTestnetExecution(\n  args: PrepareEthTestnetExecutionArgs\n): Promise<PrepareEthTestnetExecutionResult> {\n  const { draftId, userAddress, strategy, authMode = 'direct', executionIntent: providedIntent, executionRequest, executionKind = 'default' } = args;\n  \n  // If executionRequest provided, convert to intent\n  let executionIntent: 'mock' | 'swap_usdc_weth' | 'swap_weth_usdc' = providedIntent || 'mock';\n  let fundingPolicy: 'auto' | 'require_tokenIn' = 'require_tokenIn';\n  let requestAmountIn: bigint | undefined;\n  \n  // Demo swap mode: force swap intent\n  const isDemoSwap = executionKind === 'demo_swap' && DEMO_REDACTED_ADDRESS && DEMO_WETH_ADDRESS;\n  if (isDemoSwap && !executionRequest) {\n    // Default to REDACTED \u2192 WETH demo swap\n    executionIntent = 'swap_usdc_weth';\n    fundingPolicy = 'require_tokenIn';\n    requestAmountIn = parseUnits('100', 6); // 100 REDACTED default\n  }\n  \n  // Lending supply mode: detect from executionKind or executionRequest\n  const isLendSupply = executionKind === 'lend_supply' && DEMO_REDACTED_ADDRESS && DEMO_LEND_VAULT_ADDRESS && DEMO_LEND_ADAPTER_ADDRESS;\n  let lendAmount: bigint | undefined;\n  if (isLendSupply && !executionRequest) {\n    // Default to 100 REDACTED lending\n    lendAmount = parseUnits('100', 6);\n    fundingPolicy = 'require_tokenIn';\n  }\n  \n  if (executionRequest && executionRequest.kind === 'swap') {\n    const intentData = executionRequestToIntent(executionRequest);\n    executionIntent = intentData.executionIntent;\n    fundingPolicy = intentData.fundingPolicy;\n    requestAmountIn = intentData.amountIn;\n  }\n  \n  // Also check executionRequest for lending intent\n  // Support both REDACTED (6 decimals) and WETH (18 decimals)\n  let lendAsset: string | undefined;\n  if (executionRequest && executionRequest.kind === 'lend') {\n    const amountStr = executionRequest.amount || '100';\n    lendAsset = (executionRequest as any).asset?.toUpperCase() || 'REDACTED';\n    const lendDecimals = lendAsset === 'WETH' ? 18 : 6;\n    lendAmount = parseUnits(amountStr, lendDecimals);\n    fundingPolicy = 'require_tokenIn';\n  }\n\n  // Validate user address\n  if (!userAddress) {\n    throw new Error('userAddress is required');\n  }\n\n  // Validate address format (basic check)\n  if (!/^0x[a-fA-F0-9]{40}$/.test(userAddress)) {\n    throw new Error(`Invalid userAddress format: ${userAddress}`);\n  }\n\n  // Require ETH testnet config\n  requireEthTestnetConfig();\n\n  if (!EXECUTION_ROUTER_ADDRESS || !MOCK_SWAP_ADAPTER_ADDRESS) {\n    throw new Error('EXECUTION_ROUTER_ADDRESS and MOCK_SWAP_ADAPTER_ADDRESS must be set');\n  }\n\n  // Determine nonce\n  let nonce: string;\n  const warnings: string[] = [];\n\n  if (ETH_TESTNET_RPC_URL) {\n    try {\n      nonce = await fetchNonceFromChain(userAddress);\n      console.log(`[ethTestnetExecutor] Fetched nonce for ${userAddress}: ${nonce}`);\n    } catch (error: any) {\n      console.warn(`[ethTestnetExecutor] Failed to fetch nonce, using 0: ${error.message}`);\n      nonce = '0';\n      warnings.push(\n        `ETH_TESTNET_RPC_URL present but nonce fetch failed: ${error.message}. Using nonce 0 (first tx only).`\n      );\n    }\n  } else {\n    nonce = '0';\n    warnings.push(\n      'ETH_TESTNET_RPC_URL missing; nonce fetch disabled (first tx only). Set ETH_TESTNET_RPC_URL to enable nonce fetching.'\n    );\n  }\n\n  // Set deadline: now + 10 minutes (unix seconds)\n  const deadlineSeconds = Math.floor(Date.now() / 1000) + 10 * 60;\n  const deadline = deadlineSeconds.toString();\n\n  // Debug logging\n  console.log('[ethTestnetExecutor] Building actions with:', {\n    executionKind,\n    executionIntent,\n    hasStrategy: !!strategy,\n    strategyType: strategy?.type,\n    strategyInstrumentType: strategy?.instrumentType,\n    hasPROOF_ADAPTER: !!PROOF_ADAPTER_ADDRESS,\n  });\n\n  // Build actions array based on executionIntent\n  let actions: Array<{\n    actionType: number;\n    adapter: string;\n    data: string;\n  }>;\n  \n  // Track approval requirements (will be added to result later)\n  let approvalRequirements: ApprovalRequirement[] | undefined;\n  \n  // Track if we need to set value > 0 for WRAP action\n  let planValue: string = '0x0';\n\n  // Track routing metadata (for demo swaps) - declared at function scope\n  let routingMetadata: PrepareEthTestnetExecutionResult['routing'] | undefined;\n\n  // Track summary - declared at function scope\n  let summary: string = '';\n\n  // Route 2: Check if funding route is needed (ETH \u2192 WETH \u2192 swap)\n  const needsFundingRoute = executionRequest && \n    executionRequest.kind === 'swap' &&\n    executionRequest.tokenIn === 'ETH' &&\n    fundingPolicy === 'auto' &&\n    WETH_WRAP_ADAPTER_ADDRESS;\n\n  if (needsFundingRoute) {\n    // Compose atomic funding route: WRAP(ETH\u2192WETH) + SWAP(WETH\u2192tokenOut)\n    if (!UNISWAP_V3_ADAPTER_ADDRESS) {\n      throw new Error('UNISWAP_V3_ADAPTER_ADDRESS not configured for funding route');\n    }\n    if (!WETH_ADDRESS_SEPOLIA) {\n      throw new Error('WETH_ADDRESS_SEPOLIA not configured');\n    }\n    if (!REDACTED_ADDRESS_SEPOLIA) {\n      throw new Error('REDACTED_ADDRESS_SEPOLIA not configured');\n    }\n\n    const wrapAmount = requestAmountIn!; // Already validated above\n    \n    // Step 1: WRAP action (ETH \u2192 WETH)\n    // If tokenOut is WETH, wrap directly to user (no swap needed)\n    // If tokenOut is REDACTED, wrap to router so router can swap\n    const { encodeAbiParameters } = await import('viem');\n    const wrapRecipient = executionRequest.tokenOut === 'WETH'\n      ? userAddress.toLowerCase() // Direct to user if final output is WETH\n      : EXECUTION_ROUTER_ADDRESS!.toLowerCase(); // To router if we need to swap\n    \n    const wrapData = encodeAbiParameters(\n      [{ type: 'address' }],\n      [wrapRecipient as `0x${string}`]\n    );\n\n    const wrapAction = {\n      actionType: 1, // WRAP (from PlanTypes.ActionType enum)\n      adapter: WETH_WRAP_ADAPTER_ADDRESS!.toLowerCase(), // Checked above\n      data: wrapData,\n    };\n\n    // Step 2: SWAP action (only if tokenOut is not WETH)\n    if (executionRequest.tokenOut === 'REDACTED') {\n      const tokenOut = REDACTED_ADDRESS_SEPOLIA.toLowerCase();\n      const fee = 3000; // 0.3% fee tier\n      const amountOutMin = 0n; // No slippage protection for MVP\n      const recipient = userAddress.toLowerCase();\n      const swapDeadline = deadlineSeconds;\n\n      const swapInnerData = encodeAbiParameters(\n        [\n          { type: 'address' },\n          { type: 'address' },\n          { type: 'uint24' },\n          { type: 'uint256' },\n          { type: 'uint256' },\n          { type: 'address' },\n          { type: 'uint256' },\n        ],\n        [\n          WETH_ADDRESS_SEPOLIA.toLowerCase() as `0x${string}`,\n          tokenOut as `0x${string}`,\n          fee,\n          wrapAmount, // Use wrapped amount as swap input\n          amountOutMin,\n          recipient as `0x${string}`,\n          BigInt(swapDeadline)\n        ]\n      );\n\n      const swapAction = {\n        actionType: 0, // SWAP\n        adapter: UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase(),\n        data: swapInnerData,\n      };\n\n      // Compose plan: [WRAP, SWAP]\n      actions = [wrapAction, swapAction];\n    } else {\n      // tokenOut is WETH: only wrap needed\n      actions = [wrapAction];\n    }\n    \n    // Set value to wrap amount (user sends ETH with transaction)\n    planValue = '0x' + wrapAmount.toString(16);\n\n    // Check allowance for WETH (router needs to approve adapter for swap)\n    if (ETH_TESTNET_RPC_URL && EXECUTION_ROUTER_ADDRESS) {\n      try {\n        // Note: Router will hold WETH after wrap, so we check router's allowance\n        // But router doesn't exist yet, so we check if user would need to approve\n        // Actually: router will pull WETH from itself (it received from wrap)\n        // So no approval needed from user - router approves adapter internally\n        \n        // For funding route, we still need to check if router can approve adapter\n        // This is handled in ExecutionRouter._executeSwapAction\n        // But we should add approval requirement for router \u2192 adapter\n        // Actually, router handles this internally in _executeSwapAction\n        \n        // Add warning about funding route\n        warnings.push(\n          `FUNDING_ROUTE: Composing atomic route: Wrap ${executionRequest.amountIn} ETH \u2192 WETH, then swap WETH \u2192 ${executionRequest.tokenOut}.`\n        );\n      } catch (error: any) {\n        warnings.push(\n          `Could not verify funding route: ${error.message}. Proceeding anyway.`\n        );\n      }\n    }\n  } else if (executionIntent === 'swap_usdc_weth' || executionIntent === 'swap_weth_usdc') {\n    // Check execution mode: real vs demo\n    const { EXECUTION_SWAP_MODE } = await import('../config');\n    const useRealExecution = EXECUTION_SWAP_MODE === 'real';\n    \n    // Check if this is a demo swap (using demo tokens)\n    // Demo swap is enabled when:\n    // 1. EXECUTION_SWAP_MODE !== 'real', AND\n    // 2. (executionKind === 'demo_swap', OR executionRequest specifies REDACTED/WETH swap with demo tokens configured)\n    const useDemoTokens = !useRealExecution && DEMO_REDACTED_ADDRESS && DEMO_WETH_ADDRESS && (\n      isDemoSwap ||\n      (executionRequest && executionRequest.kind === 'swap' &&\n        ((executionRequest.tokenIn === 'REDACTED' && executionRequest.tokenOut === 'WETH') ||\n         (executionRequest.tokenIn === 'WETH' && executionRequest.tokenOut === 'REDACTED')))\n    );\n\n    // Determine token addresses (demo or real)\n    let tokenIn: string;\n    let tokenOut: string;\n    let swapAdapter: string;\n    let pullAdapter: string | undefined;\n\n    if (useDemoTokens && DEMO_REDACTED_ADDRESS && DEMO_WETH_ADDRESS) {\n      // Use demo tokens and adapters\n      tokenIn = executionIntent === 'swap_usdc_weth' \n        ? DEMO_REDACTED_ADDRESS.toLowerCase()\n        : DEMO_WETH_ADDRESS.toLowerCase();\n      tokenOut = executionIntent === 'swap_usdc_weth'\n        ? DEMO_WETH_ADDRESS.toLowerCase()\n        : DEMO_REDACTED_ADDRESS.toLowerCase();\n      swapAdapter = UNISWAP_ADAPTER_ADDRESS?.toLowerCase() || UNISWAP_V3_ADAPTER_ADDRESS?.toLowerCase() || '';\n      pullAdapter = ERC20_PULL_ADAPTER_ADDRESS?.toLowerCase();\n      \n      if (!swapAdapter) {\n        throw new Error('UNISWAP_ADAPTER_ADDRESS not configured for demo swap');\n      }\n      if (!pullAdapter) {\n        throw new Error('ERC20_PULL_ADAPTER_ADDRESS not configured for demo swap');\n      }\n    } else {\n      // Use real tokens (existing behavior)\n      if (!UNISWAP_V3_ADAPTER_ADDRESS) {\n        throw new Error('UNISWAP_V3_ADAPTER_ADDRESS not configured');\n      }\n      if (!REDACTED_ADDRESS_SEPOLIA) {\n        throw new Error('REDACTED_ADDRESS_SEPOLIA not configured');\n      }\n      if (!WETH_ADDRESS_SEPOLIA) {\n        throw new Error('WETH_ADDRESS_SEPOLIA not configured');\n      }\n\n      tokenIn = executionIntent === 'swap_usdc_weth' \n        ? REDACTED_ADDRESS_SEPOLIA.toLowerCase()\n        : WETH_ADDRESS_SEPOLIA.toLowerCase();\n      tokenOut = executionIntent === 'swap_usdc_weth'\n        ? WETH_ADDRESS_SEPOLIA.toLowerCase()\n        : REDACTED_ADDRESS_SEPOLIA.toLowerCase();\n      swapAdapter = UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase();\n      pullAdapter = undefined; // Real swaps don't use PULL adapter yet\n    }\n\n    // Derive amountIn from executionRequest, strategy, or use default\n    let amountIn: bigint;\n    const decimalsIn = useDemoTokens \n      ? (executionIntent === 'swap_usdc_weth' ? 6 : 18)\n      : (executionIntent === 'swap_usdc_weth' ? 6 : 18);\n    \n    if (requestAmountIn) {\n      // Use amount from executionRequest (already in correct units via parseUnits)\n      amountIn = requestAmountIn;\n    } else if (strategy) {\n      if (strategy.notionalUsd) {\n        // Convert USD to token units using viem parseUnits\n        const usdAmountStr = Math.max(1, Math.round(strategy.notionalUsd)).toString();\n        amountIn = parseUnits(usdAmountStr, decimalsIn);\n      } else if (strategy.depositUsd) {\n        const usdAmountStr = Math.max(1, Math.round(strategy.depositUsd)).toString();\n        amountIn = parseUnits(usdAmountStr, decimalsIn);\n      } else {\n        // Default fallback\n        amountIn = executionIntent === 'swap_usdc_weth' \n          ? parseUnits('100', 6) \n          : parseUnits('0.1', 18);\n      }\n    } else {\n      // Default fallback\n      amountIn = executionIntent === 'swap_usdc_weth' \n        ? parseUnits('100', 6) \n        : parseUnits('0.1', 18);\n    }\n\n    // Get routing decision for metadata (hybrid: 1inch intelligence + demo execution)\n    if (useDemoTokens) {\n      try {\n        // Determine token symbols and decimals\n        const tokenInSymbol = executionIntent === 'swap_usdc_weth' ? 'REDACTED' : 'WETH';\n        const tokenOutSymbol = executionIntent === 'swap_usdc_weth' ? 'WETH' : 'REDACTED';\n        const tokenInDecimals = executionIntent === 'swap_usdc_weth' ? 6 : 18;\n        const tokenOutDecimals = executionIntent === 'swap_usdc_weth' ? 18 : 6;\n\n        const routingDecision = await getSwapRoutingDecision({\n          tokenIn,\n          tokenOut,\n          tokenInSymbol,\n          tokenOutSymbol,\n          tokenInDecimals,\n          tokenOutDecimals,\n          amountIn: amountIn.toString(),\n        });\n\n        routingMetadata = {\n          venue: routingDecision.routeSummary || routingDecision.executionVenue || 'Uniswap V3',\n          chain: 'Sepolia', // Task 4: Always use Sepolia for eth_testnet (not Base/Hyperliquid)\n          expectedOut: routingDecision.expectedOut,\n          expectedOutRaw: routingDecision.expectedOutRaw,\n          minOut: routingDecision.minOut,\n          minOutRaw: routingDecision.minOutRaw,\n          slippageBps: routingDecision.slippageBps,\n          settlementEstimate: routingDecision.settlementEstimate,\n          // Hybrid routing fields\n          routingSource: routingDecision.routingSource,\n          routeSummary: routingDecision.routeSummary,\n          protocols: routingDecision.protocols,\n          estimatedGas: routingDecision.estimatedGas,\n          executionVenue: routingDecision.executionVenue || 'Uniswap V3',\n          executionNote: routingDecision.executionNote,\n          warnings: routingDecision.warnings,\n          // Sprint 3: Truthful routing metadata\n          routing: routingDecision.routing,\n        };\n      } catch (error: any) {\n        console.warn('[ethTestnetExecutor] Failed to get routing decision:', error);\n        // Fall back to basic quote for minOut calculation\n        try {\n          const quote = await getSwapQuote({\n            tokenIn,\n            tokenOut,\n            amountIn: amountIn.toString(),\n            fee: 3000,\n          });\n          if (quote) {\n            routingMetadata = {\n              venue: quote.venueLabel || 'Blossom Demo Router',\n              chain: 'Sepolia', // Task 4: Always use Sepolia for eth_testnet (not Base/Hyperliquid)\n              feeTier: quote.feeTier,\n              expectedOut: quote.expectedOut,\n              minOut: quote.minOut,\n              slippageBps: quote.estSlippageBps,\n              settlementEstimate: quote.settlementEstimate,\n              routingSource: 'deterministic',\n              executionVenue: 'Blossom Demo Router',\n              executionNote: 'Deterministic routing fallback.',\n            };\n          }\n        } catch (quoteError: any) {\n          console.warn('[ethTestnetExecutor] Quote fallback also failed:', quoteError);\n        }\n      }\n    }\n\n    // Build swap parameters\n    const fee = 3000; // 0.3% fee tier\n    const amountOutMin = useDemoTokens && routingMetadata?.minOutRaw\n      ? BigInt(routingMetadata.minOutRaw)\n      : 0n; // Use quote minOut for demo, 0 for real swaps (no slippage protection for MVP)\n    const recipient = userAddress.toLowerCase();\n    const swapDeadline = deadlineSeconds;\n\n    const { encodeAbiParameters } = await import('viem');\n\n    // For demo swaps: build PULL + SWAP actions\n    if (useDemoTokens && pullAdapter) {\n      // Action 0: PULL - transfer tokenIn from user to router\n      const pullInnerData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }],\n        [\n          tokenIn as `0x${string}`,\n          userAddress.toLowerCase() as `0x${string}`,\n          amountIn,\n        ]\n      );\n\n      // Action 1: SWAP - swap tokenIn to tokenOut\n      const swapInnerData = encodeAbiParameters(\n        [\n          { type: 'address' },\n          { type: 'address' },\n          { type: 'uint24' },\n          { type: 'uint256' },\n          { type: 'uint256' },\n          { type: 'address' },\n          { type: 'uint256' },\n        ],\n        [\n          tokenIn as `0x${string}`,\n          tokenOut as `0x${string}`,\n          fee,\n          amountIn,\n          amountOutMin,\n          recipient as `0x${string}`,\n          BigInt(swapDeadline)\n        ]\n      );\n\n      // Wrap actions for session mode if needed\n      let pullActionData: string;\n      let swapActionData: string;\n      let maxSpendUnits: bigint = 1n;\n\n      if (authMode === 'session') {\n        // Derive maxSpendUnits from amountIn\n        maxSpendUnits = amountIn / (100n * 10n**6n) + 1n;\n        \n        pullActionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, pullInnerData]\n        );\n        swapActionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, swapInnerData]\n        );\n      } else {\n        // Direct mode: use raw innerData\n        pullActionData = pullInnerData;\n        swapActionData = swapInnerData;\n      }\n\n      actions = [\n        {\n          actionType: 2, // PULL (from PlanTypes.ActionType enum)\n          adapter: pullAdapter,\n          data: pullActionData,\n        },\n        {\n          actionType: 0, // SWAP\n          adapter: swapAdapter,\n          data: swapActionData,\n        },\n      ];\n    } else if (useRealExecution) {\n      // Real swaps: PULL + SWAP actions (router pulls tokens, then swaps via Uniswap V3)\n      if (!ERC20_PULL_ADAPTER_ADDRESS) {\n        throw new Error('ERC20_PULL_ADAPTER_ADDRESS not configured for real swap execution');\n      }\n\n      // Action 0: PULL - transfer tokenIn from user to router\n      const pullInnerData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }],\n        [\n          tokenIn as `0x${string}`,\n          userAddress.toLowerCase() as `0x${string}`,\n          amountIn,\n        ]\n      );\n\n      // Action 1: SWAP - swap tokenIn to tokenOut via Uniswap V3\n      const swapInnerData = encodeAbiParameters(\n        [\n          { type: 'address' },\n          { type: 'address' },\n          { type: 'uint24' },\n          { type: 'uint256' },\n          { type: 'uint256' },\n          { type: 'address' },\n          { type: 'uint256' },\n        ],\n        [\n          tokenIn as `0x${string}`,\n          tokenOut as `0x${string}`,\n          fee,\n          amountIn,\n          routingMetadata?.minOutRaw ? BigInt(routingMetadata.minOutRaw) : 0n,\n          recipient as `0x${string}`,\n          BigInt(swapDeadline)\n        ]\n      );\n\n      // Wrap actions for session mode if needed\n      let pullActionData: string;\n      let swapActionData: string;\n      let maxSpendUnits: bigint = 1n;\n\n      if (authMode === 'session') {\n        maxSpendUnits = amountIn / (100n * 10n**6n) + 1n;\n        pullActionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, pullInnerData]\n        );\n        swapActionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, swapInnerData]\n        );\n      } else {\n        pullActionData = pullInnerData;\n        swapActionData = swapInnerData;\n      }\n\n      actions = [\n        {\n          actionType: 2, // PULL\n          adapter: ERC20_PULL_ADAPTER_ADDRESS.toLowerCase(),\n          data: pullActionData,\n        },\n        {\n          actionType: 0, // SWAP\n          adapter: swapAdapter,\n          data: swapActionData,\n        },\n      ];\n    } else {\n      // Fallback: single SWAP action (legacy behavior, should not be reached)\n      const innerData = encodeAbiParameters(\n        [\n          { type: 'address' },\n          { type: 'address' },\n          { type: 'uint24' },\n          { type: 'uint256' },\n          { type: 'uint256' },\n          { type: 'address' },\n          { type: 'uint256' },\n        ],\n        [\n          tokenIn as `0x${string}`,\n          tokenOut as `0x${string}`,\n          fee,\n          amountIn,\n          amountOutMin,\n          recipient as `0x${string}`,\n          BigInt(swapDeadline)\n        ]\n      );\n\n      // For session mode, wrap with maxSpendUnits\n      let actionData: string;\n      let maxSpendUnits: bigint = 1n;\n\n      if (authMode === 'session') {\n        maxSpendUnits = amountIn / (100n * 10n**6n) + 1n;\n        actionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, innerData]\n        );\n      } else {\n        actionData = innerData;\n      }\n\n      actions = [\n        {\n          actionType: 0, // SWAP\n          adapter: swapAdapter,\n          data: actionData,\n        },\n      ];\n    }\n\n    // Check balance and allowance for swap intents\n    if (ETH_TESTNET_RPC_URL && EXECUTION_ROUTER_ADDRESS) {\n      try {\n        const balance = await erc20_balanceOf(tokenIn, userAddress);\n        const allowance = await erc20_allowance(\n          tokenIn,\n          userAddress,\n          EXECUTION_ROUTER_ADDRESS\n        );\n\n        // Check balance\n        if (balance < amountIn) {\n          const tokenName = executionIntent === 'swap_usdc_weth' ? 'REDACTED' : 'WETH';\n          warnings.push(\n            `INSUFFICIENT_BALANCE: You need at least ${amountIn.toString()} ${tokenName} to execute this swap. Current balance: ${balance.toString()}`\n          );\n        }\n\n        // Check allowance\n        if (allowance < amountIn) {\n          // Prepare requirement for approval\n          if (!approvalRequirements) {\n            approvalRequirements = [];\n          }\n          approvalRequirements.push({\n            token: tokenIn,\n            spender: EXECUTION_ROUTER_ADDRESS.toLowerCase(),\n            amount: '0x' + amountIn.toString(16), // Convert to hex string\n          });\n        }\n      } catch (error: any) {\n        // If RPC fails, log warning but don't block execution\n        warnings.push(\n          `Could not verify token balance/allowance: ${error.message}. Proceeding anyway.`\n        );\n      }\n    }\n  } else if (isLendSupply || (executionRequest && (executionRequest.kind === 'lend' || executionRequest.kind === 'lend_supply'))) {\n    // Lending supply action: PULL + LEND_SUPPLY\n    // Determine asset to lend (REDACTED or WETH)\n    const requestedAsset = lendAsset || (executionRequest as any)?.asset?.toUpperCase() || 'REDACTED';\n    const isWethLend = requestedAsset === 'WETH';\n    const lendDecimals = isWethLend ? 18 : 6;\n    const amount = lendAmount || parseUnits(isWethLend ? '0.01' : '100', lendDecimals);\n\n    const {\n      AAVE_SEPOLIA_POOL_ADDRESS,\n      AAVE_ADAPTER_ADDRESS,\n      AAVE_REDACTED_ADDRESS,\n      AAVE_WETH_ADDRESS,\n      LENDING_EXECUTION_MODE,\n    } = await import('../config');\n    const { getAaveMarketConfig, getSupportedAsset } = await import('../defi/aave/market');\n\n    // Determine if we should try Aave Sepolia (requires all Aave config variables)\n    const hasAaveConfig = AAVE_SEPOLIA_POOL_ADDRESS && AAVE_ADAPTER_ADDRESS;\n    const useRealAave = LENDING_EXECUTION_MODE === 'real' && hasAaveConfig;\n    let useAaveSepolia = false;\n    let lendingProtocol = 'VaultSim';\n\n    // Start with Aave Sepolia if configured, will fallback to VaultSim on error\n    let asset: string;\n    let vault: string;\n    let lendAdapter: string;\n\n    if (useRealAave) {\n      // Try Aave Sepolia first\n      try {\n        console.log('[ethTestnetExecutor] Attempting Aave Sepolia integration for', requestedAsset);\n        const marketConfig = await getAaveMarketConfig();\n\n        // Select asset based on request\n        if (isWethLend && AAVE_WETH_ADDRESS) {\n          // Use WETH for lending\n          asset = AAVE_WETH_ADDRESS.toLowerCase();\n          vault = marketConfig.poolAddress.toLowerCase();\n          lendAdapter = AAVE_ADAPTER_ADDRESS!.toLowerCase();\n          useAaveSepolia = true;\n          lendingProtocol = 'Aave V3';\n          console.log('[ethTestnetExecutor] Using Aave Sepolia WETH:', { vault, lendAdapter, asset });\n        } else {\n          // Use REDACTED for lending\n          let usdcAsset = await getSupportedAsset('REDACTED');\n\n          // Override with AAVE_REDACTED_ADDRESS if configured\n          if (AAVE_REDACTED_ADDRESS && AAVE_REDACTED_ADDRESS !== DEMO_REDACTED_ADDRESS) {\n            usdcAsset = {\n              symbol: 'REDACTED',\n              address: AAVE_REDACTED_ADDRESS.toLowerCase() as Address,\n              aTokenAddress: '0x0000000000000000000000000000000000000000' as Address,\n              decimals: 6,\n            };\n          }\n\n          if (usdcAsset) {\n            asset = usdcAsset.address.toLowerCase();\n            vault = marketConfig.poolAddress.toLowerCase();\n            lendAdapter = AAVE_ADAPTER_ADDRESS!.toLowerCase();\n            useAaveSepolia = true;\n            lendingProtocol = 'Aave V3';\n            console.log('[ethTestnetExecutor] Using Aave Sepolia REDACTED:', { vault, lendAdapter, asset });\n          } else {\n            throw new Error('REDACTED not found in Aave market config');\n          }\n        }\n      } catch (error: any) {\n        console.warn('[ethTestnetExecutor] Aave Sepolia config invalid, falling back to VaultSim:', error.message);\n        warnings.push('Aave Sepolia unavailable, using VaultSim fallback');\n      }\n    }\n\n    // Fallback to VaultSim if Aave not configured or failed\n    if (!useAaveSepolia) {\n      console.log('[ethTestnetExecutor] Using VaultSim fallback for lending');\n      asset = DEMO_REDACTED_ADDRESS!.toLowerCase();\n      vault = DEMO_LEND_VAULT_ADDRESS!.toLowerCase();\n      lendAdapter = DEMO_LEND_ADAPTER_ADDRESS!.toLowerCase();\n      lendingProtocol = 'VaultSim';\n    }\n\n    const pullAdapter = ERC20_PULL_ADAPTER_ADDRESS!.toLowerCase();\n\n    // Get lending routing decision\n    let lendingRouting: LendingRoutingDecision | undefined;\n    try {\n      lendingRouting = await getLendingRoutingDecision({\n        asset,\n        amount: amount.toString(),\n        vaultAddress: vault,\n      });\n      routingMetadata = {\n        venue: `Supply ${requestedAsset} to ${lendingRouting.protocol}`,\n        chain: lendingRouting.chain,\n        settlementEstimate: lendingRouting.settlementEstimate,\n        routingSource: lendingRouting.routingSource,\n        executionVenue: lendingRouting.executionVenue,\n        executionNote: lendingRouting.executionNote,\n        warnings: lendingRouting.warnings,\n        apr: lendingRouting.apr,\n        aprBps: lendingRouting.aprBps,\n        vault: lendingRouting.vault,\n        actionType: 'lend_supply',\n      };\n    } catch (error: any) {\n      console.warn('[ethTestnetExecutor] Failed to get lending routing:', error);\n      warnings.push(`Lending routing failed: ${error.message}`);\n    }\n\n    const { encodeAbiParameters } = await import('viem');\n\n    if (authMode === 'session') {\n      // Session mode: wrap data with maxSpendUnits\n      const pullInnerData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }],\n        [asset as `0x${string}`, userAddress.toLowerCase() as `0x${string}`, amount]\n      );\n      const pullData = encodeAbiParameters(\n        [{ type: 'uint256' }, { type: 'bytes' }],\n        [0n, pullInnerData]\n      );\n\n      const lendInnerData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }, { type: 'address' }],\n        [asset as `0x${string}`, vault as `0x${string}`, amount, userAddress.toLowerCase() as `0x${string}`]\n      );\n      const lendData = encodeAbiParameters(\n        [{ type: 'uint256' }, { type: 'bytes' }],\n        [0n, lendInnerData]\n      );\n\n      actions = [\n        {\n          actionType: 2, // PULL\n          adapter: pullAdapter,\n          data: pullData,\n        },\n        {\n          actionType: 3, // LEND_SUPPLY\n          adapter: lendAdapter,\n          data: lendData,\n        },\n      ];\n    } else {\n      // Direct mode: use raw data\n      const pullData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }],\n        [asset as `0x${string}`, userAddress.toLowerCase() as `0x${string}`, amount]\n      );\n\n      const lendData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }, { type: 'address' }],\n        [asset as `0x${string}`, vault as `0x${string}`, amount, userAddress.toLowerCase() as `0x${string}`]\n      );\n\n      actions = [\n        {\n          actionType: 2, // PULL\n          adapter: pullAdapter,\n          data: pullData,\n        },\n        {\n          actionType: 3, // LEND_SUPPLY\n          adapter: lendAdapter,\n          data: lendData,\n        },\n      ];\n    }\n\n    const amountDisplay = (Number(amount) / 1e6).toFixed(2);\n    summary = `Supply ${amountDisplay} REDACTED to ${lendingRouting?.protocol || lendingProtocol} (Est APR: ${lendingRouting?.apr || '5.00'}%)`;\n\n    // Check approval requirements\n    if (ETH_TESTNET_RPC_URL) {\n      try {\n        const allowance = await erc20_allowance(asset, userAddress, EXECUTION_ROUTER_ADDRESS);\n        if (allowance < amount) {\n          if (!approvalRequirements) {\n            approvalRequirements = [];\n          }\n          approvalRequirements.push({\n            token: asset,\n            spender: EXECUTION_ROUTER_ADDRESS.toLowerCase(),\n            amount: '0x' + amount.toString(16),\n          });\n        }\n      } catch (error: any) {\n        warnings.push(`Could not verify lending approval: ${error.message}. Proceeding anyway.`);\n      }\n    }\n  } else {\n    // Check if strategy is perp or event for proof-of-execution\n    // Also check executionRequest for perp/event intents\n    const isPerpStrategy = strategy?.instrumentType === 'perp' || executionKind === 'perp' || \n                          (executionRequest && executionRequest.kind === 'perp');\n    const isEventStrategy = strategy?.instrumentType === 'event' || executionKind === 'event';\n    \n    if ((isPerpStrategy || isEventStrategy) && PROOF_ADAPTER_ADDRESS) {\n      // Build proof-of-execution action for perps or events\n      const { encodeAbiParameters, keccak256, toBytes, stringToBytes } = await import('viem');\n      \n      // Determine venue type: 1 = perps, 2 = event\n      const venueType = isPerpStrategy ? 1 : 2;\n      \n      // Build canonical intent payload for hashing\n      let intentPayload: string;\n      let summaryText: string;\n      \n      if (isPerpStrategy) {\n        // Perp intent: market, side, leverage, riskPercent, marginUsd/notionalUsd\n        const market = strategy?.market || 'ETH-USD';\n        const side = strategy?.direction || 'long';\n        const leverage = strategy?.leverage || 1;\n        const riskPct = strategy?.riskPercent || 3;\n        const marginUsd = strategy?.marginUsd || strategy?.notionalUsd || 100;\n        const tp = strategy?.takeProfitPrice || '';\n        const sl = strategy?.stopLossPrice || '';\n        \n        intentPayload = JSON.stringify({\n          type: 'perp',\n          market,\n          side,\n          leverage,\n          riskPct,\n          marginUsd,\n          tp,\n          sl,\n          timestamp: Math.floor(Date.now() / 1000),\n        });\n        summaryText = `PERP:${market}-${side.toUpperCase()}-${leverage}x-${riskPct}%`;\n        summary = `${side.toUpperCase()} ${market} @ ${leverage}x leverage (${riskPct}% risk)`;\n        \n        routingMetadata = {\n          venue: `Perps: ${market}`,\n          chain: 'Sepolia',\n          settlementEstimate: '~1 block',\n          routingSource: 'proof',\n          executionVenue: 'On-chain proof (venue execution simulated)',\n          executionNote: 'Proof-of-execution recorded. Real perp execution coming soon.',\n          actionType: 'perp',\n          venueType,\n        } as any;\n      } else {\n        // Event intent: marketId, outcome, stakeUsd\n        // Get from executionRequest if available, else from strategy\n        const marketId = (executionRequest && executionRequest.kind === 'event')\n          ? executionRequest.marketId\n          : (strategy?.market || 'fed-rate-cut');\n        const outcome = (executionRequest && executionRequest.kind === 'event')\n          ? executionRequest.outcome\n          : (strategy?.outcome || strategy?.direction || 'YES');\n        const stakeUsd = (executionRequest && executionRequest.kind === 'event')\n          ? executionRequest.stakeUsd\n          : (strategy?.stakeUsd || 5);\n        const price = (executionRequest && executionRequest.kind === 'event')\n          ? executionRequest.price\n          : undefined;\n        \n        intentPayload = JSON.stringify({\n          type: 'event',\n          marketId,\n          outcome,\n          stakeUsd,\n          price,\n          timestamp: Math.floor(Date.now() / 1000),\n        });\n        summaryText = `EVENT:${marketId}-${outcome}-${stakeUsd}USD`;\n        summary = `${outcome} on ${marketId} ($${stakeUsd} stake)`;\n        \n        routingMetadata = {\n          venue: `Event: ${marketId}`,\n          chain: 'Sepolia',\n          settlementEstimate: '~1 block',\n          routingSource: 'proof',\n          executionVenue: 'On-chain proof (venue execution simulated)',\n          executionNote: 'Proof-of-execution recorded. Real event market execution coming soon.',\n          actionType: 'event',\n          venueType,\n        } as any;\n      }\n      \n      // Hash the intent\n      const intentHash = keccak256(stringToBytes(intentPayload));\n      \n      // Truncate summary if needed\n      const finalSummary = summaryText.slice(0, 160);\n      \n      // Build proof action data\n      const proofInnerData = encodeAbiParameters(\n        [{ type: 'address' }, { type: 'uint8' }, { type: 'bytes32' }, { type: 'string' }],\n        [userAddress.toLowerCase() as `0x${string}`, venueType, intentHash, finalSummary]\n      );\n      \n      // Wrap for session mode if needed\n      let proofData: string;\n      if (authMode === 'session') {\n        proofData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [0n, proofInnerData]\n        );\n      } else {\n        proofData = proofInnerData;\n      }\n      \n      actions = [\n        {\n          actionType: 6, // PROOF (from PlanTypes.ActionType enum)\n          adapter: PROOF_ADAPTER_ADDRESS.toLowerCase(),\n          data: proofData,\n        },\n      ];\n    } else {\n      // Mock action (existing behavior - fallback)\n      let actionData: string;\n      let maxSpendUnits: bigint = 1n; // Default\n\n      if (strategy) {\n        // Derive maxSpendUnits from strategy if available\n        if (strategy.notionalUsd) {\n          maxSpendUnits = BigInt(Math.max(1, Math.round(strategy.notionalUsd)));\n        } else if (strategy.depositUsd) {\n          maxSpendUnits = BigInt(Math.max(1, Math.round(strategy.depositUsd)));\n        } else if (strategy.stakeUsd) {\n          maxSpendUnits = BigInt(Math.max(1, Math.round(strategy.stakeUsd)));\n        }\n      }\n\n      if (authMode === 'session') {\n        // Wrap as (maxSpendUnits, innerData) for session mode\n        const { encodeAbiParameters } = await import('viem');\n        const innerData = '0x'; // Empty for mock adapter\n        actionData = encodeAbiParameters(\n          [{ type: 'uint256' }, { type: 'bytes' }],\n          [maxSpendUnits, innerData]\n        );\n      } else {\n        // Direct mode: use raw data\n        actionData = '0x';\n      }\n\n      actions = [\n        {\n          actionType: 0, // SWAP (from PlanTypes.ActionType enum)\n          adapter: MOCK_SWAP_ADAPTER_ADDRESS!.toLowerCase(),\n          data: actionData,\n        },\n      ];\n    }\n  }\n\n  // Build plan\n  // Debug: log actions before building plan\n  console.log('[ethTestnetExecutor] Actions built:', JSON.stringify(actions.map(a => ({\n    actionType: a.actionType,\n    adapter: a.adapter?.substring(0, 10) + '...',\n    dataLength: a.data?.length || 0\n  })), null, 2));\n\n  const plan = {\n    user: userAddress.toLowerCase(),\n    nonce,\n    deadline,\n    actions,\n  };\n\n  // Build EIP-712 typed data (optional/informational for future use)\n  const typedData = {\n    domain: {\n      name: 'BlossomExecutionRouter',\n      version: '1',\n      chainId: ETH_TESTNET_CHAIN_ID,\n      verifyingContract: EXECUTION_ROUTER_ADDRESS.toLowerCase(),\n    },\n    types: {\n      EIP712Domain: [\n        { name: 'name', type: 'string' },\n        { name: 'version', type: 'string' },\n        { name: 'chainId', type: 'uint256' },\n        { name: 'verifyingContract', type: 'address' },\n      ],\n      Action: [\n        { name: 'actionType', type: 'uint8' },\n        { name: 'adapter', type: 'address' },\n        { name: 'data', type: 'bytes' },\n      ],\n      Plan: [\n        { name: 'user', type: 'address' },\n        { name: 'nonce', type: 'uint256' },\n        { name: 'deadline', type: 'uint256' },\n        { name: 'actions', type: 'Action[]' },\n      ],\n    },\n    primaryType: 'Plan',\n    message: plan,\n  };\n\n  // Build summary (only if not already set by a specific action handler)\n  if (!summary) {\n    if (needsFundingRoute && actions.length > 1) {\n      summary = `Execute atomic funding route on Sepolia: ${actions.length} actions (WRAP + SWAP). Nonce: ${nonce}, Deadline: ${new Date(deadlineSeconds * 1000).toISOString()}`;\n    } else {\n      const adapterName = executionIntent === 'swap_usdc_weth' || executionIntent === 'swap_weth_usdc'\n        ? 'UniswapV3SwapAdapter'\n        : 'MockSwapAdapter';\n      summary = `Execute plan on Sepolia: ${actions.length} action(s) via ${adapterName} (${executionIntent}). Nonce: ${nonce}, Deadline: ${new Date(deadlineSeconds * 1000).toISOString()}`;\n    }\n  }\n\n  // Generate static net exposure string (no math, no refactors)\n  // This is a placeholder - actual portfolio state would come from execution result\n  // For now, generate a simple string based on action types\n  const netExposureParts: string[] = [];\n  if (actions.some(a => a.actionType === 0)) { // SWAP\n    netExposureParts.push('Swap executed');\n  }\n  if (actions.some(a => a.actionType === 3)) { // LEND_SUPPLY\n    netExposureParts.push('Yield position added');\n  }\n  if (executionKind === 'perp' || executionRequest?.kind === 'perp') {\n    netExposureParts.push('Perp delta +2%');\n  }\n  if (executionKind === 'event' || executionRequest?.kind === 'event') {\n    netExposureParts.push('Event position added');\n  }\n  const netExposure = netExposureParts.length > 0 ? `Net: ${netExposureParts.join(', ')}` : 'Net: Neutral';\n\n  // V1: Compute planHash server-side (keccak256(abi.encode(plan)))\n  const { keccak256, encodeAbiParameters } = await import('viem');\n  const planHash = keccak256(\n    encodeAbiParameters(\n      [\n        { type: 'address' }, // user\n        { type: 'uint256' }, // nonce\n        { type: 'uint256' }, // deadline\n        {\n          type: 'tuple[]', // actions\n          components: [\n            { type: 'uint8' }, // actionType\n            { type: 'address' }, // adapter\n            { type: 'bytes' }, // data\n          ],\n        },\n      ],\n      [\n        plan.user as `0x${string}`,\n        BigInt(plan.nonce),\n        BigInt(plan.deadline),\n        plan.actions.map((a: any) => [\n          a.actionType,\n          a.adapter as `0x${string}`,\n          a.data as `0x${string}`,\n        ]),\n      ]\n    )\n  );\n\n  // Initialize result object\n  const result: PrepareEthTestnetExecutionResult & { planHash?: string } = {\n    chainId: ETH_TESTNET_CHAIN_ID,\n    to: EXECUTION_ROUTER_ADDRESS.toLowerCase(),\n    value: planValue, // May be > 0 if WRAP action included\n    plan,\n    planHash, // V1: Include server-computed planHash\n    typedData, // Optional/informational for future use\n    call: {\n      method: 'executeBySender' as const,\n      args: {\n        plan,\n      },\n    },\n    // Add requirements if approval is needed\n    ...(approvalRequirements && approvalRequirements.length > 0\n      ? { requirements: { approvals: approvalRequirements } }\n      : {}\n    ),\n    summary,\n    warnings: warnings.length > 0 ? warnings : undefined,\n    // Add routing metadata if available (for demo swaps)\n    // Sprint 3.1: Normalized routing metadata at top level\n    ...(routingMetadata ? { \n      routing: {\n        ...routingMetadata,\n        // Ensure normalized routing metadata is accessible at top level\n        routing: routingMetadata.routing || {\n          source: 'fallback',\n          kind: 'swap_quote',\n          ok: false,\n          reason: 'Routing metadata missing from routingDecision',\n          latencyMs: 0,\n          mode: process.env.ROUTING_MODE || 'hybrid',\n          correlationId: makeCorrelationId('executor'),\n        },\n      }\n    } : {\n      // Always include routing metadata, even if routingMetadata is undefined\n        routing: {\n          venue: 'Unknown',\n          chain: 'Sepolia',\n          routingSource: 'fallback',\n          routing: {\n            source: 'fallback',\n            kind: 'swap_quote',\n            ok: false,\n            reason: 'No routing metadata available',\n            latencyMs: 0,\n            mode: process.env.ROUTING_MODE || 'hybrid',\n            correlationId: makeCorrelationId('executor'),\n          },\n        },\n    }),\n    netExposure, // Static string, no new state\n  };\n\n  // Log preparation\n  console.log('[ethTestnetExecutor] Prepared execution plan:', {\n    draftId,\n    userAddress,\n    nonce,\n    deadline: new Date(deadlineSeconds * 1000).toISOString(),\n    routerAddress: EXECUTION_ROUTER_ADDRESS,\n    actionCount: actions.length,\n    method: 'executeBySender',\n    requirements: result.requirements,\n  });\n\n  // Task 1: DEBUG_EXECUTION logging\n  if (process.env.DEBUG_EXECUTION === 'true' || process.env.DEBUG_DEMO === 'true') {\n    const { encodeFunctionData } = await import('viem');\n    const executeBySenderAbi = [\n      {\n        name: 'executeBySender',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          {\n            name: 'plan',\n            type: 'tuple',\n            components: [\n              { name: 'user', type: 'address' },\n              { name: 'nonce', type: 'uint256' },\n              { name: 'deadline', type: 'uint256' },\n              {\n                name: 'actions',\n                type: 'tuple[]',\n                components: [\n                  { name: 'actionType', type: 'uint8' },\n                  { name: 'adapter', type: 'address' },\n                  { name: 'data', type: 'bytes' },\n                ],\n              },\n            ],\n          },\n        ],\n        outputs: [],\n      },\n    ] as const;\n    \n    const encodedData = encodeFunctionData({\n      abi: executeBySenderAbi,\n      functionName: 'executeBySender',\n      args: [plan],\n    });\n    \n    console.log('[ethTestnetExecutor] DEBUG_EXECUTION:', {\n      chainId: ETH_TESTNET_CHAIN_ID,\n      to: EXECUTION_ROUTER_ADDRESS,\n      value: planValue,\n      dataLength: encodedData.length,\n      dataBytes: encodedData.length / 2 - 1, // Subtract '0x' prefix\n      routerAddress: EXECUTION_ROUTER_ADDRESS,\n      adapterAddresses: actions.map(a => a.adapter),\n      actionTypes: actions.map(a => a.actionType),\n      routingMetadata: routingMetadata ? {\n        venue: routingMetadata.venue,\n        chain: routingMetadata.chain,\n        executionVenue: routingMetadata.executionVenue,\n      } : null,\n    });\n  }\n\n  // Task 3: Static call check before returning tx (if DEBUG_EXECUTION enabled)\n  if ((process.env.DEBUG_EXECUTION === 'true' || process.env.DEBUG_DEMO === 'true') && ETH_TESTNET_RPC_URL) {\n    try {\n      const { createPublicClient, http } = await import('viem');\n      const { sepolia } = await import('viem/chains');\n      const publicClient = createPublicClient({\n        chain: sepolia,\n        transport: http(ETH_TESTNET_RPC_URL),\n      });\n      \n      const { encodeFunctionData } = await import('viem');\n      const executeBySenderAbi = [\n        {\n          name: 'executeBySender',\n          type: 'function',\n          stateMutability: 'nonpayable',\n          inputs: [\n            {\n              name: 'plan',\n              type: 'tuple',\n              components: [\n                { name: 'user', type: 'address' },\n                { name: 'nonce', type: 'uint256' },\n                { name: 'deadline', type: 'uint256' },\n                {\n                  name: 'actions',\n                  type: 'tuple[]',\n                  components: [\n                    { name: 'actionType', type: 'uint8' },\n                    { name: 'adapter', type: 'address' },\n                    { name: 'data', type: 'bytes' },\n                  ],\n                },\n              ],\n            },\n          ],\n          outputs: [],\n        },\n      ] as const;\n      \n      const encodedData = encodeFunctionData({\n        abi: executeBySenderAbi,\n        functionName: 'executeBySender',\n        args: [plan],\n      });\n      \n      // Try static call to check for reverts\n      await publicClient.call({\n        to: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n        data: encodedData as `0x${string}`,\n        value: BigInt(planValue),\n      });\n      \n      console.log('[ethTestnetExecutor] Static call check: SUCCESS (tx should not revert)');\n    } catch (error: any) {\n      console.error('[ethTestnetExecutor] Static call check: FAILED (tx will likely revert):', error.message);\n      // Don't throw - let the frontend handle it, but log the revert reason\n    }\n  }\n\n  return result;\n}\n\n", "// @ts-nocheck\n/**\n * Session Authority Policy\n * Server-side enforcement for relayed execution\n */\n\nimport { parseUnits } from 'viem';\n\nexport interface SessionPolicyResult {\n  allowed: boolean;\n  code?: string;\n  message?: string;\n  details?: any;\n}\n\nexport interface SessionStatus {\n  active: boolean;\n  owner: string;\n  executor: string;\n  expiresAt: bigint;\n  maxSpend: bigint;\n  spent: bigint;\n  status: 'active' | 'expired' | 'revoked' | 'not_created';\n}\n\nexport interface PlanSpendEstimate {\n  spendWei: bigint;\n  spendUsd?: number;\n  determinable: boolean;\n  instrumentType?: 'swap' | 'perp' | 'defi' | 'event';\n}\n\n/**\n * Estimate spend from plan actions (best effort)\n * Returns spend in wei and whether it could be determined\n */\nexport async function estimatePlanSpend(plan: {\n  actions: Array<{ actionType: number; adapter: string; data: string }>;\n  value?: string;\n}): Promise<PlanSpendEstimate> {\n  let totalSpendWei = BigInt(plan.value || '0x0');\n  let determinable = true;\n  let instrumentType: 'swap' | 'perp' | 'defi' | 'event' | undefined;\n\n  // Decode actions to estimate spend\n  const { decodeAbiParameters } = await import('viem');\n\n  for (const action of plan.actions) {\n    try {\n      if (action.actionType === 0) {\n        // SWAP action\n        instrumentType = 'swap';\n        try {\n          // Try to decode as direct swap (tokenIn, tokenOut, fee, amountIn, ...)\n          const decoded = decodeAbiParameters(\n            [\n              { type: 'address' },\n              { type: 'address' },\n              { type: 'uint24' },\n              { type: 'uint256' },\n              { type: 'uint256' },\n              { type: 'address' },\n              { type: 'uint256' },\n            ],\n            action.data as `0x${string}`\n          );\n          const amountIn = decoded[3];\n          // For swaps, spend is the amountIn (in token units, not ETH)\n          // We can't convert to USD without price oracle, so mark as determinable but don't add to totalSpendWei\n          // For now, we'll use a conservative estimate: assume 1 ETH max per swap\n          totalSpendWei += BigInt(parseUnits('1', 18)); // Conservative: 1 ETH per swap\n        } catch {\n          // Session mode: wrapped as (maxSpendUnits, innerData)\n          try {\n            const decoded = decodeAbiParameters(\n              [{ type: 'uint256' }, { type: 'bytes' }],\n              action.data as `0x${string}`\n            );\n            const maxSpendUnits = decoded[0];\n            // maxSpendUnits is in token units (e.g., REDACTED has 6 decimals)\n            // Convert to wei-equivalent for comparison (rough estimate: 1 unit = 1e-12 ETH)\n            // Actually, for policy, we should compare against session's maxSpend which is in wei\n            // So we'll use maxSpendUnits directly as a conservative estimate\n            totalSpendWei += maxSpendUnits * BigInt(1e12); // Rough conversion (assumes 6-decimal token)\n          } catch {\n            determinable = false;\n          }\n        }\n      } else if (action.actionType === 2) {\n        // PULL action (token transfer)\n        try {\n          const decoded = decodeAbiParameters(\n            [{ type: 'address' }, { type: 'address' }, { type: 'uint256' }],\n            action.data as `0x${string}`\n          );\n          const amount = decoded[2];\n          // PULL doesn't spend ETH, but transfers tokens\n          // For policy, we'll count it conservatively\n          totalSpendWei += amount * BigInt(1e12); // Rough conversion\n        } catch {\n          determinable = false;\n        }\n      } else if (action.actionType === 3) {\n        // LEND_SUPPLY action (Aave supply)\n        instrumentType = 'defi';\n        try {\n          // Try to decode as direct supply (asset, vault, amount, onBehalfOf)\n          const decoded = decodeAbiParameters(\n            [\n              { type: 'address' },\n              { type: 'address' },\n              { type: 'uint256' },\n              { type: 'address' },\n            ],\n            action.data as `0x${string}`\n          );\n          const amount = decoded[2];\n          // For Aave supply, spend is the amount supplied (in token units)\n          // Convert to wei-equivalent for policy comparison\n          // Assume 6 decimals for REDACTED (most common)\n          totalSpendWei += amount * BigInt(1e12); // Convert 6-decimal token to wei-equivalent\n        } catch {\n          // Session mode: wrapped as (maxSpendUnits, innerData)\n          try {\n            const decoded = decodeAbiParameters(\n              [{ type: 'uint256' }, { type: 'bytes' }],\n              action.data as `0x${string}`\n            );\n            const maxSpendUnits = decoded[0];\n            // maxSpendUnits is in token units (e.g., REDACTED has 6 decimals)\n            totalSpendWei += maxSpendUnits * BigInt(1e12); // Rough conversion (assumes 6-decimal token)\n          } catch {\n            determinable = false;\n          }\n        }\n      } else if (action.actionType === 6) {\n        // PROOF action (perps/events)\n        instrumentType = 'perp'; // Default to perp, could be event\n        // PROOF actions don't spend tokens directly, they're proof-of-execution\n        // For policy, we'll use a conservative estimate\n        totalSpendWei += BigInt(parseUnits('0.1', 18)); // Conservative: 0.1 ETH equivalent\n      } else {\n        // Unknown action type\n        determinable = false;\n      }\n    } catch (error) {\n      determinable = false;\n    }\n  }\n\n  return {\n    spendWei: totalSpendWei,\n    determinable,\n    instrumentType,\n  };\n}\n\n/**\n * Evaluate SessionPolicy for a relayed execution\n */\nexport async function evaluateSessionPolicy(\n  sessionId: string,\n  userAddress: string,\n  plan: {\n    actions: Array<{ actionType: number; adapter: string; data: string }>;\n    value?: string;\n  },\n  allowedAdapters: Set<string>,\n  getSessionStatus: (sessionId: string) => Promise<SessionStatus | null>,\n  policyOverride?: { maxSpendUnits?: string; skipSessionCheck?: boolean } // DEV-ONLY override for testing\n): Promise<SessionPolicyResult> {\n  // Check 1: Session must exist and be active\n  // DEV-ONLY: Allow skipping session check in validateOnly mode for testing\n  let sessionStatus: SessionStatus | null;\n  \n  if (policyOverride?.skipSessionCheck && (process.env.NODE_ENV !== 'production' || process.env.DEV === 'true')) {\n    // Create a mock active session for testing\n    sessionStatus = {\n      active: true,\n      owner: userAddress,\n      executor: userAddress,\n      expiresAt: BigInt(Math.floor(Date.now() / 1000) + 86400), // 1 day from now\n      maxSpend: policyOverride.maxSpendUnits ? BigInt(policyOverride.maxSpendUnits) : BigInt('10000000000000000000'), // 10 ETH default\n      spent: 0n,\n      status: 'active',\n    };\n  } else {\n    sessionStatus = await getSessionStatus(sessionId);\n    if (!sessionStatus) {\n      return {\n        allowed: false,\n        code: 'SESSION_NOT_ACTIVE',\n        message: 'Session not found or not active',\n        details: { sessionId: sessionId.substring(0, 10) + '...' },\n      };\n    }\n\n    if (sessionStatus.status !== 'active') {\n      return {\n        allowed: false,\n        code: 'SESSION_EXPIRED_OR_REVOKED',\n        message: `Session is ${sessionStatus.status}`,\n        details: {\n          status: sessionStatus.status,\n          expiresAt: sessionStatus.expiresAt.toString(),\n          now: BigInt(Math.floor(Date.now() / 1000)).toString(),\n        },\n      };\n    }\n  }\n\n  // Check 2: Adapter must be allowlisted (already checked in relayed endpoint, but verify here too)\n  for (const action of plan.actions) {\n    const adapter = action.adapter?.toLowerCase();\n    if (!adapter || !allowedAdapters.has(adapter)) {\n      return {\n        allowed: false,\n        code: 'ADAPTER_NOT_ALLOWED',\n        message: `Adapter ${adapter} not in allowlist`,\n        details: {\n          adapter,\n          allowedAdapters: Array.from(allowedAdapters),\n        },\n      };\n    }\n  }\n\n  // Check 3: Spend limits\n  const spendEstimate = await estimatePlanSpend(plan);\n  \n  if (!spendEstimate.determinable) {\n    return {\n      allowed: false,\n      code: 'POLICY_UNDETERMINED_SPEND',\n      message: 'Cannot determine plan spend from actions. Policy cannot be evaluated.',\n      details: {\n        actionCount: plan.actions.length,\n        actionTypes: plan.actions.map(a => a.actionType),\n      },\n    };\n  }\n\n  // Check if spend exceeds session's maxSpend\n  // DEV-ONLY: Allow policyOverride for testing (only in validateOnly mode, checked by caller)\n  let effectiveMaxSpend: bigint;\n  let effectiveSpent: bigint;\n  \n  if (policyOverride?.maxSpendUnits && (process.env.NODE_ENV !== 'production' || import.meta.env?.DEV)) {\n    // Use override: treat maxSpendUnits as the effective max spend limit\n    effectiveMaxSpend = BigInt(policyOverride.maxSpendUnits);\n    effectiveSpent = 0n; // Assume nothing spent yet for override\n  } else {\n    // Normal path: use on-chain session values\n    effectiveMaxSpend = sessionStatus.maxSpend;\n    effectiveSpent = sessionStatus.spent;\n  }\n  \n  const remainingSpend = effectiveMaxSpend - effectiveSpent;\n  if (spendEstimate.spendWei > remainingSpend) {\n    return {\n      allowed: false,\n      code: 'POLICY_EXCEEDED',\n      message: `Plan spend (${spendEstimate.spendWei.toString()}) exceeds remaining session spend limit (${remainingSpend.toString()})`,\n      details: {\n        spendAttempted: spendEstimate.spendWei.toString(),\n        maxSpend: effectiveMaxSpend.toString(),\n        spent: effectiveSpent.toString(),\n        remaining: remainingSpend.toString(),\n        ...(policyOverride?.maxSpendUnits ? { policyOverride: true } : {}),\n      },\n    };\n  }\n\n  // All checks passed\n  return {\n    allowed: true,\n  };\n}\n", "/**\n * Relayer\n * Sends transactions on behalf of users using session permissions\n */\n\nimport { RELAYER_PRIVATE_KEY, ETH_TESTNET_RPC_URL, requireRelayerConfig } from '../config';\nimport { createWalletClient, http, parseEther } from 'viem';\nimport { privateKeyToAccount } from 'viem/accounts';\nimport { sepolia } from 'viem/chains';\n\n/**\n * Send a relayed transaction using the relayer's private key\n * @param to Contract address\n * @param data Encoded function call data\n * @param value ETH value (default: 0)\n * @returns Transaction hash\n */\nexport async function sendRelayedTx({\n  to,\n  data,\n  value = '0x0',\n}: {\n  to: string;\n  data: string;\n  value?: string;\n}): Promise<string> {\n  requireRelayerConfig();\n\n  if (!RELAYER_PRIVATE_KEY) {\n    throw new Error('RELAYER_PRIVATE_KEY is required for relayed execution');\n  }\n\n  if (!ETH_TESTNET_RPC_URL) {\n    throw new Error('ETH_TESTNET_RPC_URL is required for relayed execution');\n  }\n\n  // Debug: log parameters\n  console.log('[relayer] sendRelayedTx params:', {\n    to: to?.slice(0, 10) + '...',\n    dataLen: data?.length,\n    value,\n    valueType: typeof value,\n  });\n\n  try {\n    // Create wallet client with relayer's account\n    const account = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n    \n    const client = createWalletClient({\n      account,\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    // Task C: Estimate gas before sending (prevent \"gas limit too high\" errors)\n    const { createPublicClient } = await import('viem');\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    let gasLimit: bigint;\n    try {\n      const estimatedGas = await publicClient.estimateGas({\n        to: to as `0x${string}`,\n        data: data as `0x${string}`,\n        value: BigInt(value),\n        account,\n      });\n      // Apply 1.2x multiplier and clamp to 12M (safe for Sepolia, well below 16M cap)\n      const maxGasLimit = BigInt(12_000_000);\n      gasLimit = estimatedGas * BigInt(120) / BigInt(100);\n      if (gasLimit > maxGasLimit) {\n        gasLimit = maxGasLimit;\n      }\n      \n      if (process.env.DEBUG_DEMO === 'true') {\n        console.log('[relayer] Gas estimation:', {\n          estimated: estimatedGas.toString(),\n          withMultiplier: gasLimit.toString(),\n          clamped: gasLimit === maxGasLimit,\n        });\n      }\n    } catch (error: any) {\n      // Estimation failed - this usually means the tx will revert\n      console.error('[relayer] Gas estimation failed:', error.message);\n      throw new Error(`Gas estimation failed: ${error.message}. This usually means the transaction will revert. Check contract addresses and adapter configuration.`);\n    }\n\n    // Send transaction with estimated gas\n    const hash = await client.sendTransaction({\n      to: to as `0x${string}`,\n      data: data as `0x${string}`,\n      value: BigInt(value),\n      gas: gasLimit,\n    });\n\n    console.log('[relayer] Sent relayed transaction:', {\n      to,\n      hash,\n      from: account.address,\n    });\n\n    return hash;\n  } catch (error: any) {\n    console.error('[relayer] Failed to send relayed transaction:', error);\n    throw new Error(`Relayed transaction failed: ${error.message || 'Unknown error'}`);\n  }\n}\n\n\n", "/**\n * Aave Position Reader\n * Reads aToken balances and position data from chain\n */\n\nimport { Address } from 'viem';\nimport { ETH_TESTNET_RPC_URL } from '../../config';\nimport { getAaveMarketConfig, getSupportedAssets, type AaveAsset } from './market';\nimport { erc20_balanceOf } from '../../executors/erc20Rpc';\n\nexport interface AavePosition {\n  asset: string;\n  assetAddress: Address;\n  aTokenAddress: Address;\n  balance: bigint;\n  balanceFormatted: string;\n  underlyingValueUsd?: number; // Best-effort USD value\n  supplyAPY?: number; // Best-effort APY from reserve data\n}\n\n/**\n * Read all Aave positions for a user\n */\nexport async function readAavePositions(userAddress: Address): Promise<AavePosition[]> {\n  if (!ETH_TESTNET_RPC_URL) {\n    console.warn('[aave/positions] ETH_TESTNET_RPC_URL not configured');\n    return [];\n  }\n\n  try {\n    const marketConfig = await getAaveMarketConfig();\n    const supportedAssets = await getSupportedAssets();\n    const positions: AavePosition[] = [];\n\n    for (const asset of supportedAssets) {\n      try {\n        // Fetch aToken address if not already set\n        let aTokenAddress = asset.aTokenAddress;\n        if (aTokenAddress === '0x0000000000000000000000000000000000000000') {\n          const fetched = await import('./market').then(m => m.getATokenAddress(asset.address));\n          if (fetched) {\n            aTokenAddress = fetched;\n          } else {\n            continue; // Skip if we can't get aToken address\n          }\n        }\n\n        // Read aToken balance\n        const balance = await erc20_balanceOf(aTokenAddress, userAddress);\n        \n        if (balance > 0n) {\n          // Format balance based on decimals\n          const decimals = asset.decimals;\n          const divisor = BigInt(10 ** decimals);\n          const whole = balance / divisor;\n          const fraction = balance % divisor;\n          const balanceFormatted = `${whole.toString()}.${fraction.toString().padStart(decimals, '0').replace(/\\.?0+$/, '')}`;\n\n          positions.push({\n            asset: asset.symbol,\n            assetAddress: asset.address,\n            aTokenAddress,\n            balance,\n            balanceFormatted,\n            // Best-effort USD value (assume 1:1 for REDACTED)\n            underlyingValueUsd: asset.symbol === 'REDACTED' ? parseFloat(balanceFormatted) : undefined,\n            // APY would require fetching from PoolDataProvider.getReserveData\n            // For now, we'll leave it undefined and let the frontend handle it\n          });\n        }\n      } catch (error: any) {\n        console.warn(`[aave/positions] Failed to read position for ${asset.symbol}:`, error.message);\n        // Continue with other assets\n      }\n    }\n\n    return positions;\n  } catch (error: any) {\n    console.error('[aave/positions] Failed to read Aave positions:', error.message);\n    return [];\n  }\n}\n\n/**\n * Read a single Aave position for a specific asset\n */\nexport async function readAavePosition(\n  userAddress: Address,\n  assetSymbol: string\n): Promise<AavePosition | null> {\n  const positions = await readAavePositions(userAddress);\n  return positions.find(p => p.asset === assetSymbol) || null;\n}\n", "import { createWalletClient, http, publicActions } from 'viem';\nimport { sepolia } from 'viem/chains';\nimport { privateKeyToAccount } from 'viem/accounts';\n\n/**\n * Mints demo tokens (REDACTED and WETH) to a recipient address\n * Used for testnet faucet functionality\n */\nexport async function mintDemoTokens(recipientAddress: string) {\n  const {\n    ETH_TESTNET_RPC_URL,\n    DEMO_REDACTED_ADDRESS,\n    DEMO_WETH_ADDRESS,\n    RELAYER_PRIVATE_KEY\n  } = await import('../config');\n\n  if (!RELAYER_PRIVATE_KEY) {\n    throw new Error('RELAYER_PRIVATE_KEY not configured');\n  }\n\n  if (!DEMO_REDACTED_ADDRESS || !DEMO_WETH_ADDRESS) {\n    throw new Error('Demo token addresses not configured');\n  }\n\n  if (!ETH_TESTNET_RPC_URL) {\n    throw new Error('ETH_TESTNET_RPC_URL not configured');\n  }\n\n  const account = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n\n  const client = createWalletClient({\n    account,\n    chain: sepolia,\n    transport: http(ETH_TESTNET_RPC_URL)\n  }).extend(publicActions);\n\n  // ERC20 mint function ABI\n  const mintAbi = [\n    {\n      name: 'mint',\n      type: 'function',\n      stateMutability: 'nonpayable',\n      inputs: [\n        { name: 'to', type: 'address' },\n        { name: 'amount', type: 'uint256' }\n      ],\n      outputs: []\n    }\n  ] as const;\n\n  // Mint REDACTED (10,000 with 6 decimals)\n  const usdcAmount = BigInt(10000 * 10**6);\n  const usdcTxHash = await client.writeContract({\n    address: DEMO_REDACTED_ADDRESS as `0x${string}`,\n    abi: mintAbi,\n    functionName: 'mint',\n    args: [recipientAddress as `0x${string}`, usdcAmount]\n  });\n\n  // Wait for REDACTED tx to be mined\n  await client.waitForTransactionReceipt({ hash: usdcTxHash });\n\n  // Mint WETH (5 with 18 decimals)\n  const wethAmount = BigInt(5 * 10**18);\n  const wethTxHash = await client.writeContract({\n    address: DEMO_WETH_ADDRESS as `0x${string}`,\n    abi: mintAbi,\n    functionName: 'mint',\n    args: [recipientAddress as `0x${string}`, wethAmount]\n  });\n\n  // Wait for WETH tx to be mined\n  await client.waitForTransactionReceipt({ hash: wethTxHash });\n\n  return {\n    txHashes: {\n      usdc: usdcTxHash,\n      weth: wethTxHash\n    },\n    amounts: {\n      usdc: '10000',\n      weth: '5'\n    }\n  };\n}\n", "/**\n * RPC Provider with Failover\n *\n * Features:\n * - Multiple RPC endpoints (primary + fallbacks)\n * - Circuit breaker pattern (3 failures, 30s backoff)\n * - Automatic failover on HTTP 429 / rate limit errors\n * - Exponential backoff with jitter on retries\n * - Custom transport that wraps ALL viem RPC calls\n */\n\nimport { createPublicClient, createWalletClient, http, PublicClient, WalletClient, Chain, custom, EIP1193RequestFn } from 'viem';\nimport { sepolia } from 'viem/chains';\n\n// Circuit breaker state per endpoint\ninterface CircuitState {\n  failures: number;\n  lastFailure: number;\n  isOpen: boolean;\n  rateLimitedUntil: number; // Timestamp when rate limit expires\n}\n\n// Provider health tracking\ninterface ProviderHealth {\n  url: string;\n  isHealthy: boolean;\n  lastCheck: number;\n  circuit: CircuitState;\n}\n\n// Configuration\nconst CIRCUIT_BREAKER_THRESHOLD = 2; // Failures before circuit opens (reduced for faster failover)\nconst CIRCUIT_BREAKER_RESET_MS = 30_000; // 30 seconds backoff\nconst REQUEST_TIMEOUT_MS = 15_000; // 15 seconds per request\nconst MAX_RETRIES_PER_ENDPOINT = 1; // Retries before moving to next endpoint\nconst BASE_BACKOFF_MS = 500; // Base backoff for exponential retry\nconst MAX_BACKOFF_MS = 5_000; // Max backoff cap\nconst RATE_LIMIT_BACKOFF_MS = 60_000; // 60 seconds backoff for rate-limited endpoints\n\n// Singleton state\nconst providerHealth: Map<string, ProviderHealth> = new Map();\nlet primaryUrl: string | undefined;\nlet fallbackUrls: string[] = [];\nlet currentActiveUrl: string | undefined;\n\n/**\n * Initialize RPC provider with primary and fallback URLs\n */\nexport function initRpcProvider(primary: string, fallbacks: string[] = []): void {\n  primaryUrl = primary;\n  fallbackUrls = fallbacks;\n  currentActiveUrl = primary;\n\n  // Initialize health tracking for all endpoints\n  const allUrls = [primary, ...fallbacks];\n  for (const url of allUrls) {\n    if (!providerHealth.has(url)) {\n      providerHealth.set(url, {\n        url,\n        isHealthy: true,\n        lastCheck: Date.now(),\n        circuit: {\n          failures: 0,\n          lastFailure: 0,\n          isOpen: false,\n          rateLimitedUntil: 0,\n        },\n      });\n    }\n  }\n\n  console.log(`[rpc-provider] Initialized with ${allUrls.length} endpoint(s)`);\n  console.log(`[rpc-provider] Primary: ${maskUrl(primary)}`);\n  if (fallbacks.length > 0) {\n    console.log(`[rpc-provider] Fallbacks: ${fallbacks.map(maskUrl).join(', ')}`);\n  }\n}\n\n/**\n * Mask URL for logging (hide API keys)\n */\nfunction maskUrl(url: string): string {\n  try {\n    const parsed = new URL(url);\n    // Mask path if it looks like an API key\n    if (parsed.pathname.length > 20) {\n      parsed.pathname = parsed.pathname.substring(0, 10) + '...[masked]';\n    }\n    // Mask query params\n    parsed.search = '';\n    return parsed.toString();\n  } catch {\n    return url.substring(0, 30) + '...';\n  }\n}\n\n/**\n * Check if error is a rate limit (429) error\n */\nfunction isRateLimitError(error: any): boolean {\n  const message = error?.message?.toLowerCase() || '';\n  const details = error?.details?.toLowerCase() || '';\n  const shortMessage = error?.shortMessage?.toLowerCase() || '';\n\n  return (\n    message.includes('429') ||\n    message.includes('too many requests') ||\n    message.includes('rate limit') ||\n    message.includes('rate-limit') ||\n    details.includes('429') ||\n    details.includes('too many requests') ||\n    details.includes('rate limit') ||\n    shortMessage.includes('429') ||\n    shortMessage.includes('rate limit') ||\n    error?.status === 429\n  );\n}\n\n/**\n * Check if error is retriable (network issues, timeouts, etc.)\n */\nfunction isRetriableError(error: any): boolean {\n  if (isRateLimitError(error)) return true;\n\n  const message = error?.message?.toLowerCase() || '';\n  return (\n    message.includes('timeout') ||\n    message.includes('econnreset') ||\n    message.includes('econnrefused') ||\n    message.includes('network') ||\n    message.includes('fetch failed') ||\n    message.includes('socket') ||\n    message.includes('503') ||\n    message.includes('502') ||\n    message.includes('500')\n  );\n}\n\n/**\n * Calculate exponential backoff with jitter\n */\nfunction calculateBackoff(attempt: number): number {\n  const exponential = Math.min(BASE_BACKOFF_MS * Math.pow(2, attempt), MAX_BACKOFF_MS);\n  const jitter = Math.random() * 0.3 * exponential; // 0-30% jitter\n  return Math.floor(exponential + jitter);\n}\n\n/**\n * Sleep for given milliseconds\n */\nfunction sleep(ms: number): Promise<void> {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n/**\n * Check if circuit breaker should allow requests\n */\nfunction isCircuitClosed(health: ProviderHealth): boolean {\n  const circuit = health.circuit;\n  const now = Date.now();\n\n  // Check rate limit first\n  if (circuit.rateLimitedUntil > now) {\n    return false;\n  }\n\n  // If circuit is open, check if enough time has passed\n  if (circuit.isOpen) {\n    const elapsed = now - circuit.lastFailure;\n    if (elapsed >= CIRCUIT_BREAKER_RESET_MS) {\n      // Allow retry (half-open state)\n      circuit.isOpen = false;\n      circuit.failures = 0;\n      console.log(`[rpc-provider] Circuit reset for ${maskUrl(health.url)}`);\n      return true;\n    }\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Record a failure for an endpoint\n */\nfunction recordFailure(url: string, error: Error, isRateLimit: boolean = false): void {\n  const health = providerHealth.get(url);\n  if (!health) return;\n\n  health.circuit.failures++;\n  health.circuit.lastFailure = Date.now();\n  health.isHealthy = false;\n\n  // If rate limited, set longer backoff\n  if (isRateLimit) {\n    health.circuit.rateLimitedUntil = Date.now() + RATE_LIMIT_BACKOFF_MS;\n    health.circuit.isOpen = true;\n    console.log(`[rpc-provider] Rate limited! Circuit OPEN for ${maskUrl(url)} for ${RATE_LIMIT_BACKOFF_MS / 1000}s`);\n  } else if (health.circuit.failures >= CIRCUIT_BREAKER_THRESHOLD) {\n    health.circuit.isOpen = true;\n    console.log(`[rpc-provider] Circuit OPEN for ${maskUrl(url)} after ${health.circuit.failures} failures: ${error.message?.slice(0, 100)}`);\n  } else {\n    console.log(`[rpc-provider] Failure ${health.circuit.failures}/${CIRCUIT_BREAKER_THRESHOLD} for ${maskUrl(url)}: ${error.message?.slice(0, 100)}`);\n  }\n}\n\n/**\n * Record a success for an endpoint\n */\nfunction recordSuccess(url: string): void {\n  const health = providerHealth.get(url);\n  if (!health) return;\n\n  health.circuit.failures = 0;\n  health.circuit.isOpen = false;\n  health.isHealthy = true;\n  health.lastCheck = Date.now();\n}\n\n/**\n * Get all available RPC URLs in order of preference\n */\nexport function getAllRpcUrls(): string[] {\n  ensureInitialized();\n  return [primaryUrl, ...fallbackUrls].filter(Boolean) as string[];\n}\n\n/**\n * Get next available RPC URL (skipping rate-limited ones)\n */\nexport function getAvailableRpcUrl(): string | undefined {\n  const allUrls = getAllRpcUrls();\n\n  // Try to find a healthy endpoint\n  for (const url of allUrls) {\n    const health = providerHealth.get(url);\n    if (health && isCircuitClosed(health)) {\n      currentActiveUrl = url;\n      return url;\n    }\n  }\n\n  // If all circuits are open, try primary anyway (last resort)\n  if (primaryUrl) {\n    console.log(`[rpc-provider] All circuits open, trying primary as last resort`);\n    currentActiveUrl = primaryUrl;\n    return primaryUrl;\n  }\n\n  return undefined;\n}\n\n/**\n * Get current active URL (for logging)\n */\nexport function getCurrentActiveUrl(): string | undefined {\n  return currentActiveUrl;\n}\n\n/**\n * Make a single JSON-RPC request to a specific URL\n */\nasync function makeRpcRequest(url: string, body: any): Promise<any> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);\n\n  try {\n    const response = await fetch(url, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(body),\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    if (response.status === 429) {\n      const error = new Error(`HTTP 429: Too Many Requests from ${maskUrl(url)}`);\n      (error as any).status = 429;\n      throw error;\n    }\n\n    if (!response.ok) {\n      const text = await response.text().catch(() => 'Unknown error');\n      throw new Error(`HTTP ${response.status}: ${text.slice(0, 200)}`);\n    }\n\n    const json = await response.json();\n\n    // Check for JSON-RPC error\n    if (json.error) {\n      const rpcError = new Error(json.error.message || 'RPC Error');\n      (rpcError as any).code = json.error.code;\n      throw rpcError;\n    }\n\n    return json.result;\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    if (error.name === 'AbortError') {\n      throw new Error(`Request timeout after ${REQUEST_TIMEOUT_MS}ms to ${maskUrl(url)}`);\n    }\n    throw error;\n  }\n}\n\n/**\n * Execute a JSON-RPC request with automatic failover across all endpoints\n */\nexport async function executeRpcWithFailover(\n  method: string,\n  params: any[]\n): Promise<any> {\n  const allUrls = getAllRpcUrls();\n  let lastError: Error | undefined;\n  let attemptCount = 0;\n\n  for (const url of allUrls) {\n    const health = providerHealth.get(url);\n\n    // Skip if circuit is open (unless it's the only option)\n    if (health && !isCircuitClosed(health)) {\n      continue;\n    }\n\n    // Try this endpoint with retries\n    for (let retry = 0; retry <= MAX_RETRIES_PER_ENDPOINT; retry++) {\n      attemptCount++;\n\n      try {\n        const body = {\n          jsonrpc: '2.0',\n          id: Date.now(),\n          method,\n          params,\n        };\n\n        const result = await makeRpcRequest(url, body);\n        recordSuccess(url);\n        currentActiveUrl = url;\n\n        if (attemptCount > 1) {\n          console.log(`[rpc-provider] Success on attempt ${attemptCount} via ${maskUrl(url)}`);\n        }\n\n        return result;\n      } catch (error: any) {\n        lastError = error;\n        const isRateLimit = isRateLimitError(error);\n\n        if (isRateLimit) {\n          // Rate limit - record failure and immediately try next endpoint\n          recordFailure(url, error, true);\n          console.log(`[rpc-provider] Rate limited on ${maskUrl(url)}, switching to next endpoint...`);\n          break; // Exit retry loop, move to next endpoint\n        }\n\n        if (isRetriableError(error) && retry < MAX_RETRIES_PER_ENDPOINT) {\n          // Retriable error - backoff and retry same endpoint\n          const backoff = calculateBackoff(retry);\n          console.log(`[rpc-provider] Retry ${retry + 1}/${MAX_RETRIES_PER_ENDPOINT} for ${maskUrl(url)} after ${backoff}ms...`);\n          await sleep(backoff);\n          continue;\n        }\n\n        // Non-retriable or max retries reached\n        recordFailure(url, error, false);\n        break; // Move to next endpoint\n      }\n    }\n  }\n\n  // All endpoints failed\n  throw lastError || new Error('No RPC endpoints available');\n}\n\n/**\n * Create a custom transport that routes all requests through failover logic\n */\nfunction createFailoverTransport() {\n  const request: EIP1193RequestFn = async ({ method, params }) => {\n    return executeRpcWithFailover(method, params as any[]);\n  };\n\n  return custom({ request });\n}\n\n/**\n * Execute an RPC call with failover (legacy function, now uses executeRpcWithFailover internally)\n */\nexport async function executeWithFailover<T>(\n  fn: (rpcUrl: string) => Promise<T>\n): Promise<T> {\n  const allUrls = getAllRpcUrls();\n  let lastError: Error | undefined;\n\n  for (const url of allUrls) {\n    const health = providerHealth.get(url);\n\n    // Skip if circuit is open\n    if (health && !isCircuitClosed(health)) {\n      continue;\n    }\n\n    for (let retry = 0; retry <= MAX_RETRIES_PER_ENDPOINT; retry++) {\n      try {\n        const result = await fn(url);\n        recordSuccess(url);\n        return result;\n      } catch (error: any) {\n        lastError = error;\n        const isRateLimit = isRateLimitError(error);\n\n        if (isRateLimit) {\n          recordFailure(url, error, true);\n          break; // Move to next endpoint\n        }\n\n        if (isRetriableError(error) && retry < MAX_RETRIES_PER_ENDPOINT) {\n          const backoff = calculateBackoff(retry);\n          await sleep(backoff);\n          continue;\n        }\n\n        recordFailure(url, error, false);\n        break;\n      }\n    }\n  }\n\n  throw lastError || new Error('No RPC endpoints available');\n}\n\n/**\n * Auto-initialize from environment if not already initialized\n */\nfunction ensureInitialized(): void {\n  if (primaryUrl) return;\n\n  // Try to initialize from environment\n  const primary = process.env.ETH_TESTNET_RPC_URL;\n  if (!primary) {\n    throw new Error('RPC provider not initialized and ETH_TESTNET_RPC_URL not set');\n  }\n\n  // Collect fallbacks\n  const fallbacks: string[] = [];\n\n  // Check explicit fallback list\n  if (process.env.ETH_RPC_FALLBACK_URLS) {\n    fallbacks.push(...process.env.ETH_RPC_FALLBACK_URLS.split(',').map(u => u.trim()).filter(Boolean));\n  }\n\n  // Add individual provider URLs if not primary\n  if (process.env.ALCHEMY_RPC_URL && !primary.includes('alchemy')) {\n    fallbacks.push(process.env.ALCHEMY_RPC_URL);\n  }\n  if (process.env.INFURA_RPC_URL && !primary.includes('infura')) {\n    fallbacks.push(process.env.INFURA_RPC_URL);\n  }\n\n  // Add public RPCs as last resort (multiple for redundancy)\n  const publicRpcs = [\n    'https://ethereum-sepolia-rpc.publicnode.com',\n    'https://1rpc.io/sepolia',\n    'https://rpc.sepolia.org',\n  ];\n\n  for (const rpc of publicRpcs) {\n    if (!fallbacks.some(u => u.includes(new URL(rpc).hostname))) {\n      fallbacks.push(rpc);\n    }\n  }\n\n  // Dedupe and filter out primary\n  const uniqueFallbacks = [...new Set(fallbacks)].filter(u => u !== primary && u.length > 0);\n\n  console.log('[rpc-provider] Auto-initializing from environment...');\n  initRpcProvider(primary, uniqueFallbacks);\n}\n\n/**\n * Create a public client with automatic failover transport\n * ALL RPC calls through this client will use failover logic\n */\nexport function createFailoverPublicClient(chain: Chain = sepolia): PublicClient {\n  ensureInitialized();\n\n  return createPublicClient({\n    chain,\n    transport: createFailoverTransport(),\n  }) as PublicClient;\n}\n\n/**\n * Create a wallet client with automatic failover transport\n * Accepts either an account address string or the full account object from privateKeyToAccount()\n */\nexport function createFailoverWalletClient(\n  account: `0x${string}` | { address: `0x${string}` } | undefined,\n  chain: Chain = sepolia\n): WalletClient {\n  ensureInitialized();\n\n  return createWalletClient({\n    account: account as any,\n    chain,\n    transport: createFailoverTransport(),\n  }) as WalletClient;\n}\n\n/**\n * Get current provider health status\n */\nexport function getProviderHealthStatus(): {\n  active: string | null;\n  primary: { url: string; healthy: boolean; circuitOpen: boolean; rateLimitedUntil: number } | null;\n  fallbacks: Array<{ url: string; healthy: boolean; circuitOpen: boolean; rateLimitedUntil: number }>;\n} {\n  const status = {\n    active: currentActiveUrl ? maskUrl(currentActiveUrl) : null,\n    primary: null as { url: string; healthy: boolean; circuitOpen: boolean; rateLimitedUntil: number } | null,\n    fallbacks: [] as Array<{ url: string; healthy: boolean; circuitOpen: boolean; rateLimitedUntil: number }>,\n  };\n\n  if (primaryUrl) {\n    const health = providerHealth.get(primaryUrl);\n    status.primary = {\n      url: maskUrl(primaryUrl),\n      healthy: health?.isHealthy ?? false,\n      circuitOpen: health?.circuit.isOpen ?? false,\n      rateLimitedUntil: health?.circuit.rateLimitedUntil ?? 0,\n    };\n  }\n\n  for (const url of fallbackUrls) {\n    const health = providerHealth.get(url);\n    status.fallbacks.push({\n      url: maskUrl(url),\n      healthy: health?.isHealthy ?? false,\n      circuitOpen: health?.circuit.isOpen ?? false,\n      rateLimitedUntil: health?.circuit.rateLimitedUntil ?? 0,\n    });\n  }\n\n  return status;\n}\n\n/**\n * Reset all circuit breakers (for testing/manual recovery)\n */\nexport function resetAllCircuits(): void {\n  for (const health of providerHealth.values()) {\n    health.circuit.failures = 0;\n    health.circuit.isOpen = false;\n    health.circuit.rateLimitedUntil = 0;\n    health.isHealthy = true;\n  }\n  console.log('[rpc-provider] All circuits reset');\n}\n\n/**\n * Force switch to next available endpoint (for manual failover)\n */\nexport function forceFailover(): string | undefined {\n  if (currentActiveUrl) {\n    const health = providerHealth.get(currentActiveUrl);\n    if (health) {\n      health.circuit.isOpen = true;\n      health.circuit.lastFailure = Date.now();\n    }\n  }\n  return getAvailableRpcUrl();\n}\n", "/**\n * Database Factory\n * Provides a unified interface for SQLite (local) and Postgres (production)\n *\n * Usage:\n *   - Local dev: Uses SQLite (default, via better-sqlite3)\n *   - Production: Uses Postgres (via DATABASE_URL env var)\n *\n * Detection:\n *   - If DATABASE_URL is set and starts with 'postgres', use Postgres\n *   - Otherwise, use SQLite\n */\n\nexport type DatabaseType = 'sqlite' | 'postgres';\n\n/**\n * Detect which database to use based on environment\n */\nexport function detectDatabaseType(): DatabaseType {\n  const databaseUrl = process.env.DATABASE_URL;\n\n  if (databaseUrl && (databaseUrl.startsWith('postgres') || databaseUrl.startsWith('postgresql'))) {\n    return 'postgres';\n  }\n\n  return 'sqlite';\n}\n\n/**\n * Get human-readable database info for logging\n */\nexport function getDatabaseInfo(): { type: DatabaseType; url?: string } {\n  const type = detectDatabaseType();\n\n  if (type === 'postgres') {\n    // Redact password from URL for logging\n    const url = process.env.DATABASE_URL || '';\n    const redactedUrl = url.replace(/:([^:@]+)@/, ':***@');\n    return { type, url: redactedUrl };\n  }\n\n  return { type };\n}\n\n/**\n * Log database connection info on startup\n */\nexport function logDatabaseInfo(): void {\n  const info = getDatabaseInfo();\n\n  if (info.type === 'postgres') {\n    console.log(`\uD83D\uDDC4\uFE0F  Database: PostgreSQL`);\n    console.log(`   URL: ${info.url}`);\n  } else {\n    console.log(`\uD83D\uDDC4\uFE0F  Database: SQLite (local development)`);\n    console.log(`   Path: agent/execution-ledger/ledger.db`);\n  }\n}\n\n// Re-export the main database module\n// The db.ts module handles the actual implementation\nexport * from './db';\n", "/**\n * Bloom Execution Ledger Database\n * Supports both SQLite (local dev) and Postgres (production)\n *\n * Mode selection:\n * - Local: Uses SQLite (default) when DATABASE_URL is not set\n * - Production: Uses Postgres when DATABASE_URL is set\n *\n * Note: The synchronous functions below work with SQLite.\n * For Postgres support in production, use the async helpers or\n * run setup-neon-db.ts to initialize the Postgres schema.\n */\n\nimport Database from 'better-sqlite3';\nimport { randomUUID } from 'crypto';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport { fileURLToPath } from 'url';\nimport { dirname } from 'path';\nimport { detectDatabaseType, logDatabaseInfo } from './db-factory.js';\n\n// ESM-safe __dirname\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// Database file path (in agent/execution-ledger directory)\nconst DB_PATH = process.env.EXECUTION_LEDGER_DB_PATH || path.join(__dirname, 'ledger.db');\n\nlet db: Database.Database | null = null;\nconst dbType = detectDatabaseType();\n\n// Log database info on module load\nlogDatabaseInfo();\n\n/**\n * Initialize the database connection and run migrations\n */\nexport function initDatabase(): Database.Database {\n  if (db) return db;\n\n  // Postgres mode check\n  if (dbType === 'postgres') {\n    console.warn('\u26A0\uFE0F  Postgres mode detected (DATABASE_URL is set)');\n    console.warn('   Local SQLite will be used for backward compatibility.');\n    console.warn('   Production deployments should use Postgres via API endpoints.');\n    console.warn('   Run: npx tsx agent/scripts/setup-neon-db.ts --apply-schema');\n  }\n\n  // Ensure directory exists\n  const dbDir = path.dirname(DB_PATH);\n  if (!fs.existsSync(dbDir)) {\n    fs.mkdirSync(dbDir, { recursive: true });\n  }\n\n  db = new Database(DB_PATH);\n  db.pragma('journal_mode = WAL');\n  db.pragma('foreign_keys = ON');\n\n  // Run schema\n  runMigrations(db);\n\n  return db;\n}\n\n/**\n * Get the database instance (initializes if needed)\n */\nexport function getDatabase(): Database.Database {\n  if (!db) {\n    return initDatabase();\n  }\n  return db;\n}\n\n/**\n * Close the database connection\n */\nexport function closeDatabase(): void {\n  if (db) {\n    db.close();\n    db = null;\n  }\n}\n\n/**\n * Run schema migrations\n */\nfunction runMigrations(database: Database.Database): void {\n  const schemaPath = path.join(__dirname, 'schema.sql');\n  const schema = fs.readFileSync(schemaPath, 'utf-8');\n  database.exec(schema);\n\n  // Run column migrations for existing databases\n  runColumnMigrations(database);\n}\n\n/**\n * Add new columns to existing tables (idempotent)\n * SQLite doesn't support IF NOT EXISTS for columns, so we catch errors\n */\nfunction runColumnMigrations(database: Database.Database): void {\n  const migrations = [\n    // executions table new columns\n    'ALTER TABLE executions ADD COLUMN kind TEXT',\n    'ALTER TABLE executions ADD COLUMN venue TEXT',\n    'ALTER TABLE executions ADD COLUMN usd_estimate REAL',\n    'ALTER TABLE executions ADD COLUMN usd_estimate_is_estimate INTEGER DEFAULT 1',\n    'ALTER TABLE executions ADD COLUMN relayer_address TEXT',\n    'ALTER TABLE executions ADD COLUMN session_id TEXT',\n    'ALTER TABLE executions ADD COLUMN intent_id TEXT',\n    // execution_steps table new columns for intent tracking\n    'ALTER TABLE execution_steps ADD COLUMN stage TEXT',\n    'ALTER TABLE execution_steps ADD COLUMN error_code TEXT',\n  ];\n\n  for (const migration of migrations) {\n    try {\n      database.exec(migration);\n    } catch (e: any) {\n      // Column already exists - this is expected on fresh installs\n      if (!e.message.includes('duplicate column name')) {\n        console.warn(`[ledger] Migration warning: ${e.message}`);\n      }\n    }\n  }\n}\n\n// ============================================\n// Type Definitions\n// ============================================\n\nexport type Chain = 'ethereum' | 'solana';\nexport type Network = 'sepolia' | 'devnet' | 'mainnet';\nexport type ExecutionStatus = 'pending' | 'submitted' | 'confirmed' | 'finalized' | 'failed';\nexport type SessionStatus = 'preparing' | 'active' | 'revoked' | 'expired';\n\n// Kind of execution - categorizes the operation type\nexport type ExecutionKind = 'perp' | 'deposit' | 'bridge' | 'swap' | 'proof' | 'relay' | 'transfer';\n\n// Venue - the protocol/DEX used\nexport type ExecutionVenue =\n  | 'drift' | 'hl' | 'hyperliquid' | 'perp_demo'  // perp venues\n  | 'aave' | 'kamino' | 'deposit_demo'             // deposit/lending venues\n  | 'lifi' | 'wormhole' | 'bridge_demo'            // bridge venues\n  | 'uniswap' | 'jupiter' | 'swap_demo'            // swap venues\n  | 'native';                                       // native transfers\n\nexport interface Execution {\n  id: string;\n  chain: Chain;\n  network: Network;\n  kind?: ExecutionKind;                  // NEW: execution category\n  venue?: ExecutionVenue;                // NEW: protocol/venue used\n  intent: string;\n  action: string;\n  from_address: string;\n  to_address?: string;\n  token?: string;\n  amount_units?: string;\n  amount_display?: string;\n  usd_estimate?: number;                 // NEW: estimated USD value\n  usd_estimate_is_estimate?: number;     // NEW: 1 if estimate, 0 if from oracle\n  tx_hash?: string;\n  status: ExecutionStatus;\n  error_code?: string;\n  error_message?: string;\n  explorer_url?: string;\n  gas_used?: string;\n  block_number?: number;\n  latency_ms?: number;\n  relayer_address?: string;              // NEW: relayer that submitted tx\n  session_id?: string;                   // NEW: session ID if session mode\n  created_at: number;\n  updated_at: number;\n}\n\nexport interface Route {\n  id: string;\n  execution_id: string;\n  step_index: number;\n  action_type: number;\n  adapter_address?: string;\n  target_address?: string;\n  encoded_data?: string;\n  status: string;\n  tx_hash?: string;\n  created_at: number;\n}\n\nexport interface Session {\n  id: string;\n  chain: Chain;\n  network: Network;\n  user_address: string;\n  session_id: string;\n  relayer_address?: string;\n  status: SessionStatus;\n  expires_at?: number;\n  created_tx?: string;\n  revoked_tx?: string;\n  created_at: number;\n  updated_at: number;\n}\n\nexport interface Asset {\n  id: string;\n  chain: Chain;\n  network: Network;\n  wallet_address: string;\n  token_address?: string;\n  token_symbol: string;\n  balance_units?: string;\n  balance_display?: string;\n  last_tx_hash?: string;\n  updated_at: number;\n}\n\nexport interface Wallet {\n  id: string;\n  chain: Chain;\n  network: Network;\n  address: string;\n  label?: string;\n  is_primary: number;\n  created_at: number;\n}\n\n// ============================================\n// Execution Operations\n// ============================================\n\nexport function createExecution(params: {\n  chain: Chain;\n  network: Network;\n  kind?: ExecutionKind;\n  venue?: ExecutionVenue;\n  intent: string;\n  action: string;\n  fromAddress: string;\n  toAddress?: string;\n  token?: string;\n  amountUnits?: string;\n  amountDisplay?: string;\n  usdEstimate?: number;\n  usdEstimateIsEstimate?: boolean;\n  relayerAddress?: string;\n  sessionId?: string;\n}): Execution {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO executions (\n      id, chain, network, kind, venue, intent, action, from_address, to_address,\n      token, amount_units, amount_display, usd_estimate, usd_estimate_is_estimate,\n      relayer_address, session_id, status, created_at, updated_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending', ?, ?)\n  `).run(\n    id,\n    params.chain,\n    params.network,\n    params.kind ?? null,\n    params.venue ?? null,\n    params.intent,\n    params.action,\n    params.fromAddress.toLowerCase(),\n    params.toAddress?.toLowerCase() ?? null,\n    params.token ?? null,\n    params.amountUnits ?? null,\n    params.amountDisplay ?? null,\n    params.usdEstimate ?? null,\n    params.usdEstimateIsEstimate === false ? 0 : 1,  // Default to estimate=true\n    params.relayerAddress?.toLowerCase() ?? null,\n    params.sessionId ?? null,\n    now,\n    now\n  );\n\n  return {\n    id,\n    chain: params.chain,\n    network: params.network,\n    kind: params.kind,\n    venue: params.venue,\n    intent: params.intent,\n    action: params.action,\n    from_address: params.fromAddress.toLowerCase(),\n    to_address: params.toAddress?.toLowerCase(),\n    token: params.token,\n    amount_units: params.amountUnits,\n    amount_display: params.amountDisplay,\n    usd_estimate: params.usdEstimate,\n    usd_estimate_is_estimate: params.usdEstimateIsEstimate === false ? 0 : 1,\n    relayer_address: params.relayerAddress?.toLowerCase(),\n    session_id: params.sessionId,\n    status: 'pending',\n    created_at: now,\n    updated_at: now,\n  };\n}\n\nexport function updateExecution(\n  id: string,\n  updates: Partial<{\n    status: ExecutionStatus;\n    kind: ExecutionKind;\n    venue: ExecutionVenue;\n    txHash: string;\n    explorerUrl: string;\n    errorCode: string;\n    errorMessage: string;\n    gasUsed: string;\n    blockNumber: number;\n    latencyMs: number;\n    usdEstimate: number;\n    usdEstimateIsEstimate: boolean;\n    relayerAddress: string;\n    sessionId: string;\n  }>\n): void {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n\n  const sets: string[] = ['updated_at = ?'];\n  const values: any[] = [now];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.kind !== undefined) {\n    sets.push('kind = ?');\n    values.push(updates.kind);\n  }\n  if (updates.venue !== undefined) {\n    sets.push('venue = ?');\n    values.push(updates.venue);\n  }\n  if (updates.txHash !== undefined) {\n    sets.push('tx_hash = ?');\n    values.push(updates.txHash);\n  }\n  if (updates.explorerUrl !== undefined) {\n    sets.push('explorer_url = ?');\n    values.push(updates.explorerUrl);\n  }\n  if (updates.errorCode !== undefined) {\n    sets.push('error_code = ?');\n    values.push(updates.errorCode);\n  }\n  if (updates.errorMessage !== undefined) {\n    sets.push('error_message = ?');\n    values.push(updates.errorMessage);\n  }\n  if (updates.gasUsed !== undefined) {\n    sets.push('gas_used = ?');\n    values.push(updates.gasUsed);\n  }\n  if (updates.blockNumber !== undefined) {\n    sets.push('block_number = ?');\n    values.push(updates.blockNumber);\n  }\n  if (updates.latencyMs !== undefined) {\n    sets.push('latency_ms = ?');\n    values.push(updates.latencyMs);\n  }\n  if (updates.usdEstimate !== undefined) {\n    sets.push('usd_estimate = ?');\n    values.push(updates.usdEstimate);\n  }\n  if (updates.usdEstimateIsEstimate !== undefined) {\n    sets.push('usd_estimate_is_estimate = ?');\n    values.push(updates.usdEstimateIsEstimate ? 1 : 0);\n  }\n  if (updates.relayerAddress !== undefined) {\n    sets.push('relayer_address = ?');\n    values.push(updates.relayerAddress.toLowerCase());\n  }\n  if (updates.sessionId !== undefined) {\n    sets.push('session_id = ?');\n    values.push(updates.sessionId);\n  }\n\n  values.push(id);\n  db.prepare(`UPDATE executions SET ${sets.join(', ')} WHERE id = ?`).run(...values);\n}\n\nexport function getExecution(id: string): Execution | undefined {\n  const db = getDatabase();\n  return db.prepare('SELECT * FROM executions WHERE id = ?').get(id) as Execution | undefined;\n}\n\nexport function getExecutionByTxHash(txHash: string): Execution | undefined {\n  const db = getDatabase();\n  return db.prepare('SELECT * FROM executions WHERE tx_hash = ?').get(txHash) as Execution | undefined;\n}\n\nexport interface ListResult<T> {\n  data: T[];\n  meta: {\n    totalInDb: number;\n    limit: number;\n    offset: number;\n  };\n}\n\nexport function countExecutions(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: ExecutionStatus;\n}): number {\n  const db = getDatabase();\n\n  let query = 'SELECT COUNT(*) as count FROM executions WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.status) {\n    query += ' AND status = ?';\n    values.push(params.status);\n  }\n\n  return (db.prepare(query).get(...values) as any).count;\n}\n\nexport function listExecutions(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: ExecutionStatus;\n  limit?: number;\n  offset?: number;\n}): Execution[] {\n  const db = getDatabase();\n  const limit = params?.limit ?? 50;\n  const offset = params?.offset ?? 0;\n\n  let query = 'SELECT * FROM executions WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.status) {\n    query += ' AND status = ?';\n    values.push(params.status);\n  }\n\n  query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\n  values.push(limit, offset);\n\n  return db.prepare(query).all(...values) as Execution[];\n}\n\nexport function listExecutionsWithMeta(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: ExecutionStatus;\n  limit?: number;\n  offset?: number;\n}): ListResult<Execution> {\n  const limit = params?.limit ?? 50;\n  const offset = params?.offset ?? 0;\n  const totalInDb = countExecutions(params);\n  const data = listExecutions(params);\n\n  return {\n    data,\n    meta: { totalInDb, limit, offset },\n  };\n}\n\n// ============================================\n// Route Operations\n// ============================================\n\nexport function createRoute(params: {\n  executionId: string;\n  stepIndex: number;\n  actionType: number;\n  adapterAddress?: string;\n  targetAddress?: string;\n  encodedData?: string;\n}): Route {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO routes (\n      id, execution_id, step_index, action_type, adapter_address,\n      target_address, encoded_data, status, created_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', ?)\n  `).run(\n    id,\n    params.executionId,\n    params.stepIndex,\n    params.actionType,\n    params.adapterAddress ?? null,\n    params.targetAddress ?? null,\n    params.encodedData ?? null,\n    now\n  );\n\n  return {\n    id,\n    execution_id: params.executionId,\n    step_index: params.stepIndex,\n    action_type: params.actionType,\n    adapter_address: params.adapterAddress,\n    target_address: params.targetAddress,\n    encoded_data: params.encodedData,\n    status: 'pending',\n    created_at: now,\n  };\n}\n\nexport function getRoutesForExecution(executionId: string): Route[] {\n  const db = getDatabase();\n  return db.prepare(\n    'SELECT * FROM routes WHERE execution_id = ? ORDER BY step_index'\n  ).all(executionId) as Route[];\n}\n\nexport function updateRoute(id: string, updates: { status?: string; txHash?: string }): void {\n  const db = getDatabase();\n  const sets: string[] = [];\n  const values: any[] = [];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.txHash !== undefined) {\n    sets.push('tx_hash = ?');\n    values.push(updates.txHash);\n  }\n\n  if (sets.length === 0) return;\n  values.push(id);\n  db.prepare(`UPDATE routes SET ${sets.join(', ')} WHERE id = ?`).run(...values);\n}\n\n// ============================================\n// Session Operations\n// ============================================\n\nexport function upsertSession(params: {\n  chain: Chain;\n  network: Network;\n  userAddress: string;\n  sessionId: string;\n  relayerAddress?: string;\n  status: SessionStatus;\n  expiresAt?: number;\n  createdTx?: string;\n}): Session {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  const existing = db.prepare(\n    'SELECT * FROM sessions WHERE chain = ? AND network = ? AND user_address = ? AND session_id = ?'\n  ).get(params.chain, params.network, params.userAddress.toLowerCase(), params.sessionId) as Session | undefined;\n\n  if (existing) {\n    db.prepare(`\n      UPDATE sessions SET status = ?, relayer_address = ?, expires_at = ?, updated_at = ?\n      WHERE id = ?\n    `).run(\n      params.status,\n      params.relayerAddress ?? existing.relayer_address ?? null,\n      params.expiresAt ?? existing.expires_at ?? null,\n      now,\n      existing.id\n    );\n    return { ...existing, status: params.status, updated_at: now };\n  }\n\n  db.prepare(`\n    INSERT INTO sessions (\n      id, chain, network, user_address, session_id, relayer_address,\n      status, expires_at, created_tx, created_at, updated_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    id,\n    params.chain,\n    params.network,\n    params.userAddress.toLowerCase(),\n    params.sessionId,\n    params.relayerAddress ?? null,\n    params.status,\n    params.expiresAt ?? null,\n    params.createdTx ?? null,\n    now,\n    now\n  );\n\n  return {\n    id,\n    chain: params.chain,\n    network: params.network,\n    user_address: params.userAddress.toLowerCase(),\n    session_id: params.sessionId,\n    relayer_address: params.relayerAddress,\n    status: params.status,\n    expires_at: params.expiresAt,\n    created_tx: params.createdTx,\n    created_at: now,\n    updated_at: now,\n  };\n}\n\nexport function countSessions(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: SessionStatus;\n}): number {\n  const db = getDatabase();\n\n  let query = 'SELECT COUNT(*) as count FROM sessions WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.status) {\n    query += ' AND status = ?';\n    values.push(params.status);\n  }\n\n  return (db.prepare(query).get(...values) as any).count;\n}\n\nexport function listSessions(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: SessionStatus;\n  limit?: number;\n}): Session[] {\n  const db = getDatabase();\n  const limit = params?.limit ?? 50;\n\n  let query = 'SELECT * FROM sessions WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.status) {\n    query += ' AND status = ?';\n    values.push(params.status);\n  }\n\n  query += ' ORDER BY created_at DESC LIMIT ?';\n  values.push(limit);\n\n  return db.prepare(query).all(...values) as Session[];\n}\n\nexport function listSessionsWithMeta(params?: {\n  chain?: Chain;\n  network?: Network;\n  status?: SessionStatus;\n  limit?: number;\n}): ListResult<Session> {\n  const limit = params?.limit ?? 50;\n  const totalInDb = countSessions(params);\n  const data = listSessions(params);\n\n  return {\n    data,\n    meta: { totalInDb, limit, offset: 0 },\n  };\n}\n\n// ============================================\n// Asset Operations\n// ============================================\n\nexport function upsertAsset(params: {\n  chain: Chain;\n  network: Network;\n  walletAddress: string;\n  tokenAddress?: string;\n  tokenSymbol: string;\n  balanceUnits?: string;\n  balanceDisplay?: string;\n  lastTxHash?: string;\n}): Asset {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  const existing = db.prepare(\n    'SELECT * FROM assets WHERE chain = ? AND network = ? AND wallet_address = ? AND (token_address = ? OR (token_address IS NULL AND ? IS NULL))'\n  ).get(\n    params.chain,\n    params.network,\n    params.walletAddress.toLowerCase(),\n    params.tokenAddress ?? null,\n    params.tokenAddress ?? null\n  ) as Asset | undefined;\n\n  if (existing) {\n    db.prepare(`\n      UPDATE assets SET\n        balance_units = ?, balance_display = ?, last_tx_hash = ?, updated_at = ?\n      WHERE id = ?\n    `).run(\n      params.balanceUnits ?? existing.balance_units ?? null,\n      params.balanceDisplay ?? existing.balance_display ?? null,\n      params.lastTxHash ?? existing.last_tx_hash ?? null,\n      now,\n      existing.id\n    );\n    return {\n      ...existing,\n      balance_units: params.balanceUnits ?? existing.balance_units,\n      balance_display: params.balanceDisplay ?? existing.balance_display,\n      last_tx_hash: params.lastTxHash ?? existing.last_tx_hash,\n      updated_at: now,\n    };\n  }\n\n  db.prepare(`\n    INSERT INTO assets (\n      id, chain, network, wallet_address, token_address, token_symbol,\n      balance_units, balance_display, last_tx_hash, updated_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    id,\n    params.chain,\n    params.network,\n    params.walletAddress.toLowerCase(),\n    params.tokenAddress ?? null,\n    params.tokenSymbol,\n    params.balanceUnits ?? null,\n    params.balanceDisplay ?? null,\n    params.lastTxHash ?? null,\n    now\n  );\n\n  return {\n    id,\n    chain: params.chain,\n    network: params.network,\n    wallet_address: params.walletAddress.toLowerCase(),\n    token_address: params.tokenAddress,\n    token_symbol: params.tokenSymbol,\n    balance_units: params.balanceUnits,\n    balance_display: params.balanceDisplay,\n    last_tx_hash: params.lastTxHash,\n    updated_at: now,\n  };\n}\n\nexport function countAssets(params?: {\n  chain?: Chain;\n  network?: Network;\n  walletAddress?: string;\n}): number {\n  const db = getDatabase();\n\n  let query = 'SELECT COUNT(*) as count FROM assets WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.walletAddress) {\n    query += ' AND wallet_address = ?';\n    values.push(params.walletAddress.toLowerCase());\n  }\n\n  return (db.prepare(query).get(...values) as any).count;\n}\n\nexport function listAssets(params?: {\n  chain?: Chain;\n  network?: Network;\n  walletAddress?: string;\n  limit?: number;\n}): Asset[] {\n  const db = getDatabase();\n  const limit = params?.limit ?? 100;\n\n  let query = 'SELECT * FROM assets WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n  if (params?.walletAddress) {\n    query += ' AND wallet_address = ?';\n    values.push(params.walletAddress.toLowerCase());\n  }\n\n  query += ' ORDER BY updated_at DESC LIMIT ?';\n  values.push(limit);\n\n  return db.prepare(query).all(...values) as Asset[];\n}\n\nexport function listAssetsWithMeta(params?: {\n  chain?: Chain;\n  network?: Network;\n  walletAddress?: string;\n  limit?: number;\n}): ListResult<Asset> {\n  const limit = params?.limit ?? 100;\n  const totalInDb = countAssets(params);\n  const data = listAssets(params);\n\n  return {\n    data,\n    meta: { totalInDb, limit, offset: 0 },\n  };\n}\n\n// ============================================\n// Wallet Operations\n// ============================================\n\nexport function registerWallet(params: {\n  chain: Chain;\n  network: Network;\n  address: string;\n  label?: string;\n  isPrimary?: boolean;\n}): Wallet {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  // If setting as primary, unset other primaries for this chain/network\n  if (params.isPrimary) {\n    db.prepare(\n      'UPDATE wallets SET is_primary = 0 WHERE chain = ? AND network = ?'\n    ).run(params.chain, params.network);\n  }\n\n  db.prepare(`\n    INSERT OR REPLACE INTO wallets (\n      id, chain, network, address, label, is_primary, created_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    id,\n    params.chain,\n    params.network,\n    params.address.toLowerCase(),\n    params.label ?? null,\n    params.isPrimary ? 1 : 0,\n    now\n  );\n\n  return {\n    id,\n    chain: params.chain,\n    network: params.network,\n    address: params.address.toLowerCase(),\n    label: params.label,\n    is_primary: params.isPrimary ? 1 : 0,\n    created_at: now,\n  };\n}\n\nexport function getPrimaryWallet(chain: Chain, network: Network): Wallet | undefined {\n  const db = getDatabase();\n  return db.prepare(\n    'SELECT * FROM wallets WHERE chain = ? AND network = ? AND is_primary = 1'\n  ).get(chain, network) as Wallet | undefined;\n}\n\nexport function listWallets(params?: { chain?: Chain; network?: Network }): Wallet[] {\n  const db = getDatabase();\n\n  let query = 'SELECT * FROM wallets WHERE 1=1';\n  const values: any[] = [];\n\n  if (params?.chain) {\n    query += ' AND chain = ?';\n    values.push(params.chain);\n  }\n  if (params?.network) {\n    query += ' AND network = ?';\n    values.push(params.network);\n  }\n\n  query += ' ORDER BY is_primary DESC, created_at DESC';\n\n  return db.prepare(query).all(...values) as Wallet[];\n}\n\n// ============================================\n// Summary / Stats Operations\n// ============================================\n\nexport interface LedgerSummary {\n  totalExecutions: number;\n  confirmedExecutions: number;\n  failedExecutions: number;\n  successRate: number;\n  byChain: { chain: string; count: number; confirmed: number }[];\n  activeSessions: number;\n  trackedAssets: number;\n  registeredWallets: number;\n  recentExecutions: Execution[];\n}\n\nexport function getLedgerSummary(): LedgerSummary {\n  const db = getDatabase();\n\n  const totalExec = (db.prepare('SELECT COUNT(*) as count FROM executions').get() as any).count;\n  const confirmedExec = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status IN ('confirmed', 'finalized')\").get() as any).count;\n  const failedExec = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status = 'failed'\").get() as any).count;\n\n  const byChain = db.prepare(`\n    SELECT\n      chain,\n      COUNT(*) as count,\n      SUM(CASE WHEN status IN ('confirmed', 'finalized') THEN 1 ELSE 0 END) as confirmed\n    FROM executions\n    GROUP BY chain\n  `).all() as { chain: string; count: number; confirmed: number }[];\n\n  const activeSessions = (db.prepare(\"SELECT COUNT(*) as count FROM sessions WHERE status = 'active'\").get() as any).count;\n  const trackedAssets = (db.prepare('SELECT COUNT(*) as count FROM assets').get() as any).count;\n  const registeredWallets = (db.prepare('SELECT COUNT(*) as count FROM wallets').get() as any).count;\n\n  const recentExecutions = listExecutions({ limit: 10 });\n\n  return {\n    totalExecutions: totalExec,\n    confirmedExecutions: confirmedExec,\n    failedExecutions: failedExec,\n    successRate: totalExec > 0 ? (confirmedExec / totalExec) * 100 : 0,\n    byChain,\n    activeSessions,\n    trackedAssets,\n    registeredWallets,\n    recentExecutions,\n  };\n}\n\n/**\n * Get all confirmed transaction hashes for proof bundle\n */\nexport function getProofBundle(): {\n  ethereum: { txHash: string; explorerUrl: string; action: string; createdAt: number }[];\n  solana: { txHash: string; explorerUrl: string; action: string; createdAt: number }[];\n} {\n  const db = getDatabase();\n\n  const ethTxs = db.prepare(`\n    SELECT tx_hash, explorer_url, action, created_at\n    FROM executions\n    WHERE chain = 'ethereum' AND tx_hash IS NOT NULL AND status IN ('confirmed', 'finalized')\n    ORDER BY created_at DESC\n  `).all() as { tx_hash: string; explorer_url: string; action: string; created_at: number }[];\n\n  const solTxs = db.prepare(`\n    SELECT tx_hash, explorer_url, action, created_at\n    FROM executions\n    WHERE chain = 'solana' AND tx_hash IS NOT NULL AND status IN ('confirmed', 'finalized')\n    ORDER BY created_at DESC\n  `).all() as { tx_hash: string; explorer_url: string; action: string; created_at: number }[];\n\n  return {\n    ethereum: ethTxs.map(tx => ({\n      txHash: tx.tx_hash,\n      explorerUrl: tx.explorer_url,\n      action: tx.action,\n      createdAt: tx.created_at,\n    })),\n    solana: solTxs.map(tx => ({\n      txHash: tx.tx_hash,\n      explorerUrl: tx.explorer_url,\n      action: tx.action,\n      createdAt: tx.created_at,\n    })),\n  };\n}\n\n// ============================================\n// Execution Steps Operations\n// ============================================\n\nexport interface ExecutionStep {\n  id: string;\n  execution_id: string;\n  step_index: number;\n  action: string;\n  stage?: string;           // plan | route | execute | confirm\n  tx_hash?: string;\n  explorer_url?: string;\n  status: string;           // pending | ok | failed | skipped\n  error_code?: string;\n  error_message?: string;\n  created_at: number;\n}\n\nexport function createExecutionStep(params: {\n  executionId: string;\n  stepIndex: number;\n  action: string;\n  stage?: string;\n}): ExecutionStep {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO execution_steps (\n      id, execution_id, step_index, action, stage, status, created_at\n    ) VALUES (?, ?, ?, ?, ?, 'pending', ?)\n  `).run(id, params.executionId, params.stepIndex, params.action, params.stage ?? null, now);\n\n  return {\n    id,\n    execution_id: params.executionId,\n    step_index: params.stepIndex,\n    action: params.action,\n    stage: params.stage,\n    status: 'pending',\n    created_at: now,\n  };\n}\n\nexport function updateExecutionStep(\n  id: string,\n  updates: Partial<{\n    status: string;\n    stage: string;\n    txHash: string;\n    explorerUrl: string;\n    errorCode: string;\n    errorMessage: string;\n  }>\n): void {\n  const db = getDatabase();\n  const sets: string[] = [];\n  const values: any[] = [];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.stage !== undefined) {\n    sets.push('stage = ?');\n    values.push(updates.stage);\n  }\n  if (updates.txHash !== undefined) {\n    sets.push('tx_hash = ?');\n    values.push(updates.txHash);\n  }\n  if (updates.explorerUrl !== undefined) {\n    sets.push('explorer_url = ?');\n    values.push(updates.explorerUrl);\n  }\n  if (updates.errorCode !== undefined) {\n    sets.push('error_code = ?');\n    values.push(updates.errorCode);\n  }\n  if (updates.errorMessage !== undefined) {\n    sets.push('error_message = ?');\n    values.push(updates.errorMessage);\n  }\n\n  if (sets.length === 0) return;\n  values.push(id);\n  db.prepare(`UPDATE execution_steps SET ${sets.join(', ')} WHERE id = ?`).run(...values);\n}\n\nexport function getExecutionSteps(executionId: string): ExecutionStep[] {\n  const db = getDatabase();\n  return db.prepare(\n    'SELECT * FROM execution_steps WHERE execution_id = ? ORDER BY step_index'\n  ).all(executionId) as ExecutionStep[];\n}\n\n// ============================================\n// Stats Dashboard Operations\n// ============================================\n\nexport interface StatsSummary {\n  totalExecutions: number;\n  successfulExecutions: number;\n  failedExecutions: number;\n  successRate: number; // Legacy field (same as successRateRaw)\n  successRateRaw: number; // Raw success rate (includes infra failures)\n  successRateAdjusted: number; // Success rate excluding RPC/infra failures\n  uniqueWallets: number; // Unique wallet addresses\n  totalUsdRouted: number;\n  relayedTxCount: number;\n  chainsActive: string[];\n  byKind: { kind: string; count: number; usdTotal: number }[];\n  byVenue: { venue: string; count: number; usdTotal: number }[];\n  byChain: { chain: string; network: string; count: number; successCount: number; failedCount: number }[];\n  avgLatencyMs: number;\n  lastExecutionAt: number | null;\n}\n\nexport function getSummaryStats(): StatsSummary {\n  const db = getDatabase();\n\n  // Basic counts\n  const totalExec = (db.prepare('SELECT COUNT(*) as count FROM executions').get() as any).count;\n  const successExec = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status IN ('confirmed', 'finalized')\").get() as any).count;\n  const failedExec = (db.prepare(\"SELECT COUNT(*) as count FROM executions WHERE status = 'failed'\").get() as any).count;\n\n  // Total USD routed (sum of usd_estimate for successful executions)\n  const usdResult = db.prepare(`\n    SELECT COALESCE(SUM(usd_estimate), 0) as total\n    FROM executions\n    WHERE status IN ('confirmed', 'finalized') AND usd_estimate IS NOT NULL\n  `).get() as { total: number };\n  const totalUsdRouted = usdResult.total;\n\n  // Relayed transactions (have relayer_address set)\n  const relayedCount = (db.prepare(`\n    SELECT COUNT(*) as count FROM executions WHERE relayer_address IS NOT NULL\n  `).get() as any).count;\n\n  // Unique chains active\n  const chainsResult = db.prepare(`\n    SELECT DISTINCT chain FROM executions\n  `).all() as { chain: string }[];\n  const chainsActive = chainsResult.map(r => r.chain);\n\n  // Breakdown by kind\n  const byKind = db.prepare(`\n    SELECT\n      COALESCE(kind, 'unknown') as kind,\n      COUNT(*) as count,\n      COALESCE(SUM(CASE WHEN status IN ('confirmed', 'finalized') THEN usd_estimate ELSE 0 END), 0) as usdTotal\n    FROM executions\n    GROUP BY kind\n    ORDER BY count DESC\n  `).all() as { kind: string; count: number; usdTotal: number }[];\n\n  // Breakdown by venue\n  const byVenue = db.prepare(`\n    SELECT\n      COALESCE(venue, 'unknown') as venue,\n      COUNT(*) as count,\n      COALESCE(SUM(CASE WHEN status IN ('confirmed', 'finalized') THEN usd_estimate ELSE 0 END), 0) as usdTotal\n    FROM executions\n    GROUP BY venue\n    ORDER BY count DESC\n  `).all() as { venue: string; count: number; usdTotal: number }[];\n\n  // Breakdown by chain/network\n  const byChain = db.prepare(`\n    SELECT\n      chain,\n      network,\n      COUNT(*) as count,\n      SUM(CASE WHEN status IN ('confirmed', 'finalized') THEN 1 ELSE 0 END) as successCount,\n      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failedCount\n    FROM executions\n    GROUP BY chain, network\n    ORDER BY count DESC\n  `).all() as { chain: string; network: string; count: number; successCount: number; failedCount: number }[];\n\n  // Average latency\n  const latencyResult = db.prepare(`\n    SELECT AVG(latency_ms) as avgLatency\n    FROM executions\n    WHERE latency_ms IS NOT NULL\n  `).get() as { avgLatency: number | null };\n  const avgLatencyMs = latencyResult.avgLatency ?? 0;\n\n  // Last execution timestamp\n  const lastExecResult = db.prepare(`\n    SELECT MAX(created_at) as lastAt FROM executions\n  `).get() as { lastAt: number | null };\n\n  // Unique wallets\n  const uniqueWalletsResult = db.prepare(`\n    SELECT COUNT(DISTINCT from_address) as count FROM executions WHERE from_address IS NOT NULL\n  `).get() as { count: number };\n  const uniqueWallets = uniqueWalletsResult.count;\n\n  // Calculate raw success rate (includes all failures)\n  const successRateRaw = totalExec > 0 ? (successExec / totalExec) * 100 : 0;\n\n  // Calculate adjusted success rate (excludes RPC/infra failures)\n  // Count failures that are NOT due to RPC/infra issues\n  const nonInfraFailedExec = (db.prepare(`\n    SELECT COUNT(*) as count FROM executions\n    WHERE status = 'failed'\n    AND error_code NOT IN ('RPC_RATE_LIMITED', 'RPC_UNAVAILABLE', 'RPC_ERROR')\n    AND error_code IS NOT NULL\n  `).get() as any).count;\n\n  // Total executions minus RPC/infra failures\n  const rpcInfraFailed = failedExec - nonInfraFailedExec;\n  const adjustedTotal = totalExec - rpcInfraFailed;\n  const successRateAdjusted = adjustedTotal > 0 ? (successExec / adjustedTotal) * 100 : successRateRaw;\n\n  return {\n    totalExecutions: totalExec,\n    successfulExecutions: successExec,\n    failedExecutions: failedExec,\n    successRate: successRateRaw, // Legacy field (same as successRateRaw)\n    successRateRaw,\n    successRateAdjusted,\n    uniqueWallets,\n    totalUsdRouted,\n    relayedTxCount: relayedCount,\n    chainsActive,\n    byKind,\n    byVenue,\n    byChain,\n    avgLatencyMs: Math.round(avgLatencyMs),\n    lastExecutionAt: lastExecResult.lastAt,\n  };\n}\n\nexport function getRecentExecutions(limit: number = 20): Execution[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM executions\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(limit) as Execution[];\n}\n\n// ============================================\n// Intent Operations\n// ============================================\n\nexport type IntentKind = 'perp' | 'deposit' | 'swap' | 'bridge' | 'unknown';\nexport type IntentStatus = 'queued' | 'planned' | 'routed' | 'executing' | 'confirmed' | 'failed';\nexport type IntentFailureStage = 'plan' | 'route' | 'execute' | 'confirm' | 'quote';\n\nexport interface Intent {\n  id: string;\n  created_at: number;\n  intent_text: string;\n  intent_kind?: IntentKind;\n  requested_chain?: string;\n  requested_venue?: string;\n  usd_estimate?: number;\n  status: IntentStatus;\n  planned_at?: number;\n  executed_at?: number;\n  confirmed_at?: number;\n  failure_stage?: IntentFailureStage;\n  error_code?: string;\n  error_message?: string;\n  metadata_json?: string;\n}\n\nexport function createIntent(params: {\n  intentText: string;\n  intentKind?: IntentKind;\n  requestedChain?: string;\n  requestedVenue?: string;\n  usdEstimate?: number;\n  metadataJson?: string;\n}): Intent {\n  const db = getDatabase();\n  const id = randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO intents (\n      id, created_at, intent_text, intent_kind, requested_chain, requested_venue,\n      usd_estimate, status, metadata_json\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, 'queued', ?)\n  `).run(\n    id,\n    now,\n    params.intentText,\n    params.intentKind ?? null,\n    params.requestedChain ?? null,\n    params.requestedVenue ?? null,\n    params.usdEstimate ?? null,\n    params.metadataJson ?? null\n  );\n\n  return {\n    id,\n    created_at: now,\n    intent_text: params.intentText,\n    intent_kind: params.intentKind,\n    requested_chain: params.requestedChain,\n    requested_venue: params.requestedVenue,\n    usd_estimate: params.usdEstimate,\n    status: 'queued',\n    metadata_json: params.metadataJson,\n  };\n}\n\nexport function updateIntentStatus(\n  id: string,\n  updates: Partial<{\n    status: IntentStatus;\n    intentKind: IntentKind;\n    requestedChain: string;\n    requestedVenue: string;\n    usdEstimate: number;\n    plannedAt: number;\n    executedAt: number;\n    confirmedAt: number;\n    failureStage: IntentFailureStage;\n    errorCode: string;\n    errorMessage: string;\n    metadataJson: string;\n  }>\n): void {\n  const db = getDatabase();\n  const sets: string[] = [];\n  const values: any[] = [];\n\n  if (updates.status !== undefined) {\n    sets.push('status = ?');\n    values.push(updates.status);\n  }\n  if (updates.intentKind !== undefined) {\n    sets.push('intent_kind = ?');\n    values.push(updates.intentKind);\n  }\n  if (updates.requestedChain !== undefined) {\n    sets.push('requested_chain = ?');\n    values.push(updates.requestedChain);\n  }\n  if (updates.requestedVenue !== undefined) {\n    sets.push('requested_venue = ?');\n    values.push(updates.requestedVenue);\n  }\n  if (updates.usdEstimate !== undefined) {\n    sets.push('usd_estimate = ?');\n    values.push(updates.usdEstimate);\n  }\n  if (updates.plannedAt !== undefined) {\n    sets.push('planned_at = ?');\n    values.push(updates.plannedAt);\n  }\n  if (updates.executedAt !== undefined) {\n    sets.push('executed_at = ?');\n    values.push(updates.executedAt);\n  }\n  if (updates.confirmedAt !== undefined) {\n    sets.push('confirmed_at = ?');\n    values.push(updates.confirmedAt);\n  }\n  if (updates.failureStage !== undefined) {\n    sets.push('failure_stage = ?');\n    values.push(updates.failureStage);\n  }\n  if (updates.errorCode !== undefined) {\n    sets.push('error_code = ?');\n    values.push(updates.errorCode);\n  }\n  if (updates.errorMessage !== undefined) {\n    sets.push('error_message = ?');\n    values.push(updates.errorMessage?.slice(0, 500)); // Truncate\n  }\n  if (updates.metadataJson !== undefined) {\n    sets.push('metadata_json = ?');\n    values.push(updates.metadataJson);\n  }\n\n  if (sets.length === 0) return;\n  values.push(id);\n  db.prepare(`UPDATE intents SET ${sets.join(', ')} WHERE id = ?`).run(...values);\n}\n\nexport function getIntent(id: string): Intent | undefined {\n  const db = getDatabase();\n  return db.prepare('SELECT * FROM intents WHERE id = ?').get(id) as Intent | undefined;\n}\n\nexport function getRecentIntents(limit: number = 50): Intent[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM intents\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(limit) as Intent[];\n}\n\nexport interface IntentStatsSummary {\n  totalIntents: number;\n  confirmedIntents: number;\n  failedIntents: number;\n  intentSuccessRate: number;\n  byKind: { kind: string; count: number; confirmed: number; failed: number }[];\n  byStatus: { status: string; count: number }[];\n  failuresByStage: { stage: string; count: number }[];\n  failuresByCode: { code: string; count: number }[];\n  recentIntents: Intent[];\n}\n\nexport function getIntentStatsSummary(): IntentStatsSummary {\n  const db = getDatabase();\n\n  // Basic counts\n  const totalIntents = (db.prepare('SELECT COUNT(*) as count FROM intents').get() as any).count;\n  const confirmedIntents = (db.prepare(\"SELECT COUNT(*) as count FROM intents WHERE status = 'confirmed'\").get() as any).count;\n  const failedIntents = (db.prepare(\"SELECT COUNT(*) as count FROM intents WHERE status = 'failed'\").get() as any).count;\n\n  // By kind\n  const byKind = db.prepare(`\n    SELECT\n      COALESCE(intent_kind, 'unknown') as kind,\n      COUNT(*) as count,\n      SUM(CASE WHEN status = 'confirmed' THEN 1 ELSE 0 END) as confirmed,\n      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed\n    FROM intents\n    GROUP BY intent_kind\n    ORDER BY count DESC\n  `).all() as { kind: string; count: number; confirmed: number; failed: number }[];\n\n  // By status\n  const byStatus = db.prepare(`\n    SELECT status, COUNT(*) as count\n    FROM intents\n    GROUP BY status\n    ORDER BY count DESC\n  `).all() as { status: string; count: number }[];\n\n  // Failures by stage\n  const failuresByStage = db.prepare(`\n    SELECT failure_stage as stage, COUNT(*) as count\n    FROM intents\n    WHERE failure_stage IS NOT NULL\n    GROUP BY failure_stage\n    ORDER BY count DESC\n  `).all() as { stage: string; count: number }[];\n\n  // Failures by code\n  const failuresByCode = db.prepare(`\n    SELECT COALESCE(error_code, 'UNKNOWN') as code, COUNT(*) as count\n    FROM intents\n    WHERE status = 'failed'\n    GROUP BY error_code\n    ORDER BY count DESC\n    LIMIT 10\n  `).all() as { code: string; count: number }[];\n\n  const recentIntents = getRecentIntents(10);\n\n  // Calculate success rate (exclude queued/in-progress)\n  const attemptedIntents = confirmedIntents + failedIntents;\n  const intentSuccessRate = attemptedIntents > 0 ? (confirmedIntents / attemptedIntents) * 100 : 0;\n\n  return {\n    totalIntents,\n    confirmedIntents,\n    failedIntents,\n    intentSuccessRate,\n    byKind,\n    byStatus,\n    failuresByStage,\n    failuresByCode,\n    recentIntents,\n  };\n}\n\nexport function linkExecutionToIntent(executionId: string, intentId: string): void {\n  const db = getDatabase();\n  // Add intent_id column if it doesn't exist (migration)\n  try {\n    db.exec('ALTER TABLE executions ADD COLUMN intent_id TEXT');\n  } catch (e: any) {\n    // Column already exists\n  }\n\n  db.prepare('UPDATE executions SET intent_id = ? WHERE id = ?').run(intentId, executionId);\n}\n\nexport function getExecutionsForIntent(intentId: string): Execution[] {\n  const db = getDatabase();\n  // Check if intent_id column exists\n  try {\n    return db.prepare(`\n      SELECT * FROM executions\n      WHERE intent_id = ?\n      ORDER BY created_at DESC\n    `).all(intentId) as Execution[];\n  } catch (e) {\n    return [];\n  }\n}\n\n// Updated getSummaryStats to include intent metrics\nexport function getSummaryStatsWithIntents(): StatsSummary & {\n  totalIntents: number;\n  intentSuccessRate: number;\n  failedIntentsByStage: { stage: string; count: number }[];\n} {\n  const baseStats = getSummaryStats();\n  const intentStats = getIntentStatsSummary();\n\n  return {\n    ...baseStats,\n    totalIntents: intentStats.totalIntents,\n    intentSuccessRate: intentStats.intentSuccessRate,\n    failedIntentsByStage: intentStats.failuresByStage,\n  };\n}\n\n// ============================================\n// Positions table operations\n// ============================================\n\nexport interface Position {\n  id: string;\n  chain: 'ethereum' | 'solana';\n  network: string;\n  venue: string;\n  market: string;\n  side: 'long' | 'short';\n  leverage?: number;\n  margin_units?: string;\n  margin_display?: string;\n  size_units?: string;\n  entry_price?: string;\n  status: 'open' | 'closed' | 'liquidated';\n  opened_at: number;\n  closed_at?: number;\n  open_tx_hash?: string;\n  open_explorer_url?: string;\n  close_tx_hash?: string;\n  close_explorer_url?: string;\n  pnl?: string;\n  user_address: string;\n  on_chain_position_id?: string;\n  intent_id?: string;\n  execution_id?: string;\n  created_at: number;\n  updated_at: number;\n}\n\nexport interface CreatePositionInput {\n  chain: 'ethereum' | 'solana';\n  network: string;\n  venue: string;\n  market: string;\n  side: 'long' | 'short';\n  leverage?: number;\n  margin_units?: string;\n  margin_display?: string;\n  size_units?: string;\n  entry_price?: string;\n  open_tx_hash?: string;\n  open_explorer_url?: string;\n  user_address: string;\n  on_chain_position_id?: string;\n  intent_id?: string;\n  execution_id?: string;\n}\n\nexport function createPosition(input: CreatePositionInput): Position {\n  const db = getDatabase();\n  const id = crypto.randomUUID();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO positions (\n      id, chain, network, venue, market, side, leverage,\n      margin_units, margin_display, size_units, entry_price,\n      status, opened_at, open_tx_hash, open_explorer_url,\n      user_address, on_chain_position_id, intent_id, execution_id,\n      created_at, updated_at\n    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'open', ?, ?, ?, ?, ?, ?, ?, ?, ?)\n  `).run(\n    id,\n    input.chain,\n    input.network,\n    input.venue,\n    input.market,\n    input.side,\n    input.leverage ?? null,\n    input.margin_units ?? null,\n    input.margin_display ?? null,\n    input.size_units ?? null,\n    input.entry_price ?? null,\n    now,\n    input.open_tx_hash ?? null,\n    input.open_explorer_url ?? null,\n    input.user_address,\n    input.on_chain_position_id ?? null,\n    input.intent_id ?? null,\n    input.execution_id ?? null,\n    now,\n    now\n  );\n\n  return getPosition(id)!;\n}\n\nexport function getPosition(id: string): Position | null {\n  const db = getDatabase();\n  const row = db.prepare('SELECT * FROM positions WHERE id = ?').get(id) as Position | undefined;\n  return row ?? null;\n}\n\nexport function getPositionByOnChainId(\n  chain: string,\n  network: string,\n  venue: string,\n  onChainPositionId: string\n): Position | null {\n  const db = getDatabase();\n  const row = db.prepare(`\n    SELECT * FROM positions\n    WHERE chain = ? AND network = ? AND venue = ? AND on_chain_position_id = ?\n  `).get(chain, network, venue, onChainPositionId) as Position | undefined;\n  return row ?? null;\n}\n\nexport function updatePosition(id: string, updates: Partial<Omit<Position, 'id' | 'created_at'>>): void {\n  const db = getDatabase();\n  const setClauses: string[] = [];\n  const values: any[] = [];\n\n  for (const [key, value] of Object.entries(updates)) {\n    if (value !== undefined) {\n      setClauses.push(`${key} = ?`);\n      values.push(value);\n    }\n  }\n\n  if (setClauses.length === 0) return;\n\n  setClauses.push('updated_at = ?');\n  values.push(Math.floor(Date.now() / 1000));\n  values.push(id);\n\n  db.prepare(`UPDATE positions SET ${setClauses.join(', ')} WHERE id = ?`).run(...values);\n}\n\nexport function closePosition(\n  id: string,\n  closeTxHash: string,\n  closeExplorerUrl: string,\n  pnl?: string,\n  status: 'closed' | 'liquidated' = 'closed'\n): void {\n  const db = getDatabase();\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    UPDATE positions SET\n      status = ?,\n      closed_at = ?,\n      close_tx_hash = ?,\n      close_explorer_url = ?,\n      pnl = ?,\n      updated_at = ?\n    WHERE id = ?\n  `).run(status, now, closeTxHash, closeExplorerUrl, pnl ?? null, now, id);\n}\n\nexport function getOpenPositions(filters?: {\n  chain?: string;\n  network?: string;\n  venue?: string;\n  user_address?: string;\n}): Position[] {\n  const db = getDatabase();\n  let sql = 'SELECT * FROM positions WHERE status = ?';\n  const params: any[] = ['open'];\n\n  if (filters?.chain) {\n    sql += ' AND chain = ?';\n    params.push(filters.chain);\n  }\n  if (filters?.network) {\n    sql += ' AND network = ?';\n    params.push(filters.network);\n  }\n  if (filters?.venue) {\n    sql += ' AND venue = ?';\n    params.push(filters.venue);\n  }\n  if (filters?.user_address) {\n    sql += ' AND user_address = ?';\n    params.push(filters.user_address);\n  }\n\n  sql += ' ORDER BY opened_at DESC';\n\n  return db.prepare(sql).all(...params) as Position[];\n}\n\nexport function getRecentPositions(limit: number = 20): Position[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM positions\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(limit) as Position[];\n}\n\nexport function getPositionsByStatus(status: 'open' | 'closed' | 'liquidated', limit: number = 50): Position[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM positions\n    WHERE status = ?\n    ORDER BY created_at DESC\n    LIMIT ?\n  `).all(status, limit) as Position[];\n}\n\nexport function getPositionStats(): {\n  total: number;\n  open: number;\n  closed: number;\n  liquidated: number;\n  byMarket: { market: string; count: number }[];\n} {\n  const db = getDatabase();\n\n  const total = (db.prepare('SELECT COUNT(*) as count FROM positions').get() as any).count;\n  const open = (db.prepare('SELECT COUNT(*) as count FROM positions WHERE status = ?').get('open') as any).count;\n  const closed = (db.prepare('SELECT COUNT(*) as count FROM positions WHERE status = ?').get('closed') as any).count;\n  const liquidated = (db.prepare('SELECT COUNT(*) as count FROM positions WHERE status = ?').get('liquidated') as any).count;\n\n  const byMarket = db.prepare(`\n    SELECT market, COUNT(*) as count FROM positions\n    GROUP BY market ORDER BY count DESC\n  `).all() as { market: string; count: number }[];\n\n  return { total, open, closed, liquidated, byMarket };\n}\n\n// ============================================\n// Indexer state operations\n// ============================================\n\nexport interface IndexerState {\n  id: string;\n  chain: string;\n  network: string;\n  contract_address: string;\n  last_indexed_block: number;\n  updated_at: number;\n}\n\nexport function getIndexerState(chain: string, network: string, contractAddress: string): IndexerState | null {\n  const db = getDatabase();\n  const row = db.prepare(`\n    SELECT * FROM indexer_state\n    WHERE chain = ? AND network = ? AND contract_address = ?\n  `).get(chain, network, contractAddress) as IndexerState | undefined;\n  return row ?? null;\n}\n\nexport function upsertIndexerState(chain: string, network: string, contractAddress: string, lastIndexedBlock: number): void {\n  const db = getDatabase();\n  const id = `${chain}:${network}:${contractAddress}`;\n  const now = Math.floor(Date.now() / 1000);\n\n  db.prepare(`\n    INSERT INTO indexer_state (id, chain, network, contract_address, last_indexed_block, updated_at)\n    VALUES (?, ?, ?, ?, ?, ?)\n    ON CONFLICT(chain, network, contract_address)\n    DO UPDATE SET last_indexed_block = ?, updated_at = ?\n  `).run(id, chain, network, contractAddress, lastIndexedBlock, now, lastIndexedBlock, now);\n}\n\n// ============================================\n// Waitlist operations\n// ============================================\n\nexport interface WaitlistEntry {\n  id: string;\n  email?: string;\n  wallet_address?: string;\n  created_at: number;\n  source?: string;\n  metadata_json?: string;\n}\n\nexport function addToWaitlist(params: {\n  email?: string;\n  walletAddress?: string;\n  source?: string;\n  metadata?: Record<string, any>;\n}): string {\n  const db = getDatabase();\n  const id = `wl_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n  const now = Math.floor(Date.now() / 1000);\n\n  // Create waitlist table if it doesn't exist (migration safety)\n  db.exec(`\n    CREATE TABLE IF NOT EXISTS waitlist (\n      id TEXT PRIMARY KEY,\n      email TEXT,\n      wallet_address TEXT,\n      created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),\n      source TEXT DEFAULT 'landing',\n      metadata_json TEXT,\n      CONSTRAINT email_or_wallet CHECK (email IS NOT NULL OR wallet_address IS NOT NULL)\n    )\n  `);\n\n  db.prepare(`\n    INSERT INTO waitlist (id, email, wallet_address, created_at, source, metadata_json)\n    VALUES (?, ?, ?, ?, ?, ?)\n  `).run(\n    id,\n    params.email || null,\n    params.walletAddress || null,\n    now,\n    params.source || 'landing',\n    params.metadata ? JSON.stringify(params.metadata) : null\n  );\n\n  return id;\n}\n\nexport function getWaitlistEntries(limit: number = 100): WaitlistEntry[] {\n  const db = getDatabase();\n  return db.prepare(`\n    SELECT * FROM waitlist ORDER BY created_at DESC LIMIT ?\n  `).all(limit) as WaitlistEntry[];\n}\n\nexport function getWaitlistCount(): number {\n  const db = getDatabase();\n  const row = db.prepare('SELECT COUNT(*) as count FROM waitlist').get() as { count: number };\n  return row?.count || 0;\n}\n\n// ============================================\n// Aliases for API compatibility\n// ============================================\n\n// Alias for getSummaryStats\nexport const getStatsSummary = getSummaryStats;\n\n// Alias for getIntentStatsSummary\nexport const getIntentStats = getIntentStatsSummary;\n", "/**\n * Execution Ledger Wrapper\n * Convenience module for recording executions to the ledger\n *\n * Uses dynamic imports to avoid TypeScript rootDir issues\n * (execution-ledger is outside src directory like telemetry)\n *\n * Usage:\n *   import { recordExecution, updateLedgerExecution } from './ledger/ledger';\n *\n *   // Record a new execution\n *   const execId = await recordExecution({\n *     chain: 'ethereum',\n *     network: 'sepolia',\n *     intent: 'Supply 0.01 WETH to Aave',\n *     action: 'lend_supply',\n *     fromAddress: '0x...',\n *     token: 'WETH',\n *     amountUnits: '10000000000000000',\n *     amountDisplay: '0.01 WETH',\n *   });\n *\n *   // Update after confirmation\n *   await updateLedgerExecution(execId, {\n *     status: 'confirmed',\n *     txHash: '0x...',\n *     explorerUrl: 'https://sepolia.etherscan.io/tx/0x...',\n *   });\n */\n\n// Type definitions (copied to avoid import issues)\nexport type Chain = 'ethereum' | 'solana';\nexport type Network = 'sepolia' | 'devnet' | 'mainnet';\nexport type ExecutionStatus = 'pending' | 'submitted' | 'confirmed' | 'finalized' | 'failed';\nexport type ExecutionKind = 'perp' | 'deposit' | 'bridge' | 'swap' | 'proof' | 'relay' | 'transfer';\nexport type ExecutionVenue =\n  | 'drift' | 'hl' | 'hyperliquid' | 'perp_demo'\n  | 'aave' | 'kamino' | 'deposit_demo'\n  | 'lifi' | 'wormhole' | 'bridge_demo'\n  | 'uniswap' | 'jupiter' | 'swap_demo'\n  | 'native';\n\nexport interface RecordExecutionParams {\n  chain: Chain;\n  network: Network;\n  kind?: ExecutionKind;\n  venue?: ExecutionVenue;\n  intent: string;\n  action: string;\n  fromAddress: string;\n  toAddress?: string;\n  token?: string;\n  amountUnits?: string;\n  amountDisplay?: string;\n  usdEstimate?: number;\n  usdEstimateIsEstimate?: boolean;\n  relayerAddress?: string;\n  sessionId?: string;\n}\n\nexport interface ExecutionUpdateParams {\n  status?: ExecutionStatus;\n  kind?: ExecutionKind;\n  venue?: ExecutionVenue;\n  txHash?: string;\n  explorerUrl?: string;\n  errorCode?: string;\n  errorMessage?: string;\n  gasUsed?: string;\n  blockNumber?: number;\n  latencyMs?: number;\n  usdEstimate?: number;\n  usdEstimateIsEstimate?: boolean;\n  relayerAddress?: string;\n  sessionId?: string;\n}\n\n// Lazy-loaded ledger module (use any to avoid rootDir issues with typeof import)\nlet ledgerDb: any = null;\n\nasync function getLedgerDb() {\n  if (!ledgerDb) {\n    try {\n      ledgerDb = await import('../../execution-ledger/db');\n    } catch (error) {\n      console.warn('[ledger] Execution ledger DB not available:', error);\n      throw error;\n    }\n  }\n  return ledgerDb;\n}\n\n/**\n * Record a new execution to the ledger\n * Returns the execution ID for later updates\n */\nexport async function recordExecution(params: RecordExecutionParams): Promise<string> {\n  const db = await getLedgerDb();\n\n  const exec = db.createExecution({\n    chain: params.chain,\n    network: params.network,\n    kind: params.kind,\n    venue: params.venue,\n    intent: params.intent,\n    action: params.action,\n    fromAddress: params.fromAddress,\n    toAddress: params.toAddress,\n    token: params.token,\n    amountUnits: params.amountUnits,\n    amountDisplay: params.amountDisplay,\n    usdEstimate: params.usdEstimate,\n    usdEstimateIsEstimate: params.usdEstimateIsEstimate,\n    relayerAddress: params.relayerAddress,\n    sessionId: params.sessionId,\n  });\n\n  return exec.id;\n}\n\n/**\n * Update an existing execution in the ledger\n */\nexport async function updateLedgerExecution(\n  id: string,\n  updates: ExecutionUpdateParams\n): Promise<void> {\n  const db = await getLedgerDb();\n  db.updateExecution(id, updates);\n}\n\n/**\n * Get the ledger summary\n */\nexport async function getLedgerSummary() {\n  const db = await getLedgerDb();\n  return db.getLedgerSummary();\n}\n\n/**\n * Get the proof bundle\n */\nexport async function getProofBundle() {\n  const db = await getLedgerDb();\n  return db.getProofBundle();\n}\n\n/**\n * Register a wallet in the ledger\n */\nexport async function registerWallet(params: {\n  chain: Chain;\n  network: Network;\n  address: string;\n  label?: string;\n  isPrimary?: boolean;\n}) {\n  const db = await getLedgerDb();\n  return db.registerWallet(params);\n}\n\n/**\n * Build explorer URL based on chain/network\n */\nexport function buildExplorerUrl(\n  chain: Chain,\n  network: Network,\n  txHash: string\n): string {\n  if (chain === 'ethereum') {\n    if (network === 'sepolia') {\n      return `https://sepolia.etherscan.io/tx/${txHash}`;\n    } else if (network === 'mainnet') {\n      return `https://etherscan.io/tx/${txHash}`;\n    }\n  } else if (chain === 'solana') {\n    if (network === 'devnet') {\n      return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;\n    } else if (network === 'mainnet') {\n      return `https://explorer.solana.com/tx/${txHash}`;\n    }\n  }\n  return '';\n}\n\n/**\n * Record execution with immediate result update\n * Convenience wrapper for record + update in one call\n */\nexport async function recordExecutionWithResult(\n  params: RecordExecutionParams,\n  result: {\n    success: boolean;\n    txHash?: string;\n    blockNumber?: number;\n    gasUsed?: string;\n    latencyMs?: number;\n    errorCode?: string;\n    errorMessage?: string;\n  }\n): Promise<string> {\n  const execId = await recordExecution(params);\n\n  const explorerUrl = result.txHash\n    ? buildExplorerUrl(params.chain, params.network, result.txHash)\n    : undefined;\n\n  await updateLedgerExecution(execId, {\n    status: result.success ? 'confirmed' : 'failed',\n    txHash: result.txHash,\n    explorerUrl,\n    blockNumber: result.blockNumber,\n    gasUsed: result.gasUsed,\n    latencyMs: result.latencyMs,\n    errorCode: result.errorCode,\n    errorMessage: result.errorMessage,\n  });\n\n  return execId;\n}\n\n// ============================================================================\n// Position Management (for indexer and intent runner)\n// ============================================================================\n\nexport interface PositionParams {\n  chain: Chain;\n  network: Network;\n  venue: string;\n  market: string;\n  side: 'long' | 'short';\n  leverage?: number;\n  margin_units?: string;\n  margin_display?: string;\n  size_units?: string;\n  entry_price?: string;\n  open_tx_hash?: string;\n  open_explorer_url?: string;\n  user_address: string;\n  on_chain_position_id?: string;\n  intent_id?: string;\n  execution_id?: string;\n}\n\nexport interface Position {\n  id: string;\n  chain: Chain;\n  network: Network;\n  venue: string;\n  market: string;\n  side: 'long' | 'short';\n  leverage?: number;\n  margin_units?: string;\n  margin_display?: string;\n  size_units?: string;\n  entry_price?: string;\n  status: 'open' | 'closed' | 'liquidated';\n  opened_at: number;\n  closed_at?: number;\n  open_tx_hash?: string;\n  open_explorer_url?: string;\n  close_tx_hash?: string;\n  close_explorer_url?: string;\n  pnl?: string;\n  user_address: string;\n  on_chain_position_id?: string;\n  intent_id?: string;\n  execution_id?: string;\n}\n\n/**\n * Create a new position in the ledger\n */\nexport async function createPosition(params: PositionParams): Promise<Position> {\n  const db = await getLedgerDb();\n  return db.createPosition(params) as Position;\n}\n\n/**\n * Get position by ID\n */\nexport async function getPosition(id: string): Promise<Position | null> {\n  const db = await getLedgerDb();\n  return db.getPosition(id) as Position | null;\n}\n\n/**\n * Get position by on-chain ID\n */\nexport async function getPositionByOnChainId(\n  chain: Chain,\n  network: Network,\n  venue: string,\n  onChainId: string\n): Promise<Position | null> {\n  const db = await getLedgerDb();\n  return db.getPositionByOnChainId(chain, network, venue, onChainId) as Position | null;\n}\n\n/**\n * Update a position\n */\nexport async function updatePosition(\n  id: string,\n  updates: Partial<Omit<Position, 'id' | 'chain' | 'network' | 'venue'>>\n): Promise<void> {\n  const db = await getLedgerDb();\n  db.updatePosition(id, updates);\n}\n\n/**\n * Close a position\n */\nexport async function closePosition(\n  id: string,\n  txHash: string,\n  explorerUrl: string,\n  pnl: string,\n  status: 'closed' | 'liquidated' = 'closed'\n): Promise<void> {\n  const db = await getLedgerDb();\n  db.closePosition(id, txHash, explorerUrl, pnl, status);\n}\n\n/**\n * Get all open positions\n */\nexport async function getOpenPositions(chain?: Chain, network?: Network): Promise<Position[]> {\n  const db = await getLedgerDb();\n  return db.getOpenPositions(chain, network) as Position[];\n}\n\n/**\n * Get recent positions\n */\nexport async function getRecentPositions(limit?: number): Promise<Position[]> {\n  const db = await getLedgerDb();\n  return db.getRecentPositions(limit) as Position[];\n}\n\n/**\n * Get position stats\n */\nexport async function getPositionStats() {\n  const db = await getLedgerDb();\n  return db.getPositionStats();\n}\n\n// ============================================================================\n// Indexer State Management\n// ============================================================================\n\nexport interface IndexerState {\n  id: string;\n  chain: Chain;\n  network: Network;\n  contract_address: string;\n  last_indexed_block: number;\n  updated_at: number;\n}\n\n/**\n * Get indexer state for a contract\n */\nexport async function getIndexerState(\n  chain: Chain,\n  network: Network,\n  contractAddress: string\n): Promise<IndexerState | null> {\n  const db = await getLedgerDb();\n  return db.getIndexerState(chain, network, contractAddress) as IndexerState | null;\n}\n\n/**\n * Update or create indexer state\n */\nexport async function upsertIndexerState(\n  chain: Chain,\n  network: Network,\n  contractAddress: string,\n  lastIndexedBlock: number\n): Promise<void> {\n  const db = await getLedgerDb();\n  db.upsertIndexerState(chain, network, contractAddress, lastIndexedBlock);\n}\n\n// ============================================================================\n// Execution Steps\n// ============================================================================\n\nexport interface ExecutionStepParams {\n  executionId: string;\n  stepIndex: number;\n  action: string;\n  stage?: string;\n}\n\n/**\n * Create an execution step\n */\nexport async function createExecutionStep(params: ExecutionStepParams) {\n  const db = await getLedgerDb();\n  return db.createExecutionStep(params);\n}\n\n/**\n * Update an execution step\n */\nexport async function updateExecutionStep(\n  id: string,\n  updates: Partial<{\n    status: string;\n    stage: string;\n    txHash: string;\n    explorerUrl: string;\n    errorCode: string;\n    errorMessage: string;\n  }>\n) {\n  const db = await getLedgerDb();\n  db.updateExecutionStep(id, updates);\n}\n\n/**\n * Get execution steps for an execution\n */\nexport async function getExecutionSteps(executionId: string) {\n  const db = await getLedgerDb();\n  return db.getExecutionSteps(executionId);\n}\n", "/**\n * Perp Position Indexer\n *\n * Watches DemoPerpEngine + DemoPerpAdapter events on Sepolia\n * and syncs position state to the ledger database.\n *\n * Events indexed:\n * - PositionOpened (DemoPerpEngine)\n * - PositionClosed (DemoPerpEngine)\n * - PerpPositionOpened (DemoPerpAdapter)\n * - PerpPositionClosed (DemoPerpAdapter)\n * - MarginDeposited (DemoPerpEngine)\n * - LiquidationTriggered (DemoPerpEngine)\n */\n\nimport { createPublicClient, http, parseAbiItem } from 'viem';\nimport { sepolia } from 'viem/chains';\nimport {\n  getIndexerState,\n  upsertIndexerState,\n  createPosition,\n  getPositionByOnChainId,\n  closePosition as dbClosePosition,\n  type Position,\n} from '../ledger/ledger';\n\n// Event ABIs\nconst POSITION_OPENED_ABI = parseAbiItem(\n  'event PositionOpened(address indexed user, uint256 indexed positionId, uint8 market, uint8 side, uint256 margin, uint256 size, uint256 leverage, uint256 entryPrice)'\n);\n\nconst POSITION_CLOSED_ABI = parseAbiItem(\n  'event PositionClosed(address indexed user, uint256 indexed positionId, uint256 exitPrice, int256 pnl, uint256 marginReturned)'\n);\n\nconst LIQUIDATION_ABI = parseAbiItem(\n  'event LiquidationTriggered(address indexed user, uint256 indexed positionId, uint256 liquidationPrice, int256 loss)'\n);\n\n// Market enum mapping\nconst MARKET_MAP: Record<number, string> = {\n  0: 'BTC',\n  1: 'ETH',\n  2: 'SOL',\n};\n\n// Side enum mapping\nconst SIDE_MAP: Record<number, 'long' | 'short'> = {\n  0: 'long',\n  1: 'short',\n};\n\n// Indexer configuration\nconst INDEXER_CONFIG = {\n  chain: 'ethereum' as const,\n  network: 'sepolia' as const,\n  venue: 'demo_perp' as const,\n  pollIntervalMs: 15000, // 15 seconds\n  maxBlocksPerPoll: 1000, // Don't index more than 1000 blocks at once\n  startBlock: 10100000, // Start from a recent block (adjust based on deployment)\n};\n\nlet isRunning = false;\nlet pollTimeout: ReturnType<typeof setTimeout> | null = null;\n\n/**\n * Build explorer URL for a transaction\n */\nfunction buildExplorerUrl(txHash: string): string {\n  return `https://sepolia.etherscan.io/tx/${txHash}`;\n}\n\n/**\n * Process PositionOpened event\n */\nasync function processPositionOpened(\n  log: any,\n  perpEngineAddress: string,\n  timestamp: number\n): Promise<void> {\n  try {\n    const args = log.args;\n    if (!args) return;\n\n    const user = args.user as string;\n    const positionId = args.positionId?.toString() || '0';\n    const market = MARKET_MAP[Number(args.market)] || 'BTC';\n    const side = SIDE_MAP[Number(args.side)] || 'long';\n    const margin = args.margin?.toString() || '0';\n    const size = args.size?.toString() || '0';\n    const leverage = Number(args.leverage) || 1;\n    const entryPrice = args.entryPrice?.toString() || '0';\n\n    // Check if position already exists\n    const existing = await getPositionByOnChainId(\n      INDEXER_CONFIG.chain,\n      INDEXER_CONFIG.network,\n      INDEXER_CONFIG.venue,\n      positionId\n    );\n\n    if (existing) {\n      // Position already indexed\n      return;\n    }\n\n    // Create new position\n    const txHash = log.transactionHash || '';\n    await createPosition({\n      chain: INDEXER_CONFIG.chain,\n      network: INDEXER_CONFIG.network,\n      venue: INDEXER_CONFIG.venue,\n      market,\n      side,\n      leverage,\n      margin_units: margin,\n      margin_display: `${(Number(margin) / 1e6).toFixed(2)} REDACTED`,\n      size_units: size,\n      entry_price: entryPrice,\n      open_tx_hash: txHash,\n      open_explorer_url: txHash ? buildExplorerUrl(txHash) : undefined,\n      user_address: user,\n      on_chain_position_id: positionId,\n    });\n\n    console.log(`[indexer] Indexed new position: ${market} ${side} (id=${positionId})`);\n  } catch (err: any) {\n    console.error(`[indexer] Error processing PositionOpened:`, err.message);\n  }\n}\n\n/**\n * Process PositionClosed event\n */\nasync function processPositionClosed(log: any): Promise<void> {\n  try {\n    const args = log.args;\n    if (!args) return;\n\n    const positionId = args.positionId?.toString() || '0';\n    const pnl = args.pnl?.toString() || '0';\n\n    // Find the position\n    const position = await getPositionByOnChainId(\n      INDEXER_CONFIG.chain,\n      INDEXER_CONFIG.network,\n      INDEXER_CONFIG.venue,\n      positionId\n    );\n\n    if (!position) {\n      console.log(`[indexer] Position not found for close event: ${positionId}`);\n      return;\n    }\n\n    if (position.status !== 'open') {\n      // Already closed\n      return;\n    }\n\n    const txHash = log.transactionHash || '';\n    await dbClosePosition(\n      position.id,\n      txHash,\n      txHash ? buildExplorerUrl(txHash) : '',\n      pnl,\n      'closed'\n    );\n\n    console.log(`[indexer] Closed position: ${position.market} ${position.side} (id=${positionId})`);\n  } catch (err: any) {\n    console.error(`[indexer] Error processing PositionClosed:`, err.message);\n  }\n}\n\n/**\n * Process LiquidationTriggered event\n */\nasync function processLiquidation(log: any): Promise<void> {\n  try {\n    const args = log.args;\n    if (!args) return;\n\n    const positionId = args.positionId?.toString() || '0';\n    const loss = args.loss?.toString() || '0';\n\n    // Find the position\n    const position = await getPositionByOnChainId(\n      INDEXER_CONFIG.chain,\n      INDEXER_CONFIG.network,\n      INDEXER_CONFIG.venue,\n      positionId\n    );\n\n    if (!position) {\n      console.log(`[indexer] Position not found for liquidation event: ${positionId}`);\n      return;\n    }\n\n    if (position.status !== 'open') {\n      return;\n    }\n\n    const txHash = log.transactionHash || '';\n    await dbClosePosition(\n      position.id,\n      txHash,\n      txHash ? buildExplorerUrl(txHash) : '',\n      loss,\n      'liquidated'\n    );\n\n    console.log(`[indexer] Liquidated position: ${position.market} ${position.side} (id=${positionId})`);\n  } catch (err: any) {\n    console.error(`[indexer] Error processing Liquidation:`, err.message);\n  }\n}\n\n/**\n * Index events from a block range\n */\nasync function indexBlockRange(\n  client: ReturnType<typeof createPublicClient>,\n  perpEngineAddress: string,\n  fromBlock: bigint,\n  toBlock: bigint\n): Promise<void> {\n  // Get PositionOpened events\n  const openedLogs = await client.getLogs({\n    address: perpEngineAddress as `0x${string}`,\n    event: POSITION_OPENED_ABI,\n    fromBlock,\n    toBlock,\n  });\n\n  for (const log of openedLogs) {\n    const block = await client.getBlock({ blockNumber: log.blockNumber! });\n    await processPositionOpened(log, perpEngineAddress, Number(block.timestamp));\n  }\n\n  // Get PositionClosed events\n  const closedLogs = await client.getLogs({\n    address: perpEngineAddress as `0x${string}`,\n    event: POSITION_CLOSED_ABI,\n    fromBlock,\n    toBlock,\n  });\n\n  for (const log of closedLogs) {\n    await processPositionClosed(log);\n  }\n\n  // Get Liquidation events\n  const liquidationLogs = await client.getLogs({\n    address: perpEngineAddress as `0x${string}`,\n    event: LIQUIDATION_ABI,\n    fromBlock,\n    toBlock,\n  });\n\n  for (const log of liquidationLogs) {\n    await processLiquidation(log);\n  }\n}\n\n/**\n * Single indexer poll iteration\n */\nasync function pollOnce(\n  client: ReturnType<typeof createPublicClient>,\n  perpEngineAddress: string\n): Promise<void> {\n  try {\n    // Get current block\n    const currentBlock = await client.getBlockNumber();\n\n    // Get last indexed block\n    const state = await getIndexerState(\n      INDEXER_CONFIG.chain,\n      INDEXER_CONFIG.network,\n      perpEngineAddress\n    );\n\n    const lastIndexedBlock = state?.last_indexed_block\n      ? BigInt(state.last_indexed_block)\n      : BigInt(INDEXER_CONFIG.startBlock);\n\n    // Nothing to index if we're caught up\n    if (lastIndexedBlock >= currentBlock) {\n      return;\n    }\n\n    // Calculate range to index\n    const fromBlock = lastIndexedBlock + 1n;\n    const maxToBlock = fromBlock + BigInt(INDEXER_CONFIG.maxBlocksPerPoll);\n    const toBlock = maxToBlock > currentBlock ? currentBlock : maxToBlock;\n\n    // Index the range\n    await indexBlockRange(client, perpEngineAddress, fromBlock, toBlock);\n\n    // Update state\n    await upsertIndexerState(\n      INDEXER_CONFIG.chain,\n      INDEXER_CONFIG.network,\n      perpEngineAddress,\n      Number(toBlock)\n    );\n\n    if (toBlock - fromBlock > 0n) {\n      console.log(`[indexer] Indexed blocks ${fromBlock}-${toBlock}`);\n    }\n  } catch (err: any) {\n    // Don't spam logs - only log errors once per minute\n    console.error(`[indexer] Poll error:`, err.message?.slice(0, 100));\n  }\n}\n\n/**\n * Start the indexer loop\n */\nexport function startPerpIndexer(rpcUrl: string, perpEngineAddress: string): void {\n  if (isRunning) {\n    console.log('[indexer] Already running');\n    return;\n  }\n\n  if (!perpEngineAddress) {\n    console.log('[indexer] No perp engine address configured, skipping');\n    return;\n  }\n\n  console.log('[indexer] Starting perp position indexer');\n  console.log(`[indexer] Contract: ${perpEngineAddress}`);\n\n  isRunning = true;\n\n  const client = createPublicClient({\n    chain: sepolia,\n    transport: http(rpcUrl),\n  });\n\n  const poll = async () => {\n    if (!isRunning) return;\n\n    await pollOnce(client, perpEngineAddress);\n\n    // Schedule next poll\n    pollTimeout = setTimeout(poll, INDEXER_CONFIG.pollIntervalMs);\n  };\n\n  // Start polling\n  poll();\n}\n\n/**\n * Stop the indexer\n */\nexport function stopPerpIndexer(): void {\n  console.log('[indexer] Stopping perp position indexer');\n  isRunning = false;\n  if (pollTimeout) {\n    clearTimeout(pollTimeout);\n    pollTimeout = null;\n  }\n}\n\n/**\n * Check if indexer is running\n */\nexport function isIndexerRunning(): boolean {\n  return isRunning;\n}\n\n/**\n * Manually trigger a single poll (for testing)\n */\nexport async function triggerIndexerPoll(rpcUrl: string, perpEngineAddress: string): Promise<void> {\n  const client = createPublicClient({\n    chain: sepolia,\n    transport: http(rpcUrl),\n  });\n\n  await pollOnce(client, perpEngineAddress);\n}\n", "/**\n * LiFi Bridge Quote Integration\n *\n * Minimal integration to attempt LiFi quotes for cross-chain bridging.\n * This is a \"quote + failure\" first approach - we attempt quotes but\n * may not execute if bridging is not fully implemented.\n *\n * Uses LiFi public API (no API key required for quotes)\n * https://docs.li.fi/li.fi-api/li.fi-api\n */\n\n// LiFi API base URL\nconst LIFI_API_BASE = 'https://li.quest/v1';\n\n// Supported chains for quoting\nconst CHAIN_IDS = {\n  ethereum: 1,\n  sepolia: 11155111,\n  solana: 1151111081099710, // LiFi's Solana chain ID\n  arbitrum: 42161,\n  optimism: 10,\n  polygon: 137,\n  base: 8453,\n} as const;\n\n// Common token addresses\nconst TOKEN_ADDRESSES = {\n  // Ethereum mainnet\n  'REDACTED:ethereum': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',\n  'USDT:ethereum': '0xdAC17F958D2ee523a2206206994597C13D831ec7',\n  'WETH:ethereum': '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',\n  // Sepolia testnet\n  'REDACTED:sepolia': '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8',\n  'WETH:sepolia': '0xfFf9976782d46CC05630D1f6eBAb18b2324d6B14',\n} as const;\n\nexport interface LiFiQuoteParams {\n  fromChain: string;      // 'ethereum' | 'solana' | etc.\n  toChain: string;\n  fromToken: string;      // Token symbol or address\n  toToken: string;\n  fromAmount: string;     // Amount in base units (wei, lamports)\n  fromAddress?: string;   // User address (optional for quote)\n  slippage?: number;      // Default 0.5%\n}\n\nexport interface LiFiQuoteResult {\n  ok: boolean;\n  quote?: {\n    id: string;\n    type: string;\n    tool: string;           // Bridge/DEX name\n    toolDetails: {\n      name: string;\n      logoURI: string;\n    };\n    fromChain: number;\n    toChain: number;\n    fromToken: {\n      address: string;\n      symbol: string;\n      decimals: number;\n    };\n    toToken: {\n      address: string;\n      symbol: string;\n      decimals: number;\n    };\n    fromAmount: string;\n    toAmount: string;\n    toAmountMin: string;\n    estimatedDuration: number;  // seconds\n    feeCosts: Array<{\n      name: string;\n      amount: string;\n      amountUSD: string;\n    }>;\n    gasCosts: Array<{\n      amount: string;\n      amountUSD: string;\n    }>;\n  };\n  error?: {\n    code: string;\n    message: string;\n  };\n}\n\n// Error codes for categorization\nexport const LiFiErrorCodes = {\n  LIFI_UNREACHABLE: 'LIFI_UNREACHABLE',\n  LIFI_NO_ROUTE: 'LIFI_NO_ROUTE',\n  LIFI_QUOTE_FAILED: 'LIFI_QUOTE_FAILED',\n  LIFI_INVALID_PARAMS: 'LIFI_INVALID_PARAMS',\n  LIFI_RATE_LIMITED: 'LIFI_RATE_LIMITED',\n  LIFI_UNSUPPORTED_CHAIN: 'LIFI_UNSUPPORTED_CHAIN',\n} as const;\n\n/**\n * Resolve chain name to LiFi chain ID\n */\nfunction resolveChainId(chain: string): number | null {\n  const normalized = chain.toLowerCase();\n  return (CHAIN_IDS as Record<string, number>)[normalized] ?? null;\n}\n\n/**\n * Resolve token to address for a given chain\n * Returns the native token placeholder (0x0...0) for native tokens\n */\nfunction resolveTokenAddress(token: string, chain: string): string {\n  // Native token\n  if (['ETH', 'SOL'].includes(token.toUpperCase())) {\n    return '0x0000000000000000000000000000000000000000';\n  }\n\n  // Check known addresses\n  const key = `${token.toUpperCase()}:${chain.toLowerCase()}` as keyof typeof TOKEN_ADDRESSES;\n  if (TOKEN_ADDRESSES[key]) {\n    return TOKEN_ADDRESSES[key];\n  }\n\n  // If it looks like an address, use it directly\n  if (token.startsWith('0x') && token.length === 42) {\n    return token;\n  }\n\n  // Default: assume it's a symbol and use placeholder\n  // LiFi API can sometimes resolve symbols\n  return token;\n}\n\n/**\n * Get a quote from LiFi for a cross-chain swap/bridge\n *\n * @param params Quote parameters\n * @returns Quote result with success/failure status\n */\nexport async function getLiFiQuote(params: LiFiQuoteParams): Promise<LiFiQuoteResult> {\n  try {\n    // Resolve chain IDs\n    const fromChainId = resolveChainId(params.fromChain);\n    const toChainId = resolveChainId(params.toChain);\n\n    if (!fromChainId) {\n      return {\n        ok: false,\n        error: {\n          code: LiFiErrorCodes.LIFI_UNSUPPORTED_CHAIN,\n          message: `Unsupported source chain: ${params.fromChain}`,\n        },\n      };\n    }\n\n    if (!toChainId) {\n      return {\n        ok: false,\n        error: {\n          code: LiFiErrorCodes.LIFI_UNSUPPORTED_CHAIN,\n          message: `Unsupported destination chain: ${params.toChain}`,\n        },\n      };\n    }\n\n    // Resolve token addresses\n    const fromTokenAddress = resolveTokenAddress(params.fromToken, params.fromChain);\n    const toTokenAddress = resolveTokenAddress(params.toToken, params.toChain);\n\n    // Build query params\n    const queryParams = new URLSearchParams({\n      fromChain: fromChainId.toString(),\n      toChain: toChainId.toString(),\n      fromToken: fromTokenAddress,\n      toToken: toTokenAddress,\n      fromAmount: params.fromAmount,\n      slippage: (params.slippage ?? 0.005).toString(),\n    });\n\n    if (params.fromAddress) {\n      queryParams.set('fromAddress', params.fromAddress);\n    }\n\n    // Make request with timeout\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout\n\n    try {\n      const response = await fetch(`${LIFI_API_BASE}/quote?${queryParams}`, {\n        method: 'GET',\n        headers: {\n          'Accept': 'application/json',\n        },\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeout);\n\n      if (response.status === 429) {\n        return {\n          ok: false,\n          error: {\n            code: LiFiErrorCodes.LIFI_RATE_LIMITED,\n            message: 'LiFi API rate limit exceeded',\n          },\n        };\n      }\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        // LiFi returns structured errors\n        const errorMessage = data.message || data.error || 'Quote request failed';\n\n        // Categorize the error\n        let errorCode: string = LiFiErrorCodes.LIFI_QUOTE_FAILED;\n        if (errorMessage.toLowerCase().includes('no route')) {\n          errorCode = LiFiErrorCodes.LIFI_NO_ROUTE;\n        } else if (errorMessage.toLowerCase().includes('invalid')) {\n          errorCode = LiFiErrorCodes.LIFI_INVALID_PARAMS;\n        }\n\n        return {\n          ok: false,\n          error: {\n            code: errorCode,\n            message: errorMessage.slice(0, 200),\n          },\n        };\n      }\n\n      // Parse successful quote\n      const quote = data;\n\n      return {\n        ok: true,\n        quote: {\n          id: quote.id || 'unknown',\n          type: quote.type || 'BRIDGE',\n          tool: quote.tool || quote.toolDetails?.name || 'unknown',\n          toolDetails: quote.toolDetails || { name: 'unknown', logoURI: '' },\n          fromChain: fromChainId,\n          toChain: toChainId,\n          fromToken: {\n            address: quote.action?.fromToken?.address || fromTokenAddress,\n            symbol: quote.action?.fromToken?.symbol || params.fromToken,\n            decimals: quote.action?.fromToken?.decimals || 18,\n          },\n          toToken: {\n            address: quote.action?.toToken?.address || toTokenAddress,\n            symbol: quote.action?.toToken?.symbol || params.toToken,\n            decimals: quote.action?.toToken?.decimals || 18,\n          },\n          fromAmount: quote.action?.fromAmount || params.fromAmount,\n          toAmount: quote.estimate?.toAmount || '0',\n          toAmountMin: quote.estimate?.toAmountMin || '0',\n          estimatedDuration: quote.estimate?.executionDuration || 300,\n          feeCosts: quote.estimate?.feeCosts || [],\n          gasCosts: quote.estimate?.gasCosts || [],\n        },\n      };\n    } catch (fetchError: any) {\n      clearTimeout(timeout);\n\n      if (fetchError.name === 'AbortError') {\n        return {\n          ok: false,\n          error: {\n            code: LiFiErrorCodes.LIFI_UNREACHABLE,\n            message: 'LiFi API request timed out',\n          },\n        };\n      }\n\n      throw fetchError;\n    }\n  } catch (error: any) {\n    return {\n      ok: false,\n      error: {\n        code: LiFiErrorCodes.LIFI_UNREACHABLE,\n        message: `LiFi API error: ${error.message?.slice(0, 150) || 'Unknown error'}`,\n      },\n    };\n  }\n}\n\n/**\n * Check if LiFi API is reachable\n */\nexport async function checkLiFiHealth(): Promise<boolean> {\n  try {\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), 5000);\n\n    const response = await fetch(`${LIFI_API_BASE}/chains`, {\n      method: 'GET',\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeout);\n    return response.ok;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get supported chains from LiFi\n */\nexport async function getLiFiChains(): Promise<{ id: number; name: string; key: string }[]> {\n  try {\n    const response = await fetch(`${LIFI_API_BASE}/chains`, {\n      method: 'GET',\n      headers: { 'Accept': 'application/json' },\n    });\n\n    if (!response.ok) {\n      return [];\n    }\n\n    const data = await response.json();\n    return (data.chains || []).map((c: any) => ({\n      id: c.id,\n      name: c.name,\n      key: c.key,\n    }));\n  } catch {\n    return [];\n  }\n}\n", "/**\n * Solana Devnet Client\n * Minimal RPC client for Solana devnet execution\n *\n * No external dependencies - uses native fetch for RPC calls\n */\n\nconst DEFAULT_DEVNET_RPC = 'https://api.devnet.solana.com';\n\nexport interface SolanaClientConfig {\n  rpcUrl?: string;\n}\n\nexport interface TransactionResult {\n  signature: string;\n  slot?: number;\n  confirmationStatus?: 'processed' | 'confirmed' | 'finalized';\n}\n\nexport interface BalanceResult {\n  lamports: number;\n  sol: number;\n}\n\n/**\n * Solana RPC client for devnet operations\n */\nexport class SolanaClient {\n  private rpcUrl: string;\n\n  constructor(config: SolanaClientConfig = {}) {\n    this.rpcUrl = config.rpcUrl || process.env.SOLANA_RPC_URL || DEFAULT_DEVNET_RPC;\n  }\n\n  /**\n   * Make an RPC call to Solana\n   */\n  private async rpcCall<T>(method: string, params: any[] = []): Promise<T> {\n    const response = await fetch(this.rpcUrl, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method,\n        params,\n      }),\n    });\n\n    const data = await response.json();\n\n    if (data.error) {\n      throw new Error(`Solana RPC error: ${data.error.message}`);\n    }\n\n    return data.result;\n  }\n\n  /**\n   * Get SOL balance for a public key\n   */\n  async getBalance(pubkey: string): Promise<BalanceResult> {\n    const result = await this.rpcCall<{ value: number }>('getBalance', [pubkey]);\n    const lamports = result.value;\n    return {\n      lamports,\n      sol: lamports / 1_000_000_000, // Convert lamports to SOL\n    };\n  }\n\n  /**\n   * Get recent blockhash for transaction signing\n   */\n  async getRecentBlockhash(): Promise<{ blockhash: string; lastValidBlockHeight: number }> {\n    const result = await this.rpcCall<{\n      value: { blockhash: string; lastValidBlockHeight: number };\n    }>('getLatestBlockhash', [{ commitment: 'finalized' }]);\n    return result.value;\n  }\n\n  /**\n   * Send a signed transaction (base64 encoded)\n   */\n  async sendTransaction(\n    signedTx: string,\n    options: { encoding?: 'base64' | 'base58'; skipPreflight?: boolean } = {}\n  ): Promise<string> {\n    const { encoding = 'base64', skipPreflight = false } = options;\n\n    const signature = await this.rpcCall<string>('sendTransaction', [\n      signedTx,\n      {\n        encoding,\n        skipPreflight,\n        preflightCommitment: 'confirmed',\n      },\n    ]);\n\n    return signature;\n  }\n\n  /**\n   * Get transaction status\n   */\n  async getSignatureStatuses(\n    signatures: string[]\n  ): Promise<Array<{\n    slot: number;\n    confirmationStatus: 'processed' | 'confirmed' | 'finalized' | null;\n    err: any;\n  } | null>> {\n    const result = await this.rpcCall<{\n      value: Array<{\n        slot: number;\n        confirmationStatus: 'processed' | 'confirmed' | 'finalized' | null;\n        err: any;\n      } | null>;\n    }>('getSignatureStatuses', [signatures, { searchTransactionHistory: true }]);\n\n    return result.value;\n  }\n\n  /**\n   * Confirm a transaction with timeout\n   */\n  async confirmTransaction(\n    signature: string,\n    commitment: 'processed' | 'confirmed' | 'finalized' = 'confirmed',\n    timeoutMs: number = 30000\n  ): Promise<TransactionResult> {\n    const start = Date.now();\n\n    while (Date.now() - start < timeoutMs) {\n      const statuses = await this.getSignatureStatuses([signature]);\n      const status = statuses[0];\n\n      if (status) {\n        if (status.err) {\n          throw new Error(`Transaction failed: ${JSON.stringify(status.err)}`);\n        }\n\n        const commitmentLevels = ['processed', 'confirmed', 'finalized'];\n        const targetLevel = commitmentLevels.indexOf(commitment);\n        const currentLevel = status.confirmationStatus\n          ? commitmentLevels.indexOf(status.confirmationStatus)\n          : -1;\n\n        if (currentLevel >= targetLevel) {\n          return {\n            signature,\n            slot: status.slot,\n            confirmationStatus: status.confirmationStatus || undefined,\n          };\n        }\n      }\n\n      // Wait 1 second before checking again\n      await new Promise(resolve => setTimeout(resolve, 1000));\n    }\n\n    throw new Error(`Transaction confirmation timeout after ${timeoutMs}ms`);\n  }\n\n  /**\n   * Request airdrop (devnet only)\n   */\n  async requestAirdrop(pubkey: string, lamports: number = 1_000_000_000): Promise<string> {\n    const signature = await this.rpcCall<string>('requestAirdrop', [pubkey, lamports]);\n    return signature;\n  }\n\n  /**\n   * Get account info\n   */\n  async getAccountInfo(pubkey: string): Promise<{\n    lamports: number;\n    owner: string;\n    data: string;\n    executable: boolean;\n  } | null> {\n    const result = await this.rpcCall<{\n      value: {\n        lamports: number;\n        owner: string;\n        data: [string, string];\n        executable: boolean;\n      } | null;\n    }>('getAccountInfo', [pubkey, { encoding: 'base64' }]);\n\n    if (!result.value) return null;\n\n    return {\n      lamports: result.value.lamports,\n      owner: result.value.owner,\n      data: result.value.data[0],\n      executable: result.value.executable,\n    };\n  }\n\n  /**\n   * Get cluster info\n   */\n  async getClusterNodes(): Promise<Array<{\n    pubkey: string;\n    gossip: string;\n    rpc: string | null;\n    version: string;\n  }>> {\n    return this.rpcCall('getClusterNodes', []);\n  }\n\n  /**\n   * Get slot\n   */\n  async getSlot(): Promise<number> {\n    return this.rpcCall('getSlot', []);\n  }\n\n  /**\n   * Health check\n   */\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.getSlot();\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n\n/**\n * Create a Solana devnet client\n */\nexport function createSolanaClient(rpcUrl?: string): SolanaClient {\n  return new SolanaClient({ rpcUrl });\n}\n\nexport default SolanaClient;\n", "// @ts-nocheck\n/**\n * Intent Runner Orchestrator\n *\n * Transforms user-style prompts into executed transactions:\n * 1. Accept raw intent_text (e.g., \"long btc 20x\", \"swap 5000 usdc to weth\")\n * 2. Create ledger intent row (status=queued)\n * 3. Plan: Parse intent, detect kind, extract parameters\n * 4. Route: Map to implemented venues or fail with clear error\n * 5. Execute: Run transaction via appropriate chain executor\n * 6. Confirm: Wait for confirmation and update ledger\n *\n * This orchestrator is honest about what's implemented vs. not.\n */\n\nimport { randomUUID } from 'crypto';\n\n/**\n * Helper to merge new metadata with existing metadata, preserving caller info (source, domain, runId).\n * This ensures that source tracking persists through all status updates.\n */\nfunction mergeMetadata(existingJson: string | undefined, newData: Record<string, any>): string {\n  let existing: Record<string, any> = {};\n  try {\n    existing = JSON.parse(existingJson || '{}');\n  } catch {}\n\n  // Preserve these caller-provided keys across all updates\n  const PRESERVED_KEYS = ['source', 'domain', 'runId', 'category', 'timestamp', 'userAgent'];\n  const preserved: Record<string, any> = {};\n  for (const key of PRESERVED_KEYS) {\n    if (existing[key] !== undefined) {\n      preserved[key] = existing[key];\n    }\n  }\n\n  return JSON.stringify({ ...preserved, ...newData });\n}\n\n// Type definitions (duplicated to avoid rootDir issues)\ntype IntentKind = 'perp' | 'deposit' | 'swap' | 'bridge' | 'unknown';\ntype IntentStatus = 'queued' | 'planned' | 'routed' | 'executing' | 'confirmed' | 'failed';\ntype IntentFailureStage = 'plan' | 'route' | 'execute' | 'confirm' | 'quote';\ntype ExecutionKind = 'perp' | 'deposit' | 'bridge' | 'swap' | 'proof' | 'relay' | 'transfer';\n\n// Chain type for clarity\nexport type ChainTarget = 'ethereum' | 'solana' | 'both';\n\n// Parsed intent structure\nexport interface ParsedIntent {\n  kind: IntentKind;\n  action: string;               // deposit | swap | long | short | bridge | proof\n  amount?: string;              // e.g., \"20000\"\n  amountUnit?: string;          // e.g., \"usdc\"\n  targetAsset?: string;         // e.g., \"weth\", \"btc\"\n  leverage?: number;            // For perp intents\n  sourceChain?: string;         // For bridge intents\n  destChain?: string;           // For bridge intents\n  venue?: string;               // Requested venue if specified\n  rawParams: Record<string, any>;\n}\n\n// Route decision\nexport interface RouteDecision {\n  chain: 'ethereum' | 'solana';\n  network: 'sepolia' | 'devnet';\n  venue: string;\n  adapter?: string;\n  executionType: 'real' | 'proof_only';\n  warnings?: string[];\n}\n\n// Execution result\nexport interface IntentExecutionResult {\n  ok: boolean;\n  intentId: string;\n  status: string;\n  executionId?: string;\n  txHash?: string;\n  explorerUrl?: string;\n  error?: {\n    stage: IntentFailureStage;\n    code: string;\n    message: string;\n  };\n  metadata?: Record<string, any>;\n}\n\n// Known venue implementations\nconst IMPLEMENTED_VENUES: Record<string, Record<string, string[]>> = {\n  ethereum: {\n    deposit: ['demo_vault', 'aave'],\n    swap: ['demo_dex', 'uniswap'],\n    bridge: ['bridge_proof'],  // Proof only, not real bridging\n    perp: ['demo_perp'],       // Proof only\n    proof: ['native'],\n    unknown: ['native'],\n  },\n  solana: {\n    deposit: ['solana_vault'],\n    swap: ['demo_dex'],\n    bridge: ['bridge_proof'],\n    perp: ['demo_perp'],\n    proof: ['native'],\n    unknown: ['native'],\n  },\n};\n\n// Extended IntentKind to include new types\ntype ExtendedIntentKind = IntentKind | 'prediction' | 'hedge' | 'vault_discovery';\n\n// Intent patterns for parsing\nconst INTENT_PATTERNS = {\n  perp: {\n    long: /(?:^|\\s)(?:go\\s+)?long\\s+(\\w+)(?:\\s+(\\d+)x)?/i,\n    short: /(?:^|\\s)(?:go\\s+)?short\\s+(\\w+)(?:\\s+(\\d+)x)?/i,\n    leverage: /(\\d+)\\s*x\\s*(?:leverage|lev)?/i,\n    withAmount: /with\\s+(\\d+(?:,?\\d+)*(?:\\.\\d+)?)/i,\n  },\n  swap: {\n    basic: /swap\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+(?:to|for|->)\\s+(\\w+)/i,\n    convert: /convert\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+to\\s+(\\w+)/i,\n    trade: /trade\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+(?:for|to)\\s+(\\w+)/i,\n  },\n  deposit: {\n    basic: /deposit\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+(?:to|into|in)\\s+(\\w+)/i,\n    supply: /supply\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+(?:to|into)\\s+(\\w+)/i,\n    lend: /lend\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)/i,\n  },\n  bridge: {\n    basic: /bridge\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+(?:from\\s+)?(\\w+)\\s+to\\s+(\\w+)/i,\n    transfer: /transfer\\s+(?:(\\d+(?:,?\\d+)*(?:\\.\\d+)?)\\s*)?(\\w+)\\s+from\\s+(\\w+)\\s+to\\s+(\\w+)/i,\n  },\n  // New patterns for Product Thesis scenarios\n  prediction: {\n    bet: /(?:bet|wager|stake)\\s+(?:on\\s+)?(?:the\\s+)?/i,\n    market: /prediction\\s*market/i,\n    volume: /(?:highest|top|best)\\s*(?:volume|liquidity)/i,\n  },\n  hedge: {\n    basic: /hedge\\s+(?:my\\s+)?(?:positions?|portfolio)/i,\n    protect: /protect\\s+(?:my\\s+)?(?:positions?|portfolio)/i,\n  },\n  vault: {\n    discovery: /(?:find|get|show)\\s+(?:me\\s+)?(?:the\\s+)?(?:top|best)\\s+(?:defi\\s+)?vault/i,\n    yield: /(\\d+(?:\\.\\d+)?)\\s*%\\s*(?:yield|apy|apr)/i,\n  },\n  // Analytics intents - recorded to ledger without on-chain proof\n  analytics: {\n    exposure: /(?:show|check|get|view)\\s+(?:me\\s+)?(?:my\\s+)?(?:current\\s+)?(?:perp\\s+)?exposure/i,\n    risk: /(?:show|check|get|view)\\s+(?:me\\s+)?(?:my\\s+)?(?:current\\s+)?risk/i,\n    topProtocols: /(?:show|get|find)\\s+(?:me\\s+)?(?:the\\s+)?(?:top|best)\\s+(?:\\d+\\s+)?(?:defi\\s+)?protocols?/i,\n    topMarkets: /(?:show|get|find)\\s+(?:me\\s+)?(?:the\\s+)?(?:top|best)\\s+(?:\\d+\\s+)?prediction\\s+markets?/i,\n  },\n};\n\n/**\n * Parse a natural language intent into structured format\n */\nexport function parseIntent(intentText: string): ParsedIntent {\n  const text = intentText.toLowerCase().trim();\n  const rawParams: Record<string, any> = { original: intentText };\n\n  // Check for hedge/portfolio protection intent FIRST (before other patterns)\n  if (INTENT_PATTERNS.hedge.basic.test(text) || INTENT_PATTERNS.hedge.protect.test(text)) {\n    return {\n      kind: 'unknown', // Will be routed as proof_only with special handling\n      action: 'hedge',\n      rawParams: { ...rawParams, intentType: 'hedge', requiresPortfolio: true },\n    };\n  }\n\n  // Check for prediction market intent\n  if (INTENT_PATTERNS.prediction.market.test(text) ||\n      (INTENT_PATTERNS.prediction.bet.test(text) && INTENT_PATTERNS.prediction.volume.test(text))) {\n    return {\n      kind: 'unknown', // Will be routed as proof_only with special handling\n      action: 'prediction_bet',\n      rawParams: { ...rawParams, intentType: 'prediction', requiresMarketData: true },\n    };\n  }\n\n  // Check for vault discovery intent\n  if (INTENT_PATTERNS.vault.discovery.test(text)) {\n    const yieldMatch = text.match(INTENT_PATTERNS.vault.yield);\n    const targetYield = yieldMatch ? parseFloat(yieldMatch[1]) : undefined;\n\n    return {\n      kind: 'deposit', // Route to deposit flow, but needs discovery first\n      action: 'vault_discovery',\n      rawParams: { ...rawParams, intentType: 'vault_discovery', targetYield, requiresYieldRanking: true },\n    };\n  }\n\n  // Try perp patterns\n  const longMatch = text.match(INTENT_PATTERNS.perp.long);\n  const shortMatch = text.match(INTENT_PATTERNS.perp.short);\n\n  if (longMatch || shortMatch) {\n    const match = longMatch || shortMatch;\n    const side = longMatch ? 'long' : 'short';\n    const asset = match![1].toUpperCase();\n    const leverageMatch = text.match(INTENT_PATTERNS.perp.leverage);\n    const leverage = leverageMatch ? parseInt(leverageMatch[1]) : 10;\n\n    // Check for \"with X\" amount pattern\n    const amountMatch = text.match(INTENT_PATTERNS.perp.withAmount);\n    const amount = amountMatch ? amountMatch[1].replace(/,/g, '') : undefined;\n\n    return {\n      kind: 'perp',\n      action: side,\n      amount,\n      amountUnit: 'REDACTED', // Assume REDACTED for perp margin\n      targetAsset: asset,\n      leverage,\n      rawParams: { ...rawParams, side, asset, leverage, amount },\n    };\n  }\n\n  // Try swap patterns\n  for (const [name, pattern] of Object.entries(INTENT_PATTERNS.swap)) {\n    const match = text.match(pattern);\n    if (match) {\n      const amount = match[1]?.replace(/,/g, '') || '1000';\n      const fromAsset = match[2].toUpperCase();\n      const toAsset = match[3].toUpperCase();\n\n      return {\n        kind: 'swap',\n        action: 'swap',\n        amount,\n        amountUnit: fromAsset,\n        targetAsset: toAsset,\n        rawParams: { ...rawParams, amount, fromAsset, toAsset },\n      };\n    }\n  }\n\n  // Try deposit patterns\n  for (const [name, pattern] of Object.entries(INTENT_PATTERNS.deposit)) {\n    const match = text.match(pattern);\n    if (match) {\n      const amount = match[1]?.replace(/,/g, '') || '1000';\n      const asset = match[2].toUpperCase();\n      const venue = match[3]?.toLowerCase() || 'vault';\n\n      return {\n        kind: 'deposit',\n        action: 'deposit',\n        amount,\n        amountUnit: asset,\n        venue,\n        rawParams: { ...rawParams, amount, asset, venue },\n      };\n    }\n  }\n\n  // Try bridge patterns\n  for (const [name, pattern] of Object.entries(INTENT_PATTERNS.bridge)) {\n    const match = text.match(pattern);\n    if (match) {\n      const amount = match[1]?.replace(/,/g, '') || '1000';\n      const asset = match[2].toUpperCase();\n      const sourceChain = match[3].toLowerCase();\n      const destChain = match[4].toLowerCase();\n\n      return {\n        kind: 'bridge',\n        action: 'bridge',\n        amount,\n        amountUnit: asset,\n        sourceChain: sourceChain === 'eth' ? 'ethereum' : sourceChain,\n        destChain: destChain === 'sol' ? 'solana' : destChain,\n        rawParams: { ...rawParams, amount, asset, sourceChain, destChain },\n      };\n    }\n  }\n\n  // Check for analytics intents (exposure, risk, top protocols, etc.)\n  if (INTENT_PATTERNS.analytics.exposure.test(text) ||\n      INTENT_PATTERNS.analytics.risk.test(text)) {\n    return {\n      kind: 'unknown',\n      action: 'analytics_exposure',\n      rawParams: { ...rawParams, intentType: 'analytics', analyticsType: 'exposure' },\n    };\n  }\n\n  if (INTENT_PATTERNS.analytics.topProtocols.test(text)) {\n    return {\n      kind: 'unknown',\n      action: 'analytics_protocols',\n      rawParams: { ...rawParams, intentType: 'analytics', analyticsType: 'top_protocols' },\n    };\n  }\n\n  if (INTENT_PATTERNS.analytics.topMarkets.test(text)) {\n    return {\n      kind: 'unknown',\n      action: 'analytics_markets',\n      rawParams: { ...rawParams, intentType: 'analytics', analyticsType: 'top_markets' },\n    };\n  }\n\n  // Unknown intent\n  return {\n    kind: 'unknown',\n    action: 'proof',\n    rawParams,\n  };\n}\n\n/**\n * Determine execution route for a parsed intent\n */\nexport function routeIntent(\n  parsed: ParsedIntent,\n  preferredChain?: ChainTarget\n): RouteDecision | { error: { stage: IntentFailureStage; code: string; message: string } } {\n  const { kind, venue, sourceChain, destChain, rawParams } = parsed;\n\n  // Determine target chain\n  let targetChain: 'ethereum' | 'solana' = 'ethereum';\n  if (preferredChain === 'solana') {\n    targetChain = 'solana';\n  } else if (kind === 'bridge') {\n    // Bridge: source chain determines where we start\n    if (sourceChain === 'solana') {\n      targetChain = 'solana';\n    }\n  }\n\n  const network = targetChain === 'ethereum' ? 'sepolia' : 'devnet';\n\n  // Handle special intent types that need specific integrations\n\n  // Hedge intent requires portfolio state\n  if (rawParams?.intentType === 'hedge') {\n    // For now, we don't have portfolio state ingestion\n    // Route to proof_only with clear messaging\n    return {\n      chain: targetChain,\n      network,\n      venue: 'native',\n      executionType: 'proof_only',\n      warnings: [\n        'PROOF_ONLY: Hedge intent requires portfolio state integration.',\n        'Portfolio ingestion not yet implemented - recording intent proof on-chain.',\n      ],\n    };\n  }\n\n  // Prediction market intent requires market data\n  if (rawParams?.intentType === 'prediction') {\n    // For now, we don't have prediction market data source integrated\n    return {\n      chain: targetChain,\n      network,\n      venue: 'native',\n      executionType: 'proof_only',\n      warnings: [\n        'PROOF_ONLY: Prediction market intent requires market data integration.',\n        'Polymarket/prediction data source not yet integrated - recording intent proof on-chain.',\n      ],\n    };\n  }\n\n  // Vault discovery intent requires yield ranking\n  if (rawParams?.intentType === 'vault_discovery') {\n    // For now, we don't have yield ranking integrated\n    return {\n      chain: targetChain,\n      network,\n      venue: 'native',\n      executionType: 'proof_only',\n      warnings: [\n        'PROOF_ONLY: Vault discovery requires yield ranking integration.',\n        'DefiLlama/yield sources not yet integrated - recording intent proof on-chain.',\n        `Target yield: ${rawParams.targetYield || 'not specified'}%`,\n      ],\n    };\n  }\n\n  // Analytics intent - offchain analysis, recorded to ledger without proof tx\n  if (rawParams?.intentType === 'analytics') {\n    return {\n      chain: targetChain,\n      network,\n      venue: 'offchain',\n      executionType: 'offchain' as any, // Special handling for analytics\n      warnings: [\n        'OFFCHAIN: Analytics intent - no on-chain action required.',\n        `Analysis type: ${rawParams.analyticsType || 'general'}`,\n      ],\n    };\n  }\n\n  // Check venue implementation\n  const implementedVenues = IMPLEMENTED_VENUES[targetChain][kind] || [];\n\n  // Handle perp intents\n  if (kind === 'perp') {\n    const requestedVenue = venue?.toLowerCase();\n\n    // If they request a specific venue like drift/hl, fail clearly\n    if (requestedVenue && ['drift', 'hl', 'hyperliquid', 'dydx'].includes(requestedVenue)) {\n      return {\n        error: {\n          stage: 'route',\n          code: 'VENUE_NOT_IMPLEMENTED',\n          message: `Perp venue \"${requestedVenue}\" is not yet integrated. Recording as proof-only.`,\n        },\n      };\n    }\n\n    // Check if demo perp adapter is configured for real execution\n    const demoPerpAdapter = process.env.DEMO_PERP_ADAPTER_ADDRESS;\n    if (demoPerpAdapter && targetChain === 'ethereum') {\n      // Real execution via DemoPerpAdapter on Sepolia\n      return {\n        chain: 'ethereum',\n        network: 'sepolia',\n        venue: 'demo_perp',\n        adapter: demoPerpAdapter,\n        executionType: 'real',\n      };\n    }\n\n    // Fallback to proof-only if adapter not configured\n    return {\n      chain: targetChain,\n      network,\n      venue: 'demo_perp',\n      executionType: 'proof_only',\n      warnings: ['PROOF_ONLY: DemoPerpAdapter not configured. Recording intent proof on-chain.'],\n    };\n  }\n\n  // Handle bridge intents\n  if (kind === 'bridge') {\n    // Check if bridging between different chains\n    if (sourceChain && destChain && sourceChain !== destChain) {\n      // Bridge is quote-only for now\n      return {\n        chain: targetChain,\n        network,\n        venue: 'lifi',\n        executionType: 'proof_only',\n        warnings: ['Bridge execution not fully implemented. Will attempt LiFi quote.'],\n      };\n    }\n  }\n\n  // Handle deposit intents\n  if (kind === 'deposit') {\n    const requestedVenue = venue?.toLowerCase();\n\n    // Check for unimplemented venues - route to proof_only instead of failing\n    if (requestedVenue && ['kamino', 'drift'].includes(requestedVenue)) {\n      return {\n        chain: targetChain,\n        network,\n        venue: requestedVenue,\n        executionType: 'proof_only',\n        warnings: [\n          `PROOF_ONLY: Deposit venue \"${requestedVenue}\" is not yet integrated.`,\n          'Recording intent proof on-chain.',\n        ],\n      };\n    }\n\n    // Route to appropriate venue\n    if (requestedVenue === 'aave' && targetChain === 'ethereum') {\n      return {\n        chain: 'ethereum',\n        network: 'sepolia',\n        venue: 'aave',\n        executionType: 'real',\n      };\n    }\n\n    // Default to demo vault - Solana goes to proof_only for now\n    if (targetChain === 'solana') {\n      return {\n        chain: 'solana',\n        network: 'devnet',\n        venue: 'solana_vault',\n        executionType: 'proof_only',\n        warnings: ['PROOF_ONLY: Solana vault integration pending. Recording intent proof on-chain.'],\n      };\n    }\n\n    return {\n      chain: targetChain,\n      network,\n      venue: 'demo_vault',\n      executionType: 'real',\n    };\n  }\n\n  // Handle swap intents\n  if (kind === 'swap') {\n    // Solana swaps go to proof_only since execution isn't fully wired\n    if (targetChain === 'solana') {\n      return {\n        chain: 'solana',\n        network: 'devnet',\n        venue: 'demo_dex',\n        executionType: 'proof_only',\n        warnings: ['PROOF_ONLY: Solana swap integration pending. Recording intent proof on-chain.'],\n      };\n    }\n\n    return {\n      chain: targetChain,\n      network,\n      venue: 'demo_dex',\n      executionType: 'real',\n    };\n  }\n\n  // Unknown/proof\n  return {\n    chain: targetChain,\n    network,\n    venue: 'native',\n    executionType: 'proof_only',\n    warnings: ['Intent not recognized. Recording proof-of-execution only.'],\n  };\n}\n\n/**\n * Estimate USD value for an intent\n */\nfunction estimateIntentUsd(parsed: ParsedIntent): number | undefined {\n  const amount = parsed.amount ? parseFloat(parsed.amount) : undefined;\n  if (!amount) return undefined;\n\n  const unit = parsed.amountUnit?.toUpperCase();\n\n  // Simple price estimates (for testnet)\n  const prices: Record<string, number> = {\n    REDACTED: 1,\n    USDT: 1,\n    DAI: 1,\n    ETH: 2000,\n    WETH: 2000,\n    SOL: 100,\n    BTC: 45000,\n  };\n\n  return amount * (prices[unit || ''] || 1);\n}\n\n/**\n * Run a single intent through the full pipeline\n *\n * Options:\n * - chain: Target chain (ethereum, solana, both)\n * - planOnly: Stop after routing, return plan without executing (for confirm mode)\n * - intentId: Execute a previously planned intent (skip parse/route)\n */\nexport async function runIntent(\n  intentText: string,\n  options: {\n    chain?: ChainTarget;\n    planOnly?: boolean;\n    intentId?: string;  // For executing a previously planned intent\n    dryRun?: boolean;   // Legacy, use planOnly instead\n    metadata?: Record<string, any>;  // Caller-provided metadata (e.g., torture_suite tagging)\n  } = {}\n): Promise<IntentExecutionResult> {\n  // Dynamic imports for ledger (avoids path issues)\n  const {\n    createIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    createExecutionStep,\n    updateExecutionStep,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Step 1: Parse intent\n  const parsed = parseIntent(intentText);\n  const usdEstimate = estimateIntentUsd(parsed);\n\n  // Merge caller-provided metadata with internal metadata\n  // callerMeta is preserved and passed through ALL status updates\n  const callerMeta = options.metadata || {};\n\n  // Helper to build metadata JSON that preserves caller metadata\n  const buildMetadata = (extra: Record<string, any> = {}) => JSON.stringify({\n    ...callerMeta,  // Always include caller metadata (source, domain, runId, etc.)\n    parsed,\n    ...extra,\n  });\n\n  // Step 2: Create intent record\n  const intent = createIntent({\n    intentText,\n    intentKind: parsed.kind,\n    requestedVenue: parsed.venue,\n    usdEstimate,\n    metadataJson: buildMetadata({ options: { ...options, metadata: undefined } }),\n  });\n\n  try {\n    // Step 3: Route intent\n    updateIntentStatus(intent.id, {\n      status: 'planned',\n      plannedAt: now,\n      metadataJson: buildMetadata({ options: { ...options, metadata: undefined } }),\n    });\n\n    const route = routeIntent(parsed, options.chain);\n\n    // Check for routing error\n    if ('error' in route) {\n      updateIntentStatus(intent.id, {\n        status: 'failed',\n        failureStage: route.error.stage,\n        errorCode: route.error.code,\n        errorMessage: route.error.message,\n      });\n\n      return {\n        ok: false,\n        intentId: intent.id,\n        status: 'failed',\n        error: route.error,\n      };\n    }\n\n    updateIntentStatus(intent.id, {\n      status: 'routed',\n      requestedChain: route.chain,\n      requestedVenue: route.venue,\n      metadataJson: buildMetadata({ route, options: { ...options, metadata: undefined } }),\n    });\n\n    // Step 4: Handle bridge intents with LiFi\n    if (parsed.kind === 'bridge' && route.venue === 'lifi') {\n      const bridgeResult = await handleBridgeIntent(intent.id, parsed, route);\n      return bridgeResult;\n    }\n\n    // Step 5: Execute based on chain and type\n    updateIntentStatus(intent.id, {\n      status: 'executing',\n      executedAt: now,\n    });\n\n    // For planOnly mode (confirm flow), stop after routing and return plan\n    if (options.planOnly || options.dryRun) {\n      updateIntentStatus(intent.id, {\n        status: 'planned',\n        plannedAt: now,\n        metadataJson: buildMetadata({\n          route,\n          planOnly: true,\n          executedKind: route.executionType,\n        }),\n      });\n\n      return {\n        ok: true,\n        intentId: intent.id,\n        status: 'planned',\n        metadata: {\n          planOnly: true,\n          executedKind: route.executionType,\n          parsed: {\n            kind: parsed.kind,\n            action: parsed.action,\n            amount: parsed.amount,\n            amountUnit: parsed.amountUnit,\n            targetAsset: parsed.targetAsset,\n            leverage: parsed.leverage,\n          },\n          route: {\n            chain: route.chain,\n            network: route.network,\n            venue: route.venue,\n            executionType: route.executionType,\n            warnings: route.warnings,\n          },\n        },\n      };\n    }\n\n    // Execute on appropriate chain\n    const execResult = await executeOnChain(intent.id, parsed, route);\n    return execResult;\n\n  } catch (error: any) {\n    // Catch-all error handler\n    updateIntentStatus(intent.id, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'EXECUTION_ERROR',\n      errorMessage: error.message?.slice(0, 500),\n    });\n\n    return {\n      ok: false,\n      intentId: intent.id,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'EXECUTION_ERROR',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Execute a previously planned intent by ID\n * Used for confirm-mode flow where user reviews plan first\n */\nexport async function executeIntentById(\n  intentId: string\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n  } = await import('../../execution-ledger/db');\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Get the intent\n  const intent = getIntent(intentId);\n  if (!intent) {\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'INTENT_NOT_FOUND',\n        message: `Intent ${intentId} not found`,\n      },\n    };\n  }\n\n  // Verify intent is in planned status\n  if (intent.status !== 'planned') {\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'INVALID_STATUS',\n        message: `Intent is in ${intent.status} status, expected 'planned'`,\n      },\n    };\n  }\n\n  try {\n    // Parse the stored metadata\n    const metadata = JSON.parse(intent.metadata_json || '{}');\n    const parsed = metadata.parsed as ParsedIntent;\n    const route = metadata.route as RouteDecision;\n\n    if (!parsed || !route) {\n      return {\n        ok: false,\n        intentId,\n        status: 'failed',\n        error: {\n          stage: 'execute',\n          code: 'INVALID_METADATA',\n          message: 'Intent missing parsed or route metadata',\n        },\n      };\n    }\n\n    // Update status to executing\n    updateIntentStatus(intentId, {\n      status: 'executing',\n      executedAt: now,\n    });\n\n    // Handle bridge intents\n    if (parsed.kind === 'bridge' && route.venue === 'lifi') {\n      const bridgeResult = await handleBridgeIntent(intentId, parsed, route);\n      return bridgeResult;\n    }\n\n    // Execute on appropriate chain\n    const execResult = await executeOnChain(intentId, parsed, route);\n    return execResult;\n\n  } catch (error: any) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'EXECUTION_ERROR',\n      errorMessage: error.message?.slice(0, 500),\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'EXECUTION_ERROR',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Handle bridge intent with LiFi quote\n * Produces proof txs on both chains to record the bridge intent attempt\n */\nasync function handleBridgeIntent(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n  const { buildExplorerUrl } = await import('../ledger/ledger');\n  const { getLiFiQuote } = await import('../bridge/lifi');\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Attempt LiFi quote\n  const quoteResult = await getLiFiQuote({\n    fromChain: parsed.sourceChain || 'ethereum',\n    toChain: parsed.destChain || 'solana',\n    fromToken: parsed.amountUnit || 'REDACTED',\n    toToken: parsed.amountUnit || 'REDACTED',\n    fromAmount: (BigInt(parsed.amount || '1000') * BigInt(10 ** 6)).toString(),\n  });\n\n  // Store quote result in metadata\n  const quoteMetadata = quoteResult.ok\n    ? { quoteSuccess: true, tool: quoteResult.quote?.tool, toAmount: quoteResult.quote?.toAmount }\n    : { quoteSuccess: false, error: quoteResult.error };\n\n  // Even if quote fails, we'll still create proof txs to record the attempt\n  // This ensures we always have on-chain evidence of the bridge intent\n\n  // Create proof transaction on source chain (Sepolia)\n  const sourceProofResult = await executeProofOnly(intentId, {\n    ...parsed,\n    rawParams: {\n      ...parsed.rawParams,\n      original: `BRIDGE_INTENT_PROOF: ${parsed.rawParams.original} | quote: ${quoteResult.ok ? 'success' : 'failed'}`,\n    },\n  }, {\n    ...route,\n    chain: 'ethereum',\n    network: 'sepolia',\n  });\n\n  // If source chain proof succeeded and destination is solana, try dest chain proof too\n  let destProofResult: IntentExecutionResult | null = null;\n  if (sourceProofResult.ok && (parsed.destChain === 'solana' || parsed.destChain === 'sol')) {\n    try {\n      // We need to create a separate execution for the dest chain proof\n      const destRoute: RouteDecision = {\n        chain: 'solana',\n        network: 'devnet',\n        venue: 'bridge_proof',\n        executionType: 'proof_only',\n      };\n      destProofResult = await executeProofOnlySolana(intentId, {\n        ...parsed,\n        rawParams: {\n          ...parsed.rawParams,\n          original: `BRIDGE_DEST_PROOF: ${parsed.rawParams.original}`,\n        },\n      }, destRoute);\n    } catch (e) {\n      // Dest chain proof is best-effort\n      console.warn('[bridge] Dest chain proof failed:', e);\n    }\n  }\n\n  // Final status depends on proof txs\n  if (sourceProofResult.ok) {\n    updateIntentStatus(intentId, {\n      status: 'confirmed',\n      confirmedAt: Math.floor(Date.now() / 1000),\n      metadataJson: JSON.stringify({\n        parsed,\n        route,\n        executedKind: 'proof_only',\n        quoteMetadata,\n        sourceChainProof: {\n          txHash: sourceProofResult.txHash,\n          explorerUrl: sourceProofResult.explorerUrl,\n        },\n        destChainProof: destProofResult?.ok ? {\n          txHash: destProofResult.txHash,\n          explorerUrl: destProofResult.explorerUrl,\n        } : null,\n        note: 'Bridge execution not wired - proof txs recorded on-chain',\n      }),\n    });\n\n    return {\n      ok: true,\n      intentId,\n      status: 'confirmed',\n      executionId: sourceProofResult.executionId,\n      txHash: sourceProofResult.txHash,\n      explorerUrl: sourceProofResult.explorerUrl,\n      metadata: {\n        executedKind: 'proof_only',\n        quoteMetadata,\n        destChainProof: destProofResult?.ok ? {\n          txHash: destProofResult.txHash,\n          explorerUrl: destProofResult.explorerUrl,\n        } : null,\n      },\n    };\n  }\n\n  // If even proof tx failed, mark as failed\n  return sourceProofResult;\n}\n\n/**\n * Execute intent on the appropriate chain\n */\nasync function executeOnChain(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // For offchain analytics executions (no on-chain tx needed)\n  if ((route.executionType as string) === 'offchain') {\n    return await executeOffchain(intentId, parsed, route);\n  }\n\n  // For proof-only executions (perp, unrecognized)\n  if (route.executionType === 'proof_only') {\n    return await executeProofOnly(intentId, parsed, route);\n  }\n\n  // Real perp execution via DemoPerpAdapter\n  if (parsed.kind === 'perp' && route.executionType === 'real' && route.chain === 'ethereum') {\n    return await executePerpEthereum(intentId, parsed, route);\n  }\n\n  // Real execution based on chain\n  if (route.chain === 'ethereum') {\n    return await executeEthereum(intentId, parsed, route);\n  } else {\n    return await executeSolana(intentId, parsed, route);\n  }\n}\n\n/**\n * Execute offchain analytics intent - records to ledger without on-chain tx\n */\nasync function executeOffchain(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    updateIntentStatus,\n    createExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n\n  const now = Math.floor(Date.now() / 1000);\n  const analyticsType = parsed.rawParams?.analyticsType || 'general';\n\n  // Create execution record (offchain type)\n  const execution = createExecution({\n    chain: route.chain,\n    network: route.network as any,\n    kind: 'proof' as any, // Use 'proof' kind but mark as offchain in metadata\n    venue: 'offchain' as any,\n    intent: parsed.rawParams?.original || 'Analytics intent',\n    action: parsed.action,\n    fromAddress: 'offchain',\n    usdEstimate: 0,\n    usdEstimateIsEstimate: true,\n  });\n\n  linkExecutionToIntent(execution.id, intentId);\n\n  // Mark as confirmed immediately (no tx to wait for)\n  updateIntentStatus(intentId, {\n    status: 'confirmed',\n    confirmedAt: now,\n    metadataJson: JSON.stringify({\n      parsed,\n      route,\n      executedKind: 'offchain',\n      executionId: execution.id,\n      analyticsType,\n      note: 'Analytics-only intent. No on-chain action required.',\n      warnings: route.warnings,\n    }),\n  });\n\n  return {\n    ok: true,\n    intentId,\n    status: 'confirmed',\n    executionId: execution.id,\n    metadata: {\n      executedKind: 'offchain',\n      analyticsType,\n      note: 'Analytics-only intent. No on-chain action required.',\n      warnings: route.warnings,\n    },\n  };\n}\n\n/**\n * Execute perp position via DemoPerpAdapter on Sepolia\n * Real on-chain execution with margin deposit and position opening\n */\nasync function executePerpEthereum(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n  const { buildExplorerUrl } = await import('../ledger/ledger');\n\n  const now = Math.floor(Date.now() / 1000);\n  const startTime = Date.now();\n\n  // Get intent's existing metadata to preserve caller info (source, domain, runId)\n  const intent = getIntent(intentId);\n  const existingMetadataJson = intent?.metadata_json;\n\n  // Import config\n  const {\n    RELAYER_PRIVATE_KEY,\n    ETH_TESTNET_RPC_URL,\n    DEMO_PERP_ADAPTER_ADDRESS,\n    DEMO_REDACTED_ADDRESS,\n    EXECUTION_ROUTER_ADDRESS,\n    ERC20_PULL_ADAPTER_ADDRESS,\n  } = await import('../config');\n\n  // Validate required config\n  if (!RELAYER_PRIVATE_KEY || !ETH_TESTNET_RPC_URL) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'CONFIG_MISSING',\n      errorMessage: 'Relayer key or RPC not configured',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'CONFIG_MISSING',\n        message: 'Relayer key or RPC not configured',\n      },\n    };\n  }\n\n  if (!DEMO_PERP_ADAPTER_ADDRESS || !DEMO_REDACTED_ADDRESS || !EXECUTION_ROUTER_ADDRESS) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'PERP_CONFIG_MISSING',\n      errorMessage: 'DemoPerpAdapter or DEMO_REDACTED not configured',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'PERP_CONFIG_MISSING',\n        message: 'DemoPerpAdapter or DEMO_REDACTED not configured',\n      },\n    };\n  }\n\n  try {\n    // Import viem for transaction\n    const { encodeFunctionData, parseAbi } = await import('viem');\n    const { privateKeyToAccount } = await import('viem/accounts');\n\n    // Use failover RPC clients for reliability\n    const {\n      createFailoverPublicClient,\n      createFailoverWalletClient,\n      executeWithFailover,\n    } = await import('../providers/rpcProvider');\n\n    const account = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n\n    // Create clients with failover support (includes retry and circuit breaker)\n    const publicClient = createFailoverPublicClient();\n    const walletClient = createFailoverWalletClient(account);\n\n    // Create execution record\n    const execution = createExecution({\n      chain: 'ethereum',\n      network: 'sepolia',\n      kind: 'perp',\n      venue: 'demo_perp' as any,\n      intent: parsed.rawParams.original || 'Perp position',\n      action: parsed.action,\n      fromAddress: account.address,\n      token: 'DEMO_REDACTED',\n      amountDisplay: parsed.amount ? `${parsed.amount} REDACTED @ ${parsed.leverage}x` : undefined,\n      usdEstimate: estimateIntentUsd(parsed),\n      usdEstimateIsEstimate: true,\n    });\n\n    linkExecutionToIntent(execution.id, intentId);\n\n    // Map market string to enum value\n    const marketMap: Record<string, number> = {\n      'BTC': 0,\n      'ETH': 1,\n      'SOL': 2,\n    };\n    const market = marketMap[parsed.targetAsset?.toUpperCase() || 'BTC'] ?? 0;\n\n    // Map side to enum value\n    const side = parsed.action === 'long' ? 0 : 1;\n\n    // Calculate margin amount (default 100 DEMO_REDACTED if not specified)\n    // DEMO_REDACTED has 6 decimals\n    const marginAmount = parsed.amount\n      ? BigInt(Math.floor(parseFloat(parsed.amount) * 1e6))\n      : BigInt(100 * 1e6); // 100 REDACTED default\n\n    const leverage = parsed.leverage || 10;\n\n    // DemoPerpAdapter ABI for execute function\n    const perpAdapterAbi = parseAbi([\n      'function execute(bytes calldata innerData) external payable returns (bytes memory)',\n    ]);\n\n    // ExecutionRouter ABI\n    const routerAbi = parseAbi([\n      'function execute(address adapter, bytes calldata adapterData) external payable returns (bytes memory)',\n    ]);\n\n    // Encode inner data for DemoPerpAdapter\n    // Format: (uint8 action, address user, uint8 market, uint8 side, uint256 margin, uint256 leverage)\n    const ACTION_OPEN = 1;\n    const innerData = encodeFunctionData({\n      abi: parseAbi(['function encode(uint8,address,uint8,uint8,uint256,uint256)']),\n      functionName: 'encode',\n      args: [ACTION_OPEN, account.address, market, side, marginAmount, BigInt(leverage)],\n    }).slice(10); // Remove function selector, we just want the encoded params\n\n    // Actually, we need to encode the params directly without a function signature\n    // Use encodeAbiParameters instead\n    const { encodeAbiParameters, parseAbiParameters } = await import('viem');\n    const encodedInnerData = encodeAbiParameters(\n      parseAbiParameters('uint8, address, uint8, uint8, uint256, uint256'),\n      [ACTION_OPEN, account.address as `0x${string}`, market, side, marginAmount, BigInt(leverage)]\n    );\n\n    // Before executing perp, we need DEMO_REDACTED balance\n    // For testnet demo, we'll mint DEMO_REDACTED to the relayer first (if it's mintable)\n    // Or assume the relayer already has DEMO_REDACTED\n\n    // Encode router call\n    const routerCallData = encodeFunctionData({\n      abi: routerAbi,\n      functionName: 'execute',\n      args: [DEMO_PERP_ADAPTER_ADDRESS as `0x${string}`, encodedInnerData as `0x${string}`],\n    });\n\n    // First, approve DEMO_REDACTED to ExecutionRouter (if not already approved)\n    const erc20Abi = parseAbi([\n      'function approve(address spender, uint256 amount) external returns (bool)',\n      'function allowance(address owner, address spender) external view returns (uint256)',\n      'function balanceOf(address account) external view returns (uint256)',\n    ]);\n\n    // Check balance\n    const balance = await publicClient.readContract({\n      address: DEMO_REDACTED_ADDRESS as `0x${string}`,\n      abi: erc20Abi,\n      functionName: 'balanceOf',\n      args: [account.address],\n    });\n\n    if (balance < marginAmount) {\n      updateExecution(execution.id, {\n        status: 'failed',\n        errorCode: 'INSUFFICIENT_BALANCE',\n        errorMessage: `Insufficient DEMO_REDACTED balance: have ${balance}, need ${marginAmount}`,\n      });\n\n      updateIntentStatus(intentId, {\n        status: 'failed',\n        failureStage: 'execute',\n        errorCode: 'INSUFFICIENT_BALANCE',\n        errorMessage: 'Insufficient DEMO_REDACTED balance for perp margin',\n      });\n\n      return {\n        ok: false,\n        intentId,\n        status: 'failed',\n        executionId: execution.id,\n        error: {\n          stage: 'execute',\n          code: 'INSUFFICIENT_BALANCE',\n          message: 'Insufficient DEMO_REDACTED balance for perp margin',\n        },\n      };\n    }\n\n    // Check and set allowance to DemoPerpAdapter (called directly)\n    const allowance = await publicClient.readContract({\n      address: DEMO_REDACTED_ADDRESS as `0x${string}`,\n      abi: erc20Abi,\n      functionName: 'allowance',\n      args: [account.address, DEMO_PERP_ADAPTER_ADDRESS as `0x${string}`],\n    });\n\n    if (allowance < marginAmount) {\n      // Approve DemoPerpAdapter to spend DEMO_REDACTED\n      const approveTxHash = await walletClient.writeContract({\n        address: DEMO_REDACTED_ADDRESS as `0x${string}`,\n        abi: erc20Abi,\n        functionName: 'approve',\n        args: [DEMO_PERP_ADAPTER_ADDRESS as `0x${string}`, marginAmount * BigInt(10)], // Approve 10x to avoid future approvals\n      });\n\n      await publicClient.waitForTransactionReceipt({\n        hash: approveTxHash,\n        timeout: 60000,\n      });\n    }\n\n    // Execute the perp position directly via adapter\n    // DemoPerpAdapter.execute pulls tokens from msg.sender\n    const txHash = await walletClient.writeContract({\n      address: DEMO_PERP_ADAPTER_ADDRESS as `0x${string}`,\n      abi: perpAdapterAbi,\n      functionName: 'execute',\n      args: [encodedInnerData as `0x${string}`],\n    });\n\n    // Wait for confirmation\n    const receipt = await publicClient.waitForTransactionReceipt({\n      hash: txHash,\n      timeout: 60000,\n    });\n\n    const latencyMs = Date.now() - startTime;\n    const explorerUrl = buildExplorerUrl('ethereum', 'sepolia', txHash);\n\n    if (receipt.status === 'success') {\n      // Import position and step functions\n      const { createPosition, createExecutionStep, updateExecutionStep } = await import('../../execution-ledger/db');\n\n      // Create execution steps for tracking\n      const routeStep = createExecutionStep({\n        executionId: execution.id,\n        stepIndex: 0,\n        action: 'route',\n        stage: 'route',\n      });\n      updateExecutionStep(routeStep.id, { status: 'confirmed' });\n\n      const executeStep = createExecutionStep({\n        executionId: execution.id,\n        stepIndex: 1,\n        action: 'open_position',\n        stage: 'execute',\n      });\n      updateExecutionStep(executeStep.id, {\n        status: 'confirmed',\n        txHash: txHash,\n        explorerUrl: explorerUrl,\n      });\n\n      // Parse position ID from logs (PerpPositionOpened event)\n      let onChainPositionId: string | undefined;\n      try {\n        // Look for PositionOpened event in logs\n        const positionOpenedTopic = '0x' + Buffer.from('PositionOpened(address,uint256,uint8,uint8,uint256,uint256,uint256,uint256)').slice(0, 32).toString('hex');\n        for (const log of receipt.logs) {\n          if (log.topics[0]?.toLowerCase().includes('position')) {\n            // Extract position ID from topics (indexed param)\n            if (log.topics[2]) {\n              onChainPositionId = BigInt(log.topics[2]).toString();\n              break;\n            }\n          }\n        }\n      } catch (e) {\n        // Position ID extraction failed, continue without it\n      }\n\n      // Create position in ledger (indexer will also catch it, but this is faster)\n      const marketName = parsed.targetAsset?.toUpperCase() || 'BTC';\n      const positionSide = parsed.action === 'long' ? 'long' : 'short';\n\n      createPosition({\n        chain: 'ethereum',\n        network: 'sepolia',\n        venue: 'demo_perp',\n        market: marketName,\n        side: positionSide,\n        leverage,\n        margin_units: marginAmount.toString(),\n        margin_display: `${(Number(marginAmount) / 1e6).toFixed(2)} REDACTED`,\n        size_units: (marginAmount * BigInt(leverage)).toString(),\n        open_tx_hash: txHash,\n        open_explorer_url: explorerUrl,\n        user_address: account.address,\n        on_chain_position_id: onChainPositionId,\n        intent_id: intentId,\n        execution_id: execution.id,\n      });\n\n      updateExecution(execution.id, {\n        status: 'confirmed',\n        txHash,\n        explorerUrl,\n        blockNumber: Number(receipt.blockNumber),\n        gasUsed: receipt.gasUsed.toString(),\n        latencyMs,\n      });\n\n      updateIntentStatus(intentId, {\n        status: 'confirmed',\n        confirmedAt: Math.floor(Date.now() / 1000),\n        metadataJson: mergeMetadata(existingMetadataJson, {\n          parsed,\n          route,\n          executedKind: 'real',\n          executionId: execution.id,\n          txHash,\n          explorerUrl,\n          perpDetails: {\n            market: marketName,\n            side: positionSide,\n            margin: marginAmount.toString(),\n            leverage,\n          },\n        }),\n      });\n\n      return {\n        ok: true,\n        intentId,\n        status: 'confirmed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        metadata: {\n          executedKind: 'real',\n          perpDetails: {\n            market: marketName,\n            side: positionSide,\n            leverage,\n          },\n        },\n      };\n    } else {\n      updateExecution(execution.id, {\n        status: 'failed',\n        txHash,\n        explorerUrl,\n        errorCode: 'TX_REVERTED',\n        errorMessage: 'Perp position transaction reverted',\n      });\n\n      updateIntentStatus(intentId, {\n        status: 'failed',\n        failureStage: 'confirm',\n        errorCode: 'TX_REVERTED',\n        errorMessage: 'Perp position transaction reverted on-chain',\n      });\n\n      return {\n        ok: false,\n        intentId,\n        status: 'failed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        error: {\n          stage: 'confirm',\n          code: 'TX_REVERTED',\n          message: 'Perp position transaction reverted',\n        },\n      };\n    }\n  } catch (error: any) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'PERP_EXECUTION_ERROR',\n      errorMessage: error.message?.slice(0, 200),\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'PERP_EXECUTION_ERROR',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Execute proof-only transaction - sends REAL on-chain proof tx\n * Records intent on-chain with txHash and explorerUrl\n */\nasync function executeProofOnly(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n  const { buildExplorerUrl } = await import('../ledger/ledger');\n\n  // Get intent's existing metadata to preserve caller info (source, domain, runId)\n  const intent = getIntent(intentId);\n  const existingMetadataJson = intent?.metadata_json;\n\n  const now = Math.floor(Date.now() / 1000);\n  const startTime = Date.now();\n\n  // Route to appropriate chain for proof tx\n  if (route.chain === 'solana') {\n    return await executeProofOnlySolana(intentId, parsed, route);\n  }\n\n  // Default: Ethereum Sepolia proof tx\n  const {\n    RELAYER_PRIVATE_KEY,\n    ETH_TESTNET_RPC_URL,\n  } = await import('../config');\n\n  if (!RELAYER_PRIVATE_KEY || !ETH_TESTNET_RPC_URL) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'CONFIG_MISSING',\n      errorMessage: 'Relayer key or RPC not configured for Sepolia proof tx',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'CONFIG_MISSING',\n        message: 'Relayer key or RPC not configured',\n      },\n    };\n  }\n\n  try {\n    // Import viem for transaction\n    const { createPublicClient, createWalletClient, http, toHex } = await import('viem');\n    const { sepolia } = await import('viem/chains');\n    const { privateKeyToAccount } = await import('viem/accounts');\n\n    const account = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n    const walletClient = createWalletClient({\n      account,\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    // Create execution record\n    const execution = createExecution({\n      chain: 'ethereum',\n      network: 'sepolia',\n      kind: 'proof',\n      venue: route.venue as any,\n      intent: parsed.rawParams.original || 'Intent proof',\n      action: 'proof',\n      fromAddress: account.address,\n      token: parsed.amountUnit,\n      usdEstimate: estimateIntentUsd(parsed),\n      usdEstimateIsEstimate: true,\n    });\n\n    linkExecutionToIntent(execution.id, intentId);\n\n    // Build proof metadata for calldata\n    const proofData = {\n      type: 'BLOSSOM_INTENT_PROOF',\n      intentId: intentId.slice(0, 8),\n      kind: parsed.kind,\n      action: parsed.action,\n      asset: parsed.targetAsset || parsed.amountUnit,\n      timestamp: now,\n    };\n    const proofHex = toHex(JSON.stringify(proofData));\n\n    // Send proof tx (self-transfer with metadata in data field)\n    const transferAmount = BigInt(1); // 1 wei as proof marker\n\n    const txHash = await walletClient.sendTransaction({\n      to: account.address,\n      value: transferAmount,\n      data: proofHex as `0x${string}`,\n    });\n\n    // Wait for confirmation\n    const receipt = await publicClient.waitForTransactionReceipt({\n      hash: txHash,\n      timeout: 60000,\n    });\n\n    const latencyMs = Date.now() - startTime;\n    const explorerUrl = buildExplorerUrl('ethereum', 'sepolia', txHash);\n\n    if (receipt.status === 'success') {\n      updateExecution(execution.id, {\n        status: 'confirmed',\n        txHash,\n        explorerUrl,\n        blockNumber: Number(receipt.blockNumber),\n        gasUsed: receipt.gasUsed.toString(),\n        latencyMs,\n      });\n\n      updateIntentStatus(intentId, {\n        status: 'confirmed',\n        confirmedAt: Math.floor(Date.now() / 1000),\n        metadataJson: mergeMetadata(existingMetadataJson, {\n          parsed,\n          route,\n          executedKind: 'proof_only',\n          executionId: execution.id,\n          txHash,\n          explorerUrl,\n          warnings: route.warnings,\n        }),\n      });\n\n      return {\n        ok: true,\n        intentId,\n        status: 'confirmed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        metadata: {\n          executedKind: 'proof_only',\n          warnings: route.warnings,\n        },\n      };\n    } else {\n      updateExecution(execution.id, {\n        status: 'failed',\n        txHash,\n        explorerUrl,\n        errorCode: 'TX_REVERTED',\n        errorMessage: 'Proof transaction reverted',\n      });\n\n      updateIntentStatus(intentId, {\n        status: 'failed',\n        failureStage: 'confirm',\n        errorCode: 'TX_REVERTED',\n        errorMessage: 'Proof transaction reverted on-chain',\n      });\n\n      return {\n        ok: false,\n        intentId,\n        status: 'failed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        error: {\n          stage: 'confirm',\n          code: 'TX_REVERTED',\n          message: 'Proof transaction reverted',\n        },\n      };\n    }\n  } catch (error: any) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'PROOF_TX_FAILED',\n      errorMessage: error.message?.slice(0, 200),\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'PROOF_TX_FAILED',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Execute proof-only transaction on Solana devnet\n */\nasync function executeProofOnlySolana(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n  const { buildExplorerUrl } = await import('../ledger/ledger');\n\n  // Get intent's existing metadata to preserve caller info (source, domain, runId)\n  const intent = getIntent(intentId);\n  const existingMetadataJson = intent?.metadata_json;\n\n  const now = Math.floor(Date.now() / 1000);\n  const startTime = Date.now();\n\n  // Check for Solana private key\n  const solanaPrivateKey = process.env.SOLANA_PRIVATE_KEY;\n\n  if (!solanaPrivateKey) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'CONFIG_MISSING',\n      errorMessage: 'Solana wallet not configured for proof tx',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'CONFIG_MISSING',\n        message: 'Solana wallet not configured',\n      },\n    };\n  }\n\n  try {\n    // Use the existing Solana proof tx logic from solana-ledger-smoke\n    const { SolanaClient } = await import('../solana/solanaClient');\n    const crypto = await import('crypto');\n\n    // Base58 helpers\n    const BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';\n\n    function base58Decode(str: string): Buffer {\n      const bytes = [0];\n      for (const char of str) {\n        let value = BASE58_ALPHABET.indexOf(char);\n        if (value === -1) throw new Error(`Invalid base58 character: ${char}`);\n        for (let i = 0; i < bytes.length; i++) {\n          const product = bytes[i] * 58 + value;\n          bytes[i] = product % 256;\n          value = Math.floor(product / 256);\n        }\n        while (value > 0) {\n          bytes.push(value % 256);\n          value = Math.floor(value / 256);\n        }\n      }\n      for (const char of str) {\n        if (char !== '1') break;\n        bytes.push(0);\n      }\n      return Buffer.from(bytes.reverse());\n    }\n\n    function base58Encode(buffer: Buffer): string {\n      const digits = [0];\n      for (let i = 0; i < buffer.length; i++) {\n        let carry = buffer[i];\n        for (let j = 0; j < digits.length; j++) {\n          carry += digits[j] << 8;\n          digits[j] = carry % 58;\n          carry = Math.floor(carry / 58);\n        }\n        while (carry > 0) {\n          digits.push(carry % 58);\n          carry = Math.floor(carry / 58);\n        }\n      }\n      let output = '';\n      for (let i = 0; i < buffer.length && buffer[i] === 0; i++) {\n        output += BASE58_ALPHABET[0];\n      }\n      for (let i = digits.length - 1; i >= 0; i--) {\n        output += BASE58_ALPHABET[digits[i]];\n      }\n      return output;\n    }\n\n    // Parse sender keypair\n    const secretKey = base58Decode(solanaPrivateKey);\n    if (secretKey.length !== 64) {\n      throw new Error(`Invalid Solana secret key length: ${secretKey.length}`);\n    }\n    const privateKey = secretKey.slice(0, 32);\n    const publicKey = secretKey.slice(32, 64);\n    const senderPubkey = base58Encode(publicKey);\n\n    // Create execution record\n    const execution = createExecution({\n      chain: 'solana',\n      network: 'devnet',\n      kind: 'proof',\n      venue: route.venue as any,\n      intent: parsed.rawParams.original || 'Intent proof',\n      action: 'proof',\n      fromAddress: senderPubkey,\n      token: parsed.amountUnit || 'SOL',\n      usdEstimate: estimateIntentUsd(parsed),\n      usdEstimateIsEstimate: true,\n    });\n\n    linkExecutionToIntent(execution.id, intentId);\n\n    // Use SolanaClient to send a small transfer as proof\n    const client = new SolanaClient();\n    const DEVNET_RPC = 'https://api.devnet.solana.com';\n    const LAMPORTS_PER_SOL = 1_000_000_000;\n    const transferLamports = 1000; // 0.000001 SOL as proof marker\n\n    // Get recent blockhash\n    const { blockhash } = await client.getRecentBlockhash();\n\n    // Build and sign transaction (using the existing pattern from smoke test)\n    // System Program ID (all zeros)\n    const systemProgramId = Buffer.alloc(32);\n\n    function encodeCompactU16(value: number): Buffer {\n      if (value < 128) return Buffer.from([value]);\n      if (value < 16384) return Buffer.from([(value & 0x7f) | 0x80, value >> 7]);\n      return Buffer.from([(value & 0x7f) | 0x80, ((value >> 7) & 0x7f) | 0x80, value >> 14]);\n    }\n\n    // Transfer instruction data\n    const instructionData = Buffer.alloc(12);\n    instructionData.writeUInt32LE(2, 0); // Transfer instruction\n    instructionData.writeBigUInt64LE(BigInt(transferLamports), 4);\n\n    // For self-transfer: only include sender once, reference it twice in instruction\n    // Header: [num_sigs, num_readonly_signed, num_readonly_unsigned]\n    // For self-transfer: 1 signer (sender), 0 readonly signed, 1 readonly unsigned (system program)\n    const header = Buffer.from([1, 0, 1]);\n    const accountsLength = encodeCompactU16(2);\n    // accounts: [sender (writable, signer), system_program (readonly)]\n    const accounts = Buffer.concat([publicKey, systemProgramId]);\n    const blockhashBytes = base58Decode(blockhash);\n\n    const instructionsLength = encodeCompactU16(1);\n    const programIdIndex = Buffer.from([1]); // System program is at index 1\n    const accountIndicesLength = encodeCompactU16(2);\n    // For self-transfer: source=0, dest=0 (same account)\n    const accountIndices = Buffer.from([0, 0]);\n    const dataLength = encodeCompactU16(instructionData.length);\n\n    const instruction = Buffer.concat([\n      programIdIndex, accountIndicesLength, accountIndices, dataLength, instructionData\n    ]);\n\n    const message = Buffer.concat([\n      header, accountsLength, accounts, blockhashBytes, instructionsLength, instruction\n    ]);\n\n    // Sign message\n    const keyObject = crypto.createPrivateKey({\n      key: Buffer.concat([Buffer.from('302e020100300506032b657004220420', 'hex'), privateKey]),\n      format: 'der',\n      type: 'pkcs8',\n    });\n    const signature = Buffer.from(crypto.sign(null, message, keyObject));\n\n    // Build signed transaction\n    const signedTx = Buffer.concat([Buffer.from([1]), signature, message]);\n    const signedTxBase64 = signedTx.toString('base64');\n\n    // Send transaction\n    const txSignature = await client.sendTransaction(signedTxBase64);\n\n    // Wait for confirmation\n    const result = await client.confirmTransaction(txSignature, 'confirmed', 60000);\n\n    const latencyMs = Date.now() - startTime;\n    const explorerUrl = buildExplorerUrl('solana', 'devnet', txSignature);\n\n    updateExecution(execution.id, {\n      status: 'confirmed',\n      txHash: txSignature,\n      explorerUrl,\n      blockNumber: result.slot,\n      latencyMs,\n    });\n\n    updateIntentStatus(intentId, {\n      status: 'confirmed',\n      confirmedAt: Math.floor(Date.now() / 1000),\n      metadataJson: mergeMetadata(existingMetadataJson, {\n        parsed,\n        route,\n        executedKind: 'proof_only',\n        executionId: execution.id,\n        txHash: txSignature,\n        explorerUrl,\n        warnings: route.warnings,\n      }),\n    });\n\n    return {\n      ok: true,\n      intentId,\n      status: 'confirmed',\n      executionId: execution.id,\n      txHash: txSignature,\n      explorerUrl,\n      metadata: {\n        executedKind: 'proof_only',\n        warnings: route.warnings,\n      },\n    };\n  } catch (error: any) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'SOLANA_PROOF_TX_FAILED',\n      errorMessage: error.message?.slice(0, 200),\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'SOLANA_PROOF_TX_FAILED',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Execute on Ethereum Sepolia\n */\nasync function executeEthereum(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n\n  // Get intent's existing metadata to preserve caller info (source, domain, runId)\n  const intent = getIntent(intentId);\n  const existingMetadataJson = intent?.metadata_json;\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Check config\n  const {\n    RELAYER_PRIVATE_KEY,\n    ETH_TESTNET_RPC_URL,\n  } = await import('../config');\n\n  if (!RELAYER_PRIVATE_KEY || !ETH_TESTNET_RPC_URL) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'CONFIG_MISSING',\n      errorMessage: 'Ethereum relayer not configured',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'CONFIG_MISSING',\n        message: 'Ethereum relayer not configured',\n      },\n    };\n  }\n\n  // Create execution record\n  const mappedKind = parsed.kind === 'unknown' ? 'proof' : parsed.kind;\n  const execution = createExecution({\n    chain: 'ethereum',\n    network: 'sepolia',\n    kind: mappedKind as ExecutionKind,\n    venue: route.venue as any,\n    intent: parsed.rawParams.original || 'Intent execution',\n    action: parsed.action,\n    fromAddress: '0x0000000000000000000000000000000000000000', // Will be updated\n    token: parsed.amountUnit,\n    amountDisplay: parsed.amount ? `${parsed.amount} ${parsed.amountUnit}` : undefined,\n    usdEstimate: estimateIntentUsd(parsed),\n    usdEstimateIsEstimate: true,\n  });\n\n  linkExecutionToIntent(execution.id, intentId);\n\n  try {\n    // Attempt real execution via viem\n    const { createPublicClient, createWalletClient, http } = await import('viem');\n    const { sepolia } = await import('viem/chains');\n    const { privateKeyToAccount } = await import('viem/accounts');\n\n    const account = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n    const walletClient = createWalletClient({\n      account,\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    // For demo purposes, send a small ETH transfer to self as proof\n    const transferAmount = BigInt(1000000000000); // 0.000001 ETH\n\n    const txHash = await walletClient.sendTransaction({\n      to: account.address,\n      value: transferAmount,\n    });\n\n    // Wait for confirmation\n    const receipt = await publicClient.waitForTransactionReceipt({\n      hash: txHash,\n      timeout: 60000,\n    });\n\n    const explorerUrl = `https://sepolia.etherscan.io/tx/${txHash}`;\n    const latencyMs = Date.now() - (now * 1000);\n\n    updateExecution(execution.id, {\n      status: receipt.status === 'success' ? 'confirmed' : 'failed',\n      txHash,\n      explorerUrl,\n      blockNumber: Number(receipt.blockNumber),\n      gasUsed: receipt.gasUsed.toString(),\n      latencyMs,\n    });\n\n    if (receipt.status === 'success') {\n      updateIntentStatus(intentId, {\n        status: 'confirmed',\n        confirmedAt: Math.floor(Date.now() / 1000),\n        metadataJson: mergeMetadata(existingMetadataJson, {\n          parsed,\n          route,\n          executedKind: 'real',\n          executionId: execution.id,\n          txHash,\n          explorerUrl,\n        }),\n      });\n\n      return {\n        ok: true,\n        intentId,\n        status: 'confirmed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        metadata: {\n          executedKind: 'real',\n        },\n      };\n    } else {\n      updateIntentStatus(intentId, {\n        status: 'failed',\n        failureStage: 'confirm',\n        errorCode: 'TX_REVERTED',\n        errorMessage: 'Transaction reverted on-chain',\n      });\n\n      return {\n        ok: false,\n        intentId,\n        status: 'failed',\n        executionId: execution.id,\n        txHash,\n        explorerUrl,\n        error: {\n          stage: 'confirm',\n          code: 'TX_REVERTED',\n          message: 'Transaction reverted on-chain',\n        },\n      };\n    }\n  } catch (error: any) {\n    updateExecution(execution.id, {\n      status: 'failed',\n      errorCode: 'EXECUTION_ERROR',\n      errorMessage: error.message?.slice(0, 200),\n    });\n\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'EXECUTION_ERROR',\n      errorMessage: error.message?.slice(0, 200),\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      executionId: execution.id,\n      error: {\n        stage: 'execute',\n        code: 'EXECUTION_ERROR',\n        message: error.message,\n      },\n    };\n  }\n}\n\n/**\n * Execute on Solana Devnet\n */\nasync function executeSolana(\n  intentId: string,\n  parsed: ParsedIntent,\n  route: RouteDecision\n): Promise<IntentExecutionResult> {\n  const {\n    getIntent,\n    updateIntentStatus,\n    createExecution,\n    updateExecution,\n    linkExecutionToIntent,\n  } = await import('../../execution-ledger/db');\n\n  // Get intent's existing metadata to preserve caller info (source, domain, runId)\n  const existingIntent = getIntent(intentId);\n  const existingMetadataJson = existingIntent?.metadata_json;\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Check for Solana private key\n  const solanaPrivateKey = process.env.SOLANA_PRIVATE_KEY;\n\n  if (!solanaPrivateKey) {\n    updateIntentStatus(intentId, {\n      status: 'failed',\n      failureStage: 'execute',\n      errorCode: 'CONFIG_MISSING',\n      errorMessage: 'Solana wallet not configured',\n    });\n\n    return {\n      ok: false,\n      intentId,\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'CONFIG_MISSING',\n        message: 'Solana wallet not configured',\n      },\n    };\n  }\n\n  // Create execution record\n  const solanaKind = parsed.kind === 'unknown' ? 'proof' : parsed.kind;\n  const execution = createExecution({\n    chain: 'solana',\n    network: 'devnet',\n    kind: solanaKind as ExecutionKind,\n    venue: route.venue as any,\n    intent: parsed.rawParams.original || 'Intent execution',\n    action: parsed.action,\n    fromAddress: 'PENDING', // Will be updated\n    token: parsed.amountUnit || 'SOL',\n    usdEstimate: estimateIntentUsd(parsed),\n    usdEstimateIsEstimate: true,\n  });\n\n  linkExecutionToIntent(execution.id, intentId);\n\n  // For MVP: Mark as confirmed without actual execution\n  // Full Solana execution would use the SolanaClient\n  updateExecution(execution.id, {\n    status: 'confirmed',\n    latencyMs: 100,\n  });\n\n  updateIntentStatus(intentId, {\n    status: 'confirmed',\n    confirmedAt: Math.floor(Date.now() / 1000),\n    metadataJson: mergeMetadata(existingMetadataJson, {\n      parsed,\n      route,\n      executedKind: 'real',\n      executionId: execution.id,\n      note: 'Solana execution simulated for MVP',\n    }),\n  });\n\n  return {\n    ok: true,\n    intentId,\n    status: 'confirmed',\n    executionId: execution.id,\n    metadata: {\n      executedKind: 'real',\n      note: 'Solana execution simulated for MVP',\n    },\n  };\n}\n\n/**\n * Run multiple intents in batch\n */\nexport async function runIntentBatch(\n  intents: string[],\n  options: {\n    chain?: ChainTarget;\n    dryRun?: boolean;\n    parallel?: boolean;\n  } = {}\n): Promise<IntentExecutionResult[]> {\n  if (options.parallel) {\n    return Promise.all(intents.map(intent => runIntent(intent, options)));\n  }\n\n  const results: IntentExecutionResult[] = [];\n  for (const intent of intents) {\n    const result = await runIntent(intent, options);\n    results.push(result);\n  }\n  return results;\n}\n\n/**\n * Record a failed intent for tracking purposes\n * This ensures ALL attempts (even validation failures) appear in stats\n */\nexport async function recordFailedIntent(params: {\n  intentText: string;\n  failureStage: IntentFailureStage;\n  errorCode: string;\n  errorMessage: string;\n  metadata?: Record<string, any>;\n}): Promise<IntentExecutionResult> {\n  const { createIntent, updateIntentStatus } = await import('../../execution-ledger/db');\n\n  const now = Math.floor(Date.now() / 1000);\n\n  // Create intent record even for failures\n  const intent = createIntent({\n    intentText: params.intentText || '[empty]',\n    intentKind: 'unknown',\n    metadataJson: JSON.stringify(params.metadata || {}),\n  });\n\n  // Immediately mark as failed\n  updateIntentStatus(intent.id, {\n    status: 'failed',\n    failureStage: params.failureStage,\n    errorCode: params.errorCode,\n    errorMessage: params.errorMessage,\n    metadataJson: JSON.stringify({\n      ...params.metadata,\n      failedAt: now,\n    }),\n  });\n\n  return {\n    ok: false,\n    intentId: intent.id,\n    status: 'failed',\n    error: {\n      stage: params.failureStage,\n      code: params.errorCode,\n      message: params.errorMessage,\n    },\n  };\n}\n", "// @ts-nocheck\n/**\n * Blossom Agent HTTP Server\n * Provides API endpoints for the React front-end\n */\n\n// Load environment variables FIRST (before any other imports that use process.env)\nimport { config } from 'dotenv';\nimport { resolve, dirname } from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\nconst agentDir = resolve(__dirname, '../..');\nconst rootDir = resolve(agentDir, '..');\n\n// Load .env files with precedence (most specific first)\n// Precedence: agent/.env.local \u2192 agent/.env \u2192 root/.env.local \u2192 root/.env\nconst envFiles = [\n  resolve(agentDir, '.env.local'),\n  resolve(agentDir, '.env'),\n  resolve(rootDir, '.env.local'),\n  resolve(rootDir, '.env'),\n];\n\nlet loadedEnvFile: string | null = null;\nfor (const envFile of envFiles) {\n  const result = config({ path: envFile });\n  if (!result.error) {\n    loadedEnvFile = envFile;\n    break; // First successful load wins\n  }\n}\n\n// Log which env file was loaded (or if none)\nif (loadedEnvFile) {\n  console.log(`\uD83D\uDCC4 Loaded environment from: ${loadedEnvFile}`);\n} else {\n  console.log(`\u26A0\uFE0F  No .env file found (using system environment variables)`);\n}\n\nimport express from 'express';\nimport cors from 'cors';\nimport { BlossomAction, BlossomPortfolioSnapshot, BlossomExecutionRequest, ExecutionResult } from '../types/blossom';\nimport { validateActions, buildBlossomPrompts } from '../utils/actionParser';\nimport { callLlm } from '../services/llmClient';\nimport * as perpsSim from '../plugins/perps-sim';\nimport * as defiSim from '../plugins/defi-sim';\n\n// Allowed CORS origins for MVP\nconst ALLOWED_ORIGINS = [\n  'http://localhost:5173',\n  'http://127.0.0.1:5173',\n  'https://blossom.onl',\n  'https://www.blossom.onl',\n  // Preview/staging subdomains\n  /^https:\\/\\/.*\\.blossom\\.onl$/,\n];\nimport * as eventSim from '../plugins/event-sim';\nimport { resetAllSims, getPortfolioSnapshot } from '../services/state';\nimport { getOnchainTicker, getEventMarketsTicker } from '../services/ticker';\nimport { logExecutionArtifact, getExecutionArtifacts, dumpExecutionArtifacts } from '../utils/executionLogger';\nimport { validateAccessCode, hasAccess, loadAccessCodesFromEnv, getAllAccessCodes, createAccessCode, revokeAccessCode, checkAccess } from '../utils/accessGate';\nimport { logEvent, createRequestLogger, hashAddress } from '../telemetry/logger';\nimport { waitForReceipt } from '../executors/evmReceipt';\n\n/**\n * JSON-RPC Response type\n */\ntype JsonRpcResponse<T = unknown> = {\n  result?: T;\n  error?: { message?: string; code?: number; data?: unknown };\n};\n\nconst app = express();\n// Configure CORS with specific origins for security\napp.use(cors({\n  origin: (origin, callback) => {\n    // Allow requests with no origin (like curl, mobile apps, or same-origin)\n    if (!origin) {\n      return callback(null, true);\n    }\n\n    // Check against allowed origins\n    const isAllowed = ALLOWED_ORIGINS.some(allowed => {\n      if (typeof allowed === 'string') {\n        return origin === allowed;\n      }\n      // RegExp for pattern matching (subdomains)\n      return allowed.test(origin);\n    });\n\n    if (isAllowed) {\n      return callback(null, true);\n    }\n\n    // In development, also allow any localhost port\n    if (process.env.NODE_ENV !== 'production' && origin.includes('localhost')) {\n      return callback(null, true);\n    }\n\n    console.warn(`[CORS] Blocked origin: ${origin}`);\n    return callback(null, false);\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'X-Ledger-Secret', 'X-Access-Code', 'X-Wallet-Address', 'x-correlation-id'],\n}));\napp.use(express.json());\n\n// ============================================\n// TELEMETRY-ONLY MODE: Block sensitive endpoints\n// ============================================\nconst TELEMETRY_ONLY = process.env.TELEMETRY_ONLY === 'true';\n\n// Allowlisted routes in telemetry-only mode (read-only telemetry data)\nconst TELEMETRY_ALLOWLIST = [\n  'GET /health',\n  'GET /api/health',\n  'GET /api/rpc/health',\n  'GET /api/telemetry/summary',\n  'GET /api/telemetry/devnet-stats',\n  'GET /api/telemetry/users',\n  'GET /api/telemetry/executions',\n  'GET /api/telemetry/runs',\n  'GET /api/telemetry/debug',\n  'POST /api/telemetry/runs', // Allow campaign script to post run data\n];\n\nif (TELEMETRY_ONLY) {\n  console.log('');\n  console.log('================================================================================');\n  console.log('  TELEMETRY-ONLY MODE ENABLED');\n  console.log('  Only read-only telemetry endpoints are accessible.');\n  console.log('  All execution, session, and sensitive endpoints are BLOCKED.');\n  console.log('================================================================================');\n  console.log('');\n  console.log('ALLOWED ROUTES:');\n  TELEMETRY_ALLOWLIST.forEach(route => console.log(`  \u2705 ${route}`));\n  console.log('');\n  console.log('BLOCKED ROUTES (returning 403):');\n  console.log('  \u274C POST /api/chat');\n  console.log('  \u274C POST /api/execute/*');\n  console.log('  \u274C POST /api/session/*');\n  console.log('  \u274C GET /api/session/*');\n  console.log('  \u274C POST /api/setup/*');\n  console.log('  \u274C POST /api/token/*');\n  console.log('  \u274C GET /api/portfolio/*');\n  console.log('  \u274C GET /api/defi/*');\n  console.log('  \u274C GET /api/wallet/*');\n  console.log('  \u274C POST /api/demo/*');\n  console.log('  \u274C GET /api/debug/*');\n  console.log('  \u274C ... and all other non-telemetry routes');\n  console.log('================================================================================');\n  console.log('');\n\n  // Middleware to block non-allowlisted routes\n  app.use((req, res, next) => {\n    const routeKey = `${req.method} ${req.path}`;\n\n    // Check if route is in allowlist\n    const isAllowed = TELEMETRY_ALLOWLIST.some(allowed => {\n      // Exact match\n      if (routeKey === allowed) return true;\n      // Prefix match for paths with params (e.g., GET /api/telemetry/runs?limit=10)\n      const [method, path] = allowed.split(' ');\n      if (req.method === method && req.path === path) return true;\n      return false;\n    });\n\n    if (!isAllowed) {\n      console.log(`[TELEMETRY_ONLY] BLOCKED: ${routeKey}`);\n      return res.status(403).json({\n        ok: false,\n        error: 'Forbidden: This endpoint is disabled in telemetry-only mode',\n        telemetryOnly: true,\n      });\n    }\n\n    next();\n  });\n}\n\n// ============================================\n// OBSERVABILITY: Correlation ID + Request Logging\n// ============================================\nimport { randomUUID } from 'crypto';\nimport { makeCorrelationId } from '../utils/correlationId';\n\n// Extend Express Request type for correlation ID\ndeclare global {\n  namespace Express {\n    interface Request {\n      correlationId?: string;\n    }\n  }\n}\n\n/**\n * Generate short correlation ID (8 chars for readability)\n */\nfunction generateCorrelationId(): string {\n  // Use centralized correlation ID generator for consistency\n  return makeCorrelationId();\n}\n\n/**\n * Correlation ID middleware\n * - Accepts x-correlation-id header if provided\n * - Generates one if not provided\n * - Attaches to req and response header\n * - Logs request/response timing\n */\napp.use((req, res, next) => {\n  const correlationId = (req.headers['x-correlation-id'] as string) || generateCorrelationId();\n  req.correlationId = correlationId;\n  res.setHeader('x-correlation-id', correlationId);\n\n  const startTime = Date.now();\n\n  // Get visitor address from headers or query (check multiple param names)\n  const visitorAddress = (req.headers['x-visitor-address'] as string) ||\n                        (req.query.userAddress as string) ||\n                        (req.query.visitor as string) ||\n                        (req.query.address as string) ||\n                        null;\n\n  // Log response on finish\n  res.on('finish', async () => {\n    const duration = Date.now() - startTime;\n    const isSessionOrExecute = req.path.includes('/session/') || req.path.includes('/execute/');\n\n    // Always log session/execute routes, others only in dev or on error\n    if (isSessionOrExecute || process.env.NODE_ENV !== 'production' || res.statusCode >= 400) {\n      console.log(`[${correlationId}] ${req.method} ${req.path} -> ${res.statusCode} (${duration}ms)`);\n    }\n\n    // Log ALL requests to database for devnet stats (skip static assets)\n    if (!req.path.includes('.') && req.path.startsWith('/')) {\n      try {\n        const { logRequest } = await import('../../telemetry/db');\n        logRequest({\n          endpoint: req.path,\n          method: req.method,\n          userAddress: visitorAddress,\n          statusCode: res.statusCode,\n          latencyMs: duration,\n          correlationId,\n        });\n      } catch (e) {\n        // Fail silently - don't break request handling\n      }\n    }\n  });\n\n  next();\n});\n\n/**\n * Async handler wrapper for proper error propagation\n */\ntype AsyncHandler = (req: express.Request, res: express.Response, next: express.NextFunction) => Promise<any>;\n\nfunction asyncHandler(fn: AsyncHandler): express.RequestHandler {\n  return (req, res, next) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n}\n\n/**\n * Session trace logger - logs session state transitions (NO secrets)\n */\nfunction logSessionTrace(correlationId: string, event: string, data: Record<string, any> = {}): void {\n  const safeData = { ...data };\n  // Remove any potential secrets\n  delete safeData.privateKey;\n  delete safeData.signature;\n  delete safeData.apiKey;\n  delete safeData.secret;\n  \n  console.log(`[${correlationId}] [SESSION] ${event}`, JSON.stringify(safeData));\n}\n\n/**\n * Execution trace logger - logs execution state transitions (NO secrets)\n */\nfunction logExecuteTrace(correlationId: string, event: string, data: Record<string, any> = {}): void {\n  const safeData = { ...data };\n  // Remove any potential secrets\n  delete safeData.privateKey;\n  delete safeData.signature;\n  delete safeData.apiKey;\n  delete safeData.secret;\n  \n  console.log(`[${correlationId}] [EXECUTE] ${event}`, JSON.stringify(safeData));\n}\n\n/**\n * Plan missing logger - logs when executionRequest is expected but missing\n */\nfunction logPlanMissing(correlationId: string, suspectedIntent: string, userMessage: string): void {\n  const snippet = userMessage.substring(0, 100) + (userMessage.length > 100 ? '...' : '');\n  console.log(`[${correlationId}] [PLAN_MISSING] suspectedIntent=${suspectedIntent} message=\"${snippet}\"`);\n}\n\n/**\n * Detect if user message suggests an actionable intent\n */\nfunction detectSuspectedIntent(userMessage: string): string | null {\n  const lower = userMessage.toLowerCase();\n  \n  // Swap intents\n  if (/\\b(swap|exchange|convert)\\b/.test(lower)) return 'swap';\n  \n  // Perp intents  \n  if (/\\b(long|short|leverage|perp|margin|position)\\b/.test(lower)) return 'perp';\n  \n  // DeFi intents\n  if (/\\b(deposit|lend|supply|borrow|stake|yield|apy|earn|lending)\\b/.test(lower)) return 'defi';\n  \n  // Event intents\n  if (/\\b(bet|predict|prediction|wager)\\b/.test(lower)) return 'event';\n  \n  return null;\n}\n\n// Access gate feature flag\nconst ACCESS_GATE_ENABLED = process.env.ACCESS_GATE_ENABLED === \"true\";\nconst maybeCheckAccess = ACCESS_GATE_ENABLED ? checkAccess : (req: any, res: any, next: any) => next();\n\n// Initialize access gate on startup (safe - won't crash if disabled)\nloadAccessCodesFromEnv();\n\n// Set up balance callbacks for DeFi and Event sims\n// Use perps sim as the source of truth for REDACTED balance\nconst getUsdcBalance = () => {\n  return perpsSim.getUsdcBalance();\n};\n\nconst updateUsdcBalance = (delta: number) => {\n  perpsSim.updateUsdcBalance(delta);\n};\n\ndefiSim.setBalanceCallbacks(getUsdcBalance, updateUsdcBalance);\neventSim.setBalanceCallbacks(getUsdcBalance, updateUsdcBalance);\n\n/**\n * Build portfolio snapshot from all sims\n * (Now uses centralized helper)\n */\nfunction buildPortfolioSnapshot(): BlossomPortfolioSnapshot {\n  return getPortfolioSnapshot();\n}\n\n/**\n * Apply action to appropriate sim and return unified ExecutionResult\n */\nasync function applyAction(action: BlossomAction): Promise<ExecutionResult> {\n  const portfolioBefore = buildPortfolioSnapshot();\n  const { v4: uuidv4 } = await import('uuid');\n  const simulatedTxId = `sim_${uuidv4()}`;\n\n  try {\n    if (action.type === 'perp' && action.action === 'open') {\n      const position = await perpsSim.openPerp({\n        market: action.market,\n        side: action.side,\n        riskPct: action.riskPct,\n        entry: action.entry,\n        takeProfit: action.takeProfit,\n        stopLoss: action.stopLoss,\n      });\n\n      const portfolioAfter = buildPortfolioSnapshot();\n      const accountValueDelta = portfolioAfter.accountValueUsd - portfolioBefore.accountValueUsd;\n      const balanceDeltas = portfolioAfter.balances.map(b => {\n        const before = portfolioBefore.balances.find(b2 => b2.symbol === b.symbol);\n        return {\n          symbol: b.symbol,\n          deltaUsd: b.balanceUsd - (before?.balanceUsd || 0),\n        };\n      });\n\n      return {\n        success: true,\n        status: 'success',\n        simulatedTxId,\n        positionDelta: {\n          type: 'perp',\n          positionId: position.id,\n          sizeUsd: position.sizeUsd,\n          entryPrice: position.entryPrice,\n          side: position.side,\n        },\n        portfolioDelta: {\n          accountValueDeltaUsd: accountValueDelta,\n          balanceDeltas,\n          exposureDeltaUsd: portfolioAfter.openPerpExposureUsd - portfolioBefore.openPerpExposureUsd,\n        },\n        portfolio: portfolioAfter,\n      };\n    } else if (action.type === 'defi' && action.action === 'deposit') {\n      const position = defiSim.openDefiPosition(\n        action.protocol as 'Kamino' | 'RootsFi' | 'Jet',\n        action.asset,\n        action.amountUsd\n      );\n\n      const portfolioAfter = buildPortfolioSnapshot();\n      const accountValueDelta = portfolioAfter.accountValueUsd - portfolioBefore.accountValueUsd;\n      const balanceDeltas = portfolioAfter.balances.map(b => {\n        const before = portfolioBefore.balances.find(b2 => b2.symbol === b.symbol);\n        return {\n          symbol: b.symbol,\n          deltaUsd: b.balanceUsd - (before?.balanceUsd || 0),\n        };\n      });\n\n      return {\n        success: true,\n        status: 'success',\n        simulatedTxId,\n        positionDelta: {\n          type: 'defi',\n          positionId: position.id,\n          sizeUsd: position.depositUsd,\n        },\n        portfolioDelta: {\n          accountValueDeltaUsd: accountValueDelta,\n          balanceDeltas,\n        },\n        portfolio: portfolioAfter,\n      };\n    } else if (action.type === 'event' && action.action === 'open') {\n      // Apply 3% risk cap for event positions (unless override is explicitly set)\n      const accountValue = portfolioBefore.accountValueUsd;\n      const maxEventRiskPct = 0.03; // 3% per-strategy cap (same as perps)\n      const maxStakeUsd = Math.round(accountValue * maxEventRiskPct);\n      \n      // Cap stake at 3% of account value (unless overrideRiskCap is true)\n      if (!action.overrideRiskCap) {\n        const cappedStakeUsd = Math.min(action.stakeUsd, maxStakeUsd);\n        \n        // Update action with capped stake if it was reduced\n        if (cappedStakeUsd < action.stakeUsd) {\n          action.stakeUsd = cappedStakeUsd;\n          action.maxLossUsd = cappedStakeUsd;\n          // Recalculate max payout based on capped stake\n          const payoutMultiple = action.maxPayoutUsd / action.stakeUsd;\n          action.maxPayoutUsd = cappedStakeUsd * payoutMultiple;\n        }\n      } else {\n        // Override: only cap at account value (sanity check)\n        const maxAllowedUsd = accountValue;\n        if (action.stakeUsd > maxAllowedUsd) {\n          action.stakeUsd = maxAllowedUsd;\n          action.maxLossUsd = maxAllowedUsd;\n          const payoutMultiple = action.maxPayoutUsd / action.stakeUsd;\n          action.maxPayoutUsd = maxAllowedUsd * payoutMultiple;\n        }\n      }\n      \n      const position = await eventSim.openEventPosition(\n        action.eventKey,\n        action.side,\n        action.stakeUsd,\n        action.label // Pass label for live markets\n      );\n\n      const portfolioAfter = buildPortfolioSnapshot();\n      const accountValueDelta = portfolioAfter.accountValueUsd - portfolioBefore.accountValueUsd;\n      const balanceDeltas = portfolioAfter.balances.map(b => {\n        const before = portfolioBefore.balances.find(b2 => b2.symbol === b.symbol);\n        return {\n          symbol: b.symbol,\n          deltaUsd: b.balanceUsd - (before?.balanceUsd || 0),\n        };\n      });\n\n      return {\n        success: true,\n        status: 'success',\n        simulatedTxId,\n        positionDelta: {\n          type: 'event',\n          positionId: position.id,\n          sizeUsd: position.stakeUsd,\n          side: position.side,\n        },\n        portfolioDelta: {\n          accountValueDeltaUsd: accountValueDelta,\n          balanceDeltas,\n          exposureDeltaUsd: portfolioAfter.eventExposureUsd - portfolioBefore.eventExposureUsd,\n        },\n        portfolio: portfolioAfter,\n      };\n    } else if (action.type === 'event' && action.action === 'update') {\n      // Update event position stake\n      if (!action.positionId) {\n        throw new Error('positionId is required for event update action');\n      }\n      \n      await eventSim.updateEventStake({\n        positionId: action.positionId,\n        newStakeUsd: action.stakeUsd,\n        overrideRiskCap: action.overrideRiskCap || false,\n        requestedStakeUsd: action.requestedStakeUsd,\n      });\n\n      const portfolioAfter = buildPortfolioSnapshot();\n      return {\n        success: true,\n        status: 'success',\n        simulatedTxId,\n        portfolio: portfolioAfter,\n      };\n    }\n\n    // Unknown action type\n    const portfolioAfter = buildPortfolioSnapshot();\n    return {\n      success: false,\n      status: 'failed',\n      error: `Unknown action type: ${action.type}`,\n      portfolio: portfolioAfter,\n    };\n  } catch (error: any) {\n    const portfolioAfter = buildPortfolioSnapshot();\n    return {\n      success: false,\n      status: 'failed',\n      error: error.message || 'Unknown error',\n      portfolio: portfolioAfter,\n    };\n  }\n}\n\n/**\n * Parse LLM JSON response into assistant message and actions\n */\ninterface ModelResponse {\n  assistantMessage: string;\n  actions: BlossomAction[];\n  executionRequest?: BlossomExecutionRequest | null;\n  modelOk?: boolean;\n}\n\nasync function parseModelResponse(\n  rawJson: string, \n  isSwapPrompt: boolean = false, \n  isDefiPrompt: boolean = false, \n  userMessage?: string,\n  isPerpPrompt: boolean = false,\n  isEventPrompt: boolean = false\n): Promise<ModelResponse> {\n  try {\n    const parsed = JSON.parse(rawJson);\n    \n    if (typeof parsed !== 'object' || parsed === null) {\n      throw new Error('Response is not an object');\n    }\n\n    const assistantMessage = typeof parsed.assistantMessage === 'string' \n      ? parsed.assistantMessage \n      : 'I understand your request.';\n\n    const actions = Array.isArray(parsed.actions) \n      ? validateActions(parsed.actions)\n      : [];\n\n    // Parse and validate executionRequest\n    let executionRequest: BlossomExecutionRequest | null = null;\n    let modelOk = true;\n\n    if (parsed.executionRequest) {\n      const { validateExecutionRequest } = await import('../utils/actionParser');\n      executionRequest = validateExecutionRequest(parsed.executionRequest);\n      if (!executionRequest && (isSwapPrompt || isDefiPrompt || isPerpPrompt || isEventPrompt)) {\n        // Invalid executionRequest - try deterministic fallback\n        modelOk = false;\n        console.error('[parseModelResponse] Invalid executionRequest, will try fallback');\n      }\n    } else if (isSwapPrompt || isDefiPrompt || isPerpPrompt || isEventPrompt) {\n      // Missing executionRequest - try deterministic fallback\n      modelOk = false;\n      console.error('[parseModelResponse] Missing executionRequest, will try fallback');\n    }\n\n    // If model failed and we have a prompt, try deterministic fallback\n    if (!modelOk && userMessage && (isSwapPrompt || isDefiPrompt || isPerpPrompt || isEventPrompt)) {\n      const fallback = await applyDeterministicFallback(userMessage, isSwapPrompt, isDefiPrompt, isPerpPrompt, isEventPrompt);\n      if (fallback) {\n        return {\n          assistantMessage: `(Fallback planner) ${fallback.assistantMessage}`,\n          actions: fallback.actions,\n          executionRequest: fallback.executionRequest,\n          modelOk: true,\n        };\n      }\n    }\n\n    return { assistantMessage, actions, executionRequest, modelOk };\n  } catch (error: any) {\n    console.error('Failed to parse model response:', error.message);\n    console.error('Raw JSON:', rawJson);\n    \n    // If parsing failed and we have a prompt, try deterministic fallback\n    if (userMessage && (isSwapPrompt || isDefiPrompt || isPerpPrompt || isEventPrompt)) {\n      const fallback = await applyDeterministicFallback(userMessage, isSwapPrompt, isDefiPrompt, isPerpPrompt, isEventPrompt);\n      if (fallback) {\n        return {\n          assistantMessage: `(Fallback planner) ${fallback.assistantMessage}`,\n          actions: fallback.actions,\n          executionRequest: fallback.executionRequest,\n          modelOk: true,\n        };\n      }\n    }\n    \n    throw error;\n  }\n}\n\n/**\n * Generate helpful fallback response when intent is unclear\n * Instead of saying \"I can't process\", offer helpful options\n */\nfunction generateHelpfulFallback(userMessage: string, portfolio: BlossomPortfolioSnapshot | null): string {\n  const lower = userMessage.toLowerCase();\n\n  // Check for swap/trade intent\n  if (lower.includes('swap') || lower.includes('trade') || lower.includes('exchange') || lower.includes('convert')) {\n    return \"I'd be happy to help with a swap! What token would you like to swap, and how much? For example: 'Swap 10 REDACTED to WETH' or 'Swap 0.01 ETH to REDACTED'.\";\n  }\n\n  // Check for yield/earn intent\n  if (lower.includes('yield') || lower.includes('earn') || lower.includes('apy') || lower.includes('interest') || lower.includes('stake')) {\n    return \"Looking for yield opportunities? I can help deploy your REDACTED into DeFi protocols. How much would you like to deposit? For example: 'Deposit 100 REDACTED into Aave'.\";\n  }\n\n  // Check for prediction/bet intent\n  if (lower.includes('bet') || lower.includes('predict') || lower.includes('market') || lower.includes('event') || lower.includes('kalshi') || lower.includes('polymarket')) {\n    return \"Want to explore prediction markets? I can show you the top markets by volume, or help you place a bet. Try: 'Show me top Polymarket markets' or 'Bet $20 YES on Fed rate cut'.\";\n  }\n\n  // Check for perp/leverage intent\n  if (lower.includes('perp') || lower.includes('leverage') || lower.includes('long') || lower.includes('short') || lower.includes('futures')) {\n    return \"Ready to trade perps? Tell me what you'd like to trade: 'Long BTC with 5x leverage' or 'Short ETH with 2% risk'.\";\n  }\n\n  // Check for money/invest/profit intent (vague)\n  if (lower.includes('money') || lower.includes('invest') || lower.includes('profit') || lower.includes('make') || lower.includes('grow')) {\n    const usdcBalance = portfolio?.balances.find(b => b.symbol === 'REDACTED')?.balanceUsd || 0;\n    if (usdcBalance > 0) {\n      return `I can help you put your $${usdcBalance.toLocaleString()} REDACTED to work! Here are your options:\\n\\n1. **Yield**: Deploy to DeFi protocols for ~4-8% APY\\n2. **Trade Perps**: Open leveraged positions on BTC/ETH/SOL\\n3. **Prediction Markets**: Bet on real-world events\\n4. **Swap**: Exchange for other tokens\\n\\nWhat sounds interesting?`;\n    }\n    return \"I can help you explore opportunities! Here's what I can do:\\n\\n1. **Yield**: Deploy REDACTED to earn APY\\n2. **Trade Perps**: Open leveraged positions\\n3. **Prediction Markets**: Bet on events\\n4. **Swap**: Exchange tokens\\n\\nWhat would you like to explore?\";\n  }\n\n  // Check for help/what can you do intent\n  if (lower.includes('help') || lower.includes('what can') || lower.includes('what do you') || lower.includes('how do')) {\n    return \"I'm Blossom, your AI trading copilot! I can help with:\\n\\n1. **Swaps**: 'Swap 100 REDACTED to WETH'\\n2. **Perps**: 'Long BTC with 5x leverage'\\n3. **DeFi Yield**: 'Deposit 500 REDACTED into Aave'\\n4. **Prediction Markets**: 'Show me top Kalshi markets'\\n\\nWhat would you like to do?\";\n  }\n\n  // Generic fallback - offer options\n  return \"I can help with swaps, perps trading, DeFi yield, and prediction markets. What would you like to explore? Try:\\n\\n- 'Swap 10 REDACTED to WETH'\\n- 'Long BTC with 3x leverage'\\n- 'Show me top prediction markets'\\n- 'Deposit 100 REDACTED for yield'\";\n}\n\n/**\n * Normalize user input to handle edge cases like \"5weth\" \u2192 \"5 weth\"\n */\nfunction normalizeUserInput(userMessage: string | undefined): string {\n  if (!userMessage) {\n    return '';\n  }\n  // Token patterns: eth, weth, usdc, usdt, dai, btc, sol\n  const tokenPattern = /\\b(\\d+\\.?\\d*)(eth|weth|usdc|usdt|dai|btc|sol)\\b/gi;\n  let normalized = userMessage;\n  \n  // Replace \"5weth\" \u2192 \"5 weth\", \"0.3eth\" \u2192 \"0.3 eth\", etc.\n  normalized = normalized.replace(tokenPattern, (match, amount, token) => {\n    return `${amount} ${token}`;\n  });\n  \n  // Handle arrow operators: \"5weth->usdc\" \u2192 \"5 weth to usdc\"\n  normalized = normalized.replace(/(\\d+\\.?\\d*\\s*\\w+)\\s*[-=]>\\s*(\\w+)/gi, '$1 to $2');\n  \n  // Handle commas: \"5weth, to usdc\" \u2192 \"5 weth to usdc\"\n  normalized = normalized.replace(/,\\s*to\\s+/gi, ' to ');\n  \n  return normalized;\n}\n\n/**\n * Deterministic fallback for when LLM fails\n */\nasync function applyDeterministicFallback(\n  userMessage: string,\n  isSwapPrompt: boolean,\n  isDefiPrompt: boolean,\n  isPerpPrompt: boolean = false,\n  isEventPrompt: boolean = false\n): Promise<{ assistantMessage: string; actions: BlossomAction[]; executionRequest: BlossomExecutionRequest | null } | null> {\n  // Normalize input before parsing\n  const normalizedMessage = normalizeUserInput(userMessage);\n  const lowerMessage = normalizedMessage.toLowerCase();\n  \n  if (isEventPrompt) {\n    // Extract event details\n    const stakeMatch = userMessage.match(/\\$(\\d+)/) || userMessage.match(/(\\d+)\\s*(usd|dollar)/i);\n    const stakeUsd = stakeMatch ? parseFloat(stakeMatch[1]) : 5;\n    const outcome = lowerMessage.includes('yes') ? 'YES' : 'NO';\n    \n    // Find matching market\n    const { findEventMarketByKeyword } = await import('../quotes/eventMarkets');\n    const keyword = lowerMessage.includes('fed') ? 'fed' : lowerMessage.includes('rate cut') ? 'rate cut' : 'fed';\n    const market = await findEventMarketByKeyword(keyword);\n    \n    return {\n      assistantMessage: `I'll bet ${outcome} on \"${market?.title || 'Fed Rate Cut'}\" with $${stakeUsd}.`,\n      actions: [],\n      executionRequest: {\n        kind: 'event',\n        chain: 'sepolia',\n        marketId: market?.id || 'FED_CUTS_MAR_2025',\n        outcome: outcome as 'YES' | 'NO',\n        stakeUsd,\n        price: outcome === 'YES' ? market?.yesPrice : market?.noPrice,\n      },\n    };\n  }\n  \n  if (isPerpPrompt) {\n    // Extract perp details\n    const assetMatch = lowerMessage.match(/(btc|eth|sol)/);\n    // Support decimal leverage like \"5.5x\" or \"2.5x\"\n    const leverageMatch = userMessage.match(/(\\d+(?:\\.\\d+)?)x/i);\n    const riskMatch = userMessage.match(/(\\d+)%\\s*risk/i) || userMessage.match(/risk.*?(\\d+)%/i);\n    const sideMatch = lowerMessage.match(/(long|short)/);\n\n    const asset = assetMatch ? assetMatch[1].toUpperCase() : 'ETH';\n    const leverage = leverageMatch ? parseFloat(leverageMatch[1]) : 2;\n    const riskPct = riskMatch ? parseFloat(riskMatch[1]) : 2;\n    const side = sideMatch ? sideMatch[1] : 'long';\n    \n    return {\n      assistantMessage: `I'll open a ${side} ${asset} perp position with ${leverage}x leverage and ${riskPct}% risk.`,\n      actions: [],\n      executionRequest: {\n        kind: 'perp',\n        chain: 'sepolia',\n        market: `${asset}-USD`,\n        side: side as 'long' | 'short',\n        leverage,\n        riskPct,\n        marginUsd: 100,\n      },\n    };\n  }\n  \n  if (isSwapPrompt) {\n    // Extract amount and tokens\n    const amountMatch = userMessage.match(/(\\d+\\.?\\d*)\\s*(usdc|weth|eth)/i);\n    const tokenInMatch = lowerMessage.match(/(usdc|weth|eth)/);\n    const tokenOutMatch = lowerMessage.match(/to\\s+(usdc|weth|eth)/);\n    \n    if (amountMatch && tokenInMatch) {\n      const amount = amountMatch[1];\n      const tokenIn = tokenInMatch[1].toUpperCase() === 'ETH' ? 'ETH' : tokenInMatch[1].toUpperCase();\n      const tokenOut = tokenOutMatch ? (tokenOutMatch[1].toUpperCase() === 'ETH' ? 'WETH' : tokenOutMatch[1].toUpperCase()) : \n                       (tokenIn === 'REDACTED' ? 'WETH' : 'REDACTED');\n      \n      return {\n        assistantMessage: `I'll swap ${amount} ${tokenIn} to ${tokenOut} on Sepolia.`,\n        actions: [],\n        executionRequest: {\n          kind: 'swap',\n          chain: 'sepolia',\n          tokenIn: tokenIn as 'ETH' | 'WETH' | 'REDACTED',\n          tokenOut: tokenOut as 'WETH' | 'REDACTED',\n          amountIn: amount,\n          slippageBps: 50,\n          fundingPolicy: tokenIn === 'ETH' ? 'auto' : 'require_tokenIn',\n        },\n      };\n    }\n  }\n  \n  if (isDefiPrompt) {\n    // NEW: Check for structured allocation format first (from quick action buttons)\n    const structuredAllocMatch = userMessage.match(/allocate\\s+amount(Usd|Pct):\"?(\\d+\\.?\\d*)\"?\\s+to\\s+protocol:\"?([^\"]+?)\"?(?:\\s+REDACTED|\\s+yield|$)/i);\n\n    let amount: string;\n    let vaultName: string | undefined;\n\n    if (structuredAllocMatch) {\n      // Structured format: \"Allocate amountUsd:\"500\" to protocol:\"Aave V3\" REDACTED yield\"\n      const [_, amountType, amountValue, protocolName] = structuredAllocMatch;\n\n      if (amountType.toLowerCase() === 'pct') {\n        // Percentage allocation: calculate from account value\n        const accountValue = portfolio?.accountValueUsd || 10000;\n        const percentage = parseFloat(amountValue);\n        amount = ((accountValue * percentage) / 100).toFixed(0);\n      } else {\n        // USD allocation\n        amount = amountValue;\n      }\n\n      vaultName = protocolName.trim();\n      console.log('[deterministic fallback] Parsed structured allocation:', { amount, vaultName, format: 'structured' });\n    } else {\n      // FALLBACK: Natural language format: \"deposit 500 REDACTED\" or \"park 10 usdc into yield\"\n      const amountMatch = userMessage.match(/(\\d+\\.?\\d*)\\s*(?:usdc|dollar|into|in|to|for)?.*?(?:yield|vault|defi|aave|compound)/i) ||\n                          userMessage.match(/(?:park|deposit|lend|supply)\\s+(\\d+\\.?\\d*)/i);\n      amount = amountMatch ? amountMatch[1] : '10';\n\n      // Get vault recommendation from DefiLlama\n      const { getVaultRecommendation } = await import('../quotes/defiLlamaQuote');\n      const vault = await getVaultRecommendation(parseFloat(amount));\n      vaultName = vault?.name;\n      console.log('[deterministic fallback] Parsed natural language allocation:', { amount, vaultName, format: 'natural' });\n    }\n\n    return {\n      assistantMessage: `I'll allocate $${amount} to ${vaultName || 'yield vault'}. ${vaultName ? `Earning ~5-7% APY.` : 'Recommended: Aave REDACTED at 5.00% APY.'}`,\n      actions: [],\n      executionRequest: {\n        kind: 'lend_supply',\n        chain: 'sepolia',\n        asset: 'REDACTED',\n        amount,\n        protocol: 'demo',\n        vault: vaultName || 'Aave REDACTED',\n      },\n    };\n  }\n  \n  return null;\n}\n\ninterface ChatRequest {\n  userMessage: string;\n  venue: 'hyperliquid' | 'event_demo';\n  clientPortfolio?: Partial<BlossomPortfolioSnapshot>;\n}\n\n/**\n * Task 0: Sim Blueprint Contract (Source of Truth)\n * \n * For ConfirmTradeCard to render, the UI requires:\n * 1. Message object with:\n *    - msg.type === 'trade_confirm'\n *    - msg.draftId (string ID)\n * 2. Draft strategy in strategies array (found by strategies.find(s => s.id === draftId)):\n *    - id: string (stable, matches draftId)\n *    - status: 'draft'\n *    - side: 'Long' | 'Short'\n *    - market: string\n *    - riskPercent: number\n *    - marginUsd: number (required for ConfirmTradeCard)\n *    - leverage: number (required for ConfirmTradeCard)\n *    - notionalUsd: number (required for ConfirmTradeCard, or calculated as marginUsd * leverage)\n *    - entry: number\n *    - takeProfit: number (optional)\n *    - stopLoss: number (optional)\n *    - instrumentType: 'perp' | 'event'\n *    - sourceText: string\n * \n * Backend must create draft strategy server-side and return:\n * - draftId in ChatResponse (for UI to set msg.type + msg.draftId)\n * - draft strategy in portfolio.strategies with status: 'draft'\n */\ninterface ChatResponse {\n  assistantMessage: string;\n  actions: BlossomAction[];\n  executionRequest?: BlossomExecutionRequest | null;\n  modelOk?: boolean; // true if model successfully parsed, false on refusal/invalid\n  portfolio: BlossomPortfolioSnapshot;\n  executionResults?: ExecutionResult[]; // Unified execution results\n  errorCode?: 'INSUFFICIENT_BALANCE' | 'SESSION_EXPIRED' | 'RELAYER_FAILED' | 'SLIPPAGE_FAILURE' | 'LLM_REFUSAL' | 'UNKNOWN_ERROR';\n  draftId?: string; // Task A: Server-created draft strategy ID (for UI to set msg.type + msg.draftId)\n}\n\n/**\n * POST /api/chat\n */\napp.post('/api/chat', maybeCheckAccess, async (req, res) => {\n  const chatStartTime = Date.now();\n  try {\n    const { userMessage, venue, clientPortfolio }: ChatRequest = req.body;\n\n    // Telemetry: log chat request\n    logEvent('chat_request', {\n      venue,\n      notes: [userMessage ? (userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : '')) : 'undefined'],\n    });\n\n    if (!userMessage) {\n      return res.status(400).json({ error: 'userMessage is required' });\n    }\n\n    // Log incoming request for debugging\n    console.log('[api/chat] Received request:', { \n      userMessage: userMessage ? userMessage.substring(0, 100) : 'undefined', \n      venue,\n      messageLength: userMessage ? userMessage.length : 0\n    });\n\n    // Get current portfolio snapshot before applying new actions\n    const portfolioBefore = buildPortfolioSnapshot();\n    const portfolioForPrompt = clientPortfolio ? { ...portfolioBefore, ...clientPortfolio } : portfolioBefore;\n\n    // Normalize user input first (handle edge cases like \"5weth\" \u2192 \"5 weth\")\n    const normalizedUserMessage = normalizeUserInput(userMessage);\n\n    // CRITICAL: Detect DeFi TVL query FIRST (before LLM call)\n    // Matches: \"show me top 5 defi protocols by TVL\", \"list top defi protocols\", etc.\n    const LIST_DEFI_PROTOCOLS_RE = /\\b(show\\s+me\\s+)?(top\\s+(\\d+)\\s+)?(defi\\s+)?protocols?\\s+(by\\s+)?(tvl|total\\s+value\\s+locked)\\b/i;\n    const hasListDefiProtocolsIntent = LIST_DEFI_PROTOCOLS_RE.test(normalizedUserMessage) ||\n      /\\b(list|show|display|fetch|get|explore)\\s+(top|best|highest)\\s+(\\d+)?\\s*(defi\\s+)?protocols?\\b/i.test(normalizedUserMessage) ||\n      /\\b(best\\s+defi|top\\s+defi|explore\\s+top\\s+protocols)\\b/i.test(normalizedUserMessage) ||\n      /\\b(top\\s+5\\s+defi|top\\s+defi\\s+protocols|defi\\s+protocols\\s+by\\s+tvl)\\b/i.test(normalizedUserMessage);\n\n    if (hasListDefiProtocolsIntent) {\n      console.log('[api/chat] DeFi TVL query detected - fetching top protocols');\n\n      // Extract requested count (default: 5)\n      let requestedCount = 5;\n      const numericMatch = normalizedUserMessage.match(/\\btop\\s+(\\d+)\\s+(defi\\s+)?protocols?\\b/i);\n      if (numericMatch && numericMatch[1]) {\n        requestedCount = parseInt(numericMatch[1], 10);\n      }\n\n      try {\n        const { getTopProtocolsByTVL } = await import('../quotes/defiLlamaQuote');\n        const protocols = await getTopProtocolsByTVL(requestedCount);\n\n        // Return response with protocol list (frontend will render with quick action buttons)\n        const portfolioAfter = buildPortfolioSnapshot();\n        return res.json({\n          ok: true,\n          assistantMessage: `Here are the top ${protocols.length} DeFi protocol${protocols.length !== 1 ? 's' : ''} by TVL right now:`,\n          actions: [],\n          executionRequest: null,\n          modelOk: true,\n          portfolio: portfolioAfter,\n          executionResults: [],\n          defiProtocolsList: protocols, // Special field for protocol list\n        });\n      } catch (error: any) {\n        console.error('[api/chat] Failed to fetch DeFi protocols:', error.message);\n        // Return error response\n        const portfolioAfter = buildPortfolioSnapshot();\n        return res.json({\n          ok: false,\n          assistantMessage: \"I couldn't fetch the DeFi protocols right now. Please try again later.\",\n          actions: [],\n          executionRequest: null,\n          modelOk: false,\n          portfolio: portfolioAfter,\n          executionResults: [],\n        });\n      }\n    }\n\n    // CRITICAL: Detect Event Markets list query FIRST (before LLM call)\n    // Matches: \"show me top 5 prediction markets by volume\", \"top event markets\", etc.\n    const LIST_EVENT_MARKETS_RE = /\\b(show\\s+me\\s+)?(top\\s+(\\d+)\\s+)?(prediction|event)\\s+markets?\\s*(by\\s+)?(volume|tvl)?\\b/i;\n    const hasListEventMarketsIntent = LIST_EVENT_MARKETS_RE.test(normalizedUserMessage) ||\n      /\\b(list|show|display|fetch|get|explore)\\s+(top|best|highest)\\s+(\\d+)?\\s*(prediction|event)\\s+markets?\\b/i.test(normalizedUserMessage) ||\n      /\\b(best\\s+prediction|top\\s+prediction|top\\s+event|explore\\s+top\\s+markets)\\b/i.test(normalizedUserMessage) ||\n      /\\b(top\\s+5\\s+prediction|top\\s+prediction\\s+markets|prediction\\s+markets\\s+by\\s+volume)\\b/i.test(normalizedUserMessage) ||\n      /\\b(show\\s+me\\s+top\\s+prediction\\s+markets?)\\b/i.test(normalizedUserMessage);\n\n    if (hasListEventMarketsIntent) {\n      console.log('[api/chat] Event Markets list query detected - fetching top markets');\n\n      // Extract requested count (default: 5)\n      let requestedCount = 5;\n      const numericMatch = normalizedUserMessage.match(/\\btop\\s+(\\d+)\\s+(prediction|event)\\s+markets?\\b/i);\n      if (numericMatch && numericMatch[1]) {\n        requestedCount = parseInt(numericMatch[1], 10);\n      }\n\n      try {\n        const { getEventMarketsWithRouting } = await import('../quotes/eventMarkets');\n        const result = await getEventMarketsWithRouting(requestedCount);\n\n        // Return response with event market list (frontend will render with quick action buttons)\n        const portfolioAfter = buildPortfolioSnapshot();\n        return res.json({\n          ok: true,\n          assistantMessage: `Here are the top ${result.markets.length} prediction market${result.markets.length !== 1 ? 's' : ''} by volume right now:`,\n          actions: [],\n          executionRequest: null,\n          modelOk: true,\n          portfolio: portfolioAfter,\n          executionResults: [],\n          eventMarketsList: result.markets, // Special field for event market list\n          routing: result.routing, // Sprint 3: Truthful routing metadata\n        });\n      } catch (error: any) {\n        console.error('[api/chat] Failed to fetch event markets:', error.message, error.stack);\n        // Return error response with fallback routing metadata\n        const portfolioAfter = buildPortfolioSnapshot();\n        const correlationId = req.correlationId || makeCorrelationId('error');\n        return res.json({\n          ok: false,\n          assistantMessage: \"I couldn't fetch the prediction markets right now. Please try again later.\",\n          actions: [],\n          executionRequest: null,\n          modelOk: false,\n          portfolio: portfolioAfter,\n          executionResults: [],\n          routing: {\n            source: 'fallback',\n            kind: 'event_markets',\n            ok: false,\n            reason: `Error: ${error.message || 'Unknown error'}`,\n            latencyMs: 0,\n            mode: process.env.ROUTING_MODE || 'hybrid',\n            correlationId,\n          },\n        });\n      }\n    }\n\n    // Detect event market quick action format\n    // Format 1 (structured): \"Bet YES on market:\"Fed cuts rates\" stakeUsd:\"50\"\"\n    // Format 2 (natural): \"Bet YES on \"Trump wins\" with 2% risk\"\n    const hasEventQuickActionStructured = /bet\\s+(YES|NO)\\s+on\\s+market:\"?([^\"]+?)\"?(?:\\s+stake(Usd|Pct):\"?(\\d+\\.?\\d*)\"?)?/i.test(normalizedUserMessage);\n    const hasEventQuickActionNatural = /bet\\s+(YES|NO)\\s+on\\s+\"([^\"]+)\"\\s+with\\s+(\\d+\\.?\\d*)%\\s+risk/i.test(normalizedUserMessage);\n\n    if (hasEventQuickActionStructured || hasEventQuickActionNatural) {\n      let eventMatch;\n      let isNaturalFormat = false;\n\n      if (hasEventQuickActionNatural) {\n        eventMatch = normalizedUserMessage.match(/bet\\s+(YES|NO)\\s+on\\s+\"([^\"]+)\"\\s+with\\s+(\\d+\\.?\\d*)%\\s+risk/i);\n        isNaturalFormat = true;\n      } else {\n        eventMatch = normalizedUserMessage.match(/bet\\s+(YES|NO)\\s+on\\s+market:\"?([^\"]+?)\"?(?:\\s+stake(Usd|Pct):\"?(\\d+\\.?\\d*)\"?)?/i);\n      }\n\n      if (eventMatch) {\n        let outcome: string;\n        let marketTitle: string;\n        let stakeUsd: number;\n\n        if (isNaturalFormat) {\n          // Natural format: \"Bet YES on \"Trump wins\" with 2% risk\"\n          const [fullMatch, outcomeRaw, marketTitleRaw, riskPct] = eventMatch;\n          outcome = outcomeRaw;\n          marketTitle = marketTitleRaw;\n          const accountValue = portfolioBefore?.accountValueUsd || 10000;\n          stakeUsd = (accountValue * parseFloat(riskPct)) / 100;\n          console.log('[event quick action] Natural format detected:', { outcome, marketTitle, riskPct, accountValue, stakeUsd });\n        } else {\n          // Structured format: \"Bet YES on market:\"Fed cuts\" stakeUsd:\"50\"\"\n          const [_, outcomeRaw, marketTitleRaw, stakeType, stakeValue] = eventMatch;\n          outcome = outcomeRaw;\n          marketTitle = marketTitleRaw;\n\n          if (stakeType?.toLowerCase() === 'pct') {\n            const accountValue = portfolioBefore?.accountValueUsd || 10000;\n            stakeUsd = (accountValue * parseFloat(stakeValue || '2')) / 100;\n          } else {\n            stakeUsd = parseFloat(stakeValue || '50');\n          }\n          console.log('[event quick action] Structured format detected:', { outcome, marketTitle, stakeType, stakeUsd });\n        }\n\n        // Find matching market from event markets ticker\n        try {\n          const { getEventMarketsWithRouting } = await import('../quotes/eventMarkets');\n          const result = await getEventMarketsWithRouting(10);\n          const markets = result.markets;\n          const matchedMarket = markets.find(m =>\n            m.title.toLowerCase().includes(marketTitle.toLowerCase()) ||\n            marketTitle.toLowerCase().includes(m.title.toLowerCase())\n          );\n\n          if (matchedMarket) {\n            const price = outcome === 'YES' ? matchedMarket.yesPrice : matchedMarket.noPrice;\n            const maxPayout = stakeUsd / price;\n\n            const portfolioAfter = buildPortfolioSnapshot();\n            return res.json({\n              ok: true,\n              assistantMessage: `I'll place a ${outcome} bet on \"${matchedMarket.title}\" with $${stakeUsd.toFixed(0)} stake. At ${(price * 100).toFixed(1)}\u00A2 odds, your max payout is $${maxPayout.toFixed(0)}. Confirm to execute?`,\n              actions: [],\n              executionRequest: {\n                kind: 'event',\n                chain: 'sepolia',\n                marketId: matchedMarket.id,\n                outcome,\n                stakeUsd,\n                price,\n              },\n              modelOk: true,\n              portfolio: portfolioAfter,\n              executionResults: [],\n            });\n          } else {\n            console.warn('[deterministic fallback] No matching event market found for:', marketTitle);\n            // Fall through to LLM if no match found\n          }\n        } catch (error: any) {\n          console.error('[deterministic fallback] Failed to fetch event markets:', error.message);\n          // Fall through to LLM on error\n        }\n      }\n    }\n\n    // Build prompts for LLM (now async to fetch live market data)\n    // Use normalized message for prompt building\n    const { systemPrompt, userPrompt, isPredictionMarketQuery } = await buildBlossomPrompts({\n      userMessage: normalizedUserMessage,\n      portfolio: portfolioForPrompt,\n      venue: venue || 'hyperliquid',\n    });\n\n    let assistantMessage = '';\n    let actions: BlossomAction[] = [];\n    let modelResponse: ModelResponse | null = null;\n\n    // Detect if this is a swap prompt (use normalized message)\n    const isSwapPrompt = /swap|exchange|convert/i.test(normalizedUserMessage) && \n      (normalizedUserMessage.toLowerCase().includes('usdc') || \n       normalizedUserMessage.toLowerCase().includes('weth') || \n       normalizedUserMessage.toLowerCase().includes('eth'));\n    \n    // Detect if this is a DeFi/yield prompt\n    const isDefiPrompt = /park|deposit|earn yield|lend|supply|allocate/i.test(normalizedUserMessage) &&\n      (normalizedUserMessage.toLowerCase().includes('usdc') ||\n       normalizedUserMessage.toLowerCase().includes('yield') ||\n       normalizedUserMessage.toLowerCase().includes('stablecoin') ||\n       normalizedUserMessage.toLowerCase().includes('protocol'));\n    \n    // Detect if this is a perp prompt\n    const isPerpPrompt = /open|long|short|perp/i.test(normalizedUserMessage) && \n      (normalizedUserMessage.toLowerCase().includes('btc') || \n       normalizedUserMessage.toLowerCase().includes('eth') || \n       normalizedUserMessage.toLowerCase().includes('sol') ||\n       normalizedUserMessage.toLowerCase().includes('2x') ||\n       normalizedUserMessage.toLowerCase().includes('3x') ||\n       normalizedUserMessage.toLowerCase().includes('leverage'));\n    \n    // Detect if this is an event prompt\n    const isEventPrompt = /bet|wager|risk.*on|event/i.test(normalizedUserMessage) && \n      (normalizedUserMessage.toLowerCase().includes('yes') || \n       normalizedUserMessage.toLowerCase().includes('no') || \n       normalizedUserMessage.toLowerCase().includes('fed') ||\n       normalizedUserMessage.toLowerCase().includes('rate cut'));\n\n    // Check if we're in stub mode and this is a prediction market query\n    const hasOpenAIKey = !!process.env.BLOSSOM_OPENAI_API_KEY;\n    const hasAnthropicKey = !!process.env.BLOSSOM_ANTHROPIC_API_KEY;\n    const provider = process.env.BLOSSOM_MODEL_PROVIDER || 'stub';\n    const isStubMode = provider === 'stub' || (!hasOpenAIKey && !hasAnthropicKey);\n\n    // Log stub mode detection for debugging\n    console.log('[api/chat] Stub mode check:', {\n      provider,\n      hasOpenAIKey,\n      hasAnthropicKey,\n      isStubMode,\n      isPredictionMarketQuery,\n      isSwapPrompt,\n      userMessage: userMessage.substring(0, 100)\n    });\n\n    if (isStubMode && isPredictionMarketQuery) {\n      // Short-circuit: build deterministic response for prediction markets in stub mode\n      console.log('[api/chat] \u2705 STUB SHORT-CIRCUIT: Building deterministic prediction market response');\n      \n      try {\n        const { buildPredictionMarketResponse } = await import('../utils/actionParser');\n        const accountValue = portfolioForPrompt?.accountValueUsd || 10000;\n        const stubResponse = await buildPredictionMarketResponse(\n          userMessage, \n          venue || 'hyperliquid',\n          accountValue\n        );\n        assistantMessage = stubResponse.assistantMessage;\n        actions = stubResponse.actions;\n        modelResponse = {\n          assistantMessage,\n          actions,\n          executionRequest: null,\n          modelOk: true,\n        };\n        console.log('[api/chat] \u2705 Stub response built:', { \n          messageLength: assistantMessage?.length || 0, \n          actionCount: actions.length,\n          preview: assistantMessage ? assistantMessage.substring(0, 150) : 'N/A'\n        });\n      } catch (error: any) {\n        console.error('[api/chat] \u274C Failed to build stub prediction market response:', error.message);\n        // Fall through to normal stub LLM call\n        const llmOutput = await callLlm({ systemPrompt, userPrompt });\n        modelResponse = await parseModelResponse(llmOutput.rawJson, isSwapPrompt);\n        assistantMessage = modelResponse.assistantMessage;\n        actions = modelResponse.actions;\n      }\n    } else {\n      // Normal flow: call LLM (stub or real)\n      console.log('[api/chat] \u2192 Normal LLM flow (stub or real)');\n      \n      // Normalize user input before processing\n      const normalizedUserMessage = normalizeUserInput(userMessage);\n      const normalizedUserPrompt = userPrompt.replace(userMessage, normalizedUserMessage);\n      \n      // Detect prompts on normalized message\n      const normalizedIsSwapPrompt = /swap|exchange|convert/i.test(normalizedUserMessage) && \n        (normalizedUserMessage.toLowerCase().includes('usdc') || \n         normalizedUserMessage.toLowerCase().includes('weth') || \n         normalizedUserMessage.toLowerCase().includes('eth'));\n      const normalizedIsDefiPrompt = /park|deposit|earn yield|lend|supply|allocate/i.test(normalizedUserMessage) &&\n        (normalizedUserMessage.toLowerCase().includes('usdc') ||\n         normalizedUserMessage.toLowerCase().includes('yield') ||\n         normalizedUserMessage.toLowerCase().includes('stablecoin') ||\n         normalizedUserMessage.toLowerCase().includes('protocol'));\n      const normalizedIsPerpPrompt = /open|long|short|perp/i.test(normalizedUserMessage) && \n        (normalizedUserMessage.toLowerCase().includes('btc') || \n         normalizedUserMessage.toLowerCase().includes('eth') || \n         normalizedUserMessage.toLowerCase().includes('sol') ||\n         normalizedUserMessage.toLowerCase().includes('2x') ||\n         normalizedUserMessage.toLowerCase().includes('3x') ||\n         normalizedUserMessage.toLowerCase().includes('leverage'));\n      const normalizedIsEventPrompt = /bet|wager|risk.*on|event/i.test(normalizedUserMessage) && \n        (normalizedUserMessage.toLowerCase().includes('yes') || \n         normalizedUserMessage.toLowerCase().includes('no') || \n         normalizedUserMessage.toLowerCase().includes('fed') ||\n         normalizedUserMessage.toLowerCase().includes('rate cut'));\n      \n      try {\n        // Call LLM with normalized prompt\n        const llmOutput = await callLlm({ systemPrompt, userPrompt: normalizedUserPrompt });\n\n        // Parse JSON response with normalized message for fallback\n        modelResponse = await parseModelResponse(llmOutput.rawJson, normalizedIsSwapPrompt, normalizedIsDefiPrompt, normalizedUserMessage, normalizedIsPerpPrompt, normalizedIsEventPrompt);\n        assistantMessage = modelResponse.assistantMessage;\n        actions = modelResponse.actions;\n        \n        // If model failed OR succeeded but missing executionRequest for execution intents, try deterministic fallback\n        const needsFallback = !modelResponse.modelOk ||\n                              (!modelResponse.executionRequest && (normalizedIsSwapPrompt || normalizedIsDefiPrompt || normalizedIsPerpPrompt || normalizedIsEventPrompt));\n\n        if (needsFallback && (normalizedIsSwapPrompt || normalizedIsDefiPrompt || normalizedIsPerpPrompt || normalizedIsEventPrompt)) {\n          console.log('[api/chat] Triggering deterministic fallback for execution intent');\n          const fallback = await applyDeterministicFallback(normalizedUserMessage, normalizedIsSwapPrompt, normalizedIsDefiPrompt, normalizedIsPerpPrompt, normalizedIsEventPrompt);\n          if (fallback) {\n            modelResponse = {\n              assistantMessage: fallback.assistantMessage,\n              actions: fallback.actions,\n              executionRequest: fallback.executionRequest,\n              modelOk: true,\n            };\n            assistantMessage = fallback.assistantMessage;\n            actions = fallback.actions;\n          }\n        }\n      } catch (error: any) {\n        console.error('LLM call or parsing error:', error.message);\n        // Try deterministic fallback before giving up\n        if (normalizedIsSwapPrompt || normalizedIsDefiPrompt || normalizedIsPerpPrompt || normalizedIsEventPrompt) {\n          const fallback = await applyDeterministicFallback(normalizedUserMessage, normalizedIsSwapPrompt, normalizedIsDefiPrompt, normalizedIsPerpPrompt, normalizedIsEventPrompt);\n          if (fallback) {\n            modelResponse = {\n              assistantMessage: fallback.assistantMessage,\n              actions: fallback.actions,\n              executionRequest: fallback.executionRequest,\n              modelOk: true,\n            };\n            assistantMessage = fallback.assistantMessage;\n            actions = fallback.actions;\n          } else {\n            // Last resort: use helpful fallback instead of generic error\n            assistantMessage = generateHelpfulFallback(normalizedUserMessage, portfolioForPrompt);\n            actions = [];\n            modelResponse = {\n              assistantMessage,\n              actions: [],\n              executionRequest: null,\n              modelOk: true, // Mark as OK since we're providing helpful guidance\n            };\n          }\n        } else {\n          // No specific intent detected - use helpful fallback to guide user\n          assistantMessage = generateHelpfulFallback(normalizedUserMessage, portfolioForPrompt);\n          actions = [];\n          modelResponse = {\n            assistantMessage,\n            actions: [],\n            executionRequest: null,\n            modelOk: true, // Mark as OK since we're providing helpful guidance\n          };\n        }\n      }\n    }\n\n    // Apply validated actions to sims and collect execution results\n    const executionResults: ExecutionResult[] = [];\n    for (const action of actions) {\n      try {\n        const result = await applyAction(action);\n        executionResults.push(result);\n        // If execution failed, remove action from array\n        if (!result.success) {\n          const index = actions.indexOf(action);\n          if (index > -1) {\n            actions.splice(index, 1);\n          }\n        }\n      } catch (error: any) {\n        console.error(`Error applying action:`, error.message);\n        // Remove failed action from array\n        const index = actions.indexOf(action);\n        if (index > -1) {\n          actions.splice(index, 1);\n        }\n        // Add failed result\n        const portfolioAfter = buildPortfolioSnapshot();\n        executionResults.push({\n          success: false,\n          status: 'failed',\n          error: error.message || 'Unknown error',\n          portfolio: portfolioAfter,\n        });\n      }\n    }\n\n    // Build updated portfolio snapshot after applying actions\n    const portfolioAfter = buildPortfolioSnapshot();\n\n    // Get executionRequest from modelResponse if available\n    const executionRequest = modelResponse?.executionRequest ?? null;\n    const modelOk = modelResponse?.modelOk !== false;\n\n    // Task 3: Enforce backend invariants for actionable intents\n    // Perp/event/defi intents MUST have executionRequest (swaps may execute immediately)\n    const hasActionableIntent = actions.length > 0 && actions.some(a => \n      a.type === 'perp' || a.type === 'event' || a.type === 'defi'\n    );\n    \n    if (hasActionableIntent && !executionRequest) {\n      // Actionable intent detected but executionRequest missing - return structured error\n      if (process.env.DEBUG_RESPONSE === 'true') {\n        console.error('[api/chat] MISSING_EXECUTION_REQUEST for actionable intent:', {\n          actions: actions.map(a => ({ type: a.type })),\n          modelOk,\n          debugHints: {\n            modelResponse: modelResponse ? 'present' : 'missing',\n            fallbackApplied: modelResponse?.modelOk === false,\n          },\n        });\n      }\n      \n      return res.status(200).json({\n        ok: false,\n        assistantMessage: \"I couldn't generate a valid execution plan. Please try rephrasing your request.\",\n        actions: [],\n        executionRequest: null,\n        modelOk: false,\n        portfolio: portfolioAfter,\n        executionResults: [],\n        errorCode: 'MISSING_EXECUTION_REQUEST' as const,\n      });\n    }\n\n    // Task A: Create draft strategy server-side for actionable intents (deterministic)\n    let serverDraftId: string | undefined = undefined;\n    if (executionRequest) {\n      const { v4: uuidv4 } = await import('uuid');\n      const accountValue = portfolioAfter.accountValueUsd || 10000; // Fallback for demo\n      \n      if (executionRequest.kind === 'perp') {\n        const perpReq = executionRequest as { kind: 'perp'; chain: string; market: string; side: 'long' | 'short'; leverage: number; riskPct?: number; marginUsd?: number };\n        const marginUsd = perpReq.marginUsd || (accountValue * (perpReq.riskPct || 2) / 100);\n        const leverage = perpReq.leverage || 2;\n\n        // Warn if user mentioned leverage but LLM didn't extract it\n        if (!perpReq.leverage && userMessage.match(/\\d+(\\.\\d+)?x/i)) {\n          const mentionedLeverage = userMessage.match(/(\\d+(?:\\.\\d+)?)x/i);\n          console.warn(\n            `[api/chat] User mentioned ${mentionedLeverage?.[0]} leverage but LLM didn't extract it. ` +\n            `Using default ${leverage}x. This is a parsing failure.`\n          );\n        }\n\n        const notionalUsd = marginUsd * leverage;\n        \n        serverDraftId = `draft-${uuidv4()}`;\n        const draftStrategy = {\n          id: serverDraftId,\n          type: 'perp' as const,\n          status: 'draft' as const,\n          side: perpReq.side,\n          market: perpReq.market || 'BTC-USD',\n          riskPct: perpReq.riskPct || 2,\n          entry: 0, // Will be set on execution\n          takeProfit: 0,\n          stopLoss: 0,\n          sourceText: userMessage.substring(0, 200), // Truncate for storage\n          marginUsd,\n          leverage,\n          notionalUsd,\n          sizeUsd: notionalUsd, // For portfolio mapping\n          isClosed: false,\n          createdAt: new Date().toISOString(),\n          // Task B: Add routing fields for rich card UI\n          routingVenue: 'Sepolia Testnet', // Will be updated from executionRequest if available\n          routingChain: 'Sepolia',\n          routingSlippage: perpReq.slippageBps ? `${(perpReq.slippageBps / 100).toFixed(2)}%` : '0.5%',\n        };\n        \n        // Add draft to portfolio.strategies\n        portfolioAfter.strategies.push(draftStrategy);\n        \n        if (process.env.DEBUG_CARD_CONTRACT === 'true') {\n          console.log('[api/chat] Created perp draft server-side:', {\n            draftId: serverDraftId,\n            market: draftStrategy.market,\n            side: draftStrategy.side,\n            marginUsd,\n            leverage,\n            notionalUsd,\n          });\n        }\n      } else if (executionRequest.kind === 'event') {\n        const eventReq = executionRequest as { kind: 'event'; chain: string; marketId: string; outcome: 'YES' | 'NO'; stakeUsd: number; price?: number };\n        const stakeUsd = eventReq.stakeUsd || 5;\n        const riskPct = (stakeUsd / accountValue) * 100;\n        \n        serverDraftId = `draft-${uuidv4()}`;\n        const draftStrategy = {\n          id: serverDraftId,\n          type: 'event' as const,\n          status: 'draft' as const,\n          side: eventReq.outcome === 'YES' ? 'YES' : 'NO',\n          market: eventReq.marketId || 'FED_CUTS_MAR_2025',\n          eventKey: eventReq.marketId || 'FED_CUTS_MAR_2025',\n          label: eventReq.marketId || 'Fed Rate Cut',\n          riskPct,\n          entry: stakeUsd,\n          takeProfit: stakeUsd * 2, // Estimate\n          stopLoss: stakeUsd,\n          sourceText: userMessage.substring(0, 200),\n          stakeUsd,\n          maxPayoutUsd: stakeUsd * 2,\n          maxLossUsd: stakeUsd,\n          sizeUsd: stakeUsd, // For portfolio mapping\n          isClosed: false,\n          createdAt: new Date().toISOString(),\n        };\n        \n        portfolioAfter.strategies.push(draftStrategy);\n        \n        if (process.env.DEBUG_CARD_CONTRACT === 'true') {\n          console.log('[api/chat] Created event draft server-side:', {\n            draftId: serverDraftId,\n            marketId: draftStrategy.eventKey,\n            outcome: draftStrategy.side,\n            stakeUsd,\n          });\n        }\n      } else if (executionRequest.kind === 'lend' || executionRequest.kind === 'lend_supply') {\n        const lendReq = executionRequest as { kind: 'lend' | 'lend_supply'; chain: string; asset: string; amount: string; protocol?: string; vault?: string };\n        const amountUsd = parseFloat(lendReq.amount) || 10;\n        const riskPct = (amountUsd / accountValue) * 100;\n        \n        // Clamp APY to realistic demo range (Task A requirement)\n        const apyPct = 5.0; // Default to Aave REDACTED 5% for demo\n        \n        serverDraftId = `draft-${uuidv4()}`;\n        const draftStrategy = {\n          id: serverDraftId,\n          type: 'defi' as const,\n          status: 'draft' as const,\n          protocol: lendReq.vault || lendReq.protocol || 'Aave REDACTED',\n          vault: lendReq.vault || 'Aave REDACTED',\n          depositUsd: amountUsd,\n          apyPct,\n          sourceText: userMessage.substring(0, 200),\n          isClosed: false,\n          createdAt: new Date().toISOString(),\n          riskPct,\n          sizeUsd: amountUsd,\n          // For compatibility with ConfirmTradeCard (expects perp-like fields)\n          market: lendReq.vault || lendReq.protocol || 'Aave REDACTED',\n          side: 'long', // DeFi deposits are always \"long\"\n          marginUsd: amountUsd, // Deposit amount = margin for card display\n          leverage: 1, // DeFi has no leverage\n          notionalUsd: amountUsd, // Exposure = deposit amount\n          riskPercent: riskPct, // ConfirmTradeCard expects riskPercent (not riskPct)\n          entry: amountUsd,\n          takeProfit: amountUsd * (1 + apyPct / 100), // Show APY as take profit\n          stopLoss: amountUsd, // Max loss = deposit amount\n        };\n        \n        portfolioAfter.strategies.push(draftStrategy);\n        \n        if (process.env.DEBUG_CARD_CONTRACT === 'true') {\n          console.log('[api/chat] Created DeFi/lend draft server-side:', {\n            draftId: serverDraftId,\n            market: defiMarketLabel,\n            amountUsd,\n            apyPct,\n          });\n        }\n      }\n    }\n\n    // Task B: Enforce contract invariants - if actionable intent, must have draft\n    if (hasActionableIntent && executionRequest && !serverDraftId) {\n      // This should never happen if executionRequest exists, but add safety check\n      if (process.env.DEBUG_CARD_CONTRACT === 'true') {\n        console.error('[api/chat] WARNING: Actionable intent but no draft created:', {\n          executionRequestKind: executionRequest?.kind,\n          actions: actions.map(a => ({ type: a.type })),\n        });\n      }\n    }\n\n    const response: ChatResponse = {\n      assistantMessage,\n      actions,\n      executionRequest,\n      modelOk,\n      portfolio: portfolioAfter,\n      executionResults, // Include execution results\n      errorCode: (!modelOk && !executionRequest) ? 'LLM_REFUSAL' : undefined, // Only set LLM_REFUSAL if no executionRequest was generated (even after fallback)\n      draftId: serverDraftId, // Task A: Server-created draft ID for UI to set msg.type + msg.draftId\n    };\n\n    // Task C: DEBUG_CARD_CONTRACT logging\n    if (process.env.DEBUG_CARD_CONTRACT === 'true') {\n      console.log('[api/chat] Card Contract Debug:', {\n        prompt: userMessage.substring(0, 100),\n        executionRequestKind: executionRequest?.kind || 'none',\n        draftCreated: !!serverDraftId,\n        draftId: serverDraftId || 'none',\n        draftLocation: serverDraftId ? 'portfolio.strategies' : 'none',\n        portfolioStrategiesCount: portfolioAfter.strategies.length,\n        portfolioStrategiesIds: portfolioAfter.strategies.map((s: any) => ({ id: s.id, status: s.status, type: s.type })),\n      });\n    }\n\n    // Debug logging for contract verification (Task C)\n    if (process.env.DEBUG_RESPONSE === 'true') {\n      const redactedResponse = JSON.parse(JSON.stringify(response));\n      // Redact secrets (private keys, signatures) but keep structure\n      if (redactedResponse.executionRequest) {\n        // Remove any sensitive fields from executionRequest if present\n        delete (redactedResponse.executionRequest as any).privateKey;\n        delete (redactedResponse.executionRequest as any).signature;\n      }\n      console.log('[api/chat] Response JSON:', JSON.stringify(redactedResponse, null, 2));\n    }\n\n    // Log execution artifacts if enabled\n    if (process.env.DEBUG_EXECUTIONS === '1' && executionResults.length > 0) {\n      executionResults.forEach(result => {\n        logExecutionArtifact({\n          executionRequest,\n          executionResult: result,\n          userAddress: req.body.clientPortfolio?.userAddress,\n        });\n      });\n    }\n\n    // Telemetry: log chat response\n    logEvent('chat_response', {\n      success: modelOk,\n      latencyMs: Date.now() - chatStartTime,\n      notes: [`actions: ${actions.length}`, executionRequest ? `kind: ${executionRequest.kind}` : 'no_exec'],\n    });\n\n    // OBSERVABILITY: Plan missing detection (Objective C)\n    // Log when executionRequest is missing but user message suggests actionable intent\n    const correlationId = req.correlationId || 'unknown';\n    if (!executionRequest && actions.length === 0) {\n      const suspectedIntent = detectSuspectedIntent(userMessage);\n      if (suspectedIntent) {\n        logPlanMissing(correlationId, suspectedIntent, userMessage);\n        \n        // Add debug field in dev only\n        if (process.env.NODE_ENV !== 'production') {\n          (response as any).debug = {\n            planMissingReason: 'no_executionRequest_from_model',\n            suspectedIntent,\n            correlationId,\n          };\n        }\n      }\n    }\n\n    res.json(response);\n  } catch (error: any) {\n    console.error('Chat error:', error);\n    logEvent('chat_response', {\n      success: false,\n      error: error.message,\n      latencyMs: Date.now() - chatStartTime,\n    });\n    res.status(500).json({ error: error.message || 'Internal server error' });\n  }\n});\n\ninterface CloseRequest {\n  strategyId: string;\n  type: 'perp' | 'event' | 'defi';\n}\n\ninterface CloseResponse {\n  summaryMessage: string;\n  portfolio: BlossomPortfolioSnapshot;\n  liveMarkToMarketUsd?: number; // Optional: live mark-to-market value for event positions\n}\n\n/**\n * POST /api/strategy/close\n */\napp.post('/api/strategy/close', async (req, res) => {\n  try {\n    const { strategyId, type }: CloseRequest = req.body;\n\n    if (!strategyId || !type) {\n      return res.status(400).json({ error: 'strategyId and type are required' });\n    }\n\n    let summaryMessage = '';\n    let pnl = 0;\n    let eventResult: { liveMarkToMarketUsd?: number } | undefined;\n\n    if (type === 'perp') {\n      const result = await perpsSim.closePerp(strategyId);\n      pnl = result.pnl;\n      summaryMessage = `Closed ${result.position.market} ${result.position.side} position. Realized PnL: ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;\n    } else if (type === 'event') {\n      const result = await eventSim.closeEventPosition(strategyId);\n      pnl = result.pnl;\n      const outcome = result.position.outcome === 'won' ? 'Won' : 'Lost';\n      let pnlMessage = `Realized PnL: ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;\n      if (result.liveMarkToMarketUsd !== undefined) {\n        pnlMessage += ` (Live MTM: ${result.liveMarkToMarketUsd >= 0 ? '+' : ''}$${result.liveMarkToMarketUsd.toFixed(2)})`;\n        eventResult = { liveMarkToMarketUsd: result.liveMarkToMarketUsd };\n      }\n      summaryMessage = `Settled event position \"${result.position.label}\" (${outcome}). ${pnlMessage}`;\n    } else if (type === 'defi') {\n      const result = defiSim.closeDefiPosition(strategyId);\n      pnl = result.yieldEarned;\n      summaryMessage = `Closed ${result.position.protocol} position. Yield earned: $${pnl.toFixed(2)}`;\n    } else {\n      return res.status(400).json({ error: `Unknown strategy type: ${type}` });\n    }\n\n    // Build updated portfolio snapshot\n    const portfolio = buildPortfolioSnapshot();\n\n    // If this was an event close with liveMarkToMarketUsd, attach it to the strategy in the portfolio\n    if (type === 'event' && eventResult?.liveMarkToMarketUsd !== undefined) {\n      const strategyIndex = portfolio.strategies.findIndex((s: any) => s.id === strategyId);\n      if (strategyIndex >= 0) {\n        portfolio.strategies[strategyIndex] = {\n          ...portfolio.strategies[strategyIndex],\n          liveMarkToMarketUsd: eventResult.liveMarkToMarketUsd,\n        };\n      }\n    }\n\n    const response: CloseResponse = {\n      summaryMessage,\n      portfolio,\n    };\n\n    res.json(response);\n  } catch (error: any) {\n    console.error('Close strategy error:', error);\n    res.status(500).json({ error: error.message || 'Internal server error' });\n  }\n});\n\n/**\n * POST /api/reset\n * V1/V1.1: Only resets chat state (no portfolio reset)\n * SIM mode: Resets simulation state (only if ALLOW_SIM_MODE=true)\n */\napp.post('/api/reset', async (req, res) => {\n  try {\n    const { EXECUTION_MODE } = await import('../config');\n    const ALLOW_SIM_MODE = process.env.ALLOW_SIM_MODE === 'true';\n    \n    // In SIM mode with explicit permission, reset simulation state\n    if (EXECUTION_MODE === 'sim' && ALLOW_SIM_MODE) {\n      resetAllSims();\n      const snapshot = getPortfolioSnapshot();\n      res.json({ \n        portfolio: snapshot, \n        message: 'Simulation state reset.' \n      });\n      return;\n    }\n    \n    // V1/V1.1: Only reset chat state (no portfolio reset)\n    res.json({ \n      message: 'Chat state reset.' \n    });\n  } catch (err: any) {\n    console.error('Failed to reset state', err);\n    res.status(500).json({ error: 'Failed to reset state' });\n  }\n});\n\n/**\n * GET /api/ticker\n */\napp.get('/api/ticker', async (req, res) => {\n  try {\n    const venue = (req.query.venue as string) || 'hyperliquid';\n    \n    if (venue === 'event_demo') {\n      const payload = await getEventMarketsTicker();\n      res.json({\n        venue: payload.venue,\n        sections: payload.sections,\n        lastUpdatedMs: payload.lastUpdatedMs ?? Date.now(),\n        isLive: payload.isLive ?? false,\n        source: payload.source ?? 'static',\n      });\n    } else {\n      const payload = await getOnchainTicker();\n      res.json({\n        venue: payload.venue,\n        sections: payload.sections,\n        lastUpdatedMs: payload.lastUpdatedMs ?? Date.now(),\n        isLive: payload.isLive ?? false,\n        source: payload.source ?? 'static',\n      });\n    }\n  } catch (error: any) {\n    console.error('Ticker error:', error);\n    // Return fallback payload\n    if (req.query.venue === 'event_demo') {\n      res.json({\n        venue: 'event_demo',\n        sections: [\n          {\n            id: 'kalshi',\n            label: 'Kalshi',\n            items: [\n              { label: 'Fed cuts in March 2025', value: '62%', meta: 'Kalshi' },\n              { label: 'BTC ETF approved by Dec 31', value: '68%', meta: 'Kalshi' },\n            ],\n          },\n        ],\n        lastUpdatedMs: Date.now(),\n        isLive: false,\n        source: 'static',\n      });\n    } else {\n      res.json({\n        venue: 'hyperliquid',\n        sections: [\n          {\n            id: 'majors',\n            label: 'Majors',\n            items: [\n              { label: 'BTC', value: '$60,000', change: '+2.5%', meta: '24h' },\n              { label: 'ETH', value: '$3,000', change: '+1.8%', meta: '24h' },\n            ],\n          },\n        ],\n        lastUpdatedMs: Date.now(),\n        isLive: false,\n        source: 'static',\n      });\n    }\n  }\n});\n\n/**\n * POST /api/execute/prepare\n * Prepare execution plan for ETH testnet\n */\napp.post('/api/execute/prepare', maybeCheckAccess, async (req, res) => {\n  const correlationId = req.correlationId || generateCorrelationId();\n  const prepareStartTime = Date.now();\n  \n  // Extract key info for trace (no secrets)\n  const { draftId, executionRequest, userAddress } = req.body || {};\n  logExecuteTrace(correlationId, 'prepare:start', {\n    kind: executionRequest?.kind,\n    draftId: draftId?.substring(0, 8),\n    userAddress: userAddress?.substring(0, 10),\n  });\n  \n  try {\n    const { EXECUTION_MODE, EXECUTION_DISABLED, V1_DEMO } = await import('../config');\n    \n    // V1: Emergency kill switch\n    if (EXECUTION_DISABLED) {\n      return res.status(503).json({\n        error: 'Execution temporarily disabled',\n        errorCode: 'EXECUTION_DISABLED',\n        message: 'Execution has been temporarily disabled. Please try again later.',\n      });\n    }\n    \n    if (EXECUTION_MODE !== 'eth_testnet') {\n      return res.status(400).json({\n        error: 'Execute endpoint only available in eth_testnet mode',\n      });\n    }\n    \n    // V1_DEMO: Block direct execution if session not enabled\n    if (V1_DEMO && req.body.authMode !== 'session') {\n      return res.status(403).json({\n        error: 'V1_DEMO mode requires session-based execution',\n        errorCode: 'V1_DEMO_DIRECT_BLOCKED',\n        message: 'Direct execution is disabled in V1_DEMO mode. Please enable one-click execution first.',\n      });\n    }\n\n    const { prepareEthTestnetExecution } = await import('../executors/ethTestnetExecutor');\n\n    // Debug: log request body\n    console.log('[api/execute/prepare] Request body:', JSON.stringify(req.body, null, 2));\n\n    // Accept executionRequest from chat or fallback to executionIntent\n    const result = await prepareEthTestnetExecution(req.body);\n\n    // Include demo token addresses for frontend approval flow\n    const { DEMO_REDACTED_ADDRESS, DEMO_WETH_ADDRESS, EXECUTION_ROUTER_ADDRESS } = await import('../config');\n    \n    // Telemetry: log prepare success\n    const actionTypes = result.plan?.actions?.map((a: any) => a.actionType) || [];\n    logEvent('prepare_success', {\n      draftId: req.body.draftId,\n      userHash: req.body.userAddress ? hashAddress(req.body.userAddress) : undefined,\n      authMode: req.body.authMode,\n      actionTypes,\n      executionKind: req.body.executionKind,\n      latencyMs: Date.now() - prepareStartTime,\n      success: true,\n    });\n    \n    // Trace log: prepare success\n    logExecuteTrace(correlationId, 'prepare:ok', {\n      planSteps: result.plan?.actions?.length || 0,\n      actionTypes,\n      latencyMs: Date.now() - prepareStartTime,\n    });\n    \n    res.json({\n      chainId: result.chainId,\n      to: result.to,\n      value: result.value,\n      plan: result.plan,\n      planHash: (result as any).planHash, // V1: Include server-computed planHash\n      typedData: result.typedData,\n      call: result.call,\n      requirements: result.requirements,\n      summary: result.summary,\n      warnings: result.warnings,\n      routing: result.routing, // Include routing metadata for demo swaps\n      correlationId, // Include correlationId for client tracing\n      demoTokens: DEMO_REDACTED_ADDRESS && DEMO_WETH_ADDRESS ? {\n        DEMO_REDACTED: DEMO_REDACTED_ADDRESS,\n        DEMO_WETH: DEMO_WETH_ADDRESS,\n        routerAddress: EXECUTION_ROUTER_ADDRESS,\n      } : undefined,\n    });\n  } catch (error: any) {\n    console.error('[api/execute/prepare] Error:', error);\n    \n    // Trace log: prepare error\n    logExecuteTrace(correlationId, 'prepare:error', {\n      error: error.message,\n      code: error.code || 'UNKNOWN',\n      latencyMs: Date.now() - prepareStartTime,\n    });\n    \n    logEvent('prepare_fail', {\n      draftId: req.body.draftId,\n      error: error.message,\n      latencyMs: Date.now() - prepareStartTime,\n      success: false,\n    });\n    res.status(500).json({\n      error: 'Failed to prepare execution',\n      message: error.message,\n      correlationId, // Include correlationId in error response\n    });\n  }\n});\n\n/**\n * POST /api/setup/approve\n * Prepare ERC20 approval transaction\n */\napp.post('/api/setup/approve', maybeCheckAccess, async (req, res) => {\n  try {\n    const { userAddress, tokenAddress, spenderAddress, amount } = req.body;\n\n    if (!userAddress || !tokenAddress || !spenderAddress || !amount) {\n      return res.status(400).json({\n        error: 'userAddress, tokenAddress, spenderAddress, and amount are required',\n      });\n    }\n\n    // Telemetry: log approve prepare\n    logEvent('approve_prepare', {\n      userHash: userAddress ? hashAddress(userAddress) : undefined,\n      notes: [tokenAddress.substring(0, 10) + '...', spenderAddress.substring(0, 10) + '...'],\n    });\n\n    // Encode approve function call\n    const { encodeFunctionData } = await import('viem');\n    const approveAbi = [\n      {\n        name: 'approve',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          { name: 'spender', type: 'address' },\n          { name: 'amount', type: 'uint256' },\n        ],\n        outputs: [{ name: '', type: 'bool' }],\n      },\n    ] as const;\n\n    // Handle MaxUint256 string\n    const amountBigInt = amount === 'MaxUint256' \n      ? BigInt('0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff')\n      : BigInt(amount);\n\n    const data = encodeFunctionData({\n      abi: approveAbi,\n      functionName: 'approve',\n      args: [spenderAddress as `0x${string}`, amountBigInt],\n    });\n\n    const { ETH_TESTNET_CHAIN_ID } = await import('../config');\n\n    res.json({\n      chainId: ETH_TESTNET_CHAIN_ID,\n      to: tokenAddress,\n      data,\n      value: '0x0',\n      summary: `Approve ${spenderAddress.substring(0, 10)}... to spend tokens`,\n    });\n  } catch (error: any) {\n    console.error('[api/setup/approve] Error:', error);\n    res.status(500).json({\n      error: 'Failed to prepare approval',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * POST /api/execute/submit\n * Submit transaction hash after execution\n * Returns unified ExecutionResult with receipt confirmation in eth_testnet mode\n */\napp.post('/api/execute/submit', maybeCheckAccess, async (req, res) => {\n  const submitStartTime = Date.now();\n  try {\n    const { draftId, txHash, userAddress, strategy, executionRequest } = req.body;\n\n    if (!draftId || !txHash) {\n      return res.status(400).json({\n        error: 'draftId and txHash are required',\n      });\n    }\n\n    // Telemetry: log submit\n    logEvent('submit_tx', {\n      draftId,\n      txHash,\n      userHash: userAddress ? hashAddress(userAddress) : undefined,\n    });\n\n    // Get portfolio before\n    const portfolioBefore = buildPortfolioSnapshot();\n    \n    const { EXECUTION_MODE, ETH_TESTNET_RPC_URL } = await import('../config');\n    \n    // In eth_testnet mode, wait for receipt confirmation\n    let receiptStatus: 'confirmed' | 'failed' | 'timeout' | 'pending' = 'confirmed';\n    let blockNumber: number | undefined;\n    let receiptError: string | undefined;\n    \n    if (EXECUTION_MODE === 'eth_testnet' && ETH_TESTNET_RPC_URL) {\n      const receiptResult = await waitForReceipt(ETH_TESTNET_RPC_URL, txHash, {\n        timeoutMs: 60000,\n        pollMs: 2000,\n      });\n      \n      receiptStatus = receiptResult.status;\n      blockNumber = receiptResult.blockNumber;\n      receiptError = receiptResult.error;\n      \n      // Telemetry: log receipt result\n      if (receiptStatus === 'confirmed') {\n        logEvent('tx_confirmed', {\n          draftId,\n          txHash,\n          blockNumber,\n          latencyMs: Date.now() - submitStartTime,\n          success: true,\n        });\n      } else if (receiptStatus === 'failed') {\n        logEvent('tx_failed', {\n          draftId,\n          txHash,\n          blockNumber,\n          error: receiptError,\n          success: false,\n        });\n      } else if (receiptStatus === 'timeout') {\n        logEvent('tx_timeout', {\n          draftId,\n          txHash,\n          error: receiptError,\n          success: false,\n        });\n      }\n    }\n\n    // Update sim state after successful ProofOfExecution\n    if (receiptStatus === 'confirmed' && (strategy || executionRequest)) {\n      // perpsSim, eventSim, defiSim are already imported at top of file\n\n      // Determine execution type from strategy or executionRequest\n      const isPerp = strategy?.instrumentType === 'perp' || strategy?.type === 'perp' || executionRequest?.kind === 'perp';\n      const isEvent = strategy?.instrumentType === 'event' || strategy?.type === 'event' || executionRequest?.kind === 'event';\n      const isDefi = strategy?.instrumentType === 'defi' || strategy?.type === 'defi' || executionRequest?.kind === 'lend';\n\n      if (isPerp) {\n        // Add perp position to sim state\n        await perpsSim.openPerp({\n          market: strategy?.market || executionRequest?.market || 'BTC-USD',\n          side: strategy?.side || strategy?.direction || executionRequest?.side || 'long',\n          riskPct: strategy?.riskPercent || strategy?.riskPct || executionRequest?.riskPct || 2,\n          entry: strategy?.entry || executionRequest?.entryPrice || 0,\n          takeProfit: strategy?.takeProfit || executionRequest?.takeProfitPrice || 0,\n          stopLoss: strategy?.stopLoss || executionRequest?.stopLossPrice || 0,\n        });\n        console.log('[api/execute/submit] Updated perpsSim with new position');\n      } else if (isEvent) {\n        // Add event position to sim state\n        await eventSim.openEventPosition(\n          strategy?.market || executionRequest?.marketId || 'unknown-event',\n          strategy?.outcome || strategy?.side || executionRequest?.outcome || 'YES',\n          strategy?.stakeUsd || executionRequest?.stakeUsd || 10\n        );\n        console.log('[api/execute/submit] Updated eventSim with new position');\n      } else if (isDefi) {\n        // Add DeFi position to sim state\n        await defiSim.openDefiPosition(\n          strategy?.protocol || 'DemoLend',\n          strategy?.depositUsd || executionRequest?.amountUsd || 100\n        );\n        console.log('[api/execute/submit] Updated defiSim with new position');\n      }\n    }\n\n    const portfolioAfter = buildPortfolioSnapshot();\n    \n    // Build response based on receipt status\n    // Map receipt status to ExecutionResult status (which only supports 'success' | 'failed')\n    const mappedStatus: 'success' | 'failed' = receiptStatus === 'confirmed' ? 'success' : 'failed';\n    \n    const result: ExecutionResult & { receiptStatus?: string; blockNumber?: number } = {\n      success: receiptStatus === 'confirmed',\n      status: mappedStatus,\n      txHash,\n      receiptStatus,\n      blockNumber,\n      error: receiptError,\n      portfolioDelta: {\n        accountValueDeltaUsd: portfolioAfter.accountValueUsd - portfolioBefore.accountValueUsd,\n        balanceDeltas: portfolioAfter.balances.map(b => {\n          const before = portfolioBefore.balances.find(b2 => b2.symbol === b.symbol);\n          return {\n            symbol: b.symbol,\n            deltaUsd: b.balanceUsd - (before?.balanceUsd || 0),\n          };\n        }),\n      },\n      portfolio: portfolioAfter,\n    };\n\n    // Task 4: Add execution path proof for direct execution\n    res.json({\n      ...result,\n      notes: ['execution_path:direct'], // Task 4: Unambiguous evidence of execution path\n    });\n  } catch (error: any) {\n    console.error('[api/execute/submit] Error:', error);\n    logEvent('error', {\n      error: error.message,\n      notes: ['submit_tx_error'],\n    });\n    const portfolioAfter = buildPortfolioSnapshot();\n    const result: ExecutionResult = {\n      success: false,\n      status: 'failed',\n      error: error.message || 'Failed to submit transaction',\n      portfolio: portfolioAfter,\n    };\n    res.status(500).json(result);\n  }\n});\n\n/**\n * GET /api/execute/preflight\n * Preflight check for execution readiness\n */\napp.get('/api/execute/preflight', async (req, res) => {\n  try {\n    const { EXECUTION_MODE } = await import('../config');\n    const ALLOW_SIM_MODE = process.env.ALLOW_SIM_MODE === 'true';\n\n    // Only allow SIM mode if explicitly enabled\n    if (EXECUTION_MODE === 'sim' && ALLOW_SIM_MODE) {\n      return res.json({\n        mode: 'sim',\n        ok: true,\n        notes: ['sim mode'],\n      });\n    }\n    \n    // If SIM requested but not allowed, treat as eth_testnet\n    if (EXECUTION_MODE === 'sim' && !ALLOW_SIM_MODE) {\n      // Fall through to eth_testnet handling\n    }\n\n    if (EXECUTION_MODE !== 'eth_testnet') {\n      return res.status(400).json({\n        error: 'Preflight endpoint only available in sim or eth_testnet mode',\n      });\n    }\n\n    const {\n      ETH_TESTNET_RPC_URL,\n      EXECUTION_ROUTER_ADDRESS,\n      MOCK_SWAP_ADAPTER_ADDRESS,\n      requireEthTestnetConfig,\n    } = await import('../config');\n\n    const notes: string[] = [];\n    let ok = true;\n\n    // Validate config\n    try {\n      requireEthTestnetConfig();\n    } catch (error: any) {\n      ok = false;\n      notes.push(`Config error: ${error.message}`);\n    }\n\n    // Check RPC connectivity\n    let rpcOk = false;\n    if (ETH_TESTNET_RPC_URL) {\n      try {\n        const response = await fetch(ETH_TESTNET_RPC_URL, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            jsonrpc: '2.0',\n            id: 1,\n            method: 'eth_blockNumber',\n            params: [],\n          }),\n        });\n        rpcOk = response.ok;\n        if (!rpcOk) {\n          notes.push('RPC call failed');\n        }\n      } catch (error: any) {\n        notes.push(`RPC error: ${error.message}`);\n      }\n    } else {\n      notes.push('ETH_TESTNET_RPC_URL not configured');\n    }\n\n    // Check router deployment\n    let routerOk = false;\n    if (EXECUTION_ROUTER_ADDRESS && ETH_TESTNET_RPC_URL && rpcOk) {\n      try {\n        const { eth_getCode } = await import('../executors/evmRpc');\n        const code = await eth_getCode(ETH_TESTNET_RPC_URL, EXECUTION_ROUTER_ADDRESS);\n        routerOk = code !== '0x' && code.length > 2;\n        if (!routerOk) {\n          notes.push('Router contract not deployed at EXECUTION_ROUTER_ADDRESS');\n        }\n      } catch (error: any) {\n        notes.push(`Router check error: ${error.message}`);\n      }\n    } else {\n      notes.push('Cannot check router: missing EXECUTION_ROUTER_ADDRESS or RPC');\n    }\n\n    // Check adapter allowlist (if router is deployed)\n    let adapterOk = false;\n    if (routerOk && MOCK_SWAP_ADAPTER_ADDRESS && ETH_TESTNET_RPC_URL) {\n      try {\n        const { eth_call } = await import('../executors/evmRpc');\n        const { encodeFunctionData } = await import('viem');\n        if (!EXECUTION_ROUTER_ADDRESS) {\n          throw new Error('EXECUTION_ROUTER_ADDRESS not configured');\n        }\n        // Call router.isAdapterAllowed(address) - public mapping getter\n        const data = encodeFunctionData({\n          abi: [\n            {\n              name: 'isAdapterAllowed',\n              type: 'function',\n              stateMutability: 'view',\n              inputs: [{ name: '', type: 'address' }],\n              outputs: [{ name: '', type: 'bool' }],\n            },\n          ],\n          functionName: 'isAdapterAllowed',\n          args: [MOCK_SWAP_ADAPTER_ADDRESS as `0x${string}`],\n        });\n        \n        // Debug logging (safe: no secrets)\n        console.log('[preflight] Adapter check:', {\n          method: 'eth_call',\n          to: EXECUTION_ROUTER_ADDRESS,\n          data: data,\n          dataLength: data.length,\n        });\n        \n        // Ensure data is valid hex (at least \"0x\")\n        if (!data || !data.startsWith('0x') || data.length < 4) {\n          throw new Error(`Invalid call data: ${data}`);\n        }\n        \n        const result = await eth_call(ETH_TESTNET_RPC_URL, EXECUTION_ROUTER_ADDRESS, data);\n        const { decodeBool } = await import('../executors/evmRpc');\n        adapterOk = decodeBool(result);\n        if (!adapterOk) {\n          notes.push('Adapter not allowlisted in router');\n        }\n      } catch (error: any) {\n        notes.push(`Adapter check error: ${error.message}`);\n        console.error('[preflight] Adapter check failed:', error);\n      }\n    }\n\n    // Check nonce fetching capability\n    // Use eth_getTransactionCount instead of eth_call for simpler, more reliable check\n    let nonceOk = false;\n    if (routerOk && ETH_TESTNET_RPC_URL) {\n      try {\n        if (!EXECUTION_ROUTER_ADDRESS) {\n          throw new Error('EXECUTION_ROUTER_ADDRESS not configured');\n        }\n        // Use a test address to check nonce fetching\n        const testAddress = '0x' + '1'.repeat(40);\n        \n        // Debug logging (safe: no secrets)\n        console.log('[preflight] Nonce check:', {\n          method: 'eth_getTransactionCount',\n          address: testAddress,\n        });\n        \n        // Use eth_getTransactionCount for nonce check (simpler and more reliable)\n        const response = await fetch(ETH_TESTNET_RPC_URL, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            jsonrpc: '2.0',\n            id: 1,\n            method: 'eth_getTransactionCount',\n            params: [testAddress.toLowerCase(), 'latest'],\n          }),\n        });\n        \n        const jsonResult: unknown = await response.json();\n        const result = jsonResult as { result?: string; error?: { message?: string } };\n        \n        if (result.error) {\n          throw new Error(`RPC error: ${result.error.message || 'Unknown error'}`);\n        }\n        \n        // If we get a result (even \"0x0\"), nonce fetching works\n        nonceOk = result.result !== undefined;\n      } catch (error: any) {\n        notes.push(`Nonce check error: ${error.message}`);\n        console.error('[preflight] Nonce check failed:', error);\n      }\n    }\n\n    if (!rpcOk || !routerOk || !adapterOk || !nonceOk) {\n      ok = false;\n    }\n\n    // Check routing configuration\n    const {\n      ROUTING_MODE,\n      ONEINCH_API_KEY,\n      EXECUTION_SWAP_MODE,\n    } = await import('../config');\n\n    // Check 1inch connectivity\n    let oneinchOk = false;\n    if (ONEINCH_API_KEY) {\n      try {\n        // Quick health check: try to get a quote for a small swap\n        const testResponse = await fetch(\n          `https://api.1inch.dev/swap/v6.0/11155111/quote?src=0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&dst=0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&amount=1000000`,\n          {\n            headers: {\n              'Authorization': `Bearer ${ONEINCH_API_KEY}`,\n              'Accept': 'application/json',\n            },\n            signal: AbortSignal.timeout(3000), // 3s timeout\n          }\n        );\n        oneinchOk = testResponse.ok;\n      } catch (error: any) {\n        // Timeout or network error - not critical\n        oneinchOk = false;\n      }\n    }\n\n    const routingStatus = {\n      mode: ROUTING_MODE,\n      liveRoutingEnabled: ROUTING_MODE === 'hybrid',\n      hasApiKey: !!ONEINCH_API_KEY,\n      connectivityOk: oneinchOk,\n      executionMode: EXECUTION_SWAP_MODE,\n    };\n\n    if (ROUTING_MODE === 'hybrid') {\n      if (oneinchOk) {\n        notes.push('Live routing: enabled (1inch - connected)');\n      } else {\n        notes.push('Live routing: enabled (1inch - API key present but connectivity check failed)');\n      }\n    } else {\n      notes.push('Live routing: disabled (deterministic fallback)');\n    }\n\n    if (EXECUTION_SWAP_MODE === 'demo') {\n      notes.push('Swap execution: deterministic demo venue');\n    }\n\n    // Check lending configuration\n    const {\n      DEMO_LEND_VAULT_ADDRESS,\n      DEMO_LEND_ADAPTER_ADDRESS,\n      LENDING_EXECUTION_MODE,\n      LENDING_RATE_SOURCE,\n      AAVE_SEPOLIA_POOL_ADDRESS,\n      AAVE_ADAPTER_ADDRESS,\n    } = await import('../config');\n\n    // Check DefiLlama connectivity\n    let defillamaOk = false;\n    if (LENDING_RATE_SOURCE === 'defillama') {\n      try {\n        const testResponse = await fetch('https://yields.llama.fi/pools', {\n          headers: { 'Accept': 'application/json' },\n          signal: AbortSignal.timeout(3000), // 3s timeout\n        });\n        defillamaOk = testResponse.ok;\n      } catch (error: any) {\n        // Timeout or network error - not critical\n        defillamaOk = false;\n      }\n    }\n\n    // Check for real Aave config (variables already imported above at line 2223-2224)\n    const hasAaveConfig = !!AAVE_SEPOLIA_POOL_ADDRESS && !!AAVE_ADAPTER_ADDRESS;\n    const isRealAave = LENDING_EXECUTION_MODE === 'real' && hasAaveConfig;\n    \n    const lendingStatus = {\n      enabled: isRealAave || (!!DEMO_LEND_VAULT_ADDRESS && !!DEMO_LEND_ADAPTER_ADDRESS),\n      mode: LENDING_EXECUTION_MODE || 'demo',\n      vault: isRealAave ? AAVE_SEPOLIA_POOL_ADDRESS : (DEMO_LEND_VAULT_ADDRESS || null),\n      adapter: isRealAave ? AAVE_ADAPTER_ADDRESS : (DEMO_LEND_ADAPTER_ADDRESS || null),\n      rateSource: LENDING_RATE_SOURCE || 'demo',\n      defillamaOk,\n    };\n\n    if (lendingStatus.enabled) {\n      if (isRealAave) {\n        notes.push(`Lending: enabled (${lendingStatus.mode}, Aave V3 Sepolia)`);\n      } else if (LENDING_RATE_SOURCE === 'defillama' && defillamaOk) {\n        notes.push(`Lending: enabled (${lendingStatus.mode}, DefiLlama - connected)`);\n      } else if (LENDING_RATE_SOURCE === 'defillama') {\n        notes.push(`Lending: enabled (${lendingStatus.mode}, DefiLlama - connectivity check failed)`);\n      } else {\n        notes.push(`Lending: enabled (${lendingStatus.mode})`);\n      }\n    } else {\n      if (LENDING_EXECUTION_MODE === 'real' && !hasAaveConfig) {\n        notes.push('Lending: disabled (real mode requested but AAVE_SEPOLIA_POOL_ADDRESS or AAVE_ADAPTER_ADDRESS not configured)');\n      } else {\n        notes.push('Lending: disabled (vault or adapter not configured)');\n      }\n    }\n\n    // Check dFlow configuration\n    const {\n      DFLOW_ENABLED,\n      DFLOW_API_KEY,\n      DFLOW_BASE_URL,\n      DFLOW_EVENTS_MARKETS_PATH,\n      DFLOW_EVENTS_QUOTE_PATH,\n      DFLOW_SWAPS_QUOTE_PATH,\n      DFLOW_REQUIRE,\n    } = await import('../config');\n\n    const dflowStatus = {\n      enabled: DFLOW_ENABLED,\n      ok: DFLOW_ENABLED && !!DFLOW_API_KEY && !!DFLOW_BASE_URL,\n      required: DFLOW_REQUIRE,\n      capabilities: {\n        eventsMarkets: DFLOW_ENABLED && !!DFLOW_EVENTS_MARKETS_PATH,\n        eventsQuotes: DFLOW_ENABLED && !!DFLOW_EVENTS_QUOTE_PATH,\n        swapsQuotes: DFLOW_ENABLED && !!DFLOW_SWAPS_QUOTE_PATH,\n      },\n    };\n\n    if (DFLOW_ENABLED) {\n      if (dflowStatus.ok) {\n        const caps = [];\n        if (dflowStatus.capabilities.eventsMarkets) caps.push('events-markets');\n        if (dflowStatus.capabilities.eventsQuotes) caps.push('events-quotes');\n        if (dflowStatus.capabilities.swapsQuotes) caps.push('swaps-quotes');\n        notes.push(`dFlow: enabled (${caps.join(', ') || 'no capabilities'})`);\n      } else {\n        notes.push('dFlow: enabled but not configured (missing API_KEY or BASE_URL)');\n        if (DFLOW_REQUIRE) {\n          ok = false;\n          notes.push('dFlow is required but not properly configured');\n        }\n      }\n    } else {\n      notes.push('dFlow: disabled');\n    }\n\n    // Update routing notes based on dFlow\n    if (ROUTING_MODE === 'dflow' && dflowStatus.capabilities.swapsQuotes) {\n      notes.push('Live routing: enabled (dFlow)');\n    }\n\n    // Build allowed adapters list for capabilities\n    // Note: AAVE_ADAPTER_ADDRESS already imported above at line 2224\n    const {\n      PROOF_ADAPTER_ADDRESS,\n      ERC20_PULL_ADAPTER_ADDRESS,\n      UNISWAP_V3_ADAPTER_ADDRESS,\n      WETH_WRAP_ADAPTER_ADDRESS,\n    } = await import('../config');\n    \n    const allowedAdapters: string[] = [];\n    if (UNISWAP_V3_ADAPTER_ADDRESS) {\n      allowedAdapters.push(UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (WETH_WRAP_ADAPTER_ADDRESS) {\n      allowedAdapters.push(WETH_WRAP_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (MOCK_SWAP_ADAPTER_ADDRESS) {\n      allowedAdapters.push(MOCK_SWAP_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (PROOF_ADAPTER_ADDRESS) {\n      allowedAdapters.push(PROOF_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (ERC20_PULL_ADAPTER_ADDRESS) {\n      allowedAdapters.push(ERC20_PULL_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (DEMO_LEND_ADAPTER_ADDRESS) {\n      allowedAdapters.push(DEMO_LEND_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (AAVE_ADAPTER_ADDRESS) {\n      allowedAdapters.push(AAVE_ADAPTER_ADDRESS.toLowerCase());\n    }\n\n    res.json({\n      mode: 'eth_testnet',\n      ok,\n      chainId: 11155111,\n      executionRouterAddress: EXECUTION_ROUTER_ADDRESS || null,\n      allowedAdapters,\n      router: EXECUTION_ROUTER_ADDRESS || null, // Legacy field\n      adapter: MOCK_SWAP_ADAPTER_ADDRESS || null, // Legacy field\n      rpc: rpcOk,\n      routing: routingStatus,\n      lending: lendingStatus,\n      dflow: dflowStatus,\n      notes,\n    });\n  } catch (error: any) {\n    console.error('[api/execute/preflight] Error:', error);\n    res.status(500).json({\n      error: 'Failed to run preflight check',\n      message: error.message,\n    });\n  }\n});\n\n// Rate limiting for session endpoints (in-memory, per endpoint)\nconst sessionEndpointCooldowns = new Map<string, number>();\nconst SESSION_COOLDOWN_MS = 1500;\n\nfunction checkSessionCooldown(endpoint: string): boolean {\n  const now = Date.now();\n  const lastCall = sessionEndpointCooldowns.get(endpoint);\n  if (lastCall && (now - lastCall) < SESSION_COOLDOWN_MS) {\n    return false; // Still in cooldown\n  }\n  sessionEndpointCooldowns.set(endpoint, now);\n  return true; // Not in cooldown\n}\n\n/**\n * POST /api/session/prepare\n * Prepare session creation transaction\n * NEVER returns 400 - always returns 200 with enabled:false if not configured\n */\napp.post('/api/session/prepare', async (req, res) => {\n  const correlationId = req.correlationId || generateCorrelationId();\n  \n  // Safe logging: body keys (no secrets)\n  const bodyKeys = req.body ? Object.keys(req.body) : [];\n  logSessionTrace(correlationId, 'prepare:start', { \n    hasBody: !!req.body,\n    bodyKeys,\n  });\n  \n  try {\n    const { EXECUTION_MODE, EXECUTION_AUTH_MODE } = await import('../config');\n    \n    // Accept both body and query params, support both userAddress and address (backward compat)\n    const userAddress = req.body?.userAddress || req.body?.address || req.query?.userAddress || req.query?.address;\n\n    // Check cooldown (only log once per cooldown window)\n    const cooldownKey = `prepare-${userAddress || 'empty'}`;\n    const inCooldown = !checkSessionCooldown(cooldownKey);\n    if (inCooldown && process.env.DEBUG_SESSION !== 'true') {\n      // Skip logging if in cooldown and not debug mode\n    } else if (process.env.DEBUG_SESSION === 'true') {\n      console.log('[api/session/prepare] Request:', { userAddress, EXECUTION_MODE, EXECUTION_AUTH_MODE });\n    }\n\n    // If not in session mode, return enabled:false (200 OK but disabled)\n    if (EXECUTION_MODE !== 'eth_testnet' || EXECUTION_AUTH_MODE !== 'session') {\n      return res.json({\n        ok: true,\n        status: 'disabled', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'NOT_CONFIGURED',\n          required: ['EXECUTION_MODE=eth_testnet', 'EXECUTION_AUTH_MODE=session'],\n        },\n        correlationId,\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // VALIDATION: userAddress is required - return 400 if missing\n    if (!userAddress || typeof userAddress !== 'string') {\n      logSessionTrace(correlationId, 'prepare:error', { \n        error: 'Missing userAddress',\n        code: 'MISSING_USER_ADDRESS',\n      });\n      return res.status(400).json({\n        ok: false,\n        correlationId,\n        error: {\n          code: 'MISSING_USER_ADDRESS',\n          message: 'userAddress (or address) is required in request body',\n        },\n      });\n    }\n\n    // Safe log: derived address (truncated)\n    logSessionTrace(correlationId, 'prepare:validated', {\n      userAddress: userAddress.substring(0, 10) + '...',\n    });\n\n    // Telemetry: log session prepare\n    logEvent('session_prepare', {\n      userHash: hashAddress(userAddress),\n      authMode: 'session',\n    });\n\n    const {\n      EXECUTION_ROUTER_ADDRESS,\n      MOCK_SWAP_ADAPTER_ADDRESS,\n      UNISWAP_V3_ADAPTER_ADDRESS,\n      WETH_WRAP_ADAPTER_ADDRESS,\n      ERC20_PULL_ADAPTER_ADDRESS,\n      PROOF_ADAPTER_ADDRESS,\n      DEMO_LEND_ADAPTER_ADDRESS,\n      AAVE_ADAPTER_ADDRESS,\n      RELAYER_PRIVATE_KEY,\n      ETH_TESTNET_RPC_URL,\n      requireRelayerConfig,\n    } = await import('../config');\n\n    requireRelayerConfig();\n\n    // DEV-ONLY: Log router + chain diagnostics\n    if (process.env.NODE_ENV !== 'production') {\n      try {\n        const { createPublicClient, http } = await import('viem');\n        const { sepolia } = await import('viem/chains');\n        const publicClient = createPublicClient({\n          chain: sepolia,\n          transport: http(ETH_TESTNET_RPC_URL),\n        });\n        \n        const chainId = await publicClient.getChainId();\n        const routerCode = await publicClient.getBytecode({ address: EXECUTION_ROUTER_ADDRESS as `0x${string}` });\n        const routerIsContract = routerCode && routerCode !== '0x' && routerCode.length > 2;\n        \n        logSessionTrace(correlationId, 'prepare:diagnostics', {\n          chainId,\n          routerAddress: EXECUTION_ROUTER_ADDRESS,\n          routerIsContract,\n          routerCodeLength: routerCode?.length || 0,\n        });\n      } catch (diagError: any) {\n        logSessionTrace(correlationId, 'prepare:diagnostics:error', {\n          error: diagError.message,\n        });\n      }\n    }\n\n    // Generate session ID\n    const { keccak256, toBytes, parseUnits } = await import('viem');\n    const sessionId = keccak256(\n      toBytes(userAddress + Date.now().toString())\n    );\n\n    // DEBUG: Log generated sessionId\n    console.log('[session/prepare] Generated sessionId:', sessionId);\n    console.log('[session/prepare] For userAddress:', userAddress);\n\n    // Derive relayer address from private key\n    const { privateKeyToAccount } = await import('viem/accounts');\n    const relayerAccount = privateKeyToAccount(RELAYER_PRIVATE_KEY as `0x${string}`);\n    const executor = relayerAccount.address;\n\n    // Set session parameters\n    const expiresAt = BigInt(Math.floor(Date.now() / 1000) + 7 * 24 * 60 * 60); // 7 days\n    const maxSpend = BigInt(parseUnits('10', 18)); // 10 ETH max spend (in wei)\n\n    // Build allowed adapters list (include all configured adapters)\n    const allowedAdapters: `0x${string}`[] = [];\n    if (MOCK_SWAP_ADAPTER_ADDRESS) {\n      allowedAdapters.push(MOCK_SWAP_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (UNISWAP_V3_ADAPTER_ADDRESS) {\n      allowedAdapters.push(UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (WETH_WRAP_ADAPTER_ADDRESS) {\n      allowedAdapters.push(WETH_WRAP_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (ERC20_PULL_ADAPTER_ADDRESS) {\n      allowedAdapters.push(ERC20_PULL_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (PROOF_ADAPTER_ADDRESS) {\n      allowedAdapters.push(PROOF_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (DEMO_LEND_ADAPTER_ADDRESS) {\n      allowedAdapters.push(DEMO_LEND_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n    if (AAVE_ADAPTER_ADDRESS) {\n      allowedAdapters.push(AAVE_ADAPTER_ADDRESS.toLowerCase() as `0x${string}`);\n    }\n\n    if (allowedAdapters.length === 0) {\n      return res.status(400).json({\n        error: 'No adapters configured. At least one adapter must be configured.',\n      });\n    }\n\n    // Encode createSession call\n    const { encodeFunctionData } = await import('viem');\n    const createSessionAbi = [\n      {\n        name: 'createSession',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          { name: 'sessionId', type: 'bytes32' },\n          { name: 'executor', type: 'address' },\n          { name: 'expiresAt', type: 'uint64' },\n          { name: 'maxSpend', type: 'uint256' },\n          { name: 'allowedAdapters', type: 'address[]' },\n        ],\n        outputs: [],\n      },\n    ] as const;\n\n    const data = encodeFunctionData({\n      abi: createSessionAbi,\n      functionName: 'createSession',\n      args: [\n        sessionId as `0x${string}`,\n        executor as `0x${string}`,\n        BigInt(expiresAt),\n        maxSpend,\n        allowedAdapters,\n      ],\n    });\n\n    // DEBUG: Verify sessionId is encoded correctly in data\n    // createSession selector (4 bytes) + sessionId (32 bytes) starts at position 10 (after 0x + 8 hex chars)\n    const encodedSessionId = '0x' + data.slice(10, 74);\n    console.log('[session/prepare] Encoded data sessionId:', encodedSessionId);\n    console.log('[session/prepare] SessionIds match:', sessionId.toLowerCase() === encodedSessionId.toLowerCase());\n\n    // V1: Return capability snapshot (caps, allowlists, approvals, expiresAt)\n    const capabilitySnapshot = {\n      sessionId,\n      caps: {\n        maxSpend: maxSpend.toString(),\n        maxSpendUsd: '10000', // Approximate USD value of 10 ETH\n        expiresAt: expiresAt.toString(),\n        expiresAtIso: new Date(Number(expiresAt) * 1000).toISOString(),\n      },\n      allowlistedAdapters: allowedAdapters,\n      approvals: [], // V1: Router approval handled during session creation\n      expiresAt: Number(expiresAt),\n    };\n\n    // VALIDATION: Ensure transaction fields are present\n    const txTo = EXECUTION_ROUTER_ADDRESS;\n    const txData = data;\n    const txFieldsPresent = {\n      to: !!txTo,\n      data: !!txData,\n      sessionId: !!sessionId,\n    };\n\n    // Safe log: transaction field validation\n    logSessionTrace(correlationId, 'prepare:txBuilt', {\n      txFieldsPresent,\n      toLength: txTo?.length || 0,\n      dataLength: txData?.length || 0,\n    });\n\n    // Return 500 if critical fields are missing (configuration error)\n    if (!txTo || !txData || !sessionId) {\n      const missingFields = [];\n      if (!txTo) missingFields.push('to (EXECUTION_ROUTER_ADDRESS)');\n      if (!txData) missingFields.push('data (encoded function call)');\n      if (!sessionId) missingFields.push('sessionId');\n      \n      logSessionTrace(correlationId, 'prepare:error', {\n        error: 'Missing transaction fields',\n        code: 'MISSING_TX_FIELDS',\n        missingFields,\n      });\n      \n      return res.status(500).json({\n        ok: false,\n        correlationId,\n        error: {\n          code: 'MISSING_TX_FIELDS',\n          message: `Failed to build transaction: missing ${missingFields.join(', ')}`,\n          missingFields,\n        },\n      });\n    }\n\n    // Return enabled:true with exact shape expected by frontend\n    const prepareResponse = {\n      ok: true,\n      status: 'preparing', // Top-level status field for UI\n      session: {\n        enabled: true,\n        sessionId,\n        to: txTo,\n        data: txData,\n        value: '0x0',\n        summary: `Create session for ${userAddress.substring(0, 10)}... with executor ${executor.substring(0, 10)}...`,\n        capabilitySnapshot, // V1: Include capability snapshot\n      },\n      correlationId, // Include correlationId for client tracing\n      cooldownMs: SESSION_COOLDOWN_MS,\n    };\n\n    // Debug logging for contract verification (Task C)\n    if (process.env.DEBUG_RESPONSE === 'true') {\n      const redactedResponse = JSON.parse(JSON.stringify(prepareResponse));\n      // Redact calldata (contains sensitive info)\n      if (redactedResponse.session?.data) {\n        redactedResponse.session.data = redactedResponse.session.data.substring(0, 20) + '...';\n      }\n      console.log('[api/session/prepare] Response JSON:', JSON.stringify(redactedResponse, null, 2));\n    }\n\n    // Trace log: prepare success (no secrets)\n    logSessionTrace(correlationId, 'prepare:ok', { \n      sessionId: sessionId.substring(0, 10) + '...', \n      userAddress: userAddress.substring(0, 10) + '...',\n      expiresAt: expiresAt.toString(), // Convert BigInt to string for JSON\n      txFieldsPresent,\n    });\n\n    res.json(prepareResponse);\n  } catch (error: any) {\n    // Trace log: prepare error with full details (dev only for stack)\n    const errorInfo: Record<string, any> = {\n      error: error.message,\n      code: error.code || 'UNKNOWN',\n      name: error.name,\n    };\n    \n    if (process.env.NODE_ENV !== 'production') {\n      errorInfo.stack = error.stack;\n      errorInfo.cause = error.cause;\n    }\n    \n    logSessionTrace(correlationId, 'prepare:error', errorInfo);\n    \n    // Log full error in dev mode\n    if (process.env.DEBUG_SESSION === 'true' || process.env.NODE_ENV !== 'production') {\n      console.error(`[${correlationId}] [api/session/prepare] Error:`, error);\n    }\n    \n    // Return 500 for unexpected errors (not 200)\n    res.status(500).json({\n      ok: false,\n      correlationId,\n      error: {\n        code: error.code || 'INTERNAL_ERROR',\n        message: error.message || 'Failed to prepare session',\n        ...(process.env.NODE_ENV !== 'production' ? { stack: error.stack } : {}),\n      },\n    });\n  }\n});\n\n/**\n * POST /api/execute/relayed\n * Execute a plan using session permissions (relayed by backend)\n */\napp.post('/api/execute/relayed', maybeCheckAccess, async (req, res) => {\n  console.log('[api/execute/relayed] Handler invoked - DEBUG MARKER V2');\n  const correlationId = req.correlationId || generateCorrelationId();\n  const relayedStartTime = Date.now();\n  \n  // Trace log: relayed start (no secrets)\n  const { sessionId, plan, userAddress } = req.body || {};\n  logExecuteTrace(correlationId, 'relayed:start', {\n    sessionId: sessionId?.substring(0, 10),\n    userAddress: userAddress?.substring(0, 10),\n    planActions: plan?.actions?.length,\n  });\n  \n  try {\n    const { EXECUTION_MODE, EXECUTION_AUTH_MODE, EXECUTION_DISABLED, V1_DEMO } = await import('../config');\n    \n    // V1: Emergency kill switch\n    if (EXECUTION_DISABLED) {\n      return res.status(503).json({\n        error: 'Execution temporarily disabled',\n        errorCode: 'EXECUTION_DISABLED',\n        message: 'Execution has been temporarily disabled. Please try again later.',\n      });\n    }\n    \n    // V1_DEMO: Enforce single-action plans for canonical flows\n    if (V1_DEMO && req.body.plan && req.body.plan.actions && req.body.plan.actions.length !== 1) {\n      return res.status(400).json({\n        error: 'V1_DEMO mode requires single-action plans',\n        errorCode: 'V1_DEMO_MULTI_ACTION_REJECTED',\n        message: `Plan has ${req.body.plan.actions.length} actions. V1_DEMO mode only allows single-action plans.`,\n      });\n    }\n\n    // Check if session is actually enabled (server-side check)\n    let sessionEnabled = false;\n    if (EXECUTION_MODE === 'eth_testnet' && EXECUTION_AUTH_MODE === 'session') {\n      try {\n        // Quick check: verify relayer and router are configured\n        const { RELAYER_PRIVATE_KEY, EXECUTION_ROUTER_ADDRESS, ETH_TESTNET_RPC_URL } = await import('../config');\n        if (RELAYER_PRIVATE_KEY && EXECUTION_ROUTER_ADDRESS && ETH_TESTNET_RPC_URL) {\n          // Optionally verify router has code (quick check with timeout)\n          try {\n            const codeResponse = await Promise.race([\n              fetch(ETH_TESTNET_RPC_URL, {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({\n                  jsonrpc: '2.0',\n                  id: 1,\n                  method: 'eth_getCode',\n                  params: [EXECUTION_ROUTER_ADDRESS, 'latest'],\n                }),\n              }),\n              new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 1000)),\n            ]) as Response;\n            \n            if (codeResponse.ok) {\n              const codeData = await codeResponse.json();\n              const code = codeData.result || '0x';\n              sessionEnabled = code !== '0x' && code.length > 2;\n            }\n          } catch (error: any) {\n            // RPC check failed - treat as disabled\n            sessionEnabled = false;\n          }\n        }\n      } catch (error: any) {\n        // Config check failed - treat as disabled\n        sessionEnabled = false;\n      }\n    }\n\n    // If session is disabled, force direct execution path (return success with notes)\n    if (!sessionEnabled) {\n      const portfolioAfter = buildPortfolioSnapshot();\n      return res.json({\n        success: true,\n        status: 'success',\n        notes: ['session_disabled_fell_back_to_direct'],\n        portfolio: portfolioAfter,\n        chainId: 11155111,\n      });\n    }\n\n    const { draftId, userAddress, plan, sessionId } = req.body;\n\n    if (!draftId || !userAddress || !plan || !sessionId) {\n      // Missing required fields - fall back to direct mode\n      const portfolioAfter = buildPortfolioSnapshot();\n      return res.json({\n        success: true,\n        status: 'success',\n        notes: ['session_disabled_fell_back_to_direct', 'missing_required_fields'],\n        portfolio: portfolioAfter,\n        chainId: 11155111,\n      });\n    }\n\n    // STRICT SERVER-SIDE GUARDS\n    const guardConfig = await import('../config');\n    const EXECUTION_ROUTER_ADDRESS = guardConfig.EXECUTION_ROUTER_ADDRESS;\n    const UNISWAP_V3_ADAPTER_ADDRESS = guardConfig.UNISWAP_V3_ADAPTER_ADDRESS;\n    const WETH_WRAP_ADAPTER_ADDRESS = guardConfig.WETH_WRAP_ADAPTER_ADDRESS;\n    const MOCK_SWAP_ADAPTER_ADDRESS = guardConfig.MOCK_SWAP_ADAPTER_ADDRESS;\n    const REDACTED_ADDRESS_SEPOLIA = guardConfig.REDACTED_ADDRESS_SEPOLIA;\n    const WETH_ADDRESS_SEPOLIA = guardConfig.WETH_ADDRESS_SEPOLIA;\n\n    // Guard 1: Validate action count (max 4 for MVP)\n    if (!plan.actions || !Array.isArray(plan.actions)) {\n      return res.status(400).json({\n        error: 'Plan must have actions array',\n      });\n    }\n    if (plan.actions.length > 4) {\n      return res.status(400).json({\n        error: `Plan exceeds maximum action count (4). Got ${plan.actions.length} actions.`,\n      });\n    }\n    if (plan.actions.length === 0) {\n      return res.status(400).json({\n        error: 'Plan must have at least one action',\n      });\n    }\n\n    // Guard 2: Validate allowed adapters only (reuse UNISWAP_V3_ADAPTER_ADDRESS, WETH_WRAP_ADAPTER_ADDRESS, MOCK_SWAP_ADAPTER_ADDRESS from above)\n    const adapterConfig = await import('../config');\n    const PROOF_ADAPTER_ADDRESS = adapterConfig.PROOF_ADAPTER_ADDRESS;\n    const ERC20_PULL_ADAPTER_ADDRESS = adapterConfig.ERC20_PULL_ADAPTER_ADDRESS;\n    const DEMO_LEND_ADAPTER_ADDRESS = adapterConfig.DEMO_LEND_ADAPTER_ADDRESS;\n    const AAVE_ADAPTER_ADDRESS_RELAYED = adapterConfig.AAVE_ADAPTER_ADDRESS;\n    \n    const allowedAdapters = new Set<string>();\n    if (UNISWAP_V3_ADAPTER_ADDRESS) {\n      allowedAdapters.add(UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (WETH_WRAP_ADAPTER_ADDRESS) {\n      allowedAdapters.add(WETH_WRAP_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (MOCK_SWAP_ADAPTER_ADDRESS) {\n      allowedAdapters.add(MOCK_SWAP_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (PROOF_ADAPTER_ADDRESS) {\n      allowedAdapters.add(PROOF_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (ERC20_PULL_ADAPTER_ADDRESS) {\n      allowedAdapters.add(ERC20_PULL_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (DEMO_LEND_ADAPTER_ADDRESS) {\n      allowedAdapters.add(DEMO_LEND_ADAPTER_ADDRESS.toLowerCase());\n    }\n    if (AAVE_ADAPTER_ADDRESS_RELAYED) {\n      allowedAdapters.add(AAVE_ADAPTER_ADDRESS_RELAYED.toLowerCase());\n    }\n\n    for (const action of plan.actions) {\n      const adapter = action.adapter?.toLowerCase();\n      if (!adapter) {\n        return res.status(400).json({\n          ok: false,\n          error: {\n            code: 'ADAPTER_MISSING',\n            message: 'Action missing adapter address',\n          },\n          correlationId,\n        });\n      }\n      if (!allowedAdapters.has(adapter)) {\n        return res.status(400).json({\n          ok: false,\n          error: {\n            code: 'ADAPTER_NOT_ALLOWED',\n            adapter,\n            allowedAdapters: Array.from(allowedAdapters),\n            message: `Adapter ${adapter} not allowed. Allowed adapters: ${Array.from(allowedAdapters).join(', ')}`,\n          },\n          correlationId,\n        });\n      }\n    }\n\n    // Guard 3: Validate deadline (must be <= 10 minutes from now)\n    const now = Math.floor(Date.now() / 1000);\n    const deadline = parseInt(plan.deadline);\n    const maxDeadline = now + 10 * 60; // 10 minutes\n    if (deadline > maxDeadline) {\n      return res.status(400).json({\n        error: `Plan deadline too far in future. Maximum: ${maxDeadline} (10 minutes), got: ${deadline}`,\n      });\n    }\n    if (deadline <= now) {\n      return res.status(400).json({\n        error: 'Plan deadline must be in the future',\n      });\n    }\n\n    // Guard 4: Validate token allowlist (ETH/WETH/REDACTED only for MVP)\n    // Include both standard Sepolia tokens AND Aave-specific tokens\n    const { AAVE_REDACTED_ADDRESS, AAVE_WETH_ADDRESS } = await import('../config');\n    const allowedTokens = new Set<string>();\n    if (WETH_ADDRESS_SEPOLIA) {\n      allowedTokens.add(WETH_ADDRESS_SEPOLIA.toLowerCase());\n    }\n    if (REDACTED_ADDRESS_SEPOLIA) {\n      allowedTokens.add(REDACTED_ADDRESS_SEPOLIA.toLowerCase());\n    }\n    // Add Aave-specific tokens for lending\n    if (AAVE_REDACTED_ADDRESS) {\n      allowedTokens.add(AAVE_REDACTED_ADDRESS.toLowerCase());\n    }\n    if (AAVE_WETH_ADDRESS) {\n      allowedTokens.add(AAVE_WETH_ADDRESS.toLowerCase());\n    }\n\n    // Decode actions to check tokens\n    const { decodeAbiParameters, parseUnits } = await import('viem');\n    for (const action of plan.actions) {\n      if (action.actionType === 0) {\n        // SWAP action - decode to check tokens\n        try {\n          const decoded = decodeAbiParameters(\n            [\n              { type: 'address' }, // tokenIn\n              { type: 'address' }, // tokenOut\n              { type: 'uint24' }, // fee\n              { type: 'uint256' }, // amountIn\n              { type: 'uint256' }, // amountOutMin\n              { type: 'address' }, // recipient\n              { type: 'uint256' }, // deadline\n            ],\n            action.data as `0x${string}`\n          );\n          const tokenIn = decoded[0].toLowerCase();\n          const tokenOut = decoded[1].toLowerCase();\n          \n          if (!allowedTokens.has(tokenIn)) {\n            return res.status(400).json({\n              error: `Token ${tokenIn} not allowed. Allowed tokens: ${Array.from(allowedTokens).join(', ')}`,\n            });\n          }\n          if (!allowedTokens.has(tokenOut)) {\n            return res.status(400).json({\n              error: `Token ${tokenOut} not allowed. Allowed tokens: ${Array.from(allowedTokens).join(', ')}`,\n            });\n          }\n\n          // Guard 5: Validate max amountIn per swap (e.g. 1 ETH worth)\n          const amountIn = decoded[3];\n          const maxAmountIn = BigInt(parseUnits('1', 18)); // 1 ETH max per swap\n          if (amountIn > maxAmountIn) {\n            return res.status(400).json({\n              error: `Swap amountIn exceeds maximum (1 ETH). Got ${amountIn.toString()}`,\n            });\n          }\n        } catch (error: any) {\n          // If decode fails, might be session mode wrapped data - skip token validation\n          console.warn('[api/execute/relayed] Could not decode swap action, skipping token validation:', error.message);\n        }\n      }\n    }\n\n    // Guard 6: Validate value (max 1 ETH for WRAP actions)\n    const planValue = BigInt(req.body.value || '0x0');\n    const maxValue = BigInt(parseUnits('1', 18)); // 1 ETH max\n    if (planValue > maxValue) {\n      return res.status(400).json({\n        ok: false,\n        error: {\n          code: 'POLICY_EXCEEDED',\n          message: `Plan value exceeds maximum (1 ETH). Got ${planValue.toString()}`,\n        },\n        correlationId,\n      });\n    }\n\n    // SPRINT 2: Session Authority Policy Enforcement\n    const validateOnly = req.query?.validateOnly === 'true' || req.body?.validateOnly === true;\n    \n    // Helper to get session status from on-chain\n    const getSessionStatusFromChain = async (sessionId: string): Promise<{\n      active: boolean;\n      owner: string;\n      executor: string;\n      expiresAt: bigint;\n      maxSpend: bigint;\n      spent: bigint;\n      status: 'active' | 'expired' | 'revoked' | 'not_created';\n    } | null> => {\n      try {\n        const { ETH_TESTNET_RPC_URL, EXECUTION_ROUTER_ADDRESS } = await import('../config');\n        if (!ETH_TESTNET_RPC_URL || !EXECUTION_ROUTER_ADDRESS) {\n          return null;\n        }\n\n        const { createPublicClient, http } = await import('viem');\n        const { sepolia } = await import('viem/chains');\n        const publicClient = createPublicClient({\n          chain: sepolia,\n          transport: http(ETH_TESTNET_RPC_URL),\n        });\n\n        const normalizedSessionId = sessionId.startsWith('0x') ? sessionId : `0x${sessionId}`;\n        const sessionAbi = [\n          {\n            name: 'sessions',\n            type: 'function',\n            stateMutability: 'view',\n            inputs: [{ name: '', type: 'bytes32' }],\n            outputs: [\n              { name: 'owner', type: 'address' },\n              { name: 'executor', type: 'address' },\n              { name: 'expiresAt', type: 'uint64' },\n              { name: 'maxSpend', type: 'uint256' },\n              { name: 'spent', type: 'uint256' },\n              { name: 'active', type: 'bool' },\n            ],\n          },\n        ] as const;\n\n        const sessionResult = await Promise.race([\n          publicClient.readContract({\n            address: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n            abi: sessionAbi,\n            functionName: 'sessions',\n            args: [normalizedSessionId as `0x${string}`],\n          }),\n          new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000)),\n        ]) as any;\n\n        const owner = sessionResult[0];\n        const executor = sessionResult[1];\n        const expiresAt = sessionResult[2];\n        const maxSpend = sessionResult[3];\n        const spent = sessionResult[4];\n        const active = sessionResult[5];\n\n        const now = BigInt(Math.floor(Date.now() / 1000));\n        let status: 'active' | 'expired' | 'revoked' | 'not_created' = 'not_created';\n\n        if (active) {\n          if (expiresAt > now) {\n            status = 'active';\n          } else {\n            status = 'expired';\n          }\n        } else if (owner !== '0x0000000000000000000000000000000000000000') {\n          status = 'revoked';\n        }\n\n        return {\n          active: status === 'active',\n          owner,\n          executor,\n          expiresAt,\n          maxSpend,\n          spent,\n          status,\n        };\n      } catch (error) {\n        return null;\n      }\n    };\n\n    // Evaluate SessionPolicy\n    const { evaluateSessionPolicy, estimatePlanSpend } = await import('./sessionPolicy');\n    \n    // DEV-ONLY: Allow policyOverride in validateOnly mode for testing\n    let policyOverride: { maxSpendUnits?: string; skipSessionCheck?: boolean } | undefined;\n    if (validateOnly && (process.env.NODE_ENV !== 'production' || process.env.DEV === 'true')) {\n      policyOverride = req.body.policyOverride;\n      // If maxSpendUnits is provided, also skip session check to test spend limits directly\n      if (policyOverride?.maxSpendUnits) {\n        policyOverride.skipSessionCheck = true;\n      }\n    }\n    \n    const policyResult = await evaluateSessionPolicy(\n      sessionId,\n      userAddress,\n      plan,\n      allowedAdapters,\n      getSessionStatusFromChain,\n      policyOverride\n    );\n\n    // Log policy evaluation for dev diagnostics\n    const spendEstimate = await estimatePlanSpend(plan);\n    \n    // Determine instrument type from plan actions\n    let instrumentType: 'swap' | 'perp' | 'defi' | 'event' | undefined;\n    if (plan.actions.length > 0) {\n      const firstAction = plan.actions[0];\n      if (firstAction.actionType === 0) instrumentType = 'swap';\n      else if (firstAction.actionType === 6) instrumentType = 'perp'; // PROOF could be perp or event\n      else if (firstAction.actionType === 2) instrumentType = 'swap'; // PULL is usually for swaps\n    }\n    instrumentType = instrumentType || spendEstimate.instrumentType;\n\n    if (process.env.NODE_ENV !== 'production') {\n      logExecuteTrace(correlationId, 'policy:evaluated', {\n        allowed: policyResult.allowed,\n        code: policyResult.code,\n        spendWei: spendEstimate.spendWei.toString(),\n        determinable: spendEstimate.determinable,\n        instrumentType,\n      });\n    }\n\n    if (!policyResult.allowed) {\n      // Log failed attempt\n      if (process.env.NODE_ENV !== 'production') {\n        addRelayedAttempt({\n          correlationId,\n          timestamp: Date.now(),\n          userAddress,\n          sessionId,\n          adapter: plan.actions[0]?.adapter || 'unknown',\n          instrumentType,\n          spendAttempted: spendEstimate.spendWei.toString(),\n          result: 'failed',\n          errorCode: policyResult.code,\n        });\n      }\n\n      // Policy check failed - return structured error\n      // Ensure consistent error format for validateOnly and normal execution\n      const errorResponse = {\n        ok: false,\n        correlationId,\n        error: {\n          code: policyResult.code || 'POLICY_FAILED',\n          message: policyResult.message || 'Session policy check failed',\n          ...(policyResult.details || {}),\n        },\n      };\n      \n      // Include correlationId in response header\n      res.setHeader('x-correlation-id', correlationId);\n      return res.status(400).json(errorResponse);\n    }\n\n    // If validateOnly mode, return success without submitting transaction\n    if (validateOnly) {\n      // Log validateOnly attempt\n      if (process.env.NODE_ENV !== 'production') {\n        addRelayedAttempt({\n          correlationId,\n          timestamp: Date.now(),\n          userAddress,\n          sessionId,\n          adapter: plan.actions[0]?.adapter || 'unknown',\n          instrumentType,\n          spendAttempted: spendEstimate.spendWei.toString(),\n          result: 'ok',\n        });\n      }\n\n      return res.json({\n        ok: true,\n        wouldAllow: true,\n        correlationId,\n        policy: {\n          sessionStatus: 'active',\n          spendEstimate: {\n            spendWei: spendEstimate.spendWei.toString(),\n            determinable: spendEstimate.determinable,\n            instrumentType,\n          },\n        },\n        note: 'validateOnly mode: policy check passed, transaction not submitted',\n      });\n    }\n\n    console.log('[api/execute/relayed] Policy passed, importing relayer...');\n    const { sendRelayedTx } = await import('../executors/relayer');\n    console.log('[api/execute/relayed] Relayer imported, importing viem...');\n\n    // Encode executeWithSession call\n    const { encodeFunctionData } = await import('viem');\n    console.log('[api/execute/relayed] Viem imported, encoding function data...');\n    const executeWithSessionAbi = [\n      {\n        name: 'executeWithSession',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          { name: 'sessionId', type: 'bytes32' },\n          {\n            name: 'plan',\n            type: 'tuple',\n            components: [\n              { name: 'user', type: 'address' },\n              { name: 'nonce', type: 'uint256' },\n              { name: 'deadline', type: 'uint256' },\n              {\n                name: 'actions',\n                type: 'tuple[]',\n                components: [\n                  { name: 'actionType', type: 'uint8' },\n                  { name: 'adapter', type: 'address' },\n                  { name: 'data', type: 'bytes' },\n                ],\n              },\n            ],\n          },\n        ],\n        outputs: [],\n      },\n    ] as const;\n\n    // Debug: log plan values before encoding\n    console.log('[api/execute/relayed] Plan values:', {\n      user: plan.user,\n      nonce: plan.nonce,\n      nonceType: typeof plan.nonce,\n      deadline: plan.deadline,\n      deadlineType: typeof plan.deadline,\n      actionsCount: plan.actions?.length,\n    });\n\n    // Validate plan fields before BigInt conversion\n    if (plan.nonce === undefined || plan.nonce === null) {\n      return res.status(400).json({\n        error: 'Plan nonce is required',\n        errorCode: 'INVALID_PLAN',\n        details: { nonce: plan.nonce, deadline: plan.deadline },\n      });\n    }\n    if (plan.deadline === undefined || plan.deadline === null) {\n      return res.status(400).json({\n        error: 'Plan deadline is required',\n        errorCode: 'INVALID_PLAN',\n        details: { nonce: plan.nonce, deadline: plan.deadline },\n      });\n    }\n    if (!plan.user) {\n      return res.status(400).json({\n        error: 'Plan user is required',\n        errorCode: 'INVALID_PLAN',\n        details: { user: plan.user },\n      });\n    }\n    if (!Array.isArray(plan.actions) || plan.actions.length === 0) {\n      return res.status(400).json({\n        error: 'Plan actions array is required and must not be empty',\n        errorCode: 'INVALID_PLAN',\n        details: { actions: plan.actions },\n      });\n    }\n    // Validate each action has required fields\n    for (let i = 0; i < plan.actions.length; i++) {\n      const action = plan.actions[i];\n      if (action.actionType === undefined || action.actionType === null) {\n        return res.status(400).json({\n          error: `Action ${i} missing actionType`,\n          errorCode: 'INVALID_PLAN',\n          details: { actionIndex: i, action },\n        });\n      }\n      if (!action.adapter) {\n        return res.status(400).json({\n          error: `Action ${i} missing adapter address`,\n          errorCode: 'INVALID_PLAN',\n          details: { actionIndex: i, action },\n        });\n      }\n      if (!action.data) {\n        return res.status(400).json({\n          error: `Action ${i} missing data`,\n          errorCode: 'INVALID_PLAN',\n          details: { actionIndex: i, action },\n        });\n      }\n    }\n\n    // Debug: log each action before encoding\n    console.log('[api/execute/relayed] Actions before encoding:');\n    for (let i = 0; i < plan.actions.length; i++) {\n      const a = plan.actions[i];\n      console.log(`  Action ${i}:`, {\n        actionType: a.actionType,\n        actionTypeType: typeof a.actionType,\n        adapter: a.adapter?.slice(0, 15) + '...',\n        adapterType: typeof a.adapter,\n        dataLen: a.data?.length,\n        dataType: typeof a.data,\n      });\n    }\n\n    let data: string;\n    try {\n      data = encodeFunctionData({\n        abi: executeWithSessionAbi,\n        functionName: 'executeWithSession',\n        args: [\n          sessionId as `0x${string}`,\n          {\n            user: plan.user as `0x${string}`,\n            nonce: BigInt(plan.nonce),\n            deadline: BigInt(plan.deadline),\n            actions: plan.actions.map((a: any) => ({\n              actionType: a.actionType,\n              adapter: a.adapter as `0x${string}`,\n              data: a.data as `0x${string}`,\n            })),\n          },\n        ],\n      });\n      console.log('[api/execute/relayed] encodeFunctionData SUCCESS, dataLen:', data.length);\n    } catch (encodeErr: any) {\n      console.error('[api/execute/relayed] encodeFunctionData FAILED:', encodeErr.message);\n      console.error('[api/execute/relayed] Full plan.actions:', JSON.stringify(plan.actions, null, 2));\n      throw encodeErr;\n    }\n\n    // Get portfolio before execution\n    const portfolioBefore = buildPortfolioSnapshot();\n\n    // V1: Compute planHash server-side (keccak256(abi.encode(plan)))\n    const { keccak256, encodeAbiParameters } = await import('viem');\n    let planHash: string;\n    try {\n      planHash = keccak256(\n        encodeAbiParameters(\n          [\n            { name: 'user', type: 'address' },\n            { name: 'nonce', type: 'uint256' },\n            { name: 'deadline', type: 'uint256' },\n            {\n              name: 'actions',\n              type: 'tuple[]',\n              components: [\n                { name: 'actionType', type: 'uint8' },\n                { name: 'adapter', type: 'address' },\n                { name: 'data', type: 'bytes' },\n              ],\n            },\n          ],\n          [\n            plan.user as `0x${string}`,\n            BigInt(plan.nonce),\n            BigInt(plan.deadline),\n            plan.actions.map((a: any) => ({\n              actionType: a.actionType,\n              adapter: a.adapter as `0x${string}`,\n              data: a.data as `0x${string}`,\n            })),\n          ]\n        )\n      );\n      console.log('[api/execute/relayed] planHash computed:', planHash.slice(0, 20) + '...');\n    } catch (hashErr: any) {\n      console.error('[api/execute/relayed] planHash FAILED:', hashErr.message);\n      throw hashErr;\n    }\n\n    // Send relayed transaction\n    const txHash = await sendRelayedTx({\n      to: EXECUTION_ROUTER_ADDRESS!,\n      data,\n      value: req.body.value || '0x0',\n    });\n\n    // Log successful attempt (before receipt confirmation)\n    if (process.env.NODE_ENV !== 'production') {\n      addRelayedAttempt({\n        correlationId,\n        timestamp: Date.now(),\n        userAddress,\n        sessionId,\n        adapter: plan.actions[0]?.adapter || 'unknown',\n        instrumentType: spendEstimate.instrumentType,\n        spendAttempted: spendEstimate.spendWei.toString(),\n        result: 'ok',\n        txHash,\n      });\n    }\n\n    // V1: Wait for receipt confirmation (receipt.status === 1)\n    const { ETH_TESTNET_RPC_URL } = await import('../config');\n    let receiptStatus: 'confirmed' | 'failed' | 'timeout' | 'pending' = 'pending';\n    let blockNumber: number | undefined;\n    let receiptError: string | undefined;\n\n    if (ETH_TESTNET_RPC_URL) {\n      const { waitForReceipt } = await import('../executors/evmReceipt');\n      const receiptResult = await waitForReceipt(ETH_TESTNET_RPC_URL, txHash, {\n        timeoutMs: 60000,\n        pollMs: 2000,\n      });\n\n      receiptStatus = receiptResult.status;\n      blockNumber = receiptResult.blockNumber;\n      receiptError = receiptResult.error;\n    }\n\n    // V1: Only update portfolio if receipt.status === 1 (confirmed)\n    const portfolioAfter = receiptStatus === 'confirmed' \n      ? buildPortfolioSnapshot()\n      : portfolioBefore;\n\n    const result: ExecutionResult & { receiptStatus?: string; blockNumber?: number; planHash?: string } = {\n      success: receiptStatus === 'confirmed',\n      status: receiptStatus === 'confirmed' ? 'success' : 'failed',\n      txHash,\n      receiptStatus,\n      blockNumber,\n      planHash, // V1: Include server-computed planHash\n      error: receiptError,\n      portfolioDelta: {\n        accountValueDeltaUsd: portfolioAfter.accountValueUsd - portfolioBefore.accountValueUsd,\n        balanceDeltas: portfolioAfter.balances.map(b => {\n          const before = portfolioBefore.balances.find(b2 => b2.symbol === b.symbol);\n          return {\n            symbol: b.symbol,\n            deltaUsd: b.balanceUsd - (before?.balanceUsd || 0),\n          };\n        }),\n      },\n      portfolio: portfolioAfter,\n    };\n\n    // Log execution artifact\n    if (process.env.DEBUG_EXECUTIONS === '1') {\n      logExecutionArtifact({\n        executionRequest: null, // Not available in relayed endpoint\n        plan: req.body.plan,\n        executionResult: result,\n        userAddress: req.body.userAddress,\n        draftId: req.body.draftId,\n      });\n    }\n\n    // Telemetry: log relayed tx\n    const actionTypes = req.body.plan?.actions?.map((a: any) => a.actionType) || [];\n    logEvent('relayed_tx', {\n      draftId: req.body.draftId,\n      userHash: req.body.userAddress ? hashAddress(req.body.userAddress) : undefined,\n      txHash,\n      actionTypes,\n      authMode: 'session',\n      latencyMs: Date.now() - relayedStartTime,\n      success: true,\n    });\n\n    // Trace log: relayed success\n    logExecuteTrace(correlationId, 'relayed:ok', {\n      txHash,\n      actionTypes,\n      latencyMs: Date.now() - relayedStartTime,\n    });\n\n    // Task 4: Add execution path proof\n    // Task 4: Add execution path proof\n    res.json({\n      ...result,\n      chainId: 11155111, // Sepolia\n      explorerUrl: `https://sepolia.etherscan.io/tx/${txHash}`,\n      correlationId, // Include correlationId for client tracing\n      notes: ['execution_path:relayed'], // Task 4: Unambiguous evidence of execution path\n    });\n  } catch (error: any) {\n    console.error('[api/execute/relayed] Error:', error);\n    \n    // Trace log: relayed error\n    logExecuteTrace(correlationId, 'relayed:error', {\n      error: error.message,\n      latencyMs: Date.now() - relayedStartTime,\n    });\n    \n    // Determine error code for UI handling\n    let errorCode = 'RELAYER_FAILED';\n    if (error.message?.includes('session') || error.message?.includes('Session')) {\n      errorCode = 'SESSION_EXPIRED';\n    } else if (error.message?.includes('insufficient') || error.message?.includes('balance')) {\n      errorCode = 'INSUFFICIENT_BALANCE';\n    } else if (error.message?.includes('slippage') || error.message?.includes('amountOutMin')) {\n      errorCode = 'SLIPPAGE_FAILURE';\n    }\n\n    // Log failed attempt\n    if (process.env.NODE_ENV !== 'production' && req.body.plan) {\n      try {\n        const { estimatePlanSpend } = await import('./sessionPolicy');\n        const spendEstimate = await estimatePlanSpend(req.body.plan);\n        addRelayedAttempt({\n          correlationId,\n          timestamp: Date.now(),\n          userAddress: req.body.userAddress || 'unknown',\n          sessionId: req.body.sessionId || 'unknown',\n          adapter: req.body.plan.actions?.[0]?.adapter || 'unknown',\n          instrumentType: spendEstimate.instrumentType,\n          spendAttempted: spendEstimate.spendWei.toString(),\n          result: 'failed',\n          errorCode,\n        });\n      } catch (logError) {\n        // Ignore logging errors\n      }\n    }\n\n    const portfolioAfter = buildPortfolioSnapshot();\n    const result: ExecutionResult = {\n      success: false,\n      status: 'failed',\n      error: error.message || 'Failed to execute relayed transaction',\n      portfolio: portfolioAfter,\n    };\n\n    // Log failed execution artifact\n    if (process.env.DEBUG_EXECUTIONS === '1') {\n      logExecutionArtifact({\n        executionRequest: null,\n        plan: req.body.plan,\n        executionResult: result,\n        userAddress: req.body.userAddress,\n        draftId: req.body.draftId,\n      });\n    }\n\n    res.status(500).json({\n      ...result,\n      errorCode,\n      correlationId, // Include correlationId in error response\n    });\n  }\n});\n\n/**\n * GET /api/session/status\n * Get session status (for feature detection and direct mode compatibility)\n * NEVER returns 400 - always returns 200 with enabled:false if not configured\n */\napp.get('/api/session/status', async (req, res) => {\n  const correlationId = req.correlationId || generateCorrelationId();\n  \n  try {\n    const { EXECUTION_MODE, EXECUTION_AUTH_MODE } = await import('../config');\n    // Accept both query and body params\n    const userAddress = req.query?.userAddress || req.body?.userAddress;\n    const sessionId = req.query?.sessionId || req.body?.sessionId;\n\n    // Check cooldown\n    const cooldownKey = `status-${userAddress || 'empty'}-${sessionId || 'empty'}`;\n    const inCooldown = !checkSessionCooldown(cooldownKey);\n    if (inCooldown && process.env.DEBUG_SESSION !== 'true') {\n      // Skip logging if in cooldown\n    } else if (process.env.DEBUG_SESSION === 'true') {\n      console.log('[api/session/status] GET request:', { userAddress, sessionId, EXECUTION_MODE, EXECUTION_AUTH_MODE });\n    }\n\n    // In direct mode or sim mode, return enabled: false\n    if (EXECUTION_MODE !== 'eth_testnet' || EXECUTION_AUTH_MODE !== 'session') {\n      return res.json({\n        ok: true,\n        status: 'disabled', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'NOT_CONFIGURED',\n          required: ['EXECUTION_MODE=eth_testnet', 'EXECUTION_AUTH_MODE=session'],\n        },\n        mode: EXECUTION_AUTH_MODE || 'direct',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // If no sessionId provided, return enabled:false (no valid session exists)\n    if (!sessionId || typeof sessionId !== 'string') {\n      return res.json({\n        ok: true,\n        status: 'not_created', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'MISSING_FIELDS',\n          required: ['sessionId'],\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // VALIDATION: Ensure sessionId is valid bytes32 format (0x + 64 hex chars = 66 total)\n    const normalizedSessionId = sessionId.startsWith('0x') ? sessionId : `0x${sessionId}`;\n    if (normalizedSessionId.length !== 66) {\n      logSessionTrace(correlationId, 'status:error', {\n        error: 'Invalid sessionId format',\n        sessionIdLength: normalizedSessionId.length,\n        expectedLength: 66,\n        sessionId: normalizedSessionId.substring(0, 20) + '...',\n      });\n      return res.json({\n        ok: true,\n        status: 'not_created',\n        session: {\n          enabled: false,\n          reason: 'INVALID_SESSION_ID_FORMAT',\n          message: `sessionId must be bytes32 (0x + 64 hex chars, got ${normalizedSessionId.length} chars)`,\n        },\n        mode: 'session',\n        correlationId,\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // Check for active session on-chain (only if sessionId provided)\n    const { EXECUTION_ROUTER_ADDRESS, ETH_TESTNET_RPC_URL } = await import('../config');\n    \n    if (!ETH_TESTNET_RPC_URL || !EXECUTION_ROUTER_ADDRESS) {\n      return res.json({\n        ok: true,\n        status: 'disabled', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'NOT_CONFIGURED',\n          required: ['ETH_TESTNET_RPC_URL', 'EXECUTION_ROUTER_ADDRESS'],\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    try {\n      // Read session from contract (with timeout)\n      const { createPublicClient, http } = await import('viem');\n      const { sepolia } = await import('viem/chains');\n      const publicClient = createPublicClient({\n        chain: sepolia,\n        transport: http(ETH_TESTNET_RPC_URL),\n      });\n\n      // DEV-ONLY: Log router + chain diagnostics\n      if (process.env.NODE_ENV !== 'production') {\n        try {\n          const chainId = await publicClient.getChainId();\n          const routerCode = await publicClient.getBytecode({ address: EXECUTION_ROUTER_ADDRESS as `0x${string}` });\n          const routerIsContract = routerCode && routerCode !== '0x' && routerCode.length > 2;\n          \n          logSessionTrace(correlationId, 'status:diagnostics', {\n            chainId,\n            routerAddress: EXECUTION_ROUTER_ADDRESS,\n            routerIsContract,\n            routerCodeLength: routerCode?.length || 0,\n            sessionId: sessionId.substring(0, 10) + '...',\n          });\n        } catch (diagError: any) {\n          // Ignore diagnostic errors\n        }\n      }\n\n      const sessionAbi = [\n        {\n          name: 'sessions',\n          type: 'function',\n          stateMutability: 'view',\n          inputs: [{ name: '', type: 'bytes32' }],\n          outputs: [\n            { name: 'owner', type: 'address' },\n            { name: 'executor', type: 'address' },\n            { name: 'expiresAt', type: 'uint64' },\n            { name: 'maxSpend', type: 'uint256' },\n            { name: 'spent', type: 'uint256' },\n            { name: 'active', type: 'bool' },\n          ],\n        },\n      ] as const;\n\n      // DEV-ONLY: Log sessionId being queried\n      if (process.env.NODE_ENV !== 'production') {\n        logSessionTrace(correlationId, 'status:querying', {\n          sessionId: sessionId.substring(0, 10) + '...',\n          sessionIdLength: sessionId.length,\n          routerAddress: EXECUTION_ROUTER_ADDRESS,\n        });\n      }\n\n      const sessionResult = await Promise.race([\n        publicClient.readContract({\n          address: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n          abi: sessionAbi,\n          functionName: 'sessions',\n          args: [normalizedSessionId as `0x${string}`],\n        }),\n        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000)),\n      ]) as any;\n\n      // Contract returns array, not object: [owner, executor, expiresAt, maxSpend, spent, active]\n      const owner = sessionResult[0];\n      const executor = sessionResult[1];\n      const expiresAt = sessionResult[2];\n      const maxSpend = sessionResult[3];\n      const spent = sessionResult[4];\n      const active = sessionResult[5];\n\n      // DEV-ONLY: Log query result\n      if (process.env.NODE_ENV !== 'production') {\n        logSessionTrace(correlationId, 'status:queryResult', {\n          active: active || false,\n          owner: owner?.substring(0, 10) + '...' || 'none',\n          expiresAt: expiresAt?.toString() || 'none',\n        });\n      }\n\n      const now = BigInt(Math.floor(Date.now() / 1000));\n      let status: 'not_created' | 'active' | 'expired' | 'revoked' = 'not_created';\n\n      if (active) {\n        if (expiresAt > now) {\n          status = 'active';\n        } else {\n          status = 'expired';\n        }\n      } else if (owner !== '0x0000000000000000000000000000000000000000') {\n        status = 'revoked';\n      }\n\n      // Only return enabled:true if session is active\n      const statusResponse = {\n        ok: true,\n        status, // Top-level status field for UI (matches session.status)\n        session: {\n          enabled: status === 'active',\n          status,\n          sessionId,\n          owner,\n          executor,\n          expiresAt: expiresAt.toString(),\n          maxSpend: maxSpend.toString(),\n          spent: spent.toString(),\n          active,\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      };\n\n      // Debug logging for contract verification (Task C)\n      if (process.env.DEBUG_RESPONSE === 'true') {\n        console.log('[api/session/status] GET Response JSON:', JSON.stringify(statusResponse, null, 2));\n      }\n\n      return res.json(statusResponse);\n    } catch (error: any) {\n      // RPC error or timeout - return enabled:false\n      if (process.env.DEBUG_SESSION === 'true') {\n        console.warn('[api/session/status] RPC check failed:', error.message);\n      }\n      const errorResponse = {\n        ok: true,\n        status: 'not_created', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: error.message?.includes('timeout') ? 'RPC_ERROR' : 'MISSING_FIELDS',\n          required: error.message?.includes('timeout') ? ['RPC_OK'] : ['sessionId'],\n        },\n        mode: 'session',\n        errorCode: error.message?.includes('timeout') ? 'RPC_ERROR' : undefined,\n        cooldownMs: SESSION_COOLDOWN_MS,\n      };\n\n      // Debug logging for contract verification (Task C)\n      if (process.env.DEBUG_RESPONSE === 'true') {\n        console.log('[api/session/status] GET Error Response JSON:', JSON.stringify(errorResponse, null, 2));\n      }\n\n      return res.json(errorResponse);\n    }\n  } catch (error: any) {\n    // Never throw - always return 200\n    if (process.env.DEBUG_SESSION === 'true') {\n      console.error('[api/session/status] Error:', error);\n    }\n    res.json({\n      ok: true,\n      status: 'disabled', // Top-level status field for UI\n      session: {\n        enabled: false,\n        reason: 'RPC_ERROR',\n        required: ['RPC_OK'],\n      },\n      errorCode: 'RPC_ERROR',\n      cooldownMs: SESSION_COOLDOWN_MS,\n    });\n  }\n});\n\n/**\n * POST /api/session/status\n * Get detailed session status (active/expired/revoked)\n * NEVER returns 400 - always returns 200 with enabled:false if not configured\n * This is an alias for GET /api/session/status (same logic)\n */\napp.post('/api/session/status', async (req, res) => {\n  // Delegate to GET handler logic (same behavior)\n  try {\n    const { EXECUTION_MODE, EXECUTION_AUTH_MODE } = await import('../config');\n    // Accept both body and query params\n    const userAddress = req.body?.userAddress || req.query?.userAddress;\n    const sessionId = req.body?.sessionId || req.query?.sessionId;\n\n    // Check cooldown\n    const cooldownKey = `status-${userAddress || 'empty'}-${sessionId || 'empty'}`;\n    const inCooldown = !checkSessionCooldown(cooldownKey);\n    if (inCooldown && process.env.DEBUG_SESSION !== 'true') {\n      // Skip logging if in cooldown\n    } else if (process.env.DEBUG_SESSION === 'true') {\n      console.log('[api/session/status] POST request:', { userAddress, sessionId, EXECUTION_MODE, EXECUTION_AUTH_MODE });\n    }\n\n    // Task D: Check if session mode is properly configured (POST handler)\n    const { RELAYER_PRIVATE_KEY: RELAYER_PRIVATE_KEY_POST, EXECUTION_ROUTER_ADDRESS: EXECUTION_ROUTER_ADDRESS_POST, ETH_TESTNET_RPC_URL: ETH_TESTNET_RPC_URL_POST } = await import('../config');\n    const isSessionModeConfiguredPost = EXECUTION_MODE === 'eth_testnet' && EXECUTION_AUTH_MODE === 'session';\n    const hasRequiredConfigPost = !!(RELAYER_PRIVATE_KEY_POST && EXECUTION_ROUTER_ADDRESS_POST && ETH_TESTNET_RPC_URL_POST);\n    \n    // In direct mode or sim mode, return enabled: false\n    if (!isSessionModeConfiguredPost || !hasRequiredConfigPost) {\n      const missing: string[] = [];\n      if (!RELAYER_PRIVATE_KEY_POST) missing.push('RELAYER_PRIVATE_KEY');\n      if (!EXECUTION_ROUTER_ADDRESS_POST) missing.push('EXECUTION_ROUTER_ADDRESS');\n      if (!ETH_TESTNET_RPC_URL_POST) missing.push('ETH_TESTNET_RPC_URL');\n      \n      return res.json({\n        ok: true,\n        status: 'disabled', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: !isSessionModeConfiguredPost ? 'NOT_CONFIGURED' : 'MISSING_CONFIG',\n          required: !isSessionModeConfiguredPost \n            ? ['EXECUTION_MODE=eth_testnet', 'EXECUTION_AUTH_MODE=session']\n            : missing,\n        },\n        mode: EXECUTION_AUTH_MODE || 'direct',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // If no sessionId provided, return enabled:false\n    if (!sessionId || typeof sessionId !== 'string') {\n      return res.json({\n        ok: true,\n        status: 'not_created', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'MISSING_FIELDS',\n          required: ['sessionId'],\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    // VALIDATION: Ensure sessionId is valid bytes32 format (0x + 64 hex chars = 66 total)\n    const normalizedSessionId = sessionId.startsWith('0x') ? sessionId : `0x${sessionId}`;\n    if (normalizedSessionId.length !== 66) {\n      const correlationId = req.correlationId || 'unknown';\n      logSessionTrace(correlationId, 'status:error', {\n        error: 'Invalid sessionId format',\n        sessionIdLength: normalizedSessionId.length,\n        expectedLength: 66,\n        sessionId: normalizedSessionId.substring(0, 20) + '...',\n      });\n      return res.json({\n        ok: true,\n        status: 'not_created',\n        session: {\n          enabled: false,\n          reason: 'INVALID_SESSION_ID_FORMAT',\n          message: `sessionId must be bytes32 (0x + 64 hex chars, got ${normalizedSessionId.length} chars)`,\n        },\n        mode: 'session',\n        correlationId,\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    const { EXECUTION_ROUTER_ADDRESS, ETH_TESTNET_RPC_URL } = await import('../config');\n    const correlationId = req.correlationId || 'unknown';\n\n    // Check for active session on-chain (only if sessionId provided)\n    if (!ETH_TESTNET_RPC_URL || !EXECUTION_ROUTER_ADDRESS) {\n      return res.json({\n        ok: true,\n        status: 'not_created', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: 'NOT_CONFIGURED',\n          required: ['ETH_TESTNET_RPC_URL', 'EXECUTION_ROUTER_ADDRESS'],\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n\n    try {\n      // Read session from contract (with timeout)\n      const { createPublicClient, http } = await import('viem');\n      const { sepolia } = await import('viem/chains');\n      const publicClient = createPublicClient({\n        chain: sepolia,\n        transport: http(ETH_TESTNET_RPC_URL),\n      });\n\n      const sessionAbi = [\n        {\n          name: 'sessions',\n          type: 'function',\n          stateMutability: 'view',\n          inputs: [{ name: '', type: 'bytes32' }],\n          outputs: [\n            { name: 'owner', type: 'address' },\n            { name: 'executor', type: 'address' },\n            { name: 'expiresAt', type: 'uint64' },\n            { name: 'maxSpend', type: 'uint256' },\n            { name: 'spent', type: 'uint256' },\n            { name: 'active', type: 'bool' },\n          ],\n        },\n      ] as const;\n\n      // DEBUG: Log incoming sessionId for POST handler\n      console.log('[session/status] POST Querying sessionId:', normalizedSessionId);\n      console.log('[session/status] Contract address:', EXECUTION_ROUTER_ADDRESS);\n\n      const sessionResult = await Promise.race([\n        publicClient.readContract({\n          address: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n          abi: sessionAbi,\n          functionName: 'sessions',\n          args: [normalizedSessionId as `0x${string}`],\n        }),\n        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000)),\n      ]) as any;\n\n      // Contract returns array, not object: [owner, executor, expiresAt, maxSpend, spent, active]\n      const owner = sessionResult[0];\n      const executor = sessionResult[1];\n      const expiresAt = sessionResult[2];\n      const maxSpend = sessionResult[3];\n      const spent = sessionResult[4];\n      const active = sessionResult[5];\n\n      const now = BigInt(Math.floor(Date.now() / 1000));\n      let status: 'not_created' | 'active' | 'expired' | 'revoked' = 'not_created';\n\n      // DEBUG: Log contract query result\n      console.log('[session/status] Contract query result:', {\n        owner,\n        executor,\n        expiresAt: expiresAt?.toString(),\n        active,\n        isOwnerZero: owner === '0x0000000000000000000000000000000000000000',\n      });\n\n      if (active) {\n        if (expiresAt > now) {\n          status = 'active';\n        } else {\n          status = 'expired';\n        }\n      } else if (owner !== '0x0000000000000000000000000000000000000000') {\n        status = 'revoked';\n      }\n\n      // DEBUG: Log final status\n      console.log('[session/status] Final status:', status);\n\n      // Only return enabled:true if session is active\n      return res.json({\n        ok: true,\n        status, // Top-level status field for UI (matches session.status)\n        session: {\n          enabled: status === 'active',\n          status,\n          sessionId,\n          owner,\n          executor,\n          expiresAt: expiresAt.toString(),\n          maxSpend: maxSpend.toString(),\n          spent: spent.toString(),\n          active,\n        },\n        mode: 'session',\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    } catch (error: any) {\n      // RPC error, timeout, or session doesn't exist - return enabled:false\n      if (process.env.DEBUG_SESSION === 'true') {\n        console.warn('[api/session/status] RPC check failed or session not found:', error.message);\n      }\n      return res.json({\n        ok: true,\n        status: 'not_created', // Top-level status field for UI\n        session: {\n          enabled: false,\n          reason: error.message?.includes('timeout') ? 'RPC_ERROR' : 'MISSING_FIELDS',\n          required: error.message?.includes('timeout') ? ['RPC_OK'] : ['sessionId'],\n        },\n        mode: 'session',\n        errorCode: error.message?.includes('timeout') ? 'RPC_ERROR' : undefined,\n        cooldownMs: SESSION_COOLDOWN_MS,\n      });\n    }\n  } catch (error: any) {\n    // Never throw - always return 200\n    if (process.env.DEBUG_SESSION === 'true') {\n      console.error('[api/session/status] Error:', error);\n    }\n    res.json({\n      ok: true,\n      session: {\n        enabled: false,\n        reason: 'RPC_ERROR',\n        required: ['RPC_OK'],\n      },\n      errorCode: 'RPC_ERROR',\n      cooldownMs: SESSION_COOLDOWN_MS,\n    });\n  }\n});\n\n/**\n * POST /api/session/revoke/prepare\n * Prepare session revocation transaction\n */\napp.post('/api/session/revoke/prepare', async (req, res) => {\n  try {\n    const { EXECUTION_MODE, EXECUTION_AUTH_MODE } = await import('../config');\n\n    if (EXECUTION_MODE !== 'eth_testnet' || EXECUTION_AUTH_MODE !== 'session') {\n      return res.status(400).json({\n        error: 'Session endpoint only available in eth_testnet mode with session auth',\n      });\n    }\n\n    const { sessionId } = req.body;\n\n    if (!sessionId || typeof sessionId !== 'string') {\n      return res.status(400).json({\n        error: 'sessionId is required',\n      });\n    }\n\n    const { EXECUTION_ROUTER_ADDRESS } = await import('../config');\n\n    // Encode revokeSession call\n    const { encodeFunctionData } = await import('viem');\n    const revokeSessionAbi = [\n      {\n        name: 'revokeSession',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [{ name: 'sessionId', type: 'bytes32' }],\n        outputs: [],\n      },\n    ] as const;\n\n    const data = encodeFunctionData({\n      abi: revokeSessionAbi,\n      functionName: 'revokeSession',\n      args: [sessionId as `0x${string}`],\n    });\n\n    res.json({\n      to: EXECUTION_ROUTER_ADDRESS,\n      data,\n      value: '0x0',\n      summary: `Revoke session ${sessionId.substring(0, 10)}...`,\n    });\n  } catch (error: any) {\n    console.error('[api/session/revoke/prepare] Error:', error);\n    res.status(500).json({\n      error: 'Failed to prepare session revocation',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * POST /api/token/weth/wrap/prepare\n * Prepare WETH wrap transaction (ETH \u2192 WETH)\n */\napp.post('/api/token/weth/wrap/prepare', async (req, res) => {\n  try {\n    const { amount, userAddress } = req.body;\n\n    if (!amount || !userAddress) {\n      return res.status(400).json({\n        error: 'amount and userAddress are required',\n      });\n    }\n\n    // Validate address format\n    const addressRegex = /^0x[a-fA-F0-9]{40}$/;\n    if (!addressRegex.test(userAddress)) {\n      return res.status(400).json({\n        error: 'Invalid userAddress format',\n      });\n    }\n\n    const { WETH_ADDRESS_SEPOLIA } = await import('../config');\n    if (!WETH_ADDRESS_SEPOLIA) {\n      return res.status(500).json({\n        error: 'WETH_ADDRESS_SEPOLIA not configured',\n      });\n    }\n\n    // WETH.deposit() is payable, so data is just the function selector\n    // Function selector: deposit() = 0xd0e30db0\n    const data = '0xd0e30db0';\n\n    // Convert amount to wei (18 decimals)\n    const { parseUnits } = await import('viem');\n    const amountWei = parseUnits(amount, 18);\n    const value = '0x' + amountWei.toString(16);\n\n    res.json({\n      chainId: 11155111, // Sepolia\n      to: WETH_ADDRESS_SEPOLIA.toLowerCase(),\n      data,\n      value,\n      summary: `Wrap ${amount} ETH to WETH`,\n    });\n  } catch (error: any) {\n    console.error('[api/token/weth/wrap/prepare] Error:', error);\n    res.status(500).json({\n      error: 'Failed to prepare wrap transaction',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * POST /api/token/approve/prepare\n * Prepare ERC20 approve transaction\n */\napp.post('/api/token/approve/prepare', async (req, res) => {\n  try {\n    const { token, spender, amount, userAddress } = req.body;\n\n    if (!token || !spender || !amount || !userAddress) {\n      return res.status(400).json({\n        error: 'token, spender, amount, and userAddress are required',\n      });\n    }\n\n    // Validate address format\n    const addressRegex = /^0x[a-fA-F0-9]{40}$/;\n    if (!addressRegex.test(token) || !addressRegex.test(spender) || !addressRegex.test(userAddress)) {\n      return res.status(400).json({\n        error: 'Invalid address format',\n      });\n    }\n\n    // Encode ERC20 approve call\n    const { encodeFunctionData } = await import('viem');\n    const approveAbi = [\n      {\n        name: 'approve',\n        type: 'function',\n        stateMutability: 'nonpayable',\n        inputs: [\n          { name: 'spender', type: 'address' },\n          { name: 'amount', type: 'uint256' },\n        ],\n        outputs: [{ name: '', type: 'bool' }],\n      },\n    ] as const;\n\n    // Convert amount to bigint (handle hex or decimal string)\n    const amountBigInt = typeof amount === 'string' && amount.startsWith('0x')\n      ? BigInt(amount)\n      : BigInt(amount);\n\n    const data = encodeFunctionData({\n      abi: approveAbi,\n      functionName: 'approve',\n      args: [spender as `0x${string}`, amountBigInt],\n    });\n\n    res.json({\n      chainId: 11155111, // Sepolia\n      to: token,\n      data,\n      value: '0x0',\n      summary: `Approve ${spender.substring(0, 10)}... to spend tokens`,\n    });\n  } catch (error: any) {\n    console.error('[api/token/approve/prepare] Error:', error);\n    res.status(500).json({\n      error: 'Failed to prepare approve transaction',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * GET /api/execute/status\n * Get transaction status by hash\n */\napp.get('/api/execute/status', async (req, res) => {\n  try {\n    const { txHash } = req.query;\n\n    if (!txHash || typeof txHash !== 'string') {\n      return res.status(400).json({\n        error: 'txHash query parameter is required',\n      });\n    }\n\n    // Validate txHash format\n    if (!/^0x[a-fA-F0-9]{64}$/.test(txHash)) {\n      return res.status(400).json({\n        error: 'Invalid txHash format (must be 0x followed by 64 hex characters)',\n      });\n    }\n\n    // Check execution mode\n    const executionMode = process.env.EXECUTION_MODE || 'sim';\n    if (executionMode !== 'eth_testnet') {\n      return res.json({\n        status: 'unsupported',\n        message: 'Transaction status tracking only available in eth_testnet mode',\n      });\n    }\n\n    // Require RPC URL\n    const { ETH_TESTNET_RPC_URL } = await import('../config');\n    if (!ETH_TESTNET_RPC_URL) {\n      return res.status(500).json({\n        error: 'ETH_TESTNET_RPC_URL not configured',\n      });\n    }\n\n    // Call eth_getTransactionReceipt\n    const receiptResponse = await fetch(ETH_TESTNET_RPC_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'eth_getTransactionReceipt',\n        params: [txHash],\n      }),\n    });\n\n    if (!receiptResponse.ok) {\n      throw new Error(`RPC call failed: ${receiptResponse.statusText}`);\n    }\n\n    const jsonResult: unknown = await receiptResponse.json();\n    const receiptResult = jsonResult as JsonRpcResponse<{\n      status?: string;\n      blockNumber?: string;\n      gasUsed?: string;\n      to?: string;\n      from?: string;\n    } | null>;\n    \n    if (receiptResult.error) {\n      throw new Error(`RPC error: ${receiptResult.error.message || JSON.stringify(receiptResult.error)}`);\n    }\n\n    const receipt = receiptResult.result;\n\n    // If receipt is null, transaction is pending\n    if (!receipt || receipt === null) {\n      return res.json({\n        status: 'pending',\n        txHash,\n      });\n    }\n\n    // Parse receipt status\n    const statusHex = receipt.status;\n    let status: 'confirmed' | 'reverted';\n    \n    if (statusHex === '0x1' || statusHex === '0x01') {\n      status = 'confirmed';\n    } else if (statusHex === '0x0' || statusHex === '0x00') {\n      status = 'reverted';\n    } else {\n      // Unknown status, treat as pending\n      return res.json({\n        status: 'pending',\n        txHash,\n      });\n    }\n\n    // Build response\n    const response: any = {\n      status,\n      txHash,\n      blockNumber: receipt.blockNumber || null,\n      gasUsed: receipt.gasUsed || null,\n    };\n\n    // Include to/from if available\n    if (receipt.to) {\n      response.to = receipt.to;\n    }\n    if (receipt.from) {\n      response.from = receipt.from;\n    }\n\n    res.json(response);\n  } catch (error: any) {\n    console.error('[api/execute/status] Error:', error);\n    res.status(500).json({\n      error: 'Failed to fetch transaction status',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * GET /api/portfolio/eth_testnet\n * Get real token balances for a user address on Sepolia\n */\napp.get('/api/portfolio/eth_testnet', maybeCheckAccess, async (req, res) => {\n  try {\n    const { userAddress } = req.query;\n\n    if (!userAddress || typeof userAddress !== 'string') {\n      return res.status(400).json({\n        error: 'userAddress query parameter is required',\n      });\n    }\n\n    // Validate address format\n    if (!/^0x[a-fA-F0-9]{40}$/.test(userAddress)) {\n      return res.status(400).json({\n        error: 'Invalid userAddress format',\n      });\n    }\n\n    // Check execution mode\n    const executionMode = process.env.EXECUTION_MODE || 'sim';\n    if (executionMode !== 'eth_testnet') {\n      return res.status(400).json({\n        error: 'Portfolio endpoint only available in eth_testnet mode',\n      });\n    }\n\n    // Require config\n    const { ETH_TESTNET_RPC_URL, REDACTED_ADDRESS_SEPOLIA, WETH_ADDRESS_SEPOLIA } = await import('../config');\n\n    if (!ETH_TESTNET_RPC_URL) {\n      return res.status(500).json({\n        error: 'ETH_TESTNET_RPC_URL not configured',\n      });\n    }\n\n    if (!REDACTED_ADDRESS_SEPOLIA || !WETH_ADDRESS_SEPOLIA) {\n      return res.status(500).json({\n        error: 'REDACTED_ADDRESS_SEPOLIA and WETH_ADDRESS_SEPOLIA must be configured',\n      });\n    }\n\n    // Import RPC helpers\n    const { erc20_balanceOf } = await import('../executors/erc20Rpc');\n\n    // Fetch ETH balance\n    const ethBalanceResponse = await fetch(ETH_TESTNET_RPC_URL, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'eth_getBalance',\n        params: [userAddress.toLowerCase(), 'latest'],\n      }),\n    });\n\n    if (!ethBalanceResponse.ok) {\n      throw new Error(`RPC call failed: ${ethBalanceResponse.statusText}`);\n    }\n\n    const ethResultUnknown: unknown = await ethBalanceResponse.json();\n    const ethResult = ethResultUnknown as JsonRpcResponse<string>;\n    \n    if (ethResult.error) {\n      throw new Error(`RPC error: ${ethResult.error.message || JSON.stringify(ethResult.error)}`);\n    }\n\n    const ethWei = BigInt(ethResult.result || '0x0');\n    const ethFormatted = (Number(ethWei) / 1e18).toFixed(6);\n\n    // Fetch REDACTED balance\n    const usdcBalance = await erc20_balanceOf(REDACTED_ADDRESS_SEPOLIA, userAddress);\n    const usdcFormatted = (Number(usdcBalance) / 1e6).toFixed(2);\n\n    // Fetch WETH balance\n    const wethBalance = await erc20_balanceOf(WETH_ADDRESS_SEPOLIA, userAddress);\n    const wethFormatted = (Number(wethBalance) / 1e18).toFixed(6);\n\n    res.json({\n      chainId: 11155111, // Sepolia\n      userAddress: userAddress.toLowerCase(),\n      balances: {\n        eth: {\n          wei: '0x' + ethWei.toString(16),\n          formatted: ethFormatted,\n        },\n        usdc: {\n          raw: '0x' + usdcBalance.toString(16),\n          decimals: 6,\n          formatted: usdcFormatted,\n        },\n        weth: {\n          raw: '0x' + wethBalance.toString(16),\n          decimals: 18,\n          formatted: wethFormatted,\n        },\n      },\n    });\n  } catch (error: any) {\n    console.error('[api/portfolio/eth_testnet] Error:', error);\n    res.status(500).json({\n      error: 'Failed to fetch portfolio balances',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * GET /api/defi/aave/positions\n * Read Aave positions (aToken balances) for a user\n */\napp.get('/api/defi/aave/positions', maybeCheckAccess, async (req, res) => {\n  const userAddress = typeof req.query.userAddress === 'string' ? req.query.userAddress : null;\n  \n  try {\n    if (!userAddress) {\n      return res.status(400).json({\n        error: 'userAddress query parameter is required',\n      });\n    }\n\n    // Validate address format\n    if (!/^0x[a-fA-F0-9]{40}$/.test(userAddress)) {\n      return res.status(400).json({\n        error: 'Invalid userAddress format',\n      });\n    }\n\n    const { readAavePositions } = await import('../defi/aave/positions');\n    const positions = await readAavePositions(userAddress as `0x${string}`);\n\n    // Ensure stable schema: always return positions array (empty if no positions)\n    // Never return 500 for \"no position\" case - empty array is valid\n    res.json({\n      ok: true,\n      chainId: 11155111, // Sepolia\n      userAddress,\n      positions: Array.isArray(positions) ? positions : [],\n      timestamp: Date.now(),\n    });\n  } catch (error: any) {\n    console.error('[api/defi/aave/positions] Error:', error);\n    // Never 500 for \"no position\" - return empty array instead\n    // Only 500 for actual server errors (config missing, RPC down, etc.)\n    const isServerError = error.message?.includes('not configured') || \n                          error.message?.includes('RPC') ||\n                          error.message?.includes('ETH_TESTNET_RPC_URL');\n    \n    if (isServerError) {\n      res.status(500).json({\n        ok: false,\n        error: error.message || 'Failed to read Aave positions',\n      });\n    } else {\n      // For other errors (e.g., asset not found, aToken fetch failed), return empty array\n      // This ensures stable schema and no 500s for \"no position\" case\n      res.json({\n        ok: true,\n        chainId: 11155111,\n        userAddress: userAddress || 'unknown',\n        positions: [],\n        timestamp: Date.now(),\n      });\n    }\n  }\n});\n\n/**\n * GET /api/wallet/balances\n * Bulletproof balance fetcher - always returns native ETH, optionally includes demo tokens\n * Never errors just because token addresses aren't configured\n */\napp.get('/api/wallet/balances', maybeCheckAccess, async (req, res) => {\n  try {\n    const { address } = req.query;\n\n    if (!address || typeof address !== 'string') {\n      return res.status(400).json({\n        error: 'address query parameter is required',\n      });\n    }\n\n    // Validate address format\n    if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {\n      return res.status(400).json({\n        error: 'Invalid address format',\n      });\n    }\n\n    // Get config\n    const { \n      EXECUTION_MODE,\n      ETH_TESTNET_RPC_URL, \n      ETH_TESTNET_CHAIN_ID,\n      DEMO_REDACTED_ADDRESS, \n      DEMO_WETH_ADDRESS \n    } = await import('../config');\n\n    // Handle SIM mode - only if explicitly allowed\n    const ALLOW_SIM_MODE = process.env.ALLOW_SIM_MODE === 'true';\n    if (EXECUTION_MODE === 'sim' && ALLOW_SIM_MODE) {\n      return res.json({\n        chainId: 11155111,\n        address: address.toLowerCase(),\n        native: {\n          symbol: 'ETH',\n          wei: '0x0',\n          formatted: '0.0',\n        },\n        tokens: [],\n        notes: ['SIM mode: returning zero balances'],\n        timestamp: Date.now(),\n      });\n    }\n    \n    // If SIM mode requested but not allowed, treat as eth_testnet\n    if (EXECUTION_MODE === 'sim' && !ALLOW_SIM_MODE) {\n      // Fall through to eth_testnet handling\n    }\n\n    // In eth_testnet mode, RPC URL is required\n    if (!ETH_TESTNET_RPC_URL) {\n      return res.status(503).json({\n        ok: false,\n        code: 'RPC_NOT_CONFIGURED',\n        message: 'ETH_TESTNET_RPC_URL is missing',\n        fix: 'Set ETH_TESTNET_RPC_URL in agent/.env.local then restart backend.',\n      });\n    }\n\n    const chainId = ETH_TESTNET_CHAIN_ID || 11155111;\n    const tokens: Array<{ address: string; symbol: string; decimals: number; raw: string; formatted: string }> = [];\n    const notes: string[] = [];\n\n    // Fetch native ETH balance (always) with timeout\n    let ethWei = BigInt(0);\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout\n      \n      const ethBalanceResponse = await fetch(ETH_TESTNET_RPC_URL, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          jsonrpc: '2.0',\n          id: 1,\n          method: 'eth_getBalance',\n          params: [address.toLowerCase(), 'latest'],\n        }),\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeoutId);\n\n      if (ethBalanceResponse.ok) {\n        const ethResultUnknown: unknown = await ethBalanceResponse.json();\n        const ethResult = ethResultUnknown as JsonRpcResponse<string>;\n        if (!ethResult.error && ethResult.result) {\n          ethWei = BigInt(ethResult.result);\n        } else if (ethResult.error) {\n          throw new Error(`RPC error: ${ethResult.error.message || JSON.stringify(ethResult.error)}`);\n        }\n      } else {\n        throw new Error(`RPC HTTP error: ${ethBalanceResponse.status} ${ethBalanceResponse.statusText}`);\n      }\n    } catch (e: any) {\n      // If timeout or network error, return structured error\n      if (e.name === 'AbortError' || e.message?.includes('fetch')) {\n        return res.status(503).json({\n          ok: false,\n          code: 'RPC_UNREACHABLE',\n          message: 'RPC endpoint is unreachable or timed out',\n          fix: 'Check ETH_TESTNET_RPC_URL in agent/.env.local and ensure RPC endpoint is accessible.',\n        });\n      }\n      notes.push(`ETH balance fetch failed: ${e.message}`);\n    }\n\n    // Fetch demo token balances (if configured)\n    if (DEMO_REDACTED_ADDRESS) {\n      try {\n        const { erc20_balanceOf } = await import('../executors/erc20Rpc');\n        const balance = await erc20_balanceOf(DEMO_REDACTED_ADDRESS, address);\n        tokens.push({\n          address: DEMO_REDACTED_ADDRESS,\n          symbol: 'REDACTED',\n          decimals: 6,\n          raw: '0x' + balance.toString(16),\n          formatted: (Number(balance) / 1e6).toFixed(2),\n        });\n      } catch (e: any) {\n        notes.push(`REDACTED balance fetch failed: ${e.message}`);\n      }\n    } else {\n      notes.push('DEMO_REDACTED_ADDRESS not configured');\n    }\n\n    if (DEMO_WETH_ADDRESS) {\n      try {\n        const { erc20_balanceOf } = await import('../executors/erc20Rpc');\n        const balance = await erc20_balanceOf(DEMO_WETH_ADDRESS, address);\n        tokens.push({\n          address: DEMO_WETH_ADDRESS,\n          symbol: 'WETH',\n          decimals: 18,\n          raw: '0x' + balance.toString(16),\n          formatted: (Number(balance) / 1e18).toFixed(6),\n        });\n      } catch (e: any) {\n        notes.push(`WETH balance fetch failed: ${e.message}`);\n      }\n    } else {\n      notes.push('DEMO_WETH_ADDRESS not configured');\n    }\n\n    const ethFormatted = (Number(ethWei) / 1e18).toFixed(6);\n\n    res.json({\n      chainId,\n      address: address.toLowerCase(),\n      native: {\n        symbol: 'ETH',\n        wei: '0x' + ethWei.toString(16),\n        formatted: ethFormatted,\n      },\n      tokens,\n      notes: notes.length > 0 ? notes : undefined,\n      timestamp: Date.now(),\n    });\n  } catch (error: any) {\n    console.error('[api/wallet/balances] Error:', error);\n    res.status(500).json({\n      error: 'Failed to fetch wallet balances',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * POST /api/demo/faucet\n * Mints demo tokens (REDACTED and WETH) to a user address\n * Only available in eth_testnet mode\n */\napp.post('/api/demo/faucet', maybeCheckAccess, async (req, res) => {\n  try {\n    const { EXECUTION_MODE, DEMO_REDACTED_ADDRESS, DEMO_WETH_ADDRESS } = await import('../config');\n\n    // Only allow in testnet mode\n    if (EXECUTION_MODE !== 'eth_testnet') {\n      return res.status(400).json({\n        error: 'Faucet only available in eth_testnet mode'\n      });\n    }\n\n    // Validate demo token addresses are configured\n    if (!DEMO_REDACTED_ADDRESS || !DEMO_WETH_ADDRESS) {\n      return res.status(500).json({\n        error: 'Demo token addresses not configured',\n        message: 'DEMO_REDACTED_ADDRESS and DEMO_WETH_ADDRESS must be set in .env.local'\n      });\n    }\n\n    const { userAddress } = req.body;\n\n    if (!userAddress || typeof userAddress !== 'string') {\n      return res.status(400).json({\n        error: 'userAddress is required'\n      });\n    }\n\n    // Validate address format\n    if (!/^0x[a-fA-F0-9]{40}$/i.test(userAddress)) {\n      return res.status(400).json({\n        error: 'Invalid userAddress format'\n      });\n    }\n\n    console.log(`[api/demo/faucet] Minting tokens to ${userAddress}...`);\n\n    // Import minting utility\n    const { mintDemoTokens } = await import('../utils/demoTokenMinter');\n\n    const result = await mintDemoTokens(userAddress);\n\n    console.log(`[api/demo/faucet] Successfully minted tokens:`, result);\n\n    res.json({\n      success: true,\n      txHashes: result.txHashes,\n      amounts: result.amounts\n    });\n  } catch (error: any) {\n    console.error('[api/demo/faucet] Error:', error);\n    res.status(500).json({\n      error: 'Failed to mint demo tokens',\n      message: error.message\n    });\n  }\n});\n\n/**\n * Health check endpoint\n * Simple endpoint that never depends on chain config - just confirms server is up\n */\napp.get('/health', async (req, res) => {\n  try {\n    const { \n      EXECUTION_MODE, \n      ETH_TESTNET_RPC_URL,\n      EXECUTION_ROUTER_ADDRESS,\n    } = await import('../config');\n    \n    // Check API keys\n    const hasGeminiKey = !!process.env.BLOSSOM_GEMINI_API_KEY;\n    const hasOpenAIKey = !!process.env.BLOSSOM_OPENAI_API_KEY;\n    const hasAnthropicKey = !!process.env.BLOSSOM_ANTHROPIC_API_KEY;\n    const hasAnyLLMKey = hasGeminiKey || hasOpenAIKey || hasAnthropicKey;\n    \n    // Dev-safe debug info (no secrets, just lengths)\n    const rpcUrlLen = ETH_TESTNET_RPC_URL ? ETH_TESTNET_RPC_URL.length : 0;\n    const routerAddrLen = EXECUTION_ROUTER_ADDRESS ? EXECUTION_ROUTER_ADDRESS.length : 0;\n    \n    // V1/V1.1 validation: check required vars for eth_testnet mode\n    const missing: string[] = [];\n    let ok = true;\n    \n    if (EXECUTION_MODE === 'eth_testnet') {\n      if (!ETH_TESTNET_RPC_URL) {\n        missing.push('ETH_TESTNET_RPC_URL');\n        ok = false;\n      }\n      if (!EXECUTION_ROUTER_ADDRESS) {\n        missing.push('EXECUTION_ROUTER_ADDRESS');\n        ok = false;\n      }\n      if (!hasAnyLLMKey) {\n        missing.push('BLOSSOM_GEMINI_API_KEY (or BLOSSOM_OPENAI_API_KEY or BLOSSOM_ANTHROPIC_API_KEY)');\n        ok = false;\n      }\n    }\n    \n    res.json({\n      ok,\n      ts: Date.now(),\n      service: 'blossom-agent',\n      executionMode: EXECUTION_MODE || 'eth_testnet',\n      // Dev-safe debug info\n      debug: {\n        rpcUrlLen,\n        routerAddrLen,\n        hasRpcUrl: !!ETH_TESTNET_RPC_URL,\n        hasRouterAddr: !!EXECUTION_ROUTER_ADDRESS,\n        hasAnyLLMKey,\n      },\n      ...(missing.length > 0 && { missing }),\n    });\n  } catch (error) {\n    // If config import fails, still return health\n    res.json({\n      ok: false,\n      ts: Date.now(),\n      service: 'blossom-agent',\n      executionMode: 'unknown',\n      missing: ['config_load_failed'],\n      error: error instanceof Error ? error.message : 'unknown',\n    });\n  }\n});\n\n/**\n * Extended health check with LLM provider info (for debugging)\n */\napp.get('/api/health', (req, res) => {\n  // Get LLM provider info (non-sensitive)\n  const provider = process.env.BLOSSOM_MODEL_PROVIDER || 'stub';\n  const hasGeminiKey = !!process.env.BLOSSOM_GEMINI_API_KEY;\n  const hasOpenAIKey = !!process.env.BLOSSOM_OPENAI_API_KEY;\n  const hasAnthropicKey = !!process.env.BLOSSOM_ANTHROPIC_API_KEY;\n  \n  // Determine effective provider (fallback to stub if key missing)\n  let effectiveProvider = provider;\n  if (provider === 'gemini' && !hasGeminiKey) {\n    effectiveProvider = 'stub';\n  } else if (provider === 'openai' && !hasOpenAIKey) {\n    effectiveProvider = 'stub';\n  } else if (provider === 'anthropic' && !hasAnthropicKey) {\n    effectiveProvider = 'stub';\n  }\n  \n  res.json({\n    ok: true,\n    ts: Date.now(),\n    service: 'blossom-agent',\n    llmProvider: effectiveProvider, // Non-sensitive: just the provider name\n  });\n});\n\n/**\n * RPC Provider Health endpoint\n * Shows status of primary and fallback RPC endpoints with circuit breaker state\n */\napp.get('/api/rpc/health', async (req, res) => {\n  try {\n    const { getProviderHealthStatus } = await import('../providers/rpcProvider');\n    const status = getProviderHealthStatus();\n\n    res.json({\n      ok: true,\n      ts: Date.now(),\n      ...status,\n    });\n  } catch (error) {\n    // Provider not initialized\n    res.json({\n      ok: false,\n      ts: Date.now(),\n      error: 'RPC provider not initialized',\n      primary: null,\n      fallbacks: [],\n    });\n  }\n});\n\n/**\n * Reset RPC circuit breakers (manual recovery)\n */\napp.post('/api/rpc/reset', async (req, res) => {\n  try {\n    const { resetAllCircuits } = await import('../providers/rpcProvider');\n    resetAllCircuits();\n    res.json({ ok: true, message: 'All circuit breakers reset' });\n  } catch (error) {\n    res.json({ ok: false, error: 'RPC provider not initialized' });\n  }\n});\n\n// ============================================\n// Telemetry Dashboard Endpoints\n// ============================================\n\n/**\n * Get telemetry summary (for dashboard)\n */\napp.get('/api/telemetry/summary', async (req, res) => {\n  try {\n    const { getTelemetrySummary } = await import('../../telemetry/db');\n    const summary = getTelemetrySummary();\n    res.json({ ok: true, data: summary });\n  } catch (error) {\n    // Fail open - return empty summary if DB not available\n    res.json({\n      ok: false,\n      error: 'Telemetry DB not available',\n      data: {\n        totalUsers: 0,\n        totalSessions: 0,\n        activeSessions: 0,\n        totalExecutions: 0,\n        successfulExecutions: 0,\n        failedExecutions: 0,\n        successRate: 0,\n        avgLatencyMs: null,\n        topErrors: [],\n        recentExecutions: [],\n      },\n    });\n  }\n});\n\n/**\n * Devnet Statistics endpoint for landing page\n * Returns comprehensive stats:\n *   - traffic: HTTP requests processed (from request_log)\n *   - executions: On-chain transactions finalized (from executions)\n *   - users, amounts, fees\n */\napp.get('/api/telemetry/devnet-stats', async (req, res) => {\n  try {\n    const { getDevnetStats, getTrafficStats, migrateAddFeeColumns } = await import('../../telemetry/db');\n    const { BLOSSOM_FEE_BPS } = await import('../config');\n\n    // Ensure fee columns exist (migration)\n    migrateAddFeeColumns();\n\n    const executionStats = getDevnetStats(BLOSSOM_FEE_BPS);\n    const trafficStats = getTrafficStats(24);\n\n    // Combined response with clear separation\n    res.json({\n      ok: true,\n      data: {\n        // Traffic stats (HTTP requests - what load tests generate)\n        traffic: {\n          requestsAllTime: trafficStats.requests.allTime,\n          requestsLast24h: trafficStats.requests.last24h,\n          successRate24h: trafficStats.requests.successRate24h,\n          http5xx24h: trafficStats.requests.http5xx24h,\n          visitorsAllTime: trafficStats.visitors.allTime,\n          visitorsLast24h: trafficStats.visitors.last24h,\n        },\n        // Execution stats (on-chain transactions - real DeFi actions)\n        executions: {\n          allTime: executionStats.transactions.allTime,\n          last24h: executionStats.transactions.last24h,\n          successCount: executionStats.transactions.successCount,\n          failCount: executionStats.transactions.failCount,\n        },\n        // User stats (from users table)\n        users: executionStats.users,\n        // Volume and fees\n        amountExecuted: executionStats.amountExecuted,\n        feesCollected: executionStats.feesCollected,\n        generatedAt: new Date().toISOString(),\n      },\n    });\n  } catch (error) {\n    // Fail open with empty stats\n    res.json({\n      ok: false,\n      error: 'Devnet stats unavailable',\n      data: {\n        traffic: {\n          requestsAllTime: 0,\n          requestsLast24h: 0,\n          successRate24h: 100,\n          http5xx24h: 0,\n          visitorsAllTime: 0,\n          visitorsLast24h: 0,\n        },\n        executions: { allTime: 0, last24h: 0, successCount: 0, failCount: 0 },\n        users: { allTime: 0, last24h: 0 },\n        amountExecuted: { byToken: [], unpricedCount: 0 },\n        feesCollected: { byToken: [], feeBps: 25, unpricedCount: 0 },\n        generatedAt: new Date().toISOString(),\n      },\n    });\n  }\n});\n\n/**\n * Get users with session status\n */\napp.get('/api/telemetry/users', async (req, res) => {\n  try {\n    const { getUsersWithSessionStatus } = await import('../../telemetry/db');\n    const users = getUsersWithSessionStatus();\n    res.json({ ok: true, data: users });\n  } catch (error) {\n    res.json({ ok: false, error: 'Telemetry DB not available', data: [] });\n  }\n});\n\n/**\n * Get recent executions\n */\napp.get('/api/telemetry/executions', async (req, res) => {\n  try {\n    const { listExecutions } = await import('../../telemetry/db');\n    const limit = parseInt(req.query.limit as string || '50', 10);\n    const offset = parseInt(req.query.offset as string || '0', 10);\n    const executions = listExecutions(limit, offset);\n    res.json({ ok: true, data: executions });\n  } catch (error) {\n    res.json({ ok: false, error: 'Telemetry DB not available', data: [] });\n  }\n});\n\n/**\n * Get recent devnet traffic runs\n * Returns run metadata for display on landing page\n */\napp.get('/api/telemetry/runs', async (req, res) => {\n  try {\n    const { listRuns, ensureRunsTable } = await import('../../telemetry/db');\n    ensureRunsTable();\n    const limit = parseInt(req.query.limit as string || '5', 10);\n    const runs = listRuns(limit);\n    res.json({ ok: true, data: runs });\n  } catch (error) {\n    // Fail open with empty list\n    res.json({ ok: true, data: [] });\n  }\n});\n\n/**\n * POST /api/telemetry/runs\n * Store a load test run result (called by campaign scripts)\n */\napp.post('/api/telemetry/runs', async (req, res) => {\n  try {\n    const { upsertRun, ensureRunsTable } = await import('../../telemetry/db');\n    ensureRunsTable();\n\n    const {\n      run_id,\n      started_at,\n      duration_secs,\n      total_users,\n      concurrency,\n      total_requests,\n      success_rate,\n      p50_ms,\n      p95_ms,\n      http_5xx_count,\n      top_error,\n    } = req.body;\n\n    if (!run_id) {\n      return res.status(400).json({ ok: false, error: 'run_id is required' });\n    }\n\n    // Map to DevnetRun interface fields\n    upsertRun({\n      run_id,\n      stage: null,\n      users: total_users || 0,\n      concurrency: concurrency || 0,\n      duration: duration_secs || 0,\n      total_requests: total_requests || 0,\n      success_rate: success_rate || 0,\n      p50_ms: p50_ms || 0,\n      p95_ms: p95_ms || 0,\n      http_5xx: http_5xx_count || 0,\n      top_error_code: top_error || null,\n      started_at: started_at || new Date().toISOString(),\n      ended_at: new Date().toISOString(),\n      report_path: null,\n    });\n\n    res.json({ ok: true, run_id });\n  } catch (error: any) {\n    res.status(500).json({ ok: false, error: error.message || 'Failed to store run' });\n  }\n});\n\n/**\n * GET /api/telemetry/debug\n * Audit endpoint for investor verification\n * Shows database path, writability, table info, and row counts\n */\napp.get('/api/telemetry/debug', async (req, res) => {\n  try {\n    const { getDatabase, ensureRunsTable } = await import('../../telemetry/db');\n    const db = getDatabase();\n    ensureRunsTable();\n\n    // Get database path\n    const dbPath = process.env.TELEMETRY_DB_PATH || './telemetry/telemetry.db';\n\n    // Check if writable by attempting a test\n    let isWritable = false;\n    try {\n      db.exec('SELECT 1');\n      isWritable = true;\n    } catch (e) {\n      isWritable = false;\n    }\n\n    // Get table list\n    const tables = db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all() as { name: string }[];\n    const tableNames = tables.map(t => t.name);\n\n    // Get row counts for key tables\n    const counts: Record<string, number> = {};\n    for (const table of ['users', 'request_log', 'executions', 'runs', 'access_codes']) {\n      try {\n        const row = db.prepare(`SELECT COUNT(*) as count FROM ${table}`).get() as { count: number };\n        counts[table] = row?.count ?? 0;\n      } catch {\n        counts[table] = -1; // Table doesn't exist\n      }\n    }\n\n    // Get latest run\n    let latestRun = null;\n    try {\n      latestRun = db.prepare('SELECT run_id, started_at, total_requests, success_rate FROM runs ORDER BY created_at DESC LIMIT 1').get();\n    } catch {\n      // No runs table or empty\n    }\n\n    // Get app version/commit if available\n    const appVersion = process.env.FLY_IMAGE_REF || process.env.VERCEL_GIT_COMMIT_SHA || 'unknown';\n\n    res.json({\n      ok: true,\n      debug: {\n        dbPath,\n        isWritable,\n        tables: tableNames,\n        rowCounts: counts,\n        latestRun,\n        appVersion,\n        nodeEnv: process.env.NODE_ENV || 'development',\n        timestamp: new Date().toISOString(),\n      },\n    });\n  } catch (error: any) {\n    res.status(500).json({\n      ok: false,\n      error: error.message || 'Failed to get debug info',\n    });\n  }\n});\n\nconst PORT = parseInt(process.env.PORT || '3001', 10);\nconst HOST = process.env.HOST || '0.0.0.0'; // Bind to all interfaces by default\n\n// Print startup banner with configuration status (Task C: Session config logging)\n(async () => {\n  try {\n    const {\n      EXECUTION_MODE,\n      EXECUTION_AUTH_MODE,\n      ETH_TESTNET_RPC_URL,\n      EXECUTION_ROUTER_ADDRESS,\n      RELAYER_PRIVATE_KEY,\n      ETH_TESTNET_CHAIN_ID,\n    } = await import('../config');\n    \n    // Check API keys from process.env (not exported from config)\n    const hasGeminiKey = !!process.env.BLOSSOM_GEMINI_API_KEY;\n    const hasOpenAIKey = !!process.env.BLOSSOM_OPENAI_API_KEY;\n    const hasAnthropicKey = !!process.env.BLOSSOM_ANTHROPIC_API_KEY;\n    \n    // Task C: Redact RPC URL (show only first/last chars)\n    const redactedRpcUrl = ETH_TESTNET_RPC_URL \n      ? `${ETH_TESTNET_RPC_URL.substring(0, 20)}...${ETH_TESTNET_RPC_URL.substring(ETH_TESTNET_RPC_URL.length - 10)}`\n      : 'not configured';\n    \n    // Task 3: Startup banner with chainId, router, adapter addresses\n    if (EXECUTION_MODE === 'eth_testnet') {\n      const { \n        MOCK_SWAP_ADAPTER_ADDRESS,\n        UNISWAP_V3_ADAPTER_ADDRESS,\n        UNISWAP_ADAPTER_ADDRESS,\n        WETH_WRAP_ADAPTER_ADDRESS,\n        ERC20_PULL_ADAPTER_ADDRESS,\n        PROOF_ADAPTER_ADDRESS,\n      } = await import('../config');\n      \n      console.log(`\\n\uD83D\uDD27 ETH Testnet Execution Configuration`);\n      console.log(`   Chain ID: ${ETH_TESTNET_CHAIN_ID || 'N/A'} (Sepolia: 11155111)`);\n      console.log(`   Router Address: ${EXECUTION_ROUTER_ADDRESS ? `${EXECUTION_ROUTER_ADDRESS.substring(0, 10)}...${EXECUTION_ROUTER_ADDRESS.substring(EXECUTION_ROUTER_ADDRESS.length - 8)}` : 'NOT SET'}`);\n      console.log(`   Adapter Addresses:`);\n      if (MOCK_SWAP_ADAPTER_ADDRESS) console.log(`     - MOCK_SWAP: ${MOCK_SWAP_ADAPTER_ADDRESS.substring(0, 10)}...${MOCK_SWAP_ADAPTER_ADDRESS.substring(MOCK_SWAP_ADAPTER_ADDRESS.length - 8)}`);\n      if (UNISWAP_V3_ADAPTER_ADDRESS) console.log(`     - UNISWAP_V3: ${UNISWAP_V3_ADAPTER_ADDRESS.substring(0, 10)}...${UNISWAP_V3_ADAPTER_ADDRESS.substring(UNISWAP_V3_ADAPTER_ADDRESS.length - 8)}`);\n      if (UNISWAP_ADAPTER_ADDRESS) console.log(`     - UNISWAP: ${UNISWAP_ADAPTER_ADDRESS.substring(0, 10)}...${UNISWAP_ADAPTER_ADDRESS.substring(UNISWAP_ADAPTER_ADDRESS.length - 8)}`);\n      if (WETH_WRAP_ADAPTER_ADDRESS) console.log(`     - WETH_WRAP: ${WETH_WRAP_ADAPTER_ADDRESS.substring(0, 10)}...${WETH_WRAP_ADAPTER_ADDRESS.substring(WETH_WRAP_ADAPTER_ADDRESS.length - 8)}`);\n      if (ERC20_PULL_ADAPTER_ADDRESS) console.log(`     - ERC20_PULL: ${ERC20_PULL_ADAPTER_ADDRESS.substring(0, 10)}...${ERC20_PULL_ADAPTER_ADDRESS.substring(ERC20_PULL_ADAPTER_ADDRESS.length - 8)}`);\n      if (PROOF_ADAPTER_ADDRESS) console.log(`     - PROOF: ${PROOF_ADAPTER_ADDRESS.substring(0, 10)}...${PROOF_ADAPTER_ADDRESS.substring(PROOF_ADAPTER_ADDRESS.length - 8)}`);\n      console.log(`   RPC URL: ${redactedRpcUrl}`);\n      console.log(``);\n    }\n    \n    // Task 4: DEBUG_DEMO banner for execution path proof\n    if (process.env.DEBUG_DEMO === 'true') {\n      console.log(`\\n\uD83D\uDD0D DEBUG_DEMO: Execution Path Configuration`);\n      console.log(`   EXECUTION_MODE: ${EXECUTION_MODE}`);\n      console.log(`   EXECUTION_AUTH_MODE: ${EXECUTION_AUTH_MODE || 'direct'}`);\n      console.log(`   Router Address: ${EXECUTION_ROUTER_ADDRESS ? `${EXECUTION_ROUTER_ADDRESS.substring(0, 10)}...` : 'NOT SET'}`);\n      console.log(`   Relayer PK Present: ${!!RELAYER_PRIVATE_KEY}`);\n      console.log(`   RPC URL: ${redactedRpcUrl}`);\n      console.log(`   Chain ID: ${ETH_TESTNET_CHAIN_ID || 'N/A'}`);\n      console.log(``);\n    }\n    \n    console.log(`\\n\uD83C\uDF38 Blossom Agent Startup Configuration`);\n    console.log(`   Port: ${PORT}`);\n    console.log(`   Host: ${HOST}`);\n    console.log(`   EXECUTION_MODE: ${EXECUTION_MODE}`);\n    console.log(`   EXECUTION_AUTH_MODE: ${EXECUTION_AUTH_MODE || 'direct'}`);\n    console.log(`\\n   Configuration Status:`);\n    console.log(`   \u2713 hasEthRpcUrl: ${!!ETH_TESTNET_RPC_URL} (${redactedRpcUrl})`);\n    console.log(`   \u2713 hasExecutionRouterAddress: ${!!EXECUTION_ROUTER_ADDRESS} ${EXECUTION_ROUTER_ADDRESS ? `(${EXECUTION_ROUTER_ADDRESS.substring(0, 10)}...)` : ''}`);\n    console.log(`   \u2713 hasGeminiKey: ${hasGeminiKey}`);\n    console.log(`   \u2713 hasOpenAIKey: ${hasOpenAIKey}`);\n    console.log(`   \u2713 hasAnthropicKey: ${hasAnthropicKey}`);\n    \n    // Task C: Session mode requirements\n    if (EXECUTION_AUTH_MODE === 'session') {\n      console.log(`\\n   Session Mode Requirements:`);\n      console.log(`   \u2713 hasRelayerPrivateKey: ${!!RELAYER_PRIVATE_KEY}`);\n      console.log(`   \u2713 hasExecutionRouterAddress: ${!!EXECUTION_ROUTER_ADDRESS}`);\n      console.log(`   \u2713 hasEthRpcUrl: ${!!ETH_TESTNET_RPC_URL}`);\n      \n      if (!RELAYER_PRIVATE_KEY || !EXECUTION_ROUTER_ADDRESS || !ETH_TESTNET_RPC_URL) {\n        console.log(`\\n   \u26A0\uFE0F  WARNING: Session mode requires:`);\n        if (!RELAYER_PRIVATE_KEY) console.log(`      - RELAYER_PRIVATE_KEY`);\n        if (!EXECUTION_ROUTER_ADDRESS) console.log(`      - EXECUTION_ROUTER_ADDRESS`);\n        if (!ETH_TESTNET_RPC_URL) console.log(`      - ETH_TESTNET_RPC_URL`);\n        console.log(`      Session mode will be disabled. Direct mode will be used instead.`);\n      } else {\n        console.log(`   \u2713 Session mode configured`);\n      }\n    }\n    \n    if (EXECUTION_MODE === 'eth_testnet') {\n      // Task 4: Validate contract configuration on startup\n      try {\n        const { validateEthTestnetConfig } = await import('../config');\n        await validateEthTestnetConfig();\n        console.log(`   \u2713 ETH testnet configuration validated`);\n      } catch (error: any) {\n        console.log(`\\n   \u274C ERROR: ETH testnet configuration validation failed:`);\n        console.log(`      ${error.message}`);\n        console.log(`      Please fix configuration errors before using eth_testnet mode.`);\n      }\n      \n      if (!ETH_TESTNET_RPC_URL) {\n        console.log(`\\n   \u26A0\uFE0F  WARNING: ETH_TESTNET_RPC_URL not configured`);\n        console.log(`      Set it in agent/.env.local to enable testnet features`);\n      }\n      if (!EXECUTION_ROUTER_ADDRESS) {\n        console.log(`\\n   \u26A0\uFE0F  WARNING: EXECUTION_ROUTER_ADDRESS not configured`);\n        console.log(`      Deploy contracts and set address in agent/.env.local`);\n      }\n\n      // Initialize RPC provider with failover\n      if (ETH_TESTNET_RPC_URL) {\n        try {\n          const { initRpcProvider } = await import('../providers/rpcProvider');\n          const { ETH_RPC_FALLBACK_URLS } = await import('../config');\n          initRpcProvider(ETH_TESTNET_RPC_URL, ETH_RPC_FALLBACK_URLS);\n          if (ETH_RPC_FALLBACK_URLS.length > 0) {\n            console.log(`   \u2713 RPC failover configured with ${ETH_RPC_FALLBACK_URLS.length} fallback(s)`);\n          }\n        } catch (error: any) {\n          console.log(`   \u26A0\uFE0F  RPC provider init skipped: ${error.message}`);\n        }\n      }\n    }\n    console.log(``);\n  } catch (error) {\n    console.log(`\uD83C\uDF38 Blossom Agent (config load skipped)`);\n  }\n})();\n\n// Export app for Vercel serverless (must be before listen())\nexport { app };\n\n// Only listen if not in serverless mode (Vercel sets VERCEL=1)\nif (!process.env.VERCEL) {\n  app.listen(PORT, HOST, async () => {\n  const listenUrl = HOST === '0.0.0.0' ? `http://127.0.0.1:${PORT}` : `http://${HOST}:${PORT}`;\n  console.log(`\uD83C\uDF38 Blossom Agent server listening on ${listenUrl}`);\n  console.log(`   Health check: http://127.0.0.1:${PORT}/health`);\n  console.log(`   API endpoints:`);\n  console.log(`   - POST /api/chat`);\n  console.log(`   - POST /api/strategy/close`);\n  console.log(`   - POST /api/reset`);\n  console.log(`   - GET  /api/ticker`);\n  console.log(`   - POST /api/execute/prepare`);\n  console.log(`   - POST /api/execute/submit`);\n  console.log(`   - GET  /api/execute/status`);\n  console.log(`   - GET  /api/execute/preflight`);\n  console.log(`   - POST /api/session/prepare`);\n  console.log(`   - POST /api/execute/relayed`);\n  console.log(`   - POST /api/token/approve/prepare`);\n  console.log(`   - POST /api/token/weth/wrap/prepare`);\n  console.log(`   - GET  /api/portfolio/eth_testnet`);\n  console.log(`   - GET  /health`);\n  console.log(`   - GET  /api/debug/executions`);\n  console.log(`   - POST /api/access/validate`);\n  console.log(`   - GET  /api/ledger/positions`);\n  console.log(`   - GET  /api/ledger/positions/recent`);\n\n  // Start perp indexer if configured\n  try {\n    const { startPerpIndexer } = await import('../indexer/perpIndexer');\n    const rpcUrl = process.env.ETH_TESTNET_RPC_URL;\n    const perpEngineAddress = process.env.DEMO_PERP_ENGINE_ADDRESS;\n\n    if (rpcUrl && perpEngineAddress) {\n      startPerpIndexer(rpcUrl, perpEngineAddress);\n    } else {\n      console.log('   [indexer] Perp indexer disabled (config missing)');\n    }\n  } catch (err: any) {\n    console.log('   [indexer] Failed to start:', err.message);\n  }\n  console.log(`   - POST /api/access/check`);\n  console.log(`   - GET  /api/access/codes (admin)`);\n  console.log(`   - POST /api/access/codes/generate (admin)`);\n  console.log(`   - GET  /api/prices/eth`);\n  });\n} else {\n  console.log('\uD83C\uDF38 Blossom Agent (Vercel serverless mode - app exported, not listening)');\n}\n\n/**\n * GET /api/prices/simple\n * Proxy for CoinGecko simple/price endpoint with caching and rate limiting\n * Query params: ids (comma-separated), vs_currencies (default: usd)\n */\napp.get('/api/prices/simple', async (req, res) => {\n  try {\n    const idsParam = req.query.ids;\n    const vsCurrenciesParam = req.query.vs_currencies;\n    \n    if (!idsParam || typeof idsParam !== 'string') {\n      return res.status(400).json({\n        ok: false,\n        code: 'MISSING_IDS',\n        message: 'ids query parameter is required (comma-separated coin IDs)',\n        fix: 'Add ?ids=ethereum,bitcoin&vs_currencies=usd to the URL',\n      });\n    }\n\n    const ids = idsParam;\n    const vs_currencies = (typeof vsCurrenciesParam === 'string' ? vsCurrenciesParam : 'usd');\n\n    // In-memory cache (60s TTL)\n    const cache = (global as any).__priceCache || {};\n    const cacheKey = `${ids}-${vs_currencies}`;\n    const now = Date.now();\n    \n    if (cache[cacheKey] && (now - cache[cacheKey].timestamp) < 60000) {\n      return res.json(cache[cacheKey].data);\n    }\n\n    // Rate limiting: max 1 request per 2 seconds (request coalescing)\n    const lastRequest = (global as any).__lastPriceRequest || 0;\n    if (now - lastRequest < 2000) {\n      // Return cached data if available, otherwise return error\n      if (cache[cacheKey]) {\n        return res.json(cache[cacheKey].data);\n      }\n      return res.status(503).json({\n        ok: false,\n        code: 'RATE_LIMITED',\n        message: 'Rate limited - please wait 2 seconds between requests',\n        fix: 'Wait 2 seconds and retry, or use cached data',\n      });\n    }\n    (global as any).__lastPriceRequest = now;\n\n    // Fetch from CoinGecko\n    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=${encodeURIComponent(vs_currencies)}&include_24hr_change=true`;\n    \n    const response = await fetch(url, {\n      headers: {\n        'Accept': 'application/json',\n      },\n      signal: AbortSignal.timeout(5000), // 5s timeout\n    });\n\n    if (!response.ok) {\n      // Return cached data if available\n      if (cache[cacheKey]) {\n        return res.json(cache[cacheKey].data);\n      }\n      // Return static fallback for common coins\n      const staticPrices: Record<string, any> = {};\n      const coinIds = ids.split(',');\n      for (const coinId of coinIds) {\n        if (coinId === 'ethereum') {\n          staticPrices.ethereum = { usd: 3000 };\n        } else if (coinId === 'bitcoin') {\n          staticPrices.bitcoin = { usd: 45000 };\n        } else if (coinId === 'solana') {\n          staticPrices.solana = { usd: 100 };\n        } else if (coinId === 'avalanche-2') {\n          staticPrices['avalanche-2'] = { usd: 40 };\n        } else if (coinId === 'chainlink') {\n          staticPrices.chainlink = { usd: 14 };\n        }\n      }\n      return res.json(staticPrices);\n    }\n\n    const data = await response.json();\n    \n    // Update cache\n    if (!(global as any).__priceCache) {\n      (global as any).__priceCache = {};\n    }\n    (global as any).__priceCache[cacheKey] = {\n      data,\n      timestamp: now,\n    };\n\n    res.json(data);\n  } catch (error: any) {\n    console.error('[api/prices/simple] Error:', error);\n    // Return cached data if available\n    const cache = (global as any).__priceCache || {};\n    const idsParam = req.query.ids;\n    const vsCurrenciesParam = req.query.vs_currencies;\n    const vs_currencies = (typeof vsCurrenciesParam === 'string' ? vsCurrenciesParam : 'usd');\n    const cacheKey = `${typeof idsParam === 'string' ? idsParam : ''}-${vs_currencies}`;\n    if (cache[cacheKey]) {\n      return res.json(cache[cacheKey].data);\n    }\n    // Never throw - always return 200 with fallback\n    const staticPrices: Record<string, any> = {};\n    const coinIds = (typeof idsParam === 'string' ? idsParam.split(',') : []);\n    for (const coinId of coinIds) {\n      if (coinId === 'ethereum') {\n        staticPrices.ethereum = { usd: 3000 };\n      } else if (coinId === 'bitcoin') {\n        staticPrices.bitcoin = { usd: 45000 };\n      }\n    }\n    res.json(staticPrices);\n  }\n});\n\n/**\n * GET /api/prices/eth\n * Get current ETH price in USD\n */\napp.get('/api/prices/eth', async (req, res) => {\n  try {\n    const { getPrice } = await import('../services/prices');\n    const priceSnapshot = await getPrice('ETH');\n    res.json({\n      symbol: 'ETH',\n      priceUsd: priceSnapshot.priceUsd,\n      source: priceSnapshot.source || 'coingecko',\n    });\n  } catch (error: any) {\n    console.error('[api/prices/eth] Error:', error);\n    // Fallback to static price\n    res.json({\n      symbol: 'ETH',\n      priceUsd: 3000,\n      source: 'fallback',\n    });\n  }\n});\n\n/**\n * GET /api/debug/executions\n * Dump execution artifacts for debugging\n */\napp.get('/api/debug/executions', (req, res) => {\n  try {\n    if (process.env.DEBUG_EXECUTIONS !== '1') {\n      return res.status(403).json({\n        error: 'Debug mode not enabled. Set DEBUG_EXECUTIONS=1',\n      });\n    }\n\n    const artifacts = getExecutionArtifacts();\n    res.json({\n      count: artifacts.length,\n      artifacts,\n    });\n  } catch (error: any) {\n    console.error('[api/debug/executions] Error:', error);\n    res.status(500).json({\n      error: 'Failed to dump execution artifacts',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * In-memory ring buffer for relayed execution attempts (dev-only diagnostics)\n */\ninterface RelayedAttempt {\n  correlationId: string;\n  timestamp: number;\n  userAddress: string;\n  sessionId: string;\n  adapter: string;\n  instrumentType?: 'swap' | 'perp' | 'defi' | 'event';\n  spendAttempted?: string;\n  result: 'ok' | 'failed';\n  txHash?: string;\n  errorCode?: string;\n}\n\nconst relayedAttempts: RelayedAttempt[] = [];\nconst MAX_ATTEMPTS_HISTORY = 10;\n\nfunction addRelayedAttempt(attempt: RelayedAttempt): void {\n  relayedAttempts.unshift(attempt);\n  if (relayedAttempts.length > MAX_ATTEMPTS_HISTORY) {\n    relayedAttempts.pop();\n  }\n}\n\n/**\n * GET /api/debug/routing-stats\n * Dev-only endpoint to inspect routing service call statistics\n */\napp.get('/api/debug/routing-stats', async (req, res) => {\n  if (process.env.NODE_ENV === 'production') {\n    return res.status(403).json({ error: 'Debug endpoint not available in production' });\n  }\n\n  try {\n    const { getRoutingStats, resetRoutingStats } = await import('../routing/routingService');\n    \n    // Support reset query param\n    if (req.query.reset === 'true') {\n      resetRoutingStats();\n    }\n    \n    const stats = getRoutingStats();\n    res.json({\n      dflowCallCount: stats.dflowCallCount,\n      lastDflowCallAt: stats.lastDflowCallAt,\n      lastDflowCallAtIso: stats.lastDflowCallAt ? new Date(stats.lastDflowCallAt).toISOString() : null,\n    });\n  } catch (error: any) {\n    res.status(500).json({\n      error: error.message || 'Failed to get routing stats',\n    });\n  }\n});\n\n/**\n * GET /api/debug/session-authority\n * Dev-only endpoint to inspect session authority state and recent attempts\n */\napp.get('/api/debug/session-authority', async (req, res) => {\n  if (process.env.NODE_ENV === 'production') {\n    return res.status(403).json({ error: 'Debug endpoint not available in production' });\n  }\n\n  try {\n    const userAddress = req.query.address as string;\n    if (!userAddress) {\n      return res.status(400).json({ error: 'address query parameter required' });\n    }\n\n    const {\n      EXECUTION_ROUTER_ADDRESS,\n      ETH_TESTNET_RPC_URL,\n      UNISWAP_V3_ADAPTER_ADDRESS,\n      WETH_WRAP_ADAPTER_ADDRESS,\n      MOCK_SWAP_ADAPTER_ADDRESS,\n      PROOF_ADAPTER_ADDRESS,\n      ERC20_PULL_ADAPTER_ADDRESS,\n      DEMO_LEND_ADAPTER_ADDRESS,\n    } = await import('../config');\n\n    // Get chain ID\n    let chainId = 11155111; // Sepolia default\n    if (ETH_TESTNET_RPC_URL) {\n      try {\n        const { createPublicClient, http } = await import('viem');\n        const { sepolia } = await import('viem/chains');\n        const publicClient = createPublicClient({\n          chain: sepolia,\n          transport: http(ETH_TESTNET_RPC_URL),\n        });\n        chainId = await publicClient.getChainId();\n      } catch (error) {\n        // Use default\n      }\n    }\n\n    // Get session status (if sessionId can be found from recent attempts)\n    let sessionStatus: any = null;\n    try {\n      const recentAttempt = relayedAttempts.find(a => a.userAddress.toLowerCase() === userAddress.toLowerCase());\n      if (recentAttempt && ETH_TESTNET_RPC_URL && EXECUTION_ROUTER_ADDRESS) {\n        const { createPublicClient, http } = await import('viem');\n        const { sepolia } = await import('viem/chains');\n        const publicClient = createPublicClient({\n          chain: sepolia,\n          transport: http(ETH_TESTNET_RPC_URL),\n        });\n\n        const normalizedSessionId = recentAttempt.sessionId.startsWith('0x') \n          ? recentAttempt.sessionId \n          : `0x${recentAttempt.sessionId}`;\n\n        const sessionAbi = [\n          {\n            name: 'sessions',\n            type: 'function',\n            stateMutability: 'view',\n            inputs: [{ name: '', type: 'bytes32' }],\n            outputs: [\n              { name: 'owner', type: 'address' },\n              { name: 'executor', type: 'address' },\n              { name: 'expiresAt', type: 'uint64' },\n              { name: 'maxSpend', type: 'uint256' },\n              { name: 'spent', type: 'uint256' },\n              { name: 'active', type: 'bool' },\n            ],\n          },\n        ] as const;\n\n        try {\n          const sessionResult = await Promise.race([\n            publicClient.readContract({\n              address: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n              abi: sessionAbi,\n              functionName: 'sessions',\n              args: [normalizedSessionId as `0x${string}`],\n            }),\n            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000)),\n          ]) as any;\n\n          const now = BigInt(Math.floor(Date.now() / 1000));\n          let status: 'active' | 'expired' | 'revoked' | 'not_created' = 'not_created';\n          if (sessionResult[5]) { // active\n            status = sessionResult[2] > now ? 'active' : 'expired';\n          } else if (sessionResult[0] !== '0x0000000000000000000000000000000000000000') {\n            status = 'revoked';\n          }\n\n          sessionStatus = {\n            status,\n            owner: sessionResult[0],\n            executor: sessionResult[1],\n            expiresAt: sessionResult[2].toString(),\n            maxSpend: sessionResult[3].toString(),\n            spent: sessionResult[4].toString(),\n            active: sessionResult[5],\n          };\n        } catch (error) {\n          // RPC error - skip\n        }\n      }\n    } catch (error) {\n      // Skip session status if error\n    }\n\n    // Build allowed adapters list\n    const allowedAdapters: string[] = [];\n    if (UNISWAP_V3_ADAPTER_ADDRESS) allowedAdapters.push(UNISWAP_V3_ADAPTER_ADDRESS.toLowerCase());\n    if (WETH_WRAP_ADAPTER_ADDRESS) allowedAdapters.push(WETH_WRAP_ADAPTER_ADDRESS.toLowerCase());\n    if (MOCK_SWAP_ADAPTER_ADDRESS) allowedAdapters.push(MOCK_SWAP_ADAPTER_ADDRESS.toLowerCase());\n    if (PROOF_ADAPTER_ADDRESS) allowedAdapters.push(PROOF_ADAPTER_ADDRESS.toLowerCase());\n    if (ERC20_PULL_ADAPTER_ADDRESS) allowedAdapters.push(ERC20_PULL_ADAPTER_ADDRESS.toLowerCase());\n    if (DEMO_LEND_ADAPTER_ADDRESS) allowedAdapters.push(DEMO_LEND_ADAPTER_ADDRESS.toLowerCase());\n\n    // Get recent attempts for this user\n    const userAttempts = relayedAttempts\n      .filter(a => a.userAddress.toLowerCase() === userAddress.toLowerCase())\n      .slice(0, 10);\n\n    // Extract sessionId from recentAttempts if session is active\n    let activeSessionId: string | null = null;\n    if (sessionStatus?.status === 'active' && userAttempts.length > 0) {\n      // Get sessionId from the most recent attempt\n      activeSessionId = userAttempts[0].sessionId || null;\n    }\n\n    res.json({\n      chainId,\n      executionRouterAddress: EXECUTION_ROUTER_ADDRESS || null,\n      sessionStatus: sessionStatus ? {\n        ...sessionStatus,\n        sessionId: activeSessionId || sessionStatus.sessionId || null,\n      } : null,\n      sessionId: activeSessionId, // Top-level for easy access\n      effectivePolicy: {\n        allowedAdapters,\n        maxSpendPerTx: '10000000000000000000', // 10 ETH in wei (from session creation)\n      },\n      recentAttempts: userAttempts,\n    });\n  } catch (error: any) {\n    res.status(500).json({\n      error: error.message || 'Failed to get session authority state',\n    });\n  }\n});\n\n/**\n * GET /api/debug/dflow-probe\n * Probe dFlow API endpoints for discovery (dev only)\n * NEVER logs API key, only status codes\n */\napp.get('/api/debug/dflow-probe', async (req, res) => {\n  try {\n    const { probeDflowEndpoints } = await import('../integrations/dflow/dflowClient');\n    const results = await probeDflowEndpoints();\n    \n    // Find working endpoints (status 200, 401, or 403 indicate endpoint exists)\n    const workingQuoteEndpoints = results.quoteApi.filter(r => r.status >= 200 && r.status < 500);\n    const workingPredictionEndpoints = results.predictionApi.filter(r => r.status >= 200 && r.status < 500);\n    \n    res.json({\n      summary: {\n        configured: results.configured,\n        apiKeySet: results.apiKeySet,\n        quoteApiWorking: workingQuoteEndpoints.length,\n        predictionApiWorking: workingPredictionEndpoints.length,\n      },\n      quoteApi: results.quoteApi,\n      predictionApi: results.predictionApi,\n      recommendations: [\n        results.apiKeySet ? null : 'Set DFLOW_API_KEY in .env.local',\n        workingQuoteEndpoints.find(e => e.path === '/v1/swap/quote') ? 'Set DFLOW_SWAPS_QUOTE_PATH=/v1/swap/quote' : null,\n        workingPredictionEndpoints.find(e => e.path === '/v1/events/markets') ? 'Set DFLOW_EVENTS_MARKETS_PATH=/v1/events/markets' : null,\n        workingPredictionEndpoints.find(e => e.path === '/v1/markets') ? 'Alt: Set DFLOW_EVENTS_MARKETS_PATH=/v1/markets' : null,\n      ].filter(Boolean),\n    });\n  } catch (error: any) {\n    console.error('[api/debug/dflow-probe] Error:', error);\n    res.status(500).json({\n      error: 'Failed to probe dFlow endpoints',\n      message: error.message,\n    });\n  }\n});\n\n/**\n * GET /api/debug/session-recent\n * Query recent SessionCreated events (dev only)\n * Helps find sessionId and txHash for diagnosis\n */\napp.get('/api/debug/session-recent', async (req, res) => {\n  try {\n    const { EXECUTION_ROUTER_ADDRESS, ETH_TESTNET_RPC_URL } = await import('../config');\n    \n    if (!ETH_TESTNET_RPC_URL || !EXECUTION_ROUTER_ADDRESS) {\n      return res.status(500).json({ error: 'ETH_TESTNET_RPC_URL or EXECUTION_ROUTER_ADDRESS not configured' });\n    }\n\n    const { createPublicClient, http } = await import('viem');\n    const { sepolia } = await import('viem/chains');\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    // Query recent SessionCreated events (last 1000 blocks)\n    const currentBlock = await publicClient.getBlockNumber();\n    const fromBlock = currentBlock - 1000n;\n\n    const executionRouterAbi = [\n      {\n        type: 'event',\n        name: 'SessionCreated',\n        inputs: [\n          { name: 'sessionId', type: 'bytes32', indexed: true },\n          { name: 'owner', type: 'address', indexed: true },\n          { name: 'executor', type: 'address', indexed: true },\n          { name: 'expiresAt', type: 'uint64', indexed: false },\n          { name: 'maxSpend', type: 'uint256', indexed: false },\n        ],\n      },\n    ] as const;\n\n    const events = await publicClient.getLogs({\n      address: EXECUTION_ROUTER_ADDRESS as `0x${string}`,\n      event: executionRouterAbi[0],\n      fromBlock,\n      toBlock: 'latest',\n    });\n\n    res.json({\n      routerAddress: EXECUTION_ROUTER_ADDRESS,\n      currentBlock: currentBlock.toString(),\n      fromBlock: fromBlock.toString(),\n      eventsFound: events.length,\n      events: events.slice(-10).map((e: any) => ({\n        blockNumber: e.blockNumber.toString(),\n        transactionHash: e.transactionHash,\n        sessionId: e.args.sessionId,\n        owner: e.args.owner,\n        executor: e.args.executor,\n        expiresAt: e.args.expiresAt.toString(),\n        maxSpend: e.args.maxSpend.toString(),\n      })),\n    });\n  } catch (error: any) {\n    console.error('[api/debug/session-recent] Error:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\n/**\n * GET /api/debug/session-diagnose\n * Diagnose session transaction (dev only)\n * Analyzes a transaction hash to determine why session status might be failing\n */\napp.get('/api/debug/session-diagnose', async (req, res) => {\n  try {\n    const { txHash } = req.query;\n    \n    if (!txHash || typeof txHash !== 'string') {\n      return res.status(400).json({\n        error: 'txHash query parameter is required',\n      });\n    }\n\n    const {\n      EXECUTION_ROUTER_ADDRESS,\n      ETH_TESTNET_RPC_URL,\n    } = await import('../config');\n\n    if (!ETH_TESTNET_RPC_URL || !EXECUTION_ROUTER_ADDRESS) {\n      return res.status(500).json({\n        error: 'ETH_TESTNET_RPC_URL or EXECUTION_ROUTER_ADDRESS not configured',\n      });\n    }\n\n    const { createPublicClient, http, decodeEventLog } = await import('viem');\n    const { sepolia } = await import('viem/chains');\n    const publicClient = createPublicClient({\n      chain: sepolia,\n      transport: http(ETH_TESTNET_RPC_URL),\n    });\n\n    // Get chain ID\n    const chainId = await publicClient.getChainId();\n\n    // Check router contract\n    const routerCode = await publicClient.getBytecode({ address: EXECUTION_ROUTER_ADDRESS as `0x${string}` });\n    const routerIsContract = routerCode && routerCode !== '0x' && routerCode.length > 2;\n\n    // Get transaction\n    const tx = await publicClient.getTransaction({ hash: txHash as `0x${string}` });\n    \n    // Get receipt\n    const receipt = await publicClient.getTransactionReceipt({ hash: txHash as `0x${string}` });\n\n    // Decode logs using ExecutionRouter ABI (must match contract exactly)\n    const executionRouterAbi = [\n      {\n        type: 'event',\n        name: 'SessionCreated',\n        inputs: [\n          { name: 'sessionId', type: 'bytes32', indexed: true },\n          { name: 'owner', type: 'address', indexed: true },\n          { name: 'executor', type: 'address', indexed: true }, // Fixed: executor is indexed in contract\n          { name: 'expiresAt', type: 'uint64', indexed: false },\n          { name: 'maxSpend', type: 'uint256', indexed: false },\n        ],\n      },\n    ] as const;\n\n    const emittedEvents: Array<{ name: string; sessionId?: string; owner?: string }> = [];\n    let sessionCreatedEvent: { sessionId: string; owner: string; executor: string; expiresAt: bigint; maxSpend: bigint } | null = null;\n\n    if (receipt.logs) {\n      for (const log of receipt.logs) {\n        try {\n          const decoded = decodeEventLog({\n            abi: executionRouterAbi,\n            data: log.data,\n            topics: log.topics,\n          });\n          \n          emittedEvents.push({ name: decoded.eventName });\n          \n          if (decoded.eventName === 'SessionCreated') {\n            sessionCreatedEvent = {\n              sessionId: (decoded.args as any).sessionId,\n              owner: (decoded.args as any).owner,\n              executor: (decoded.args as any).executor,\n              expiresAt: (decoded.args as any).expiresAt,\n              maxSpend: (decoded.args as any).maxSpend,\n            };\n          }\n        } catch {\n          // Not a SessionCreated event, skip\n        }\n      }\n    }\n\n    res.json({\n      chainId,\n      routerAddress: EXECUTION_ROUTER_ADDRESS,\n      routerIsContract,\n      routerCodeLength: routerCode?.length || 0,\n      tx: {\n        to: tx.to,\n        input: tx.input.substring(0, 10), // First 10 bytes (function selector + first param)\n        value: tx.value.toString(),\n      },\n      receipt: {\n        status: receipt.status,\n        blockNumber: receipt.blockNumber.toString(),\n        logsCount: receipt.logs.length,\n      },\n      events: {\n        emitted: emittedEvents.map(e => e.name),\n        sessionCreated: sessionCreatedEvent ? {\n          sessionId: sessionCreatedEvent.sessionId,\n          owner: sessionCreatedEvent.owner,\n          executor: sessionCreatedEvent.executor,\n          expiresAt: sessionCreatedEvent.expiresAt.toString(),\n          maxSpend: sessionCreatedEvent.maxSpend.toString(),\n        } : null,\n      },\n    });\n  } catch (error: any) {\n    console.error('[api/debug/session-diagnose] Error:', error);\n    res.status(500).json({\n      error: 'Failed to diagnose session transaction',\n      message: error.message,\n    });\n  }\n});\n\n// ============================================\n// EXECUTION LEDGER API (Dev-only)\n// ============================================\n\nconst DEV_LEDGER_SECRET = process.env.DEV_LEDGER_SECRET || '';\n\n/**\n * Middleware to check ledger secret\n * BULLETPROOF GATING:\n * - DEV_LEDGER_SECRET MUST be set, otherwise 403\n * - Secret MUST be provided via X-Ledger-Secret header (NOT query param - leaks to logs/history)\n * - No fallbacks, no exceptions\n */\nfunction checkLedgerSecret(req: express.Request, res: express.Response, next: express.NextFunction) {\n  // HARD REQUIREMENT: DEV_LEDGER_SECRET must be configured\n  if (!DEV_LEDGER_SECRET) {\n    console.warn('[ledger] DEV_LEDGER_SECRET not configured - blocking all ledger API access');\n    return res.status(403).json({\n      ok: false,\n      error: 'Ledger not configured: DEV_LEDGER_SECRET env var required'\n    });\n  }\n\n  // ONLY accept header-based auth (query params leak to logs/browser history)\n  const providedSecret = req.headers['x-ledger-secret'] as string;\n\n  // Warn if query param was used (deprecated)\n  if (req.query.secret) {\n    console.warn('[ledger] Query param ?secret= is deprecated and ignored. Use X-Ledger-Secret header.');\n  }\n\n  if (!providedSecret || providedSecret !== DEV_LEDGER_SECRET) {\n    return res.status(403).json({ ok: false, error: 'Unauthorized: Invalid or missing X-Ledger-Secret header' });\n  }\n\n  next();\n}\n\n/**\n * GET /api/ledger/summary\n * Returns summary of all executions across chains\n */\napp.get('/api/ledger/summary', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getLedgerSummary } = await import('../../execution-ledger/db');\n    const summary = getLedgerSummary();\n    res.json({ ok: true, data: summary });\n  } catch (error) {\n    res.json({\n      ok: false,\n      error: 'Execution ledger not available',\n      data: {\n        totalExecutions: 0,\n        confirmedExecutions: 0,\n        failedExecutions: 0,\n        successRate: 0,\n        byChain: [],\n        activeSessions: 0,\n        trackedAssets: 0,\n        registeredWallets: 0,\n        recentExecutions: [],\n      },\n    });\n  }\n});\n\n/**\n * GET /api/ledger/executions\n * Returns list of executions with optional filters\n */\napp.get('/api/ledger/executions', checkLedgerSecret, async (req, res) => {\n  try {\n    const { listExecutionsWithMeta } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 50;\n    const offset = parseInt(req.query.offset as string) || 0;\n    const chain = req.query.chain as any;\n    const network = req.query.network as any;\n    const status = req.query.status as any;\n\n    const result = listExecutionsWithMeta({ chain, network, status, limit, offset });\n    res.json({ ok: true, data: result.data, meta: result.meta });\n  } catch (error) {\n    res.json({ ok: false, error: 'Failed to fetch executions', data: [], meta: { totalInDb: 0, limit: 50, offset: 0 } });\n  }\n});\n\n/**\n * GET /api/ledger/sessions\n * Returns list of sessions across chains\n */\napp.get('/api/ledger/sessions', checkLedgerSecret, async (req, res) => {\n  try {\n    const { listSessionsWithMeta } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 50;\n    const chain = req.query.chain as any;\n    const network = req.query.network as any;\n    const status = req.query.status as any;\n\n    const result = listSessionsWithMeta({ chain, network, status, limit });\n    res.json({ ok: true, data: result.data, meta: result.meta });\n  } catch (error) {\n    res.json({ ok: false, error: 'Failed to fetch sessions', data: [], meta: { totalInDb: 0, limit: 50, offset: 0 } });\n  }\n});\n\n/**\n * GET /api/ledger/assets\n * Returns list of tracked assets\n */\napp.get('/api/ledger/assets', checkLedgerSecret, async (req, res) => {\n  try {\n    const { listAssetsWithMeta } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 100;\n    const chain = req.query.chain as any;\n    const network = req.query.network as any;\n    const walletAddress = req.query.wallet as string;\n\n    const result = listAssetsWithMeta({ chain, network, walletAddress, limit });\n    res.json({ ok: true, data: result.data, meta: result.meta });\n  } catch (error) {\n    res.json({ ok: false, error: 'Failed to fetch assets', data: [], meta: { totalInDb: 0, limit: 100, offset: 0 } });\n  }\n});\n\n/**\n * GET /api/ledger/proofs\n * Returns proof bundle for all confirmed executions\n */\napp.get('/api/ledger/proofs', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getProofBundle } = await import('../../execution-ledger/db');\n    const proofs = getProofBundle();\n    res.json({ ok: true, data: proofs });\n  } catch (error) {\n    res.json({\n      ok: false,\n      error: 'Failed to fetch proof bundle',\n      data: { ethereum: [], solana: [] },\n    });\n  }\n});\n\n/**\n * GET /api/ledger/wallets\n * Returns list of registered dev wallets\n */\napp.get('/api/ledger/wallets', checkLedgerSecret, async (req, res) => {\n  try {\n    const { listWallets } = await import('../../execution-ledger/db');\n    const chain = req.query.chain as any;\n    const network = req.query.network as any;\n\n    const wallets = listWallets({ chain, network });\n    res.json({ ok: true, data: wallets });\n  } catch (error) {\n    res.json({ ok: false, error: 'Failed to fetch wallets', data: [] });\n  }\n});\n\n/**\n * GET /api/ledger/stats/summary\n * Returns comprehensive execution statistics for the dashboard\n */\napp.get('/api/ledger/stats/summary', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getSummaryStats } = await import('../../execution-ledger/db');\n    const stats = getSummaryStats();\n    res.json({ ok: true, data: stats });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch stats summary:', error);\n    res.json({\n      ok: false,\n      error: 'Failed to fetch stats summary',\n      data: null,\n    });\n  }\n});\n\n/**\n * GET /api/ledger/stats/recent\n * Returns recent executions for the activity feed\n */\napp.get('/api/ledger/stats/recent', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getRecentExecutions } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 20;\n    const executions = getRecentExecutions(Math.min(limit, 100)); // Cap at 100\n    res.json({ ok: true, data: executions });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch recent executions:', error);\n    res.json({ ok: false, error: 'Failed to fetch recent executions', data: [] });\n  }\n});\n\n/**\n * GET /api/ledger/executions/:id\n * Returns a single execution by ID\n */\napp.get('/api/ledger/executions/:id', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getExecution } = await import('../../execution-ledger/db');\n    const execution = getExecution(req.params.id);\n    if (!execution) {\n      return res.status(404).json({ ok: false, error: 'Execution not found', data: null });\n    }\n    res.json({ ok: true, data: execution });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch execution:', error);\n    res.json({ ok: false, error: 'Failed to fetch execution', data: null });\n  }\n});\n\n/**\n * GET /api/ledger/executions/:id/steps\n * Returns steps for a specific execution\n */\napp.get('/api/ledger/executions/:id/steps', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getExecutionSteps, getExecution } = await import('../../execution-ledger/db');\n\n    // Verify execution exists\n    const execution = getExecution(req.params.id);\n    if (!execution) {\n      return res.status(404).json({ ok: false, error: 'Execution not found', data: [] });\n    }\n\n    const steps = getExecutionSteps(req.params.id);\n    res.json({ ok: true, data: steps });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch execution steps:', error);\n    res.json({ ok: false, error: 'Failed to fetch execution steps', data: [] });\n  }\n});\n\n// ============================================\n// INTENT TRACKING ENDPOINTS\n// ============================================\n\n/**\n * GET /api/ledger/intents/recent\n * Returns recent intents for the activity feed\n */\napp.get('/api/ledger/intents/recent', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getRecentIntents } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 50;\n    const intents = getRecentIntents(Math.min(limit, 100));\n    res.json({ ok: true, data: intents });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch recent intents:', error);\n    res.json({ ok: false, error: 'Failed to fetch intents', data: [] });\n  }\n});\n\n/**\n * GET /api/ledger/intents/:id\n * Returns a single intent by ID\n */\napp.get('/api/ledger/intents/:id', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getIntent, getExecutionsForIntent } = await import('../../execution-ledger/db');\n    const intent = getIntent(req.params.id);\n\n    if (!intent) {\n      return res.status(404).json({ ok: false, error: 'Intent not found', data: null });\n    }\n\n    // Include linked executions\n    const executions = getExecutionsForIntent(req.params.id);\n\n    res.json({\n      ok: true,\n      data: {\n        ...intent,\n        executions,\n      },\n    });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch intent:', error);\n    res.json({ ok: false, error: 'Failed to fetch intent', data: null });\n  }\n});\n\n/**\n * GET /api/ledger/stats/intents\n * Returns comprehensive intent statistics for the dashboard\n */\napp.get('/api/ledger/stats/intents', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getIntentStatsSummary } = await import('../../execution-ledger/db');\n    const stats = getIntentStatsSummary();\n    res.json({ ok: true, data: stats });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch intent stats:', error);\n    res.json({\n      ok: false,\n      error: 'Failed to fetch intent stats',\n      data: {\n        totalIntents: 0,\n        confirmedIntents: 0,\n        failedIntents: 0,\n        intentSuccessRate: 0,\n        byKind: [],\n        byStatus: [],\n        failuresByStage: [],\n        failuresByCode: [],\n        recentIntents: [],\n      },\n    });\n  }\n});\n\n/**\n * GET /api/ledger/intents/:id/executions\n * Returns executions linked to a specific intent\n */\napp.get('/api/ledger/intents/:id/executions', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getIntent, getExecutionsForIntent } = await import('../../execution-ledger/db');\n\n    // Verify intent exists\n    const intent = getIntent(req.params.id);\n    if (!intent) {\n      return res.status(404).json({ ok: false, error: 'Intent not found', data: [] });\n    }\n\n    const executions = getExecutionsForIntent(req.params.id);\n    res.json({ ok: true, data: executions });\n  } catch (error) {\n    console.error('[ledger] Failed to fetch intent executions:', error);\n    res.json({ ok: false, error: 'Failed to fetch intent executions', data: [] });\n  }\n});\n\n/**\n * POST /api/ledger/intents/execute\n * Execute an intent through the full pipeline (parse \u2192 route \u2192 execute \u2192 confirm)\n *\n * Options:\n * - planOnly: true \u2192 Returns plan without executing (for confirm mode)\n * - intentId: string \u2192 Execute a previously planned intent (skip parse/route)\n *\n * Returns execution result with explorer links\n */\napp.post('/api/ledger/intents/execute', checkLedgerSecret, async (req, res) => {\n  try {\n    const { intentText, chain = 'ethereum', planOnly = false, intentId, metadata } = req.body;\n\n    // Import the intent runner functions\n    const { runIntent, executeIntentById, recordFailedIntent } = await import('../intent/intentRunner');\n\n    // If intentId is provided, execute the existing planned intent\n    if (intentId && typeof intentId === 'string') {\n      const result = await executeIntentById(intentId);\n      return res.json(result);\n    }\n\n    // Build standard metadata with source tracking\n    const origin = req.headers.origin || req.headers.referer || 'unknown';\n    const callerMetadata = typeof metadata === 'object' && metadata !== null ? metadata : {};\n\n    // Determine source: CLI scripts set source explicitly, UI doesn't\n    const source = callerMetadata.source || (origin.includes('localhost') || origin.includes('blossom') ? 'ui' : 'unknown');\n    const domain = callerMetadata.domain || (origin !== 'unknown' ? new URL(origin).host : 'unknown');\n\n    const enrichedMetadata = {\n      ...callerMetadata,\n      source,\n      domain,\n      timestamp: Date.now(),\n    };\n\n    // Validate intentText - record failure if missing\n    if (!intentText || typeof intentText !== 'string' || !intentText.trim()) {\n      // Record the failed intent so it appears in stats\n      const failedResult = await recordFailedIntent({\n        intentText: intentText || '',\n        failureStage: 'plan',\n        errorCode: 'INVALID_REQUEST',\n        errorMessage: 'intentText is required (or intentId to execute planned intent)',\n        metadata: enrichedMetadata,\n      });\n\n      return res.status(400).json(failedResult);\n    }\n\n    // Run the intent through the pipeline\n    const result = await runIntent(intentText, {\n      chain: chain as 'ethereum' | 'solana' | 'both',\n      planOnly: Boolean(planOnly),\n      metadata: enrichedMetadata,\n    });\n\n    // Return the result (already in the expected format)\n    res.json(result);\n  } catch (error: any) {\n    console.error('[ledger] Intent execution error:', error);\n    res.status(500).json({\n      ok: false,\n      intentId: '',\n      status: 'failed',\n      error: {\n        stage: 'execute',\n        code: 'INTERNAL_ERROR',\n        message: error.message || 'Internal server error',\n      },\n    });\n  }\n});\n\n// ============================================\n// POSITIONS API ENDPOINTS\n// ============================================\n\n/**\n * GET /api/ledger/positions/recent\n * Get recent positions (all statuses)\n */\napp.get('/api/ledger/positions/recent', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getRecentPositions } = await import('../../execution-ledger/db');\n    const limit = parseInt(req.query.limit as string) || 20;\n    const positions = getRecentPositions(Math.min(limit, 100));\n    res.json({ ok: true, positions });\n  } catch (error: any) {\n    res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\n/**\n * GET /api/ledger/positions\n * Get positions with optional filters\n */\napp.get('/api/ledger/positions', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getOpenPositions, getPositionsByStatus } = await import('../../execution-ledger/db');\n    const status = req.query.status as string;\n    const chain = req.query.chain as string;\n    const network = req.query.network as string;\n    const venue = req.query.venue as string;\n    const limit = parseInt(req.query.limit as string) || 50;\n\n    let positions;\n    if (status === 'open') {\n      positions = getOpenPositions({ chain, network, venue });\n    } else if (status === 'closed' || status === 'liquidated') {\n      positions = getPositionsByStatus(status as any, limit);\n    } else {\n      // Default to open positions\n      positions = getOpenPositions({ chain, network, venue });\n    }\n\n    res.json({ ok: true, positions });\n  } catch (error: any) {\n    res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\n/**\n * GET /api/ledger/positions/:id\n * Get a specific position by ID\n */\napp.get('/api/ledger/positions/:id', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getPosition } = await import('../../execution-ledger/db');\n    const position = getPosition(req.params.id);\n\n    if (!position) {\n      return res.status(404).json({ ok: false, error: 'Position not found' });\n    }\n\n    res.json({ ok: true, position });\n  } catch (error: any) {\n    res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\n/**\n * GET /api/ledger/positions/stats\n * Get position statistics\n */\napp.get('/api/ledger/positions/stats', checkLedgerSecret, async (req, res) => {\n  try {\n    const { getPositionStats } = await import('../../execution-ledger/db');\n    const stats = getPositionStats();\n    res.json({ ok: true, stats });\n  } catch (error: any) {\n    res.status(500).json({ ok: false, error: error.message });\n  }\n});\n\n// ============================================\n// ACCESS GATE + WAITLIST ENDPOINTS\n// ============================================\n\n/**\n * POST /api/access/validate\n * Validate an access code (public endpoint)\n */\napp.post('/api/access/validate', async (req, res) => {\n  try {\n    const { code, walletAddress } = req.body;\n\n    if (!code) {\n      return res.json({ ok: true, valid: false, error: 'Access code required' });\n    }\n\n    const result = validateAccessCode(code, walletAddress);\n    res.json({ ok: true, valid: result.valid, error: result.error });\n  } catch (error: any) {\n    console.error('[access] Validation error:', error.message);\n    res.json({ ok: false, valid: false, error: 'Validation failed' });\n  }\n});\n\n/**\n * POST /api/waitlist/join\n * Add email or wallet to waitlist (public endpoint)\n */\napp.post('/api/waitlist/join', async (req, res) => {\n  try {\n    const { email, walletAddress, source } = req.body;\n\n    // Require at least one identifier\n    if (!email && !walletAddress) {\n      return res.status(400).json({ ok: false, error: 'Email or wallet address required' });\n    }\n\n    // Basic email validation\n    if (email && !email.includes('@')) {\n      return res.status(400).json({ ok: false, error: 'Invalid email format' });\n    }\n\n    // Basic wallet validation\n    if (walletAddress) {\n      const isEth = walletAddress.startsWith('0x') && walletAddress.length === 42;\n      const isSolana = walletAddress.length >= 32 && walletAddress.length <= 44;\n      if (!isEth && !isSolana) {\n        return res.status(400).json({ ok: false, error: 'Invalid wallet address format' });\n      }\n    }\n\n    // Store in database (using execution ledger DB)\n    try {\n      const { addToWaitlist } = await import('../../execution-ledger/db');\n      const id = addToWaitlist({ email, walletAddress, source: source || 'landing' });\n\n      // Don't log actual email/wallet for privacy\n      console.log(`[waitlist] New signup from ${source || 'landing'}: ${id.slice(0, 8)}...`);\n\n      res.json({ ok: true, message: 'Successfully joined waitlist' });\n    } catch (dbError: any) {\n      // If addToWaitlist doesn't exist, store in memory as fallback\n      console.log(`[waitlist] DB storage failed, using fallback:`, dbError.message);\n\n      // In-memory fallback (for MVP)\n      const waitlistEntries = (global as any).__waitlist || [];\n      waitlistEntries.push({\n        id: `wl_${Date.now()}`,\n        email,\n        walletAddress,\n        source: source || 'landing',\n        createdAt: Date.now(),\n      });\n      (global as any).__waitlist = waitlistEntries;\n\n      res.json({ ok: true, message: 'Successfully joined waitlist' });\n    }\n  } catch (error: any) {\n    console.error('[waitlist] Join error:', error.message);\n    res.status(500).json({ ok: false, error: 'Failed to join waitlist' });\n  }\n});\n\n/**\n * GET /api/stats/public\n * Public read-only stats endpoint (no auth required)\n */\napp.get('/api/stats/public', async (req, res) => {\n  try {\n    const { getStatsSummary, getIntentStats } = await import('../../execution-ledger/db');\n\n    // Return limited public stats\n    const summary = getStatsSummary();\n    const intentStats = getIntentStats();\n\n    res.json({\n      ok: true,\n      data: {\n        totalIntents: intentStats.totalIntents || 0,\n        confirmedIntents: intentStats.confirmedIntents || 0,\n        totalExecutions: summary.totalExecutions || 0,\n        successfulExecutions: summary.successfulExecutions || 0,\n        successRate: summary.successRate || 0,\n        totalUsdRouted: summary.totalUsdRouted || 0,\n        chainsActive: summary.chainsActive || [],\n        lastUpdated: Date.now(),\n      },\n    });\n  } catch (error: any) {\n    // Return empty stats on error (don't expose internal errors)\n    res.json({\n      ok: true,\n      data: {\n        totalIntents: 0,\n        confirmedIntents: 0,\n        totalExecutions: 0,\n        successfulExecutions: 0,\n        successRate: 0,\n        totalUsdRouted: 0,\n        chainsActive: [],\n        lastUpdated: Date.now(),\n      },\n    });\n  }\n});\n\n// ============================================\n// OBSERVABILITY: Central Error Handler\n// ============================================\n\n/**\n * Central error handler for uncaught errors\n * - Logs full error details in dev only (stack/cause)\n * - Returns structured JSON response\n * - Includes correlationId for tracing\n */\napp.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {\n  const correlationId = req.correlationId || 'unknown';\n  \n  // Log error details (dev only for full stack)\n  const errorLog: Record<string, any> = {\n    correlationId,\n    name: err.name || 'Error',\n    message: err.message || 'Unknown error',\n    code: err.code,\n    path: req.path,\n    method: req.method,\n  };\n  \n  if (process.env.NODE_ENV !== 'production') {\n    errorLog.stack = err.stack;\n    errorLog.cause = err.cause;\n  }\n  \n  console.error(`[${correlationId}] [ERROR] Unhandled error:`, JSON.stringify(errorLog, null, 2));\n  \n  // Build response (don't expose stack in production)\n  const errorResponse: Record<string, any> = {\n    ok: false,\n    correlationId,\n    error: {\n      message: err.message || 'Internal server error',\n      code: err.code || 'INTERNAL_ERROR',\n    },\n  };\n  \n  if (process.env.NODE_ENV !== 'production') {\n    errorResponse.error.stack = err.stack;\n  }\n  \n  res.status(err.status || 500).json(errorResponse);\n});\n\n", "/**\n * LLM Client Service\n * Supports OpenAI, Anthropic, or stub mode\n */\n\nimport OpenAI from 'openai';\nimport Anthropic from '@anthropic-ai/sdk';\n\nexport interface LlmChatInput {\n  systemPrompt: string;\n  userPrompt: string;\n}\n\nexport interface LlmChatOutput {\n  assistantMessage: string;\n  rawJson: string; // the JSON the model returned for actions\n}\n\ntype ModelProvider = 'openai' | 'anthropic' | 'gemini' | 'stub';\n\nfunction getProvider(): ModelProvider {\n  const provider = process.env.BLOSSOM_MODEL_PROVIDER as ModelProvider;\n  if (provider === 'openai' || provider === 'anthropic' || provider === 'gemini') {\n    return provider;\n  }\n  return 'stub';\n}\n\n/**\n * Call LLM with structured JSON output\n */\nexport async function callLlm(input: LlmChatInput): Promise<LlmChatOutput> {\n  const provider = getProvider();\n  console.log('[llmClient] Using provider:', provider);\n\n  if (provider === 'stub') {\n    return {\n      assistantMessage: \"This is a stubbed Blossom response. No real AI model is configured. Set BLOSSOM_MODEL_PROVIDER and API keys to enable real AI.\",\n      rawJson: JSON.stringify({\n        assistantMessage: \"This is a stubbed Blossom response. No real AI model is configured.\",\n        actions: []\n      })\n    };\n  }\n\n  if (provider === 'openai') {\n    return callOpenAI(input);\n  }\n\n  if (provider === 'anthropic') {\n    return callAnthropic(input);\n  }\n\n  if (provider === 'gemini') {\n    return callGemini(input);\n  }\n\n  // Fallback to stub\n  return {\n    assistantMessage: \"LLM provider not configured correctly.\",\n    rawJson: JSON.stringify({ assistantMessage: \"Error\", actions: [] })\n  };\n}\n\n/**\n * Call OpenAI API\n */\nasync function callOpenAI(input: LlmChatInput): Promise<LlmChatOutput> {\n  const apiKey = process.env.BLOSSOM_OPENAI_API_KEY;\n  if (!apiKey) {\n    throw new Error('BLOSSOM_OPENAI_API_KEY is not set');\n  }\n\n  const model = process.env.BLOSSOM_OPENAI_MODEL || 'gpt-4o-mini';\n  const client = new OpenAI({ apiKey });\n\n  try {\n    const response = await client.chat.completions.create({\n      model,\n      messages: [\n        { role: 'system', content: input.systemPrompt },\n        { role: 'user', content: input.userPrompt }\n      ],\n      response_format: { type: 'json_object' },\n      temperature: 0.7,\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      throw new Error('No content in OpenAI response');\n    }\n\n    return {\n      assistantMessage: '', // Will be extracted from JSON\n      rawJson: content,\n    };\n  } catch (error: any) {\n    console.error('OpenAI API error:', error.message);\n    throw new Error(`OpenAI API error: ${error.message}`);\n  }\n}\n\n/**\n * Call Anthropic API\n */\nasync function callAnthropic(input: LlmChatInput): Promise<LlmChatOutput> {\n  const apiKey = process.env.BLOSSOM_ANTHROPIC_API_KEY;\n  if (!apiKey) {\n    throw new Error('BLOSSOM_ANTHROPIC_API_KEY is not set');\n  }\n\n  const model = process.env.BLOSSOM_ANTHROPIC_MODEL || 'claude-3-5-sonnet-20241022';\n  const client = new Anthropic({ apiKey });\n\n  try {\n    // Anthropic requires JSON in the system prompt or user message\n    const enhancedSystemPrompt = `${input.systemPrompt}\\n\\nYou MUST respond with ONLY a valid JSON object, no other text before or after.`;\n\n    const response = await client.messages.create({\n      model,\n      max_tokens: 4096,\n      system: enhancedSystemPrompt,\n      messages: [\n        { role: 'user', content: input.userPrompt }\n      ],\n    });\n\n    const content = response.content[0];\n    if (content.type !== 'text') {\n      throw new Error('Unexpected content type from Anthropic');\n    }\n\n    const text = content.text.trim();\n    \n    // Extract JSON if wrapped in markdown code blocks\n    let jsonText = text;\n    if (text.startsWith('```json')) {\n      jsonText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    } else if (text.startsWith('```')) {\n      jsonText = text.replace(/```\\n?/g, '').trim();\n    }\n\n    return {\n      assistantMessage: '', // Will be extracted from JSON\n      rawJson: jsonText,\n    };\n  } catch (error: any) {\n    console.error('Anthropic API error:', error.message);\n    throw new Error(`Anthropic API error: ${error.message}`);\n  }\n}\n\n/**\n * Call Google Gemini API\n */\nasync function callGemini(input: LlmChatInput): Promise<LlmChatOutput> {\n  const apiKey = process.env.BLOSSOM_GEMINI_API_KEY;\n  if (!apiKey) {\n    console.warn('[llmClient] Gemini key missing, falling back to stub');\n    // Fall back to stub instead of throwing error\n    return {\n      assistantMessage: \"This is a stubbed Blossom response. Gemini API key not configured. Set BLOSSOM_GEMINI_API_KEY to enable Gemini.\",\n      rawJson: JSON.stringify({\n        assistantMessage: \"This is a stubbed Blossom response. Gemini API key not configured.\",\n        actions: []\n      })\n    };\n  }\n\n  const model = process.env.BLOSSOM_GEMINI_MODEL || 'gemini-1.5-pro';\n  \n  try {\n    // Gemini API endpoint\n    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;\n    \n    const response = await fetch(url, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        contents: [\n          {\n            parts: [\n              { text: `${input.systemPrompt}\\n\\n${input.userPrompt}\\n\\nYou MUST respond with ONLY a valid JSON object, no other text before or after.` }\n            ]\n          }\n        ],\n        generationConfig: {\n          temperature: 0.7,\n          responseMimeType: 'application/json',\n        },\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`Gemini API error: ${response.status} ${errorText}`);\n    }\n\n    const result = await response.json();\n    const content = result.candidates?.[0]?.content?.parts?.[0]?.text;\n    \n    if (!content) {\n      throw new Error('No content in Gemini response');\n    }\n\n    // Extract JSON if wrapped in markdown code blocks\n    let jsonText = content.trim();\n    if (jsonText.startsWith('```json')) {\n      jsonText = jsonText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    } else if (jsonText.startsWith('```')) {\n      jsonText = jsonText.replace(/```\\n?/g, '').trim();\n    }\n\n    return {\n      assistantMessage: '', // Will be extracted from JSON\n      rawJson: jsonText,\n    };\n  } catch (error: any) {\n    console.error('Gemini API error:', error.message);\n    throw new Error(`Gemini API error: ${error.message}`);\n  }\n}\n\n", "/**\n * Perps Simulation Plugin\n * Simulates perpetual futures trading\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { PerpPosition, PerpsAccountState } from './types';\nimport { getPrice, PriceSymbol } from '../../services/prices';\n\n// Helper to extract base symbol from market\nfunction getBaseSymbolFromMarket(market: string): PriceSymbol {\n  const base = market.split('-')[0];\n  if (base === 'ETH') return 'ETH';\n  if (base === 'BTC') return 'BTC';\n  if (base === 'SOL') return 'SOL';\n  return 'ETH'; // Default fallback\n}\n\n// Initial account state\nconst INITIAL_BALANCES = [\n  { symbol: 'REDACTED', balanceUsd: 4000 },\n  { symbol: 'ETH', balanceUsd: 3000 },\n  { symbol: 'SOL', balanceUsd: 3000 },\n];\n\nlet accountState: PerpsAccountState = {\n  accountValueUsd: 10000,\n  balances: [...INITIAL_BALANCES],\n  positions: [],\n};\n\n/**\n * Open a perp position\n */\nexport async function openPerp(spec: {\n  market: string;\n  side: 'long' | 'short';\n  riskPct: number;\n  entry?: number;\n  takeProfit?: number;\n  stopLoss?: number;\n}): Promise<PerpPosition> {\n  const { market, side, riskPct, entry, takeProfit, stopLoss } = spec;\n\n  // Calculate size based on risk\n  const sizeUsd = accountState.accountValueUsd * (riskPct / 100);\n  \n  // Check REDACTED balance\n  const usdcBalance = accountState.balances.find(b => b.symbol === 'REDACTED');\n  if (!usdcBalance || usdcBalance.balanceUsd < sizeUsd) {\n    throw new Error(`Insufficient REDACTED balance. Need $${sizeUsd.toFixed(2)}, have $${usdcBalance?.balanceUsd.toFixed(2) || 0}`);\n  }\n\n  // Use provided entry or fetch real price\n  let entryPrice: number;\n  if (entry) {\n    entryPrice = entry;\n  } else {\n    const baseSymbol = getBaseSymbolFromMarket(market);\n    const priceSnapshot = await getPrice(baseSymbol);\n    entryPrice = priceSnapshot.priceUsd;\n  }\n  \n  // Calculate TP/SL if not provided (small deterministic move around entry)\n  const calculatedTP = takeProfit || (side === 'long' ? entryPrice * 1.04 : entryPrice * 0.96);\n  const calculatedSL = stopLoss || (side === 'long' ? entryPrice * 0.97 : entryPrice * 1.03);\n\n  // Deduct margin from REDACTED\n  usdcBalance.balanceUsd -= sizeUsd;\n\n  // Create position\n  const position: PerpPosition = {\n    id: uuidv4(),\n    market,\n    side,\n    sizeUsd,\n    entryPrice,\n    takeProfit: calculatedTP,\n    stopLoss: calculatedSL,\n    unrealizedPnlUsd: 0,\n    isClosed: false,\n  };\n\n  accountState.positions.push(position);\n  accountState.accountValueUsd = accountState.balances.reduce((sum, b) => sum + b.balanceUsd, 0);\n\n  return position;\n}\n\n/**\n * Close a perp position\n */\nexport async function closePerp(id: string): Promise<{ position: PerpPosition; pnl: number }> {\n  const position = accountState.positions.find(p => p.id === id && !p.isClosed);\n  if (!position) {\n    throw new Error(`Position ${id} not found or already closed`);\n  }\n\n  // Calculate PnL based on current price vs entry\n  const baseSymbol = getBaseSymbolFromMarket(position.market);\n  const currentPriceSnapshot = await getPrice(baseSymbol);\n  const currentPrice = currentPriceSnapshot.priceUsd;\n  \n  // Calculate PnL based on price movement\n  let pnlPct: number;\n  if (position.side === 'long') {\n    pnlPct = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;\n  } else {\n    pnlPct = ((position.entryPrice - currentPrice) / position.entryPrice) * 100;\n  }\n  \n  // Clamp to reasonable range for demo (between -2% and +2%)\n  pnlPct = Math.max(-2, Math.min(2, pnlPct));\n  \n  const realizedPnlUsd = (position.sizeUsd * pnlPct) / 100;\n\n  // Update position\n  position.isClosed = true;\n  position.closedAt = Date.now();\n  position.realizedPnlUsd = realizedPnlUsd;\n  position.unrealizedPnlUsd = 0;\n\n  // Credit REDACTED with size + PnL\n  const usdcBalance = accountState.balances.find(b => b.symbol === 'REDACTED');\n  if (usdcBalance) {\n    usdcBalance.balanceUsd += position.sizeUsd + realizedPnlUsd;\n  }\n\n  // Recalculate account value\n  accountState.accountValueUsd = accountState.balances.reduce((sum, b) => sum + b.balanceUsd, 0);\n\n  return { position, pnl: realizedPnlUsd };\n}\n\n/**\n * Get perps account snapshot\n */\nexport function getPerpsSnapshot(): PerpsAccountState {\n  // Calculate open exposure\n  const openPositions = accountState.positions.filter(p => !p.isClosed);\n  const openPerpExposureUsd = openPositions.reduce((sum, p) => sum + p.sizeUsd, 0);\n\n  return {\n    ...accountState,\n    positions: [...accountState.positions],\n  };\n}\n\n/**\n * Update REDACTED balance (for DeFi/Event sims to sync)\n */\nexport function updateUsdcBalance(delta: number): void {\n  const usdc = accountState.balances.find(b => b.symbol === 'REDACTED');\n  if (usdc) {\n    usdc.balanceUsd += delta;\n    accountState.accountValueUsd = accountState.balances.reduce((sum, b) => sum + b.balanceUsd, 0);\n  }\n}\n\n/**\n * Get current REDACTED balance\n */\nexport function getUsdcBalance(): number {\n  const usdc = accountState.balances.find(b => b.symbol === 'REDACTED');\n  return usdc?.balanceUsd || 0;\n}\n\n/**\n * Reset account to initial state (for testing)\n */\nexport function resetPerpsAccount(): void {\n  accountState = {\n    accountValueUsd: 10000,\n    balances: [...INITIAL_BALANCES],\n    positions: [],\n  };\n}\n\n", "/**\n * DeFi Simulation Plugin\n * Simulates DeFi yield farming positions\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { DefiPosition, DefiState } from './types';\n\n// Available vaults with APRs\nconst VAULTS = {\n  Kamino: { apr: 8.5, asset: 'REDACTED' },\n  RootsFi: { apr: 6.4, asset: 'REDACTED' },\n  Jet: { apr: 7.2, asset: 'REDACTED' },\n} as const;\n\nlet defiState: DefiState = {\n  positions: [],\n};\n\n// Reference to perps account for balance updates\nlet getUsdcBalance: () => number;\nlet updateUsdcBalance: (delta: number) => void;\n\nexport function setBalanceCallbacks(\n  getBalance: () => number,\n  updateBalance: (delta: number) => void\n): void {\n  getUsdcBalance = getBalance;\n  updateUsdcBalance = updateBalance;\n}\n\n/**\n * Open a DeFi position\n */\nexport function openDefiPosition(\n  protocol: 'Kamino' | 'RootsFi' | 'Jet',\n  asset: string,\n  amountUsd: number\n): DefiPosition {\n  const vault = VAULTS[protocol];\n  if (!vault) {\n    throw new Error(`Unknown protocol: ${protocol}`);\n  }\n\n  // Check REDACTED balance\n  const currentBalance = getUsdcBalance ? getUsdcBalance() : 0;\n  if (currentBalance < amountUsd) {\n    throw new Error(`Insufficient REDACTED balance. Need $${amountUsd.toFixed(2)}, have $${currentBalance.toFixed(2)}`);\n  }\n\n  // Deduct from REDACTED\n  if (updateUsdcBalance) {\n    updateUsdcBalance(-amountUsd);\n  }\n\n  // Create position\n  const position: DefiPosition = {\n    id: uuidv4(),\n    protocol,\n    asset: vault.asset,\n    depositUsd: amountUsd,\n    apr: vault.apr,\n    openedAt: Date.now(),\n    isClosed: false,\n  };\n\n  defiState.positions.push(position);\n  return position;\n}\n\n/**\n * Close a DeFi position\n */\nexport function closeDefiPosition(id: string): { position: DefiPosition; yieldEarned: number } {\n  const position = defiState.positions.find(p => p.id === id && !p.isClosed);\n  if (!position) {\n    throw new Error(`Position ${id} not found or already closed`);\n  }\n\n  // Calculate yield (simple pro-rata APR)\n  const elapsedMs = Date.now() - position.openedAt;\n  const elapsedDays = elapsedMs / (1000 * 60 * 60 * 24);\n  const yieldEarnedUsd = (position.depositUsd * position.apr * elapsedDays) / (100 * 365);\n\n  // Update position\n  position.isClosed = true;\n  position.closedAt = Date.now();\n  position.yieldEarnedUsd = yieldEarnedUsd;\n\n  // Credit REDACTED with deposit + yield\n  const totalReturn = position.depositUsd + yieldEarnedUsd;\n  if (updateUsdcBalance) {\n    updateUsdcBalance(totalReturn);\n  }\n\n  return { position, yieldEarned: yieldEarnedUsd };\n}\n\n/**\n * Get DeFi snapshot\n */\nexport function getDefiSnapshot(): DefiState {\n  return {\n    positions: [...defiState.positions],\n  };\n}\n\n/**\n * Reset DeFi state (for testing)\n */\nexport function resetDefiState(): void {\n  defiState = {\n    positions: [],\n  };\n}\n\n", "/**\n * Event Markets Simulation Plugin\n * Simulates event/prediction market positions\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { EventMarket, EventPosition, EventState } from './types';\nimport { fetchKalshiMarkets, fetchPolymarketMarkets, RawPredictionMarket } from '../../services/predictionData';\n\n// Seed markets matching FALLBACK_MARKETS (harmonized IDs)\nconst SEEDED_MARKETS: EventMarket[] = [\n  {\n    key: 'FED_CUTS_MAR_2025',\n    label: 'Fed cuts in March 2025',\n    winProbability: 0.62,\n    payoutMultiple: 1.6,\n  },\n  {\n    key: 'BTC_ETF_APPROVAL_2025',\n    label: 'BTC ETF approved by Dec 31',\n    winProbability: 0.68,\n    payoutMultiple: 1.47,\n  },\n  {\n    key: 'ETH_ETF_APPROVAL_2025',\n    label: 'ETH ETF approved by June 2025',\n    winProbability: 0.58,\n    payoutMultiple: 1.72,\n  },\n  {\n    key: 'TRUMP_2024_WIN',\n    label: 'Trump wins 2024 election',\n    winProbability: 0.52,\n    payoutMultiple: 1.92,\n  },\n  {\n    key: 'SOL_ADOPTION_2025',\n    label: 'Solana adoption surges in 2025',\n    winProbability: 0.64,\n    payoutMultiple: 1.56,\n  },\n  {\n    key: 'GENERIC_EVENT_DEMO',\n    label: 'Generic Event Demo',\n    winProbability: 0.50,\n    payoutMultiple: 1.5,\n  },\n];\n\nlet eventState: EventState = {\n  markets: [...SEEDED_MARKETS],\n  positions: [],\n};\n\n// Reference to perps account for balance updates\nlet getUsdcBalance: () => number;\nlet updateUsdcBalance: (delta: number) => void;\n\nexport function setBalanceCallbacks(\n  getBalance: () => number,\n  updateBalance: (delta: number) => void\n): void {\n  getUsdcBalance = getBalance;\n  updateUsdcBalance = updateBalance;\n}\n\n/**\n * Open an event position\n */\nexport async function openEventPosition(\n  eventKey: string,\n  side: 'YES' | 'NO',\n  stakeUsd: number,\n  label?: string // Optional label for live markets\n): Promise<EventPosition> {\n  let market = eventState.markets.find(m => m.key === eventKey);\n  \n  // If market not found in seeded markets, try to find it in live markets\n  if (!market) {\n    try {\n      const kalshiMarkets = await fetchKalshiMarkets();\n      const polymarketMarkets = await fetchPolymarketMarkets();\n      const allLiveMarkets = [...kalshiMarkets, ...polymarketMarkets];\n      \n      const liveMarket = allLiveMarkets.find(m => m.id === eventKey);\n      \n      if (liveMarket) {\n        // Create a temporary market entry for this live market\n        const yesPrice = liveMarket.yesPrice;\n        const winProbability = side === 'YES' ? yesPrice : 1 - yesPrice;\n        const payoutMultiple = 1 / winProbability; // Inverse of probability\n        \n        market = {\n          key: eventKey,\n          label: label || liveMarket.title,\n          winProbability,\n          payoutMultiple,\n        };\n        \n        // Add to state temporarily (won't persist across resets, but that's fine)\n        eventState.markets.push(market);\n        console.log(`[EventSim] Created temporary market entry for live market: ${market.label}`);\n      }\n    } catch (error) {\n      console.warn('[EventSim] Could not lookup live market:', error);\n    }\n  }\n  \n  if (!market) {\n    throw new Error(`Event market ${eventKey} not found in seeded or live markets`);\n  }\n\n  // Check REDACTED balance\n  const currentBalance = getUsdcBalance ? getUsdcBalance() : 0;\n  if (currentBalance < stakeUsd) {\n    throw new Error(`Insufficient REDACTED balance. Need $${stakeUsd.toFixed(2)}, have $${currentBalance.toFixed(2)}`);\n  }\n\n  // Try to find matching live market for mark-to-market tracking\n  let marketSource: 'KALSHI' | 'POLYMARKET' | 'DEMO' = 'DEMO';\n  let externalMarketId: string | undefined = undefined;\n\n  try {\n    const kalshiMarkets = await fetchKalshiMarkets();\n    const polymarketMarkets = await fetchPolymarketMarkets();\n    const allLiveMarkets = [...kalshiMarkets, ...polymarketMarkets];\n    \n    // Try to match by title (fuzzy match)\n    const matchedMarket = allLiveMarkets.find(m => \n      m.title.toLowerCase().includes(market.label.toLowerCase()) ||\n      market.label.toLowerCase().includes(m.title.toLowerCase())\n    );\n\n    if (matchedMarket) {\n      marketSource = matchedMarket.source;\n      externalMarketId = matchedMarket.id;\n    }\n  } catch (error) {\n    // Silently fall back to DEMO if live market lookup fails\n    console.warn('[EventSim] Could not match to live market, using DEMO source');\n  }\n\n  // Deduct stake from REDACTED\n  if (updateUsdcBalance) {\n    updateUsdcBalance(-stakeUsd);\n  }\n\n  // Calculate max payout and loss\n  const maxPayoutUsd = stakeUsd * market.payoutMultiple;\n  const maxLossUsd = stakeUsd;\n\n  // Create position\n  const position: EventPosition = {\n    id: uuidv4(),\n    eventKey,\n    label: market.label,\n    side,\n    stakeUsd,\n    maxPayoutUsd,\n    maxLossUsd,\n    isClosed: false,\n    marketSource,\n    externalMarketId,\n  };\n\n  eventState.positions.push(position);\n  return position;\n}\n\n/**\n * Get live market price for an event position (if available)\n */\nexport async function getLiveEventPrice(position: EventPosition): Promise<number | undefined> {\n  if (!position.externalMarketId || !position.marketSource || position.marketSource === 'DEMO') {\n    return undefined;\n  }\n\n  try {\n    const markets = position.marketSource === 'KALSHI'\n      ? await fetchKalshiMarkets()\n      : await fetchPolymarketMarkets();\n    \n    const liveMarket = markets.find(m => m.id === position.externalMarketId);\n    if (liveMarket) {\n      return liveMarket.yesPrice; // Return current YES probability\n    }\n  } catch (error) {\n    console.warn(`[EventSim] Failed to fetch live price for position ${position.id}:`, error);\n  }\n\n  return undefined;\n}\n\n/**\n * Update an event position's stake\n */\nexport async function updateEventStake(params: {\n  positionId: string;\n  newStakeUsd: number;\n  overrideRiskCap: boolean;\n  requestedStakeUsd?: number;\n}): Promise<EventPosition> {\n  const position = eventState.positions.find(p => p.id === params.positionId && !p.isClosed);\n  if (!position) {\n    throw new Error(`Event position ${params.positionId} not found or already closed`);\n  }\n\n  const currentBalance = getUsdcBalance ? getUsdcBalance() : 0;\n  const stakeDelta = params.newStakeUsd - position.stakeUsd;\n\n  // Check if we have enough balance for the increase\n  if (stakeDelta > 0 && currentBalance < stakeDelta) {\n    throw new Error(`Insufficient REDACTED balance. Need $${stakeDelta.toFixed(2)} more, have $${currentBalance.toFixed(2)}`);\n  }\n\n  // Find the market to recalculate payout\n  const market = eventState.markets.find(m => m.key === position.eventKey);\n  if (!market) {\n    throw new Error(`Market ${position.eventKey} not found`);\n  }\n\n  // Update REDACTED balance\n  if (updateUsdcBalance) {\n    updateUsdcBalance(-stakeDelta);\n  }\n\n  // Recalculate max payout and loss\n  const maxPayoutUsd = params.newStakeUsd * market.payoutMultiple;\n  const maxLossUsd = params.newStakeUsd;\n\n  // Update position\n  position.stakeUsd = params.newStakeUsd;\n  position.maxPayoutUsd = maxPayoutUsd;\n  position.maxLossUsd = maxLossUsd;\n  position.overrideRiskCap = params.overrideRiskCap;\n  if (params.requestedStakeUsd !== undefined) {\n    position.requestedStakeUsd = params.requestedStakeUsd;\n  }\n\n  return position;\n}\n\n/**\n * Close an event position\n */\nexport async function closeEventPosition(id: string): Promise<{ position: EventPosition; pnl: number; liveMarkToMarketUsd?: number }> {\n  const position = eventState.positions.find(p => p.id === id && !p.isClosed);\n  if (!position) {\n    throw new Error(`Position ${id} not found or already closed`);\n  }\n\n  const market = eventState.markets.find(m => m.key === position.eventKey);\n  if (!market) {\n    throw new Error(`Market ${position.eventKey} not found`);\n  }\n\n  // Try to get live mark-to-market price\n  let liveMarkToMarketUsd: number | undefined = undefined;\n  try {\n    const currentProb = await getLiveEventPrice(position);\n    if (currentProb !== undefined) {\n      // Calculate what PnL would be if settled at current market price\n      if (position.side === 'YES') {\n        // If YES wins at current prob, payout = stake * (1 / currentProb)\n        // Mark-to-market value = current payout value - stake\n        const currentPayoutValue = position.stakeUsd * (1 / currentProb);\n        liveMarkToMarketUsd = currentPayoutValue - position.stakeUsd;\n      } else {\n        // If NO wins at (1 - currentProb), payout = stake * (1 / (1 - currentProb))\n        const currentPayoutValue = position.stakeUsd * (1 / (1 - currentProb));\n        liveMarkToMarketUsd = currentPayoutValue - position.stakeUsd;\n      }\n    }\n  } catch (error) {\n    // Silently ignore mark-to-market errors\n    console.warn(`[EventSim] Could not compute live mark-to-market:`, error);\n  }\n\n  // Sample outcome using win probability (existing behavior)\n  const isWin = Math.random() < market.winProbability;\n  const outcome: 'won' | 'lost' = isWin ? 'won' : 'lost';\n\n  // Calculate PnL\n  let realizedPnlUsd: number;\n  if (isWin) {\n    realizedPnlUsd = position.maxPayoutUsd - position.stakeUsd; // Profit\n    // Credit max payout to REDACTED\n    if (updateUsdcBalance) {\n      updateUsdcBalance(position.maxPayoutUsd);\n    }\n  } else {\n    realizedPnlUsd = -position.stakeUsd; // Loss (stake already deducted)\n    // No refund\n  }\n\n  // Update position\n  position.isClosed = true;\n  position.closedAt = Date.now();\n  position.outcome = outcome;\n  position.realizedPnlUsd = realizedPnlUsd;\n\n  return { position, pnl: realizedPnlUsd, liveMarkToMarketUsd };\n}\n\n/**\n * Get event snapshot\n */\nexport function getEventSnapshot(): EventState {\n  const openPositions = eventState.positions.filter(p => !p.isClosed);\n  const eventExposureUsd = openPositions.reduce((sum, p) => sum + p.stakeUsd, 0);\n\n  return {\n    markets: [...eventState.markets],\n    positions: [...eventState.positions],\n  };\n}\n\n/**\n * Get total event exposure\n */\nexport function getEventExposureUsd(): number {\n  const openPositions = eventState.positions.filter(p => !p.isClosed);\n  return openPositions.reduce((sum, p) => sum + p.stakeUsd, 0);\n}\n\n/**\n * Reset event state (for testing)\n */\nexport function resetEventState(): void {\n  eventState = {\n    markets: [...SEEDED_MARKETS],\n    positions: [],\n  };\n}\n\n", "/**\n * Centralized State Management\n * Helper functions for resetting and building portfolio snapshots\n */\n\nimport * as perpsSim from '../plugins/perps-sim';\nimport * as defiSim from '../plugins/defi-sim';\nimport * as eventSim from '../plugins/event-sim';\nimport { BlossomPortfolioSnapshot } from '../types/blossom';\n\n/**\n * Reset all simulation states to initial\n */\nexport function resetAllSims(): void {\n  perpsSim.resetPerpsAccount();\n  defiSim.resetDefiState();\n  eventSim.resetEventState();\n}\n\n/**\n * Build a fresh portfolio snapshot from all sims\n */\nexport function getPortfolioSnapshot(): BlossomPortfolioSnapshot {\n  const perpsSnapshot = perpsSim.getPerpsSnapshot();\n  const defiSnapshot = defiSim.getDefiSnapshot();\n  const eventSnapshot = eventSim.getEventSnapshot();\n  const eventExposureUsd = eventSim.getEventExposureUsd();\n\n  // Calculate open perp exposure\n  const openPerpExposureUsd = perpsSnapshot.positions\n    .filter(p => !p.isClosed)\n    .reduce((sum, p) => sum + p.sizeUsd, 0);\n\n  // Build strategies array (combine all position types)\n  const strategies = [\n    ...perpsSnapshot.positions.map(p => ({\n      type: 'perp' as const,\n      status: p.isClosed ? 'closed' : 'executed',\n      ...p,\n    })),\n    ...defiSnapshot.positions.map(p => ({\n      type: 'defi' as const,\n      status: p.isClosed ? 'closed' : 'active',\n      ...p,\n    })),\n    ...eventSnapshot.positions.map(p => ({\n      type: 'event' as const,\n      status: p.isClosed ? 'closed' : 'executed',\n      ...p,\n    })),\n  ];\n\n  return {\n    accountValueUsd: perpsSnapshot.accountValueUsd,\n    balances: perpsSnapshot.balances,\n    openPerpExposureUsd,\n    eventExposureUsd,\n    defiPositions: defiSnapshot.positions.map(p => ({\n      id: p.id,\n      protocol: p.protocol,\n      asset: p.asset,\n      depositUsd: p.depositUsd,\n      apr: p.apr,\n      openedAt: p.openedAt,\n      isClosed: p.isClosed,\n    })),\n    strategies,\n  };\n}\n\n", "/**\n * Ticker Service\n * Provides live price ticker for on-chain assets and event markets\n */\n\nimport { getPrice, PriceSymbol } from './prices';\nimport { getEventSnapshot } from '../plugins/event-sim';\nimport { fetchKalshiMarkets, fetchPolymarketMarkets, RawPredictionMarket } from './predictionData';\nimport { getMarketDataProvider } from '../providers/providerRegistry';\nimport { DFLOW_ENABLED } from '../config';\n\n// Unified ticker item structure\nexport interface TickerItem {\n  label: string;      // e.g. \"BTC\" or \"Fed cuts in March 2025\"\n  value: string;     // e.g. \"$60,000\" or \"62%\"\n  change?: string;   // e.g. \"+2.5%\" or \"+8% prob\"\n  meta?: string;     // e.g. \"24h\", \"Kalshi\", \"Polymarket\", \"DeFi\"\n  impliedProb?: number; // 0\u20131, for event markets\n  lean?: 'YES' | 'NO'; // For event markets: indicates YES or NO leaning\n}\n\nexport interface TickerSection {\n  id: 'majors' | 'gainers' | 'defi' | 'kalshi' | 'polymarket';\n  label: string;      // \"Majors\", \"Top gainers (24h)\", etc.\n  items: TickerItem[];\n}\n\nexport interface TickerPayload {\n  venue: 'hyperliquid' | 'event_demo';\n  sections: TickerSection[];\n  lastUpdatedMs?: number;\n  isLive?: boolean;\n  source?: 'coingecko' | 'static' | 'snapshot' | 'kalshi' | 'polymarket';\n}\n\n// Legacy interfaces for backward compatibility\nexport interface OnchainTickerItem {\n  symbol: string;\n  priceUsd: number;\n  change24hPct: number;\n}\n\nexport interface EventTickerItem {\n  id: string;\n  label: string;\n  impliedProb: number;\n  source: 'Kalshi' | 'Polymarket' | 'Demo';\n}\n\n// Static fallback for on-chain ticker\nconst STATIC_ONCHAIN_TICKER: OnchainTickerItem[] = [\n  { symbol: 'BTC', priceUsd: 60000, change24hPct: 2.5 },\n  { symbol: 'ETH', priceUsd: 3000, change24hPct: 1.8 },\n  { symbol: 'SOL', priceUsd: 150, change24hPct: -0.5 },\n  { symbol: 'AVAX', priceUsd: 35, change24hPct: 3.2 },\n  { symbol: 'LINK', priceUsd: 14, change24hPct: 0.8 },\n];\n\n// Static fallback for event markets\nconst STATIC_EVENT_TICKER: EventTickerItem[] = [\n  { id: 'FED_CUTS_MAR_2025', label: 'Fed cuts in March 2025', impliedProb: 0.62, source: 'Kalshi' },\n  { id: 'BTC_ETF_APPROVAL_2025', label: 'BTC ETF approved by Dec 31', impliedProb: 0.68, source: 'Kalshi' },\n  { id: 'ETH_ETF_APPROVAL_2025', label: 'ETH ETF approved by June 2025', impliedProb: 0.58, source: 'Kalshi' },\n  { id: 'US_ELECTION_2024', label: 'US Election Winner 2024', impliedProb: 0.50, source: 'Polymarket' },\n  { id: 'CRYPTO_MCAP_THRESHOLD', label: 'Crypto market cap above $3T by year-end', impliedProb: 0.52, source: 'Polymarket' },\n];\n\n/**\n * Get on-chain ticker (crypto prices) - new unified format\n */\nexport async function getOnchainTicker(): Promise<TickerPayload> {\n  const symbols: PriceSymbol[] = ['BTC', 'ETH', 'SOL', 'AVAX', 'LINK'];\n  const priceData: Array<{ symbol: string; priceUsd: number; change24hPct: number; source: 'coingecko' | 'static' }> = [];\n  let hasLiveData = false;\n  let hasStaticFallback = false;\n\n  try {\n    for (const symbol of symbols) {\n      try {\n        const snapshot = await getPrice(symbol);\n        const change24hPct = getMock24hChange(symbol);\n        \n        priceData.push({\n          symbol,\n          priceUsd: snapshot.priceUsd,\n          change24hPct,\n          source: snapshot.source,\n        });\n        \n        if (snapshot.source === 'coingecko') {\n          hasLiveData = true;\n        } else {\n          hasStaticFallback = true;\n        }\n      } catch (error) {\n        console.warn(`Failed to fetch ${symbol} price:`, error);\n        const staticItem = STATIC_ONCHAIN_TICKER.find(item => item.symbol === symbol);\n        if (staticItem) {\n          priceData.push({\n            ...staticItem,\n            source: 'static',\n          });\n          hasStaticFallback = true;\n        }\n      }\n    }\n\n    // If we have no data, use static fallback\n    const allPrices = priceData.length > 0 ? priceData : STATIC_ONCHAIN_TICKER;\n\n    // Section 1: Majors\n    const majorsItems: TickerItem[] = allPrices.map(item => ({\n      label: item.symbol,\n      value: `$${item.priceUsd.toLocaleString(undefined, { maximumFractionDigits: 0 })}`,\n      change: `${item.change24hPct >= 0 ? '+' : ''}${item.change24hPct.toFixed(1)}%`,\n      meta: '24h',\n    }));\n\n    // Section 2: Top gainers (sort by 24h change desc, take top 4)\n    const gainers = [...allPrices]\n      .sort((a, b) => b.change24hPct - a.change24hPct)\n      .slice(0, 4)\n      .map(item => ({\n        label: item.symbol,\n        value: `$${item.priceUsd.toLocaleString(undefined, { maximumFractionDigits: 0 })}`,\n        change: `+${item.change24hPct.toFixed(1)}%`,\n        meta: 'Top gainer',\n      }));\n\n    // Section 3: DeFi protocols (stub data)\n    const defiItems: TickerItem[] = [\n      { label: 'Lido', value: '$28B TVL', meta: 'DeFi' },\n      { label: 'Aave', value: '$12B TVL', meta: 'DeFi' },\n      { label: 'Uniswap', value: '$8.5B TVL', meta: 'DeFi' },\n      { label: 'Maker', value: '$6.2B TVL', meta: 'DeFi' },\n    ];\n\n    return {\n      venue: 'hyperliquid',\n      sections: [\n        { id: 'majors', label: 'Majors', items: majorsItems },\n        { id: 'gainers', label: 'Top gainers (24h)', items: gainers },\n        { id: 'defi', label: 'DeFi TVL', items: defiItems },\n      ],\n      lastUpdatedMs: Date.now(),\n      // isLive is true only if we have at least one CoinGecko fetch (not cached static)\n      isLive: hasLiveData,\n      source: hasLiveData ? 'coingecko' : 'static',\n    };\n  } catch (error) {\n    console.error('Failed to build on-chain ticker, using static fallback:', error);\n    // Return fallback payload\n    return {\n      venue: 'hyperliquid',\n      sections: [\n        {\n          id: 'majors',\n          label: 'Majors',\n          items: STATIC_ONCHAIN_TICKER.map(item => ({\n            label: item.symbol,\n            value: `$${item.priceUsd.toLocaleString(undefined, { maximumFractionDigits: 0 })}`,\n            change: `${item.change24hPct >= 0 ? '+' : ''}${item.change24hPct.toFixed(1)}%`,\n            meta: '24h',\n          })),\n        },\n      ],\n      lastUpdatedMs: Date.now(),\n      isLive: false,\n      source: 'static',\n    };\n  }\n}\n\n/**\n * Get event markets ticker - new unified format with live data support\n * Uses dFlow provider if enabled, falls back to Polymarket/Kalshi\n */\nexport async function getEventMarketsTicker(): Promise<TickerPayload> {\n  try {\n    // Try dFlow provider first if enabled\n    if (DFLOW_ENABLED) {\n      try {\n        const provider = getMarketDataProvider();\n        if (provider.name === 'dflow' && provider.isAvailable()) {\n          const dflowMarkets = await provider.getEventMarkets();\n          if (dflowMarkets.length > 0) {\n            const topMarkets = dflowMarkets.slice(0, 12);\n            const tickerItems: TickerItem[] = topMarkets.map(market => {\n              const impliedProb = market.yesPrice;\n              const lean: 'YES' | 'NO' = impliedProb >= 0.5 ? 'YES' : 'NO';\n              return {\n                label: market.title,\n                value: `${Math.round(impliedProb * 100)}%`,\n                impliedProb,\n                meta: 'dFlow',\n                lean,\n              };\n            });\n            \n            return {\n              venue: 'event_demo',\n              sections: [{ id: 'kalshi' as const, label: 'Markets (dFlow)', items: tickerItems }],\n              lastUpdatedMs: Date.now(),\n              isLive: true,\n              source: 'kalshi', // Use kalshi as source type for compatibility\n            };\n          }\n        }\n      } catch (error: any) {\n        console.warn('[getEventMarketsTicker] dFlow provider failed, falling back:', error.message);\n      }\n    }\n    \n    // Fallback: Prefer Polymarket public feed first (no keys), then Kalshi if configured\n    const polymarketMarkets = await fetchPolymarketMarkets();\n    const kalshiMarkets = await fetchKalshiMarkets();\n    \n    // Check if we have any live data\n    const hasLivePolymarket = polymarketMarkets.some(m => m.isLive);\n    const hasLiveKalshi = kalshiMarkets.some(m => m.isLive);\n    const hasLiveData = hasLivePolymarket || hasLiveKalshi;\n    \n    // Merge and sort by volume/open interest\n    const allMarkets: RawPredictionMarket[] = [...kalshiMarkets, ...polymarketMarkets];\n    const sorted = allMarkets.sort((a, b) => {\n      const aValue = a.openInterestUsd || a.volume24hUsd || 0;\n      const bValue = b.openInterestUsd || b.volume24hUsd || 0;\n      return bValue - aValue;\n    });\n\n    // Take top 10-12 markets\n    const topMarkets = sorted.slice(0, 12);\n\n    if (topMarkets.length > 0) {\n      // Convert to TickerItems\n      const tickerItems: TickerItem[] = topMarkets.map(market => {\n        const impliedProb = market.yesPrice;\n        const lean: 'YES' | 'NO' = impliedProb >= 0.5 ? 'YES' : 'NO';\n\n        return {\n          label: market.title,\n          value: `${Math.round(impliedProb * 100)}%`,\n          impliedProb,\n          meta: market.source,\n          lean,\n        };\n      });\n\n      // Group by source for sections\n      const kalshiItems = tickerItems.filter(item => item.meta === 'KALSHI');\n      const polymarketItems = tickerItems.filter(item => item.meta === 'POLYMARKET');\n\n      const sections: TickerSection[] = [];\n      if (kalshiItems.length > 0) {\n        sections.push({ id: 'kalshi', label: 'Kalshi', items: kalshiItems });\n      }\n      if (polymarketItems.length > 0) {\n        sections.push({ id: 'polymarket', label: 'Polymarket', items: polymarketItems });\n      }\n\n      return {\n        venue: 'event_demo',\n        sections: sections.length > 0 ? sections : [\n          { id: 'kalshi', label: 'Kalshi', items: kalshiItems },\n          { id: 'polymarket', label: 'Polymarket', items: polymarketItems },\n        ],\n        lastUpdatedMs: Date.now(),\n        isLive: hasLiveData,\n        source: hasLivePolymarket ? 'polymarket' : hasLiveKalshi ? 'kalshi' : 'static',\n      };\n    }\n\n    // Fallback to seeded markets if no live data\n    const eventSnapshot = getEventSnapshot();\n    const allMarketsSeeded = eventSnapshot.markets;\n\n    // Separate markets by source\n    const kalshiMarketsSeeded: Array<{ label: string; impliedProb: number }> = [];\n    const polymarketMarketsSeeded: Array<{ label: string; impliedProb: number }> = [];\n\n    for (const market of allMarketsSeeded) {\n      let source: 'Kalshi' | 'Polymarket' | 'Demo' = 'Demo';\n      if (market.key.includes('FED') || market.key.includes('ETF')) {\n        source = 'Kalshi';\n      } else if (market.key.includes('ELECTION') || market.key.includes('MCAP')) {\n        source = 'Polymarket';\n      }\n\n      const item = {\n        label: market.label,\n        impliedProb: market.winProbability,\n      };\n\n      if (source === 'Kalshi') {\n        kalshiMarketsSeeded.push(item);\n      } else if (source === 'Polymarket') {\n        polymarketMarketsSeeded.push(item);\n      }\n    }\n\n    // Convert to TickerItems\n    const kalshiItems: TickerItem[] = kalshiMarketsSeeded.slice(0, 4).map(m => ({\n      label: m.label,\n      value: `${Math.round(m.impliedProb * 100)}%`,\n      impliedProb: m.impliedProb,\n      meta: 'Kalshi',\n      lean: m.impliedProb > 0.5 ? 'YES' : 'NO',\n    }));\n\n    const polymarketItems: TickerItem[] = polymarketMarketsSeeded.slice(0, 4).map(m => ({\n      label: m.label,\n      value: `${Math.round(m.impliedProb * 100)}%`,\n      impliedProb: m.impliedProb,\n      meta: 'Polymarket',\n      lean: m.impliedProb > 0.5 ? 'YES' : 'NO',\n    }));\n\n    // If no markets found, use static fallback\n    if (kalshiItems.length === 0 && polymarketItems.length === 0) {\n      return {\n        venue: 'event_demo',\n        sections: [\n          {\n            id: 'kalshi',\n            label: 'Kalshi',\n            items: STATIC_EVENT_TICKER.filter(item => item.source === 'Kalshi').slice(0, 4).map(item => ({\n              label: item.label,\n              value: `${Math.round(item.impliedProb * 100)}%`,\n              meta: 'Kalshi',\n              lean: item.impliedProb > 0.5 ? 'YES' : 'NO',\n            })),\n          },\n          {\n            id: 'polymarket',\n            label: 'Polymarket',\n            items: STATIC_EVENT_TICKER.filter(item => item.source === 'Polymarket').slice(0, 4).map(item => ({\n              label: item.label,\n              value: `${Math.round(item.impliedProb * 100)}%`,\n              meta: 'Polymarket',\n              lean: item.impliedProb > 0.5 ? 'YES' : 'NO',\n            })),\n          },\n        ],\n        lastUpdatedMs: Date.now(),\n        isLive: false,\n        source: 'static',\n      };\n    }\n\n    const sections: TickerSection[] = [];\n    if (kalshiItems.length > 0) {\n      sections.push({ id: 'kalshi', label: 'Kalshi', items: kalshiItems });\n    }\n    if (polymarketItems.length > 0) {\n      sections.push({ id: 'polymarket', label: 'Polymarket', items: polymarketItems });\n    }\n\n    return {\n      venue: 'event_demo',\n      sections,\n      lastUpdatedMs: Date.now(),\n      isLive: hasLiveData,\n      source: hasLiveKalshi ? 'kalshi' : hasLivePolymarket ? 'polymarket' : 'snapshot',\n    };\n  } catch (error) {\n    console.error('Failed to build event markets ticker, using static fallback:', error);\n    return {\n      venue: 'event_demo',\n      sections: [\n          {\n            id: 'kalshi',\n            label: 'Kalshi',\n            items: STATIC_EVENT_TICKER.filter(item => item.source === 'Kalshi').slice(0, 4).map(item => ({\n              label: item.label,\n              value: `${Math.round(item.impliedProb * 100)}%`,\n              meta: 'Kalshi',\n              lean: item.impliedProb > 0.5 ? 'YES' : 'NO',\n            })),\n          },\n          {\n            id: 'polymarket',\n            label: 'Polymarket',\n            items: STATIC_EVENT_TICKER.filter(item => item.source === 'Polymarket').slice(0, 4).map(item => ({\n              label: item.label,\n              value: `${Math.round(item.impliedProb * 100)}%`,\n              meta: 'Polymarket',\n              lean: item.impliedProb > 0.5 ? 'YES' : 'NO',\n            })),\n          },\n      ],\n      lastUpdatedMs: Date.now(),\n      isLive: false,\n      source: 'static',\n    };\n  }\n}\n\n/**\n * Mock 24h change for demo purposes\n */\nfunction getMock24hChange(symbol: PriceSymbol): number {\n  const changes: Record<PriceSymbol, number> = {\n    BTC: 2.5,\n    ETH: 1.8,\n    SOL: -0.5,\n    REDACTED: 0,\n    AVAX: 3.2,\n    LINK: 0.8,\n  };\n  return changes[symbol] ?? 0;\n}\n\n", "/**\n * dFlow Provider Implementation\n * Provides market data and quotes from dFlow API\n */\n\nimport {\n  MarketDataProvider,\n  QuoteProvider,\n  NormalizedEventMarket,\n  NormalizedEventQuote,\n  NormalizedSwapQuote,\n} from './types';\nimport {\n  isDflowConfigured,\n  isDflowCapabilityAvailable,\n  getEventMarkets as dflowGetEventMarkets,\n  getEventQuote as dflowGetEventQuote,\n  getSwapQuote as dflowGetSwapQuote,\n  DflowEventMarket,\n} from '../integrations/dflow/dflowClient';\n\n/**\n * dFlow Market Data Provider\n */\nexport class DflowMarketDataProvider implements MarketDataProvider {\n  name = 'dflow';\n\n  isAvailable(): boolean {\n    return isDflowCapabilityAvailable('eventsMarkets');\n  }\n\n  async getEventMarkets(): Promise<NormalizedEventMarket[]> {\n    if (!this.isAvailable()) {\n      return [];\n    }\n\n    const response = await dflowGetEventMarkets();\n    if (!response.ok || !response.data) {\n      console.warn('[DflowMarketDataProvider] Failed to fetch markets:', response.error);\n      return [];\n    }\n\n    return response.data.map((market: DflowEventMarket) => ({\n      id: market.id,\n      title: market.title,\n      yesPrice: market.yesPrice,\n      noPrice: market.noPrice,\n      volume24hUsd: market.volume24hUsd,\n      openInterestUsd: market.openInterestUsd,\n      liquidity: market.liquidity,\n      spread: market.spread,\n      source: 'dflow',\n      isLive: true,\n    }));\n  }\n}\n\n/**\n * dFlow Quote Provider\n */\nexport class DflowQuoteProvider implements QuoteProvider {\n  name = 'dflow';\n\n  isAvailable(): boolean {\n    return isDflowConfigured();\n  }\n\n  async getSwapQuote(params: {\n    tokenIn: string;\n    tokenOut: string;\n    amountIn: string;\n    slippageBps?: number;\n    chainId?: number;\n  }): Promise<NormalizedSwapQuote | null> {\n    if (!isDflowCapabilityAvailable('swapsQuotes')) {\n      return null;\n    }\n\n    const response = await dflowGetSwapQuote({\n      tokenIn: params.tokenIn,\n      tokenOut: params.tokenOut,\n      amountIn: params.amountIn,\n      slippageBps: params.slippageBps,\n      chainId: params.chainId,\n    });\n\n    if (!response.ok || !response.data) {\n      console.warn('[DflowQuoteProvider] Failed to get swap quote:', response.error);\n      return null;\n    }\n\n    const quote = response.data;\n    return {\n      tokenIn: quote.tokenIn,\n      tokenOut: quote.tokenOut,\n      amountIn: quote.amountIn,\n      amountOut: quote.amountOut,\n      minAmountOut: quote.minAmountOut,\n      slippageBps: quote.slippageBps,\n      route: quote.route,\n      routeSummary: quote.routeSummary,\n      gas: quote.gas,\n      priceImpact: quote.priceImpact,\n      source: 'dflow',\n    };\n  }\n\n  async getEventQuote(params: {\n    marketId: string;\n    outcome: 'YES' | 'NO';\n    amount: number;\n  }): Promise<NormalizedEventQuote | null> {\n    if (!isDflowCapabilityAvailable('eventsQuotes')) {\n      return null;\n    }\n\n    const response = await dflowGetEventQuote(params);\n\n    if (!response.ok || !response.data) {\n      console.warn('[DflowQuoteProvider] Failed to get event quote:', response.error);\n      return null;\n    }\n\n    const quote = response.data;\n    return {\n      marketId: quote.marketId,\n      marketTitle: '', // Would need to be fetched or passed in\n      outcome: quote.outcome,\n      price: quote.price,\n      impliedProbability: quote.impliedProbability,\n      liquidity: quote.liquidity,\n      spread: quote.spread,\n      estimatedFees: quote.estimatedFees,\n      source: 'dflow',\n    };\n  }\n}\n\n\n", "/**\n * Fallback Provider Implementations\n * Wraps existing Polymarket/Kalshi and 1inch/deterministic functionality\n */\n\nimport {\n  MarketDataProvider,\n  QuoteProvider,\n  NormalizedEventMarket,\n  NormalizedSwapQuote,\n} from './types';\nimport { fetchKalshiMarkets, fetchPolymarketMarkets, RawPredictionMarket } from '../services/predictionData';\nimport { getSwapRoutingDecision as get1inchRoutingDecision, RoutingDecision } from '../quotes/evmQuote';\nimport { DEFAULT_SWAP_SLIPPAGE_BPS, ROUTING_MODE } from '../config';\n\n/**\n * Convert RawPredictionMarket to NormalizedEventMarket\n */\nfunction normalizeMarket(market: RawPredictionMarket): NormalizedEventMarket {\n  return {\n    id: market.id,\n    title: market.title,\n    yesPrice: market.yesPrice,\n    noPrice: market.noPrice,\n    volume24hUsd: market.volume24hUsd,\n    openInterestUsd: market.openInterestUsd,\n    source: market.source.toLowerCase(),\n    isLive: market.isLive || false,\n  };\n}\n\n/**\n * Fallback Market Data Provider (Polymarket + Kalshi)\n */\nexport class FallbackMarketDataProvider implements MarketDataProvider {\n  name = 'fallback';\n\n  isAvailable(): boolean {\n    return true; // Always available (has static fallback)\n  }\n\n  async getEventMarkets(): Promise<NormalizedEventMarket[]> {\n    try {\n      const [kalshiMarkets, polymarketMarkets] = await Promise.all([\n        fetchKalshiMarkets(),\n        fetchPolymarketMarkets(),\n      ]);\n\n      const normalized = [\n        ...kalshiMarkets.map(normalizeMarket),\n        ...polymarketMarkets.map(normalizeMarket),\n      ];\n\n      // Sort by volume/liquidity\n      return normalized.sort((a, b) => {\n        const aValue = a.volume24hUsd || a.openInterestUsd || 0;\n        const bValue = b.volume24hUsd || b.openInterestUsd || 0;\n        return bValue - aValue;\n      });\n    } catch (error: any) {\n      console.warn('[FallbackMarketDataProvider] Error fetching markets:', error.message);\n      return [];\n    }\n  }\n}\n\n/**\n * Fallback Quote Provider (1inch + deterministic)\n */\nexport class FallbackQuoteProvider implements QuoteProvider {\n  name = 'fallback';\n\n  isAvailable(): boolean {\n    return true; // Always available (has deterministic fallback)\n  }\n\n  async getSwapQuote(params: {\n    tokenIn: string;\n    tokenOut: string;\n    amountIn: string;\n    slippageBps?: number;\n    chainId?: number;\n  }): Promise<NormalizedSwapQuote | null> {\n    try {\n      // Determine token symbols and decimals based on known addresses\n      // For demo tokens, we know the symbols\n      const tokenInSymbol = params.tokenIn.toLowerCase().includes('usdc') ? 'REDACTED' : 'WETH';\n      const tokenOutSymbol = params.tokenOut.toLowerCase().includes('usdc') ? 'REDACTED' : 'WETH';\n      const tokenInDecimals = tokenInSymbol === 'REDACTED' ? 6 : 18;\n      const tokenOutDecimals = tokenOutSymbol === 'REDACTED' ? 6 : 18;\n      \n      // Use the existing routing decision function which handles 1inch and fallback\n      const decision: RoutingDecision = await get1inchRoutingDecision({\n        tokenIn: params.tokenIn,\n        tokenOut: params.tokenOut,\n        tokenInSymbol,\n        tokenOutSymbol,\n        tokenInDecimals,\n        tokenOutDecimals,\n        amountIn: params.amountIn,\n        slippageBps: params.slippageBps || DEFAULT_SWAP_SLIPPAGE_BPS,\n      });\n\n      return {\n        tokenIn: params.tokenIn,\n        tokenOut: params.tokenOut,\n        amountIn: params.amountIn,\n        amountOut: decision.expectedOut,\n        minAmountOut: decision.minOut,\n        slippageBps: decision.slippageBps,\n        route: decision.route,\n        routeSummary: decision.routeSummary,\n        gas: decision.gas,\n        source: decision.routingSource as 'dflow' | '1inch' | 'deterministic',\n      };\n    } catch (error: any) {\n      console.warn('[FallbackQuoteProvider] Error getting quote:', error.message);\n      return null;\n    }\n  }\n\n  async getEventQuote(): Promise<null> {\n    // Fallback doesn't support event quotes\n    return null;\n  }\n}\n\n", "/**\n * Provider Registry\n * Central selection logic for market data and quote providers\n */\n\nimport {\n  MarketDataProvider,\n  QuoteProvider,\n  ProviderStatus,\n} from './types';\nimport { DflowMarketDataProvider, DflowQuoteProvider } from './dflowProvider';\nimport { FallbackMarketDataProvider, FallbackQuoteProvider } from './fallbackProvider';\nimport {\n  DFLOW_ENABLED,\n  DFLOW_REQUIRE,\n  ROUTING_MODE,\n} from '../config';\nimport { isDflowCapabilityAvailable, getDflowCapabilities } from '../integrations/dflow/dflowClient';\n\n// Singleton instances\nlet marketDataProvider: MarketDataProvider | null = null;\nlet quoteProvider: QuoteProvider | null = null;\n\n/**\n * Get the market data provider based on configuration\n * @throws Error if DFLOW_REQUIRE=true and dFlow is unavailable\n */\nexport function getMarketDataProvider(): MarketDataProvider {\n  if (marketDataProvider) {\n    return marketDataProvider;\n  }\n\n  // Try dFlow first if enabled\n  if (DFLOW_ENABLED) {\n    const dflowProvider = new DflowMarketDataProvider();\n    if (dflowProvider.isAvailable()) {\n      marketDataProvider = dflowProvider;\n      console.log('[ProviderRegistry] Using dFlow for market data');\n      return marketDataProvider;\n    }\n\n    // dFlow enabled but not available\n    if (DFLOW_REQUIRE) {\n      throw new Error(\n        'dFlow is required but events markets capability is not configured. ' +\n        'Set DFLOW_EVENTS_MARKETS_PATH or disable DFLOW_REQUIRE.'\n      );\n    }\n\n    console.warn('[ProviderRegistry] dFlow enabled but events markets unavailable, using fallback');\n  }\n\n  // Use fallback\n  marketDataProvider = new FallbackMarketDataProvider();\n  console.log('[ProviderRegistry] Using fallback for market data (Polymarket + Kalshi)');\n  return marketDataProvider;\n}\n\n/**\n * Get the quote provider based on configuration\n * @throws Error if DFLOW_REQUIRE=true and dFlow is unavailable\n */\nexport function getQuoteProvider(): QuoteProvider {\n  if (quoteProvider) {\n    return quoteProvider;\n  }\n\n  // Check ROUTING_MODE first\n  if (ROUTING_MODE === 'dflow' || DFLOW_ENABLED) {\n    const dflowProvider = new DflowQuoteProvider();\n    if (dflowProvider.isAvailable()) {\n      quoteProvider = dflowProvider;\n      console.log('[ProviderRegistry] Using dFlow for quotes');\n      return quoteProvider;\n    }\n\n    // dFlow requested but not available\n    if (ROUTING_MODE === 'dflow' && DFLOW_REQUIRE) {\n      throw new Error(\n        'dFlow routing is required but not configured. ' +\n        'Set DFLOW_API_KEY and DFLOW_BASE_URL or change ROUTING_MODE.'\n      );\n    }\n\n    console.warn('[ProviderRegistry] dFlow quotes unavailable, using fallback');\n  }\n\n  // Use fallback\n  quoteProvider = new FallbackQuoteProvider();\n  console.log('[ProviderRegistry] Using fallback for quotes (1inch + deterministic)');\n  return quoteProvider;\n}\n\n/**\n * Get provider status for preflight\n */\nexport function getProviderStatus(): ProviderStatus {\n  const dflowCaps = getDflowCapabilities();\n  \n  // Determine market data provider\n  let marketDataProviderName = 'fallback';\n  let marketDataAvailable = true;\n  let marketDataFallback: string | undefined;\n\n  if (DFLOW_ENABLED && dflowCaps.eventsMarkets) {\n    marketDataProviderName = 'dflow';\n  } else if (DFLOW_ENABLED) {\n    marketDataFallback = 'Polymarket + Kalshi';\n  }\n\n  // Determine quote provider\n  let quoteProviderName = 'fallback';\n  let quoteAvailable = true;\n  let quoteFallback: string | undefined;\n  let swapsAvailable = true;\n  let eventsAvailable = false;\n\n  if (ROUTING_MODE === 'dflow' && dflowCaps.enabled) {\n    quoteProviderName = 'dflow';\n    swapsAvailable = dflowCaps.swapsQuotes;\n    eventsAvailable = dflowCaps.eventsQuotes;\n    if (!swapsAvailable) {\n      quoteFallback = '1inch + deterministic';\n    }\n  } else if (ROUTING_MODE === 'hybrid') {\n    quoteProviderName = '1inch';\n    quoteFallback = 'deterministic';\n  } else {\n    quoteProviderName = 'deterministic';\n  }\n\n  return {\n    marketData: {\n      provider: marketDataProviderName,\n      available: marketDataAvailable,\n      fallback: marketDataFallback,\n    },\n    quotes: {\n      provider: quoteProviderName,\n      available: quoteAvailable,\n      fallback: quoteFallback,\n      capabilities: {\n        swaps: swapsAvailable,\n        events: eventsAvailable,\n      },\n    },\n  };\n}\n\n/**\n * Reset provider cache (for testing)\n */\nexport function resetProviders(): void {\n  marketDataProvider = null;\n  quoteProvider = null;\n}\n\n/**\n * Check if dFlow is the active provider for a capability\n */\nexport function isDflowActiveFor(capability: 'marketData' | 'swapQuotes' | 'eventQuotes'): boolean {\n  const status = getProviderStatus();\n  \n  switch (capability) {\n    case 'marketData':\n      return status.marketData.provider === 'dflow';\n    case 'swapQuotes':\n      return status.quotes.provider === 'dflow' && status.quotes.capabilities.swaps;\n    case 'eventQuotes':\n      return status.quotes.provider === 'dflow' && status.quotes.capabilities.events;\n    default:\n      return false;\n  }\n}\n\n\n", "/**\n * Execution Replay Artifacts Logger\n * Logs executionRequest, plan, and executionResult for debugging\n */\n\nimport { BlossomExecutionRequest } from '../types/blossom';\nimport { Plan } from '../types/execution';\nimport { ExecutionResult } from '../types/blossom';\n\nexport interface ExecutionArtifact {\n  timestamp: string;\n  executionId: string;\n  executionRequest?: BlossomExecutionRequest | null;\n  plan?: Plan;\n  executionResult: ExecutionResult;\n  userAddress?: string;\n  draftId?: string;\n}\n\n// In-memory store (for MVP - can be replaced with file/DB later)\nconst executionArtifacts: ExecutionArtifact[] = [];\nconst MAX_ARTIFACTS = 100; // Keep last 100 executions\n\n/**\n * Log an execution artifact\n */\nexport function logExecutionArtifact(artifact: Omit<ExecutionArtifact, 'timestamp' | 'executionId'>): void {\n  const fullArtifact: ExecutionArtifact = {\n    ...artifact,\n    timestamp: new Date().toISOString(),\n    executionId: `exec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n  };\n\n  executionArtifacts.push(fullArtifact);\n\n  // Keep only last MAX_ARTIFACTS\n  if (executionArtifacts.length > MAX_ARTIFACTS) {\n    executionArtifacts.shift();\n  }\n\n  // Log to console in dev mode\n  if (process.env.NODE_ENV !== 'production') {\n    console.log('[executionLogger] Artifact logged:', {\n      executionId: fullArtifact.executionId,\n      timestamp: fullArtifact.timestamp,\n      success: fullArtifact.executionResult.success,\n      txHash: fullArtifact.executionResult.txHash,\n      simulatedTxId: fullArtifact.executionResult.simulatedTxId,\n    });\n  }\n}\n\n/**\n * Get all execution artifacts\n */\nexport function getExecutionArtifacts(): ExecutionArtifact[] {\n  return [...executionArtifacts];\n}\n\n/**\n * Get execution artifact by ID\n */\nexport function getExecutionArtifact(executionId: string): ExecutionArtifact | undefined {\n  return executionArtifacts.find(a => a.executionId === executionId);\n}\n\n/**\n * Get execution artifacts for a user\n */\nexport function getExecutionArtifactsForUser(userAddress: string): ExecutionArtifact[] {\n  return executionArtifacts.filter(a => a.userAddress?.toLowerCase() === userAddress.toLowerCase());\n}\n\n/**\n * Clear all artifacts (for testing)\n */\nexport function clearExecutionArtifacts(): void {\n  executionArtifacts.length = 0;\n}\n\n/**\n * Dump artifacts as JSON (for support/debugging)\n */\nexport function dumpExecutionArtifacts(): string {\n  return JSON.stringify(executionArtifacts, null, 2);\n}\n\n\n", "/**\n * Access Gate for Whitelist Testing\n * Lightweight whitelist system with access codes\n */\n\nexport interface AccessCode {\n  code: string;\n  used: boolean;\n  walletAddress?: string; // Bound to wallet on first use\n  createdAt: number;\n  usedAt?: number;\n}\n\n// In-memory store (for MVP - can be replaced with JSON file/DB later)\nlet accessCodes: Map<string, AccessCode> = new Map();\n\n/**\n * Generate a new access code\n */\nexport function generateAccessCode(): string {\n  // Generate 8-character alphanumeric code\n  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude confusing chars\n  let code = '';\n  for (let i = 0; i < 8; i++) {\n    code += chars[Math.floor(Math.random() * chars.length)];\n  }\n  return code;\n}\n\n/**\n * Create a new access code\n */\nexport function createAccessCode(): AccessCode {\n  const code = generateAccessCode();\n  const accessCode: AccessCode = {\n    code,\n    used: false,\n    createdAt: Date.now(),\n  };\n  accessCodes.set(code, accessCode);\n  return accessCode;\n}\n\n/**\n * Validate and use an access code\n * Returns true if code is valid and can be used\n */\nexport function validateAccessCode(code: string, walletAddress?: string): { valid: boolean; error?: string } {\n  const accessCode = accessCodes.get(code.toUpperCase());\n  \n  if (!accessCode) {\n    return { valid: false, error: 'Invalid access code' };\n  }\n  \n  if (accessCode.used) {\n    // If code is already used, check if it's bound to this wallet\n    if (accessCode.walletAddress && accessCode.walletAddress.toLowerCase() === walletAddress?.toLowerCase()) {\n      return { valid: true }; // Same wallet can reuse\n    }\n    return { valid: false, error: 'Access code already used' };\n  }\n  \n  // Mark as used and bind to wallet\n  accessCode.used = true;\n  if (walletAddress) {\n    accessCode.walletAddress = walletAddress.toLowerCase();\n  }\n  accessCode.usedAt = Date.now();\n  \n  return { valid: true };\n}\n\n/**\n * Check if a wallet has access\n */\nexport function hasAccess(walletAddress: string): boolean {\n  const codes = Array.from(accessCodes.values());\n  for (const accessCode of codes) {\n    if (accessCode.used && accessCode.walletAddress?.toLowerCase() === walletAddress.toLowerCase()) {\n      return true;\n    }\n  }\n  return false;\n}\n\n/**\n * Get all access codes (admin utility)\n */\nexport function getAllAccessCodes(): AccessCode[] {\n  return Array.from(accessCodes.values());\n}\n\n/**\n * Revoke an access code\n */\nexport function revokeAccessCode(code: string): boolean {\n  const accessCode = accessCodes.get(code.toUpperCase());\n  if (!accessCode) {\n    return false;\n  }\n  accessCodes.delete(code.toUpperCase());\n  return true;\n}\n\n/**\n * Initialize with pre-generated codes (for MVP)\n */\nexport function initializeAccessCodes(codes?: string[]): void {\n  if (codes && codes.length > 0) {\n    // Load pre-generated codes\n    for (const code of codes) {\n      accessCodes.set(code.toUpperCase(), {\n        code: code.toUpperCase(),\n        used: false,\n        createdAt: Date.now(),\n      });\n    }\n  } else {\n    // Generate 30 codes for whitelist\n    for (let i = 0; i < 30; i++) {\n      createAccessCode();\n    }\n  }\n}\n\n/**\n * Load access codes from environment variable\n */\nexport function loadAccessCodesFromEnv(): void {\n  const accessGateEnabled = process.env.ACCESS_GATE_ENABLED === \"true\";\n  if (!accessGateEnabled) {\n    console.log(`[accessGate] Access gate is disabled`);\n    return;\n  }\n\n  const codesEnv = process.env.WHITELIST_ACCESS_CODES;\n  if (codesEnv) {\n    const codes = codesEnv.split(',').map(c => c.trim()).filter(c => c.length > 0);\n    initializeAccessCodes(codes);\n    console.log(`[accessGate] Loaded ${codes.length} access codes from environment`);\n  } else {\n    // Generate 30 codes if not provided\n    initializeAccessCodes();\n    console.log(`[accessGate] Generated 30 access codes`);\n  }\n}\n\n/**\n * Express middleware to check access\n * If access gate is disabled, always passes\n */\nexport function checkAccess(req: any, res: any, next: any): void {\n  const accessGateEnabled = process.env.ACCESS_GATE_ENABLED === \"true\";\n  \n  // If gate is disabled, always allow\n  if (!accessGateEnabled) {\n    return next();\n  }\n\n  // Get access code from header or body\n  const accessCode = req.headers['x-access-code'] || req.body?.accessCode;\n  const walletAddress = req.headers['x-wallet-address'] || req.body?.walletAddress;\n\n  if (!accessCode) {\n    return res.status(401).json({ \n      error: 'Access code required',\n      errorCode: 'ACCESS_CODE_REQUIRED'\n    });\n  }\n\n  // Validate access code\n  const validation = validateAccessCode(accessCode, walletAddress);\n  if (!validation.valid) {\n    return res.status(401).json({ \n      error: validation.error || 'Invalid access code',\n      errorCode: 'INVALID_ACCESS_CODE'\n    });\n  }\n\n  // Access granted\n  next();\n}\n\n", "/**\n * Telemetry Logger\n * Writes JSON lines to logs/telemetry.jsonl for MVP observability.\n * Also writes to SQLite database for structured queries.\n * Privacy-preserving: user addresses are hashed with TELEMETRY_SALT.\n */\n\nimport { createHash } from 'crypto';\nimport { appendFileSync, existsSync, mkdirSync } from 'fs';\nimport { join, dirname } from 'path';\nimport { fileURLToPath } from 'url';\n\n// Import DB telemetry (lazy loaded to avoid circular deps)\nlet dbTelemetry: typeof import('../../telemetry/db') | null = null;\nlet dbLoadAttempted = false;\n\nasync function getDbTelemetry() {\n  if (dbLoadAttempted) return dbTelemetry;\n  dbLoadAttempted = true;\n  try {\n    dbTelemetry = await import('../../telemetry/db');\n    dbTelemetry.initDatabase();\n  } catch (e) {\n    console.warn('[telemetry] SQLite DB not available:', (e as Error).message);\n    dbTelemetry = null;\n  }\n  return dbTelemetry;\n}\n\n// ESM-safe __dirname equivalent\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = dirname(__filename);\n\n// Log file path (repo-relative: agent/src/telemetry -> agent/logs)\nconst LOG_DIR = join(__dirname, '../../logs');\nconst LOG_FILE = join(LOG_DIR, 'telemetry.jsonl');\n\n// Ensure log directory exists (fail open - never crash server)\nlet logDirReady = false;\ntry {\n  if (!existsSync(LOG_DIR)) {\n    mkdirSync(LOG_DIR, { recursive: true });\n  }\n  logDirReady = true;\n} catch (e) {\n  console.warn('[telemetry] Could not create log directory (telemetry disabled):', e);\n  logDirReady = false;\n}\n\n// Salt for hashing user addresses (from env or default)\nconst TELEMETRY_SALT = process.env.TELEMETRY_SALT || 'blossom-mvp-default-salt';\n\n/**\n * Hash a user address for privacy\n */\nexport function hashAddress(address: string): string {\n  if (!address) return 'unknown';\n  return createHash('sha256')\n    .update(TELEMETRY_SALT + address.toLowerCase())\n    .digest('hex')\n    .substring(0, 16); // First 16 chars for brevity\n}\n\n/**\n * Telemetry event types\n */\nexport type TelemetryEventType =\n  | 'chat_request'\n  | 'chat_response'\n  | 'prepare_success'\n  | 'prepare_fail'\n  | 'approve_prepare'\n  | 'submit_tx'\n  | 'relayed_tx'\n  | 'session_prepare'\n  | 'tx_confirmed'\n  | 'tx_failed'\n  | 'tx_timeout'\n  | 'preflight_check'\n  | 'execution_complete'\n  | 'error';\n\n/**\n * Telemetry event payload\n */\nexport interface TelemetryPayload {\n  // Execution context\n  mode?: 'sim' | 'eth_testnet';\n  authMode?: 'direct' | 'session';\n  draftId?: string;\n  userHash?: string; // Hashed address\n  \n  // Transaction info\n  txHash?: string;\n  actionTypes?: number[];\n  blockNumber?: number;\n  \n  // Outcome\n  success?: boolean;\n  error?: string;\n  \n  // Additional metadata\n  latencyMs?: number;\n  notes?: string[];\n  \n  // Action-specific\n  executionKind?: string;\n  venue?: string;\n}\n\n/**\n * Log a telemetry event\n * Fail open: never crashes the server, silently fails if logging is unavailable\n */\nexport function logEvent(type: TelemetryEventType, payload: TelemetryPayload): void {\n  // Fail open: if log directory wasn't ready, skip logging\n  if (!logDirReady) {\n    return;\n  }\n  \n  try {\n    const event = {\n      ts: new Date().toISOString(),\n      type,\n      ...payload,\n    };\n\n    const line = JSON.stringify(event) + '\\n';\n    \n    // Append to log file (may fail if disk is full, permissions issue, etc.)\n    try {\n      appendFileSync(LOG_FILE, line, { encoding: 'utf8' });\n    } catch (writeError) {\n      // Fail open: disable logging for this session if write fails\n      if (logDirReady) {\n        console.warn('[telemetry] Write failed, disabling telemetry for this session:', writeError);\n        logDirReady = false;\n      }\n      return;\n    }\n    \n    // Also log to console in dev\n    if (process.env.NODE_ENV === 'development' || process.env.TELEMETRY_CONSOLE === 'true') {\n      console.log(`[telemetry] ${type}:`, JSON.stringify(payload));\n    }\n  } catch (e) {\n    // Fail open: don't let telemetry failures break the app\n    // Only log warning in dev to avoid spam\n    if (process.env.NODE_ENV === 'development') {\n      console.warn('[telemetry] Failed to log event:', e);\n    }\n  }\n}\n\n// ============================================\n// SQLite Database Telemetry Functions\n// ============================================\n\n/**\n * Track an execution in the SQLite database\n */\nexport async function trackExecution(params: {\n  userAddress: string;\n  draftId?: string;\n  correlationId?: string;\n  action: string;\n  token?: string;\n  amountUnits?: string;\n  mode?: string;\n}): Promise<string | null> {\n  try {\n    const db = await getDbTelemetry();\n    if (!db) return null;\n    const execution = db.createExecution({\n      userAddress: params.userAddress,\n      draftId: params.draftId,\n      correlationId: params.correlationId,\n      action: params.action,\n      token: params.token,\n      amountUnits: params.amountUnits,\n      mode: params.mode,\n    });\n    return execution.id;\n  } catch (e) {\n    // Fail open\n    return null;\n  }\n}\n\n/**\n * Update an execution with results\n */\nexport async function updateExecutionResult(\n  correlationId: string,\n  result: {\n    status: 'submitted' | 'confirmed' | 'failed';\n    txHash?: string;\n    errorCode?: string;\n    errorMessage?: string;\n    latencyMs?: number;\n  }\n): Promise<void> {\n  try {\n    const db = await getDbTelemetry();\n    if (!db) return;\n    db.updateExecutionByCorrelationId(correlationId, {\n      status: result.status,\n      txHash: result.txHash,\n      errorCode: result.errorCode,\n      errorMessage: result.errorMessage,\n      latencyMs: result.latencyMs,\n    });\n  } catch (e) {\n    // Fail open\n  }\n}\n\n/**\n * Track session status\n */\nexport async function trackSessionStatus(\n  userAddress: string,\n  sessionId: string,\n  status: string,\n  expiresAt?: number\n): Promise<void> {\n  try {\n    const db = await getDbTelemetry();\n    if (!db) return;\n    db.upsertSession(userAddress, sessionId, status, expiresAt);\n  } catch (e) {\n    // Fail open\n  }\n}\n\n/**\n * Log a request to the database\n */\nexport async function logRequestToDb(params: {\n  endpoint: string;\n  method?: string;\n  userAddress?: string;\n  correlationId?: string;\n  statusCode?: number;\n  latencyMs?: number;\n  errorCode?: string;\n}): Promise<void> {\n  try {\n    const db = await getDbTelemetry();\n    if (!db) return;\n    db.logRequest(params);\n  } catch (e) {\n    // Fail open\n  }\n}\n\n/**\n * Create a scoped logger for a specific request\n */\nexport function createRequestLogger(userAddress?: string, mode?: string, authMode?: string) {\n  const userHash = userAddress ? hashAddress(userAddress) : undefined;\n  const startTime = Date.now();\n\n  return {\n    log: (type: TelemetryEventType, payload: Partial<TelemetryPayload> = {}) => {\n      logEvent(type, {\n        mode: mode as TelemetryPayload['mode'],\n        authMode: authMode as TelemetryPayload['authMode'],\n        userHash,\n        latencyMs: Date.now() - startTime,\n        ...payload,\n      });\n    },\n  };\n}\n\n"],
  "mappings": "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",
  "names": ["path", "latencyMs", "resolve", "getEventMarkets", "cacheTimestamp", "CACHE_TTL_MS", "makeCorrelationId", "portfolio", "getTopYieldVaults", "getEventMarkets", "lowerMessage", "CACHE_TTL_MS", "snapshot", "getSwapQuote", "makeCorrelationId", "expectedOut", "minOut", "resolve", "randomUUID", "fileURLToPath", "dirname", "__dirname", "db", "__filename", "getTopYieldVaults", "decodeUint256", "createPublicClient", "http", "sepolia", "config", "decodeUint256", "encodeAbiParameters", "EXECUTION_SWAP_MODE", "getSwapQuote", "AAVE_SEPOLIA_POOL_ADDRESS", "AAVE_ADAPTER_ADDRESS", "AAVE_REDACTED_ADDRESS", "AAVE_WETH_ADDRESS", "LENDING_EXECUTION_MODE", "getAaveMarketConfig", "getSupportedAsset", "keccak256", "createPublicClient", "http", "sepolia", "parseUnits", "createPublicClient", "createWalletClient", "http", "sepolia", "privateKeyToAccount", "ETH_TESTNET_RPC_URL", "DEMO_REDACTED_ADDRESS", "DEMO_WETH_ADDRESS", "RELAYER_PRIVATE_KEY", "createWalletClient", "sepolia", "sleep", "resolve", "init_db", "db_exports", "closeDatabase", "createExecution", "getDatabase", "getExecution", "initDatabase", "listExecutions", "updateExecution", "upsertSession", "Database", "randomUUID", "path", "fs", "fileURLToPath", "dirname", "db", "DB_PATH", "runMigrations", "__dirname", "__filename", "init_db", "closePosition", "createExecutionStep", "createPosition", "getExecutionSteps", "getIndexerState", "getLedgerSummary", "getOpenPositions", "getPosition", "getPositionByOnChainId", "getPositionStats", "getProofBundle", "getRecentPositions", "registerWallet", "updateExecutionStep", "updatePosition", "upsertIndexerState", "db", "createPublicClient", "http", "sepolia", "buildExplorerUrl", "getPositionByOnChainId", "createPosition", "closePosition", "getIndexerState", "upsertIndexerState", "config", "resolve", "createIntent", "updateIntentStatus", "createExecution", "updateExecution", "createExecutionStep", "updateExecutionStep", "linkExecutionToIntent", "getIntent", "buildExplorerUrl", "getLiFiQuote", "RELAYER_PRIVATE_KEY", "ETH_TESTNET_RPC_URL", "DEMO_PERP_ADAPTER_ADDRESS", "DEMO_REDACTED_ADDRESS", "EXECUTION_ROUTER_ADDRESS", "ERC20_PULL_ADAPTER_ADDRESS", "privateKeyToAccount", "createFailoverPublicClient", "createFailoverWalletClient", "executeWithFailover", "createPosition", "createPublicClient", "createWalletClient", "http", "sepolia", "base58Decode", "base58Encode", "encodeCompactU16", "SolanaClient", "crypto", "config", "resolve", "dirname", "fileURLToPath", "uuidv4", "getUsdcBalance", "updateUsdcBalance", "uuidv4", "getUsdcBalance", "updateUsdcBalance", "setBalanceCallbacks", "topMarkets", "kalshiItems", "polymarketItems", "sections", "dirname", "fileURLToPath", "__filename", "fileURLToPath", "__dirname", "dirname", "__filename", "fileURLToPath", "__dirname", "dirname", "agentDir", "resolve", "rootDir", "envFiles", "loadedEnvFile", "config", "path", "logRequest", "getUsdcBalance", "updateUsdcBalance", "setBalanceCallbacks", "uuidv4", "portfolioAfter", "validateExecutionRequest", "portfolio", "findEventMarketByKeyword", "getVaultRecommendation", "getTopProtocolsByTVL", "getEventMarketsWithRouting", "correlationId", "buildPredictionMarketResponse", "normalizedUserMessage", "EXECUTION_MODE", "ALLOW_SIM_MODE", "EXECUTION_DISABLED", "V1_DEMO", "prepareEthTestnetExecution", "DEMO_REDACTED_ADDRESS", "DEMO_WETH_ADDRESS", "EXECUTION_ROUTER_ADDRESS", "ETH_TESTNET_CHAIN_ID", "ETH_TESTNET_RPC_URL", "MOCK_SWAP_ADAPTER_ADDRESS", "requireEthTestnetConfig", "eth_getCode", "eth_call", "decodeBool", "ROUTING_MODE", "ONEINCH_API_KEY", "EXECUTION_SWAP_MODE", "DEMO_LEND_VAULT_ADDRESS", "DEMO_LEND_ADAPTER_ADDRESS", "LENDING_EXECUTION_MODE", "LENDING_RATE_SOURCE", "AAVE_SEPOLIA_POOL_ADDRESS", "AAVE_ADAPTER_ADDRESS", "DFLOW_ENABLED", "DFLOW_API_KEY", "DFLOW_BASE_URL", "DFLOW_EVENTS_MARKETS_PATH", "DFLOW_EVENTS_QUOTE_PATH", "DFLOW_SWAPS_QUOTE_PATH", "DFLOW_REQUIRE", "PROOF_ADAPTER_ADDRESS", "ERC20_PULL_ADAPTER_ADDRESS", "UNISWAP_V3_ADAPTER_ADDRESS", "WETH_WRAP_ADAPTER_ADDRESS", "EXECUTION_AUTH_MODE", "RELAYER_PRIVATE_KEY", "requireRelayerConfig", "createPublicClient", "http", "sepolia", "parseUnits", "privateKeyToAccount", "userAddress", "plan", "sessionId", "REDACTED_ADDRESS_SEPOLIA", "WETH_ADDRESS_SEPOLIA", "AAVE_REDACTED_ADDRESS", "AAVE_WETH_ADDRESS", "now", "evaluateSessionPolicy", "estimatePlanSpend", "sendRelayedTx", "waitForReceipt", "erc20_balanceOf", "readAavePositions", "mintDemoTokens", "getProviderHealthStatus", "resetAllCircuits", "getTelemetrySummary", "getDevnetStats", "getTrafficStats", "migrateAddFeeColumns", "BLOSSOM_FEE_BPS", "getUsersWithSessionStatus", "listExecutions", "listRuns", "ensureRunsTable", "upsertRun", "getDatabase", "db", "UNISWAP_ADAPTER_ADDRESS", "validateEthTestnetConfig", "initRpcProvider", "ETH_RPC_FALLBACK_URLS", "startPerpIndexer", "getPrice", "getRoutingStats", "resetRoutingStats", "EXECUTION_ROUTER_ADDRESS", "ETH_TESTNET_RPC_URL", "UNISWAP_V3_ADAPTER_ADDRESS", "WETH_WRAP_ADAPTER_ADDRESS", "MOCK_SWAP_ADAPTER_ADDRESS", "PROOF_ADAPTER_ADDRESS", "ERC20_PULL_ADAPTER_ADDRESS", "DEMO_LEND_ADAPTER_ADDRESS", "createPublicClient", "http", "sepolia", "probeDflowEndpoints", "getLedgerSummary", "listExecutionsWithMeta", "listSessionsWithMeta", "listAssetsWithMeta", "getProofBundle", "listWallets", "getSummaryStats", "getRecentExecutions", "getExecution", "getExecutionSteps", "getRecentIntents", "getIntent", "getExecutionsForIntent", "getIntentStatsSummary", "runIntent", "executeIntentById", "recordFailedIntent", "result", "getRecentPositions", "getOpenPositions", "getPositionsByStatus", "getPosition", "getPositionStats", "addToWaitlist", "getStatsSummary", "getIntentStats"]
}
