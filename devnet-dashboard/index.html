<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blossom Devnet Statistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-pink-50 via-white to-blue-50">
  <!-- Header -->
  <header class="border-b border-gray-200 bg-white/80 backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="https://blossom.ceo" class="flex items-center gap-2 text-gray-600 hover:text-pink-500 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            Back to Blossom
          </a>
          <div class="h-6 w-px bg-gray-200"></div>
          <h1 class="text-xl font-bold text-gray-900">Devnet Statistics</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="lastUpdated" class="text-xs text-gray-500">Loading...</span>
          <button onclick="fetchData()" id="refreshBtn" class="flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg bg-pink-100 text-pink-600 hover:bg-pink-200 transition-colors">
            <svg class="w-4 h-4" id="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- Error message -->
    <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 text-red-700"></div>

    <!-- Summary Cards -->
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Summary</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Requests -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span class="text-xs text-gray-500 uppercase tracking-wide">Requests</span>
          </div>
          <div id="requestsAllTime" class="text-2xl font-mono font-bold text-gray-900">-</div>
          <div class="text-xs text-gray-500 mt-1"><span id="requests24h" class="text-blue-500 font-medium">-</span> last 24h</div>
        </div>

        <!-- Visitors -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="text-xs text-gray-500 uppercase tracking-wide">Visitors</span>
          </div>
          <div id="visitorsAllTime" class="text-2xl font-mono font-bold text-gray-900">-</div>
          <div class="text-xs text-gray-500 mt-1"><span id="visitors24h" class="text-purple-500 font-medium">-</span> last 24h</div>
        </div>

        <!-- Success Rate -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span class="text-xs text-gray-500 uppercase tracking-wide">Success Rate</span>
          </div>
          <div id="successRate" class="text-2xl font-mono font-bold text-green-600">-</div>
          <div class="text-xs text-gray-500 mt-1"><span id="http5xx" class="text-gray-500">-</span> 5xx errors (24h)</div>
        </div>

        <!-- Status -->
        <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
          <div class="flex items-center gap-2 mb-2">
            <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
            <span class="text-xs text-gray-500 uppercase tracking-wide">API Status</span>
          </div>
          <div id="apiStatus" class="text-2xl font-mono font-bold text-green-600">-</div>
          <div class="text-xs text-gray-500 mt-1">Telemetry-only mode</div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Execution Trends</h2>
      <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
        <div id="chartRoot" class="h-64 flex items-center justify-center text-sm text-gray-500">
          Loading chart...
        </div>
      </div>
    </section>

    <!-- Recent Runs -->
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Traffic Runs</h2>
      <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <div id="runsTable" class="overflow-x-auto">
          <p class="p-8 text-center text-gray-500">Loading runs...</p>
        </div>
      </div>
    </section>
  </main>

  <!-- React + Recharts (CDN) for lightweight charts -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

  <script>
    const API_BASE = 'https://blossom-telemetry.fly.dev';

    function renderChart(runs) {
      try {
        const chartRoot = document.getElementById('chartRoot');
        if (!chartRoot || !window.Recharts || !window.React || !window.ReactDOM) return;

        const data = (runs || []).slice(0, 10).map((run, idx) => ({
          name: (run.run_id || '').slice(0, 6) || `run-${idx + 1}`,
          requests: run.total_requests || 0,
          successRate: Number(run.success_rate || 0).toFixed(1),
        })).reverse();

        const {
          ResponsiveContainer,
          BarChart,
          Bar,
          XAxis,
          YAxis,
          Tooltip,
        } = window.Recharts;

        const chart = React.createElement(
          ResponsiveContainer,
          { width: '100%', height: 240 },
          React.createElement(
            BarChart,
            { data },
            React.createElement(XAxis, { dataKey: 'name', tick: { fontSize: 10 } }),
            React.createElement(YAxis, { tick: { fontSize: 10 } }),
            React.createElement(Tooltip, { formatter: (value, name) => [value, name] }),
            React.createElement(Bar, { dataKey: 'requests', fill: '#FF6BA0' })
          )
        );

        ReactDOM.createRoot(chartRoot).render(chart);
      } catch (err) {
        const chartRoot = document.getElementById('chartRoot');
        if (chartRoot) {
          chartRoot.textContent = 'Chart unavailable.';
        }
      }
    }

    function formatNumber(n) {
      if (n == null) return '-';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toLocaleString();
    }

    function formatTime(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    async function fetchData() {
      const refreshIcon = document.getElementById('refreshIcon');
      refreshIcon.classList.add('animate-spin');
      document.getElementById('error').classList.add('hidden');

      try {
        const [statsRes, runsRes] = await Promise.all([
          fetch(API_BASE + '/api/telemetry/devnet-stats'),
          fetch(API_BASE + '/api/telemetry/runs?limit=10')
        ]);

        const stats = await statsRes.json();
        const runs = await runsRes.json();

        if (stats.ok && stats.data) {
          const t = stats.data.traffic;
          document.getElementById('requestsAllTime').textContent = formatNumber(t.requestsAllTime);
          document.getElementById('requests24h').textContent = formatNumber(t.requestsLast24h);
          document.getElementById('visitorsAllTime').textContent = formatNumber(t.visitorsAllTime);
          document.getElementById('visitors24h').textContent = formatNumber(t.visitorsLast24h);
          document.getElementById('successRate').textContent = (t.successRate24h || 0).toFixed(1) + '%';
          document.getElementById('http5xx').textContent = t.http5xx24h || 0;
          document.getElementById('apiStatus').textContent = 'Online';
        }

        if (runs.ok && runs.data) {
          if (runs.data.length > 0) {
            let html = '<table class="w-full text-sm"><thead class="bg-gray-50"><tr class="text-left text-gray-600 border-b border-gray-200">';
            html += '<th class="px-4 py-3 font-medium">Run ID</th>';
            html += '<th class="px-4 py-3 font-medium">Started</th>';
            html += '<th class="px-4 py-3 font-medium text-right">Users</th>';
            html += '<th class="px-4 py-3 font-medium text-right">Requests</th>';
            html += '<th class="px-4 py-3 font-medium text-right">Success %</th>';
            html += '<th class="px-4 py-3 font-medium text-right">P95 (ms)</th>';
            html += '</tr></thead><tbody class="font-mono">';

            runs.data.forEach(run => {
              const successClass = (run.success_rate || 0) >= 99 ? 'text-green-600' : (run.success_rate || 0) >= 95 ? 'text-yellow-600' : 'text-red-600';
              html += '<tr class="border-b border-gray-200 last:border-0 hover:bg-gray-50">';
              html += '<td class="px-4 py-3 text-gray-900 truncate max-w-[200px]">' + (run.run_id || '-').slice(0, 30) + '</td>';
              html += '<td class="px-4 py-3 text-gray-600">' + formatTime(run.started_at) + '</td>';
              html += '<td class="px-4 py-3 text-right text-gray-900">' + formatNumber(run.users) + '</td>';
              html += '<td class="px-4 py-3 text-right text-gray-900">' + formatNumber(run.total_requests) + '</td>';
              html += '<td class="px-4 py-3 text-right font-semibold ' + successClass + '">' + ((run.success_rate || 0).toFixed(1)) + '%</td>';
              html += '<td class="px-4 py-3 text-right text-gray-600">' + (run.p95_ms || '-') + '</td>';
              html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('runsTable').innerHTML = html;
            renderChart(runs.data);
          } else {
            document.getElementById('runsTable').innerHTML = '<p class="p-8 text-center text-gray-500">No traffic runs yet.</p>';
            renderChart([]);
          }
        }

        document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
      } catch (err) {
        document.getElementById('error').textContent = 'Failed to fetch data: ' + err.message;
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('apiStatus').textContent = 'Error';
        document.getElementById('apiStatus').classList.remove('text-green-600');
        document.getElementById('apiStatus').classList.add('text-red-600');
      } finally {
        refreshIcon.classList.remove('animate-spin');
      }
    }

    // Fetch on load and every 30 seconds
    fetchData();
    setInterval(fetchData, 30000);
  </script>
</body>
</html>
